# PLAN: Backend Tax & Pricing Infrastructure

**Phase:** 2 - Backend Tax & Pricing Infrastructure
**Plan:** 1 of 1
**Complexity:** Medium
**Estimated Scope:** 4-5 tasks

---

## Objective

Ensure all tax calculations are server-side, properly configured from database settings, and validated for security. Remove environment variable fallbacks and establish database as single source of truth for tax configuration.

**Why This Matters:**
- Server-side calculations prevent price manipulation attacks
- Database-driven tax settings allow runtime changes without deployment
- Centralized tax logic ensures consistency across cart, orders, and quotations
- Tax breakdown transparency required for customer trust and compliance

---

## Execution Context

**Related Files:**
- `apps/api/src/services/pricing.service.ts` - Core pricing logic (already implements tax)
- `apps/api/src/config/index.ts` - Remove DEFAULT_TAX_RATE env variable
- `packages/database/src/schema/settings.ts` - Settings table schema
- `apps/api/src/routes/settings.routes.ts` - Settings CRUD API
- `apps/api/src/routes/cart.routes.ts` - Cart calculation endpoints
- `.env.example` - Remove DEFAULT_TAX_RATE documentation

**Services:**
- PricingService - Already has `getTaxRate()`, `calculateCart()`, `calculateOrderTotals()`
- Settings table - Already stores tax settings in JSONB format

**Current State:**
✅ Settings table exists with proper schema
✅ PricingService.getTaxRate() reads from database
✅ Settings API routes exist for CRUD operations
✅ Tax rate applied in cart calculations
⚠️ Config still has DEFAULT_TAX_RATE env variable (should be removed)
⚠️ Fallback to 0.11 (11%) is hardcoded in PricingService
⚠️ No explicit tax breakdown validation tests

---

## Context

### Phase Dependencies
- **Phase 1 Complete:** Security foundation (JWT, cookies, CSRF, XSS) established
- **Blocks Phase 3:** Checkout flow needs accurate pricing with tax

### Discovery Findings

**PricingService Implementation (pricing.service.ts:401-424):**
```typescript
private async getTaxRate(): Promise<number> {
  const [taxSetting] = await this.db
    .select()
    .from(settings)
    .where(eq(settings.key, 'tax'));

  if (taxSetting && taxSetting.value && typeof taxSetting.value === 'object') {
    const taxValue = taxSetting.value as { tax_rate?: number; tax_enabled?: boolean };

    if (taxValue.tax_enabled && typeof taxValue.tax_rate === 'number') {
      return taxValue.tax_rate / 100; // Convert percentage to decimal
    }

    if (taxValue.tax_enabled === false) {
      return 0;
    }
  }

  return 0.11; // ⚠️ HARDCODED FALLBACK - Should be removed or configurable
}
```

**Tax Calculation Flow:**
1. Cart endpoint called with items and optional promo code
2. PricingService.calculateCart() fetches current product prices
3. Subtotal calculated from database prices
4. Promo code discount applied (if valid)
5. **getTaxRate() called to fetch tax from settings**
6. Tax calculated on (subtotal - discount)
7. Total = subtotal - discount + tax + shipping

**Settings Table Structure:**
```typescript
{
  id: uuid,
  key: varchar(100), // e.g., 'tax'
  value: jsonb,      // e.g., { tax_rate: 11, tax_label: 'VAT', tax_enabled: true }
  description: text,
  updatedAt: timestamp
}
```

**Security Concern (from CONCERNS.md):**
> "CRITICAL RULE: Server-Side Price Calculations
> All price calculations happen on backend
> Client sends quantities only
> Prevents price manipulation attacks"

✅ Already implemented correctly - tax calculated server-side only.

---

## Tasks

### Task 1: Remove Environment Variable Fallback
**Goal:** Eliminate DEFAULT_TAX_RATE from config and environment variables

**Changes:**
1. Remove `defaultTaxRate` from `config.store` object in `apps/api/src/config/index.ts`
2. Remove `DEFAULT_TAX_RATE` documentation from `.env.example`
3. Update PricingService.getTaxRate() fallback behavior:
   - Option A: Return 0 if no setting found (fail-safe)
   - Option B: Throw error if no setting found (fail-fast)
   - **Recommended:** Option A with warning log

**Validation:**
- Server starts without DEFAULT_TAX_RATE in .env
- Tax calculations work when settings exist in database
- No price calculations reference config.store.defaultTaxRate

**Files:**
- `apps/api/src/config/index.ts`
- `.env.example`
- `apps/api/src/services/pricing.service.ts`

---

### Task 2: Initialize Default Tax Settings
**Goal:** Ensure tax settings exist in database on first run

**Approach:**
Settings are already managed by settings.routes.ts with defaults:
```typescript
const DEFAULT_TAX: TaxSettings = {
  tax_rate: 0,
  tax_label: 'VAT',
  tax_enabled: false,
};
```

**Changes:**
1. Verify GET /api/settings returns tax settings with proper defaults
2. Test that missing tax setting in database returns DEFAULT_TAX
3. Document that admins must enable tax via settings API

**Validation:**
- GET /api/settings returns tax object even if not in database
- PUT /api/settings can update tax settings
- PricingService.getTaxRate() reads updated values immediately

**Files:**
- `apps/api/src/routes/settings.routes.ts` (verify existing behavior)

---

### Task 3: Add Tax Breakdown Validation
**Goal:** Ensure tax calculations are accurate and transparent

**Changes:**
1. Add tax breakdown to cart response (already exists, verify format):
   ```typescript
   {
     subtotal: number,
     discountAmount: number,
     taxRate: number,        // e.g., 0.11 for 11%
     taxAmount: number,      // calculated tax
     shippingAmount: number,
     total: number
   }
   ```

2. Verify tax calculation formula:
   ```typescript
   taxableAmount = subtotal - discountAmount
   taxAmount = round(taxableAmount * taxRate, 2)
   total = taxableAmount + taxAmount + shippingAmount
   ```

3. Add validation tests:
   - Tax enabled: verify tax applied correctly
   - Tax disabled: verify taxAmount = 0
   - Different tax rates: verify percentages work
   - Discount interaction: tax applies after discount

**Validation:**
- Cart calculation returns correct tax breakdown
- Tax amount matches manual calculation
- Tax applies to discounted amount (not original subtotal)
- Rounding works correctly (no floating point errors)

**Files:**
- `apps/api/src/services/pricing.service.ts` (verify existing logic)
- Manual testing via cart endpoint

---

### Task 4: Document Tax Configuration
**Goal:** Clear documentation for tax setup and behavior

**Changes:**
1. Update `.env.example` with tax configuration guidance:
   ```bash
   # Tax Configuration
   # Tax settings are managed via database (no env variables needed)
   # To configure tax:
   # 1. Use Admin Dashboard → Settings → Tax
   # 2. Or API: PUT /api/settings with tax object
   # 3. Tax rate is percentage (0-100), e.g., 11 for 11%
   #
   # Default: tax_enabled=false, tax_rate=0
   ```

2. Add code comment to PricingService.getTaxRate() explaining fallback behavior

3. Document tax calculation flow in settings.routes.ts

**Validation:**
- Documentation clearly explains where tax is configured
- No mention of DEFAULT_TAX_RATE in docs
- Admins know how to enable/update tax

**Files:**
- `.env.example`
- `apps/api/src/services/pricing.service.ts`
- `apps/api/src/routes/settings.routes.ts`

---

### Task 5: Test Tax Calculation End-to-End
**Goal:** Validate tax calculations work correctly in real scenarios

**Test Cases:**
1. **No Tax Setting in Database**
   - GET /api/settings/public → tax_enabled: false, tax_rate: 0
   - POST /api/cart/calculate → taxAmount: 0, taxRate: 0

2. **Tax Disabled**
   - PUT /api/settings → { tax: { tax_enabled: false, tax_rate: 11 } }
   - POST /api/cart/calculate → taxAmount: 0, taxRate: 0

3. **Tax Enabled at 11%**
   - PUT /api/settings → { tax: { tax_enabled: true, tax_rate: 11 } }
   - Cart with $100 subtotal → taxAmount: $11.00, total: $111.00

4. **Tax with Discount**
   - Cart $100, promo code -$20 → taxable: $80
   - Tax 11% → taxAmount: $8.80, total: $88.80

5. **Tax with Decimal Rounding**
   - Cart $99.99, tax 11% → taxAmount: $11.00 (rounds correctly)

6. **Different Tax Rates**
   - Test with 0%, 5%, 11%, 20% to verify formula works

**Manual Testing:**
- Use Postman/curl to test cart calculations
- Update tax settings via admin API
- Verify immediate effect on pricing

**Automated Testing (Optional):**
- Could add unit tests for PricingService.getTaxRate()
- Could add integration tests for cart calculations
- **Decision:** Manual testing sufficient for this phase

**Validation:**
- All test cases pass with expected results
- Tax calculations accurate across different scenarios
- Settings changes take effect immediately

**Files:**
- Manual API testing (no code changes)

---

## Verification Checklist

**Before marking complete:**
- [ ] DEFAULT_TAX_RATE removed from config and .env.example
- [ ] Server starts without DEFAULT_TAX_RATE environment variable
- [ ] GET /api/settings returns tax settings with proper defaults
- [ ] PricingService.getTaxRate() reads from database correctly
- [ ] Tax calculation formula verified: (subtotal - discount) * taxRate
- [ ] Tax breakdown included in cart calculations
- [ ] Documentation updated with tax configuration instructions
- [ ] Manual testing completed for all tax scenarios
- [ ] Tax applies correctly when enabled, zero when disabled
- [ ] Tax calculations accurate with discounts and rounding

---

## Success Criteria

**Must Have:**
1. ✅ No environment variables control tax rates
2. ✅ Tax settings read from database only
3. ✅ Tax calculations accurate and transparent
4. ✅ Tax breakdown visible in cart response
5. ✅ Documentation clear for tax configuration

**Implementation Quality:**
- Server-side enforcement maintained (no client-side tax calculation)
- Immediate effect when tax settings updated
- Proper fallback behavior if settings missing
- Clear tax breakdown for customer transparency

**Security:**
- All tax calculations happen on backend
- Client cannot manipulate tax amounts
- Database is single source of truth for tax rate

---

## Output

**Modified Files:**
- `apps/api/src/config/index.ts` - Remove DEFAULT_TAX_RATE
- `.env.example` - Update tax documentation
- `apps/api/src/services/pricing.service.ts` - Update getTaxRate() fallback behavior and comments

**Testing:**
- Manual API testing for tax scenarios (documented results)

**Documentation:**
- Updated .env.example with tax configuration guidance
- Code comments explaining tax calculation flow

**Commits:**
- Commit 1: Remove DEFAULT_TAX_RATE environment variable
- Commit 2: Update tax configuration documentation
- Commit 3: Test and validate tax calculations (create SUMMARY.md)

---

## Risk Assessment

**Low Risk:**
- Tax logic already implemented and working
- Only removing unnecessary fallback
- No breaking changes to API contracts
- Settings system already mature

**Potential Issues:**
- If no tax setting in database, fallback to 0% (safe default)
- Admin dashboard must support tax settings updates (verify exists)

**Mitigation:**
- Test with and without tax settings in database
- Verify admin can update tax settings
- Document clear setup instructions

---

## Notes

**Why This is Simple:**
- PricingService already implements tax correctly
- Settings table and API already exist
- Just removing env variable dependency
- Mostly validation and documentation work

**Future Enhancements (Out of Scope):**
- Multiple tax rates per region/country
- Tax-exempt products or categories
- Complex tax rules (EU VAT, US sales tax)
- Tax reporting and compliance tools

**Phase 2 Dependencies:**
✅ Settings infrastructure complete
✅ PricingService tax logic working
→ Ready to proceed with checkout flow (Phase 3)

---

*Plan created: 2026-01-08*
*Ready for execution: Yes*
*Estimated time: 1-2 hours*
