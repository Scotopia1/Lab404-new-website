# Plan 07-01: Customer Profile & Settings

**Phase:** 7 - Customer Account - Profile & Settings
**Plan:** 07-01
**Objective:** Complete customer profile management with profile updates and password change functionality

---

## Context

**Current State:**
- Profile page exists at `apps/lab404-website/src/app/account/profile/page.tsx` but uses simulated API calls
- GET `/api/customers/me` endpoint exists (returns id, email, firstName, lastName, phone, orderCount, createdAt)
- PUT `/api/customers/me` endpoint exists with validation (updateProfileSchema: firstName, lastName, phone)
- NO password change endpoint exists - needs to be created
- Password validation exists in auth.routes.ts (strong password requirements)
- Customer schema has passwordHash field (bcrypt hashed, never exposed)

**What Needs to Be Built:**
1. Password change API endpoint (PUT `/api/customers/me/password`)
2. React Query hooks for profile operations
3. Update profile page to use live API data
4. Password change form component
5. Account stats display (member since, total orders)

---

## Tasks

### Task 1: Create password change API endpoint
**File:** `apps/api/src/routes/customers.routes.ts` (EDIT)

Add password change endpoint after PUT `/api/customers/me`:

```typescript
// Password change schema
const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, 'Current password is required'),
  newPassword: z.string()
    .min(8, 'Password must be at least 8 characters')
    .max(72, 'Password must be less than 72 characters')
    .refine(
      (password) => {
        const hasUppercase = /[A-Z]/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        return hasUppercase && hasLowercase && hasNumber;
      },
      { message: 'Password must contain uppercase, lowercase, and number' }
    )
    .refine(
      (password) => !WEAK_PASSWORDS.includes(password.toLowerCase()),
      { message: 'Password is too common. Please choose a stronger password.' }
    ),
  confirmPassword: z.string().min(1, 'Please confirm your password'),
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

/**
 * PUT /api/customers/me/password
 * Change customer password
 */
customersRoutes.put(
  '/me/password',
  requireAuth,
  validateBody(changePasswordSchema),
  async (req, res, next) => {
    try {
      const db = getDb();
      const customerId = req.user?.customerId;
      const { currentPassword, newPassword } = req.body;

      if (!customerId) {
        throw new ForbiddenError('Customer not found');
      }

      // Get customer with password hash
      const [customer] = await db
        .select({ id: customers.id, passwordHash: customers.passwordHash })
        .from(customers)
        .where(eq(customers.id, customerId));

      if (!customer || !customer.passwordHash) {
        throw new NotFoundError('Customer not found');
      }

      // Verify current password
      const isPasswordValid = await bcrypt.compare(currentPassword, customer.passwordHash);
      if (!isPasswordValid) {
        throw new BadRequestError('Current password is incorrect');
      }

      // Hash new password
      const newPasswordHash = await bcrypt.hash(newPassword, 12);

      // Update password
      await db
        .update(customers)
        .set({
          passwordHash: newPasswordHash,
          updatedAt: new Date(),
        })
        .where(eq(customers.id, customerId));

      sendSuccess(res, { message: 'Password changed successfully' });
    } catch (error) {
      next(error);
    }
  }
);
```

**Success criteria:**
- Endpoint validates current password
- New password meets strength requirements
- Password hash updated in database
- Returns success message

---

### Task 2: Create React Query hooks for profile
**File:** `apps/lab404-website/src/hooks/use-profile.ts` (NEW)

```typescript
import { useQuery, useMutation, useQueryClient, UseQueryResult } from '@tanstack/react-query';
import { api } from '@/lib/api';

export interface Customer {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  phone?: string | null;
  orderCount: number;
  createdAt: string;
}

export interface UpdateProfileInput {
  firstName?: string;
  lastName?: string;
  phone?: string;
}

export interface ChangePasswordInput {
  currentPassword: string;
  newPassword: string;
  confirmPassword: string;
}

// Fetch customer profile
export function useProfile(): UseQueryResult<Customer> {
  return useQuery({
    queryKey: ['profile'],
    queryFn: async () => {
      const response = await api.get<Customer>('/customers/me');
      return response.data;
    },
  });
}

// Update profile mutation
export function useUpdateProfile() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (data: UpdateProfileInput) => {
      const response = await api.put<Customer>('/customers/me', data);
      return response.data;
    },
    onSuccess: (data) => {
      queryClient.setQueryData(['profile'], data);
      // Also update auth store if needed
    },
  });
}

// Change password mutation
export function useChangePassword() {
  return useMutation({
    mutationFn: async (data: ChangePasswordInput) => {
      const response = await api.put<{ message: string }>('/customers/me/password', data);
      return response.data;
    },
  });
}
```

---

### Task 3: Update profile page with live API data
**File:** `apps/lab404-website/src/app/account/profile/page.tsx` (EDIT)

Replace simulated API calls with useProfile and useUpdateProfile hooks:

```typescript
'use client';

import AccountLayout from '@/components/layout/account-layout';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { toast } from 'sonner';
import { Loader2, User, Mail, Phone, Calendar, ShoppingBag } from 'lucide-react';
import { useProfile, useUpdateProfile } from '@/hooks/use-profile';
import { format } from 'date-fns';
import { Skeleton } from '@/components/ui/skeleton';

const profileSchema = z.object({
  firstName: z.string().min(1, 'First name is required').max(100),
  lastName: z.string().min(1, 'Last name is required').max(100),
  phone: z.string().max(50).optional(),
});

type ProfileFormData = z.infer<typeof profileSchema>;

export default function ProfilePage() {
  const { data: profile, isLoading, error } = useProfile();
  const updateProfile = useUpdateProfile();

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<ProfileFormData>({
    resolver: zodResolver(profileSchema),
    values: profile ? {
      firstName: profile.firstName,
      lastName: profile.lastName,
      phone: profile.phone || '',
    } : undefined,
  });

  const onSubmit = async (data: ProfileFormData) => {
    try {
      await updateProfile.mutateAsync(data);
      toast.success('Profile updated successfully');
    } catch (error: any) {
      toast.error(error.response?.data?.error || 'Failed to update profile');
    }
  };

  if (isLoading) {
    return (
      <AccountLayout>
        <div className="space-y-6">
          <Skeleton className="h-12 w-64" />
          <Card>
            <CardHeader>
              <Skeleton className="h-6 w-32" />
            </CardHeader>
            <CardContent className="space-y-4">
              <Skeleton className="h-10 w-full" />
              <Skeleton className="h-10 w-full" />
            </CardContent>
          </Card>
        </div>
      </AccountLayout>
    );
  }

  if (error || !profile) {
    return (
      <AccountLayout>
        <Card>
          <CardContent className="py-8 text-center">
            <p className="text-destructive">Failed to load profile</p>
          </CardContent>
        </Card>
      </AccountLayout>
    );
  }

  return (
    <AccountLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Profile</h1>
          <p className="text-muted-foreground">
            Manage your personal information and password.
          </p>
        </div>

        {/* Account Stats */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Member Since</CardTitle>
              <Calendar className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {format(new Date(profile.createdAt), 'MMM yyyy')}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total Orders</CardTitle>
              <ShoppingBag className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{profile.orderCount}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Email</CardTitle>
              <Mail className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-sm truncate">{profile.email}</div>
            </CardContent>
          </Card>
        </div>

        {/* Profile Form */}
        <Card>
          <CardHeader>
            <CardTitle>Personal Information</CardTitle>
            <CardDescription>Update your name and contact details</CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
              <div className="grid gap-4 sm:grid-cols-2">
                <div className="space-y-2">
                  <Label htmlFor="firstName">First Name</Label>
                  <Input id="firstName" {...register('firstName')} />
                  {errors.firstName && (
                    <p className="text-sm text-destructive">{errors.firstName.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="lastName">Last Name</Label>
                  <Input id="lastName" {...register('lastName')} />
                  {errors.lastName && (
                    <p className="text-sm text-destructive">{errors.lastName.message}</p>
                  )}
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="phone">Phone (Optional)</Label>
                <Input id="phone" type="tel" {...register('phone')} />
                {errors.phone && (
                  <p className="text-sm text-destructive">{errors.phone.message}</p>
                )}
              </div>
              <div className="space-y-2">
                <Label htmlFor="email">Email</Label>
                <Input id="email" type="email" value={profile.email} disabled />
                <p className="text-xs text-muted-foreground">
                  Contact support to change your email address
                </p>
              </div>
              <Button type="submit" disabled={updateProfile.isPending}>
                {updateProfile.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Save Changes
              </Button>
            </form>
          </CardContent>
        </Card>

        {/* Password Change - placeholder for Task 4 */}
        <Card>
          <CardHeader>
            <CardTitle>Password</CardTitle>
            <CardDescription>Change your account password</CardDescription>
          </CardHeader>
          <CardContent>
            <Button variant="outline">Change Password</Button>
          </CardContent>
        </Card>
      </div>
    </AccountLayout>
  );
}
```

---

### Task 4: Create password change component
**File:** `apps/lab404-website/src/components/profile/password-change-form.tsx` (NEW)

```typescript
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { useChangePassword } from '@/hooks/use-profile';
import { toast } from 'sonner';
import { Loader2, Eye, EyeOff } from 'lucide-react';

const passwordSchema = z.object({
  currentPassword: z.string().min(1, 'Current password is required'),
  newPassword: z.string()
    .min(8, 'Password must be at least 8 characters')
    .max(72, 'Password must be less than 72 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number'),
  confirmPassword: z.string().min(1, 'Please confirm your password'),
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

type PasswordFormData = z.infer<typeof passwordSchema>;

export function PasswordChangeForm() {
  const [isOpen, setIsOpen] = useState(false);
  const [showPasswords, setShowPasswords] = useState({
    current: false,
    new: false,
    confirm: false,
  });
  const changePassword = useChangePassword();

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<PasswordFormData>({
    resolver: zodResolver(passwordSchema),
  });

  const onSubmit = async (data: PasswordFormData) => {
    try {
      await changePassword.mutateAsync(data);
      toast.success('Password changed successfully');
      reset();
      setIsOpen(false);
    } catch (error: any) {
      toast.error(error.response?.data?.error || 'Failed to change password');
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        <Button variant="outline">Change Password</Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Change Password</DialogTitle>
          <DialogDescription>
            Enter your current password and choose a new one
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Current Password */}
          <div className="space-y-2">
            <Label htmlFor="currentPassword">Current Password</Label>
            <div className="relative">
              <Input
                id="currentPassword"
                type={showPasswords.current ? 'text' : 'password'}
                {...register('currentPassword')}
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="absolute right-0 top-0 h-full px-3"
                onClick={() => setShowPasswords(s => ({ ...s, current: !s.current }))}
              >
                {showPasswords.current ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
              </Button>
            </div>
            {errors.currentPassword && (
              <p className="text-sm text-destructive">{errors.currentPassword.message}</p>
            )}
          </div>

          {/* New Password */}
          <div className="space-y-2">
            <Label htmlFor="newPassword">New Password</Label>
            <div className="relative">
              <Input
                id="newPassword"
                type={showPasswords.new ? 'text' : 'password'}
                {...register('newPassword')}
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="absolute right-0 top-0 h-full px-3"
                onClick={() => setShowPasswords(s => ({ ...s, new: !s.new }))}
              >
                {showPasswords.new ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
              </Button>
            </div>
            {errors.newPassword && (
              <p className="text-sm text-destructive">{errors.newPassword.message}</p>
            )}
            <p className="text-xs text-muted-foreground">
              Must be 8+ characters with uppercase, lowercase, and number
            </p>
          </div>

          {/* Confirm Password */}
          <div className="space-y-2">
            <Label htmlFor="confirmPassword">Confirm New Password</Label>
            <div className="relative">
              <Input
                id="confirmPassword"
                type={showPasswords.confirm ? 'text' : 'password'}
                {...register('confirmPassword')}
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="absolute right-0 top-0 h-full px-3"
                onClick={() => setShowPasswords(s => ({ ...s, confirm: !s.confirm }))}
              >
                {showPasswords.confirm ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
              </Button>
            </div>
            {errors.confirmPassword && (
              <p className="text-sm text-destructive">{errors.confirmPassword.message}</p>
            )}
          </div>

          <div className="flex justify-end gap-2">
            <Button type="button" variant="outline" onClick={() => setIsOpen(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={changePassword.isPending}>
              {changePassword.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Change Password
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

---

### Task 5: Integrate password change form into profile page
**File:** `apps/lab404-website/src/app/account/profile/page.tsx` (EDIT)

Replace the password placeholder card with the PasswordChangeForm component:

```typescript
import { PasswordChangeForm } from '@/components/profile/password-change-form';

// ... in the JSX, replace the password Card:

<Card>
  <CardHeader>
    <CardTitle>Password</CardTitle>
    <CardDescription>Change your account password</CardDescription>
  </CardHeader>
  <CardContent>
    <PasswordChangeForm />
  </CardContent>
</Card>
```

---

### Task 6: Create testing documentation
**File:** `.planning/phases/07-customer-profile-settings/07-01-TESTING.md` (NEW)

Comprehensive testing checklist covering:
1. Profile Display (loading, data accuracy, stats)
2. Profile Update (form validation, API integration, success/error)
3. Password Change (validation, current password verification, success/error)
4. Edge Cases (network errors, invalid data, concurrent updates)
5. UI/UX (loading states, error messages, responsiveness)
6. API Integration (all endpoints, error responses)
7. Security (password strength, no password exposure)

---

## Success Criteria

- [ ] Password change API endpoint created and secured
- [ ] React Query hooks for profile operations working
- [ ] Profile page displays live data from API
- [ ] Profile update form works with validation
- [ ] Account stats displayed (member since, total orders)
- [ ] Password change form with validation
- [ ] Password visibility toggles working
- [ ] All operations show toast notifications
- [ ] Loading and error states handled
- [ ] Email field disabled (read-only)
- [ ] Phone field optional
- [ ] Testing documentation created

---

## Output

**Files Created (3):**
1. `apps/lab404-website/src/hooks/use-profile.ts` - React Query hooks
2. `apps/lab404-website/src/components/profile/password-change-form.tsx` - Password change dialog
3. `.planning/phases/07-customer-profile-settings/07-01-TESTING.md` - Testing documentation

**Files Modified (2):**
1. `apps/api/src/routes/customers.routes.ts` - Password change endpoint
2. `apps/lab404-website/src/app/account/profile/page.tsx` - Live API integration

**Estimated commits:** 6 (one per task) + 1 docs = 7 total
