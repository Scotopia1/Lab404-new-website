# PLAN: Checkout Flow Restructure - COD Only

**Phase:** 3 - Checkout Flow Restructure
**Plan:** 1 of 2
**Complexity:** High
**Estimated Scope:** 6-7 tasks

---

## Objective

Restructure checkout UI to COD-only payment, remove all Stripe/card payment references, implement proper address validation matching API schema, and ensure orders are created correctly with cart clearing.

**Why This Matters:**
- COD is the only payment method in v1 (Stripe deferred to v2)
- Card payment fields confuse customers and create security concerns
- Proper address validation prevents order fulfillment issues
- Cart must clear after successful order to prevent duplicate orders

**Scope:** Frontend checkout form restructure + validation alignment

---

## Execution Context

**Related Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx` - Main checkout form (HAS CARD FIELDS)
- `apps/lab404-website/src/lib/checkout-validation.ts` - Form validation schema (HAS CARD VALIDATION)
- `apps/api/src/routes/orders.routes.ts` - Order creation API (EXPECTS COD)

**Current State:**
⚠️ Checkout form has card payment fields (cardNumber, expiryDate, cvc)
⚠️ Validation schema includes card field validation
⚠️ Form sends mock card data to API: `cardNumber.slice(-4)`, `provider: 'visa'`
⚠️ Address schema mismatch: form has `address/state/zipCode`, API expects `addressLine1/state/postalCode`
⚠️ API expects `customerEmail` field, form doesn't collect it separately
✅ API already configured for COD: `paymentMethod: z.enum(['cod']).default('cod')`
✅ Order creation endpoint exists and works
✅ Cart clearing happens after successful order (line 61 in checkout-form.tsx)

**API Order Schema:**
```typescript
createOrderSchema = z.object({
  shipping Address: addressSchema,       // Required
  billingAddress: addressSchema.optional(), // Optional
  sameAsShipping: z.boolean().optional().default(true),
  customerEmail: z.string().email(),     // Required
  customerNotes: z.string().max(1000).optional(),
  paymentMethod: z.enum(['cod']).default('cod'), // COD only
});

addressSchema = z.object({
  firstName, lastName, company (opt),
  addressLine1, addressLine2 (opt),
  city, state (opt), postalCode (opt), country,
  phone (opt)
});
```

---

## Context

### Phase Dependencies
- **Phase 1 Complete:** Security foundation (auth, cookies, CSRF, XSS)
- **Phase 2 Complete:** Tax calculations from database
- **Blocks Phase 4:** Email notifications need working checkout

### Discovery Findings

**Checkout Form Issues (checkout-form.tsx:49-52):**
```typescript
paymentMethod: {
    cardNumber: data.cardNumber.slice(-4), // ❌ Should not exist
    provider: 'visa',                       // ❌ Mock data
},
```

**Validation Schema Issues (checkout-validation.ts:12-14):**
```typescript
cardNumber: z.string().min(16, 'Card number must be 16 digits').max(16),
expiryDate: z.string().regex(/^(0[1-9]|1[0-2])\/([0-9]{2})$/, 'Invalid expiry date (MM/YY)'),
cvc: z.string().min(3, 'CVC must be 3 digits').max(4),
```
These must be removed.

**Address Field Mapping:**
| Form Field | API Field | Status |
|------------|-----------|--------|
| address | addressLine1 | ❌ Name mismatch |
| (none) | addressLine2 | ❌ Missing optional field |
| city | city | ✅ Match |
| state | state | ✅ Match |
| zipCode | postalCode | ❌ Name mismatch |
| country | country | ✅ Match |
| (none) | phone | ❌ Missing optional field |
| (none) | company | ❌ Missing optional field |

**Email Field:**
- Form collects email in shipping section
- API expects `customerEmail` at root level (not in shippingAddress)
- Form must send `customerEmail` separately

---

## Tasks

### Task 1: Remove Card Payment Fields from Validation Schema
**Goal:** Update checkout validation to remove all card payment fields

**Changes to `checkout-validation.ts`:**
```typescript
// REMOVE these fields:
cardNumber: z.string().min(16, 'Card number must be 16 digits').max(16),
expiryDate: z.string().regex(/^(0[1-9]|1[0-2])\/([0-9]{2})$/, 'Invalid expiry date (MM/YY)'),
cvc: z.string().min(3, 'CVC must be 3 digits').max(4),

// UPDATE schema to match API address schema:
export const checkoutSchema = z.object({
  // Shipping address fields
  firstName: z.string().min(2, 'First name must be at least 2 characters'),
  lastName: z.string().min(2, 'Last name must be at least 2 characters'),
  email: z.string().email('Invalid email address'), // Will be sent as customerEmail
  company: z.string().max(255).optional(),
  addressLine1: z.string().min(5, 'Address must be at least 5 characters'),
  addressLine2: z.string().max(255).optional(),
  city: z.string().min(2, 'City must be at least 2 characters'),
  state: z.string().max(100).optional(),
  postalCode: z.string().max(20).optional(),
  country: z.string().min(2, 'Country must be at least 2 characters'),
  phone: z.string().max(50).optional(),

  // Optional customer notes
  customerNotes: z.string().max(1000).optional(),
});
```

**Validation:**
- Schema compiles without errors
- No card payment fields remain
- Field names match API addressSchema
- All required API fields present

**Files:**
- `apps/lab404-website/src/lib/checkout-validation.ts`

---

### Task 2: Remove Card Payment UI from Checkout Form
**Goal:** Remove entire "Payment Details" card section from checkout form

**Changes to `checkout-form.tsx`:**
1. Remove "Payment Details" Card component (lines 139-168):
   ```tsx
   // DELETE THIS ENTIRE SECTION:
   <Card>
       <CardHeader>
           <CardTitle>Payment Details</CardTitle>
       </CardHeader>
       <CardContent className="grid gap-4">
           {/* All card input fields */}
       </CardContent>
   </Card>
   ```

2. Update form to only show:
   - Shipping Information card (keep)
   - Order Summary card (keep)
   - Remove payment details card (delete)

**Validation:**
- Form renders without card payment section
- No card-related inputs visible
- Form still collects shipping address
- Order summary still displays

**Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx`

---

### Task 3: Update Shipping Form Fields to Match API Schema
**Goal:** Align form field names with API address schema

**Changes to `checkout-form.tsx` shipping section:**
```tsx
// ADD company field (optional):
<div className="space-y-2 sm:col-span-2">
    <Label htmlFor="company">Company (Optional)</Label>
    <Input id="company" {...register('company')} />
    {errors.company && (
        <p className="text-sm text-destructive">{errors.company.message}</p>
    )}
</div>

// RENAME address → addressLine1:
<div className="space-y-2 sm:col-span-2">
    <Label htmlFor="addressLine1">Address Line 1</Label>
    <Input id="addressLine1" {...register('addressLine1')} />
    {errors.addressLine1 && (
        <p className="text-sm text-destructive">{errors.addressLine1.message}</p>
    )}
</div>

// ADD addressLine2 (optional):
<div className="space-y-2 sm:col-span-2">
    <Label htmlFor="addressLine2">Address Line 2 (Optional)</Label>
    <Input id="addressLine2" {...register('addressLine2')} />
    {errors.addressLine2 && (
        <p className="text-sm text-destructive">{errors.addressLine2.message}</p>
    )}
</div>

// RENAME zipCode → postalCode:
<div className="space-y-2">
    <Label htmlFor="postalCode">Postal Code</Label>
    <Input id="postalCode" {...register('postalCode')} />
    {errors.postalCode && (
        <p className="text-sm text-destructive">{errors.postalCode.message}</p>
    )}
</div>

// ADD phone field (optional):
<div className="space-y-2">
    <Label htmlFor="phone">Phone (Optional)</Label>
    <Input id="phone" type="tel" {...register('phone')} />
    {errors.phone && (
        <p className="text-sm text-destructive">{errors.phone.message}</p>
    )}
</div>

// ADD customer notes (optional):
<div className="space-y-2 sm:col-span-2">
    <Label htmlFor="customerNotes">Order Notes (Optional)</Label>
    <textarea
        id="customerNotes"
        {...register('customerNotes')}
        className="min-h-[80px] w-full rounded-md border px-3 py-2"
        placeholder="Any special instructions for your order?"
    />
    {errors.customerNotes && (
        <p className="text-sm text-destructive">{errors.customerNotes.message}</p>
    )}
</div>
```

**Validation:**
- All API-required fields present
- Field names match addressSchema exactly
- Optional fields clearly marked
- Form validation works

**Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx`

---

### Task 4: Update Order Submission to Send Correct Data
**Goal:** Send data in format API expects (COD, correct address structure)

**Changes to `checkout-form.tsx` onSubmit function:**
```typescript
const onSubmit = async (data: CheckoutFormData) => {
    if (!cart || cart.items.length === 0) {
        toast.error('Your cart is empty');
        return;
    }

    setIsSubmitting(true);
    try {
        // Send order to backend with correct structure
        const response = await api.post('/orders', {
            // Customer email at root level (not in address)
            customerEmail: data.email,

            // Shipping address with correct field names
            shippingAddress: {
                firstName: data.firstName,
                lastName: data.lastName,
                company: data.company,
                addressLine1: data.addressLine1,
                addressLine2: data.addressLine2,
                city: data.city,
                state: data.state,
                postalCode: data.postalCode,
                country: data.country,
                phone: data.phone,
            },

            // Billing same as shipping (API default: true)
            sameAsShipping: true,

            // COD payment method (API default: 'cod')
            paymentMethod: 'cod',

            // Optional customer notes
            customerNotes: data.customerNotes,
        });

        // Clear cart after successful order
        await clearCart.mutateAsync();

        toast.success('Order placed successfully!');

        // Navigate to order confirmation with order number
        const orderNumber = response.data.data.orderNumber;
        router.push(`/checkout/success?orderNumber=${orderNumber}`);
    } catch (error) {
        console.error('Order creation error:', error);
        toast.error('Failed to place order. Please try again.');
    } finally {
        setIsSubmitting(false);
    }
};
```

**Validation:**
- Order creation succeeds with 201 status
- Order appears in database with correct data
- Cart cleared after successful order
- User redirected to success page with order number

**Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx`

---

### Task 5: Add COD Payment Method Indicator
**Goal:** Show clear COD payment method in order summary

**Changes to `checkout-form.tsx` Order Summary section:**
```tsx
<CardContent className="space-y-4">
    {/* Existing cart items display */}
    {cart?.items.map((item) => (
        <div key={item.id} className="flex justify-between text-sm">
            <span>
                {item.quantity}x {item.product.name}
            </span>
            <span>${(Number(item.product.price) * item.quantity).toFixed(2)}</span>
        </div>
    ))}

    <div className="border-t pt-4 space-y-4">
        {/* ADD: Payment Method Indicator */}
        <div className="bg-muted p-3 rounded-lg">
            <div className="flex items-center gap-2 text-sm font-medium">
                <svg className="h-5 w-5" /* ... cash icon ... */>...</svg>
                <span>Payment Method: Cash on Delivery (COD)</span>
            </div>
            <p className="text-xs text-muted-foreground mt-1">
                Pay when you receive your order
            </p>
        </div>

        {/* Existing promo code input */}
        <div className="flex gap-2">
            <Input placeholder="Promo code" />
            <Button variant="outline">Apply</Button>
        </div>

        {/* Existing price breakdown */}
        <div className="space-y-1.5">
            <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Subtotal</span>
                <span>${cart?.subtotal.toFixed(2)}</span>
            </div>
            <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Tax</span>
                <span>${cart?.taxAmount.toFixed(2)}</span>
            </div>
            <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Shipping</span>
                <span>Free</span>
            </div>
            <div className="flex justify-between text-base font-medium pt-2 border-t">
                <span>Total</span>
                <span>${cart?.total.toFixed(2)}</span>
            </div>
        </div>
    </div>

    <Button className="w-full" size="lg" disabled={isSubmitting}>
        {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
        Place Order - Pay on Delivery
    </Button>
</CardContent>
```

**Validation:**
- COD indicator clearly visible
- Payment method explanation shown
- Button text updated to mention COD
- Tax amount displayed (from Phase 2)

**Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx`

---

### Task 6: Create Order Success Page
**Goal:** Show order confirmation with order number and next steps

**Create `apps/lab404-website/src/app/checkout/success/page.tsx`:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { CheckCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export default function CheckoutSuccessPage() {
    const searchParams = useSearchParams();
    const orderNumber = searchParams.get('orderNumber');
    const [mounted, setMounted] = useState(false);

    useEffect(() => {
        setMounted(true);
    }, []);

    if (!mounted) {
        return null; // Prevent hydration issues
    }

    if (!orderNumber) {
        return (
            <div className="container mx-auto px-4 py-16">
                <Card>
                    <CardContent className="p-8 text-center">
                        <p>No order information found.</p>
                        <Button asChild className="mt-4">
                            <Link href="/">Return to Home</Link>
                        </Button>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <div className="container mx-auto px-4 py-16">
            <Card className="max-w-2xl mx-auto">
                <CardHeader className="text-center">
                    <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
                        <CheckCircle className="h-10 w-10 text-green-600" />
                    </div>
                    <CardTitle className="text-2xl">Order Placed Successfully!</CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="text-center space-y-2">
                        <p className="text-muted-foreground">
                            Your order has been received and is being processed.
                        </p>
                        <div className="bg-muted p-4 rounded-lg">
                            <p className="text-sm text-muted-foreground mb-1">Order Number</p>
                            <p className="text-2xl font-bold">{orderNumber}</p>
                        </div>
                    </div>

                    <div className="border-t pt-6 space-y-4">
                        <h3 className="font-semibold">What's Next?</h3>
                        <ul className="space-y-3 text-sm">
                            <li className="flex gap-3">
                                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary text-xs font-bold">1</span>
                                <span>You'll receive an email confirmation shortly</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary text-xs font-bold">2</span>
                                <span>We'll prepare your order and contact you for delivery</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary text-xs font-bold">3</span>
                                <span>Pay with cash when you receive your order</span>
                            </li>
                        </ul>
                    </div>

                    <div className="border-t pt-6 flex flex-col sm:flex-row gap-3">
                        <Button asChild variant="outline" className="flex-1">
                            <Link href={`/orders/track/${orderNumber}`}>Track Order</Link>
                        </Button>
                        <Button asChild className="flex-1">
                            <Link href="/">Continue Shopping</Link>
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}
```

**Validation:**
- Page displays order number from URL
- Clear next steps shown
- COD payment method explained
- Links to order tracking and home page work

**Files:**
- `apps/lab404-website/src/app/checkout/success/page.tsx` (NEW FILE)

---

### Task 7: Add Error Handling and Edge Cases
**Goal:** Handle common checkout errors gracefully

**Error scenarios to handle in `checkout-form.tsx`:**
```typescript
const onSubmit = async (data: CheckoutFormData) => {
    if (!cart || cart.items.length === 0) {
        toast.error('Your cart is empty');
        return;
    }

    setIsSubmitting(true);
    try {
        const response = await api.post('/orders', {
            // ... order data
        });

        // Clear cart after successful order
        await clearCart.mutateAsync();

        toast.success('Order placed successfully!');

        const orderNumber = response.data.data.orderNumber;
        router.push(`/checkout/success?orderNumber=${orderNumber}`);
    } catch (error: any) {
        console.error('Order creation error:', error);

        // Specific error handling
        if (error.response?.status === 400) {
            const message = error.response.data?.message || 'Invalid order data';
            toast.error(message);
        } else if (error.response?.status === 404) {
            toast.error('Cart not found. Please add items to your cart.');
        } else if (error.response?.status === 409) {
            toast.error('Some items in your cart are out of stock.');
        } else if (error.response?.status === 429) {
            toast.error('Too many requests. Please wait a moment and try again.');
        } else {
            toast.error('Failed to place order. Please try again.');
        }
    } finally {
        setIsSubmitting(false);
    }
};

// ADD: Empty cart check in render
if (!cart || cart.items.length === 0) {
    return (
        <Card>
            <CardContent className="p-8 text-center">
                <p className="text-muted-foreground mb-4">Your cart is empty</p>
                <Button asChild>
                    <Link href="/products">Continue Shopping</Link>
                </Button>
            </CardContent>
        </Card>
    );
}
```

**Validation:**
- Empty cart shows friendly message
- API errors displayed with specific messages
- Network errors handled gracefully
- Loading state prevents double submissions

**Files:**
- `apps/lab404-website/src/components/checkout/checkout-form.tsx`

---

## Verification Checklist

**Before marking complete:**
- [ ] No card payment fields in validation schema
- [ ] No card payment UI in checkout form
- [ ] Form field names match API addressSchema
- [ ] Order submission sends correct data structure
- [ ] paymentMethod: 'cod' sent to API
- [ ] customerEmail sent at root level (not in address)
- [ ] Cart clears after successful order
- [ ] Success page displays with order number
- [ ] COD payment method clearly indicated
- [ ] Error handling covers common scenarios
- [ ] Tax breakdown displayed (from Phase 2)

---

## Success Criteria

**Must Have:**
1. ✅ No Stripe/card payment references in checkout
2. ✅ COD payment method clearly indicated
3. ✅ Address fields match API schema
4. ✅ Orders created successfully with correct data
5. ✅ Cart cleared after order completion
6. ✅ Order confirmation page functional

**User Experience:**
- Clear COD payment method explanation
- Simple, focused checkout form
- Proper address validation
- Success confirmation with order number
- Graceful error handling

**Security:**
- No credit card data collected
- All order data validated server-side
- CSRF protection active (Phase 1)
- XSS sanitization active (Phase 1)

---

## Output

**Modified Files:**
- `apps/lab404-website/src/lib/checkout-validation.ts` - Remove card fields, align with API
- `apps/lab404-website/src/components/checkout/checkout-form.tsx` - COD-only UI, correct data structure
- `apps/lab404-website/src/app/checkout/success/page.tsx` - NEW success confirmation page

**Testing:**
- Manual checkout flow testing (add to cart → checkout → success)
- Address validation testing
- Error scenario testing
- Cart clearing verification

**Documentation:**
- Code comments explaining COD-only approach
- Success page with clear next steps

**Commits:**
- Commit 1: Remove card payment validation schema
- Commit 2: Remove card payment UI from form
- Commit 3: Update address fields to match API schema
- Commit 4: Update order submission with correct structure
- Commit 5: Add COD payment indicator
- Commit 6: Create order success page
- Commit 7: Add error handling
- Commit 8: Create SUMMARY.md

---

## Risk Assessment

**Medium Risk:**
- Address field renaming could break existing form submits (mitigation: deploy with cart flush)
- Users with items in cart will lose them on deploy (acceptable - fresh start)

**Low Risk:**
- Removing card fields is non-breaking (UI only)
- API already expects COD (no backend changes)
- Success page is new (no existing behavior)

**Mitigation:**
- Test complete checkout flow before deploying
- Clear instructions for users about COD payment
- Proper error messages for common issues

---

## Notes

**Why 7 Tasks:**
- Task 1-2: Remove card payment (validation + UI)
- Task 3-4: Fix address schema + submission
- Task 5: Add COD indicator
- Task 6: Success page
- Task 7: Error handling

**Out of Scope (Phase 4):**
- Email notifications (separate phase)
- Order tracking page details (separate phase)
- Admin order management (exists)

**Future Enhancements (v2):**
- Stripe payment integration
- Multiple payment methods
- Saved addresses for logged-in users
- Guest checkout optimization

**Dependencies:**
✅ Phase 1: Security (auth, CSRF, XSS)
✅ Phase 2: Tax calculations
→ Phase 4: Email notifications will use this checkout

---

*Plan created: 2026-01-08*
*Ready for execution: Yes*
*Estimated time: 2-3 hours*
