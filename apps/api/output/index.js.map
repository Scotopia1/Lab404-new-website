{"version":3,"sources":["../api/index.ts","../src/app.ts","../src/config/index.ts","../src/middleware/errorHandler.ts","../src/utils/errors.ts","../src/utils/response.ts","../src/utils/logger.ts","../src/middleware/auth.ts","../../../packages/database/src/client.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/neon-http/driver.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/entity.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/logger.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/query-promise.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/table.utils.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/table.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/tracing-utils.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/drizzle-orm/version.js","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/tracing.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/column.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/column-builder.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/foreign-keys.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/unique-constraint.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/utils/array.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/common.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/enum.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/subquery.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/view-common.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/sql/sql.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/utils.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/delete.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/alias.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/casing.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/errors.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/int.common.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/bigint.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/bigserial.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/boolean.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/char.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/cidr.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/custom.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/date.common.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/date.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/double-precision.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/inet.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/integer.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/interval.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/json.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/jsonb.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/line.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/macaddr.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/macaddr8.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/numeric.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/point.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/postgis_extension/utils.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/postgis_extension/geometry.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/real.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/serial.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/smallint.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/smallserial.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/text.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/time.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/timestamp.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/uuid.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/varchar.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/vector_extension/bit.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/vector_extension/halfvec.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/vector_extension/sparsevec.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/vector_extension/vector.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/columns/all.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/table.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/primary-keys.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/sql/expressions/conditions.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/sql/expressions/select.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/relations.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/view-base.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/dialect.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/selection-proxy.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/query-builders/query-builder.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/select.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/query-builder.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/insert.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/refresh-materialized-view.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/update.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/count.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/query.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/query-builders/raw.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/db.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/indexes.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/pg-core/session.ts","../../../node_modules/.pnpm/drizzle-orm@0.36.4_@neondatabase+serverless@0.9.5_@types+pg@8.11.6_@types+react@19.2.7_react@19.2.3/node_modules/src/neon-http/session.ts","../../../packages/database/src/schema/index.ts","../../../packages/database/src/schema/categories.ts","../../../packages/database/src/schema/products.ts","../../../packages/database/src/schema/customers.ts","../../../packages/database/src/schema/promoCodes.ts","../../../packages/database/src/schema/orders.ts","../../../packages/database/src/schema/pdfTemplates.ts","../../../packages/database/src/schema/quotations.ts","../../../packages/database/src/schema/blogs.ts","../../../packages/database/src/schema/settings.ts","../../../packages/database/src/schema/carts.ts","../../../packages/database/src/schema/imports.ts","../../../packages/database/src/schema/verificationCodes.ts","../../../packages/database/src/schema/sessions.ts","../../../packages/database/src/schema/passwordHistory.ts","../../../packages/database/src/schema/loginAttempts.ts","../../../packages/database/src/schema/breachChecks.ts","../../../packages/database/src/schema/securityAuditLogs.ts","../../../packages/database/src/schema/ipReputation.ts","../../../packages/database/src/schema/newsletter.ts","../src/services/session.service.ts","../src/middleware/validator.ts","../src/middleware/rateLimiter.ts","../src/middleware/csrf.ts","../src/middleware/xss.ts","../src/middleware/request-id.ts","../src/routes/index.ts","../src/routes/auth.routes.ts","../src/utils/helpers.ts","../src/services/pricing.service.ts","../src/services/pdf.service.ts","../src/services/export.service.ts","../src/services/import.service.ts","../src/services/search.service.ts","../src/utils/crypto.ts","../src/services/verification-code.service.ts","../src/services/ip-reputation.service.ts","../src/services/cart.service.ts","../src/services/mailer.service.ts","../src/services/notification.service.ts","../src/services/password-security.service.ts","../src/services/hibp.service.ts","../src/services/audit-log.service.ts","../src/types/audit-events.ts","../src/services/login-attempt.service.ts","../src/routes/sessions.routes.ts","../src/routes/products.routes.ts","../src/routes/categories.routes.ts","../src/routes/cart.routes.ts","../src/routes/orders.routes.ts","../src/services/email-templates.service.ts","../src/routes/customers.routes.ts","../src/routes/promoCodes.routes.ts","../src/routes/quotations.routes.ts","../src/services/quotation-activity.service.ts","../src/services/quotation-revision.service.ts","../src/routes/quotation-templates.routes.ts","../src/routes/blogs.routes.ts","../src/routes/settings.routes.ts","../src/routes/analytics.routes.ts","../src/routes/export.routes.ts","../src/routes/import.routes.ts","../src/routes/contact.routes.ts","../src/routes/upload.routes.ts","../src/routes/health.routes.ts","../src/utils/db-health.ts","../src/routes/notifications.routes.ts","../src/routes/search.routes.ts","../src/routes/google-images.routes.ts","../src/routes/pdfTemplates.routes.ts","../src/routes/cron.routes.ts","../src/routes/admin.routes.ts","../src/routes/newsletter.routes.ts"],"sourcesContent":["import { createApp } from '../src/app';\n\n// Create Express app\nconst app = createApp();\n\n// Export for Vercel serverless\nexport default app;\n","import express from 'express';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport morgan from 'morgan';\nimport compression from 'compression';\nimport cookieParser from 'cookie-parser';\n\nimport { config } from './config';\nimport { errorHandler, notFoundHandler, defaultLimiter } from './middleware';\nimport { logger } from './utils/logger';\nimport { generateCsrfToken, doubleCsrfProtection } from './middleware/csrf';\nimport { xssSanitize } from './middleware/xss';\nimport { requestIdMiddleware } from './middleware/request-id';\n\n// Import routes\nimport { router } from './routes';\n\n/**\n * Create Express application\n */\nexport function createApp() {\n  const app = express();\n\n  // Trust proxy for Vercel/cloud deployments\n  app.set('trust proxy', 1);\n\n  // ===========================================\n  // Request Identification\n  // ===========================================\n\n  // Generate unique ID for each request (for audit logging & correlation)\n  app.use(requestIdMiddleware);\n\n  // ===========================================\n  // Security Middleware\n  // ===========================================\n\n  // Helmet - Security headers\n  app.use(helmet());\n\n  // CORS - Use function to dynamically return the correct origin\n  app.use(\n    cors({\n      origin: (origin, callback) => {\n        // Allow requests with no origin (like mobile apps or curl)\n        if (!origin) {\n          return callback(null, true);\n        }\n\n        // Check if the origin is in the allowed list\n        if (config.corsOrigins.includes(origin)) {\n          callback(null, origin); // Return the specific origin\n        } else {\n          callback(new Error('Not allowed by CORS'));\n        }\n      },\n      credentials: true,\n      methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n      allowedHeaders: ['Content-Type', 'Authorization', 'X-Session-ID', 'X-CSRF-Token'],\n    })\n  );\n\n  // Rate limiting\n  app.use(defaultLimiter);\n\n  // ===========================================\n  // Request Processing Middleware\n  // ===========================================\n\n  // Compression\n  app.use(compression());\n\n  // Cookie parsing\n  app.use(cookieParser());\n\n  // Body parsing\n  app.use(express.json({ limit: '10mb' }));\n  app.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n  // XSS Sanitization - Apply after body parsing, before routes\n  app.use(xssSanitize);\n\n  // CSRF Protection - Apply after cookie parser, skip for safe methods and health checks\n  app.use((req, res, next) => {\n    // Skip CSRF for safe methods, health checks, and public auth endpoints\n    const publicAuthPaths = [\n      '/api/auth/login',\n      '/api/auth/admin/login',\n      '/api/auth/register',\n      '/api/auth/forgot-password',\n      '/api/auth/verify-reset-code',\n      '/api/auth/reset-password',\n      '/api/auth/verify-email',\n    ];\n\n    if (\n      ['GET', 'HEAD', 'OPTIONS'].includes(req.method) ||\n      req.path === '/health' ||\n      req.path === '/api/health' ||\n      publicAuthPaths.includes(req.path)\n    ) {\n      return next();\n    }\n    doubleCsrfProtection(req, res, next);\n  });\n\n  // Logging\n  if (config.isDev) {\n    app.use(morgan('dev'));\n  } else {\n    app.use(\n      morgan('combined', {\n        stream: { write: (message: string) => logger.http(message.trim()) },\n      })\n    );\n  }\n\n  // ===========================================\n  // Health Check & CSRF Token\n  // ===========================================\n\n  app.get('/health', (_req, res) => {\n    res.json({\n      status: 'ok',\n      timestamp: new Date().toISOString(),\n      environment: config.env,\n    });\n  });\n\n  // CSRF token endpoint\n  app.get('/api/csrf-token', (req, res) => {\n    const token = generateCsrfToken(req, res);\n    res.json({ csrfToken: token });\n  });\n\n  // ===========================================\n  // API Routes\n  // ===========================================\n\n  app.use('/api', router);\n\n  // ===========================================\n  // Error Handling\n  // ===========================================\n\n  // 404 handler\n  app.use(notFoundHandler);\n\n  // Global error handler\n  app.use(errorHandler);\n\n  return app;\n}\n","import dotenv from 'dotenv';\nimport path from 'path';\n\n// Load environment variables from root .env file\ndotenv.config({ path: path.resolve(__dirname, '../../../../.env') });\n\nexport const config = {\n  // Environment\n  env: process.env['NODE_ENV'] || 'development',\n  isDev: process.env['NODE_ENV'] === 'development',\n  isProd: process.env['NODE_ENV'] === 'production',\n\n  // Server\n  port: parseInt(process.env['API_PORT'] || '4000', 10),\n  apiUrl: process.env['API_URL'] || 'http://localhost:4000',\n\n  // Database\n  databaseUrl: process.env['DATABASE_URL'] || '',\n\n  // JWT\n  jwtSecret: process.env['JWT_SECRET'] as string,\n  jwtExpiresIn: process.env['JWT_EXPIRES_IN'] || '7d',\n\n  // CORS\n  corsOrigins: (process.env['CORS_ORIGINS'] || 'http://localhost:3000,http://localhost:3001')\n    .split(',')\n    .map(origin => origin.trim())\n    .filter(origin => origin.length > 0),\n\n  // ImageKit\n  imagekit: {\n    publicKey: process.env['IMAGEKIT_PUBLIC_KEY'] || '',\n    privateKey: process.env['IMAGEKIT_PRIVATE_KEY'] || '',\n    urlEndpoint: process.env['IMAGEKIT_URL_ENDPOINT'] || '',\n  },\n\n  // SMTP\n  smtp: {\n    host: process.env['SMTP_HOST'] || '',\n    port: parseInt(process.env['SMTP_PORT'] || '587', 10),\n    secure: process.env['SMTP_SECURE'] === 'true',\n    user: process.env['SMTP_USER'] || '',\n    pass: process.env['SMTP_PASS'] || '',\n    from: process.env['EMAIL_FROM'] || 'noreply@lab404electronics.com',\n  },\n\n  // Stripe (Future)\n  stripe: {\n    secretKey: process.env['STRIPE_SECRET_KEY'] || '',\n    webhookSecret: process.env['STRIPE_WEBHOOK_SECRET'] || '',\n  },\n\n  // Google APIs\n  google: {\n    apiKey: process.env['GOOGLE_API_KEY'] || '',\n    searchEngineId: process.env['GOOGLE_SEARCH_ENGINE_ID'] || '',\n  },\n\n  // Store defaults\n  store: {\n    name: process.env['STORE_NAME'] || 'Lab404Electronics',\n    currency: process.env['STORE_CURRENCY'] || 'USD',\n  },\n\n  // URLs\n  urls: {\n    admin: process.env['ADMIN_URL'] || 'http://localhost:3001',\n    web: process.env['WEB_URL'] || 'http://localhost:3000',\n  },\n} as const;\n\n// Validate required config\nexport function validateConfig(): void {\n  const required = [\n    ['DATABASE_URL', config.databaseUrl],\n    ['JWT_SECRET', config.jwtSecret],\n  ];\n\n  const missing = required.filter(([, value]) => !value).map(([name]) => name);\n\n  if (missing.length > 0) {\n    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);\n  }\n\n  // Validate JWT_SECRET length (minimum 32 characters for security)\n  if (config.jwtSecret.length < 32) {\n    throw new Error('JWT_SECRET must be at least 32 characters long. Generate a secure secret with: openssl rand -base64 32');\n  }\n}\n","import { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { ApiError } from '../utils/errors';\nimport { sendError } from '../utils/response';\nimport { logger } from '../utils/logger';\nimport { config } from '../config';\n\n/**\n * Global error handler middleware\n * Catches all errors and sends appropriate responses\n */\nexport function errorHandler(\n  err: Error,\n  req: Request,\n  res: Response,\n  _next: NextFunction\n): Response {\n  // Log error\n  logger.error('Request error', err, {\n    method: req.method,\n    path: req.path,\n    ip: req.ip,\n  });\n\n  // Handle known API errors\n  if (err instanceof ApiError) {\n    return sendError(res, err.statusCode, err.code, err.message, err.details);\n  }\n\n  // Handle Zod validation errors\n  if (err instanceof ZodError) {\n    const details = err.errors.map((e) => ({\n      field: e.path.join('.'),\n      message: e.message,\n    }));\n\n    return sendError(res, 422, 'VALIDATION_ERROR', 'Validation failed', details);\n  }\n\n  // Handle unexpected errors\n  const message = config.isDev ? err.message : 'Internal server error';\n\n  return sendError(res, 500, 'INTERNAL_SERVER_ERROR', message);\n}\n\n/**\n * 404 Not Found handler\n */\nexport function notFoundHandler(req: Request, res: Response): Response {\n  return sendError(res, 404, 'NOT_FOUND', `Route ${req.method} ${req.path} not found`);\n}\n","/**\n * Base API Error class\n * All custom errors should extend this class\n */\nexport class ApiError extends Error {\n  public readonly statusCode: number;\n  public readonly code: string;\n  public readonly details?: Array<{ field: string; message: string }>;\n\n  constructor(\n    statusCode: number,\n    code: string,\n    message: string,\n    details?: Array<{ field: string; message: string }>\n  ) {\n    super(message);\n    this.statusCode = statusCode;\n    this.code = code;\n    this.details = details;\n    this.name = 'ApiError';\n\n    // Maintains proper stack trace for where our error was thrown\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * 400 Bad Request\n */\nexport class BadRequestError extends ApiError {\n  constructor(message = 'Bad request', details?: Array<{ field: string; message: string }>) {\n    super(400, 'BAD_REQUEST', message, details);\n    this.name = 'BadRequestError';\n  }\n}\n\n/**\n * 401 Unauthorized\n */\nexport class UnauthorizedError extends ApiError {\n  constructor(message = 'Unauthorized') {\n    super(401, 'UNAUTHORIZED', message);\n    this.name = 'UnauthorizedError';\n  }\n}\n\n/**\n * 403 Forbidden\n */\nexport class ForbiddenError extends ApiError {\n  constructor(message = 'Forbidden') {\n    super(403, 'FORBIDDEN', message);\n    this.name = 'ForbiddenError';\n  }\n}\n\n/**\n * 404 Not Found\n */\nexport class NotFoundError extends ApiError {\n  constructor(message = 'Resource not found') {\n    super(404, 'NOT_FOUND', message);\n    this.name = 'NotFoundError';\n  }\n}\n\n/**\n * 409 Conflict\n */\nexport class ConflictError extends ApiError {\n  constructor(message = 'Resource already exists') {\n    super(409, 'CONFLICT', message);\n    this.name = 'ConflictError';\n  }\n}\n\n/**\n * 422 Validation Error\n */\nexport class ValidationError extends ApiError {\n  constructor(message = 'Validation failed', details?: Array<{ field: string; message: string }>) {\n    super(422, 'VALIDATION_ERROR', message, details);\n    this.name = 'ValidationError';\n  }\n}\n\n/**\n * 429 Too Many Requests\n */\nexport class TooManyRequestsError extends ApiError {\n  constructor(message = 'Too many requests') {\n    super(429, 'TOO_MANY_REQUESTS', message);\n    this.name = 'TooManyRequestsError';\n  }\n}\n\n/**\n * 500 Internal Server Error\n */\nexport class InternalServerError extends ApiError {\n  constructor(message = 'Internal server error') {\n    super(500, 'INTERNAL_SERVER_ERROR', message);\n    this.name = 'InternalServerError';\n  }\n}\n","import { Response } from 'express';\nimport type { ApiResponse, PaginationMeta } from '@lab404/shared-types';\n\n/**\n * Send a success response\n */\nexport function sendSuccess<T>(\n  res: Response,\n  data: T,\n  statusCode = 200,\n  meta?: PaginationMeta\n): Response {\n  const response: ApiResponse<T> = {\n    success: true,\n    data,\n    ...(meta && { meta }),\n  };\n\n  return res.status(statusCode).json(response);\n}\n\n/**\n * Send a created response (201)\n */\nexport function sendCreated<T>(res: Response, data: T): Response {\n  return sendSuccess(res, data, 201);\n}\n\n/**\n * Send a no content response (204)\n */\nexport function sendNoContent(res: Response): Response {\n  return res.status(204).send();\n}\n\n/**\n * Send an error response\n */\nexport function sendError(\n  res: Response,\n  statusCode: number,\n  code: string,\n  message: string,\n  details?: Array<{ field: string; message: string }>\n): Response {\n  const response: ApiResponse<never> = {\n    success: false,\n    error: {\n      code,\n      message,\n      ...(details && { details }),\n    },\n  };\n\n  return res.status(statusCode).json(response);\n}\n\n/**\n * Create pagination meta from query params\n */\nexport function createPaginationMeta(\n  page: number,\n  limit: number,\n  total: number\n): PaginationMeta {\n  return {\n    page,\n    limit,\n    total,\n    totalPages: Math.ceil(total / limit),\n  };\n}\n\n/**\n * Parse pagination params from query\n * Handles integer overflow by capping values to safe maximums\n */\nexport function parsePaginationParams(query: {\n  page?: string;\n  limit?: string;\n}): { page: number; limit: number; offset: number } {\n  // Parse with safe integer handling\n  let parsedPage = parseInt(query.page || '1', 10);\n  let parsedLimit = parseInt(query.limit || '20', 10);\n\n  // Handle NaN, Infinity, and negative numbers\n  if (!Number.isFinite(parsedPage) || parsedPage < 1) {\n    parsedPage = 1;\n  }\n  if (!Number.isFinite(parsedLimit) || parsedLimit < 1) {\n    parsedLimit = 20;\n  }\n\n  // Cap to reasonable maximums to prevent integer overflow\n  const MAX_PAGE = 1000000; // 1 million pages max\n  const MAX_LIMIT = 100;\n\n  const page = Math.min(MAX_PAGE, Math.max(1, parsedPage));\n  const limit = Math.min(MAX_LIMIT, Math.max(1, parsedLimit));\n  const offset = (page - 1) * limit;\n\n  return { page, limit, offset };\n}\n","import { config } from '../config';\n\ntype LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\ninterface LogContext {\n  [key: string]: unknown;\n}\n\n/**\n * Simple logger utility\n * In production, replace with a proper logging service (Winston, Pino, etc.)\n */\nclass Logger {\n  private formatMessage(level: LogLevel, message: string, context?: LogContext): string {\n    const timestamp = new Date().toISOString();\n    const contextStr = context ? ` ${JSON.stringify(context)}` : '';\n    return `[${timestamp}] [${level.toUpperCase()}] ${message}${contextStr}`;\n  }\n\n  debug(message: string, context?: LogContext): void {\n    if (config.isDev) {\n      console.debug(this.formatMessage('debug', message, context));\n    }\n  }\n\n  info(message: string, context?: LogContext): void {\n    console.info(this.formatMessage('info', message, context));\n  }\n\n  warn(message: string, context?: LogContext): void {\n    console.warn(this.formatMessage('warn', message, context));\n  }\n\n  error(message: string, error?: Error | unknown, context?: LogContext): void {\n    const errorContext: LogContext = { ...context };\n\n    if (error instanceof Error) {\n      errorContext['errorName'] = error.name;\n      errorContext['errorMessage'] = error.message;\n\n      // Only include stack trace in development\n      if (config.isDev) {\n        errorContext['stack'] = error.stack;\n      }\n    } else if (error) {\n      errorContext['error'] = error;\n    }\n\n    console.error(this.formatMessage('error', message, errorContext));\n  }\n\n  /**\n   * Log HTTP request (for morgan custom format)\n   */\n  http(message: string): void {\n    console.log(`[${new Date().toISOString()}] [HTTP] ${message}`);\n  }\n}\n\nexport const logger = new Logger();\n","import { Request, Response, NextFunction } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { validate as uuidValidate } from 'uuid';\nimport { config } from '../config';\nimport { UnauthorizedError, ForbiddenError } from '../utils/errors';\nimport type { AuthUser, UserRole } from '@lab404/shared-types';\nimport { sessionService } from '../services/session.service';\nimport { logger } from '../utils/logger';\n\n// Extend Express Request type to include user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: AuthUser;\n      sessionId?: string;\n    }\n  }\n}\n\ninterface JwtPayload {\n  userId: string;\n  email: string;\n  role: UserRole;\n  customerId?: string;\n  sessionId?: string;\n}\n\n/**\n * Extract JWT token from cookies or Authorization header\n * Prioritizes httpOnly cookie over Bearer token (for migration)\n */\nfunction extractToken(req: Request): string | null {\n  // Try cookie first (secure, httpOnly)\n  const cookieToken = req.cookies?.['auth_token'];\n  if (cookieToken) {\n    return cookieToken;\n  }\n\n  // Fallback to Bearer header (temporary, for backward compatibility)\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader) {\n    return null;\n  }\n\n  const parts = authHeader.split(' ');\n\n  if (parts.length !== 2 || parts[0] !== 'Bearer') {\n    return null;\n  }\n\n  return parts[1] || null;\n}\n\n/**\n * Verify JWT token and return payload\n */\nfunction verifyToken(token: string): JwtPayload {\n  try {\n    return jwt.verify(token, config.jwtSecret) as JwtPayload;\n  } catch {\n    throw new UnauthorizedError('Invalid or expired token');\n  }\n}\n\n/**\n * Optional authentication middleware\n * Sets req.user if valid token is present, but doesn't require it\n */\nexport function optionalAuth(req: Request, _res: Response, next: NextFunction): void {\n  try {\n    const token = extractToken(req);\n\n    if (token) {\n      const payload = verifyToken(token);\n\n      req.user = {\n        id: payload.userId,\n        email: payload.email,\n        role: payload.role,\n        customerId: payload.customerId,\n        sessionId: payload.sessionId,\n      };\n    }\n\n    // Also check for session ID (for guest carts) - validate UUID format\n    const sessionId = req.headers['x-session-id'] as string | undefined;\n    if (sessionId && uuidValidate(sessionId)) {\n      req.sessionId = sessionId;\n    }\n\n    next();\n  } catch {\n    // Ignore errors for optional auth\n    next();\n  }\n}\n\n/**\n * Required authentication middleware\n * Throws UnauthorizedError if no valid token is present\n */\nexport async function requireAuth(req: Request, _res: Response, next: NextFunction): Promise<void> {\n  try {\n    const token = extractToken(req);\n\n    if (!token) {\n      throw new UnauthorizedError('Authentication required');\n    }\n\n    const payload = verifyToken(token);\n\n    // Validate session if sessionId present\n    if (payload.sessionId) {\n      const session = await sessionService.validateSession(payload.sessionId);\n\n      if (!session) {\n        throw new UnauthorizedError('Session not found or expired');\n      }\n\n      if (!session.isActive) {\n        throw new UnauthorizedError('Session has been revoked');\n      }\n\n      // Update activity (async, non-blocking)\n      sessionService.updateActivity(session.id).catch((err) =>\n        logger.error('Failed to update session activity', { sessionId: session.id, error: err })\n      );\n    }\n\n    req.user = {\n      id: payload.userId,\n      email: payload.email,\n      role: payload.role,\n      customerId: payload.customerId,\n      sessionId: payload.sessionId,\n    };\n\n    next();\n  } catch (error) {\n    next(error);\n  }\n}\n\n/**\n * Admin authorization middleware\n * Must be used after requireAuth\n */\nexport function requireAdmin(req: Request, _res: Response, next: NextFunction): void {\n  try {\n    if (!req.user) {\n      throw new UnauthorizedError('Authentication required');\n    }\n\n    if (req.user.role !== 'admin') {\n      throw new ForbiddenError('Admin access required');\n    }\n\n    next();\n  } catch (error) {\n    next(error);\n  }\n}\n\n/**\n * Generate JWT token for user\n */\nexport function generateToken(payload: JwtPayload): string {\n  return jwt.sign(payload, config.jwtSecret, {\n    expiresIn: config.jwtExpiresIn as jwt.SignOptions['expiresIn'],\n    algorithm: 'HS256',\n  });\n}\n\n/**\n * Get token expiration date\n */\nexport function getTokenExpiration(): Date {\n  const expiresIn = config.jwtExpiresIn;\n  const ms = parseDuration(expiresIn);\n  return new Date(Date.now() + ms);\n}\n\n/**\n * Parse duration string to milliseconds\n */\nfunction parseDuration(duration: string): number {\n  const match = duration.match(/^(\\d+)([smhd])$/);\n\n  if (!match) {\n    return 7 * 24 * 60 * 60 * 1000; // Default 7 days\n  }\n\n  const value = parseInt(match[1] || '0', 10);\n  const unit = match[2];\n\n  switch (unit) {\n    case 's':\n      return value * 1000;\n    case 'm':\n      return value * 60 * 1000;\n    case 'h':\n      return value * 60 * 60 * 1000;\n    case 'd':\n      return value * 24 * 60 * 60 * 1000;\n    default:\n      return 7 * 24 * 60 * 60 * 1000;\n  }\n}\n","import { neon } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport * as schema from './schema';\n\n/**\n * Creates a database client instance\n * @param connectionString - The NeonDB connection string\n * @returns Drizzle database instance\n */\nexport function createDb(connectionString: string) {\n  const sql = neon(connectionString);\n  return drizzle(sql, { schema });\n}\n\n/**\n * Type for the database instance\n */\nexport type Database = ReturnType<typeof createDb>;\n\n/**\n * Get database instance (singleton pattern for serverless)\n */\nlet dbInstance: Database | null = null;\n\nexport function getDb(): Database {\n  if (!dbInstance) {\n    const connectionString = process.env['DATABASE_URL'];\n    if (!connectionString) {\n      throw new Error('DATABASE_URL environment variable is not set');\n    }\n    dbInstance = createDb(connectionString);\n  }\n  return dbInstance;\n}\n\n/**\n * Default database instance for easy importing\n */\nexport const db = getDb();\n","import type { HTTPTransactionOptions, NeonQueryFunction } from '@neondatabase/serverless';\nimport { neon, types } from '@neondatabase/serverless';\nimport type { BatchItem, BatchResponse } from '~/batch.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { Logger } from '~/logger.ts';\nimport { DefaultLogger } from '~/logger.ts';\nimport { PgDatabase } from '~/pg-core/db.ts';\nimport { PgDialect } from '~/pg-core/dialect.ts';\nimport { createTableRelationsHelpers, extractTablesRelationalConfig } from '~/relations.ts';\nimport type { ExtractTablesWithRelations, RelationalSchemaConfig, TablesRelationalConfig } from '~/relations.ts';\nimport { type DrizzleConfig, isConfig } from '~/utils.ts';\nimport { type NeonHttpClient, type NeonHttpQueryResultHKT, NeonHttpSession } from './session.ts';\n\nexport interface NeonDriverOptions {\n\tlogger?: Logger;\n}\n\nexport class NeonHttpDriver {\n\tstatic readonly [entityKind]: string = 'NeonHttpDriver';\n\n\tconstructor(\n\t\tprivate client: NeonHttpClient,\n\t\tprivate dialect: PgDialect,\n\t\tprivate options: NeonDriverOptions = {},\n\t) {\n\t\tthis.initMappers();\n\t}\n\n\tcreateSession(\n\t\tschema: RelationalSchemaConfig<TablesRelationalConfig> | undefined,\n\t): NeonHttpSession<Record<string, unknown>, TablesRelationalConfig> {\n\t\treturn new NeonHttpSession(this.client, this.dialect, schema, { logger: this.options.logger });\n\t}\n\n\tinitMappers() {\n\t\ttypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val);\n\t\ttypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val);\n\t\ttypes.setTypeParser(types.builtins.DATE, (val) => val);\n\t\ttypes.setTypeParser(types.builtins.INTERVAL, (val) => val);\n\t}\n}\n\nfunction wrap<T extends object>(\n\ttarget: T,\n\ttoken: string,\n\tcb: (target: any, p: string | symbol, res: any) => any,\n\tdeep?: boolean,\n) {\n\treturn new Proxy(target, {\n\t\tget(target, p) {\n\t\t\tconst element = target[p as keyof typeof p];\n\t\t\tif (typeof element !== 'function' && (typeof element !== 'object' || element === null)) return element;\n\n\t\t\tif (deep) return wrap(element, token, cb);\n\t\t\tif (p === 'query') return wrap(element, token, cb, true);\n\n\t\t\treturn new Proxy(element as any, {\n\t\t\t\tapply(target, thisArg, argArray) {\n\t\t\t\t\tconst res = target.call(thisArg, ...argArray);\n\t\t\t\t\tif ('setToken' in res && typeof res.setToken === 'function') {\n\t\t\t\t\t\tres.setToken(token);\n\t\t\t\t\t}\n\t\t\t\t\treturn cb(target, p, res);\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t});\n}\n\nexport class NeonHttpDatabase<\n\tTSchema extends Record<string, unknown> = Record<string, never>,\n> extends PgDatabase<NeonHttpQueryResultHKT, TSchema> {\n\tstatic override readonly [entityKind]: string = 'NeonHttpDatabase';\n\n\t$withAuth(\n\t\ttoken: string,\n\t): Omit<\n\t\tthis,\n\t\tExclude<\n\t\t\tkeyof this,\n\t\t\t| '$count'\n\t\t\t| 'delete'\n\t\t\t| 'select'\n\t\t\t| 'selectDistinct'\n\t\t\t| 'selectDistinctOn'\n\t\t\t| 'update'\n\t\t\t| 'insert'\n\t\t\t| 'with'\n\t\t\t| 'query'\n\t\t\t| 'execute'\n\t\t\t| 'refreshMaterializedView'\n\t\t>\n\t> {\n\t\tthis.authToken = token;\n\n\t\treturn wrap(this, token, (target, p, res) => {\n\t\t\tif (p === 'with') {\n\t\t\t\treturn wrap(res, token, (_, __, res) => res);\n\t\t\t}\n\t\t\treturn res;\n\t\t});\n\t}\n\n\t/** @internal */\n\tdeclare readonly session: NeonHttpSession<TSchema, ExtractTablesWithRelations<TSchema>>;\n\n\tasync batch<U extends BatchItem<'pg'>, T extends Readonly<[U, ...U[]]>>(\n\t\tbatch: T,\n\t): Promise<BatchResponse<T>> {\n\t\treturn this.session.batch(batch) as Promise<BatchResponse<T>>;\n\t}\n}\n\nfunction construct<\n\tTSchema extends Record<string, unknown> = Record<string, never>,\n\tTClient extends NeonQueryFunction<any, any> = NeonQueryFunction<any, any>,\n>(\n\tclient: TClient,\n\tconfig: DrizzleConfig<TSchema> = {},\n): NeonHttpDatabase<TSchema> & {\n\t$client: TClient;\n} {\n\tconst dialect = new PgDialect({ casing: config.casing });\n\tlet logger;\n\tif (config.logger === true) {\n\t\tlogger = new DefaultLogger();\n\t} else if (config.logger !== false) {\n\t\tlogger = config.logger;\n\t}\n\n\tlet schema: RelationalSchemaConfig<TablesRelationalConfig> | undefined;\n\tif (config.schema) {\n\t\tconst tablesConfig = extractTablesRelationalConfig(\n\t\t\tconfig.schema,\n\t\t\tcreateTableRelationsHelpers,\n\t\t);\n\t\tschema = {\n\t\t\tfullSchema: config.schema,\n\t\t\tschema: tablesConfig.tables,\n\t\t\ttableNamesMap: tablesConfig.tableNamesMap,\n\t\t};\n\t}\n\n\tconst driver = new NeonHttpDriver(client, dialect, { logger });\n\tconst session = driver.createSession(schema);\n\n\tconst db = new NeonHttpDatabase(\n\t\tdialect,\n\t\tsession,\n\t\tschema as RelationalSchemaConfig<ExtractTablesWithRelations<TSchema>> | undefined,\n\t);\n\t(<any> db).$client = client;\n\n\treturn db as any;\n}\n\nexport function drizzle<\n\tTSchema extends Record<string, unknown> = Record<string, never>,\n\tTClient extends NeonQueryFunction<any, any> = NeonQueryFunction<false, false>,\n>(\n\t...params: [\n\t\tTClient | string,\n\t] | [\n\t\tTClient | string,\n\t\tDrizzleConfig<TSchema>,\n\t] | [\n\t\t(\n\t\t\t& DrizzleConfig<TSchema>\n\t\t\t& ({\n\t\t\t\tconnection: string | ({ connectionString: string } & HTTPTransactionOptions<boolean, boolean>);\n\t\t\t} | {\n\t\t\t\tclient: TClient;\n\t\t\t})\n\t\t),\n\t]\n): NeonHttpDatabase<TSchema> & {\n\t$client: TClient;\n} {\n\tif (typeof params[0] === 'string') {\n\t\tconst instance = neon(params[0] as string);\n\t\treturn construct(instance, params[1]) as any;\n\t}\n\n\tif (isConfig(params[0])) {\n\t\tconst { connection, client, ...drizzleConfig } = params[0] as\n\t\t\t& {\n\t\t\t\tconnection?:\n\t\t\t\t\t| ({\n\t\t\t\t\t\tconnectionString: string;\n\t\t\t\t\t} & HTTPTransactionOptions<boolean, boolean>)\n\t\t\t\t\t| string;\n\t\t\t\tclient?: TClient;\n\t\t\t}\n\t\t\t& DrizzleConfig<TSchema>;\n\n\t\tif (client) return construct(client, drizzleConfig);\n\n\t\tif (typeof connection === 'object') {\n\t\t\tconst { connectionString, ...options } = connection;\n\n\t\t\tconst instance = neon(connectionString, options);\n\n\t\t\treturn construct(instance, drizzleConfig) as any;\n\t\t}\n\n\t\tconst instance = neon(connection!);\n\n\t\treturn construct(instance, drizzleConfig) as any;\n\t}\n\n\treturn construct(params[0] as TClient, params[1] as DrizzleConfig<TSchema> | undefined) as any;\n}\n\nexport namespace drizzle {\n\texport function mock<TSchema extends Record<string, unknown> = Record<string, never>>(\n\t\tconfig?: DrizzleConfig<TSchema>,\n\t): NeonHttpDatabase<TSchema> & {\n\t\t$client: '$client is not available on drizzle.mock()';\n\t} {\n\t\treturn construct({} as any, config) as any;\n\t}\n}\n","export const entityKind = Symbol.for('drizzle:entityKind');\nexport const hasOwnEntityKind = Symbol.for('drizzle:hasOwnEntityKind');\n\nexport interface DrizzleEntity {\n\t[entityKind]: string;\n}\n\nexport type DrizzleEntityClass<T> =\n\t& ((abstract new(...args: any[]) => T) | (new(...args: any[]) => T))\n\t& DrizzleEntity;\n\nexport function is<T extends DrizzleEntityClass<any>>(value: any, type: T): value is InstanceType<T> {\n\tif (!value || typeof value !== 'object') {\n\t\treturn false;\n\t}\n\n\tif (value instanceof type) { // eslint-disable-line no-instanceof/no-instanceof\n\t\treturn true;\n\t}\n\n\tif (!Object.prototype.hasOwnProperty.call(type, entityKind)) {\n\t\tthrow new Error(\n\t\t\t`Class \"${\n\t\t\t\ttype.name ?? '<unknown>'\n\t\t\t}\" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`,\n\t\t);\n\t}\n\n\tlet cls = Object.getPrototypeOf(value).constructor;\n\tif (cls) {\n\t\t// Traverse the prototype chain to find the entityKind\n\t\twhile (cls) {\n\t\t\tif (entityKind in cls && cls[entityKind] === type[entityKind]) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tcls = Object.getPrototypeOf(cls);\n\t\t}\n\t}\n\n\treturn false;\n}\n","import { entityKind } from '~/entity.ts';\n\nexport interface Logger {\n\tlogQuery(query: string, params: unknown[]): void;\n}\n\nexport interface LogWriter {\n\twrite(message: string): void;\n}\n\nexport class ConsoleLogWriter implements LogWriter {\n\tstatic readonly [entityKind]: string = 'ConsoleLogWriter';\n\n\twrite(message: string) {\n\t\tconsole.log(message);\n\t}\n}\n\nexport class DefaultLogger implements Logger {\n\tstatic readonly [entityKind]: string = 'DefaultLogger';\n\n\treadonly writer: LogWriter;\n\n\tconstructor(config?: { writer: LogWriter }) {\n\t\tthis.writer = config?.writer ?? new ConsoleLogWriter();\n\t}\n\n\tlogQuery(query: string, params: unknown[]): void {\n\t\tconst stringifiedParams = params.map((p) => {\n\t\t\ttry {\n\t\t\t\treturn JSON.stringify(p);\n\t\t\t} catch {\n\t\t\t\treturn String(p);\n\t\t\t}\n\t\t});\n\t\tconst paramsStr = stringifiedParams.length ? ` -- params: [${stringifiedParams.join(', ')}]` : '';\n\t\tthis.writer.write(`Query: ${query}${paramsStr}`);\n\t}\n}\n\nexport class NoopLogger implements Logger {\n\tstatic readonly [entityKind]: string = 'NoopLogger';\n\n\tlogQuery(): void {\n\t\t// noop\n\t}\n}\n","import { entityKind } from '~/entity.ts';\n\nexport abstract class QueryPromise<T> implements Promise<T> {\n\tstatic readonly [entityKind]: string = 'QueryPromise';\n\n\t[Symbol.toStringTag] = 'QueryPromise';\n\n\tcatch<TResult = never>(\n\t\tonRejected?: ((reason: any) => TResult | PromiseLike<TResult>) | null | undefined,\n\t): Promise<T | TResult> {\n\t\treturn this.then(undefined, onRejected);\n\t}\n\n\tfinally(onFinally?: (() => void) | null | undefined): Promise<T> {\n\t\treturn this.then(\n\t\t\t(value) => {\n\t\t\t\tonFinally?.();\n\t\t\t\treturn value;\n\t\t\t},\n\t\t\t(reason) => {\n\t\t\t\tonFinally?.();\n\t\t\t\tthrow reason;\n\t\t\t},\n\t\t);\n\t}\n\n\tthen<TResult1 = T, TResult2 = never>(\n\t\tonFulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | undefined | null,\n\t\tonRejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | undefined | null,\n\t): Promise<TResult1 | TResult2> {\n\t\treturn this.execute().then(onFulfilled, onRejected);\n\t}\n\n\tabstract execute(): Promise<T>;\n}\n","/** @internal */\nexport const TableName = Symbol.for('drizzle:Name');\n","import type { Column, GetColumnData } from './column.ts';\nimport { entityKind } from './entity.ts';\nimport type { OptionalKeyOnly, RequiredKeyOnly } from './operations.ts';\nimport type { ExtraConfigColumn } from './pg-core/index.ts';\nimport type { SQLWrapper } from './sql/sql.ts';\nimport { TableName } from './table.utils.ts';\nimport type { Simplify, Update } from './utils.ts';\n\nexport interface TableConfig<TColumn extends Column = Column<any>> {\n\tname: string;\n\tschema: string | undefined;\n\tcolumns: Record<string, TColumn>;\n\tdialect: string;\n}\n\nexport type UpdateTableConfig<T extends TableConfig, TUpdate extends Partial<TableConfig>> = Required<\n\tUpdate<T, TUpdate>\n>;\n\n/** @internal */\nexport const Schema = Symbol.for('drizzle:Schema');\n\n/** @internal */\nexport const Columns = Symbol.for('drizzle:Columns');\n\n/** @internal */\nexport const ExtraConfigColumns = Symbol.for('drizzle:ExtraConfigColumns');\n\n/** @internal */\nexport const OriginalName = Symbol.for('drizzle:OriginalName');\n\n/** @internal */\nexport const BaseName = Symbol.for('drizzle:BaseName');\n\n/** @internal */\nexport const IsAlias = Symbol.for('drizzle:IsAlias');\n\n/** @internal */\nexport const ExtraConfigBuilder = Symbol.for('drizzle:ExtraConfigBuilder');\n\nconst IsDrizzleTable = Symbol.for('drizzle:IsDrizzleTable');\n\nexport interface Table<\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tT extends TableConfig = TableConfig,\n> extends SQLWrapper {\n\t// SQLWrapper runtime implementation is defined in 'sql/sql.ts'\n}\n\nexport class Table<T extends TableConfig = TableConfig> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Table';\n\n\tdeclare readonly _: {\n\t\treadonly brand: 'Table';\n\t\treadonly config: T;\n\t\treadonly name: T['name'];\n\t\treadonly schema: T['schema'];\n\t\treadonly columns: T['columns'];\n\t\treadonly inferSelect: InferSelectModel<Table<T>>;\n\t\treadonly inferInsert: InferInsertModel<Table<T>>;\n\t};\n\n\tdeclare readonly $inferSelect: InferSelectModel<Table<T>>;\n\tdeclare readonly $inferInsert: InferInsertModel<Table<T>>;\n\n\t/** @internal */\n\tstatic readonly Symbol = {\n\t\tName: TableName as typeof TableName,\n\t\tSchema: Schema as typeof Schema,\n\t\tOriginalName: OriginalName as typeof OriginalName,\n\t\tColumns: Columns as typeof Columns,\n\t\tExtraConfigColumns: ExtraConfigColumns as typeof ExtraConfigColumns,\n\t\tBaseName: BaseName as typeof BaseName,\n\t\tIsAlias: IsAlias as typeof IsAlias,\n\t\tExtraConfigBuilder: ExtraConfigBuilder as typeof ExtraConfigBuilder,\n\t};\n\n\t/**\n\t * @internal\n\t * Can be changed if the table is aliased.\n\t */\n\t[TableName]: string;\n\n\t/**\n\t * @internal\n\t * Used to store the original name of the table, before any aliasing.\n\t */\n\t[OriginalName]: string;\n\n\t/** @internal */\n\t[Schema]: string | undefined;\n\n\t/** @internal */\n\t[Columns]!: T['columns'];\n\n\t/** @internal */\n\t[ExtraConfigColumns]!: Record<string, ExtraConfigColumn>;\n\n\t/**\n\t *  @internal\n\t * Used to store the table name before the transformation via the `tableCreator` functions.\n\t */\n\t[BaseName]: string;\n\n\t/** @internal */\n\t[IsAlias] = false;\n\n\t/** @internal */\n\t[IsDrizzleTable] = true;\n\n\t/** @internal */\n\t[ExtraConfigBuilder]: ((self: any) => Record<string, unknown> | unknown[]) | undefined = undefined;\n\n\tconstructor(name: string, schema: string | undefined, baseName: string) {\n\t\tthis[TableName] = this[OriginalName] = name;\n\t\tthis[Schema] = schema;\n\t\tthis[BaseName] = baseName;\n\t}\n}\n\nexport function isTable(table: unknown): table is Table {\n\treturn typeof table === 'object' && table !== null && IsDrizzleTable in table;\n}\n\n/**\n * Any table with a specified boundary.\n *\n * @example\n\t```ts\n\t// Any table with a specific name\n\ttype AnyUsersTable = AnyTable<{ name: 'users' }>;\n\t```\n *\n * To describe any table with any config, simply use `Table` without any type arguments, like this:\n *\n\t```ts\n\tfunction needsTable(table: Table) {\n\t\t...\n\t}\n\t```\n */\nexport type AnyTable<TPartial extends Partial<TableConfig>> = Table<UpdateTableConfig<TableConfig, TPartial>>;\n\nexport function getTableName<T extends Table>(table: T): T['_']['name'] {\n\treturn table[TableName];\n}\n\nexport function getTableUniqueName<T extends Table>(table: T): `${T['_']['schema']}.${T['_']['name']}` {\n\treturn `${table[Schema] ?? 'public'}.${table[TableName]}`;\n}\n\nexport type MapColumnName<TName extends string, TColumn extends Column, TDBColumNames extends boolean> =\n\tTDBColumNames extends true ? TColumn['_']['name']\n\t\t: TName;\n\nexport type InferModelFromColumns<\n\tTColumns extends Record<string, Column>,\n\tTInferMode extends 'select' | 'insert' = 'select',\n\tTConfig extends { dbColumnNames: boolean; override?: boolean } = { dbColumnNames: false; override: false },\n> = Simplify<\n\tTInferMode extends 'insert' ?\n\t\t\t& {\n\t\t\t\t[\n\t\t\t\t\tKey in keyof TColumns & string as RequiredKeyOnly<\n\t\t\t\t\t\tMapColumnName<Key, TColumns[Key], TConfig['dbColumnNames']>,\n\t\t\t\t\t\tTColumns[Key]\n\t\t\t\t\t>\n\t\t\t\t]: GetColumnData<TColumns[Key], 'query'>;\n\t\t\t}\n\t\t\t& {\n\t\t\t\t[\n\t\t\t\t\tKey in keyof TColumns & string as OptionalKeyOnly<\n\t\t\t\t\t\tMapColumnName<Key, TColumns[Key], TConfig['dbColumnNames']>,\n\t\t\t\t\t\tTColumns[Key],\n\t\t\t\t\t\tTConfig['override']\n\t\t\t\t\t>\n\t\t\t\t]?: GetColumnData<TColumns[Key], 'query'>;\n\t\t\t}\n\t\t: {\n\t\t\t[\n\t\t\t\tKey in keyof TColumns & string as MapColumnName<\n\t\t\t\t\tKey,\n\t\t\t\t\tTColumns[Key],\n\t\t\t\t\tTConfig['dbColumnNames']\n\t\t\t\t>\n\t\t\t]: GetColumnData<TColumns[Key], 'query'>;\n\t\t}\n>;\n\n/** @deprecated Use one of the alternatives: {@link InferSelectModel} / {@link InferInsertModel}, or `table.$inferSelect` / `table.$inferInsert`\n */\nexport type InferModel<\n\tTTable extends Table,\n\tTInferMode extends 'select' | 'insert' = 'select',\n\tTConfig extends { dbColumnNames: boolean } = { dbColumnNames: false },\n> = InferModelFromColumns<TTable['_']['columns'], TInferMode, TConfig>;\n\nexport type InferSelectModel<\n\tTTable extends Table,\n\tTConfig extends { dbColumnNames: boolean } = { dbColumnNames: false },\n> = InferModelFromColumns<TTable['_']['columns'], 'select', TConfig>;\n\nexport type InferInsertModel<\n\tTTable extends Table,\n\tTConfig extends { dbColumnNames: boolean; override?: boolean } = { dbColumnNames: false; override: false },\n> = InferModelFromColumns<TTable['_']['columns'], 'insert', TConfig>;\n","export function iife<T extends unknown[], U>(fn: (...args: T) => U, ...args: T): U {\n\treturn fn(...args);\n}\n","// package.json\nvar version = \"0.36.4\";\n\n// src/version.ts\nvar compatibilityVersion = 10;\nexport {\n  compatibilityVersion,\n  version as npmVersion\n};\n","import type { Span, Tracer } from '@opentelemetry/api';\nimport { iife } from '~/tracing-utils.ts';\nimport { npmVersion } from '~/version.ts';\n\nlet otel: typeof import('@opentelemetry/api') | undefined;\nlet rawTracer: Tracer | undefined;\n// try {\n// \totel = await import('@opentelemetry/api');\n// } catch (err: any) {\n// \tif (err.code !== 'MODULE_NOT_FOUND' && err.code !== 'ERR_MODULE_NOT_FOUND') {\n// \t\tthrow err;\n// \t}\n// }\n\ntype SpanName =\n\t| 'drizzle.operation'\n\t| 'drizzle.prepareQuery'\n\t| 'drizzle.buildSQL'\n\t| 'drizzle.execute'\n\t| 'drizzle.driver.execute'\n\t| 'drizzle.mapResponse';\n\n/** @internal */\nexport const tracer = {\n\tstartActiveSpan<F extends (span?: Span) => unknown>(name: SpanName, fn: F): ReturnType<F> {\n\t\tif (!otel) {\n\t\t\treturn fn() as ReturnType<F>;\n\t\t}\n\n\t\tif (!rawTracer) {\n\t\t\trawTracer = otel.trace.getTracer('drizzle-orm', npmVersion);\n\t\t}\n\n\t\treturn iife(\n\t\t\t(otel, rawTracer) =>\n\t\t\t\trawTracer.startActiveSpan(\n\t\t\t\t\tname,\n\t\t\t\t\t((span: Span) => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\treturn fn(span);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tspan.setStatus({\n\t\t\t\t\t\t\t\tcode: otel.SpanStatusCode.ERROR,\n\t\t\t\t\t\t\t\tmessage: e instanceof Error ? e.message : 'Unknown error', // eslint-disable-line no-instanceof/no-instanceof\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthrow e;\n\t\t\t\t\t\t} finally {\n\t\t\t\t\t\t\tspan.end();\n\t\t\t\t\t\t}\n\t\t\t\t\t}) as F,\n\t\t\t\t),\n\t\t\totel,\n\t\t\trawTracer,\n\t\t);\n\t},\n};\n","import type {\n\tColumnBuilderBaseConfig,\n\tColumnBuilderRuntimeConfig,\n\tColumnDataType,\n\tGeneratedColumnConfig,\n\tGeneratedIdentityConfig,\n} from './column-builder.ts';\nimport { entityKind } from './entity.ts';\nimport type { DriverValueMapper, SQL, SQLWrapper } from './sql/sql.ts';\nimport type { Table } from './table.ts';\nimport type { Update } from './utils.ts';\n\nexport interface ColumnBaseConfig<\n\tTDataType extends ColumnDataType,\n\tTColumnType extends string,\n> extends ColumnBuilderBaseConfig<TDataType, TColumnType> {\n\ttableName: string;\n\tnotNull: boolean;\n\thasDefault: boolean;\n\tisPrimaryKey: boolean;\n\tisAutoincrement: boolean;\n\thasRuntimeDefault: boolean;\n}\n\nexport type ColumnTypeConfig<T extends ColumnBaseConfig<ColumnDataType, string>, TTypeConfig extends object> = T & {\n\tbrand: 'Column';\n\ttableName: T['tableName'];\n\tname: T['name'];\n\tdataType: T['dataType'];\n\tcolumnType: T['columnType'];\n\tdata: T['data'];\n\tdriverParam: T['driverParam'];\n\tnotNull: T['notNull'];\n\thasDefault: T['hasDefault'];\n\tisPrimaryKey: T['isPrimaryKey'];\n\tisAutoincrement: T['isAutoincrement'];\n\thasRuntimeDefault: T['hasRuntimeDefault'];\n\tenumValues: T['enumValues'];\n\tbaseColumn: T extends { baseColumn: infer U } ? U : unknown;\n\tgenerated: GeneratedColumnConfig<T['data']> | undefined;\n\tidentity: undefined | 'always' | 'byDefault';\n} & TTypeConfig;\n\nexport type ColumnRuntimeConfig<TData, TRuntimeConfig extends object> = ColumnBuilderRuntimeConfig<\n\tTData,\n\tTRuntimeConfig\n>;\n\nexport interface Column<\n\tT extends ColumnBaseConfig<ColumnDataType, string> = ColumnBaseConfig<ColumnDataType, string>,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTRuntimeConfig extends object = object,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTTypeConfig extends object = object,\n> extends DriverValueMapper<T['data'], T['driverParam']>, SQLWrapper {\n\t// SQLWrapper runtime implementation is defined in 'sql/sql.ts'\n}\n/*\n\t`Column` only accepts a full `ColumnConfig` as its generic.\n\tTo infer parts of the config, use `AnyColumn` that accepts a partial config.\n\tSee `GetColumnData` for example usage of inferring.\n*/\nexport abstract class Column<\n\tT extends ColumnBaseConfig<ColumnDataType, string> = ColumnBaseConfig<ColumnDataType, string>,\n\tTRuntimeConfig extends object = object,\n\tTTypeConfig extends object = object,\n> implements DriverValueMapper<T['data'], T['driverParam']>, SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Column';\n\n\tdeclare readonly _: ColumnTypeConfig<T, TTypeConfig>;\n\n\treadonly name: string;\n\treadonly keyAsName: boolean;\n\treadonly primary: boolean;\n\treadonly notNull: boolean;\n\treadonly default: T['data'] | SQL | undefined;\n\treadonly defaultFn: (() => T['data'] | SQL) | undefined;\n\treadonly onUpdateFn: (() => T['data'] | SQL) | undefined;\n\treadonly hasDefault: boolean;\n\treadonly isUnique: boolean;\n\treadonly uniqueName: string | undefined;\n\treadonly uniqueType: string | undefined;\n\treadonly dataType: T['dataType'];\n\treadonly columnType: T['columnType'];\n\treadonly enumValues: T['enumValues'] = undefined;\n\treadonly generated: GeneratedColumnConfig<T['data']> | undefined = undefined;\n\treadonly generatedIdentity: GeneratedIdentityConfig | undefined = undefined;\n\n\tprotected config: ColumnRuntimeConfig<T['data'], TRuntimeConfig>;\n\n\tconstructor(\n\t\treadonly table: Table,\n\t\tconfig: ColumnRuntimeConfig<T['data'], TRuntimeConfig>,\n\t) {\n\t\tthis.config = config;\n\t\tthis.name = config.name;\n\t\tthis.keyAsName = config.keyAsName;\n\t\tthis.notNull = config.notNull;\n\t\tthis.default = config.default;\n\t\tthis.defaultFn = config.defaultFn;\n\t\tthis.onUpdateFn = config.onUpdateFn;\n\t\tthis.hasDefault = config.hasDefault;\n\t\tthis.primary = config.primaryKey;\n\t\tthis.isUnique = config.isUnique;\n\t\tthis.uniqueName = config.uniqueName;\n\t\tthis.uniqueType = config.uniqueType;\n\t\tthis.dataType = config.dataType as T['dataType'];\n\t\tthis.columnType = config.columnType;\n\t\tthis.generated = config.generated;\n\t\tthis.generatedIdentity = config.generatedIdentity;\n\t}\n\n\tabstract getSQLType(): string;\n\n\tmapFromDriverValue(value: unknown): unknown {\n\t\treturn value;\n\t}\n\n\tmapToDriverValue(value: unknown): unknown {\n\t\treturn value;\n\t}\n\n\t// ** @internal */\n\tshouldDisableInsert(): boolean {\n\t\treturn this.config.generated !== undefined && this.config.generated.type !== 'byDefault';\n\t}\n}\n\nexport type UpdateColConfig<\n\tT extends ColumnBaseConfig<ColumnDataType, string>,\n\tTUpdate extends Partial<ColumnBaseConfig<ColumnDataType, string>>,\n> = Update<T, TUpdate>;\n\nexport type AnyColumn<TPartial extends Partial<ColumnBaseConfig<ColumnDataType, string>> = {}> = Column<\n\tRequired<Update<ColumnBaseConfig<ColumnDataType, string>, TPartial>>\n>;\n\nexport type GetColumnData<TColumn extends Column, TInferMode extends 'query' | 'raw' = 'query'> =\n\t// dprint-ignore\n\tTInferMode extends 'raw' // Raw mode\n\t\t? TColumn['_']['data'] // Just return the underlying type\n\t\t: TColumn['_']['notNull'] extends true // Query mode\n\t\t? TColumn['_']['data'] // Query mode, not null\n\t\t: TColumn['_']['data'] | null; // Query mode, nullable\n\nexport type InferColumnsDataTypes<TColumns extends Record<string, Column>> = {\n\t[Key in keyof TColumns]: GetColumnData<TColumns[Key], 'query'>;\n};\n","import { entityKind } from '~/entity.ts';\nimport type { Column } from './column.ts';\nimport type { MySqlColumn } from './mysql-core/index.ts';\nimport type { ExtraConfigColumn, PgColumn, PgSequenceOptions } from './pg-core/index.ts';\nimport type { SQL } from './sql/sql.ts';\nimport type { SQLiteColumn } from './sqlite-core/index.ts';\nimport type { Assume, Simplify } from './utils.ts';\n\nexport type ColumnDataType =\n\t| 'string'\n\t| 'number'\n\t| 'boolean'\n\t| 'array'\n\t| 'json'\n\t| 'date'\n\t| 'bigint'\n\t| 'custom'\n\t| 'buffer';\n\nexport type Dialect = 'pg' | 'mysql' | 'sqlite' | 'common';\n\nexport type GeneratedStorageMode = 'virtual' | 'stored';\n\nexport type GeneratedType = 'always' | 'byDefault';\n\nexport type GeneratedColumnConfig<TDataType> = {\n\tas: TDataType | SQL | (() => SQL);\n\ttype?: GeneratedType;\n\tmode?: GeneratedStorageMode;\n};\n\nexport type GeneratedIdentityConfig = {\n\tsequenceName?: string;\n\tsequenceOptions?: PgSequenceOptions;\n\ttype: 'always' | 'byDefault';\n};\n\nexport interface ColumnBuilderBaseConfig<TDataType extends ColumnDataType, TColumnType extends string> {\n\tname: string;\n\tdataType: TDataType;\n\tcolumnType: TColumnType;\n\tdata: unknown;\n\tdriverParam: unknown;\n\tenumValues: string[] | undefined;\n}\n\nexport type MakeColumnConfig<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTTableName extends string,\n\tTData = T extends { $type: infer U } ? U : T['data'],\n> = {\n\tname: T['name'];\n\ttableName: TTableName;\n\tdataType: T['dataType'];\n\tcolumnType: T['columnType'];\n\tdata: TData;\n\tdriverParam: T['driverParam'];\n\tnotNull: T extends { notNull: true } ? true : false;\n\thasDefault: T extends { hasDefault: true } ? true : false;\n\tisPrimaryKey: T extends { isPrimaryKey: true } ? true : false;\n\tisAutoincrement: T extends { isAutoincrement: true } ? true : false;\n\thasRuntimeDefault: T extends { hasRuntimeDefault: true } ? true : false;\n\tenumValues: T['enumValues'];\n\tbaseColumn: T extends { baseBuilder: infer U extends ColumnBuilderBase } ? BuildColumn<TTableName, U, 'common'>\n\t\t: never;\n\tidentity: T extends { identity: 'always' } ? 'always' : T extends { identity: 'byDefault' } ? 'byDefault' : undefined;\n\tgenerated: T extends { generated: infer G } ? unknown extends G ? undefined\n\t\t: G extends undefined ? undefined\n\t\t: G\n\t\t: undefined;\n} & {};\n\nexport type ColumnBuilderTypeConfig<\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTTypeConfig extends object = object,\n> = Simplify<\n\t& {\n\t\tbrand: 'ColumnBuilder';\n\t\tname: T['name'];\n\t\tdataType: T['dataType'];\n\t\tcolumnType: T['columnType'];\n\t\tdata: T['data'];\n\t\tdriverParam: T['driverParam'];\n\t\tnotNull: T extends { notNull: infer U } ? U : boolean;\n\t\thasDefault: T extends { hasDefault: infer U } ? U : boolean;\n\t\tenumValues: T['enumValues'];\n\t\tidentity: T extends { identity: infer U } ? U : unknown;\n\t\tgenerated: T extends { generated: infer G } ? G extends undefined ? unknown : G : unknown;\n\t}\n\t& TTypeConfig\n>;\n\nexport type ColumnBuilderRuntimeConfig<TData, TRuntimeConfig extends object = object> = {\n\tname: string;\n\tkeyAsName: boolean;\n\tnotNull: boolean;\n\tdefault: TData | SQL | undefined;\n\tdefaultFn: (() => TData | SQL) | undefined;\n\tonUpdateFn: (() => TData | SQL) | undefined;\n\thasDefault: boolean;\n\tprimaryKey: boolean;\n\tisUnique: boolean;\n\tuniqueName: string | undefined;\n\tuniqueType: string | undefined;\n\tdataType: string;\n\tcolumnType: string;\n\tgenerated: GeneratedColumnConfig<TData> | undefined;\n\tgeneratedIdentity: GeneratedIdentityConfig | undefined;\n} & TRuntimeConfig;\n\nexport interface ColumnBuilderExtraConfig {\n\tprimaryKeyHasDefault?: boolean;\n}\n\nexport type NotNull<T extends ColumnBuilderBase> = T & {\n\t_: {\n\t\tnotNull: true;\n\t};\n};\n\nexport type HasDefault<T extends ColumnBuilderBase> = T & {\n\t_: {\n\t\thasDefault: true;\n\t};\n};\n\nexport type IsPrimaryKey<T extends ColumnBuilderBase> = T & {\n\t_: {\n\t\tisPrimaryKey: true;\n\t};\n};\n\nexport type IsAutoincrement<T extends ColumnBuilderBase> = T & {\n\t_: {\n\t\tisAutoincrement: true;\n\t};\n};\n\nexport type HasRuntimeDefault<T extends ColumnBuilderBase> = T & {\n\t_: {\n\t\thasRuntimeDefault: true;\n\t};\n};\n\nexport type $Type<T extends ColumnBuilderBase, TType> = T & {\n\t_: {\n\t\t$type: TType;\n\t};\n};\n\nexport type HasGenerated<T extends ColumnBuilderBase, TGenerated extends {} = {}> = T & {\n\t_: {\n\t\thasDefault: true;\n\t\tgenerated: TGenerated;\n\t};\n};\n\nexport type IsIdentity<\n\tT extends ColumnBuilderBase,\n\tTType extends 'always' | 'byDefault',\n> = T & {\n\t_: {\n\t\tnotNull: true;\n\t\thasDefault: true;\n\t\tidentity: TType;\n\t};\n};\nexport interface ColumnBuilderBase<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string> = ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTTypeConfig extends object = object,\n> {\n\t_: ColumnBuilderTypeConfig<T, TTypeConfig>;\n}\n\n// To understand how to use `ColumnBuilder` and `AnyColumnBuilder`, see `Column` and `AnyColumn` documentation.\nexport abstract class ColumnBuilder<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string> = ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTRuntimeConfig extends object = object,\n\tTTypeConfig extends object = object,\n\tTExtraConfig extends ColumnBuilderExtraConfig = ColumnBuilderExtraConfig,\n> implements ColumnBuilderBase<T, TTypeConfig> {\n\tstatic readonly [entityKind]: string = 'ColumnBuilder';\n\n\tdeclare _: ColumnBuilderTypeConfig<T, TTypeConfig>;\n\n\tprotected config: ColumnBuilderRuntimeConfig<T['data'], TRuntimeConfig>;\n\n\tconstructor(name: T['name'], dataType: T['dataType'], columnType: T['columnType']) {\n\t\tthis.config = {\n\t\t\tname,\n\t\t\tkeyAsName: name === '',\n\t\t\tnotNull: false,\n\t\t\tdefault: undefined,\n\t\t\thasDefault: false,\n\t\t\tprimaryKey: false,\n\t\t\tisUnique: false,\n\t\t\tuniqueName: undefined,\n\t\t\tuniqueType: undefined,\n\t\t\tdataType,\n\t\t\tcolumnType,\n\t\t\tgenerated: undefined,\n\t\t} as ColumnBuilderRuntimeConfig<T['data'], TRuntimeConfig>;\n\t}\n\n\t/**\n\t * Changes the data type of the column. Commonly used with `json` columns. Also, useful for branded types.\n\t *\n\t * @example\n\t * ```ts\n\t * const users = pgTable('users', {\n\t * \tid: integer('id').$type<UserId>().primaryKey(),\n\t * \tdetails: json('details').$type<UserDetails>().notNull(),\n\t * });\n\t * ```\n\t */\n\t$type<TType>(): $Type<this, TType> {\n\t\treturn this as $Type<this, TType>;\n\t}\n\n\t/**\n\t * Adds a `not null` clause to the column definition.\n\t *\n\t * Affects the `select` model of the table - columns *without* `not null` will be nullable on select.\n\t */\n\tnotNull(): NotNull<this> {\n\t\tthis.config.notNull = true;\n\t\treturn this as NotNull<this>;\n\t}\n\n\t/**\n\t * Adds a `default <value>` clause to the column definition.\n\t *\n\t * Affects the `insert` model of the table - columns *with* `default` are optional on insert.\n\t *\n\t * If you need to set a dynamic default value, use {@link $defaultFn} instead.\n\t */\n\tdefault(value: (this['_'] extends { $type: infer U } ? U : this['_']['data']) | SQL): HasDefault<this> {\n\t\tthis.config.default = value;\n\t\tthis.config.hasDefault = true;\n\t\treturn this as HasDefault<this>;\n\t}\n\n\t/**\n\t * Adds a dynamic default value to the column.\n\t * The function will be called when the row is inserted, and the returned value will be used as the column value.\n\t *\n\t * **Note:** This value does not affect the `drizzle-kit` behavior, it is only used at runtime in `drizzle-orm`.\n\t */\n\t$defaultFn(\n\t\tfn: () => (this['_'] extends { $type: infer U } ? U : this['_']['data']) | SQL,\n\t): HasRuntimeDefault<HasDefault<this>> {\n\t\tthis.config.defaultFn = fn;\n\t\tthis.config.hasDefault = true;\n\t\treturn this as HasRuntimeDefault<HasDefault<this>>;\n\t}\n\n\t/**\n\t * Alias for {@link $defaultFn}.\n\t */\n\t$default = this.$defaultFn;\n\n\t/**\n\t * Adds a dynamic update value to the column.\n\t * The function will be called when the row is updated, and the returned value will be used as the column value if none is provided.\n\t * If no `default` (or `$defaultFn`) value is provided, the function will be called when the row is inserted as well, and the returned value will be used as the column value.\n\t *\n\t * **Note:** This value does not affect the `drizzle-kit` behavior, it is only used at runtime in `drizzle-orm`.\n\t */\n\t$onUpdateFn(\n\t\tfn: () => (this['_'] extends { $type: infer U } ? U : this['_']['data']) | SQL,\n\t): HasDefault<this> {\n\t\tthis.config.onUpdateFn = fn;\n\t\tthis.config.hasDefault = true;\n\t\treturn this as HasDefault<this>;\n\t}\n\n\t/**\n\t * Alias for {@link $onUpdateFn}.\n\t */\n\t$onUpdate = this.$onUpdateFn;\n\n\t/**\n\t * Adds a `primary key` clause to the column definition. This implicitly makes the column `not null`.\n\t *\n\t * In SQLite, `integer primary key` implicitly makes the column auto-incrementing.\n\t */\n\tprimaryKey(): TExtraConfig['primaryKeyHasDefault'] extends true ? IsPrimaryKey<HasDefault<NotNull<this>>>\n\t\t: IsPrimaryKey<NotNull<this>>\n\t{\n\t\tthis.config.primaryKey = true;\n\t\tthis.config.notNull = true;\n\t\treturn this as TExtraConfig['primaryKeyHasDefault'] extends true ? IsPrimaryKey<HasDefault<NotNull<this>>>\n\t\t\t: IsPrimaryKey<NotNull<this>>;\n\t}\n\n\tabstract generatedAlwaysAs(\n\t\tas: SQL | T['data'] | (() => SQL),\n\t\tconfig?: Partial<GeneratedColumnConfig<unknown>>,\n\t): HasGenerated<this, {\n\t\ttype: 'always';\n\t}>;\n\n\t/** @internal Sets the name of the column to the key within the table definition if a name was not given. */\n\tsetName(name: string) {\n\t\tif (this.config.name !== '') return;\n\t\tthis.config.name = name;\n\t}\n}\n\nexport type BuildColumn<\n\tTTableName extends string,\n\tTBuilder extends ColumnBuilderBase,\n\tTDialect extends Dialect,\n> = TDialect extends 'pg' ? PgColumn<MakeColumnConfig<TBuilder['_'], TTableName>>\n\t: TDialect extends 'mysql' ? MySqlColumn<MakeColumnConfig<TBuilder['_'], TTableName>>\n\t: TDialect extends 'sqlite' ? SQLiteColumn<MakeColumnConfig<TBuilder['_'], TTableName>>\n\t: TDialect extends 'common' ? Column<MakeColumnConfig<TBuilder['_'], TTableName>>\n\t: never;\n\nexport type BuildIndexColumn<\n\tTDialect extends Dialect,\n> = TDialect extends 'pg' ? ExtraConfigColumn : never;\n\n// TODO\n// try to make sql as well + indexRaw\n\n// optional after everything will be working as expected\n// also try to leave only needed methods for extraConfig\n// make an error if I pass .asc() to fk and so on\n\nexport type BuildColumns<\n\tTTableName extends string,\n\tTConfigMap extends Record<string, ColumnBuilderBase>,\n\tTDialect extends Dialect,\n> =\n\t& {\n\t\t[Key in keyof TConfigMap]: BuildColumn<TTableName, {\n\t\t\t_:\n\t\t\t\t& Omit<TConfigMap[Key]['_'], 'name'>\n\t\t\t\t& { name: TConfigMap[Key]['_']['name'] extends '' ? Assume<Key, string> : TConfigMap[Key]['_']['name'] };\n\t\t}, TDialect>;\n\t}\n\t& {};\n\nexport type BuildExtraConfigColumns<\n\t_TTableName extends string,\n\tTConfigMap extends Record<string, ColumnBuilderBase>,\n\tTDialect extends Dialect,\n> =\n\t& {\n\t\t[Key in keyof TConfigMap]: BuildIndexColumn<TDialect>;\n\t}\n\t& {};\n\nexport type ChangeColumnTableName<TColumn extends Column, TAlias extends string, TDialect extends Dialect> =\n\tTDialect extends 'pg' ? PgColumn<MakeColumnConfig<TColumn['_'], TAlias>>\n\t\t: TDialect extends 'mysql' ? MySqlColumn<MakeColumnConfig<TColumn['_'], TAlias>>\n\t\t: TDialect extends 'sqlite' ? SQLiteColumn<MakeColumnConfig<TColumn['_'], TAlias>>\n\t\t: never;\n","import { entityKind } from '~/entity.ts';\nimport { TableName } from '~/table.utils.ts';\nimport type { AnyPgColumn, PgColumn } from './columns/index.ts';\nimport type { PgTable } from './table.ts';\n\nexport type UpdateDeleteAction = 'cascade' | 'restrict' | 'no action' | 'set null' | 'set default';\n\nexport type Reference = () => {\n\treadonly name?: string;\n\treadonly columns: PgColumn[];\n\treadonly foreignTable: PgTable;\n\treadonly foreignColumns: PgColumn[];\n};\n\nexport class ForeignKeyBuilder {\n\tstatic readonly [entityKind]: string = 'PgForeignKeyBuilder';\n\n\t/** @internal */\n\treference: Reference;\n\n\t/** @internal */\n\t_onUpdate: UpdateDeleteAction | undefined = 'no action';\n\n\t/** @internal */\n\t_onDelete: UpdateDeleteAction | undefined = 'no action';\n\n\tconstructor(\n\t\tconfig: () => {\n\t\t\tname?: string;\n\t\t\tcolumns: PgColumn[];\n\t\t\tforeignColumns: PgColumn[];\n\t\t},\n\t\tactions?: {\n\t\t\tonUpdate?: UpdateDeleteAction;\n\t\t\tonDelete?: UpdateDeleteAction;\n\t\t} | undefined,\n\t) {\n\t\tthis.reference = () => {\n\t\t\tconst { name, columns, foreignColumns } = config();\n\t\t\treturn { name, columns, foreignTable: foreignColumns[0]!.table as PgTable, foreignColumns };\n\t\t};\n\t\tif (actions) {\n\t\t\tthis._onUpdate = actions.onUpdate;\n\t\t\tthis._onDelete = actions.onDelete;\n\t\t}\n\t}\n\n\tonUpdate(action: UpdateDeleteAction): this {\n\t\tthis._onUpdate = action === undefined ? 'no action' : action;\n\t\treturn this;\n\t}\n\n\tonDelete(action: UpdateDeleteAction): this {\n\t\tthis._onDelete = action === undefined ? 'no action' : action;\n\t\treturn this;\n\t}\n\n\t/** @internal */\n\tbuild(table: PgTable): ForeignKey {\n\t\treturn new ForeignKey(table, this);\n\t}\n}\n\nexport type AnyForeignKeyBuilder = ForeignKeyBuilder;\n\nexport class ForeignKey {\n\tstatic readonly [entityKind]: string = 'PgForeignKey';\n\n\treadonly reference: Reference;\n\treadonly onUpdate: UpdateDeleteAction | undefined;\n\treadonly onDelete: UpdateDeleteAction | undefined;\n\n\tconstructor(readonly table: PgTable, builder: ForeignKeyBuilder) {\n\t\tthis.reference = builder.reference;\n\t\tthis.onUpdate = builder._onUpdate;\n\t\tthis.onDelete = builder._onDelete;\n\t}\n\n\tgetName(): string {\n\t\tconst { name, columns, foreignColumns } = this.reference();\n\t\tconst columnNames = columns.map((column) => column.name);\n\t\tconst foreignColumnNames = foreignColumns.map((column) => column.name);\n\t\tconst chunks = [\n\t\t\tthis.table[TableName],\n\t\t\t...columnNames,\n\t\t\tforeignColumns[0]!.table[TableName],\n\t\t\t...foreignColumnNames,\n\t\t];\n\t\treturn name ?? `${chunks.join('_')}_fk`;\n\t}\n}\n\ntype ColumnsWithTable<\n\tTTableName extends string,\n\tTColumns extends PgColumn[],\n> = { [Key in keyof TColumns]: AnyPgColumn<{ tableName: TTableName }> };\n\nexport function foreignKey<\n\tTTableName extends string,\n\tTForeignTableName extends string,\n\tTColumns extends [AnyPgColumn<{ tableName: TTableName }>, ...AnyPgColumn<{ tableName: TTableName }>[]],\n>(\n\tconfig: {\n\t\tname?: string;\n\t\tcolumns: TColumns;\n\t\tforeignColumns: ColumnsWithTable<TForeignTableName, TColumns>;\n\t},\n): ForeignKeyBuilder {\n\tfunction mappedConfig() {\n\t\tconst { name, columns, foreignColumns } = config;\n\t\treturn {\n\t\t\tname,\n\t\t\tcolumns,\n\t\t\tforeignColumns,\n\t\t};\n\t}\n\n\treturn new ForeignKeyBuilder(mappedConfig);\n}\n","import { entityKind } from '~/entity.ts';\nimport { TableName } from '~/table.utils.ts';\nimport type { PgColumn } from './columns/index.ts';\nimport type { PgTable } from './table.ts';\n\nexport function unique(name?: string): UniqueOnConstraintBuilder {\n\treturn new UniqueOnConstraintBuilder(name);\n}\n\nexport function uniqueKeyName(table: PgTable, columns: string[]) {\n\treturn `${table[TableName]}_${columns.join('_')}_unique`;\n}\n\nexport class UniqueConstraintBuilder {\n\tstatic readonly [entityKind]: string = 'PgUniqueConstraintBuilder';\n\n\t/** @internal */\n\tcolumns: PgColumn[];\n\t/** @internal */\n\tnullsNotDistinctConfig = false;\n\n\tconstructor(\n\t\tcolumns: PgColumn[],\n\t\tprivate name?: string,\n\t) {\n\t\tthis.columns = columns;\n\t}\n\n\tnullsNotDistinct() {\n\t\tthis.nullsNotDistinctConfig = true;\n\t\treturn this;\n\t}\n\n\t/** @internal */\n\tbuild(table: PgTable): UniqueConstraint {\n\t\treturn new UniqueConstraint(table, this.columns, this.nullsNotDistinctConfig, this.name);\n\t}\n}\n\nexport class UniqueOnConstraintBuilder {\n\tstatic readonly [entityKind]: string = 'PgUniqueOnConstraintBuilder';\n\n\t/** @internal */\n\tname?: string;\n\n\tconstructor(\n\t\tname?: string,\n\t) {\n\t\tthis.name = name;\n\t}\n\n\ton(...columns: [PgColumn, ...PgColumn[]]) {\n\t\treturn new UniqueConstraintBuilder(columns, this.name);\n\t}\n}\n\nexport class UniqueConstraint {\n\tstatic readonly [entityKind]: string = 'PgUniqueConstraint';\n\n\treadonly columns: PgColumn[];\n\treadonly name?: string;\n\treadonly nullsNotDistinct: boolean = false;\n\n\tconstructor(readonly table: PgTable, columns: PgColumn[], nullsNotDistinct: boolean, name?: string) {\n\t\tthis.columns = columns;\n\t\tthis.name = name ?? uniqueKeyName(this.table, this.columns.map((column) => column.name));\n\t\tthis.nullsNotDistinct = nullsNotDistinct;\n\t}\n\n\tgetName() {\n\t\treturn this.name;\n\t}\n}\n","function parsePgArrayValue(arrayString: string, startFrom: number, inQuotes: boolean): [string, number] {\n\tfor (let i = startFrom; i < arrayString.length; i++) {\n\t\tconst char = arrayString[i];\n\n\t\tif (char === '\\\\') {\n\t\t\ti++;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (char === '\"') {\n\t\t\treturn [arrayString.slice(startFrom, i).replace(/\\\\/g, ''), i + 1];\n\t\t}\n\n\t\tif (inQuotes) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (char === ',' || char === '}') {\n\t\t\treturn [arrayString.slice(startFrom, i).replace(/\\\\/g, ''), i];\n\t\t}\n\t}\n\n\treturn [arrayString.slice(startFrom).replace(/\\\\/g, ''), arrayString.length];\n}\n\nexport function parsePgNestedArray(arrayString: string, startFrom = 0): [any[], number] {\n\tconst result: any[] = [];\n\tlet i = startFrom;\n\tlet lastCharIsComma = false;\n\n\twhile (i < arrayString.length) {\n\t\tconst char = arrayString[i];\n\n\t\tif (char === ',') {\n\t\t\tif (lastCharIsComma || i === startFrom) {\n\t\t\t\tresult.push('');\n\t\t\t}\n\t\t\tlastCharIsComma = true;\n\t\t\ti++;\n\t\t\tcontinue;\n\t\t}\n\n\t\tlastCharIsComma = false;\n\n\t\tif (char === '\\\\') {\n\t\t\ti += 2;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (char === '\"') {\n\t\t\tconst [value, startFrom] = parsePgArrayValue(arrayString, i + 1, true);\n\t\t\tresult.push(value);\n\t\t\ti = startFrom;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (char === '}') {\n\t\t\treturn [result, i + 1];\n\t\t}\n\n\t\tif (char === '{') {\n\t\t\tconst [value, startFrom] = parsePgNestedArray(arrayString, i + 1);\n\t\t\tresult.push(value);\n\t\t\ti = startFrom;\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst [value, newStartFrom] = parsePgArrayValue(arrayString, i, false);\n\t\tresult.push(value);\n\t\ti = newStartFrom;\n\t}\n\n\treturn [result, i];\n}\n\nexport function parsePgArray(arrayString: string): any[] {\n\tconst [result] = parsePgNestedArray(arrayString, 1);\n\treturn result;\n}\n\nexport function makePgArray(array: any[]): string {\n\treturn `{${\n\t\tarray.map((item) => {\n\t\t\tif (Array.isArray(item)) {\n\t\t\t\treturn makePgArray(item);\n\t\t\t}\n\n\t\t\tif (typeof item === 'string') {\n\t\t\t\treturn `\"${item.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"')}\"`;\n\t\t\t}\n\n\t\t\treturn `${item}`;\n\t\t}).join(',')\n\t}}`;\n}\n","import type {\n\tColumnBuilderBase,\n\tColumnBuilderBaseConfig,\n\tColumnBuilderExtraConfig,\n\tColumnBuilderRuntimeConfig,\n\tColumnDataType,\n\tHasGenerated,\n\tMakeColumnConfig,\n} from '~/column-builder.ts';\nimport { ColumnBuilder } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { Column } from '~/column.ts';\nimport { entityKind, is } from '~/entity.ts';\nimport type { Update } from '~/utils.ts';\n\nimport type { ForeignKey, UpdateDeleteAction } from '~/pg-core/foreign-keys.ts';\nimport { ForeignKeyBuilder } from '~/pg-core/foreign-keys.ts';\nimport type { AnyPgTable, PgTable } from '~/pg-core/table.ts';\nimport type { SQL } from '~/sql/sql.ts';\nimport { iife } from '~/tracing-utils.ts';\nimport type { PgIndexOpClass } from '../indexes.ts';\nimport { uniqueKeyName } from '../unique-constraint.ts';\nimport { makePgArray, parsePgArray } from '../utils/array.ts';\n\nexport interface ReferenceConfig {\n\tref: () => PgColumn;\n\tactions: {\n\t\tonUpdate?: UpdateDeleteAction;\n\t\tonDelete?: UpdateDeleteAction;\n\t};\n}\n\nexport interface PgColumnBuilderBase<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string> = ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTTypeConfig extends object = object,\n> extends ColumnBuilderBase<T, TTypeConfig & { dialect: 'pg' }> {}\n\nexport abstract class PgColumnBuilder<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string> = ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTRuntimeConfig extends object = object,\n\tTTypeConfig extends object = object,\n\tTExtraConfig extends ColumnBuilderExtraConfig = ColumnBuilderExtraConfig,\n> extends ColumnBuilder<T, TRuntimeConfig, TTypeConfig & { dialect: 'pg' }, TExtraConfig>\n\timplements PgColumnBuilderBase<T, TTypeConfig>\n{\n\tprivate foreignKeyConfigs: ReferenceConfig[] = [];\n\n\tstatic override readonly [entityKind]: string = 'PgColumnBuilder';\n\n\tarray(size?: number): PgArrayBuilder<\n\t\t& {\n\t\t\tname: T['name'];\n\t\t\tdataType: 'array';\n\t\t\tcolumnType: 'PgArray';\n\t\t\tdata: T['data'][];\n\t\t\tdriverParam: T['driverParam'][] | string;\n\t\t\tenumValues: T['enumValues'];\n\t\t}\n\t\t& (T extends { notNull: true } ? { notNull: true } : {})\n\t\t& (T extends { hasDefault: true } ? { hasDefault: true } : {}),\n\t\tT\n\t> {\n\t\treturn new PgArrayBuilder(this.config.name, this as PgColumnBuilder<any, any>, size);\n\t}\n\n\treferences(\n\t\tref: ReferenceConfig['ref'],\n\t\tactions: ReferenceConfig['actions'] = {},\n\t): this {\n\t\tthis.foreignKeyConfigs.push({ ref, actions });\n\t\treturn this;\n\t}\n\n\tunique(\n\t\tname?: string,\n\t\tconfig?: { nulls: 'distinct' | 'not distinct' },\n\t): this {\n\t\tthis.config.isUnique = true;\n\t\tthis.config.uniqueName = name;\n\t\tthis.config.uniqueType = config?.nulls;\n\t\treturn this;\n\t}\n\n\tgeneratedAlwaysAs(as: SQL | T['data'] | (() => SQL)): HasGenerated<this, {\n\t\ttype: 'always';\n\t}> {\n\t\tthis.config.generated = {\n\t\t\tas,\n\t\t\ttype: 'always',\n\t\t\tmode: 'stored',\n\t\t};\n\t\treturn this as HasGenerated<this, {\n\t\t\ttype: 'always';\n\t\t}>;\n\t}\n\n\t/** @internal */\n\tbuildForeignKeys(column: PgColumn, table: PgTable): ForeignKey[] {\n\t\treturn this.foreignKeyConfigs.map(({ ref, actions }) => {\n\t\t\treturn iife(\n\t\t\t\t(ref, actions) => {\n\t\t\t\t\tconst builder = new ForeignKeyBuilder(() => {\n\t\t\t\t\t\tconst foreignColumn = ref();\n\t\t\t\t\t\treturn { columns: [column], foreignColumns: [foreignColumn] };\n\t\t\t\t\t});\n\t\t\t\t\tif (actions.onUpdate) {\n\t\t\t\t\t\tbuilder.onUpdate(actions.onUpdate);\n\t\t\t\t\t}\n\t\t\t\t\tif (actions.onDelete) {\n\t\t\t\t\t\tbuilder.onDelete(actions.onDelete);\n\t\t\t\t\t}\n\t\t\t\t\treturn builder.build(table);\n\t\t\t\t},\n\t\t\t\tref,\n\t\t\t\tactions,\n\t\t\t);\n\t\t});\n\t}\n\n\t/** @internal */\n\tabstract build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgColumn<MakeColumnConfig<T, TTableName>>;\n\n\t/** @internal */\n\tbuildExtraConfigColumn<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): ExtraConfigColumn {\n\t\treturn new ExtraConfigColumn(table, this.config);\n\t}\n}\n\n// To understand how to use `PgColumn` and `PgColumn`, see `Column` and `AnyColumn` documentation.\nexport abstract class PgColumn<\n\tT extends ColumnBaseConfig<ColumnDataType, string> = ColumnBaseConfig<ColumnDataType, string>,\n\tTRuntimeConfig extends object = {},\n\tTTypeConfig extends object = {},\n> extends Column<T, TRuntimeConfig, TTypeConfig & { dialect: 'pg' }> {\n\tstatic override readonly [entityKind]: string = 'PgColumn';\n\n\tconstructor(\n\t\toverride readonly table: PgTable,\n\t\tconfig: ColumnBuilderRuntimeConfig<T['data'], TRuntimeConfig>,\n\t) {\n\t\tif (!config.uniqueName) {\n\t\t\tconfig.uniqueName = uniqueKeyName(table, [config.name]);\n\t\t}\n\t\tsuper(table, config);\n\t}\n}\n\nexport type IndexedExtraConfigType = { order?: 'asc' | 'desc'; nulls?: 'first' | 'last'; opClass?: string };\n\nexport class ExtraConfigColumn<\n\tT extends ColumnBaseConfig<ColumnDataType, string> = ColumnBaseConfig<ColumnDataType, string>,\n> extends PgColumn<T, IndexedExtraConfigType> {\n\tstatic override readonly [entityKind]: string = 'ExtraConfigColumn';\n\n\toverride getSQLType(): string {\n\t\treturn this.getSQLType();\n\t}\n\n\tindexConfig: IndexedExtraConfigType = {\n\t\torder: this.config.order ?? 'asc',\n\t\tnulls: this.config.nulls ?? 'last',\n\t\topClass: this.config.opClass,\n\t};\n\tdefaultConfig: IndexedExtraConfigType = {\n\t\torder: 'asc',\n\t\tnulls: 'last',\n\t\topClass: undefined,\n\t};\n\n\tasc(): Omit<this, 'asc' | 'desc'> {\n\t\tthis.indexConfig.order = 'asc';\n\t\treturn this;\n\t}\n\n\tdesc(): Omit<this, 'asc' | 'desc'> {\n\t\tthis.indexConfig.order = 'desc';\n\t\treturn this;\n\t}\n\n\tnullsFirst(): Omit<this, 'nullsFirst' | 'nullsLast'> {\n\t\tthis.indexConfig.nulls = 'first';\n\t\treturn this;\n\t}\n\n\tnullsLast(): Omit<this, 'nullsFirst' | 'nullsLast'> {\n\t\tthis.indexConfig.nulls = 'last';\n\t\treturn this;\n\t}\n\n\t/**\n\t * ### PostgreSQL documentation quote\n\t *\n\t * > An operator class with optional parameters can be specified for each column of an index.\n\t * The operator class identifies the operators to be used by the index for that column.\n\t * For example, a B-tree index on four-byte integers would use the int4_ops class;\n\t * this operator class includes comparison functions for four-byte integers.\n\t * In practice the default operator class for the column's data type is usually sufficient.\n\t * The main point of having operator classes is that for some data types, there could be more than one meaningful ordering.\n\t * For example, we might want to sort a complex-number data type either by absolute value or by real part.\n\t * We could do this by defining two operator classes for the data type and then selecting the proper class when creating an index.\n\t * More information about operator classes check:\n\t *\n\t * ### Useful links\n\t * https://www.postgresql.org/docs/current/sql-createindex.html\n\t *\n\t * https://www.postgresql.org/docs/current/indexes-opclass.html\n\t *\n\t * https://www.postgresql.org/docs/current/xindex.html\n\t *\n\t * ### Additional types\n\t * If you have the `pg_vector` extension installed in your database, you can use the\n\t * `vector_l2_ops`, `vector_ip_ops`, `vector_cosine_ops`, `vector_l1_ops`, `bit_hamming_ops`, `bit_jaccard_ops`, `halfvec_l2_ops`, `sparsevec_l2_ops` options, which are predefined types.\n\t *\n\t * **You can always specify any string you want in the operator class, in case Drizzle doesn't have it natively in its types**\n\t *\n\t * @param opClass\n\t * @returns\n\t */\n\top(opClass: PgIndexOpClass): Omit<this, 'op'> {\n\t\tthis.indexConfig.opClass = opClass;\n\t\treturn this;\n\t}\n}\n\nexport class IndexedColumn {\n\tstatic readonly [entityKind]: string = 'IndexedColumn';\n\tconstructor(\n\t\tname: string | undefined,\n\t\tkeyAsName: boolean,\n\t\ttype: string,\n\t\tindexConfig: IndexedExtraConfigType,\n\t) {\n\t\tthis.name = name;\n\t\tthis.keyAsName = keyAsName;\n\t\tthis.type = type;\n\t\tthis.indexConfig = indexConfig;\n\t}\n\n\tname: string | undefined;\n\tkeyAsName: boolean;\n\ttype: string;\n\tindexConfig: IndexedExtraConfigType;\n}\n\nexport type AnyPgColumn<TPartial extends Partial<ColumnBaseConfig<ColumnDataType, string>> = {}> = PgColumn<\n\tRequired<Update<ColumnBaseConfig<ColumnDataType, string>, TPartial>>\n>;\n\nexport class PgArrayBuilder<\n\tT extends ColumnBuilderBaseConfig<'array', 'PgArray'>,\n\tTBase extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n> extends PgColumnBuilder<\n\tT,\n\t{\n\t\tbaseBuilder: PgColumnBuilder<TBase>;\n\t\tsize: number | undefined;\n\t},\n\t{\n\t\tbaseBuilder: PgColumnBuilder<TBase>;\n\t}\n> {\n\tstatic override readonly [entityKind] = 'PgArrayBuilder';\n\n\tconstructor(\n\t\tname: string,\n\t\tbaseBuilder: PgArrayBuilder<T, TBase>['config']['baseBuilder'],\n\t\tsize: number | undefined,\n\t) {\n\t\tsuper(name, 'array', 'PgArray');\n\t\tthis.config.baseBuilder = baseBuilder;\n\t\tthis.config.size = size;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgArray<MakeColumnConfig<T, TTableName>, TBase> {\n\t\tconst baseColumn = this.config.baseBuilder.build(table);\n\t\treturn new PgArray<MakeColumnConfig<T, TTableName>, TBase>(\n\t\t\ttable as AnyPgTable<{ name: MakeColumnConfig<T, TTableName>['tableName'] }>,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t\tbaseColumn,\n\t\t);\n\t}\n}\n\nexport class PgArray<\n\tT extends ColumnBaseConfig<'array', 'PgArray'>,\n\tTBase extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n> extends PgColumn<T> {\n\treadonly size: number | undefined;\n\n\tstatic override readonly [entityKind]: string = 'PgArray';\n\n\tconstructor(\n\t\ttable: AnyPgTable<{ name: T['tableName'] }>,\n\t\tconfig: PgArrayBuilder<T, TBase>['config'],\n\t\treadonly baseColumn: PgColumn,\n\t\treadonly range?: [number | undefined, number | undefined],\n\t) {\n\t\tsuper(table, config);\n\t\tthis.size = config.size;\n\t}\n\n\tgetSQLType(): string {\n\t\treturn `${this.baseColumn.getSQLType()}[${typeof this.size === 'number' ? this.size : ''}]`;\n\t}\n\n\toverride mapFromDriverValue(value: unknown[] | string): T['data'] {\n\t\tif (typeof value === 'string') {\n\t\t\t// Thank you node-postgres for not parsing enum arrays\n\t\t\tvalue = parsePgArray(value);\n\t\t}\n\t\treturn value.map((v) => this.baseColumn.mapFromDriverValue(v));\n\t}\n\n\toverride mapToDriverValue(value: unknown[], isNestedArray = false): unknown[] | string {\n\t\tconst a = value.map((v) =>\n\t\t\tv === null\n\t\t\t\t? null\n\t\t\t\t: is(this.baseColumn, PgArray)\n\t\t\t\t? this.baseColumn.mapToDriverValue(v as unknown[], true)\n\t\t\t\t: this.baseColumn.mapToDriverValue(v)\n\t\t);\n\t\tif (isNestedArray) return a;\n\t\treturn makePgArray(a);\n\t}\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport type { Writable } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgEnumColumnBuilderInitial<TName extends string, TValues extends [string, ...string[]]> =\n\tPgEnumColumnBuilder<{\n\t\tname: TName;\n\t\tdataType: 'string';\n\t\tcolumnType: 'PgEnumColumn';\n\t\tdata: TValues[number];\n\t\tenumValues: TValues;\n\t\tdriverParam: string;\n\t}>;\n\nconst isPgEnumSym = Symbol.for('drizzle:isPgEnum');\nexport interface PgEnum<TValues extends [string, ...string[]]> {\n\t(): PgEnumColumnBuilderInitial<'', TValues>;\n\t<TName extends string>(name: TName): PgEnumColumnBuilderInitial<TName, TValues>;\n\t<TName extends string>(name?: TName): PgEnumColumnBuilderInitial<TName, TValues>;\n\n\treadonly enumName: string;\n\treadonly enumValues: TValues;\n\treadonly schema: string | undefined;\n\t/** @internal */\n\t[isPgEnumSym]: true;\n}\n\nexport function isPgEnum(obj: unknown): obj is PgEnum<[string, ...string[]]> {\n\treturn !!obj && typeof obj === 'function' && isPgEnumSym in obj && obj[isPgEnumSym] === true;\n}\n\nexport class PgEnumColumnBuilder<\n\tT extends ColumnBuilderBaseConfig<'string', 'PgEnumColumn'> & { enumValues: [string, ...string[]] },\n> extends PgColumnBuilder<T, { enum: PgEnum<T['enumValues']> }> {\n\tstatic override readonly [entityKind]: string = 'PgEnumColumnBuilder';\n\n\tconstructor(name: T['name'], enumInstance: PgEnum<T['enumValues']>) {\n\t\tsuper(name, 'string', 'PgEnumColumn');\n\t\tthis.config.enum = enumInstance;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgEnumColumn<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgEnumColumn<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgEnumColumn<T extends ColumnBaseConfig<'string', 'PgEnumColumn'> & { enumValues: [string, ...string[]] }>\n\textends PgColumn<T, { enum: PgEnum<T['enumValues']> }>\n{\n\tstatic override readonly [entityKind]: string = 'PgEnumColumn';\n\n\treadonly enum = this.config.enum;\n\toverride readonly enumValues = this.config.enum.enumValues;\n\n\tconstructor(\n\t\ttable: AnyPgTable<{ name: T['tableName'] }>,\n\t\tconfig: PgEnumColumnBuilder<T>['config'],\n\t) {\n\t\tsuper(table, config);\n\t\tthis.enum = config.enum;\n\t}\n\n\tgetSQLType(): string {\n\t\treturn this.enum.enumName;\n\t}\n}\n\n// Gratitude to zod for the enum function types\nexport function pgEnum<U extends string, T extends Readonly<[U, ...U[]]>>(\n\tenumName: string,\n\tvalues: T | Writable<T>,\n): PgEnum<Writable<T>> {\n\treturn pgEnumWithSchema(enumName, values, undefined);\n}\n\n/** @internal */\nexport function pgEnumWithSchema<U extends string, T extends Readonly<[U, ...U[]]>>(\n\tenumName: string,\n\tvalues: T | Writable<T>,\n\tschema?: string,\n): PgEnum<Writable<T>> {\n\tconst enumInstance: PgEnum<Writable<T>> = Object.assign(\n\t\t<TName extends string>(name?: TName): PgEnumColumnBuilderInitial<TName, Writable<T>> =>\n\t\t\tnew PgEnumColumnBuilder(name ?? '' as TName, enumInstance),\n\t\t{\n\t\t\tenumName,\n\t\t\tenumValues: values,\n\t\t\tschema,\n\t\t\t[isPgEnumSym]: true,\n\t\t} as const,\n\t);\n\n\treturn enumInstance;\n}\n","import { entityKind } from './entity.ts';\nimport type { SQL, SQLWrapper } from './sql/sql.ts';\n\nexport interface Subquery<\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTAlias extends string = string,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTSelectedFields extends Record<string, unknown> = Record<string, unknown>,\n> extends SQLWrapper {\n\t// SQLWrapper runtime implementation is defined in 'sql/sql.ts'\n}\nexport class Subquery<\n\tTAlias extends string = string,\n\tTSelectedFields extends Record<string, unknown> = Record<string, unknown>,\n> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Subquery';\n\n\tdeclare _: {\n\t\tbrand: 'Subquery';\n\t\tsql: SQL;\n\t\tselectedFields: TSelectedFields;\n\t\talias: TAlias;\n\t\tisWith: boolean;\n\t};\n\n\tconstructor(sql: SQL, selection: Record<string, unknown>, alias: string, isWith = false) {\n\t\tthis._ = {\n\t\t\tbrand: 'Subquery',\n\t\t\tsql,\n\t\t\tselectedFields: selection as TSelectedFields,\n\t\t\talias: alias as TAlias,\n\t\t\tisWith,\n\t\t};\n\t}\n\n\t// getSQL(): SQL<unknown> {\n\t// \treturn new SQL([this]);\n\t// }\n}\n\nexport class WithSubquery<\n\tTAlias extends string = string,\n\tTSelection extends Record<string, unknown> = Record<string, unknown>,\n> extends Subquery<TAlias, TSelection> {\n\tstatic override readonly [entityKind]: string = 'WithSubquery';\n}\n","export const ViewBaseConfig = Symbol.for('drizzle:ViewBaseConfig');\n","import type { CasingCache } from '~/casing.ts';\nimport { entityKind, is } from '~/entity.ts';\nimport type { SelectedFields } from '~/operations.ts';\nimport { isPgEnum } from '~/pg-core/columns/enum.ts';\nimport { Subquery } from '~/subquery.ts';\nimport { tracer } from '~/tracing.ts';\nimport { ViewBaseConfig } from '~/view-common.ts';\nimport type { AnyColumn } from '../column.ts';\nimport { Column } from '../column.ts';\nimport { IsAlias, Table } from '../table.ts';\n\n/**\n * This class is used to indicate a primitive param value that is used in `sql` tag.\n * It is only used on type level and is never instantiated at runtime.\n * If you see a value of this type in the code, its runtime value is actually the primitive param value.\n */\nexport class FakePrimitiveParam {\n\tstatic readonly [entityKind]: string = 'FakePrimitiveParam';\n}\n\nexport type Chunk =\n\t| string\n\t| Table\n\t| View\n\t| AnyColumn\n\t| Name\n\t| Param\n\t| Placeholder\n\t| SQL;\n\nexport interface BuildQueryConfig {\n\tcasing: CasingCache;\n\tescapeName(name: string): string;\n\tescapeParam(num: number, value: unknown): string;\n\tescapeString(str: string): string;\n\tprepareTyping?: (encoder: DriverValueEncoder<unknown, unknown>) => QueryTypingsValue;\n\tparamStartIndex?: { value: number };\n\tinlineParams?: boolean;\n\tinvokeSource?: 'indexes' | undefined;\n}\n\nexport type QueryTypingsValue = 'json' | 'decimal' | 'time' | 'timestamp' | 'uuid' | 'date' | 'none';\n\nexport interface Query {\n\tsql: string;\n\tparams: unknown[];\n}\n\nexport interface QueryWithTypings extends Query {\n\ttypings?: QueryTypingsValue[];\n}\n\n/**\n * Any value that implements the `getSQL` method. The implementations include:\n * - `Table`\n * - `Column`\n * - `View`\n * - `Subquery`\n * - `SQL`\n * - `SQL.Aliased`\n * - `Placeholder`\n * - `Param`\n */\nexport interface SQLWrapper {\n\tgetSQL(): SQL;\n\tshouldOmitSQLParens?(): boolean;\n}\n\nexport function isSQLWrapper(value: unknown): value is SQLWrapper {\n\treturn value !== null && value !== undefined && typeof (value as any).getSQL === 'function';\n}\n\nfunction mergeQueries(queries: QueryWithTypings[]): QueryWithTypings {\n\tconst result: QueryWithTypings = { sql: '', params: [] };\n\tfor (const query of queries) {\n\t\tresult.sql += query.sql;\n\t\tresult.params.push(...query.params);\n\t\tif (query.typings?.length) {\n\t\t\tif (!result.typings) {\n\t\t\t\tresult.typings = [];\n\t\t\t}\n\t\t\tresult.typings.push(...query.typings);\n\t\t}\n\t}\n\treturn result;\n}\n\nexport class StringChunk implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'StringChunk';\n\n\treadonly value: string[];\n\n\tconstructor(value: string | string[]) {\n\t\tthis.value = Array.isArray(value) ? value : [value];\n\t}\n\n\tgetSQL(): SQL<unknown> {\n\t\treturn new SQL([this]);\n\t}\n}\n\nexport class SQL<T = unknown> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'SQL';\n\n\tdeclare _: {\n\t\tbrand: 'SQL';\n\t\ttype: T;\n\t};\n\n\t/** @internal */\n\tdecoder: DriverValueDecoder<T, any> = noopDecoder;\n\tprivate shouldInlineParams = false;\n\n\tconstructor(readonly queryChunks: SQLChunk[]) {}\n\n\tappend(query: SQL): this {\n\t\tthis.queryChunks.push(...query.queryChunks);\n\t\treturn this;\n\t}\n\n\ttoQuery(config: BuildQueryConfig): QueryWithTypings {\n\t\treturn tracer.startActiveSpan('drizzle.buildSQL', (span) => {\n\t\t\tconst query = this.buildQueryFromSourceParams(this.queryChunks, config);\n\t\t\tspan?.setAttributes({\n\t\t\t\t'drizzle.query.text': query.sql,\n\t\t\t\t'drizzle.query.params': JSON.stringify(query.params),\n\t\t\t});\n\t\t\treturn query;\n\t\t});\n\t}\n\n\tbuildQueryFromSourceParams(chunks: SQLChunk[], _config: BuildQueryConfig): Query {\n\t\tconst config = Object.assign({}, _config, {\n\t\t\tinlineParams: _config.inlineParams || this.shouldInlineParams,\n\t\t\tparamStartIndex: _config.paramStartIndex || { value: 0 },\n\t\t});\n\n\t\tconst {\n\t\t\tcasing,\n\t\t\tescapeName,\n\t\t\tescapeParam,\n\t\t\tprepareTyping,\n\t\t\tinlineParams,\n\t\t\tparamStartIndex,\n\t\t} = config;\n\n\t\treturn mergeQueries(chunks.map((chunk): QueryWithTypings => {\n\t\t\tif (is(chunk, StringChunk)) {\n\t\t\t\treturn { sql: chunk.value.join(''), params: [] };\n\t\t\t}\n\n\t\t\tif (is(chunk, Name)) {\n\t\t\t\treturn { sql: escapeName(chunk.value), params: [] };\n\t\t\t}\n\n\t\t\tif (chunk === undefined) {\n\t\t\t\treturn { sql: '', params: [] };\n\t\t\t}\n\n\t\t\tif (Array.isArray(chunk)) {\n\t\t\t\tconst result: SQLChunk[] = [new StringChunk('(')];\n\t\t\t\tfor (const [i, p] of chunk.entries()) {\n\t\t\t\t\tresult.push(p);\n\t\t\t\t\tif (i < chunk.length - 1) {\n\t\t\t\t\t\tresult.push(new StringChunk(', '));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresult.push(new StringChunk(')'));\n\t\t\t\treturn this.buildQueryFromSourceParams(result, config);\n\t\t\t}\n\n\t\t\tif (is(chunk, SQL)) {\n\t\t\t\treturn this.buildQueryFromSourceParams(chunk.queryChunks, {\n\t\t\t\t\t...config,\n\t\t\t\t\tinlineParams: inlineParams || chunk.shouldInlineParams,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (is(chunk, Table)) {\n\t\t\t\tconst schemaName = chunk[Table.Symbol.Schema];\n\t\t\t\tconst tableName = chunk[Table.Symbol.Name];\n\t\t\t\treturn {\n\t\t\t\t\tsql: schemaName === undefined\n\t\t\t\t\t\t? escapeName(tableName)\n\t\t\t\t\t\t: escapeName(schemaName) + '.' + escapeName(tableName),\n\t\t\t\t\tparams: [],\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (is(chunk, Column)) {\n\t\t\t\tconst columnName = casing.getColumnCasing(chunk);\n\t\t\t\tif (_config.invokeSource === 'indexes') {\n\t\t\t\t\treturn { sql: escapeName(columnName), params: [] };\n\t\t\t\t}\n\n\t\t\t\tconst schemaName = chunk.table[Table.Symbol.Schema];\n\t\t\t\treturn {\n\t\t\t\t\tsql: chunk.table[IsAlias] || schemaName === undefined\n\t\t\t\t\t\t? escapeName(chunk.table[Table.Symbol.Name]) + '.' + escapeName(columnName)\n\t\t\t\t\t\t: escapeName(schemaName) + '.' + escapeName(chunk.table[Table.Symbol.Name]) + '.'\n\t\t\t\t\t\t\t+ escapeName(columnName),\n\t\t\t\t\tparams: [],\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (is(chunk, View)) {\n\t\t\t\tconst schemaName = chunk[ViewBaseConfig].schema;\n\t\t\t\tconst viewName = chunk[ViewBaseConfig].name;\n\t\t\t\treturn {\n\t\t\t\t\tsql: schemaName === undefined\n\t\t\t\t\t\t? escapeName(viewName)\n\t\t\t\t\t\t: escapeName(schemaName) + '.' + escapeName(viewName),\n\t\t\t\t\tparams: [],\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (is(chunk, Param)) {\n\t\t\t\tif (is(chunk.value, Placeholder)) {\n\t\t\t\t\treturn { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: ['none'] };\n\t\t\t\t}\n\n\t\t\t\tconst mappedValue = chunk.value === null ? null : chunk.encoder.mapToDriverValue(chunk.value);\n\n\t\t\t\tif (is(mappedValue, SQL)) {\n\t\t\t\t\treturn this.buildQueryFromSourceParams([mappedValue], config);\n\t\t\t\t}\n\n\t\t\t\tif (inlineParams) {\n\t\t\t\t\treturn { sql: this.mapInlineParam(mappedValue, config), params: [] };\n\t\t\t\t}\n\n\t\t\t\tlet typings: QueryTypingsValue[] = ['none'];\n\t\t\t\tif (prepareTyping) {\n\t\t\t\t\ttypings = [prepareTyping(chunk.encoder)];\n\t\t\t\t}\n\n\t\t\t\treturn { sql: escapeParam(paramStartIndex.value++, mappedValue), params: [mappedValue], typings };\n\t\t\t}\n\n\t\t\tif (is(chunk, Placeholder)) {\n\t\t\t\treturn { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: ['none'] };\n\t\t\t}\n\n\t\t\tif (is(chunk, SQL.Aliased) && chunk.fieldAlias !== undefined) {\n\t\t\t\treturn { sql: escapeName(chunk.fieldAlias), params: [] };\n\t\t\t}\n\n\t\t\tif (is(chunk, Subquery)) {\n\t\t\t\tif (chunk._.isWith) {\n\t\t\t\t\treturn { sql: escapeName(chunk._.alias), params: [] };\n\t\t\t\t}\n\t\t\t\treturn this.buildQueryFromSourceParams([\n\t\t\t\t\tnew StringChunk('('),\n\t\t\t\t\tchunk._.sql,\n\t\t\t\t\tnew StringChunk(') '),\n\t\t\t\t\tnew Name(chunk._.alias),\n\t\t\t\t], config);\n\t\t\t}\n\n\t\t\tif (isPgEnum(chunk)) {\n\t\t\t\tif (chunk.schema) {\n\t\t\t\t\treturn { sql: escapeName(chunk.schema) + '.' + escapeName(chunk.enumName), params: [] };\n\t\t\t\t}\n\t\t\t\treturn { sql: escapeName(chunk.enumName), params: [] };\n\t\t\t}\n\n\t\t\tif (isSQLWrapper(chunk)) {\n\t\t\t\tif (chunk.shouldOmitSQLParens?.()) {\n\t\t\t\t\treturn this.buildQueryFromSourceParams([chunk.getSQL()], config);\n\t\t\t\t}\n\t\t\t\treturn this.buildQueryFromSourceParams([\n\t\t\t\t\tnew StringChunk('('),\n\t\t\t\t\tchunk.getSQL(),\n\t\t\t\t\tnew StringChunk(')'),\n\t\t\t\t], config);\n\t\t\t}\n\n\t\t\tif (inlineParams) {\n\t\t\t\treturn { sql: this.mapInlineParam(chunk, config), params: [] };\n\t\t\t}\n\n\t\t\treturn { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: ['none'] };\n\t\t}));\n\t}\n\n\tprivate mapInlineParam(\n\t\tchunk: unknown,\n\t\t{ escapeString }: BuildQueryConfig,\n\t): string {\n\t\tif (chunk === null) {\n\t\t\treturn 'null';\n\t\t}\n\t\tif (typeof chunk === 'number' || typeof chunk === 'boolean') {\n\t\t\treturn chunk.toString();\n\t\t}\n\t\tif (typeof chunk === 'string') {\n\t\t\treturn escapeString(chunk);\n\t\t}\n\t\tif (typeof chunk === 'object') {\n\t\t\tconst mappedValueAsString = chunk.toString();\n\t\t\tif (mappedValueAsString === '[object Object]') {\n\t\t\t\treturn escapeString(JSON.stringify(chunk));\n\t\t\t}\n\t\t\treturn escapeString(mappedValueAsString);\n\t\t}\n\t\tthrow new Error('Unexpected param value: ' + chunk);\n\t}\n\n\tgetSQL(): SQL {\n\t\treturn this;\n\t}\n\n\tas(alias: string): SQL.Aliased<T>;\n\t/**\n\t * @deprecated\n\t * Use ``sql<DataType>`query`.as(alias)`` instead.\n\t */\n\tas<TData>(): SQL<TData>;\n\t/**\n\t * @deprecated\n\t * Use ``sql<DataType>`query`.as(alias)`` instead.\n\t */\n\tas<TData>(alias: string): SQL.Aliased<TData>;\n\tas(alias?: string): SQL<T> | SQL.Aliased<T> {\n\t\t// TODO: remove with deprecated overloads\n\t\tif (alias === undefined) {\n\t\t\treturn this;\n\t\t}\n\n\t\treturn new SQL.Aliased(this, alias);\n\t}\n\n\tmapWith<\n\t\tTDecoder extends\n\t\t\t| DriverValueDecoder<any, any>\n\t\t\t| DriverValueDecoder<any, any>['mapFromDriverValue'],\n\t>(decoder: TDecoder): SQL<GetDecoderResult<TDecoder>> {\n\t\tthis.decoder = typeof decoder === 'function' ? { mapFromDriverValue: decoder } : decoder;\n\t\treturn this as SQL<GetDecoderResult<TDecoder>>;\n\t}\n\n\tinlineParams(): this {\n\t\tthis.shouldInlineParams = true;\n\t\treturn this;\n\t}\n\n\t/**\n\t * This method is used to conditionally include a part of the query.\n\t *\n\t * @param condition - Condition to check\n\t * @returns itself if the condition is `true`, otherwise `undefined`\n\t */\n\tif(condition: any | undefined): this | undefined {\n\t\treturn condition ? this : undefined;\n\t}\n}\n\nexport type GetDecoderResult<T> = T extends Column ? T['_']['data'] : T extends\n\t| DriverValueDecoder<infer TData, any>\n\t| DriverValueDecoder<infer TData, any>['mapFromDriverValue'] ? TData\n: never;\n\n/**\n * Any DB name (table, column, index etc.)\n */\nexport class Name implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Name';\n\n\tprotected brand!: 'Name';\n\n\tconstructor(readonly value: string) {}\n\n\tgetSQL(): SQL<unknown> {\n\t\treturn new SQL([this]);\n\t}\n}\n\n/**\n * Any DB name (table, column, index etc.)\n * @deprecated Use `sql.identifier` instead.\n */\nexport function name(value: string): Name {\n\treturn new Name(value);\n}\n\nexport interface DriverValueDecoder<TData, TDriverParam> {\n\tmapFromDriverValue(value: TDriverParam): TData;\n}\n\nexport interface DriverValueEncoder<TData, TDriverParam> {\n\tmapToDriverValue(value: TData): TDriverParam | SQL;\n}\n\nexport function isDriverValueEncoder(value: unknown): value is DriverValueEncoder<any, any> {\n\treturn typeof value === 'object' && value !== null && 'mapToDriverValue' in value\n\t\t&& typeof (value as any).mapToDriverValue === 'function';\n}\n\nexport const noopDecoder: DriverValueDecoder<any, any> = {\n\tmapFromDriverValue: (value) => value,\n};\n\nexport const noopEncoder: DriverValueEncoder<any, any> = {\n\tmapToDriverValue: (value) => value,\n};\n\nexport interface DriverValueMapper<TData, TDriverParam>\n\textends DriverValueDecoder<TData, TDriverParam>, DriverValueEncoder<TData, TDriverParam>\n{}\n\nexport const noopMapper: DriverValueMapper<any, any> = {\n\t...noopDecoder,\n\t...noopEncoder,\n};\n\n/** Parameter value that is optionally bound to an encoder (for example, a column). */\nexport class Param<TDataType = unknown, TDriverParamType = TDataType> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Param';\n\n\tprotected brand!: 'BoundParamValue';\n\n\t/**\n\t * @param value - Parameter value\n\t * @param encoder - Encoder to convert the value to a driver parameter\n\t */\n\tconstructor(\n\t\treadonly value: TDataType,\n\t\treadonly encoder: DriverValueEncoder<TDataType, TDriverParamType> = noopEncoder,\n\t) {}\n\n\tgetSQL(): SQL<unknown> {\n\t\treturn new SQL([this]);\n\t}\n}\n\n/** @deprecated Use `sql.param` instead. */\nexport function param<TData, TDriver>(\n\tvalue: TData,\n\tencoder?: DriverValueEncoder<TData, TDriver>,\n): Param<TData, TDriver> {\n\treturn new Param(value, encoder);\n}\n\n/**\n * Anything that can be passed to the `` sql`...` `` tagged function.\n */\nexport type SQLChunk =\n\t| StringChunk\n\t| SQLChunk[]\n\t| SQLWrapper\n\t| SQL\n\t| Table\n\t| View\n\t| Subquery\n\t| AnyColumn\n\t| Param\n\t| Name\n\t| undefined\n\t| FakePrimitiveParam\n\t| Placeholder;\n\nexport function sql<T>(strings: TemplateStringsArray, ...params: any[]): SQL<T>;\n/*\n\tThe type of `params` is specified as `SQLChunk[]`, but that's slightly incorrect -\n\tin runtime, users won't pass `FakePrimitiveParam` instances as `params` - they will pass primitive values\n\twhich will be wrapped in `Param`. That's why the overload specifies `params` as `any[]` and not as `SQLSourceParam[]`.\n\tThis type is used to make our lives easier and the type checker happy.\n*/\nexport function sql(strings: TemplateStringsArray, ...params: SQLChunk[]): SQL {\n\tconst queryChunks: SQLChunk[] = [];\n\tif (params.length > 0 || (strings.length > 0 && strings[0] !== '')) {\n\t\tqueryChunks.push(new StringChunk(strings[0]!));\n\t}\n\tfor (const [paramIndex, param] of params.entries()) {\n\t\tqueryChunks.push(param, new StringChunk(strings[paramIndex + 1]!));\n\t}\n\n\treturn new SQL(queryChunks);\n}\n\nexport namespace sql {\n\texport function empty(): SQL {\n\t\treturn new SQL([]);\n\t}\n\n\t/** @deprecated - use `sql.join()` */\n\texport function fromList(list: SQLChunk[]): SQL {\n\t\treturn new SQL(list);\n\t}\n\n\t/**\n\t * Convenience function to create an SQL query from a raw string.\n\t * @param str The raw SQL query string.\n\t */\n\texport function raw(str: string): SQL {\n\t\treturn new SQL([new StringChunk(str)]);\n\t}\n\n\t/**\n\t * Join a list of SQL chunks with a separator.\n\t * @example\n\t * ```ts\n\t * const query = sql.join([sql`a`, sql`b`, sql`c`]);\n\t * // sql`abc`\n\t * ```\n\t * @example\n\t * ```ts\n\t * const query = sql.join([sql`a`, sql`b`, sql`c`], sql`, `);\n\t * // sql`a, b, c`\n\t * ```\n\t */\n\texport function join(chunks: SQLChunk[], separator?: SQLChunk): SQL {\n\t\tconst result: SQLChunk[] = [];\n\t\tfor (const [i, chunk] of chunks.entries()) {\n\t\t\tif (i > 0 && separator !== undefined) {\n\t\t\t\tresult.push(separator);\n\t\t\t}\n\t\t\tresult.push(chunk);\n\t\t}\n\t\treturn new SQL(result);\n\t}\n\n\t/**\n\t * Create a SQL chunk that represents a DB identifier (table, column, index etc.).\n\t * When used in a query, the identifier will be escaped based on the DB engine.\n\t * For example, in PostgreSQL, identifiers are escaped with double quotes.\n\t *\n\t * **WARNING: This function does not offer any protection against SQL injections, so you must validate any user input beforehand.**\n\t *\n\t * @example ```ts\n\t * const query = sql`SELECT * FROM ${sql.identifier('my-table')}`;\n\t * // 'SELECT * FROM \"my-table\"'\n\t * ```\n\t */\n\texport function identifier(value: string): Name {\n\t\treturn new Name(value);\n\t}\n\n\texport function placeholder<TName extends string>(name: TName): Placeholder<TName> {\n\t\treturn new Placeholder(name);\n\t}\n\n\texport function param<TData, TDriver>(\n\t\tvalue: TData,\n\t\tencoder?: DriverValueEncoder<TData, TDriver>,\n\t): Param<TData, TDriver> {\n\t\treturn new Param(value, encoder);\n\t}\n}\n\nexport namespace SQL {\n\texport class Aliased<T = unknown> implements SQLWrapper {\n\t\tstatic readonly [entityKind]: string = 'SQL.Aliased';\n\n\t\tdeclare _: {\n\t\t\tbrand: 'SQL.Aliased';\n\t\t\ttype: T;\n\t\t};\n\n\t\t/** @internal */\n\t\tisSelectionField = false;\n\n\t\tconstructor(\n\t\t\treadonly sql: SQL,\n\t\t\treadonly fieldAlias: string,\n\t\t) {}\n\n\t\tgetSQL(): SQL {\n\t\t\treturn this.sql;\n\t\t}\n\n\t\t/** @internal */\n\t\tclone() {\n\t\t\treturn new Aliased(this.sql, this.fieldAlias);\n\t\t}\n\t}\n}\n\nexport class Placeholder<TName extends string = string, TValue = any> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'Placeholder';\n\n\tdeclare protected: TValue;\n\n\tconstructor(readonly name: TName) {}\n\n\tgetSQL(): SQL {\n\t\treturn new SQL([this]);\n\t}\n}\n\n/** @deprecated Use `sql.placeholder` instead. */\nexport function placeholder<TName extends string>(name: TName): Placeholder<TName> {\n\treturn new Placeholder(name);\n}\n\nexport function fillPlaceholders(params: unknown[], values: Record<string, unknown>): unknown[] {\n\treturn params.map((p) => {\n\t\tif (is(p, Placeholder)) {\n\t\t\tif (!(p.name in values)) {\n\t\t\t\tthrow new Error(`No value for placeholder \"${p.name}\" was provided`);\n\t\t\t}\n\n\t\t\treturn values[p.name];\n\t\t}\n\n\t\tif (is(p, Param) && is(p.value, Placeholder)) {\n\t\t\tif (!(p.value.name in values)) {\n\t\t\t\tthrow new Error(`No value for placeholder \"${p.value.name}\" was provided`);\n\t\t\t}\n\n\t\t\treturn p.encoder.mapToDriverValue(values[p.value.name]);\n\t\t}\n\n\t\treturn p;\n\t});\n}\n\nexport type ColumnsSelection = Record<string, unknown>;\n\nexport abstract class View<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelection extends ColumnsSelection = ColumnsSelection,\n> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'View';\n\n\tdeclare _: {\n\t\tbrand: 'View';\n\t\tviewBrand: string;\n\t\tname: TName;\n\t\texisting: TExisting;\n\t\tselectedFields: TSelection;\n\t};\n\n\t/** @internal */\n\t[ViewBaseConfig]: {\n\t\tname: TName;\n\t\toriginalName: TName;\n\t\tschema: string | undefined;\n\t\tselectedFields: SelectedFields<AnyColumn, Table>;\n\t\tisExisting: TExisting;\n\t\tquery: TExisting extends true ? undefined : SQL;\n\t\tisAlias: boolean;\n\t};\n\n\tconstructor(\n\t\t{ name, schema, selectedFields, query }: {\n\t\t\tname: TName;\n\t\t\tschema: string | undefined;\n\t\t\tselectedFields: SelectedFields<AnyColumn, Table>;\n\t\t\tquery: SQL | undefined;\n\t\t},\n\t) {\n\t\tthis[ViewBaseConfig] = {\n\t\t\tname,\n\t\t\toriginalName: name,\n\t\t\tschema,\n\t\t\tselectedFields,\n\t\t\tquery: query as (TExisting extends true ? undefined : SQL),\n\t\t\tisExisting: !query as TExisting,\n\t\t\tisAlias: false,\n\t\t};\n\t}\n\n\tgetSQL(): SQL<unknown> {\n\t\treturn new SQL([this]);\n\t}\n}\n\n// Defined separately from the Column class to resolve circular dependency\nColumn.prototype.getSQL = function() {\n\treturn new SQL([this]);\n};\n\n// Defined separately from the Table class to resolve circular dependency\nTable.prototype.getSQL = function() {\n\treturn new SQL([this]);\n};\n\n// Defined separately from the Column class to resolve circular dependency\nSubquery.prototype.getSQL = function() {\n\treturn new SQL([this]);\n};\n","import type { AnyColumn } from './column.ts';\nimport { Column } from './column.ts';\nimport { is } from './entity.ts';\nimport type { Logger } from './logger.ts';\nimport type { SelectedFieldsOrdered } from './operations.ts';\nimport type { TableLike } from './query-builders/select.types.ts';\nimport { Param, SQL, View } from './sql/sql.ts';\nimport type { DriverValueDecoder } from './sql/sql.ts';\nimport { Subquery } from './subquery.ts';\nimport { getTableName, Table } from './table.ts';\nimport { ViewBaseConfig } from './view-common.ts';\n\n/** @internal */\nexport function mapResultRow<TResult>(\n\tcolumns: SelectedFieldsOrdered<AnyColumn>,\n\trow: unknown[],\n\tjoinsNotNullableMap: Record<string, boolean> | undefined,\n): TResult {\n\t// Key -> nested object key, value -> table name if all fields in the nested object are from the same table, false otherwise\n\tconst nullifyMap: Record<string, string | false> = {};\n\n\tconst result = columns.reduce<Record<string, any>>(\n\t\t(result, { path, field }, columnIndex) => {\n\t\t\tlet decoder: DriverValueDecoder<unknown, unknown>;\n\t\t\tif (is(field, Column)) {\n\t\t\t\tdecoder = field;\n\t\t\t} else if (is(field, SQL)) {\n\t\t\t\tdecoder = field.decoder;\n\t\t\t} else {\n\t\t\t\tdecoder = field.sql.decoder;\n\t\t\t}\n\t\t\tlet node = result;\n\t\t\tfor (const [pathChunkIndex, pathChunk] of path.entries()) {\n\t\t\t\tif (pathChunkIndex < path.length - 1) {\n\t\t\t\t\tif (!(pathChunk in node)) {\n\t\t\t\t\t\tnode[pathChunk] = {};\n\t\t\t\t\t}\n\t\t\t\t\tnode = node[pathChunk];\n\t\t\t\t} else {\n\t\t\t\t\tconst rawValue = row[columnIndex]!;\n\t\t\t\t\tconst value = node[pathChunk] = rawValue === null ? null : decoder.mapFromDriverValue(rawValue);\n\n\t\t\t\t\tif (joinsNotNullableMap && is(field, Column) && path.length === 2) {\n\t\t\t\t\t\tconst objectName = path[0]!;\n\t\t\t\t\t\tif (!(objectName in nullifyMap)) {\n\t\t\t\t\t\t\tnullifyMap[objectName] = value === null ? getTableName(field.table) : false;\n\t\t\t\t\t\t} else if (\n\t\t\t\t\t\t\ttypeof nullifyMap[objectName] === 'string' && nullifyMap[objectName] !== getTableName(field.table)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tnullifyMap[objectName] = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\t\t},\n\t\t{},\n\t);\n\n\t// Nullify all nested objects from nullifyMap that are nullable\n\tif (joinsNotNullableMap && Object.keys(nullifyMap).length > 0) {\n\t\tfor (const [objectName, tableName] of Object.entries(nullifyMap)) {\n\t\t\tif (typeof tableName === 'string' && !joinsNotNullableMap[tableName]) {\n\t\t\t\tresult[objectName] = null;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result as TResult;\n}\n\n/** @internal */\nexport function orderSelectedFields<TColumn extends AnyColumn>(\n\tfields: Record<string, unknown>,\n\tpathPrefix?: string[],\n): SelectedFieldsOrdered<TColumn> {\n\treturn Object.entries(fields).reduce<SelectedFieldsOrdered<AnyColumn>>((result, [name, field]) => {\n\t\tif (typeof name !== 'string') {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst newPath = pathPrefix ? [...pathPrefix, name] : [name];\n\t\tif (is(field, Column) || is(field, SQL) || is(field, SQL.Aliased)) {\n\t\t\tresult.push({ path: newPath, field });\n\t\t} else if (is(field, Table)) {\n\t\t\tresult.push(...orderSelectedFields(field[Table.Symbol.Columns], newPath));\n\t\t} else {\n\t\t\tresult.push(...orderSelectedFields(field as Record<string, unknown>, newPath));\n\t\t}\n\t\treturn result;\n\t}, []) as SelectedFieldsOrdered<TColumn>;\n}\n\nexport function haveSameKeys(left: Record<string, unknown>, right: Record<string, unknown>) {\n\tconst leftKeys = Object.keys(left);\n\tconst rightKeys = Object.keys(right);\n\n\tif (leftKeys.length !== rightKeys.length) {\n\t\treturn false;\n\t}\n\n\tfor (const [index, key] of leftKeys.entries()) {\n\t\tif (key !== rightKeys[index]) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n/** @internal */\nexport function mapUpdateSet(table: Table, values: Record<string, unknown>): UpdateSet {\n\tconst entries: [string, UpdateSet[string]][] = Object.entries(values)\n\t\t.filter(([, value]) => value !== undefined)\n\t\t.map(([key, value]) => {\n\t\t\t// eslint-disable-next-line unicorn/prefer-ternary\n\t\t\tif (is(value, SQL) || is(value, Column)) {\n\t\t\t\treturn [key, value];\n\t\t\t} else {\n\t\t\t\treturn [key, new Param(value, table[Table.Symbol.Columns][key])];\n\t\t\t}\n\t\t});\n\n\tif (entries.length === 0) {\n\t\tthrow new Error('No values to set');\n\t}\n\n\treturn Object.fromEntries(entries);\n}\n\nexport type UpdateSet = Record<string, SQL | Param | AnyColumn | null | undefined>;\n\nexport type OneOrMany<T> = T | T[];\n\nexport type Update<T, TUpdate> =\n\t& {\n\t\t[K in Exclude<keyof T, keyof TUpdate>]: T[K];\n\t}\n\t& TUpdate;\n\nexport type Simplify<T> =\n\t& {\n\t\t// @ts-ignore - \"Type parameter 'K' has a circular constraint\", not sure why\n\t\t[K in keyof T]: T[K];\n\t}\n\t& {};\n\nexport type SimplifyMappedType<T> = [T] extends [unknown] ? T : never;\n\nexport type ShallowRecord<K extends keyof any, T> = SimplifyMappedType<{ [P in K]: T }>;\n\nexport type Assume<T, U> = T extends U ? T : U;\n\nexport type Equal<X, Y> = (<T>() => T extends X ? 1 : 2) extends (<T>() => T extends Y ? 1 : 2) ? true : false;\n\nexport interface DrizzleTypeError<T extends string> {\n\t$drizzleTypeError: T;\n}\n\nexport type ValueOrArray<T> = T | T[];\n\n/** @internal */\nexport function applyMixins(baseClass: any, extendedClasses: any[]) {\n\tfor (const extendedClass of extendedClasses) {\n\t\tfor (const name of Object.getOwnPropertyNames(extendedClass.prototype)) {\n\t\t\tif (name === 'constructor') continue;\n\n\t\t\tObject.defineProperty(\n\t\t\t\tbaseClass.prototype,\n\t\t\t\tname,\n\t\t\t\tObject.getOwnPropertyDescriptor(extendedClass.prototype, name) || Object.create(null),\n\t\t\t);\n\t\t}\n\t}\n}\n\nexport type Or<T1, T2> = T1 extends true ? true : T2 extends true ? true : false;\n\nexport type IfThenElse<If, Then, Else> = If extends true ? Then : Else;\n\nexport type PromiseOf<T> = T extends Promise<infer U> ? U : T;\n\nexport type Writable<T> = {\n\t-readonly [P in keyof T]: T[P];\n};\n\nexport function getTableColumns<T extends Table>(table: T): T['_']['columns'] {\n\treturn table[Table.Symbol.Columns];\n}\n\n/** @internal */\nexport function getTableLikeName(table: TableLike): string | undefined {\n\treturn is(table, Subquery)\n\t\t? table._.alias\n\t\t: is(table, View)\n\t\t? table[ViewBaseConfig].name\n\t\t: is(table, SQL)\n\t\t? undefined\n\t\t: table[Table.Symbol.IsAlias]\n\t\t? table[Table.Symbol.Name]\n\t\t: table[Table.Symbol.BaseName];\n}\n\nexport type ColumnsWithTable<\n\tTTableName extends string,\n\tTForeignTableName extends string,\n\tTColumns extends AnyColumn<{ tableName: TTableName }>[],\n> = { [Key in keyof TColumns]: AnyColumn<{ tableName: TForeignTableName }> };\n\nexport type Casing = 'snake_case' | 'camelCase';\n\nexport interface DrizzleConfig<TSchema extends Record<string, unknown> = Record<string, never>> {\n\tlogger?: boolean | Logger;\n\tschema?: TSchema;\n\tcasing?: Casing;\n}\nexport type ValidateShape<T, ValidShape, TResult = T> = T extends ValidShape\n\t? Exclude<keyof T, keyof ValidShape> extends never ? TResult\n\t: DrizzleTypeError<\n\t\t`Invalid key(s): ${Exclude<(keyof T) & (string | number | bigint | boolean | null | undefined), keyof ValidShape>}`\n\t>\n\t: never;\n\nexport type KnownKeysOnly<T, U> = {\n\t[K in keyof T]: K extends keyof U ? T[K] : never;\n};\n\nexport type IsAny<T> = 0 extends (1 & T) ? true : false;\n\n/** @internal */\nexport function getColumnNameAndConfig<\n\tTConfig extends Record<string, any> | undefined,\n>(a: string | TConfig | undefined, b: TConfig | undefined) {\n\treturn {\n\t\tname: typeof a === 'string' && a.length > 0 ? a : '' as string,\n\t\tconfig: typeof a === 'object' ? a : b as TConfig,\n\t};\n}\n\nexport type IfNotImported<T, Y, N> = unknown extends T ? Y : N;\n\nexport type ImportTypeError<TPackageName extends string> =\n\t`Please install \\`${TPackageName}\\` to allow Drizzle ORM to connect to the database`;\n\nexport type RequireAtLeastOne<T, Keys extends keyof T = keyof T> = Keys extends any\n\t? Required<Pick<T, Keys>> & Partial<Omit<T, Keys>>\n\t: never;\n\ntype ExpectedConfigShape = {\n\tlogger?: boolean | {\n\t\tlogQuery(query: string, params: unknown[]): void;\n\t};\n\tschema?: Record<string, never>;\n\tcasing?: 'snake_case' | 'camelCase';\n};\n\n// If this errors, you must update config shape checker function with new config specs\nconst _: DrizzleConfig = {} as ExpectedConfigShape;\nconst __: ExpectedConfigShape = {} as DrizzleConfig;\n\nexport function isConfig(data: any): boolean {\n\tif (typeof data !== 'object' || data === null) return false;\n\n\tif (data.constructor.name !== 'Object') return false;\n\n\tif ('logger' in data) {\n\t\tconst type = typeof data['logger'];\n\t\tif (\n\t\t\ttype !== 'boolean' && (type !== 'object' || typeof data['logger']['logQuery'] !== 'function')\n\t\t\t&& type !== 'undefined'\n\t\t) return false;\n\n\t\treturn true;\n\t}\n\n\tif ('schema' in data) {\n\t\tconst type = typeof data['logger'];\n\t\tif (type !== 'object' && type !== 'undefined') return false;\n\n\t\treturn true;\n\t}\n\n\tif ('casing' in data) {\n\t\tconst type = typeof data['logger'];\n\t\tif (type !== 'string' && type !== 'undefined') return false;\n\n\t\treturn true;\n\t}\n\n\tif ('mode' in data) {\n\t\tif (data['mode'] !== 'default' || data['mode'] !== 'planetscale' || data['mode'] !== undefined) return false;\n\n\t\treturn true;\n\t}\n\n\tif ('connection' in data) {\n\t\tconst type = typeof data['connection'];\n\t\tif (type !== 'string' && type !== 'object' && type !== 'undefined') return false;\n\n\t\treturn true;\n\t}\n\n\tif ('client' in data) {\n\t\tconst type = typeof data['client'];\n\t\tif (type !== 'object' && type !== 'function' && type !== 'undefined') return false;\n\n\t\treturn true;\n\t}\n\n\tif (Object.keys(data).length === 0) return true;\n\n\treturn false;\n}\n","import { entityKind } from '~/entity.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport type {\n\tPgPreparedQuery,\n\tPgQueryResultHKT,\n\tPgQueryResultKind,\n\tPgSession,\n\tPreparedQueryConfig,\n} from '~/pg-core/session.ts';\nimport type { PgTable } from '~/pg-core/table.ts';\nimport type { SelectResultFields } from '~/query-builders/select.types.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport type { Query, SQL, SQLWrapper } from '~/sql/sql.ts';\nimport type { Subquery } from '~/subquery.ts';\nimport { Table } from '~/table.ts';\nimport { tracer } from '~/tracing.ts';\nimport { orderSelectedFields } from '~/utils.ts';\nimport type { PgColumn } from '../columns/common.ts';\nimport type { SelectedFieldsFlat, SelectedFieldsOrdered } from './select.types.ts';\n\nexport type PgDeleteWithout<\n\tT extends AnyPgDeleteBase,\n\tTDynamic extends boolean,\n\tK extends keyof T & string,\n> = TDynamic extends true ? T\n\t: Omit<\n\t\tPgDeleteBase<\n\t\t\tT['_']['table'],\n\t\t\tT['_']['queryResult'],\n\t\t\tT['_']['returning'],\n\t\t\tTDynamic,\n\t\t\tT['_']['excludedMethods'] | K\n\t\t>,\n\t\tT['_']['excludedMethods'] | K\n\t>;\n\nexport type PgDelete<\n\tTTable extends PgTable = PgTable,\n\tTQueryResult extends PgQueryResultHKT = PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = Record<string, unknown> | undefined,\n> = PgDeleteBase<TTable, TQueryResult, TReturning, true, never>;\n\nexport interface PgDeleteConfig {\n\twhere?: SQL | undefined;\n\ttable: PgTable;\n\treturning?: SelectedFieldsOrdered;\n\twithList?: Subquery[];\n}\n\nexport type PgDeleteReturningAll<\n\tT extends AnyPgDeleteBase,\n\tTDynamic extends boolean,\n> = PgDeleteWithout<\n\tPgDeleteBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tT['_']['table']['$inferSelect'],\n\t\tTDynamic,\n\t\tT['_']['excludedMethods']\n\t>,\n\tTDynamic,\n\t'returning'\n>;\n\nexport type PgDeleteReturning<\n\tT extends AnyPgDeleteBase,\n\tTDynamic extends boolean,\n\tTSelectedFields extends SelectedFieldsFlat,\n> = PgDeleteWithout<\n\tPgDeleteBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tSelectResultFields<TSelectedFields>,\n\t\tTDynamic,\n\t\tT['_']['excludedMethods']\n\t>,\n\tTDynamic,\n\t'returning'\n>;\n\nexport type PgDeletePrepare<T extends AnyPgDeleteBase> = PgPreparedQuery<\n\tPreparedQueryConfig & {\n\t\texecute: T['_']['returning'] extends undefined ? PgQueryResultKind<T['_']['queryResult'], never>\n\t\t\t: T['_']['returning'][];\n\t}\n>;\n\nexport type PgDeleteDynamic<T extends AnyPgDeleteBase> = PgDelete<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tT['_']['returning']\n>;\n\nexport type AnyPgDeleteBase = PgDeleteBase<any, any, any, any, any>;\n\nexport interface PgDeleteBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n> extends\n\tQueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>,\n\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\tSQLWrapper\n{\n\treadonly _: {\n\t\tdialect: 'pg';\n\t\treadonly table: TTable;\n\t\treadonly queryResult: TQueryResult;\n\t\treadonly returning: TReturning;\n\t\treadonly dynamic: TDynamic;\n\t\treadonly excludedMethods: TExcludedMethods;\n\t\treadonly result: TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[];\n\t};\n}\n\nexport class PgDeleteBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\tTDynamic extends boolean = false,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTExcludedMethods extends string = never,\n> extends QueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>\n\timplements\n\t\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\t\tSQLWrapper\n{\n\tstatic override readonly [entityKind]: string = 'PgDelete';\n\n\tprivate config: PgDeleteConfig;\n\n\tconstructor(\n\t\ttable: TTable,\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t\twithList?: Subquery[],\n\t) {\n\t\tsuper();\n\t\tthis.config = { table, withList };\n\t}\n\n\t/**\n\t * Adds a `where` clause to the query.\n\t *\n\t * Calling this method will delete only those rows that fulfill a specified condition.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/delete}\n\t *\n\t * @param where the `where` clause.\n\t *\n\t * @example\n\t * You can use conditional operators and `sql function` to filter the rows to be deleted.\n\t *\n\t * ```ts\n\t * // Delete all cars with green color\n\t * await db.delete(cars).where(eq(cars.color, 'green'));\n\t * // or\n\t * await db.delete(cars).where(sql`${cars.color} = 'green'`)\n\t * ```\n\t *\n\t * You can logically combine conditional operators with `and()` and `or()` operators:\n\t *\n\t * ```ts\n\t * // Delete all BMW cars with a green color\n\t * await db.delete(cars).where(and(eq(cars.color, 'green'), eq(cars.brand, 'BMW')));\n\t *\n\t * // Delete all cars with the green or blue color\n\t * await db.delete(cars).where(or(eq(cars.color, 'green'), eq(cars.color, 'blue')));\n\t * ```\n\t */\n\twhere(where: SQL | undefined): PgDeleteWithout<this, TDynamic, 'where'> {\n\t\tthis.config.where = where;\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `returning` clause to the query.\n\t *\n\t * Calling this method will return the specified fields of the deleted rows. If no fields are specified, all fields will be returned.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/delete#delete-with-return}\n\t *\n\t * @example\n\t * ```ts\n\t * // Delete all cars with the green color and return all fields\n\t * const deletedCars: Car[] = await db.delete(cars)\n\t *   .where(eq(cars.color, 'green'))\n\t *   .returning();\n\t *\n\t * // Delete all cars with the green color and return only their id and brand fields\n\t * const deletedCarsIdsAndBrands: { id: number, brand: string }[] = await db.delete(cars)\n\t *   .where(eq(cars.color, 'green'))\n\t *   .returning({ id: cars.id, brand: cars.brand });\n\t * ```\n\t */\n\treturning(): PgDeleteReturningAll<this, TDynamic>;\n\treturning<TSelectedFields extends SelectedFieldsFlat>(\n\t\tfields: TSelectedFields,\n\t): PgDeleteReturning<this, TDynamic, TSelectedFields>;\n\treturning(\n\t\tfields: SelectedFieldsFlat = this.config.table[Table.Symbol.Columns],\n\t): PgDeleteReturning<this, TDynamic, any> {\n\t\tthis.config.returning = orderSelectedFields<PgColumn>(fields);\n\t\treturn this as any;\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this.dialect.buildDeleteQuery(this.config);\n\t}\n\n\ttoSQL(): Query {\n\t\tconst { typings: _typings, ...rest } = this.dialect.sqlToQuery(this.getSQL());\n\t\treturn rest;\n\t}\n\n\t/** @internal */\n\t_prepare(name?: string): PgDeletePrepare<this> {\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\treturn this.session.prepareQuery<\n\t\t\t\tPreparedQueryConfig & {\n\t\t\t\t\texecute: TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[];\n\t\t\t\t}\n\t\t\t>(this.dialect.sqlToQuery(this.getSQL()), this.config.returning, name, true);\n\t\t});\n\t}\n\n\tprepare(name: string): PgDeletePrepare<this> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\toverride execute: ReturnType<this['prepare']>['execute'] = (placeholderValues) => {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(placeholderValues, this.authToken);\n\t\t});\n\t};\n\n\t$dynamic(): PgDeleteDynamic<this> {\n\t\treturn this as any;\n\t}\n}\n","import type { AnyColumn } from './column.ts';\nimport { Column } from './column.ts';\nimport { entityKind, is } from './entity.ts';\nimport type { Relation } from './relations.ts';\nimport type { View } from './sql/sql.ts';\nimport { SQL, sql } from './sql/sql.ts';\nimport { Table } from './table.ts';\nimport { ViewBaseConfig } from './view-common.ts';\n\nexport class ColumnAliasProxyHandler<TColumn extends Column> implements ProxyHandler<TColumn> {\n\tstatic readonly [entityKind]: string = 'ColumnAliasProxyHandler';\n\n\tconstructor(private table: Table | View) {}\n\n\tget(columnObj: TColumn, prop: string | symbol): any {\n\t\tif (prop === 'table') {\n\t\t\treturn this.table;\n\t\t}\n\n\t\treturn columnObj[prop as keyof TColumn];\n\t}\n}\n\nexport class TableAliasProxyHandler<T extends Table | View> implements ProxyHandler<T> {\n\tstatic readonly [entityKind]: string = 'TableAliasProxyHandler';\n\n\tconstructor(private alias: string, private replaceOriginalName: boolean) {}\n\n\tget(target: T, prop: string | symbol): any {\n\t\tif (prop === Table.Symbol.IsAlias) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (prop === Table.Symbol.Name) {\n\t\t\treturn this.alias;\n\t\t}\n\n\t\tif (this.replaceOriginalName && prop === Table.Symbol.OriginalName) {\n\t\t\treturn this.alias;\n\t\t}\n\n\t\tif (prop === ViewBaseConfig) {\n\t\t\treturn {\n\t\t\t\t...target[ViewBaseConfig as keyof typeof target],\n\t\t\t\tname: this.alias,\n\t\t\t\tisAlias: true,\n\t\t\t};\n\t\t}\n\n\t\tif (prop === Table.Symbol.Columns) {\n\t\t\tconst columns = (target as Table)[Table.Symbol.Columns];\n\t\t\tif (!columns) {\n\t\t\t\treturn columns;\n\t\t\t}\n\n\t\t\tconst proxiedColumns: { [key: string]: any } = {};\n\n\t\t\tObject.keys(columns).map((key) => {\n\t\t\t\tproxiedColumns[key] = new Proxy(\n\t\t\t\t\tcolumns[key]!,\n\t\t\t\t\tnew ColumnAliasProxyHandler(new Proxy(target, this)),\n\t\t\t\t);\n\t\t\t});\n\n\t\t\treturn proxiedColumns;\n\t\t}\n\n\t\tconst value = target[prop as keyof typeof target];\n\t\tif (is(value, Column)) {\n\t\t\treturn new Proxy(value as AnyColumn, new ColumnAliasProxyHandler(new Proxy(target, this)));\n\t\t}\n\n\t\treturn value;\n\t}\n}\n\nexport class RelationTableAliasProxyHandler<T extends Relation> implements ProxyHandler<T> {\n\tstatic readonly [entityKind]: string = 'RelationTableAliasProxyHandler';\n\n\tconstructor(private alias: string) {}\n\n\tget(target: T, prop: string | symbol): any {\n\t\tif (prop === 'sourceTable') {\n\t\t\treturn aliasedTable(target.sourceTable, this.alias);\n\t\t}\n\n\t\treturn target[prop as keyof typeof target];\n\t}\n}\n\nexport function aliasedTable<T extends Table>(table: T, tableAlias: string): T {\n\treturn new Proxy(table, new TableAliasProxyHandler(tableAlias, false));\n}\n\nexport function aliasedRelation<T extends Relation>(relation: T, tableAlias: string): T {\n\treturn new Proxy(relation, new RelationTableAliasProxyHandler(tableAlias));\n}\n\nexport function aliasedTableColumn<T extends AnyColumn>(column: T, tableAlias: string): T {\n\treturn new Proxy(\n\t\tcolumn,\n\t\tnew ColumnAliasProxyHandler(new Proxy(column.table, new TableAliasProxyHandler(tableAlias, false))),\n\t);\n}\n\nexport function mapColumnsInAliasedSQLToAlias(query: SQL.Aliased, alias: string): SQL.Aliased {\n\treturn new SQL.Aliased(mapColumnsInSQLToAlias(query.sql, alias), query.fieldAlias);\n}\n\nexport function mapColumnsInSQLToAlias(query: SQL, alias: string): SQL {\n\treturn sql.join(query.queryChunks.map((c) => {\n\t\tif (is(c, Column)) {\n\t\t\treturn aliasedTableColumn(c, alias);\n\t\t}\n\t\tif (is(c, SQL)) {\n\t\t\treturn mapColumnsInSQLToAlias(c, alias);\n\t\t}\n\t\tif (is(c, SQL.Aliased)) {\n\t\t\treturn mapColumnsInAliasedSQLToAlias(c, alias);\n\t\t}\n\t\treturn c;\n\t}));\n}\n","import type { Column } from '~/column.ts';\nimport { entityKind } from './entity.ts';\nimport { Table } from './table.ts';\nimport type { Casing } from './utils.ts';\n\nexport function toSnakeCase(input: string) {\n\tconst words = input\n\t\t.replace(/['\\u2019]/g, '')\n\t\t.match(/[\\da-z]+|[A-Z]+(?![a-z])|[A-Z][\\da-z]+/g) ?? [];\n\n\treturn words.map((word) => word.toLowerCase()).join('_');\n}\n\nexport function toCamelCase(input: string) {\n\tconst words = input\n\t\t.replace(/['\\u2019]/g, '')\n\t\t.match(/[\\da-z]+|[A-Z]+(?![a-z])|[A-Z][\\da-z]+/g) ?? [];\n\n\treturn words.reduce((acc, word, i) => {\n\t\tconst formattedWord = i === 0 ? word.toLowerCase() : `${word[0]!.toUpperCase()}${word.slice(1)}`;\n\t\treturn acc + formattedWord;\n\t}, '');\n}\n\nfunction noopCase(input: string) {\n\treturn input;\n}\n\nexport class CasingCache {\n\tstatic readonly [entityKind]: string = 'CasingCache';\n\n\t/** @internal */\n\tcache: Record<string, string> = {};\n\tprivate cachedTables: Record<string, true> = {};\n\tprivate convert: (input: string) => string;\n\n\tconstructor(casing?: Casing) {\n\t\tthis.convert = casing === 'snake_case'\n\t\t\t? toSnakeCase\n\t\t\t: casing === 'camelCase'\n\t\t\t? toCamelCase\n\t\t\t: noopCase;\n\t}\n\n\tgetColumnCasing(column: Column): string {\n\t\tif (!column.keyAsName) return column.name;\n\n\t\tconst schema = column.table[Table.Symbol.Schema] ?? 'public';\n\t\tconst tableName = column.table[Table.Symbol.OriginalName];\n\t\tconst key = `${schema}.${tableName}.${column.name}`;\n\n\t\tif (!this.cache[key]) {\n\t\t\tthis.cacheTable(column.table);\n\t\t}\n\t\treturn this.cache[key]!;\n\t}\n\n\tprivate cacheTable(table: Table) {\n\t\tconst schema = table[Table.Symbol.Schema] ?? 'public';\n\t\tconst tableName = table[Table.Symbol.OriginalName];\n\t\tconst tableKey = `${schema}.${tableName}`;\n\n\t\tif (!this.cachedTables[tableKey]) {\n\t\t\tfor (const column of Object.values(table[Table.Symbol.Columns])) {\n\t\t\t\tconst columnKey = `${tableKey}.${column.name}`;\n\t\t\t\tthis.cache[columnKey] = this.convert(column.name);\n\t\t\t}\n\t\t\tthis.cachedTables[tableKey] = true;\n\t\t}\n\t}\n\n\tclearCache() {\n\t\tthis.cache = {};\n\t\tthis.cachedTables = {};\n\t}\n}\n","import { entityKind } from '~/entity.ts';\n\nexport class DrizzleError extends Error {\n\tstatic readonly [entityKind]: string = 'DrizzleError';\n\n\tconstructor({ message, cause }: { message?: string; cause?: unknown }) {\n\t\tsuper(message);\n\t\tthis.name = 'DrizzleError';\n\t\tthis.cause = cause;\n\t}\n}\n\nexport class TransactionRollbackError extends DrizzleError {\n\tstatic override readonly [entityKind]: string = 'TransactionRollbackError';\n\n\tconstructor() {\n\t\tsuper({ message: 'Rollback' });\n\t}\n}\n","import type { ColumnBuilderBaseConfig, ColumnDataType, GeneratedIdentityConfig, IsIdentity } from '~/column-builder.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { PgSequenceOptions } from '../sequence.ts';\nimport { PgColumnBuilder } from './common.ts';\n\nexport abstract class PgIntColumnBaseBuilder<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n> extends PgColumnBuilder<\n\tT,\n\t{ generatedIdentity: GeneratedIdentityConfig }\n> {\n\tstatic override readonly [entityKind]: string = 'PgIntColumnBaseBuilder';\n\n\tgeneratedAlwaysAsIdentity(\n\t\tsequence?: PgSequenceOptions & { name?: string },\n\t): IsIdentity<this, 'always'> {\n\t\tif (sequence) {\n\t\t\tconst { name, ...options } = sequence;\n\t\t\tthis.config.generatedIdentity = {\n\t\t\t\ttype: 'always',\n\t\t\t\tsequenceName: name,\n\t\t\t\tsequenceOptions: options,\n\t\t\t};\n\t\t} else {\n\t\t\tthis.config.generatedIdentity = {\n\t\t\t\ttype: 'always',\n\t\t\t};\n\t\t}\n\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\n\t\treturn this as IsIdentity<this, 'always'>;\n\t}\n\n\tgeneratedByDefaultAsIdentity(\n\t\tsequence?: PgSequenceOptions & { name?: string },\n\t): IsIdentity<this, 'byDefault'> {\n\t\tif (sequence) {\n\t\t\tconst { name, ...options } = sequence;\n\t\t\tthis.config.generatedIdentity = {\n\t\t\t\ttype: 'byDefault',\n\t\t\t\tsequenceName: name,\n\t\t\t\tsequenceOptions: options,\n\t\t\t};\n\t\t} else {\n\t\t\tthis.config.generatedIdentity = {\n\t\t\t\ttype: 'byDefault',\n\t\t\t};\n\t\t}\n\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\n\t\treturn this as IsIdentity<this, 'byDefault'>;\n\t}\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\n\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn } from './common.ts';\nimport { PgIntColumnBaseBuilder } from './int.common.ts';\n\nexport type PgBigInt53BuilderInitial<TName extends string> = PgBigInt53Builder<{\n\tname: TName;\n\tdataType: 'number';\n\tcolumnType: 'PgBigInt53';\n\tdata: number;\n\tdriverParam: number | string;\n\tenumValues: undefined;\n}>;\n\nexport class PgBigInt53Builder<T extends ColumnBuilderBaseConfig<'number', 'PgBigInt53'>>\n\textends PgIntColumnBaseBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgBigInt53Builder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgBigInt53');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBigInt53<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBigInt53<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgBigInt53<T extends ColumnBaseConfig<'number', 'PgBigInt53'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgBigInt53';\n\n\tgetSQLType(): string {\n\t\treturn 'bigint';\n\t}\n\n\toverride mapFromDriverValue(value: number | string): number {\n\t\tif (typeof value === 'number') {\n\t\t\treturn value;\n\t\t}\n\t\treturn Number(value);\n\t}\n}\n\nexport type PgBigInt64BuilderInitial<TName extends string> = PgBigInt64Builder<{\n\tname: TName;\n\tdataType: 'bigint';\n\tcolumnType: 'PgBigInt64';\n\tdata: bigint;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgBigInt64Builder<T extends ColumnBuilderBaseConfig<'bigint', 'PgBigInt64'>>\n\textends PgIntColumnBaseBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgBigInt64Builder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'bigint', 'PgBigInt64');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBigInt64<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBigInt64<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgBigInt64<T extends ColumnBaseConfig<'bigint', 'PgBigInt64'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgBigInt64';\n\n\tgetSQLType(): string {\n\t\treturn 'bigint';\n\t}\n\n\t// eslint-disable-next-line unicorn/prefer-native-coercion-functions\n\toverride mapFromDriverValue(value: string): bigint {\n\t\treturn BigInt(value);\n\t}\n}\n\nexport interface PgBigIntConfig<T extends 'number' | 'bigint' = 'number' | 'bigint'> {\n\tmode: T;\n}\n\nexport function bigint<TMode extends PgBigIntConfig['mode']>(\n\tconfig: PgBigIntConfig<TMode>,\n): TMode extends 'number' ? PgBigInt53BuilderInitial<''> : PgBigInt64BuilderInitial<''>;\nexport function bigint<TName extends string, TMode extends PgBigIntConfig['mode']>(\n\tname: TName,\n\tconfig: PgBigIntConfig<TMode>,\n): TMode extends 'number' ? PgBigInt53BuilderInitial<TName> : PgBigInt64BuilderInitial<TName>;\nexport function bigint(a: string | PgBigIntConfig, b?: PgBigIntConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgBigIntConfig>(a, b);\n\tif (config.mode === 'number') {\n\t\treturn new PgBigInt53Builder(name);\n\t}\n\treturn new PgBigInt64Builder(name);\n}\n","import type {\n\tColumnBuilderBaseConfig,\n\tColumnBuilderRuntimeConfig,\n\tHasDefault,\n\tMakeColumnConfig,\n\tNotNull,\n} from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgBigSerial53BuilderInitial<TName extends string> = NotNull<\n\tHasDefault<\n\t\tPgBigSerial53Builder<{\n\t\t\tname: TName;\n\t\t\tdataType: 'number';\n\t\t\tcolumnType: 'PgBigSerial53';\n\t\t\tdata: number;\n\t\t\tdriverParam: number;\n\t\t\tenumValues: undefined;\n\t\t}>\n\t>\n>;\n\nexport class PgBigSerial53Builder<T extends ColumnBuilderBaseConfig<'number', 'PgBigSerial53'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgBigSerial53Builder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'number', 'PgBigSerial53');\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBigSerial53<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBigSerial53<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgBigSerial53<T extends ColumnBaseConfig<'number', 'PgBigSerial53'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgBigSerial53';\n\n\tgetSQLType(): string {\n\t\treturn 'bigserial';\n\t}\n\n\toverride mapFromDriverValue(value: number): number {\n\t\tif (typeof value === 'number') {\n\t\t\treturn value;\n\t\t}\n\t\treturn Number(value);\n\t}\n}\n\nexport type PgBigSerial64BuilderInitial<TName extends string> = NotNull<\n\tHasDefault<\n\t\tPgBigSerial64Builder<{\n\t\t\tname: TName;\n\t\t\tdataType: 'bigint';\n\t\t\tcolumnType: 'PgBigSerial64';\n\t\t\tdata: bigint;\n\t\t\tdriverParam: string;\n\t\t\tenumValues: undefined;\n\t\t}>\n\t>\n>;\n\nexport class PgBigSerial64Builder<T extends ColumnBuilderBaseConfig<'bigint', 'PgBigSerial64'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgBigSerial64Builder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'bigint', 'PgBigSerial64');\n\t\tthis.config.hasDefault = true;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBigSerial64<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBigSerial64<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgBigSerial64<T extends ColumnBaseConfig<'bigint', 'PgBigSerial64'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgBigSerial64';\n\n\tgetSQLType(): string {\n\t\treturn 'bigserial';\n\t}\n\n\t// eslint-disable-next-line unicorn/prefer-native-coercion-functions\n\toverride mapFromDriverValue(value: string): bigint {\n\t\treturn BigInt(value);\n\t}\n}\n\nexport interface PgBigSerialConfig<T extends 'number' | 'bigint' = 'number' | 'bigint'> {\n\tmode: T;\n}\n\nexport function bigserial<TMode extends PgBigSerialConfig['mode']>(\n\tconfig: PgBigSerialConfig<TMode>,\n): TMode extends 'number' ? PgBigSerial53BuilderInitial<''> : PgBigSerial64BuilderInitial<''>;\nexport function bigserial<TName extends string, TMode extends PgBigSerialConfig['mode']>(\n\tname: TName,\n\tconfig: PgBigSerialConfig<TMode>,\n): TMode extends 'number' ? PgBigSerial53BuilderInitial<TName> : PgBigSerial64BuilderInitial<TName>;\nexport function bigserial(a: string | PgBigSerialConfig, b?: PgBigSerialConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgBigSerialConfig>(a, b);\n\tif (config.mode === 'number') {\n\t\treturn new PgBigSerial53Builder(name);\n\t}\n\treturn new PgBigSerial64Builder(name);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgBooleanBuilderInitial<TName extends string> = PgBooleanBuilder<{\n\tname: TName;\n\tdataType: 'boolean';\n\tcolumnType: 'PgBoolean';\n\tdata: boolean;\n\tdriverParam: boolean;\n\tenumValues: undefined;\n}>;\n\nexport class PgBooleanBuilder<T extends ColumnBuilderBaseConfig<'boolean', 'PgBoolean'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgBooleanBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'boolean', 'PgBoolean');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBoolean<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBoolean<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgBoolean<T extends ColumnBaseConfig<'boolean', 'PgBoolean'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgBoolean';\n\n\tgetSQLType(): string {\n\t\treturn 'boolean';\n\t}\n}\n\nexport function boolean(): PgBooleanBuilderInitial<''>;\nexport function boolean<TName extends string>(name: TName): PgBooleanBuilderInitial<TName>;\nexport function boolean(name?: string) {\n\treturn new PgBooleanBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig, type Writable } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgCharBuilderInitial<TName extends string, TEnum extends [string, ...string[]]> = PgCharBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgChar';\n\tdata: TEnum[number];\n\tenumValues: TEnum;\n\tdriverParam: string;\n}>;\n\nexport class PgCharBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgChar'>> extends PgColumnBuilder<\n\tT,\n\t{ length: number | undefined; enumValues: T['enumValues'] }\n> {\n\tstatic override readonly [entityKind]: string = 'PgCharBuilder';\n\n\tconstructor(name: T['name'], config: PgCharConfig<T['enumValues']>) {\n\t\tsuper(name, 'string', 'PgChar');\n\t\tthis.config.length = config.length;\n\t\tthis.config.enumValues = config.enum;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgChar<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgChar<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgChar<T extends ColumnBaseConfig<'string', 'PgChar'>>\n\textends PgColumn<T, { length: number | undefined; enumValues: T['enumValues'] }>\n{\n\tstatic override readonly [entityKind]: string = 'PgChar';\n\n\treadonly length = this.config.length;\n\toverride readonly enumValues = this.config.enumValues;\n\n\tgetSQLType(): string {\n\t\treturn this.length === undefined ? `char` : `char(${this.length})`;\n\t}\n}\n\nexport interface PgCharConfig<\n\tTEnum extends readonly string[] | string[] | undefined = readonly string[] | string[] | undefined,\n> {\n\tlength?: number;\n\tenum?: TEnum;\n}\n\nexport function char(): PgCharBuilderInitial<'', [string, ...string[]]>;\nexport function char<U extends string, T extends Readonly<[U, ...U[]]>>(\n\tconfig?: PgCharConfig<T | Writable<T>>,\n): PgCharBuilderInitial<'', Writable<T>>;\nexport function char<TName extends string, U extends string, T extends Readonly<[U, ...U[]]>>(\n\tname: TName,\n\tconfig?: PgCharConfig<T | Writable<T>>,\n): PgCharBuilderInitial<TName, Writable<T>>;\nexport function char(a?: string | PgCharConfig, b: PgCharConfig = {}): any {\n\tconst { name, config } = getColumnNameAndConfig<PgCharConfig>(a, b);\n\treturn new PgCharBuilder(name, config as any);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgCidrBuilderInitial<TName extends string> = PgCidrBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgCidr';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgCidrBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgCidr'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgCidrBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgCidr');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgCidr<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgCidr<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgCidr<T extends ColumnBaseConfig<'string', 'PgCidr'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgCidr';\n\n\tgetSQLType(): string {\n\t\treturn 'cidr';\n\t}\n}\n\nexport function cidr(): PgCidrBuilderInitial<''>;\nexport function cidr<TName extends string>(name: TName): PgCidrBuilderInitial<TName>;\nexport function cidr(name?: string) {\n\treturn new PgCidrBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport type { SQL } from '~/sql/sql.ts';\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type ConvertCustomConfig<TName extends string, T extends Partial<CustomTypeValues>> =\n\t& {\n\t\tname: TName;\n\t\tdataType: 'custom';\n\t\tcolumnType: 'PgCustomColumn';\n\t\tdata: T['data'];\n\t\tdriverParam: T['driverData'];\n\t\tenumValues: undefined;\n\t}\n\t& (T['notNull'] extends true ? { notNull: true } : {})\n\t& (T['default'] extends true ? { hasDefault: true } : {});\n\nexport interface PgCustomColumnInnerConfig {\n\tcustomTypeValues: CustomTypeValues;\n}\n\nexport class PgCustomColumnBuilder<T extends ColumnBuilderBaseConfig<'custom', 'PgCustomColumn'>>\n\textends PgColumnBuilder<\n\t\tT,\n\t\t{\n\t\t\tfieldConfig: CustomTypeValues['config'];\n\t\t\tcustomTypeParams: CustomTypeParams<any>;\n\t\t},\n\t\t{\n\t\t\tpgColumnBuilderBrand: 'PgCustomColumnBuilderBrand';\n\t\t}\n\t>\n{\n\tstatic override readonly [entityKind]: string = 'PgCustomColumnBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\tfieldConfig: CustomTypeValues['config'],\n\t\tcustomTypeParams: CustomTypeParams<any>,\n\t) {\n\t\tsuper(name, 'custom', 'PgCustomColumn');\n\t\tthis.config.fieldConfig = fieldConfig;\n\t\tthis.config.customTypeParams = customTypeParams;\n\t}\n\n\t/** @internal */\n\tbuild<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgCustomColumn<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgCustomColumn<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgCustomColumn<T extends ColumnBaseConfig<'custom', 'PgCustomColumn'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgCustomColumn';\n\n\tprivate sqlName: string;\n\tprivate mapTo?: (value: T['data']) => T['driverParam'];\n\tprivate mapFrom?: (value: T['driverParam']) => T['data'];\n\n\tconstructor(\n\t\ttable: AnyPgTable<{ name: T['tableName'] }>,\n\t\tconfig: PgCustomColumnBuilder<T>['config'],\n\t) {\n\t\tsuper(table, config);\n\t\tthis.sqlName = config.customTypeParams.dataType(config.fieldConfig);\n\t\tthis.mapTo = config.customTypeParams.toDriver;\n\t\tthis.mapFrom = config.customTypeParams.fromDriver;\n\t}\n\n\tgetSQLType(): string {\n\t\treturn this.sqlName;\n\t}\n\n\toverride mapFromDriverValue(value: T['driverParam']): T['data'] {\n\t\treturn typeof this.mapFrom === 'function' ? this.mapFrom(value) : value as T['data'];\n\t}\n\n\toverride mapToDriverValue(value: T['data']): T['driverParam'] {\n\t\treturn typeof this.mapTo === 'function' ? this.mapTo(value) : value as T['data'];\n\t}\n}\n\nexport type CustomTypeValues = {\n\t/**\n\t * Required type for custom column, that will infer proper type model\n\t *\n\t * Examples:\n\t *\n\t * If you want your column to be `string` type after selecting/or on inserting - use `data: string`. Like `text`, `varchar`\n\t *\n\t * If you want your column to be `number` type after selecting/or on inserting - use `data: number`. Like `integer`\n\t */\n\tdata: unknown;\n\n\t/**\n\t * Type helper, that represents what type database driver is accepting for specific database data type\n\t */\n\tdriverData?: unknown;\n\n\t/**\n\t * What config type should be used for {@link CustomTypeParams} `dataType` generation\n\t */\n\tconfig?: Record<string, any>;\n\n\t/**\n\t * Whether the config argument should be required or not\n\t * @default false\n\t */\n\tconfigRequired?: boolean;\n\n\t/**\n\t * If your custom data type should be notNull by default you can use `notNull: true`\n\t *\n\t * @example\n\t * const customSerial = customType<{ data: number, notNull: true, default: true }>({\n\t * \t  dataType() {\n\t * \t    return 'serial';\n\t *    },\n\t * });\n\t */\n\tnotNull?: boolean;\n\n\t/**\n\t * If your custom data type has default you can use `default: true`\n\t *\n\t * @example\n\t * const customSerial = customType<{ data: number, notNull: true, default: true }>({\n\t * \t  dataType() {\n\t * \t    return 'serial';\n\t *    },\n\t * });\n\t */\n\tdefault?: boolean;\n};\n\nexport interface CustomTypeParams<T extends CustomTypeValues> {\n\t/**\n\t * Database data type string representation, that is used for migrations\n\t * @example\n\t * ```\n\t * `jsonb`, `text`\n\t * ```\n\t *\n\t * If database data type needs additional params you can use them from `config` param\n\t * @example\n\t * ```\n\t * `varchar(256)`, `numeric(2,3)`\n\t * ```\n\t *\n\t * To make `config` be of specific type please use config generic in {@link CustomTypeValues}\n\t *\n\t * @example\n\t * Usage example\n\t * ```\n\t *   dataType() {\n\t *     return 'boolean';\n\t *   },\n\t * ```\n\t * Or\n\t * ```\n\t *   dataType(config) {\n\t * \t   return typeof config.length !== 'undefined' ? `varchar(${config.length})` : `varchar`;\n\t * \t }\n\t * ```\n\t */\n\tdataType: (config: T['config'] | (Equal<T['configRequired'], true> extends true ? never : undefined)) => string;\n\n\t/**\n\t * Optional mapping function, between user input and driver\n\t * @example\n\t * For example, when using jsonb we need to map JS/TS object to string before writing to database\n\t * ```\n\t * toDriver(value: TData): string {\n\t * \t return JSON.stringify(value);\n\t * }\n\t * ```\n\t */\n\ttoDriver?: (value: T['data']) => T['driverData'] | SQL;\n\n\t/**\n\t * Optional mapping function, that is responsible for data mapping from database to JS/TS code\n\t * @example\n\t * For example, when using timestamp we need to map string Date representation to JS Date\n\t * ```\n\t * fromDriver(value: string): Date {\n\t * \treturn new Date(value);\n\t * },\n\t * ```\n\t */\n\tfromDriver?: (value: T['driverData']) => T['data'];\n}\n\n/**\n * Custom pg database data type generator\n */\nexport function customType<T extends CustomTypeValues = CustomTypeValues>(\n\tcustomTypeParams: CustomTypeParams<T>,\n): Equal<T['configRequired'], true> extends true ? {\n\t\t<TConfig extends Record<string, any> & T['config']>(\n\t\t\tfieldConfig: TConfig,\n\t\t): PgCustomColumnBuilder<ConvertCustomConfig<'', T>>;\n\t\t<TName extends string>(\n\t\t\tdbName: TName,\n\t\t\tfieldConfig: T['config'],\n\t\t): PgCustomColumnBuilder<ConvertCustomConfig<TName, T>>;\n\t}\n\t: {\n\t\t(): PgCustomColumnBuilder<ConvertCustomConfig<'', T>>;\n\t\t<TConfig extends Record<string, any> & T['config']>(\n\t\t\tfieldConfig?: TConfig,\n\t\t): PgCustomColumnBuilder<ConvertCustomConfig<'', T>>;\n\t\t<TName extends string>(\n\t\t\tdbName: TName,\n\t\t\tfieldConfig?: T['config'],\n\t\t): PgCustomColumnBuilder<ConvertCustomConfig<TName, T>>;\n\t}\n{\n\treturn <TName extends string>(\n\t\ta?: TName | T['config'],\n\t\tb?: T['config'],\n\t): PgCustomColumnBuilder<ConvertCustomConfig<TName, T>> => {\n\t\tconst { name, config } = getColumnNameAndConfig<T['config']>(a, b);\n\t\treturn new PgCustomColumnBuilder(name as ConvertCustomConfig<TName, T>['name'], config, customTypeParams);\n\t};\n}\n","import type { ColumnBuilderBaseConfig, ColumnDataType } from '~/column-builder.ts';\nimport { entityKind } from '~/entity.ts';\nimport { sql } from '~/sql/sql.ts';\nimport { PgColumnBuilder } from './common.ts';\n\nexport abstract class PgDateColumnBaseBuilder<\n\tT extends ColumnBuilderBaseConfig<ColumnDataType, string>,\n\tTRuntimeConfig extends object = object,\n> extends PgColumnBuilder<T, TRuntimeConfig> {\n\tstatic override readonly [entityKind]: string = 'PgDateColumnBaseBuilder';\n\n\tdefaultNow() {\n\t\treturn this.default(sql`now()`);\n\t}\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn } from './common.ts';\nimport { PgDateColumnBaseBuilder } from './date.common.ts';\n\nexport type PgDateBuilderInitial<TName extends string> = PgDateBuilder<{\n\tname: TName;\n\tdataType: 'date';\n\tcolumnType: 'PgDate';\n\tdata: Date;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgDateBuilder<T extends ColumnBuilderBaseConfig<'date', 'PgDate'>> extends PgDateColumnBaseBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgDateBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'date', 'PgDate');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgDate<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgDate<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgDate<T extends ColumnBaseConfig<'date', 'PgDate'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgDate';\n\n\tgetSQLType(): string {\n\t\treturn 'date';\n\t}\n\n\toverride mapFromDriverValue(value: string): Date {\n\t\treturn new Date(value);\n\t}\n\n\toverride mapToDriverValue(value: Date): string {\n\t\treturn value.toISOString();\n\t}\n}\n\nexport type PgDateStringBuilderInitial<TName extends string> = PgDateStringBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgDateString';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgDateStringBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgDateString'>>\n\textends PgDateColumnBaseBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgDateStringBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgDateString');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgDateString<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgDateString<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgDateString<T extends ColumnBaseConfig<'string', 'PgDateString'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgDateString';\n\n\tgetSQLType(): string {\n\t\treturn 'date';\n\t}\n}\n\nexport interface PgDateConfig<T extends 'date' | 'string' = 'date' | 'string'> {\n\tmode: T;\n}\n\nexport function date(): PgDateStringBuilderInitial<''>;\nexport function date<TMode extends PgDateConfig['mode'] & {}>(\n\tconfig?: PgDateConfig<TMode>,\n): Equal<TMode, 'date'> extends true ? PgDateBuilderInitial<''> : PgDateStringBuilderInitial<''>;\nexport function date<TName extends string, TMode extends PgDateConfig['mode'] & {}>(\n\tname: TName,\n\tconfig?: PgDateConfig<TMode>,\n): Equal<TMode, 'date'> extends true ? PgDateBuilderInitial<TName> : PgDateStringBuilderInitial<TName>;\nexport function date(a?: string | PgDateConfig, b?: PgDateConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgDateConfig>(a, b);\n\tif (config?.mode === 'date') {\n\t\treturn new PgDateBuilder(name);\n\t}\n\treturn new PgDateStringBuilder(name);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgDoublePrecisionBuilderInitial<TName extends string> = PgDoublePrecisionBuilder<{\n\tname: TName;\n\tdataType: 'number';\n\tcolumnType: 'PgDoublePrecision';\n\tdata: number;\n\tdriverParam: string | number;\n\tenumValues: undefined;\n}>;\n\nexport class PgDoublePrecisionBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgDoublePrecision'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgDoublePrecisionBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgDoublePrecision');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgDoublePrecision<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgDoublePrecision<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgDoublePrecision<T extends ColumnBaseConfig<'number', 'PgDoublePrecision'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgDoublePrecision';\n\n\tgetSQLType(): string {\n\t\treturn 'double precision';\n\t}\n\n\toverride mapFromDriverValue(value: string | number): number {\n\t\tif (typeof value === 'string') {\n\t\t\treturn Number.parseFloat(value);\n\t\t}\n\t\treturn value;\n\t}\n}\n\nexport function doublePrecision(): PgDoublePrecisionBuilderInitial<''>;\nexport function doublePrecision<TName extends string>(name: TName): PgDoublePrecisionBuilderInitial<TName>;\nexport function doublePrecision(name?: string) {\n\treturn new PgDoublePrecisionBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgInetBuilderInitial<TName extends string> = PgInetBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgInet';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgInetBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgInet'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgInetBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgInet');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgInet<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgInet<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgInet<T extends ColumnBaseConfig<'string', 'PgInet'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgInet';\n\n\tgetSQLType(): string {\n\t\treturn 'inet';\n\t}\n}\n\nexport function inet(): PgInetBuilderInitial<''>;\nexport function inet<TName extends string>(name: TName): PgInetBuilderInitial<TName>;\nexport function inet(name?: string) {\n\treturn new PgInetBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn } from './common.ts';\nimport { PgIntColumnBaseBuilder } from './int.common.ts';\n\nexport type PgIntegerBuilderInitial<TName extends string> = PgIntegerBuilder<{\n\tname: TName;\n\tdataType: 'number';\n\tcolumnType: 'PgInteger';\n\tdata: number;\n\tdriverParam: number | string;\n\tenumValues: undefined;\n}>;\n\nexport class PgIntegerBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgInteger'>>\n\textends PgIntColumnBaseBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgIntegerBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgInteger');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgInteger<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgInteger<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgInteger<T extends ColumnBaseConfig<'number', 'PgInteger'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgInteger';\n\n\tgetSQLType(): string {\n\t\treturn 'integer';\n\t}\n\n\toverride mapFromDriverValue(value: number | string): number {\n\t\tif (typeof value === 'string') {\n\t\t\treturn Number.parseInt(value);\n\t\t}\n\t\treturn value;\n\t}\n}\n\nexport function integer(): PgIntegerBuilderInitial<''>;\nexport function integer<TName extends string>(name: TName): PgIntegerBuilderInitial<TName>;\nexport function integer(name?: string) {\n\treturn new PgIntegerBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\nimport type { Precision } from './timestamp.ts';\n\nexport type PgIntervalBuilderInitial<TName extends string> = PgIntervalBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgInterval';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgIntervalBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgInterval'>>\n\textends PgColumnBuilder<T, { intervalConfig: IntervalConfig }>\n{\n\tstatic override readonly [entityKind]: string = 'PgIntervalBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\tintervalConfig: IntervalConfig,\n\t) {\n\t\tsuper(name, 'string', 'PgInterval');\n\t\tthis.config.intervalConfig = intervalConfig;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgInterval<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgInterval<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgInterval<T extends ColumnBaseConfig<'string', 'PgInterval'>>\n\textends PgColumn<T, { intervalConfig: IntervalConfig }>\n{\n\tstatic override readonly [entityKind]: string = 'PgInterval';\n\n\treadonly fields: IntervalConfig['fields'] = this.config.intervalConfig.fields;\n\treadonly precision: IntervalConfig['precision'] = this.config.intervalConfig.precision;\n\n\tgetSQLType(): string {\n\t\tconst fields = this.fields ? ` ${this.fields}` : '';\n\t\tconst precision = this.precision ? `(${this.precision})` : '';\n\t\treturn `interval${fields}${precision}`;\n\t}\n}\n\nexport interface IntervalConfig {\n\tfields?:\n\t\t| 'year'\n\t\t| 'month'\n\t\t| 'day'\n\t\t| 'hour'\n\t\t| 'minute'\n\t\t| 'second'\n\t\t| 'year to month'\n\t\t| 'day to hour'\n\t\t| 'day to minute'\n\t\t| 'day to second'\n\t\t| 'hour to minute'\n\t\t| 'hour to second'\n\t\t| 'minute to second';\n\tprecision?: Precision;\n}\n\nexport function interval(): PgIntervalBuilderInitial<''>;\nexport function interval(\n\tconfig?: IntervalConfig,\n): PgIntervalBuilderInitial<''>;\nexport function interval<TName extends string>(\n\tname: TName,\n\tconfig?: IntervalConfig,\n): PgIntervalBuilderInitial<TName>;\nexport function interval(a?: string | IntervalConfig, b: IntervalConfig = {}) {\n\tconst { name, config } = getColumnNameAndConfig<IntervalConfig>(a, b);\n\treturn new PgIntervalBuilder(name, config);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgJsonBuilderInitial<TName extends string> = PgJsonBuilder<{\n\tname: TName;\n\tdataType: 'json';\n\tcolumnType: 'PgJson';\n\tdata: unknown;\n\tdriverParam: unknown;\n\tenumValues: undefined;\n}>;\n\nexport class PgJsonBuilder<T extends ColumnBuilderBaseConfig<'json', 'PgJson'>> extends PgColumnBuilder<\n\tT\n> {\n\tstatic override readonly [entityKind]: string = 'PgJsonBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'json', 'PgJson');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgJson<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgJson<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgJson<T extends ColumnBaseConfig<'json', 'PgJson'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgJson';\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgJsonBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t}\n\n\tgetSQLType(): string {\n\t\treturn 'json';\n\t}\n\n\toverride mapToDriverValue(value: T['data']): string {\n\t\treturn JSON.stringify(value);\n\t}\n\n\toverride mapFromDriverValue(value: T['data'] | string): T['data'] {\n\t\tif (typeof value === 'string') {\n\t\t\ttry {\n\t\t\t\treturn JSON.parse(value);\n\t\t\t} catch {\n\t\t\t\treturn value as T['data'];\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t}\n}\n\nexport function json(): PgJsonBuilderInitial<''>;\nexport function json<TName extends string>(name: TName): PgJsonBuilderInitial<TName>;\nexport function json(name?: string) {\n\treturn new PgJsonBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgJsonbBuilderInitial<TName extends string> = PgJsonbBuilder<{\n\tname: TName;\n\tdataType: 'json';\n\tcolumnType: 'PgJsonb';\n\tdata: unknown;\n\tdriverParam: unknown;\n\tenumValues: undefined;\n}>;\n\nexport class PgJsonbBuilder<T extends ColumnBuilderBaseConfig<'json', 'PgJsonb'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgJsonbBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'json', 'PgJsonb');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgJsonb<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgJsonb<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgJsonb<T extends ColumnBaseConfig<'json', 'PgJsonb'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgJsonb';\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgJsonbBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t}\n\n\tgetSQLType(): string {\n\t\treturn 'jsonb';\n\t}\n\n\toverride mapToDriverValue(value: T['data']): string {\n\t\treturn JSON.stringify(value);\n\t}\n\n\toverride mapFromDriverValue(value: T['data'] | string): T['data'] {\n\t\tif (typeof value === 'string') {\n\t\t\ttry {\n\t\t\t\treturn JSON.parse(value);\n\t\t\t} catch {\n\t\t\t\treturn value as T['data'];\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t}\n}\n\nexport function jsonb(): PgJsonbBuilderInitial<''>;\nexport function jsonb<TName extends string>(name: TName): PgJsonbBuilderInitial<TName>;\nexport function jsonb(name?: string) {\n\treturn new PgJsonbBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\n\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgLineBuilderInitial<TName extends string> = PgLineBuilder<{\n\tname: TName;\n\tdataType: 'array';\n\tcolumnType: 'PgLine';\n\tdata: [number, number, number];\n\tdriverParam: number | string;\n\tenumValues: undefined;\n}>;\n\nexport class PgLineBuilder<T extends ColumnBuilderBaseConfig<'array', 'PgLine'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgLineBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'array', 'PgLine');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgLineTuple<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgLineTuple<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgLineTuple<T extends ColumnBaseConfig<'array', 'PgLine'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgLine';\n\n\tgetSQLType(): string {\n\t\treturn 'line';\n\t}\n\n\toverride mapFromDriverValue(value: string): [number, number, number] {\n\t\tconst [a, b, c] = value.slice(1, -1).split(',');\n\t\treturn [Number.parseFloat(a!), Number.parseFloat(b!), Number.parseFloat(c!)];\n\t}\n\n\toverride mapToDriverValue(value: [number, number, number]): string {\n\t\treturn `{${value[0]},${value[1]},${value[2]}}`;\n\t}\n}\n\nexport type PgLineABCBuilderInitial<TName extends string> = PgLineABCBuilder<{\n\tname: TName;\n\tdataType: 'json';\n\tcolumnType: 'PgLineABC';\n\tdata: { a: number; b: number; c: number };\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgLineABCBuilder<T extends ColumnBuilderBaseConfig<'json', 'PgLineABC'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgLineABCBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'json', 'PgLineABC');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgLineABC<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgLineABC<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgLineABC<T extends ColumnBaseConfig<'json', 'PgLineABC'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgLineABC';\n\n\tgetSQLType(): string {\n\t\treturn 'line';\n\t}\n\n\toverride mapFromDriverValue(value: string): { a: number; b: number; c: number } {\n\t\tconst [a, b, c] = value.slice(1, -1).split(',');\n\t\treturn { a: Number.parseFloat(a!), b: Number.parseFloat(b!), c: Number.parseFloat(c!) };\n\t}\n\n\toverride mapToDriverValue(value: { a: number; b: number; c: number }): string {\n\t\treturn `{${value.a},${value.b},${value.c}}`;\n\t}\n}\n\nexport interface PgLineTypeConfig<T extends 'tuple' | 'abc' = 'tuple' | 'abc'> {\n\tmode?: T;\n}\n\nexport function line(): PgLineBuilderInitial<''>;\nexport function line<TMode extends PgLineTypeConfig['mode'] & {}>(\n\tconfig?: PgLineTypeConfig<TMode>,\n): Equal<TMode, 'abc'> extends true ? PgLineABCBuilderInitial<''>\n\t: PgLineBuilderInitial<''>;\nexport function line<TName extends string, TMode extends PgLineTypeConfig['mode'] & {}>(\n\tname: TName,\n\tconfig?: PgLineTypeConfig<TMode>,\n): Equal<TMode, 'abc'> extends true ? PgLineABCBuilderInitial<TName>\n\t: PgLineBuilderInitial<TName>;\nexport function line(a?: string | PgLineTypeConfig, b?: PgLineTypeConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgLineTypeConfig>(a, b);\n\tif (!config?.mode || config.mode === 'tuple') {\n\t\treturn new PgLineBuilder(name);\n\t}\n\treturn new PgLineABCBuilder(name);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgMacaddrBuilderInitial<TName extends string> = PgMacaddrBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgMacaddr';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgMacaddrBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgMacaddr'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgMacaddrBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgMacaddr');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgMacaddr<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgMacaddr<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgMacaddr<T extends ColumnBaseConfig<'string', 'PgMacaddr'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgMacaddr';\n\n\tgetSQLType(): string {\n\t\treturn 'macaddr';\n\t}\n}\n\nexport function macaddr(): PgMacaddrBuilderInitial<''>;\nexport function macaddr<TName extends string>(name: TName): PgMacaddrBuilderInitial<TName>;\nexport function macaddr(name?: string) {\n\treturn new PgMacaddrBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '../table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgMacaddr8BuilderInitial<TName extends string> = PgMacaddr8Builder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgMacaddr8';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgMacaddr8Builder<T extends ColumnBuilderBaseConfig<'string', 'PgMacaddr8'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgMacaddr8Builder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgMacaddr8');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgMacaddr8<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgMacaddr8<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgMacaddr8<T extends ColumnBaseConfig<'string', 'PgMacaddr8'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgMacaddr8';\n\n\tgetSQLType(): string {\n\t\treturn 'macaddr8';\n\t}\n}\n\nexport function macaddr8(): PgMacaddr8BuilderInitial<''>;\nexport function macaddr8<TName extends string>(name: TName): PgMacaddr8BuilderInitial<TName>;\nexport function macaddr8(name?: string) {\n\treturn new PgMacaddr8Builder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgNumericBuilderInitial<TName extends string> = PgNumericBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgNumeric';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgNumericBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgNumeric'>> extends PgColumnBuilder<\n\tT,\n\t{\n\t\tprecision: number | undefined;\n\t\tscale: number | undefined;\n\t}\n> {\n\tstatic override readonly [entityKind]: string = 'PgNumericBuilder';\n\n\tconstructor(name: T['name'], precision?: number, scale?: number) {\n\t\tsuper(name, 'string', 'PgNumeric');\n\t\tthis.config.precision = precision;\n\t\tthis.config.scale = scale;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgNumeric<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgNumeric<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgNumeric<T extends ColumnBaseConfig<'string', 'PgNumeric'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgNumeric';\n\n\treadonly precision: number | undefined;\n\treadonly scale: number | undefined;\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgNumericBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t\tthis.precision = config.precision;\n\t\tthis.scale = config.scale;\n\t}\n\n\tgetSQLType(): string {\n\t\tif (this.precision !== undefined && this.scale !== undefined) {\n\t\t\treturn `numeric(${this.precision}, ${this.scale})`;\n\t\t} else if (this.precision === undefined) {\n\t\t\treturn 'numeric';\n\t\t} else {\n\t\t\treturn `numeric(${this.precision})`;\n\t\t}\n\t}\n}\n\nexport type PgNumericConfig =\n\t| { precision: number; scale?: number }\n\t| { precision?: number; scale: number }\n\t| { precision: number; scale: number };\n\nexport function numeric(): PgNumericBuilderInitial<''>;\nexport function numeric(\n\tconfig?: PgNumericConfig,\n): PgNumericBuilderInitial<''>;\nexport function numeric<TName extends string>(\n\tname: TName,\n\tconfig?: PgNumericConfig,\n): PgNumericBuilderInitial<TName>;\nexport function numeric(a?: string | PgNumericConfig, b?: PgNumericConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgNumericConfig>(a, b);\n\treturn new PgNumericBuilder(name, config?.precision, config?.scale);\n}\n\nexport const decimal = numeric;\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\n\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgPointTupleBuilderInitial<TName extends string> = PgPointTupleBuilder<{\n\tname: TName;\n\tdataType: 'array';\n\tcolumnType: 'PgPointTuple';\n\tdata: [number, number];\n\tdriverParam: number | string;\n\tenumValues: undefined;\n}>;\n\nexport class PgPointTupleBuilder<T extends ColumnBuilderBaseConfig<'array', 'PgPointTuple'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgPointTupleBuilder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'array', 'PgPointTuple');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgPointTuple<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgPointTuple<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgPointTuple<T extends ColumnBaseConfig<'array', 'PgPointTuple'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgPointTuple';\n\n\tgetSQLType(): string {\n\t\treturn 'point';\n\t}\n\n\toverride mapFromDriverValue(value: string | { x: number; y: number }): [number, number] {\n\t\tif (typeof value === 'string') {\n\t\t\tconst [x, y] = value.slice(1, -1).split(',');\n\t\t\treturn [Number.parseFloat(x!), Number.parseFloat(y!)];\n\t\t}\n\t\treturn [value.x, value.y];\n\t}\n\n\toverride mapToDriverValue(value: [number, number]): string {\n\t\treturn `(${value[0]},${value[1]})`;\n\t}\n}\n\nexport type PgPointObjectBuilderInitial<TName extends string> = PgPointObjectBuilder<{\n\tname: TName;\n\tdataType: 'json';\n\tcolumnType: 'PgPointObject';\n\tdata: { x: number; y: number };\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgPointObjectBuilder<T extends ColumnBuilderBaseConfig<'json', 'PgPointObject'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgPointObjectBuilder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'json', 'PgPointObject');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgPointObject<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgPointObject<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgPointObject<T extends ColumnBaseConfig<'json', 'PgPointObject'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgPointObject';\n\n\tgetSQLType(): string {\n\t\treturn 'point';\n\t}\n\n\toverride mapFromDriverValue(value: string | { x: number; y: number }): { x: number; y: number } {\n\t\tif (typeof value === 'string') {\n\t\t\tconst [x, y] = value.slice(1, -1).split(',');\n\t\t\treturn { x: Number.parseFloat(x!), y: Number.parseFloat(y!) };\n\t\t}\n\t\treturn value;\n\t}\n\n\toverride mapToDriverValue(value: { x: number; y: number }): string {\n\t\treturn `(${value.x},${value.y})`;\n\t}\n}\n\nexport interface PgPointConfig<T extends 'tuple' | 'xy' = 'tuple' | 'xy'> {\n\tmode?: T;\n}\n\nexport function point(): PgPointTupleBuilderInitial<''>;\nexport function point<TMode extends PgPointConfig['mode'] & {}>(\n\tconfig?: PgPointConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? PgPointObjectBuilderInitial<''>\n\t: PgPointTupleBuilderInitial<''>;\nexport function point<TName extends string, TMode extends PgPointConfig['mode'] & {}>(\n\tname: TName,\n\tconfig?: PgPointConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? PgPointObjectBuilderInitial<TName>\n\t: PgPointTupleBuilderInitial<TName>;\nexport function point(a?: string | PgPointConfig, b?: PgPointConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgPointConfig>(a, b);\n\tif (!config?.mode || config.mode === 'tuple') {\n\t\treturn new PgPointTupleBuilder(name);\n\t}\n\treturn new PgPointObjectBuilder(name);\n}\n","function hexToBytes(hex: string): Uint8Array {\n\tconst bytes: number[] = [];\n\tfor (let c = 0; c < hex.length; c += 2) {\n\t\tbytes.push(Number.parseInt(hex.slice(c, c + 2), 16));\n\t}\n\treturn new Uint8Array(bytes);\n}\n\nfunction bytesToFloat64(bytes: Uint8Array, offset: number): number {\n\tconst buffer = new ArrayBuffer(8);\n\tconst view = new DataView(buffer);\n\tfor (let i = 0; i < 8; i++) {\n\t\tview.setUint8(i, bytes[offset + i]!);\n\t}\n\treturn view.getFloat64(0, true);\n}\n\nexport function parseEWKB(hex: string): [number, number] {\n\tconst bytes = hexToBytes(hex);\n\n\tlet offset = 0;\n\n\t// Byte order: 1 is little-endian, 0 is big-endian\n\tconst byteOrder = bytes[offset];\n\toffset += 1;\n\n\tconst view = new DataView(bytes.buffer);\n\tconst geomType = view.getUint32(offset, byteOrder === 1);\n\toffset += 4;\n\n\tlet _srid: number | undefined;\n\tif (geomType & 0x20000000) { // SRID flag\n\t\t_srid = view.getUint32(offset, byteOrder === 1);\n\t\toffset += 4;\n\t}\n\n\tif ((geomType & 0xFFFF) === 1) {\n\t\tconst x = bytesToFloat64(bytes, offset);\n\t\toffset += 8;\n\t\tconst y = bytesToFloat64(bytes, offset);\n\t\toffset += 8;\n\n\t\treturn [x, y];\n\t}\n\n\tthrow new Error('Unsupported geometry type');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\n\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from '../common.ts';\nimport { parseEWKB } from './utils.ts';\n\nexport type PgGeometryBuilderInitial<TName extends string> = PgGeometryBuilder<{\n\tname: TName;\n\tdataType: 'array';\n\tcolumnType: 'PgGeometry';\n\tdata: [number, number];\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgGeometryBuilder<T extends ColumnBuilderBaseConfig<'array', 'PgGeometry'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgGeometryBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'array', 'PgGeometry');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgGeometry<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgGeometry<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgGeometry<T extends ColumnBaseConfig<'array', 'PgGeometry'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgGeometry';\n\n\tgetSQLType(): string {\n\t\treturn 'geometry(point)';\n\t}\n\n\toverride mapFromDriverValue(value: string): [number, number] {\n\t\treturn parseEWKB(value);\n\t}\n\n\toverride mapToDriverValue(value: [number, number]): string {\n\t\treturn `point(${value[0]} ${value[1]})`;\n\t}\n}\n\nexport type PgGeometryObjectBuilderInitial<TName extends string> = PgGeometryObjectBuilder<{\n\tname: TName;\n\tdataType: 'json';\n\tcolumnType: 'PgGeometryObject';\n\tdata: { x: number; y: number };\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgGeometryObjectBuilder<T extends ColumnBuilderBaseConfig<'json', 'PgGeometryObject'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgGeometryObjectBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'json', 'PgGeometryObject');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgGeometryObject<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgGeometryObject<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgGeometryObject<T extends ColumnBaseConfig<'json', 'PgGeometryObject'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgGeometryObject';\n\n\tgetSQLType(): string {\n\t\treturn 'geometry(point)';\n\t}\n\n\toverride mapFromDriverValue(value: string): { x: number; y: number } {\n\t\tconst parsed = parseEWKB(value);\n\t\treturn { x: parsed[0], y: parsed[1] };\n\t}\n\n\toverride mapToDriverValue(value: { x: number; y: number }): string {\n\t\treturn `point(${value.x} ${value.y})`;\n\t}\n}\n\nexport interface PgGeometryConfig<T extends 'tuple' | 'xy' = 'tuple' | 'xy'> {\n\tmode?: T;\n\ttype?: 'point' | (string & {});\n\tsrid?: number;\n}\n\nexport function geometry(): PgGeometryBuilderInitial<''>;\nexport function geometry<TMode extends PgGeometryConfig['mode'] & {}>(\n\tconfig?: PgGeometryConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? PgGeometryObjectBuilderInitial<''> : PgGeometryBuilderInitial<''>;\nexport function geometry<TName extends string, TMode extends PgGeometryConfig['mode'] & {}>(\n\tname: TName,\n\tconfig?: PgGeometryConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? PgGeometryObjectBuilderInitial<TName> : PgGeometryBuilderInitial<TName>;\nexport function geometry(a?: string | PgGeometryConfig, b?: PgGeometryConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgGeometryConfig>(a, b);\n\tif (!config?.mode || config.mode === 'tuple') {\n\t\treturn new PgGeometryBuilder(name);\n\t}\n\treturn new PgGeometryObjectBuilder(name);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgRealBuilderInitial<TName extends string> = PgRealBuilder<{\n\tname: TName;\n\tdataType: 'number';\n\tcolumnType: 'PgReal';\n\tdata: number;\n\tdriverParam: string | number;\n\tenumValues: undefined;\n}>;\n\nexport class PgRealBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgReal'>> extends PgColumnBuilder<\n\tT,\n\t{ length: number | undefined }\n> {\n\tstatic override readonly [entityKind]: string = 'PgRealBuilder';\n\n\tconstructor(name: T['name'], length?: number) {\n\t\tsuper(name, 'number', 'PgReal');\n\t\tthis.config.length = length;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgReal<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgReal<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgReal<T extends ColumnBaseConfig<'number', 'PgReal'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgReal';\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgRealBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t}\n\n\tgetSQLType(): string {\n\t\treturn 'real';\n\t}\n\n\toverride mapFromDriverValue = (value: string | number): number => {\n\t\tif (typeof value === 'string') {\n\t\t\treturn Number.parseFloat(value);\n\t\t}\n\t\treturn value;\n\t};\n}\n\nexport function real(): PgRealBuilderInitial<''>;\nexport function real<TName extends string>(name: TName): PgRealBuilderInitial<TName>;\nexport function real(name?: string) {\n\treturn new PgRealBuilder(name ?? '');\n}\n","import type {\n\tColumnBuilderBaseConfig,\n\tColumnBuilderRuntimeConfig,\n\tHasDefault,\n\tMakeColumnConfig,\n\tNotNull,\n} from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgSerialBuilderInitial<TName extends string> = NotNull<\n\tHasDefault<\n\t\tPgSerialBuilder<{\n\t\t\tname: TName;\n\t\t\tdataType: 'number';\n\t\t\tcolumnType: 'PgSerial';\n\t\t\tdata: number;\n\t\t\tdriverParam: number;\n\t\t\tenumValues: undefined;\n\t\t}>\n\t>\n>;\n\nexport class PgSerialBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgSerial'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgSerialBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgSerial');\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgSerial<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgSerial<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgSerial<T extends ColumnBaseConfig<'number', 'PgSerial'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgSerial';\n\n\tgetSQLType(): string {\n\t\treturn 'serial';\n\t}\n}\n\nexport function serial(): PgSerialBuilderInitial<''>;\nexport function serial<TName extends string>(name: TName): PgSerialBuilderInitial<TName>;\nexport function serial(name?: string) {\n\treturn new PgSerialBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn } from './common.ts';\nimport { PgIntColumnBaseBuilder } from './int.common.ts';\n\nexport type PgSmallIntBuilderInitial<TName extends string> = PgSmallIntBuilder<{\n\tname: TName;\n\tdataType: 'number';\n\tcolumnType: 'PgSmallInt';\n\tdata: number;\n\tdriverParam: number | string;\n\tenumValues: undefined;\n}>;\n\nexport class PgSmallIntBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgSmallInt'>>\n\textends PgIntColumnBaseBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgSmallIntBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgSmallInt');\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgSmallInt<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgSmallInt<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgSmallInt<T extends ColumnBaseConfig<'number', 'PgSmallInt'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgSmallInt';\n\n\tgetSQLType(): string {\n\t\treturn 'smallint';\n\t}\n\n\toverride mapFromDriverValue = (value: number | string): number => {\n\t\tif (typeof value === 'string') {\n\t\t\treturn Number(value);\n\t\t}\n\t\treturn value;\n\t};\n}\n\nexport function smallint(): PgSmallIntBuilderInitial<''>;\nexport function smallint<TName extends string>(name: TName): PgSmallIntBuilderInitial<TName>;\nexport function smallint(name?: string) {\n\treturn new PgSmallIntBuilder(name ?? '');\n}\n","import type {\n\tColumnBuilderBaseConfig,\n\tColumnBuilderRuntimeConfig,\n\tHasDefault,\n\tMakeColumnConfig,\n\tNotNull,\n} from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgSmallSerialBuilderInitial<TName extends string> = NotNull<\n\tHasDefault<\n\t\tPgSmallSerialBuilder<{\n\t\t\tname: TName;\n\t\t\tdataType: 'number';\n\t\t\tcolumnType: 'PgSmallSerial';\n\t\t\tdata: number;\n\t\t\tdriverParam: number;\n\t\t\tenumValues: undefined;\n\t\t}>\n\t>\n>;\n\nexport class PgSmallSerialBuilder<T extends ColumnBuilderBaseConfig<'number', 'PgSmallSerial'>>\n\textends PgColumnBuilder<T>\n{\n\tstatic override readonly [entityKind]: string = 'PgSmallSerialBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'number', 'PgSmallSerial');\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgSmallSerial<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgSmallSerial<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgSmallSerial<T extends ColumnBaseConfig<'number', 'PgSmallSerial'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgSmallSerial';\n\n\tgetSQLType(): string {\n\t\treturn 'smallserial';\n\t}\n}\n\nexport function smallserial(): PgSmallSerialBuilderInitial<''>;\nexport function smallserial<TName extends string>(name: TName): PgSmallSerialBuilderInitial<TName>;\nexport function smallserial(name?: string) {\n\treturn new PgSmallSerialBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig, type Writable } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\ntype PgTextBuilderInitial<TName extends string, TEnum extends [string, ...string[]]> = PgTextBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgText';\n\tdata: TEnum[number];\n\tenumValues: TEnum;\n\tdriverParam: string;\n}>;\n\nexport class PgTextBuilder<\n\tT extends ColumnBuilderBaseConfig<'string', 'PgText'>,\n> extends PgColumnBuilder<T, { enumValues: T['enumValues'] }> {\n\tstatic override readonly [entityKind]: string = 'PgTextBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\tconfig: PgTextConfig<T['enumValues']>,\n\t) {\n\t\tsuper(name, 'string', 'PgText');\n\t\tthis.config.enumValues = config.enum;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgText<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgText<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgText<T extends ColumnBaseConfig<'string', 'PgText'>>\n\textends PgColumn<T, { enumValues: T['enumValues'] }>\n{\n\tstatic override readonly [entityKind]: string = 'PgText';\n\n\toverride readonly enumValues = this.config.enumValues;\n\n\tgetSQLType(): string {\n\t\treturn 'text';\n\t}\n}\n\nexport interface PgTextConfig<\n\tTEnum extends readonly string[] | string[] | undefined = readonly string[] | string[] | undefined,\n> {\n\tenum?: TEnum;\n}\n\nexport function text(): PgTextBuilderInitial<'', [string, ...string[]]>;\nexport function text<U extends string, T extends Readonly<[U, ...U[]]>>(\n\tconfig?: PgTextConfig<T | Writable<T>>,\n): PgTextBuilderInitial<'', Writable<T>>;\nexport function text<TName extends string, U extends string, T extends Readonly<[U, ...U[]]>>(\n\tname: TName,\n\tconfig?: PgTextConfig<T | Writable<T>>,\n): PgTextBuilderInitial<TName, Writable<T>>;\nexport function text(a?: string | PgTextConfig, b: PgTextConfig = {}): any {\n\tconst { name, config } = getColumnNameAndConfig<PgTextConfig>(a, b);\n\treturn new PgTextBuilder(name, config as any);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn } from './common.ts';\nimport { PgDateColumnBaseBuilder } from './date.common.ts';\nimport type { Precision } from './timestamp.ts';\n\nexport type PgTimeBuilderInitial<TName extends string> = PgTimeBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgTime';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgTimeBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgTime'>> extends PgDateColumnBaseBuilder<\n\tT,\n\t{ withTimezone: boolean; precision: number | undefined }\n> {\n\tstatic override readonly [entityKind]: string = 'PgTimeBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\treadonly withTimezone: boolean,\n\t\treadonly precision: number | undefined,\n\t) {\n\t\tsuper(name, 'string', 'PgTime');\n\t\tthis.config.withTimezone = withTimezone;\n\t\tthis.config.precision = precision;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgTime<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgTime<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgTime<T extends ColumnBaseConfig<'string', 'PgTime'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgTime';\n\n\treadonly withTimezone: boolean;\n\treadonly precision: number | undefined;\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgTimeBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t\tthis.withTimezone = config.withTimezone;\n\t\tthis.precision = config.precision;\n\t}\n\n\tgetSQLType(): string {\n\t\tconst precision = this.precision === undefined ? '' : `(${this.precision})`;\n\t\treturn `time${precision}${this.withTimezone ? ' with time zone' : ''}`;\n\t}\n}\n\nexport interface TimeConfig {\n\tprecision?: Precision;\n\twithTimezone?: boolean;\n}\n\nexport function time(): PgTimeBuilderInitial<''>;\nexport function time(config?: TimeConfig): PgTimeBuilderInitial<''>;\nexport function time<TName extends string>(name: TName, config?: TimeConfig): PgTimeBuilderInitial<TName>;\nexport function time(a?: string | TimeConfig, b: TimeConfig = {}) {\n\tconst { name, config } = getColumnNameAndConfig<TimeConfig>(a, b);\n\treturn new PgTimeBuilder(name, config.withTimezone ?? false, config.precision);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn } from './common.ts';\nimport { PgDateColumnBaseBuilder } from './date.common.ts';\n\nexport type PgTimestampBuilderInitial<TName extends string> = PgTimestampBuilder<{\n\tname: TName;\n\tdataType: 'date';\n\tcolumnType: 'PgTimestamp';\n\tdata: Date;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgTimestampBuilder<T extends ColumnBuilderBaseConfig<'date', 'PgTimestamp'>>\n\textends PgDateColumnBaseBuilder<\n\t\tT,\n\t\t{ withTimezone: boolean; precision: number | undefined }\n\t>\n{\n\tstatic override readonly [entityKind]: string = 'PgTimestampBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\twithTimezone: boolean,\n\t\tprecision: number | undefined,\n\t) {\n\t\tsuper(name, 'date', 'PgTimestamp');\n\t\tthis.config.withTimezone = withTimezone;\n\t\tthis.config.precision = precision;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgTimestamp<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgTimestamp<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgTimestamp<T extends ColumnBaseConfig<'date', 'PgTimestamp'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgTimestamp';\n\n\treadonly withTimezone: boolean;\n\treadonly precision: number | undefined;\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgTimestampBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t\tthis.withTimezone = config.withTimezone;\n\t\tthis.precision = config.precision;\n\t}\n\n\tgetSQLType(): string {\n\t\tconst precision = this.precision === undefined ? '' : ` (${this.precision})`;\n\t\treturn `timestamp${precision}${this.withTimezone ? ' with time zone' : ''}`;\n\t}\n\n\toverride mapFromDriverValue = (value: string): Date | null => {\n\t\treturn new Date(this.withTimezone ? value : value + '+0000');\n\t};\n\n\toverride mapToDriverValue = (value: Date): string => {\n\t\treturn value.toISOString();\n\t};\n}\n\nexport type PgTimestampStringBuilderInitial<TName extends string> = PgTimestampStringBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgTimestampString';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgTimestampStringBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgTimestampString'>>\n\textends PgDateColumnBaseBuilder<\n\t\tT,\n\t\t{ withTimezone: boolean; precision: number | undefined }\n\t>\n{\n\tstatic override readonly [entityKind]: string = 'PgTimestampStringBuilder';\n\n\tconstructor(\n\t\tname: T['name'],\n\t\twithTimezone: boolean,\n\t\tprecision: number | undefined,\n\t) {\n\t\tsuper(name, 'string', 'PgTimestampString');\n\t\tthis.config.withTimezone = withTimezone;\n\t\tthis.config.precision = precision;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgTimestampString<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgTimestampString<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgTimestampString<T extends ColumnBaseConfig<'string', 'PgTimestampString'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgTimestampString';\n\n\treadonly withTimezone: boolean;\n\treadonly precision: number | undefined;\n\n\tconstructor(table: AnyPgTable<{ name: T['tableName'] }>, config: PgTimestampStringBuilder<T>['config']) {\n\t\tsuper(table, config);\n\t\tthis.withTimezone = config.withTimezone;\n\t\tthis.precision = config.precision;\n\t}\n\n\tgetSQLType(): string {\n\t\tconst precision = this.precision === undefined ? '' : `(${this.precision})`;\n\t\treturn `timestamp${precision}${this.withTimezone ? ' with time zone' : ''}`;\n\t}\n}\n\nexport type Precision = 0 | 1 | 2 | 3 | 4 | 5 | 6;\n\nexport interface PgTimestampConfig<TMode extends 'date' | 'string' = 'date' | 'string'> {\n\tmode?: TMode;\n\tprecision?: Precision;\n\twithTimezone?: boolean;\n}\n\nexport function timestamp(): PgTimestampBuilderInitial<''>;\nexport function timestamp<TMode extends PgTimestampConfig['mode'] & {}>(\n\tconfig?: PgTimestampConfig<TMode>,\n): Equal<TMode, 'string'> extends true ? PgTimestampStringBuilderInitial<''> : PgTimestampBuilderInitial<''>;\nexport function timestamp<TName extends string, TMode extends PgTimestampConfig['mode'] & {}>(\n\tname: TName,\n\tconfig?: PgTimestampConfig<TMode>,\n): Equal<TMode, 'string'> extends true ? PgTimestampStringBuilderInitial<TName> : PgTimestampBuilderInitial<TName>;\nexport function timestamp(a?: string | PgTimestampConfig, b: PgTimestampConfig = {}) {\n\tconst { name, config } = getColumnNameAndConfig<PgTimestampConfig | undefined>(a, b);\n\tif (config?.mode === 'string') {\n\t\treturn new PgTimestampStringBuilder(name, config.withTimezone ?? false, config.precision);\n\t}\n\treturn new PgTimestampBuilder(name, config?.withTimezone ?? false, config?.precision);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { sql } from '~/sql/sql.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgUUIDBuilderInitial<TName extends string> = PgUUIDBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgUUID';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgUUIDBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgUUID'>> extends PgColumnBuilder<T> {\n\tstatic override readonly [entityKind]: string = 'PgUUIDBuilder';\n\n\tconstructor(name: T['name']) {\n\t\tsuper(name, 'string', 'PgUUID');\n\t}\n\n\t/**\n\t * Adds `default gen_random_uuid()` to the column definition.\n\t */\n\tdefaultRandom(): ReturnType<this['default']> {\n\t\treturn this.default(sql`gen_random_uuid()`) as ReturnType<this['default']>;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgUUID<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgUUID<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgUUID<T extends ColumnBaseConfig<'string', 'PgUUID'>> extends PgColumn<T> {\n\tstatic override readonly [entityKind]: string = 'PgUUID';\n\n\tgetSQLType(): string {\n\t\treturn 'uuid';\n\t}\n}\n\nexport function uuid(): PgUUIDBuilderInitial<''>;\nexport function uuid<TName extends string>(name: TName): PgUUIDBuilderInitial<TName>;\nexport function uuid(name?: string) {\n\treturn new PgUUIDBuilder(name ?? '');\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig, type Writable } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from './common.ts';\n\nexport type PgVarcharBuilderInitial<TName extends string, TEnum extends [string, ...string[]]> = PgVarcharBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgVarchar';\n\tdata: TEnum[number];\n\tdriverParam: string;\n\tenumValues: TEnum;\n}>;\n\nexport class PgVarcharBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgVarchar'>> extends PgColumnBuilder<\n\tT,\n\t{ length: number | undefined; enumValues: T['enumValues'] }\n> {\n\tstatic override readonly [entityKind]: string = 'PgVarcharBuilder';\n\n\tconstructor(name: T['name'], config: PgVarcharConfig<T['enumValues']>) {\n\t\tsuper(name, 'string', 'PgVarchar');\n\t\tthis.config.length = config.length;\n\t\tthis.config.enumValues = config.enum;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgVarchar<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgVarchar<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgVarchar<T extends ColumnBaseConfig<'string', 'PgVarchar'>>\n\textends PgColumn<T, { length: number | undefined; enumValues: T['enumValues'] }>\n{\n\tstatic override readonly [entityKind]: string = 'PgVarchar';\n\n\treadonly length = this.config.length;\n\toverride readonly enumValues = this.config.enumValues;\n\n\tgetSQLType(): string {\n\t\treturn this.length === undefined ? `varchar` : `varchar(${this.length})`;\n\t}\n}\n\nexport interface PgVarcharConfig<\n\tTEnum extends readonly string[] | string[] | undefined = readonly string[] | string[] | undefined,\n> {\n\tlength?: number;\n\tenum?: TEnum;\n}\n\nexport function varchar(): PgVarcharBuilderInitial<'', [string, ...string[]]>;\nexport function varchar<U extends string, T extends Readonly<[U, ...U[]]>>(\n\tconfig?: PgVarcharConfig<T | Writable<T>>,\n): PgVarcharBuilderInitial<'', Writable<T>>;\nexport function varchar<TName extends string, U extends string, T extends Readonly<[U, ...U[]]>>(\n\tname: TName,\n\tconfig?: PgVarcharConfig<T | Writable<T>>,\n): PgVarcharBuilderInitial<TName, Writable<T>>;\nexport function varchar(a?: string | PgVarcharConfig, b: PgVarcharConfig = {}): any {\n\tconst { name, config } = getColumnNameAndConfig<PgVarcharConfig>(a, b);\n\treturn new PgVarcharBuilder(name, config as any);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from '../common.ts';\n\nexport type PgBinaryVectorBuilderInitial<TName extends string> = PgBinaryVectorBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgBinaryVector';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgBinaryVectorBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgBinaryVector'>>\n\textends PgColumnBuilder<\n\t\tT,\n\t\t{ dimensions: number | undefined }\n\t>\n{\n\tstatic override readonly [entityKind]: string = 'PgBinaryVectorBuilder';\n\n\tconstructor(name: string, config: PgBinaryVectorConfig) {\n\t\tsuper(name, 'string', 'PgBinaryVector');\n\t\tthis.config.dimensions = config.dimensions;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgBinaryVector<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgBinaryVector<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgBinaryVector<T extends ColumnBaseConfig<'string', 'PgBinaryVector'>>\n\textends PgColumn<T, { dimensions: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'PgBinaryVector';\n\n\treadonly dimensions = this.config.dimensions;\n\n\tgetSQLType(): string {\n\t\treturn `bit(${this.dimensions})`;\n\t}\n}\n\nexport interface PgBinaryVectorConfig {\n\tdimensions: number;\n}\n\nexport function bit(\n\tconfig: PgBinaryVectorConfig,\n): PgBinaryVectorBuilderInitial<''>;\nexport function bit<TName extends string>(\n\tname: TName,\n\tconfig: PgBinaryVectorConfig,\n): PgBinaryVectorBuilderInitial<TName>;\nexport function bit(a: string | PgBinaryVectorConfig, b?: PgBinaryVectorConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgBinaryVectorConfig>(a, b);\n\treturn new PgBinaryVectorBuilder(name, config);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from '../common.ts';\n\nexport type PgHalfVectorBuilderInitial<TName extends string> = PgHalfVectorBuilder<{\n\tname: TName;\n\tdataType: 'array';\n\tcolumnType: 'PgHalfVector';\n\tdata: number[];\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgHalfVectorBuilder<T extends ColumnBuilderBaseConfig<'array', 'PgHalfVector'>> extends PgColumnBuilder<\n\tT,\n\t{ dimensions: number | undefined }\n> {\n\tstatic override readonly [entityKind]: string = 'PgHalfVectorBuilder';\n\n\tconstructor(name: string, config: PgHalfVectorConfig) {\n\t\tsuper(name, 'array', 'PgHalfVector');\n\t\tthis.config.dimensions = config.dimensions;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgHalfVector<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgHalfVector<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgHalfVector<T extends ColumnBaseConfig<'array', 'PgHalfVector'>>\n\textends PgColumn<T, { dimensions: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'PgHalfVector';\n\n\treadonly dimensions = this.config.dimensions;\n\n\tgetSQLType(): string {\n\t\treturn `halfvec(${this.dimensions})`;\n\t}\n\n\toverride mapToDriverValue(value: unknown): unknown {\n\t\treturn JSON.stringify(value);\n\t}\n\n\toverride mapFromDriverValue(value: string): unknown {\n\t\treturn value\n\t\t\t.slice(1, -1)\n\t\t\t.split(',')\n\t\t\t.map((v) => Number.parseFloat(v));\n\t}\n}\n\nexport interface PgHalfVectorConfig {\n\tdimensions: number;\n}\n\nexport function halfvec(\n\tconfig: PgHalfVectorConfig,\n): PgHalfVectorBuilderInitial<''>;\nexport function halfvec<TName extends string>(\n\tname: TName,\n\tconfig: PgHalfVectorConfig,\n): PgHalfVectorBuilderInitial<TName>;\nexport function halfvec(a: string | PgHalfVectorConfig, b?: PgHalfVectorConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgHalfVectorConfig>(a, b);\n\treturn new PgHalfVectorBuilder(name, config);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from '../common.ts';\n\nexport type PgSparseVectorBuilderInitial<TName extends string> = PgSparseVectorBuilder<{\n\tname: TName;\n\tdataType: 'string';\n\tcolumnType: 'PgSparseVector';\n\tdata: string;\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgSparseVectorBuilder<T extends ColumnBuilderBaseConfig<'string', 'PgSparseVector'>>\n\textends PgColumnBuilder<\n\t\tT,\n\t\t{ dimensions: number | undefined }\n\t>\n{\n\tstatic override readonly [entityKind]: string = 'PgSparseVectorBuilder';\n\n\tconstructor(name: string, config: PgSparseVectorConfig) {\n\t\tsuper(name, 'string', 'PgSparseVector');\n\t\tthis.config.dimensions = config.dimensions;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgSparseVector<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgSparseVector<MakeColumnConfig<T, TTableName>>(\n\t\t\ttable,\n\t\t\tthis.config as ColumnBuilderRuntimeConfig<any, any>,\n\t\t);\n\t}\n}\n\nexport class PgSparseVector<T extends ColumnBaseConfig<'string', 'PgSparseVector'>>\n\textends PgColumn<T, { dimensions: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'PgSparseVector';\n\n\treadonly dimensions = this.config.dimensions;\n\n\tgetSQLType(): string {\n\t\treturn `sparsevec(${this.dimensions})`;\n\t}\n}\n\nexport interface PgSparseVectorConfig {\n\tdimensions: number;\n}\n\nexport function sparsevec(\n\tconfig: PgSparseVectorConfig,\n): PgSparseVectorBuilderInitial<''>;\nexport function sparsevec<TName extends string>(\n\tname: TName,\n\tconfig: PgSparseVectorConfig,\n): PgSparseVectorBuilderInitial<TName>;\nexport function sparsevec(a: string | PgSparseVectorConfig, b?: PgSparseVectorConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgSparseVectorConfig>(a, b);\n\treturn new PgSparseVectorBuilder(name, config);\n}\n","import type { ColumnBuilderBaseConfig, ColumnBuilderRuntimeConfig, MakeColumnConfig } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { AnyPgTable } from '~/pg-core/table.ts';\nimport { getColumnNameAndConfig } from '~/utils.ts';\nimport { PgColumn, PgColumnBuilder } from '../common.ts';\n\nexport type PgVectorBuilderInitial<TName extends string> = PgVectorBuilder<{\n\tname: TName;\n\tdataType: 'array';\n\tcolumnType: 'PgVector';\n\tdata: number[];\n\tdriverParam: string;\n\tenumValues: undefined;\n}>;\n\nexport class PgVectorBuilder<T extends ColumnBuilderBaseConfig<'array', 'PgVector'>> extends PgColumnBuilder<\n\tT,\n\t{ dimensions: number | undefined }\n> {\n\tstatic override readonly [entityKind]: string = 'PgVectorBuilder';\n\n\tconstructor(name: string, config: PgVectorConfig) {\n\t\tsuper(name, 'array', 'PgVector');\n\t\tthis.config.dimensions = config.dimensions;\n\t}\n\n\t/** @internal */\n\toverride build<TTableName extends string>(\n\t\ttable: AnyPgTable<{ name: TTableName }>,\n\t): PgVector<MakeColumnConfig<T, TTableName>> {\n\t\treturn new PgVector<MakeColumnConfig<T, TTableName>>(table, this.config as ColumnBuilderRuntimeConfig<any, any>);\n\t}\n}\n\nexport class PgVector<T extends ColumnBaseConfig<'array', 'PgVector'>>\n\textends PgColumn<T, { dimensions: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'PgVector';\n\n\treadonly dimensions = this.config.dimensions;\n\n\tgetSQLType(): string {\n\t\treturn `vector(${this.dimensions})`;\n\t}\n\n\toverride mapToDriverValue(value: unknown): unknown {\n\t\treturn JSON.stringify(value);\n\t}\n\n\toverride mapFromDriverValue(value: string): unknown {\n\t\treturn value\n\t\t\t.slice(1, -1)\n\t\t\t.split(',')\n\t\t\t.map((v) => Number.parseFloat(v));\n\t}\n}\n\nexport interface PgVectorConfig {\n\tdimensions: number;\n}\n\nexport function vector(\n\tconfig: PgVectorConfig,\n): PgVectorBuilderInitial<''>;\nexport function vector<TName extends string>(\n\tname: TName,\n\tconfig: PgVectorConfig,\n): PgVectorBuilderInitial<TName>;\nexport function vector(a: string | PgVectorConfig, b?: PgVectorConfig) {\n\tconst { name, config } = getColumnNameAndConfig<PgVectorConfig>(a, b);\n\treturn new PgVectorBuilder(name, config);\n}\n","import { bigint } from './bigint.ts';\nimport { bigserial } from './bigserial.ts';\nimport { boolean } from './boolean.ts';\nimport { char } from './char.ts';\nimport { cidr } from './cidr.ts';\nimport { customType } from './custom.ts';\nimport { date } from './date.ts';\nimport { doublePrecision } from './double-precision.ts';\nimport { inet } from './inet.ts';\nimport { integer } from './integer.ts';\nimport { interval } from './interval.ts';\nimport { json } from './json.ts';\nimport { jsonb } from './jsonb.ts';\nimport { line } from './line.ts';\nimport { macaddr } from './macaddr.ts';\nimport { macaddr8 } from './macaddr8.ts';\nimport { numeric } from './numeric.ts';\nimport { point } from './point.ts';\nimport { geometry } from './postgis_extension/geometry.ts';\nimport { real } from './real.ts';\nimport { serial } from './serial.ts';\nimport { smallint } from './smallint.ts';\nimport { smallserial } from './smallserial.ts';\nimport { text } from './text.ts';\nimport { time } from './time.ts';\nimport { timestamp } from './timestamp.ts';\nimport { uuid } from './uuid.ts';\nimport { varchar } from './varchar.ts';\nimport { bit } from './vector_extension/bit.ts';\nimport { halfvec } from './vector_extension/halfvec.ts';\nimport { sparsevec } from './vector_extension/sparsevec.ts';\nimport { vector } from './vector_extension/vector.ts';\n\nexport function getPgColumnBuilders() {\n\treturn {\n\t\tbigint,\n\t\tbigserial,\n\t\tboolean,\n\t\tchar,\n\t\tcidr,\n\t\tcustomType,\n\t\tdate,\n\t\tdoublePrecision,\n\t\tinet,\n\t\tinteger,\n\t\tinterval,\n\t\tjson,\n\t\tjsonb,\n\t\tline,\n\t\tmacaddr,\n\t\tmacaddr8,\n\t\tnumeric,\n\t\tpoint,\n\t\tgeometry,\n\t\treal,\n\t\tserial,\n\t\tsmallint,\n\t\tsmallserial,\n\t\ttext,\n\t\ttime,\n\t\ttimestamp,\n\t\tuuid,\n\t\tvarchar,\n\t\tbit,\n\t\thalfvec,\n\t\tsparsevec,\n\t\tvector,\n\t};\n}\n\nexport type PgColumnsBuilders = ReturnType<typeof getPgColumnBuilders>;\n","import type { BuildColumns, BuildExtraConfigColumns } from '~/column-builder.ts';\nimport { entityKind } from '~/entity.ts';\nimport { Table, type TableConfig as TableConfigBase, type UpdateTableConfig } from '~/table.ts';\nimport type { CheckBuilder } from './checks.ts';\nimport { getPgColumnBuilders, type PgColumnsBuilders } from './columns/all.ts';\nimport type { PgColumn, PgColumnBuilder, PgColumnBuilderBase } from './columns/common.ts';\nimport type { ForeignKey, ForeignKeyBuilder } from './foreign-keys.ts';\nimport type { AnyIndexBuilder } from './indexes.ts';\nimport type { PgPolicy } from './policies.ts';\nimport type { PrimaryKeyBuilder } from './primary-keys.ts';\nimport type { UniqueConstraintBuilder } from './unique-constraint.ts';\n\nexport type PgTableExtraConfigValue =\n\t| AnyIndexBuilder\n\t| CheckBuilder\n\t| ForeignKeyBuilder\n\t| PrimaryKeyBuilder\n\t| UniqueConstraintBuilder\n\t| PgPolicy;\n\nexport type PgTableExtraConfig = Record<\n\tstring,\n\tPgTableExtraConfigValue\n>;\n\nexport type TableConfig = TableConfigBase<PgColumn>;\n\n/** @internal */\nexport const InlineForeignKeys = Symbol.for('drizzle:PgInlineForeignKeys');\n/** @internal */\nexport const EnableRLS = Symbol.for('drizzle:EnableRLS');\n\nexport class PgTable<T extends TableConfig = TableConfig> extends Table<T> {\n\tstatic override readonly [entityKind]: string = 'PgTable';\n\n\t/** @internal */\n\tstatic override readonly Symbol = Object.assign({}, Table.Symbol, {\n\t\tInlineForeignKeys: InlineForeignKeys as typeof InlineForeignKeys,\n\t\tEnableRLS: EnableRLS as typeof EnableRLS,\n\t});\n\n\t/**@internal */\n\t[InlineForeignKeys]: ForeignKey[] = [];\n\n\t/** @internal */\n\t[EnableRLS]: boolean = false;\n\n\t/** @internal */\n\toverride [Table.Symbol.ExtraConfigBuilder]: ((self: Record<string, PgColumn>) => PgTableExtraConfig) | undefined =\n\t\tundefined;\n}\n\nexport type AnyPgTable<TPartial extends Partial<TableConfig> = {}> = PgTable<UpdateTableConfig<TableConfig, TPartial>>;\n\nexport type PgTableWithColumns<T extends TableConfig> =\n\t& PgTable<T>\n\t& {\n\t\t[Key in keyof T['columns']]: T['columns'][Key];\n\t}\n\t& {\n\t\tenableRLS: () => Omit<\n\t\t\tPgTableWithColumns<T>,\n\t\t\t'enableRLS'\n\t\t>;\n\t};\n\n/** @internal */\nexport function pgTableWithSchema<\n\tTTableName extends string,\n\tTSchemaName extends string | undefined,\n\tTColumnsMap extends Record<string, PgColumnBuilderBase>,\n>(\n\tname: TTableName,\n\tcolumns: TColumnsMap | ((columnTypes: PgColumnsBuilders) => TColumnsMap),\n\textraConfig:\n\t\t| ((self: BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>) => PgTableExtraConfig | PgTableExtraConfigValue[])\n\t\t| undefined,\n\tschema: TSchemaName,\n\tbaseName = name,\n): PgTableWithColumns<{\n\tname: TTableName;\n\tschema: TSchemaName;\n\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\tdialect: 'pg';\n}> {\n\tconst rawTable = new PgTable<{\n\t\tname: TTableName;\n\t\tschema: TSchemaName;\n\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\tdialect: 'pg';\n\t}>(name, schema, baseName);\n\n\tconst parsedColumns: TColumnsMap = typeof columns === 'function' ? columns(getPgColumnBuilders()) : columns;\n\n\tconst builtColumns = Object.fromEntries(\n\t\tObject.entries(parsedColumns).map(([name, colBuilderBase]) => {\n\t\t\tconst colBuilder = colBuilderBase as PgColumnBuilder;\n\t\t\tcolBuilder.setName(name);\n\t\t\tconst column = colBuilder.build(rawTable);\n\t\t\trawTable[InlineForeignKeys].push(...colBuilder.buildForeignKeys(column, rawTable));\n\t\t\treturn [name, column];\n\t\t}),\n\t) as unknown as BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\n\tconst builtColumnsForExtraConfig = Object.fromEntries(\n\t\tObject.entries(parsedColumns).map(([name, colBuilderBase]) => {\n\t\t\tconst colBuilder = colBuilderBase as PgColumnBuilder;\n\t\t\tcolBuilder.setName(name);\n\t\t\tconst column = colBuilder.buildExtraConfigColumn(rawTable);\n\t\t\treturn [name, column];\n\t\t}),\n\t) as unknown as BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>;\n\n\tconst table = Object.assign(rawTable, builtColumns);\n\n\ttable[Table.Symbol.Columns] = builtColumns;\n\ttable[Table.Symbol.ExtraConfigColumns] = builtColumnsForExtraConfig;\n\n\tif (extraConfig) {\n\t\ttable[PgTable.Symbol.ExtraConfigBuilder] = extraConfig as any;\n\t}\n\n\treturn Object.assign(table, {\n\t\tenableRLS: () => {\n\t\t\ttable[PgTable.Symbol.EnableRLS] = true;\n\t\t\treturn table as PgTableWithColumns<{\n\t\t\t\tname: TTableName;\n\t\t\t\tschema: TSchemaName;\n\t\t\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\t\t\tdialect: 'pg';\n\t\t\t}>;\n\t\t},\n\t});\n}\n\nexport interface PgTableFn<TSchema extends string | undefined = undefined> {\n\t/**\n\t * @deprecated This overload is deprecated. Use the other method overload instead.\n\t */\n\t<\n\t\tTTableName extends string,\n\t\tTColumnsMap extends Record<string, PgColumnBuilderBase>,\n\t>(\n\t\tname: TTableName,\n\t\tcolumns: TColumnsMap,\n\t\textraConfig: (\n\t\t\tself: BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>,\n\t\t) => PgTableExtraConfig,\n\t): PgTableWithColumns<{\n\t\tname: TTableName;\n\t\tschema: TSchema;\n\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\tdialect: 'pg';\n\t}>;\n\n\t/**\n\t * @deprecated This overload is deprecated. Use the other method overload instead.\n\t */\n\t<\n\t\tTTableName extends string,\n\t\tTColumnsMap extends Record<string, PgColumnBuilderBase>,\n\t>(\n\t\tname: TTableName,\n\t\tcolumns: (columnTypes: PgColumnsBuilders) => TColumnsMap,\n\t\textraConfig: (self: BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>) => PgTableExtraConfig,\n\t): PgTableWithColumns<{\n\t\tname: TTableName;\n\t\tschema: TSchema;\n\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\tdialect: 'pg';\n\t}>;\n\n\t<\n\t\tTTableName extends string,\n\t\tTColumnsMap extends Record<string, PgColumnBuilderBase>,\n\t>(\n\t\tname: TTableName,\n\t\tcolumns: TColumnsMap,\n\t\textraConfig?: (\n\t\t\tself: BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>,\n\t\t) => PgTableExtraConfigValue[],\n\t): PgTableWithColumns<{\n\t\tname: TTableName;\n\t\tschema: TSchema;\n\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\tdialect: 'pg';\n\t}>;\n\n\t<\n\t\tTTableName extends string,\n\t\tTColumnsMap extends Record<string, PgColumnBuilderBase>,\n\t>(\n\t\tname: TTableName,\n\t\tcolumns: (columnTypes: PgColumnsBuilders) => TColumnsMap,\n\t\textraConfig?: (self: BuildExtraConfigColumns<TTableName, TColumnsMap, 'pg'>) => PgTableExtraConfigValue[],\n\t): PgTableWithColumns<{\n\t\tname: TTableName;\n\t\tschema: TSchema;\n\t\tcolumns: BuildColumns<TTableName, TColumnsMap, 'pg'>;\n\t\tdialect: 'pg';\n\t}>;\n}\n\nexport const pgTable: PgTableFn = (name, columns, extraConfig) => {\n\treturn pgTableWithSchema(name, columns, extraConfig, undefined);\n};\n\nexport function pgTableCreator(customizeTableName: (name: string) => string): PgTableFn {\n\treturn (name, columns, extraConfig) => {\n\t\treturn pgTableWithSchema(customizeTableName(name) as typeof name, columns, extraConfig, undefined, name);\n\t};\n}\n","import { entityKind } from '~/entity.ts';\nimport type { AnyPgColumn, PgColumn } from './columns/index.ts';\nimport { PgTable } from './table.ts';\n\nexport function primaryKey<\n\tTTableName extends string,\n\tTColumn extends AnyPgColumn<{ tableName: TTableName }>,\n\tTColumns extends AnyPgColumn<{ tableName: TTableName }>[],\n>(config: { name?: string; columns: [TColumn, ...TColumns] }): PrimaryKeyBuilder;\n/**\n * @deprecated: Please use primaryKey({ columns: [] }) instead of this function\n * @param columns\n */\nexport function primaryKey<\n\tTTableName extends string,\n\tTColumns extends AnyPgColumn<{ tableName: TTableName }>[],\n>(...columns: TColumns): PrimaryKeyBuilder;\nexport function primaryKey(...config: any) {\n\tif (config[0].columns) {\n\t\treturn new PrimaryKeyBuilder(config[0].columns, config[0].name);\n\t}\n\treturn new PrimaryKeyBuilder(config);\n}\n\nexport class PrimaryKeyBuilder {\n\tstatic readonly [entityKind]: string = 'PgPrimaryKeyBuilder';\n\n\t/** @internal */\n\tcolumns: PgColumn[];\n\n\t/** @internal */\n\tname?: string;\n\n\tconstructor(\n\t\tcolumns: PgColumn[],\n\t\tname?: string,\n\t) {\n\t\tthis.columns = columns;\n\t\tthis.name = name;\n\t}\n\n\t/** @internal */\n\tbuild(table: PgTable): PrimaryKey {\n\t\treturn new PrimaryKey(table, this.columns, this.name);\n\t}\n}\n\nexport class PrimaryKey {\n\tstatic readonly [entityKind]: string = 'PgPrimaryKey';\n\n\treadonly columns: AnyPgColumn<{}>[];\n\treadonly name?: string;\n\n\tconstructor(readonly table: PgTable, columns: AnyPgColumn<{}>[], name?: string) {\n\t\tthis.columns = columns;\n\t\tthis.name = name;\n\t}\n\n\tgetName(): string {\n\t\treturn this.name ?? `${this.table[PgTable.Symbol.Name]}_${this.columns.map((column) => column.name).join('_')}_pk`;\n\t}\n}\n","import { type AnyColumn, Column, type GetColumnData } from '~/column.ts';\nimport { is } from '~/entity.ts';\nimport { Table } from '~/table.ts';\nimport {\n\tisDriverValueEncoder,\n\tisSQLWrapper,\n\tParam,\n\tPlaceholder,\n\tSQL,\n\tsql,\n\ttype SQLChunk,\n\ttype SQLWrapper,\n\tStringChunk,\n\tView,\n} from '../sql.ts';\n\nexport function bindIfParam(value: unknown, column: SQLWrapper): SQLChunk {\n\tif (\n\t\tisDriverValueEncoder(column)\n\t\t&& !isSQLWrapper(value)\n\t\t&& !is(value, Param)\n\t\t&& !is(value, Placeholder)\n\t\t&& !is(value, Column)\n\t\t&& !is(value, Table)\n\t\t&& !is(value, View)\n\t) {\n\t\treturn new Param(value, column);\n\t}\n\treturn value as SQLChunk;\n}\n\nexport interface BinaryOperator {\n\t<TColumn extends Column>(\n\t\tleft: TColumn,\n\t\tright: GetColumnData<TColumn, 'raw'> | SQLWrapper,\n\t): SQL;\n\t<T>(left: SQL.Aliased<T>, right: T | SQLWrapper): SQL;\n\t<T extends SQLWrapper>(\n\t\tleft: Exclude<T, SQL.Aliased | Column>,\n\t\tright: unknown,\n\t): SQL;\n}\n\n/**\n * Test that two values are equal.\n *\n * Remember that the SQL standard dictates that\n * two NULL values are not equal, so if you want to test\n * whether a value is null, you may want to use\n * `isNull` instead.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made by Ford\n * db.select().from(cars)\n *   .where(eq(cars.make, 'Ford'))\n * ```\n *\n * @see isNull for a way to test equality to NULL.\n */\nexport const eq: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} = ${bindIfParam(right, left)}`;\n};\n\n/**\n * Test that two values are not equal.\n *\n * Remember that the SQL standard dictates that\n * two NULL values are not equal, so if you want to test\n * whether a value is not null, you may want to use\n * `isNotNull` instead.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars not made by Ford\n * db.select().from(cars)\n *   .where(ne(cars.make, 'Ford'))\n * ```\n *\n * @see isNotNull for a way to test whether a value is not null.\n */\nexport const ne: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} <> ${bindIfParam(right, left)}`;\n};\n\n/**\n * Combine a list of conditions with the `and` operator. Conditions\n * that are equal `undefined` are automatically ignored.\n *\n * ## Examples\n *\n * ```ts\n * db.select().from(cars)\n *   .where(\n *     and(\n *       eq(cars.make, 'Volvo'),\n *       eq(cars.year, 1950),\n *     )\n *   )\n * ```\n */\nexport function and(...conditions: (SQLWrapper | undefined)[]): SQL | undefined;\nexport function and(\n\t...unfilteredConditions: (SQLWrapper | undefined)[]\n): SQL | undefined {\n\tconst conditions = unfilteredConditions.filter(\n\t\t(c): c is Exclude<typeof c, undefined> => c !== undefined,\n\t);\n\n\tif (conditions.length === 0) {\n\t\treturn undefined;\n\t}\n\n\tif (conditions.length === 1) {\n\t\treturn new SQL(conditions);\n\t}\n\n\treturn new SQL([\n\t\tnew StringChunk('('),\n\t\tsql.join(conditions, new StringChunk(' and ')),\n\t\tnew StringChunk(')'),\n\t]);\n}\n\n/**\n * Combine a list of conditions with the `or` operator. Conditions\n * that are equal `undefined` are automatically ignored.\n *\n * ## Examples\n *\n * ```ts\n * db.select().from(cars)\n *   .where(\n *     or(\n *       eq(cars.make, 'GM'),\n *       eq(cars.make, 'Ford'),\n *     )\n *   )\n * ```\n */\nexport function or(...conditions: (SQLWrapper | undefined)[]): SQL | undefined;\nexport function or(\n\t...unfilteredConditions: (SQLWrapper | undefined)[]\n): SQL | undefined {\n\tconst conditions = unfilteredConditions.filter(\n\t\t(c): c is Exclude<typeof c, undefined> => c !== undefined,\n\t);\n\n\tif (conditions.length === 0) {\n\t\treturn undefined;\n\t}\n\n\tif (conditions.length === 1) {\n\t\treturn new SQL(conditions);\n\t}\n\n\treturn new SQL([\n\t\tnew StringChunk('('),\n\t\tsql.join(conditions, new StringChunk(' or ')),\n\t\tnew StringChunk(')'),\n\t]);\n}\n\n/**\n * Negate the meaning of an expression using the `not` keyword.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars _not_ made by GM or Ford.\n * db.select().from(cars)\n *   .where(not(inArray(cars.make, ['GM', 'Ford'])))\n * ```\n */\nexport function not(condition: SQLWrapper): SQL {\n\treturn sql`not ${condition}`;\n}\n\n/**\n * Test that the first expression passed is greater than\n * the second expression.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made after 2000.\n * db.select().from(cars)\n *   .where(gt(cars.year, 2000))\n * ```\n *\n * @see gte for greater-than-or-equal\n */\nexport const gt: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} > ${bindIfParam(right, left)}`;\n};\n\n/**\n * Test that the first expression passed is greater than\n * or equal to the second expression. Use `gt` to\n * test whether an expression is strictly greater\n * than another.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made on or after 2000.\n * db.select().from(cars)\n *   .where(gte(cars.year, 2000))\n * ```\n *\n * @see gt for a strictly greater-than condition\n */\nexport const gte: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} >= ${bindIfParam(right, left)}`;\n};\n\n/**\n * Test that the first expression passed is less than\n * the second expression.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made before 2000.\n * db.select().from(cars)\n *   .where(lt(cars.year, 2000))\n * ```\n *\n * @see lte for less-than-or-equal\n */\nexport const lt: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} < ${bindIfParam(right, left)}`;\n};\n\n/**\n * Test that the first expression passed is less than\n * or equal to the second expression.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made before 2000.\n * db.select().from(cars)\n *   .where(lte(cars.year, 2000))\n * ```\n *\n * @see lt for a strictly less-than condition\n */\nexport const lte: BinaryOperator = (left: SQLWrapper, right: unknown): SQL => {\n\treturn sql`${left} <= ${bindIfParam(right, left)}`;\n};\n\n/**\n * Test whether the first parameter, a column or expression,\n * has a value from a list passed as the second argument.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made by Ford or GM.\n * db.select().from(cars)\n *   .where(inArray(cars.make, ['Ford', 'GM']))\n * ```\n *\n * @see notInArray for the inverse of this test\n */\nexport function inArray<T>(\n\tcolumn: SQL.Aliased<T>,\n\tvalues: (T | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function inArray<TColumn extends Column>(\n\tcolumn: TColumn,\n\tvalues: (GetColumnData<TColumn, 'raw'> | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function inArray<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function inArray(\n\tcolumn: SQLWrapper,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL {\n\tif (Array.isArray(values)) {\n\t\tif (values.length === 0) {\n\t\t\treturn sql`false`;\n\t\t}\n\t\treturn sql`${column} in ${values.map((v) => bindIfParam(v, column))}`;\n\t}\n\n\treturn sql`${column} in ${bindIfParam(values, column)}`;\n}\n\n/**\n * Test whether the first parameter, a column or expression,\n * has a value that is not present in a list passed as the\n * second argument.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made by any company except Ford or GM.\n * db.select().from(cars)\n *   .where(notInArray(cars.make, ['Ford', 'GM']))\n * ```\n *\n * @see inArray for the inverse of this test\n */\nexport function notInArray<T>(\n\tcolumn: SQL.Aliased<T>,\n\tvalues: (T | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function notInArray<TColumn extends Column>(\n\tcolumn: TColumn,\n\tvalues: (GetColumnData<TColumn, 'raw'> | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function notInArray<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function notInArray(\n\tcolumn: SQLWrapper,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL {\n\tif (Array.isArray(values)) {\n\t\tif (values.length === 0) {\n\t\t\treturn sql`true`;\n\t\t}\n\t\treturn sql`${column} not in ${values.map((v) => bindIfParam(v, column))}`;\n\t}\n\n\treturn sql`${column} not in ${bindIfParam(values, column)}`;\n}\n\n/**\n * Test whether an expression is NULL. By the SQL standard,\n * NULL is neither equal nor not equal to itself, so\n * it's recommended to use `isNull` and `notIsNull` for\n * comparisons to NULL.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars that have no discontinuedAt date.\n * db.select().from(cars)\n *   .where(isNull(cars.discontinuedAt))\n * ```\n *\n * @see isNotNull for the inverse of this test\n */\nexport function isNull(value: SQLWrapper): SQL {\n\treturn sql`${value} is null`;\n}\n\n/**\n * Test whether an expression is not NULL. By the SQL standard,\n * NULL is neither equal nor not equal to itself, so\n * it's recommended to use `isNull` and `notIsNull` for\n * comparisons to NULL.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars that have been discontinued.\n * db.select().from(cars)\n *   .where(isNotNull(cars.discontinuedAt))\n * ```\n *\n * @see isNull for the inverse of this test\n */\nexport function isNotNull(value: SQLWrapper): SQL {\n\treturn sql`${value} is not null`;\n}\n\n/**\n * Test whether a subquery evaluates to have any rows.\n *\n * ## Examples\n *\n * ```ts\n * // Users whose `homeCity` column has a match in a cities\n * // table.\n * db\n *   .select()\n *   .from(users)\n *   .where(\n *     exists(db.select()\n *       .from(cities)\n *       .where(eq(users.homeCity, cities.id))),\n *   );\n * ```\n *\n * @see notExists for the inverse of this test\n */\nexport function exists(subquery: SQLWrapper): SQL {\n\treturn sql`exists ${subquery}`;\n}\n\n/**\n * Test whether a subquery doesn't include any result\n * rows.\n *\n * ## Examples\n *\n * ```ts\n * // Users whose `homeCity` column doesn't match\n * // a row in the cities table.\n * db\n *   .select()\n *   .from(users)\n *   .where(\n *     notExists(db.select()\n *       .from(cities)\n *       .where(eq(users.homeCity, cities.id))),\n *   );\n * ```\n *\n * @see exists for the inverse of this test\n */\nexport function notExists(subquery: SQLWrapper): SQL {\n\treturn sql`not exists ${subquery}`;\n}\n\n/**\n * Test whether an expression is between two values. This\n * is an easier way to express range tests, which would be\n * expressed mathematically as `x <= a <= y` but in SQL\n * would have to be like `a >= x AND a <= y`.\n *\n * Between is inclusive of the endpoints: if `column`\n * is equal to `min` or `max`, it will be TRUE.\n *\n * ## Examples\n *\n * ```ts\n * // Select cars made between 1990 and 2000\n * db.select().from(cars)\n *   .where(between(cars.year, 1990, 2000))\n * ```\n *\n * @see notBetween for the inverse of this test\n */\nexport function between<T>(\n\tcolumn: SQL.Aliased,\n\tmin: T | SQLWrapper,\n\tmax: T | SQLWrapper,\n): SQL;\nexport function between<TColumn extends AnyColumn>(\n\tcolumn: TColumn,\n\tmin: GetColumnData<TColumn, 'raw'> | SQLWrapper,\n\tmax: GetColumnData<TColumn, 'raw'> | SQLWrapper,\n): SQL;\nexport function between<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tmin: unknown,\n\tmax: unknown,\n): SQL;\nexport function between(column: SQLWrapper, min: unknown, max: unknown): SQL {\n\treturn sql`${column} between ${bindIfParam(min, column)} and ${\n\t\tbindIfParam(\n\t\t\tmax,\n\t\t\tcolumn,\n\t\t)\n\t}`;\n}\n\n/**\n * Test whether an expression is not between two values.\n *\n * This, like `between`, includes its endpoints, so if\n * the `column` is equal to `min` or `max`, in this case\n * it will evaluate to FALSE.\n *\n * ## Examples\n *\n * ```ts\n * // Exclude cars made in the 1970s\n * db.select().from(cars)\n *   .where(notBetween(cars.year, 1970, 1979))\n * ```\n *\n * @see between for the inverse of this test\n */\nexport function notBetween<T>(\n\tcolumn: SQL.Aliased,\n\tmin: T | SQLWrapper,\n\tmax: T | SQLWrapper,\n): SQL;\nexport function notBetween<TColumn extends AnyColumn>(\n\tcolumn: TColumn,\n\tmin: GetColumnData<TColumn, 'raw'> | SQLWrapper,\n\tmax: GetColumnData<TColumn, 'raw'> | SQLWrapper,\n): SQL;\nexport function notBetween<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tmin: unknown,\n\tmax: unknown,\n): SQL;\nexport function notBetween(\n\tcolumn: SQLWrapper,\n\tmin: unknown,\n\tmax: unknown,\n): SQL {\n\treturn sql`${column} not between ${\n\t\tbindIfParam(\n\t\t\tmin,\n\t\t\tcolumn,\n\t\t)\n\t} and ${bindIfParam(max, column)}`;\n}\n\n/**\n * Compare a column to a pattern, which can include `%` and `_`\n * characters to match multiple variations. Including `%`\n * in the pattern matches zero or more characters, and including\n * `_` will match a single character.\n *\n * ## Examples\n *\n * ```ts\n * // Select all cars with 'Turbo' in their names.\n * db.select().from(cars)\n *   .where(like(cars.name, '%Turbo%'))\n * ```\n *\n * @see ilike for a case-insensitive version of this condition\n */\nexport function like(column: Column | SQL.Aliased | SQL, value: string | SQLWrapper): SQL {\n\treturn sql`${column} like ${value}`;\n}\n\n/**\n * The inverse of like - this tests that a given column\n * does not match a pattern, which can include `%` and `_`\n * characters to match multiple variations. Including `%`\n * in the pattern matches zero or more characters, and including\n * `_` will match a single character.\n *\n * ## Examples\n *\n * ```ts\n * // Select all cars that don't have \"ROver\" in their name.\n * db.select().from(cars)\n *   .where(notLike(cars.name, '%Rover%'))\n * ```\n *\n * @see like for the inverse condition\n * @see notIlike for a case-insensitive version of this condition\n */\nexport function notLike(column: Column | SQL.Aliased | SQL, value: string | SQLWrapper): SQL {\n\treturn sql`${column} not like ${value}`;\n}\n\n/**\n * Case-insensitively compare a column to a pattern,\n * which can include `%` and `_`\n * characters to match multiple variations. Including `%`\n * in the pattern matches zero or more characters, and including\n * `_` will match a single character.\n *\n * Unlike like, this performs a case-insensitive comparison.\n *\n * ## Examples\n *\n * ```ts\n * // Select all cars with 'Turbo' in their names.\n * db.select().from(cars)\n *   .where(ilike(cars.name, '%Turbo%'))\n * ```\n *\n * @see like for a case-sensitive version of this condition\n */\nexport function ilike(column: Column | SQL.Aliased | SQL, value: string | SQLWrapper): SQL {\n\treturn sql`${column} ilike ${value}`;\n}\n\n/**\n * The inverse of ilike - this case-insensitively tests that a given column\n * does not match a pattern, which can include `%` and `_`\n * characters to match multiple variations. Including `%`\n * in the pattern matches zero or more characters, and including\n * `_` will match a single character.\n *\n * ## Examples\n *\n * ```ts\n * // Select all cars that don't have \"Rover\" in their name.\n * db.select().from(cars)\n *   .where(notLike(cars.name, '%Rover%'))\n * ```\n *\n * @see ilike for the inverse condition\n * @see notLike for a case-sensitive version of this condition\n */\nexport function notIlike(column: Column | SQL.Aliased | SQL, value: string | SQLWrapper): SQL {\n\treturn sql`${column} not ilike ${value}`;\n}\n\n/**\n * Test that a column or expression contains all elements of\n * the list passed as the second argument.\n *\n * ## Throws\n *\n * The argument passed in the second array can't be empty:\n * if an empty is provided, this method will throw.\n *\n * ## Examples\n *\n * ```ts\n * // Select posts where its tags contain \"Typescript\" and \"ORM\".\n * db.select().from(posts)\n *   .where(arrayContains(posts.tags, ['Typescript', 'ORM']))\n * ```\n *\n * @see arrayContained to find if an array contains all elements of a column or expression\n * @see arrayOverlaps to find if a column or expression contains any elements of an array\n */\nexport function arrayContains<T>(\n\tcolumn: SQL.Aliased<T>,\n\tvalues: (T | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayContains<TColumn extends Column>(\n\tcolumn: TColumn,\n\tvalues: (GetColumnData<TColumn, 'raw'> | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayContains<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function arrayContains(\n\tcolumn: SQLWrapper,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL {\n\tif (Array.isArray(values)) {\n\t\tif (values.length === 0) {\n\t\t\tthrow new Error('arrayContains requires at least one value');\n\t\t}\n\t\tconst array = sql`${bindIfParam(values, column)}`;\n\t\treturn sql`${column} @> ${array}`;\n\t}\n\n\treturn sql`${column} @> ${bindIfParam(values, column)}`;\n}\n\n/**\n * Test that the list passed as the second argument contains\n * all elements of a column or expression.\n *\n * ## Throws\n *\n * The argument passed in the second array can't be empty:\n * if an empty is provided, this method will throw.\n *\n * ## Examples\n *\n * ```ts\n * // Select posts where its tags contain \"Typescript\", \"ORM\" or both,\n * // but filtering posts that have additional tags.\n * db.select().from(posts)\n *   .where(arrayContained(posts.tags, ['Typescript', 'ORM']))\n * ```\n *\n * @see arrayContains to find if a column or expression contains all elements of an array\n * @see arrayOverlaps to find if a column or expression contains any elements of an array\n */\nexport function arrayContained<T>(\n\tcolumn: SQL.Aliased<T>,\n\tvalues: (T | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayContained<TColumn extends Column>(\n\tcolumn: TColumn,\n\tvalues: (GetColumnData<TColumn, 'raw'> | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayContained<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function arrayContained(\n\tcolumn: SQLWrapper,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL {\n\tif (Array.isArray(values)) {\n\t\tif (values.length === 0) {\n\t\t\tthrow new Error('arrayContained requires at least one value');\n\t\t}\n\t\tconst array = sql`${bindIfParam(values, column)}`;\n\t\treturn sql`${column} <@ ${array}`;\n\t}\n\n\treturn sql`${column} <@ ${bindIfParam(values, column)}`;\n}\n\n/**\n * Test that a column or expression contains any elements of\n * the list passed as the second argument.\n *\n * ## Throws\n *\n * The argument passed in the second array can't be empty:\n * if an empty is provided, this method will throw.\n *\n * ## Examples\n *\n * ```ts\n * // Select posts where its tags contain \"Typescript\", \"ORM\" or both.\n * db.select().from(posts)\n *   .where(arrayOverlaps(posts.tags, ['Typescript', 'ORM']))\n * ```\n *\n * @see arrayContains to find if a column or expression contains all elements of an array\n * @see arrayContained to find if an array contains all elements of a column or expression\n */\nexport function arrayOverlaps<T>(\n\tcolumn: SQL.Aliased<T>,\n\tvalues: (T | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayOverlaps<TColumn extends Column>(\n\tcolumn: TColumn,\n\tvalues: (GetColumnData<TColumn, 'raw'> | Placeholder) | SQLWrapper,\n): SQL;\nexport function arrayOverlaps<T extends SQLWrapper>(\n\tcolumn: Exclude<T, SQL.Aliased | Column>,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL;\nexport function arrayOverlaps(\n\tcolumn: SQLWrapper,\n\tvalues: (unknown | Placeholder)[] | SQLWrapper,\n): SQL {\n\tif (Array.isArray(values)) {\n\t\tif (values.length === 0) {\n\t\t\tthrow new Error('arrayOverlaps requires at least one value');\n\t\t}\n\t\tconst array = sql`${bindIfParam(values, column)}`;\n\t\treturn sql`${column} && ${array}`;\n\t}\n\n\treturn sql`${column} && ${bindIfParam(values, column)}`;\n}\n","import type { AnyColumn } from '../../column.ts';\nimport type { SQL, SQLWrapper } from '../sql.ts';\nimport { sql } from '../sql.ts';\n\n/**\n * Used in sorting, this specifies that the given\n * column or expression should be sorted in ascending\n * order. By the SQL standard, ascending order is the\n * default, so it is not usually necessary to specify\n * ascending sort order.\n *\n * ## Examples\n *\n * ```ts\n * // Return cars, starting with the oldest models\n * // and going in ascending order to the newest.\n * db.select().from(cars)\n *   .orderBy(asc(cars.year));\n * ```\n *\n * @see desc to sort in descending order\n */\nexport function asc(column: AnyColumn | SQLWrapper): SQL {\n\treturn sql`${column} asc`;\n}\n\n/**\n * Used in sorting, this specifies that the given\n * column or expression should be sorted in descending\n * order.\n *\n * ## Examples\n *\n * ```ts\n * // Select users, with the most recently created\n * // records coming first.\n * db.select().from(users)\n *   .orderBy(desc(users.createdAt));\n * ```\n *\n * @see asc to sort in ascending order\n */\nexport function desc(column: AnyColumn | SQLWrapper): SQL {\n\treturn sql`${column} desc`;\n}\n","import { type AnyTable, getTableUniqueName, type InferModelFromColumns, Table } from '~/table.ts';\nimport { type AnyColumn, Column } from './column.ts';\nimport { entityKind, is } from './entity.ts';\nimport { PrimaryKeyBuilder } from './pg-core/primary-keys.ts';\nimport {\n\tand,\n\tasc,\n\tbetween,\n\tdesc,\n\teq,\n\texists,\n\tgt,\n\tgte,\n\tilike,\n\tinArray,\n\tisNotNull,\n\tisNull,\n\tlike,\n\tlt,\n\tlte,\n\tne,\n\tnot,\n\tnotBetween,\n\tnotExists,\n\tnotIlike,\n\tnotInArray,\n\tnotLike,\n\tor,\n} from './sql/expressions/index.ts';\nimport { type Placeholder, SQL, sql } from './sql/sql.ts';\nimport type { Assume, ColumnsWithTable, Equal, Simplify, ValueOrArray } from './utils.ts';\n\nexport abstract class Relation<TTableName extends string = string> {\n\tstatic readonly [entityKind]: string = 'Relation';\n\n\tdeclare readonly $brand: 'Relation';\n\treadonly referencedTableName: TTableName;\n\tfieldName!: string;\n\n\tconstructor(\n\t\treadonly sourceTable: Table,\n\t\treadonly referencedTable: AnyTable<{ name: TTableName }>,\n\t\treadonly relationName: string | undefined,\n\t) {\n\t\tthis.referencedTableName = referencedTable[Table.Symbol.Name] as TTableName;\n\t}\n\n\tabstract withFieldName(fieldName: string): Relation<TTableName>;\n}\n\nexport class Relations<\n\tTTableName extends string = string,\n\tTConfig extends Record<string, Relation> = Record<string, Relation>,\n> {\n\tstatic readonly [entityKind]: string = 'Relations';\n\n\tdeclare readonly $brand: 'Relations';\n\n\tconstructor(\n\t\treadonly table: AnyTable<{ name: TTableName }>,\n\t\treadonly config: (helpers: TableRelationsHelpers<TTableName>) => TConfig,\n\t) {}\n}\n\nexport class One<\n\tTTableName extends string = string,\n\tTIsNullable extends boolean = boolean,\n> extends Relation<TTableName> {\n\tstatic override readonly [entityKind]: string = 'One';\n\n\tdeclare protected $relationBrand: 'One';\n\n\tconstructor(\n\t\tsourceTable: Table,\n\t\treferencedTable: AnyTable<{ name: TTableName }>,\n\t\treadonly config:\n\t\t\t| RelationConfig<\n\t\t\t\tTTableName,\n\t\t\t\tstring,\n\t\t\t\tAnyColumn<{ tableName: TTableName }>[]\n\t\t\t>\n\t\t\t| undefined,\n\t\treadonly isNullable: TIsNullable,\n\t) {\n\t\tsuper(sourceTable, referencedTable, config?.relationName);\n\t}\n\n\twithFieldName(fieldName: string): One<TTableName> {\n\t\tconst relation = new One(\n\t\t\tthis.sourceTable,\n\t\t\tthis.referencedTable,\n\t\t\tthis.config,\n\t\t\tthis.isNullable,\n\t\t);\n\t\trelation.fieldName = fieldName;\n\t\treturn relation;\n\t}\n}\n\nexport class Many<TTableName extends string> extends Relation<TTableName> {\n\tstatic override readonly [entityKind]: string = 'Many';\n\n\tdeclare protected $relationBrand: 'Many';\n\n\tconstructor(\n\t\tsourceTable: Table,\n\t\treferencedTable: AnyTable<{ name: TTableName }>,\n\t\treadonly config: { relationName: string } | undefined,\n\t) {\n\t\tsuper(sourceTable, referencedTable, config?.relationName);\n\t}\n\n\twithFieldName(fieldName: string): Many<TTableName> {\n\t\tconst relation = new Many(\n\t\t\tthis.sourceTable,\n\t\t\tthis.referencedTable,\n\t\t\tthis.config,\n\t\t);\n\t\trelation.fieldName = fieldName;\n\t\treturn relation;\n\t}\n}\n\nexport type TableRelationsKeysOnly<\n\tTSchema extends Record<string, unknown>,\n\tTTableName extends string,\n\tK extends keyof TSchema,\n> = TSchema[K] extends Relations<TTableName> ? K : never;\n\nexport type ExtractTableRelationsFromSchema<\n\tTSchema extends Record<string, unknown>,\n\tTTableName extends string,\n> = ExtractObjectValues<\n\t{\n\t\t[\n\t\t\tK in keyof TSchema as TableRelationsKeysOnly<\n\t\t\t\tTSchema,\n\t\t\t\tTTableName,\n\t\t\t\tK\n\t\t\t>\n\t\t]: TSchema[K] extends Relations<TTableName, infer TConfig> ? TConfig : never;\n\t}\n>;\n\nexport type ExtractObjectValues<T> = T[keyof T];\n\nexport type ExtractRelationsFromTableExtraConfigSchema<\n\tTConfig extends unknown[],\n> = ExtractObjectValues<\n\t{\n\t\t[\n\t\t\tK in keyof TConfig as TConfig[K] extends Relations<any> ? K\n\t\t\t\t: never\n\t\t]: TConfig[K] extends Relations<infer TRelationConfig> ? TRelationConfig\n\t\t\t: never;\n\t}\n>;\n\nexport function getOperators() {\n\treturn {\n\t\tand,\n\t\tbetween,\n\t\teq,\n\t\texists,\n\t\tgt,\n\t\tgte,\n\t\tilike,\n\t\tinArray,\n\t\tisNull,\n\t\tisNotNull,\n\t\tlike,\n\t\tlt,\n\t\tlte,\n\t\tne,\n\t\tnot,\n\t\tnotBetween,\n\t\tnotExists,\n\t\tnotLike,\n\t\tnotIlike,\n\t\tnotInArray,\n\t\tor,\n\t\tsql,\n\t};\n}\n\nexport type Operators = ReturnType<typeof getOperators>;\n\nexport function getOrderByOperators() {\n\treturn {\n\t\tsql,\n\t\tasc,\n\t\tdesc,\n\t};\n}\n\nexport type OrderByOperators = ReturnType<typeof getOrderByOperators>;\n\nexport type FindTableByDBName<\n\tTSchema extends TablesRelationalConfig,\n\tTTableName extends string,\n> = ExtractObjectValues<\n\t{\n\t\t[\n\t\t\tK in keyof TSchema as TSchema[K]['dbName'] extends TTableName ? K\n\t\t\t\t: never\n\t\t]: TSchema[K];\n\t}\n>;\n\nexport type DBQueryConfig<\n\tTRelationType extends 'one' | 'many' = 'one' | 'many',\n\tTIsRoot extends boolean = boolean,\n\tTSchema extends TablesRelationalConfig = TablesRelationalConfig,\n\tTTableConfig extends TableRelationalConfig = TableRelationalConfig,\n> =\n\t& {\n\t\tcolumns?: {\n\t\t\t[K in keyof TTableConfig['columns']]?: boolean;\n\t\t};\n\t\twith?: {\n\t\t\t[K in keyof TTableConfig['relations']]?:\n\t\t\t\t| true\n\t\t\t\t| DBQueryConfig<\n\t\t\t\t\tTTableConfig['relations'][K] extends One ? 'one' : 'many',\n\t\t\t\t\tfalse,\n\t\t\t\t\tTSchema,\n\t\t\t\t\tFindTableByDBName<\n\t\t\t\t\t\tTSchema,\n\t\t\t\t\t\tTTableConfig['relations'][K]['referencedTableName']\n\t\t\t\t\t>\n\t\t\t\t>;\n\t\t};\n\t\textras?:\n\t\t\t| Record<string, SQL.Aliased>\n\t\t\t| ((\n\t\t\t\tfields: Simplify<\n\t\t\t\t\t[TTableConfig['columns']] extends [never] ? {}\n\t\t\t\t\t\t: TTableConfig['columns']\n\t\t\t\t>,\n\t\t\t\toperators: { sql: Operators['sql'] },\n\t\t\t) => Record<string, SQL.Aliased>);\n\t}\n\t& (TRelationType extends 'many' ?\n\t\t\t& {\n\t\t\t\twhere?:\n\t\t\t\t\t| SQL\n\t\t\t\t\t| undefined\n\t\t\t\t\t| ((\n\t\t\t\t\t\tfields: Simplify<\n\t\t\t\t\t\t\t[TTableConfig['columns']] extends [never] ? {}\n\t\t\t\t\t\t\t\t: TTableConfig['columns']\n\t\t\t\t\t\t>,\n\t\t\t\t\t\toperators: Operators,\n\t\t\t\t\t) => SQL | undefined);\n\t\t\t\torderBy?:\n\t\t\t\t\t| ValueOrArray<AnyColumn | SQL>\n\t\t\t\t\t| ((\n\t\t\t\t\t\tfields: Simplify<\n\t\t\t\t\t\t\t[TTableConfig['columns']] extends [never] ? {}\n\t\t\t\t\t\t\t\t: TTableConfig['columns']\n\t\t\t\t\t\t>,\n\t\t\t\t\t\toperators: OrderByOperators,\n\t\t\t\t\t) => ValueOrArray<AnyColumn | SQL>);\n\t\t\t\tlimit?: number | Placeholder;\n\t\t\t}\n\t\t\t& (TIsRoot extends true ? {\n\t\t\t\t\toffset?: number | Placeholder;\n\t\t\t\t}\n\t\t\t\t: {})\n\t\t: {});\n\nexport interface TableRelationalConfig {\n\ttsName: string;\n\tdbName: string;\n\tcolumns: Record<string, Column>;\n\trelations: Record<string, Relation>;\n\tprimaryKey: AnyColumn[];\n\tschema?: string;\n}\n\nexport type TablesRelationalConfig = Record<string, TableRelationalConfig>;\n\nexport interface RelationalSchemaConfig<\n\tTSchema extends TablesRelationalConfig,\n> {\n\tfullSchema: Record<string, unknown>;\n\tschema: TSchema;\n\ttableNamesMap: Record<string, string>;\n}\n\nexport type ExtractTablesWithRelations<\n\tTSchema extends Record<string, unknown>,\n> = {\n\t[\n\t\tK in keyof TSchema as TSchema[K] extends Table ? K\n\t\t\t: never\n\t]: TSchema[K] extends Table ? {\n\t\t\ttsName: K & string;\n\t\t\tdbName: TSchema[K]['_']['name'];\n\t\t\tcolumns: TSchema[K]['_']['columns'];\n\t\t\trelations: ExtractTableRelationsFromSchema<\n\t\t\t\tTSchema,\n\t\t\t\tTSchema[K]['_']['name']\n\t\t\t>;\n\t\t\tprimaryKey: AnyColumn[];\n\t\t}\n\t\t: never;\n};\n\nexport type ReturnTypeOrValue<T> = T extends (...args: any[]) => infer R ? R\n\t: T;\n\nexport type BuildRelationResult<\n\tTSchema extends TablesRelationalConfig,\n\tTInclude,\n\tTRelations extends Record<string, Relation>,\n> = {\n\t[\n\t\tK in\n\t\t\t& NonUndefinedKeysOnly<TInclude>\n\t\t\t& keyof TRelations\n\t]: TRelations[K] extends infer TRel extends Relation ? BuildQueryResult<\n\t\t\tTSchema,\n\t\t\tFindTableByDBName<TSchema, TRel['referencedTableName']>,\n\t\t\tAssume<TInclude[K], true | Record<string, unknown>>\n\t\t> extends infer TResult ? TRel extends One ?\n\t\t\t\t\t| TResult\n\t\t\t\t\t| (Equal<TRel['isNullable'], false> extends true ? null : never)\n\t\t\t: TResult[]\n\t\t: never\n\t\t: never;\n};\n\nexport type NonUndefinedKeysOnly<T> =\n\t& ExtractObjectValues<\n\t\t{\n\t\t\t[K in keyof T as T[K] extends undefined ? never : K]: K;\n\t\t}\n\t>\n\t& keyof T;\n\nexport type BuildQueryResult<\n\tTSchema extends TablesRelationalConfig,\n\tTTableConfig extends TableRelationalConfig,\n\tTFullSelection extends true | Record<string, unknown>,\n> = Equal<TFullSelection, true> extends true ? InferModelFromColumns<TTableConfig['columns']>\n\t: TFullSelection extends Record<string, unknown> ? Simplify<\n\t\t\t& (TFullSelection['columns'] extends Record<string, unknown> ? InferModelFromColumns<\n\t\t\t\t\t{\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\tK in Equal<\n\t\t\t\t\t\t\t\tExclude<\n\t\t\t\t\t\t\t\t\tTFullSelection['columns'][\n\t\t\t\t\t\t\t\t\t\t& keyof TFullSelection['columns']\n\t\t\t\t\t\t\t\t\t\t& keyof TTableConfig['columns']\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\tundefined\n\t\t\t\t\t\t\t\t>,\n\t\t\t\t\t\t\t\tfalse\n\t\t\t\t\t\t\t> extends true ? Exclude<\n\t\t\t\t\t\t\t\t\tkeyof TTableConfig['columns'],\n\t\t\t\t\t\t\t\t\tNonUndefinedKeysOnly<TFullSelection['columns']>\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t:\n\t\t\t\t\t\t\t\t\t& {\n\t\t\t\t\t\t\t\t\t\t[K in keyof TFullSelection['columns']]: Equal<\n\t\t\t\t\t\t\t\t\t\t\tTFullSelection['columns'][K],\n\t\t\t\t\t\t\t\t\t\t\ttrue\n\t\t\t\t\t\t\t\t\t\t> extends true ? K\n\t\t\t\t\t\t\t\t\t\t\t: never;\n\t\t\t\t\t\t\t\t\t}[keyof TFullSelection['columns']]\n\t\t\t\t\t\t\t\t\t& keyof TTableConfig['columns']\n\t\t\t\t\t\t]: TTableConfig['columns'][K];\n\t\t\t\t\t}\n\t\t\t\t>\n\t\t\t\t: InferModelFromColumns<TTableConfig['columns']>)\n\t\t\t& (TFullSelection['extras'] extends\n\t\t\t\t| Record<string, unknown>\n\t\t\t\t| ((...args: any[]) => Record<string, unknown>) ? {\n\t\t\t\t\t[\n\t\t\t\t\t\tK in NonUndefinedKeysOnly<\n\t\t\t\t\t\t\tReturnTypeOrValue<TFullSelection['extras']>\n\t\t\t\t\t\t>\n\t\t\t\t\t]: Assume<\n\t\t\t\t\t\tReturnTypeOrValue<TFullSelection['extras']>[K],\n\t\t\t\t\t\tSQL.Aliased\n\t\t\t\t\t>['_']['type'];\n\t\t\t\t}\n\t\t\t\t: {})\n\t\t\t& (TFullSelection['with'] extends Record<string, unknown> ? BuildRelationResult<\n\t\t\t\t\tTSchema,\n\t\t\t\t\tTFullSelection['with'],\n\t\t\t\t\tTTableConfig['relations']\n\t\t\t\t>\n\t\t\t\t: {})\n\t\t>\n\t: never;\n\nexport interface RelationConfig<\n\tTTableName extends string,\n\tTForeignTableName extends string,\n\tTColumns extends AnyColumn<{ tableName: TTableName }>[],\n> {\n\trelationName?: string;\n\tfields: TColumns;\n\treferences: ColumnsWithTable<TTableName, TForeignTableName, TColumns>;\n}\n\nexport function extractTablesRelationalConfig<\n\tTTables extends TablesRelationalConfig,\n>(\n\tschema: Record<string, unknown>,\n\tconfigHelpers: (table: Table) => any,\n): { tables: TTables; tableNamesMap: Record<string, string> } {\n\tif (\n\t\tObject.keys(schema).length === 1\n\t\t&& 'default' in schema\n\t\t&& !is(schema['default'], Table)\n\t) {\n\t\tschema = schema['default'] as Record<string, unknown>;\n\t}\n\n\t// table DB name -> schema table key\n\tconst tableNamesMap: Record<string, string> = {};\n\t// Table relations found before their tables - need to buffer them until we know the schema table key\n\tconst relationsBuffer: Record<\n\t\tstring,\n\t\t{ relations: Record<string, Relation>; primaryKey?: AnyColumn[] }\n\t> = {};\n\tconst tablesConfig: TablesRelationalConfig = {};\n\tfor (const [key, value] of Object.entries(schema)) {\n\t\tif (is(value, Table)) {\n\t\t\tconst dbName = getTableUniqueName(value);\n\t\t\tconst bufferedRelations = relationsBuffer[dbName];\n\t\t\ttableNamesMap[dbName] = key;\n\t\t\ttablesConfig[key] = {\n\t\t\t\ttsName: key,\n\t\t\t\tdbName: value[Table.Symbol.Name],\n\t\t\t\tschema: value[Table.Symbol.Schema],\n\t\t\t\tcolumns: value[Table.Symbol.Columns],\n\t\t\t\trelations: bufferedRelations?.relations ?? {},\n\t\t\t\tprimaryKey: bufferedRelations?.primaryKey ?? [],\n\t\t\t};\n\n\t\t\t// Fill in primary keys\n\t\t\tfor (\n\t\t\t\tconst column of Object.values(\n\t\t\t\t\t(value as Table)[Table.Symbol.Columns],\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tif (column.primary) {\n\t\t\t\t\ttablesConfig[key]!.primaryKey.push(column);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst extraConfig = value[Table.Symbol.ExtraConfigBuilder]?.((value as Table)[Table.Symbol.ExtraConfigColumns]);\n\t\t\tif (extraConfig) {\n\t\t\t\tfor (const configEntry of Object.values(extraConfig)) {\n\t\t\t\t\tif (is(configEntry, PrimaryKeyBuilder)) {\n\t\t\t\t\t\ttablesConfig[key]!.primaryKey.push(...configEntry.columns);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (is(value, Relations)) {\n\t\t\tconst dbName = getTableUniqueName(value.table);\n\t\t\tconst tableName = tableNamesMap[dbName];\n\t\t\tconst relations: Record<string, Relation> = value.config(\n\t\t\t\tconfigHelpers(value.table),\n\t\t\t);\n\t\t\tlet primaryKey: AnyColumn[] | undefined;\n\n\t\t\tfor (const [relationName, relation] of Object.entries(relations)) {\n\t\t\t\tif (tableName) {\n\t\t\t\t\tconst tableConfig = tablesConfig[tableName]!;\n\t\t\t\t\ttableConfig.relations[relationName] = relation;\n\t\t\t\t\tif (primaryKey) {\n\t\t\t\t\t\ttableConfig.primaryKey.push(...primaryKey);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (!(dbName in relationsBuffer)) {\n\t\t\t\t\t\trelationsBuffer[dbName] = {\n\t\t\t\t\t\t\trelations: {},\n\t\t\t\t\t\t\tprimaryKey,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\trelationsBuffer[dbName]!.relations[relationName] = relation;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn { tables: tablesConfig as TTables, tableNamesMap };\n}\n\nexport function relations<\n\tTTableName extends string,\n\tTRelations extends Record<string, Relation<any>>,\n>(\n\ttable: AnyTable<{ name: TTableName }>,\n\trelations: (helpers: TableRelationsHelpers<TTableName>) => TRelations,\n): Relations<TTableName, TRelations> {\n\treturn new Relations<TTableName, TRelations>(\n\t\ttable,\n\t\t(helpers: TableRelationsHelpers<TTableName>) =>\n\t\t\tObject.fromEntries(\n\t\t\t\tObject.entries(relations(helpers)).map(([key, value]) => [\n\t\t\t\t\tkey,\n\t\t\t\t\tvalue.withFieldName(key),\n\t\t\t\t]),\n\t\t\t) as TRelations,\n\t);\n}\n\nexport function createOne<TTableName extends string>(sourceTable: Table) {\n\treturn function one<\n\t\tTForeignTable extends Table,\n\t\tTColumns extends [\n\t\t\tAnyColumn<{ tableName: TTableName }>,\n\t\t\t...AnyColumn<{ tableName: TTableName }>[],\n\t\t],\n\t>(\n\t\ttable: TForeignTable,\n\t\tconfig?: RelationConfig<TTableName, TForeignTable['_']['name'], TColumns>,\n\t): One<\n\t\tTForeignTable['_']['name'],\n\t\tEqual<TColumns[number]['_']['notNull'], true>\n\t> {\n\t\treturn new One(\n\t\t\tsourceTable,\n\t\t\ttable,\n\t\t\tconfig,\n\t\t\t(config?.fields.reduce<boolean>((res, f) => res && f.notNull, true)\n\t\t\t\t?? false) as Equal<TColumns[number]['_']['notNull'], true>,\n\t\t);\n\t};\n}\n\nexport function createMany(sourceTable: Table) {\n\treturn function many<TForeignTable extends Table>(\n\t\treferencedTable: TForeignTable,\n\t\tconfig?: { relationName: string },\n\t): Many<TForeignTable['_']['name']> {\n\t\treturn new Many(sourceTable, referencedTable, config);\n\t};\n}\n\nexport interface NormalizedRelation {\n\tfields: AnyColumn[];\n\treferences: AnyColumn[];\n}\n\nexport function normalizeRelation(\n\tschema: TablesRelationalConfig,\n\ttableNamesMap: Record<string, string>,\n\trelation: Relation,\n): NormalizedRelation {\n\tif (is(relation, One) && relation.config) {\n\t\treturn {\n\t\t\tfields: relation.config.fields,\n\t\t\treferences: relation.config.references,\n\t\t};\n\t}\n\n\tconst referencedTableTsName = tableNamesMap[getTableUniqueName(relation.referencedTable)];\n\tif (!referencedTableTsName) {\n\t\tthrow new Error(\n\t\t\t`Table \"${relation.referencedTable[Table.Symbol.Name]}\" not found in schema`,\n\t\t);\n\t}\n\n\tconst referencedTableConfig = schema[referencedTableTsName];\n\tif (!referencedTableConfig) {\n\t\tthrow new Error(`Table \"${referencedTableTsName}\" not found in schema`);\n\t}\n\n\tconst sourceTable = relation.sourceTable;\n\tconst sourceTableTsName = tableNamesMap[getTableUniqueName(sourceTable)];\n\tif (!sourceTableTsName) {\n\t\tthrow new Error(\n\t\t\t`Table \"${sourceTable[Table.Symbol.Name]}\" not found in schema`,\n\t\t);\n\t}\n\n\tconst reverseRelations: Relation[] = [];\n\tfor (\n\t\tconst referencedTableRelation of Object.values(\n\t\t\treferencedTableConfig.relations,\n\t\t)\n\t) {\n\t\tif (\n\t\t\t(relation.relationName\n\t\t\t\t&& relation !== referencedTableRelation\n\t\t\t\t&& referencedTableRelation.relationName === relation.relationName)\n\t\t\t|| (!relation.relationName\n\t\t\t\t&& referencedTableRelation.referencedTable === relation.sourceTable)\n\t\t) {\n\t\t\treverseRelations.push(referencedTableRelation);\n\t\t}\n\t}\n\n\tif (reverseRelations.length > 1) {\n\t\tthrow relation.relationName\n\t\t\t? new Error(\n\t\t\t\t`There are multiple relations with name \"${relation.relationName}\" in table \"${referencedTableTsName}\"`,\n\t\t\t)\n\t\t\t: new Error(\n\t\t\t\t`There are multiple relations between \"${referencedTableTsName}\" and \"${\n\t\t\t\t\trelation.sourceTable[Table.Symbol.Name]\n\t\t\t\t}\". Please specify relation name`,\n\t\t\t);\n\t}\n\n\tif (\n\t\treverseRelations[0]\n\t\t&& is(reverseRelations[0], One)\n\t\t&& reverseRelations[0].config\n\t) {\n\t\treturn {\n\t\t\tfields: reverseRelations[0].config.references,\n\t\t\treferences: reverseRelations[0].config.fields,\n\t\t};\n\t}\n\n\tthrow new Error(\n\t\t`There is not enough information to infer relation \"${sourceTableTsName}.${relation.fieldName}\"`,\n\t);\n}\n\nexport function createTableRelationsHelpers<TTableName extends string>(\n\tsourceTable: AnyTable<{ name: TTableName }>,\n) {\n\treturn {\n\t\tone: createOne<TTableName>(sourceTable),\n\t\tmany: createMany(sourceTable),\n\t};\n}\n\nexport type TableRelationsHelpers<TTableName extends string> = ReturnType<\n\ttypeof createTableRelationsHelpers<TTableName>\n>;\n\nexport interface BuildRelationalQueryResult<\n\tTTable extends Table = Table,\n\tTColumn extends Column = Column,\n> {\n\ttableTsKey: string;\n\tselection: {\n\t\tdbKey: string;\n\t\ttsKey: string;\n\t\tfield: TColumn | SQL | SQL.Aliased;\n\t\trelationTableTsKey: string | undefined;\n\t\tisJson: boolean;\n\t\tisExtra?: boolean;\n\t\tselection: BuildRelationalQueryResult<TTable>['selection'];\n\t}[];\n\tsql: TTable | SQL;\n}\n\nexport function mapRelationalRow(\n\ttablesConfig: TablesRelationalConfig,\n\ttableConfig: TableRelationalConfig,\n\trow: unknown[],\n\tbuildQueryResultSelection: BuildRelationalQueryResult['selection'],\n\tmapColumnValue: (value: unknown) => unknown = (value) => value,\n): Record<string, unknown> {\n\tconst result: Record<string, unknown> = {};\n\n\tfor (\n\t\tconst [\n\t\t\tselectionItemIndex,\n\t\t\tselectionItem,\n\t\t] of buildQueryResultSelection.entries()\n\t) {\n\t\tif (selectionItem.isJson) {\n\t\t\tconst relation = tableConfig.relations[selectionItem.tsKey]!;\n\t\t\tconst rawSubRows = row[selectionItemIndex] as\n\t\t\t\t| unknown[]\n\t\t\t\t| null\n\t\t\t\t| [null]\n\t\t\t\t| string;\n\t\t\tconst subRows = typeof rawSubRows === 'string'\n\t\t\t\t? (JSON.parse(rawSubRows) as unknown[])\n\t\t\t\t: rawSubRows;\n\t\t\tresult[selectionItem.tsKey] = is(relation, One)\n\t\t\t\t? subRows\n\t\t\t\t\t&& mapRelationalRow(\n\t\t\t\t\t\ttablesConfig,\n\t\t\t\t\t\ttablesConfig[selectionItem.relationTableTsKey!]!,\n\t\t\t\t\t\tsubRows,\n\t\t\t\t\t\tselectionItem.selection,\n\t\t\t\t\t\tmapColumnValue,\n\t\t\t\t\t)\n\t\t\t\t: (subRows as unknown[][]).map((subRow) =>\n\t\t\t\t\tmapRelationalRow(\n\t\t\t\t\t\ttablesConfig,\n\t\t\t\t\t\ttablesConfig[selectionItem.relationTableTsKey!]!,\n\t\t\t\t\t\tsubRow,\n\t\t\t\t\t\tselectionItem.selection,\n\t\t\t\t\t\tmapColumnValue,\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t} else {\n\t\t\tconst value = mapColumnValue(row[selectionItemIndex]);\n\t\t\tconst field = selectionItem.field!;\n\t\t\tlet decoder;\n\t\t\tif (is(field, Column)) {\n\t\t\t\tdecoder = field;\n\t\t\t} else if (is(field, SQL)) {\n\t\t\t\tdecoder = field.decoder;\n\t\t\t} else {\n\t\t\t\tdecoder = field.sql.decoder;\n\t\t\t}\n\t\t\tresult[selectionItem.tsKey] = value === null ? null : decoder.mapFromDriverValue(value);\n\t\t}\n\t}\n\n\treturn result;\n}\n","import { entityKind } from '~/entity.ts';\nimport { type ColumnsSelection, View } from '~/sql/sql.ts';\n\nexport abstract class PgViewBase<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> extends View<TName, TExisting, TSelectedFields> {\n\tstatic override readonly [entityKind]: string = 'PgViewBase';\n\n\tdeclare readonly _: View<TName, TExisting, TSelectedFields>['_'] & {\n\t\treadonly viewBrand: 'PgViewBase';\n\t};\n}\n","import { aliasedTable, aliasedTableColumn, mapColumnsInAliasedSQLToAlias, mapColumnsInSQLToAlias } from '~/alias.ts';\nimport { CasingCache } from '~/casing.ts';\nimport { Column } from '~/column.ts';\nimport { entityKind, is } from '~/entity.ts';\nimport { DrizzleError } from '~/errors.ts';\nimport type { MigrationConfig, MigrationMeta } from '~/migrator.ts';\nimport {\n\tPgColumn,\n\tPgDate,\n\tPgDateString,\n\tPgJson,\n\tPgJsonb,\n\tPgNumeric,\n\tPgTime,\n\tPgTimestamp,\n\tPgTimestampString,\n\tPgUUID,\n} from '~/pg-core/columns/index.ts';\nimport type {\n\tAnyPgSelectQueryBuilder,\n\tPgDeleteConfig,\n\tPgInsertConfig,\n\tPgSelectJoinConfig,\n\tPgUpdateConfig,\n} from '~/pg-core/query-builders/index.ts';\nimport type { PgSelectConfig, SelectedFieldsOrdered } from '~/pg-core/query-builders/select.types.ts';\nimport { PgTable } from '~/pg-core/table.ts';\nimport {\n\ttype BuildRelationalQueryResult,\n\ttype DBQueryConfig,\n\tgetOperators,\n\tgetOrderByOperators,\n\tMany,\n\tnormalizeRelation,\n\tOne,\n\ttype Relation,\n\ttype TableRelationalConfig,\n\ttype TablesRelationalConfig,\n} from '~/relations.ts';\nimport { and, eq, View } from '~/sql/index.ts';\nimport {\n\ttype DriverValueEncoder,\n\ttype Name,\n\tParam,\n\ttype QueryTypingsValue,\n\ttype QueryWithTypings,\n\tSQL,\n\tsql,\n\ttype SQLChunk,\n} from '~/sql/sql.ts';\nimport { Subquery } from '~/subquery.ts';\nimport { getTableName, getTableUniqueName, Table } from '~/table.ts';\nimport { type Casing, orderSelectedFields, type UpdateSet } from '~/utils.ts';\nimport { ViewBaseConfig } from '~/view-common.ts';\nimport type { PgSession } from './session.ts';\nimport { PgViewBase } from './view-base.ts';\nimport type { PgMaterializedView } from './view.ts';\n\nexport interface PgDialectConfig {\n\tcasing?: Casing;\n}\n\nexport class PgDialect {\n\tstatic readonly [entityKind]: string = 'PgDialect';\n\n\t/** @internal */\n\treadonly casing: CasingCache;\n\n\tconstructor(config?: PgDialectConfig) {\n\t\tthis.casing = new CasingCache(config?.casing);\n\t}\n\n\tasync migrate(migrations: MigrationMeta[], session: PgSession, config: string | MigrationConfig): Promise<void> {\n\t\tconst migrationsTable = typeof config === 'string'\n\t\t\t? '__drizzle_migrations'\n\t\t\t: config.migrationsTable ?? '__drizzle_migrations';\n\t\tconst migrationsSchema = typeof config === 'string' ? 'drizzle' : config.migrationsSchema ?? 'drizzle';\n\t\tconst migrationTableCreate = sql`\n\t\t\tCREATE TABLE IF NOT EXISTS ${sql.identifier(migrationsSchema)}.${sql.identifier(migrationsTable)} (\n\t\t\t\tid SERIAL PRIMARY KEY,\n\t\t\t\thash text NOT NULL,\n\t\t\t\tcreated_at bigint\n\t\t\t)\n\t\t`;\n\t\tawait session.execute(sql`CREATE SCHEMA IF NOT EXISTS ${sql.identifier(migrationsSchema)}`);\n\t\tawait session.execute(migrationTableCreate);\n\n\t\tconst dbMigrations = await session.all<{ id: number; hash: string; created_at: string }>(\n\t\t\tsql`select id, hash, created_at from ${sql.identifier(migrationsSchema)}.${\n\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t} order by created_at desc limit 1`,\n\t\t);\n\n\t\tconst lastDbMigration = dbMigrations[0];\n\t\tawait session.transaction(async (tx) => {\n\t\t\tfor await (const migration of migrations) {\n\t\t\t\tif (\n\t\t\t\t\t!lastDbMigration\n\t\t\t\t\t|| Number(lastDbMigration.created_at) < migration.folderMillis\n\t\t\t\t) {\n\t\t\t\t\tfor (const stmt of migration.sql) {\n\t\t\t\t\t\tawait tx.execute(sql.raw(stmt));\n\t\t\t\t\t}\n\t\t\t\t\tawait tx.execute(\n\t\t\t\t\t\tsql`insert into ${sql.identifier(migrationsSchema)}.${\n\t\t\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t\t\t} (\"hash\", \"created_at\") values(${migration.hash}, ${migration.folderMillis})`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tescapeName(name: string): string {\n\t\treturn `\"${name}\"`;\n\t}\n\n\tescapeParam(num: number): string {\n\t\treturn `$${num + 1}`;\n\t}\n\n\tescapeString(str: string): string {\n\t\treturn `'${str.replace(/'/g, \"''\")}'`;\n\t}\n\n\tprivate buildWithCTE(queries: Subquery[] | undefined): SQL | undefined {\n\t\tif (!queries?.length) return undefined;\n\n\t\tconst withSqlChunks = [sql`with `];\n\t\tfor (const [i, w] of queries.entries()) {\n\t\t\twithSqlChunks.push(sql`${sql.identifier(w._.alias)} as (${w._.sql})`);\n\t\t\tif (i < queries.length - 1) {\n\t\t\t\twithSqlChunks.push(sql`, `);\n\t\t\t}\n\t\t}\n\t\twithSqlChunks.push(sql` `);\n\t\treturn sql.join(withSqlChunks);\n\t}\n\n\tbuildDeleteQuery({ table, where, returning, withList }: PgDeleteConfig): SQL {\n\t\tconst withSql = this.buildWithCTE(withList);\n\n\t\tconst returningSql = returning\n\t\t\t? sql` returning ${this.buildSelection(returning, { isSingleTable: true })}`\n\t\t\t: undefined;\n\n\t\tconst whereSql = where ? sql` where ${where}` : undefined;\n\n\t\treturn sql`${withSql}delete from ${table}${whereSql}${returningSql}`;\n\t}\n\n\tbuildUpdateSet(table: PgTable, set: UpdateSet): SQL {\n\t\tconst tableColumns = table[Table.Symbol.Columns];\n\n\t\tconst columnNames = Object.keys(tableColumns).filter((colName) =>\n\t\t\tset[colName] !== undefined || tableColumns[colName]?.onUpdateFn !== undefined\n\t\t);\n\n\t\tconst setSize = columnNames.length;\n\t\treturn sql.join(columnNames.flatMap((colName, i) => {\n\t\t\tconst col = tableColumns[colName]!;\n\n\t\t\tconst value = set[colName] ?? sql.param(col.onUpdateFn!(), col);\n\t\t\tconst res = sql`${sql.identifier(this.casing.getColumnCasing(col))} = ${value}`;\n\n\t\t\tif (i < setSize - 1) {\n\t\t\t\treturn [res, sql.raw(', ')];\n\t\t\t}\n\t\t\treturn [res];\n\t\t}));\n\t}\n\n\tbuildUpdateQuery({ table, set, where, returning, withList, from, joins }: PgUpdateConfig): SQL {\n\t\tconst withSql = this.buildWithCTE(withList);\n\n\t\tconst tableName = table[PgTable.Symbol.Name];\n\t\tconst tableSchema = table[PgTable.Symbol.Schema];\n\t\tconst origTableName = table[PgTable.Symbol.OriginalName];\n\t\tconst alias = tableName === origTableName ? undefined : tableName;\n\t\tconst tableSql = sql`${tableSchema ? sql`${sql.identifier(tableSchema)}.` : undefined}${\n\t\t\tsql.identifier(origTableName)\n\t\t}${alias && sql` ${sql.identifier(alias)}`}`;\n\n\t\tconst setSql = this.buildUpdateSet(table, set);\n\n\t\tconst fromSql = from && sql.join([sql.raw(' from '), this.buildFromTable(from)]);\n\n\t\tconst joinsSql = this.buildJoins(joins);\n\n\t\tconst returningSql = returning\n\t\t\t? sql` returning ${this.buildSelection(returning, { isSingleTable: !from })}`\n\t\t\t: undefined;\n\n\t\tconst whereSql = where ? sql` where ${where}` : undefined;\n\n\t\treturn sql`${withSql}update ${tableSql} set ${setSql}${fromSql}${joinsSql}${whereSql}${returningSql}`;\n\t}\n\n\t/**\n\t * Builds selection SQL with provided fields/expressions\n\t *\n\t * Examples:\n\t *\n\t * `select <selection> from`\n\t *\n\t * `insert ... returning <selection>`\n\t *\n\t * If `isSingleTable` is true, then columns won't be prefixed with table name\n\t */\n\tprivate buildSelection(\n\t\tfields: SelectedFieldsOrdered,\n\t\t{ isSingleTable = false }: { isSingleTable?: boolean } = {},\n\t): SQL {\n\t\tconst columnsLen = fields.length;\n\n\t\tconst chunks = fields\n\t\t\t.flatMap(({ field }, i) => {\n\t\t\t\tconst chunk: SQLChunk[] = [];\n\n\t\t\t\tif (is(field, SQL.Aliased) && field.isSelectionField) {\n\t\t\t\t\tchunk.push(sql.identifier(field.fieldAlias));\n\t\t\t\t} else if (is(field, SQL.Aliased) || is(field, SQL)) {\n\t\t\t\t\tconst query = is(field, SQL.Aliased) ? field.sql : field;\n\n\t\t\t\t\tif (isSingleTable) {\n\t\t\t\t\t\tchunk.push(\n\t\t\t\t\t\t\tnew SQL(\n\t\t\t\t\t\t\t\tquery.queryChunks.map((c) => {\n\t\t\t\t\t\t\t\t\tif (is(c, PgColumn)) {\n\t\t\t\t\t\t\t\t\t\treturn sql.identifier(this.casing.getColumnCasing(c));\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn c;\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tchunk.push(query);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (is(field, SQL.Aliased)) {\n\t\t\t\t\t\tchunk.push(sql` as ${sql.identifier(field.fieldAlias)}`);\n\t\t\t\t\t}\n\t\t\t\t} else if (is(field, Column)) {\n\t\t\t\t\tif (isSingleTable) {\n\t\t\t\t\t\tchunk.push(sql.identifier(this.casing.getColumnCasing(field)));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tchunk.push(field);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (i < columnsLen - 1) {\n\t\t\t\t\tchunk.push(sql`, `);\n\t\t\t\t}\n\n\t\t\t\treturn chunk;\n\t\t\t});\n\n\t\treturn sql.join(chunks);\n\t}\n\n\tprivate buildJoins(joins: PgSelectJoinConfig[] | undefined): SQL | undefined {\n\t\tif (!joins || joins.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst joinsArray: SQL[] = [];\n\n\t\tfor (const [index, joinMeta] of joins.entries()) {\n\t\t\tif (index === 0) {\n\t\t\t\tjoinsArray.push(sql` `);\n\t\t\t}\n\t\t\tconst table = joinMeta.table;\n\t\t\tconst lateralSql = joinMeta.lateral ? sql` lateral` : undefined;\n\n\t\t\tif (is(table, PgTable)) {\n\t\t\t\tconst tableName = table[PgTable.Symbol.Name];\n\t\t\t\tconst tableSchema = table[PgTable.Symbol.Schema];\n\t\t\t\tconst origTableName = table[PgTable.Symbol.OriginalName];\n\t\t\t\tconst alias = tableName === origTableName ? undefined : joinMeta.alias;\n\t\t\t\tjoinsArray.push(\n\t\t\t\t\tsql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${\n\t\t\t\t\t\ttableSchema ? sql`${sql.identifier(tableSchema)}.` : undefined\n\t\t\t\t\t}${sql.identifier(origTableName)}${alias && sql` ${sql.identifier(alias)}`} on ${joinMeta.on}`,\n\t\t\t\t);\n\t\t\t} else if (is(table, View)) {\n\t\t\t\tconst viewName = table[ViewBaseConfig].name;\n\t\t\t\tconst viewSchema = table[ViewBaseConfig].schema;\n\t\t\t\tconst origViewName = table[ViewBaseConfig].originalName;\n\t\t\t\tconst alias = viewName === origViewName ? undefined : joinMeta.alias;\n\t\t\t\tjoinsArray.push(\n\t\t\t\t\tsql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${\n\t\t\t\t\t\tviewSchema ? sql`${sql.identifier(viewSchema)}.` : undefined\n\t\t\t\t\t}${sql.identifier(origViewName)}${alias && sql` ${sql.identifier(alias)}`} on ${joinMeta.on}`,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tjoinsArray.push(\n\t\t\t\t\tsql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${table} on ${joinMeta.on}`,\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (index < joins.length - 1) {\n\t\t\t\tjoinsArray.push(sql` `);\n\t\t\t}\n\t\t}\n\n\t\treturn sql.join(joinsArray);\n\t}\n\n\tprivate buildFromTable(\n\t\ttable: SQL | Subquery | PgViewBase | PgTable | undefined,\n\t): SQL | Subquery | PgViewBase | PgTable | undefined {\n\t\tif (is(table, Table) && table[Table.Symbol.OriginalName] !== table[Table.Symbol.Name]) {\n\t\t\tlet fullName = sql`${sql.identifier(table[Table.Symbol.OriginalName])}`;\n\t\t\tif (table[Table.Symbol.Schema]) {\n\t\t\t\tfullName = sql`${sql.identifier(table[Table.Symbol.Schema]!)}.${fullName}`;\n\t\t\t}\n\t\t\treturn sql`${fullName} ${sql.identifier(table[Table.Symbol.Name])}`;\n\t\t}\n\n\t\treturn table;\n\t}\n\n\tbuildSelectQuery(\n\t\t{\n\t\t\twithList,\n\t\t\tfields,\n\t\t\tfieldsFlat,\n\t\t\twhere,\n\t\t\thaving,\n\t\t\ttable,\n\t\t\tjoins,\n\t\t\torderBy,\n\t\t\tgroupBy,\n\t\t\tlimit,\n\t\t\toffset,\n\t\t\tlockingClause,\n\t\t\tdistinct,\n\t\t\tsetOperators,\n\t\t}: PgSelectConfig,\n\t): SQL {\n\t\tconst fieldsList = fieldsFlat ?? orderSelectedFields<PgColumn>(fields);\n\t\tfor (const f of fieldsList) {\n\t\t\tif (\n\t\t\t\tis(f.field, Column)\n\t\t\t\t&& getTableName(f.field.table)\n\t\t\t\t\t!== (is(table, Subquery)\n\t\t\t\t\t\t? table._.alias\n\t\t\t\t\t\t: is(table, PgViewBase)\n\t\t\t\t\t\t? table[ViewBaseConfig].name\n\t\t\t\t\t\t: is(table, SQL)\n\t\t\t\t\t\t? undefined\n\t\t\t\t\t\t: getTableName(table))\n\t\t\t\t&& !((table) =>\n\t\t\t\t\tjoins?.some(({ alias }) =>\n\t\t\t\t\t\talias === (table[Table.Symbol.IsAlias] ? getTableName(table) : table[Table.Symbol.BaseName])\n\t\t\t\t\t))(f.field.table)\n\t\t\t) {\n\t\t\t\tconst tableName = getTableName(f.field.table);\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Your \"${\n\t\t\t\t\t\tf.path.join('->')\n\t\t\t\t\t}\" field references a column \"${tableName}\".\"${f.field.name}\", but the table \"${tableName}\" is not part of the query! Did you forget to join it?`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tconst isSingleTable = !joins || joins.length === 0;\n\n\t\tconst withSql = this.buildWithCTE(withList);\n\n\t\tlet distinctSql: SQL | undefined;\n\t\tif (distinct) {\n\t\t\tdistinctSql = distinct === true ? sql` distinct` : sql` distinct on (${sql.join(distinct.on, sql`, `)})`;\n\t\t}\n\n\t\tconst selection = this.buildSelection(fieldsList, { isSingleTable });\n\n\t\tconst tableSql = this.buildFromTable(table);\n\n\t\tconst joinsSql = this.buildJoins(joins);\n\n\t\tconst whereSql = where ? sql` where ${where}` : undefined;\n\n\t\tconst havingSql = having ? sql` having ${having}` : undefined;\n\n\t\tlet orderBySql;\n\t\tif (orderBy && orderBy.length > 0) {\n\t\t\torderBySql = sql` order by ${sql.join(orderBy, sql`, `)}`;\n\t\t}\n\n\t\tlet groupBySql;\n\t\tif (groupBy && groupBy.length > 0) {\n\t\t\tgroupBySql = sql` group by ${sql.join(groupBy, sql`, `)}`;\n\t\t}\n\n\t\tconst limitSql = typeof limit === 'object' || (typeof limit === 'number' && limit >= 0)\n\t\t\t? sql` limit ${limit}`\n\t\t\t: undefined;\n\n\t\tconst offsetSql = offset ? sql` offset ${offset}` : undefined;\n\n\t\tconst lockingClauseSql = sql.empty();\n\t\tif (lockingClause) {\n\t\t\tconst clauseSql = sql` for ${sql.raw(lockingClause.strength)}`;\n\t\t\tif (lockingClause.config.of) {\n\t\t\t\tclauseSql.append(\n\t\t\t\t\tsql` of ${\n\t\t\t\t\t\tsql.join(\n\t\t\t\t\t\t\tArray.isArray(lockingClause.config.of) ? lockingClause.config.of : [lockingClause.config.of],\n\t\t\t\t\t\t\tsql`, `,\n\t\t\t\t\t\t)\n\t\t\t\t\t}`,\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (lockingClause.config.noWait) {\n\t\t\t\tclauseSql.append(sql` no wait`);\n\t\t\t} else if (lockingClause.config.skipLocked) {\n\t\t\t\tclauseSql.append(sql` skip locked`);\n\t\t\t}\n\t\t\tlockingClauseSql.append(clauseSql);\n\t\t}\n\t\tconst finalQuery =\n\t\t\tsql`${withSql}select${distinctSql} ${selection} from ${tableSql}${joinsSql}${whereSql}${groupBySql}${havingSql}${orderBySql}${limitSql}${offsetSql}${lockingClauseSql}`;\n\n\t\tif (setOperators.length > 0) {\n\t\t\treturn this.buildSetOperations(finalQuery, setOperators);\n\t\t}\n\n\t\treturn finalQuery;\n\t}\n\n\tbuildSetOperations(leftSelect: SQL, setOperators: PgSelectConfig['setOperators']): SQL {\n\t\tconst [setOperator, ...rest] = setOperators;\n\n\t\tif (!setOperator) {\n\t\t\tthrow new Error('Cannot pass undefined values to any set operator');\n\t\t}\n\n\t\tif (rest.length === 0) {\n\t\t\treturn this.buildSetOperationQuery({ leftSelect, setOperator });\n\t\t}\n\n\t\t// Some recursive magic here\n\t\treturn this.buildSetOperations(\n\t\t\tthis.buildSetOperationQuery({ leftSelect, setOperator }),\n\t\t\trest,\n\t\t);\n\t}\n\n\tbuildSetOperationQuery({\n\t\tleftSelect,\n\t\tsetOperator: { type, isAll, rightSelect, limit, orderBy, offset },\n\t}: { leftSelect: SQL; setOperator: PgSelectConfig['setOperators'][number] }): SQL {\n\t\tconst leftChunk = sql`(${leftSelect.getSQL()}) `;\n\t\tconst rightChunk = sql`(${rightSelect.getSQL()})`;\n\n\t\tlet orderBySql;\n\t\tif (orderBy && orderBy.length > 0) {\n\t\t\tconst orderByValues: (SQL<unknown> | Name)[] = [];\n\n\t\t\t// The next bit is necessary because the sql operator replaces ${table.column} with `table`.`column`\n\t\t\t// which is invalid Sql syntax, Table from one of the SELECTs cannot be used in global ORDER clause\n\t\t\tfor (const singleOrderBy of orderBy) {\n\t\t\t\tif (is(singleOrderBy, PgColumn)) {\n\t\t\t\t\torderByValues.push(sql.identifier(singleOrderBy.name));\n\t\t\t\t} else if (is(singleOrderBy, SQL)) {\n\t\t\t\t\tfor (let i = 0; i < singleOrderBy.queryChunks.length; i++) {\n\t\t\t\t\t\tconst chunk = singleOrderBy.queryChunks[i];\n\n\t\t\t\t\t\tif (is(chunk, PgColumn)) {\n\t\t\t\t\t\t\tsingleOrderBy.queryChunks[i] = sql.identifier(chunk.name);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\torderByValues.push(sql`${singleOrderBy}`);\n\t\t\t\t} else {\n\t\t\t\t\torderByValues.push(sql`${singleOrderBy}`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\torderBySql = sql` order by ${sql.join(orderByValues, sql`, `)} `;\n\t\t}\n\n\t\tconst limitSql = typeof limit === 'object' || (typeof limit === 'number' && limit >= 0)\n\t\t\t? sql` limit ${limit}`\n\t\t\t: undefined;\n\n\t\tconst operatorChunk = sql.raw(`${type} ${isAll ? 'all ' : ''}`);\n\n\t\tconst offsetSql = offset ? sql` offset ${offset}` : undefined;\n\n\t\treturn sql`${leftChunk}${operatorChunk}${rightChunk}${orderBySql}${limitSql}${offsetSql}`;\n\t}\n\n\tbuildInsertQuery(\n\t\t{ table, values: valuesOrSelect, onConflict, returning, withList, select, overridingSystemValue_ }: PgInsertConfig,\n\t): SQL {\n\t\tconst valuesSqlList: ((SQLChunk | SQL)[] | SQL)[] = [];\n\t\tconst columns: Record<string, PgColumn> = table[Table.Symbol.Columns];\n\n\t\tconst colEntries: [string, PgColumn][] = Object.entries(columns).filter(([_, col]) => !col.shouldDisableInsert());\n\n\t\tconst insertOrder = colEntries.map(\n\t\t\t([, column]) => sql.identifier(this.casing.getColumnCasing(column)),\n\t\t);\n\n\t\tif (select) {\n\t\t\tconst select = valuesOrSelect as AnyPgSelectQueryBuilder | SQL;\n\n\t\t\tif (is(select, SQL)) {\n\t\t\t\tvaluesSqlList.push(select);\n\t\t\t} else {\n\t\t\t\tvaluesSqlList.push(select.getSQL());\n\t\t\t}\n\t\t} else {\n\t\t\tconst values = valuesOrSelect as Record<string, Param | SQL>[];\n\t\t\tvaluesSqlList.push(sql.raw('values '));\n\n\t\t\tfor (const [valueIndex, value] of values.entries()) {\n\t\t\t\tconst valueList: (SQLChunk | SQL)[] = [];\n\t\t\t\tfor (const [fieldName, col] of colEntries) {\n\t\t\t\t\tconst colValue = value[fieldName];\n\t\t\t\t\tif (colValue === undefined || (is(colValue, Param) && colValue.value === undefined)) {\n\t\t\t\t\t\t// eslint-disable-next-line unicorn/no-negated-condition\n\t\t\t\t\t\tif (col.defaultFn !== undefined) {\n\t\t\t\t\t\t\tconst defaultFnResult = col.defaultFn();\n\t\t\t\t\t\t\tconst defaultValue = is(defaultFnResult, SQL) ? defaultFnResult : sql.param(defaultFnResult, col);\n\t\t\t\t\t\t\tvalueList.push(defaultValue);\n\t\t\t\t\t\t\t// eslint-disable-next-line unicorn/no-negated-condition\n\t\t\t\t\t\t} else if (!col.default && col.onUpdateFn !== undefined) {\n\t\t\t\t\t\t\tconst onUpdateFnResult = col.onUpdateFn();\n\t\t\t\t\t\t\tconst newValue = is(onUpdateFnResult, SQL) ? onUpdateFnResult : sql.param(onUpdateFnResult, col);\n\t\t\t\t\t\t\tvalueList.push(newValue);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvalueList.push(sql`default`);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvalueList.push(colValue);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvaluesSqlList.push(valueList);\n\t\t\t\tif (valueIndex < values.length - 1) {\n\t\t\t\t\tvaluesSqlList.push(sql`, `);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst withSql = this.buildWithCTE(withList);\n\n\t\tconst valuesSql = sql.join(valuesSqlList);\n\n\t\tconst returningSql = returning\n\t\t\t? sql` returning ${this.buildSelection(returning, { isSingleTable: true })}`\n\t\t\t: undefined;\n\n\t\tconst onConflictSql = onConflict ? sql` on conflict ${onConflict}` : undefined;\n\n\t\tconst overridingSql = overridingSystemValue_ === true ? sql`overriding system value ` : undefined;\n\n\t\treturn sql`${withSql}insert into ${table} ${insertOrder} ${overridingSql}${valuesSql}${onConflictSql}${returningSql}`;\n\t}\n\n\tbuildRefreshMaterializedViewQuery(\n\t\t{ view, concurrently, withNoData }: { view: PgMaterializedView; concurrently?: boolean; withNoData?: boolean },\n\t): SQL {\n\t\tconst concurrentlySql = concurrently ? sql` concurrently` : undefined;\n\t\tconst withNoDataSql = withNoData ? sql` with no data` : undefined;\n\n\t\treturn sql`refresh materialized view${concurrentlySql} ${view}${withNoDataSql}`;\n\t}\n\n\tprepareTyping(encoder: DriverValueEncoder<unknown, unknown>): QueryTypingsValue {\n\t\tif (is(encoder, PgJsonb) || is(encoder, PgJson)) {\n\t\t\treturn 'json';\n\t\t} else if (is(encoder, PgNumeric)) {\n\t\t\treturn 'decimal';\n\t\t} else if (is(encoder, PgTime)) {\n\t\t\treturn 'time';\n\t\t} else if (is(encoder, PgTimestamp) || is(encoder, PgTimestampString)) {\n\t\t\treturn 'timestamp';\n\t\t} else if (is(encoder, PgDate) || is(encoder, PgDateString)) {\n\t\t\treturn 'date';\n\t\t} else if (is(encoder, PgUUID)) {\n\t\t\treturn 'uuid';\n\t\t} else {\n\t\t\treturn 'none';\n\t\t}\n\t}\n\n\tsqlToQuery(sql: SQL, invokeSource?: 'indexes' | undefined): QueryWithTypings {\n\t\treturn sql.toQuery({\n\t\t\tcasing: this.casing,\n\t\t\tescapeName: this.escapeName,\n\t\t\tescapeParam: this.escapeParam,\n\t\t\tescapeString: this.escapeString,\n\t\t\tprepareTyping: this.prepareTyping,\n\t\t\tinvokeSource,\n\t\t});\n\t}\n\n\t// buildRelationalQueryWithPK({\n\t// \tfullSchema,\n\t// \tschema,\n\t// \ttableNamesMap,\n\t// \ttable,\n\t// \ttableConfig,\n\t// \tqueryConfig: config,\n\t// \ttableAlias,\n\t// \tisRoot = false,\n\t// \tjoinOn,\n\t// }: {\n\t// \tfullSchema: Record<string, unknown>;\n\t// \tschema: TablesRelationalConfig;\n\t// \ttableNamesMap: Record<string, string>;\n\t// \ttable: PgTable;\n\t// \ttableConfig: TableRelationalConfig;\n\t// \tqueryConfig: true | DBQueryConfig<'many', true>;\n\t// \ttableAlias: string;\n\t// \tisRoot?: boolean;\n\t// \tjoinOn?: SQL;\n\t// }): BuildRelationalQueryResult<PgTable, PgColumn> {\n\t// \t// For { \"<relation>\": true }, return a table with selection of all columns\n\t// \tif (config === true) {\n\t// \t\tconst selectionEntries = Object.entries(tableConfig.columns);\n\t// \t\tconst selection: BuildRelationalQueryResult<PgTable, PgColumn>['selection'] = selectionEntries.map((\n\t// \t\t\t[key, value],\n\t// \t\t) => ({\n\t// \t\t\tdbKey: value.name,\n\t// \t\t\ttsKey: key,\n\t// \t\t\tfield: value as PgColumn,\n\t// \t\t\trelationTableTsKey: undefined,\n\t// \t\t\tisJson: false,\n\t// \t\t\tselection: [],\n\t// \t\t}));\n\n\t// \t\treturn {\n\t// \t\t\ttableTsKey: tableConfig.tsName,\n\t// \t\t\tsql: table,\n\t// \t\t\tselection,\n\t// \t\t};\n\t// \t}\n\n\t// \t// let selection: BuildRelationalQueryResult<PgTable, PgColumn>['selection'] = [];\n\t// \t// let selectionForBuild = selection;\n\n\t// \tconst aliasedColumns = Object.fromEntries(\n\t// \t\tObject.entries(tableConfig.columns).map(([key, value]) => [key, aliasedTableColumn(value, tableAlias)]),\n\t// \t);\n\n\t// \tconst aliasedRelations = Object.fromEntries(\n\t// \t\tObject.entries(tableConfig.relations).map(([key, value]) => [key, aliasedRelation(value, tableAlias)]),\n\t// \t);\n\n\t// \tconst aliasedFields = Object.assign({}, aliasedColumns, aliasedRelations);\n\n\t// \tlet where, hasUserDefinedWhere;\n\t// \tif (config.where) {\n\t// \t\tconst whereSql = typeof config.where === 'function' ? config.where(aliasedFields, operators) : config.where;\n\t// \t\twhere = whereSql && mapColumnsInSQLToAlias(whereSql, tableAlias);\n\t// \t\thasUserDefinedWhere = !!where;\n\t// \t}\n\t// \twhere = and(joinOn, where);\n\n\t// \t// const fieldsSelection: { tsKey: string; value: PgColumn | SQL.Aliased; isExtra?: boolean }[] = [];\n\t// \tlet joins: Join[] = [];\n\t// \tlet selectedColumns: string[] = [];\n\n\t// \t// Figure out which columns to select\n\t// \tif (config.columns) {\n\t// \t\tlet isIncludeMode = false;\n\n\t// \t\tfor (const [field, value] of Object.entries(config.columns)) {\n\t// \t\t\tif (value === undefined) {\n\t// \t\t\t\tcontinue;\n\t// \t\t\t}\n\n\t// \t\t\tif (field in tableConfig.columns) {\n\t// \t\t\t\tif (!isIncludeMode && value === true) {\n\t// \t\t\t\t\tisIncludeMode = true;\n\t// \t\t\t\t}\n\t// \t\t\t\tselectedColumns.push(field);\n\t// \t\t\t}\n\t// \t\t}\n\n\t// \t\tif (selectedColumns.length > 0) {\n\t// \t\t\tselectedColumns = isIncludeMode\n\t// \t\t\t\t? selectedColumns.filter((c) => config.columns?.[c] === true)\n\t// \t\t\t\t: Object.keys(tableConfig.columns).filter((key) => !selectedColumns.includes(key));\n\t// \t\t}\n\t// \t} else {\n\t// \t\t// Select all columns if selection is not specified\n\t// \t\tselectedColumns = Object.keys(tableConfig.columns);\n\t// \t}\n\n\t// \t// for (const field of selectedColumns) {\n\t// \t// \tconst column = tableConfig.columns[field]! as PgColumn;\n\t// \t// \tfieldsSelection.push({ tsKey: field, value: column });\n\t// \t// }\n\n\t// \tlet initiallySelectedRelations: {\n\t// \t\ttsKey: string;\n\t// \t\tqueryConfig: true | DBQueryConfig<'many', false>;\n\t// \t\trelation: Relation;\n\t// \t}[] = [];\n\n\t// \t// let selectedRelations: BuildRelationalQueryResult<PgTable, PgColumn>['selection'] = [];\n\n\t// \t// Figure out which relations to select\n\t// \tif (config.with) {\n\t// \t\tinitiallySelectedRelations = Object.entries(config.with)\n\t// \t\t\t.filter((entry): entry is [typeof entry[0], NonNullable<typeof entry[1]>] => !!entry[1])\n\t// \t\t\t.map(([tsKey, queryConfig]) => ({ tsKey, queryConfig, relation: tableConfig.relations[tsKey]! }));\n\t// \t}\n\n\t// \tconst manyRelations = initiallySelectedRelations.filter((r) =>\n\t// \t\tis(r.relation, Many)\n\t// \t\t&& (schema[tableNamesMap[r.relation.referencedTable[Table.Symbol.Name]]!]?.primaryKey.length ?? 0) > 0\n\t// \t);\n\t// \t// If this is the last Many relation (or there are no Many relations), we are on the innermost subquery level\n\t// \tconst isInnermostQuery = manyRelations.length < 2;\n\n\t// \tconst selectedExtras: {\n\t// \t\ttsKey: string;\n\t// \t\tvalue: SQL.Aliased;\n\t// \t}[] = [];\n\n\t// \t// Figure out which extras to select\n\t// \tif (isInnermostQuery && config.extras) {\n\t// \t\tconst extras = typeof config.extras === 'function'\n\t// \t\t\t? config.extras(aliasedFields, { sql })\n\t// \t\t\t: config.extras;\n\t// \t\tfor (const [tsKey, value] of Object.entries(extras)) {\n\t// \t\t\tselectedExtras.push({\n\t// \t\t\t\ttsKey,\n\t// \t\t\t\tvalue: mapColumnsInAliasedSQLToAlias(value, tableAlias),\n\t// \t\t\t});\n\t// \t\t}\n\t// \t}\n\n\t// \t// Transform `fieldsSelection` into `selection`\n\t// \t// `fieldsSelection` shouldn't be used after this point\n\t// \t// for (const { tsKey, value, isExtra } of fieldsSelection) {\n\t// \t// \tselection.push({\n\t// \t// \t\tdbKey: is(value, SQL.Aliased) ? value.fieldAlias : tableConfig.columns[tsKey]!.name,\n\t// \t// \t\ttsKey,\n\t// \t// \t\tfield: is(value, Column) ? aliasedTableColumn(value, tableAlias) : value,\n\t// \t// \t\trelationTableTsKey: undefined,\n\t// \t// \t\tisJson: false,\n\t// \t// \t\tisExtra,\n\t// \t// \t\tselection: [],\n\t// \t// \t});\n\t// \t// }\n\n\t// \tlet orderByOrig = typeof config.orderBy === 'function'\n\t// \t\t? config.orderBy(aliasedFields, orderByOperators)\n\t// \t\t: config.orderBy ?? [];\n\t// \tif (!Array.isArray(orderByOrig)) {\n\t// \t\torderByOrig = [orderByOrig];\n\t// \t}\n\t// \tconst orderBy = orderByOrig.map((orderByValue) => {\n\t// \t\tif (is(orderByValue, Column)) {\n\t// \t\t\treturn aliasedTableColumn(orderByValue, tableAlias) as PgColumn;\n\t// \t\t}\n\t// \t\treturn mapColumnsInSQLToAlias(orderByValue, tableAlias);\n\t// \t});\n\n\t// \tconst limit = isInnermostQuery ? config.limit : undefined;\n\t// \tconst offset = isInnermostQuery ? config.offset : undefined;\n\n\t// \t// For non-root queries without additional config except columns, return a table with selection\n\t// \tif (\n\t// \t\t!isRoot\n\t// \t\t&& initiallySelectedRelations.length === 0\n\t// \t\t&& selectedExtras.length === 0\n\t// \t\t&& !where\n\t// \t\t&& orderBy.length === 0\n\t// \t\t&& limit === undefined\n\t// \t\t&& offset === undefined\n\t// \t) {\n\t// \t\treturn {\n\t// \t\t\ttableTsKey: tableConfig.tsName,\n\t// \t\t\tsql: table,\n\t// \t\t\tselection: selectedColumns.map((key) => ({\n\t// \t\t\t\tdbKey: tableConfig.columns[key]!.name,\n\t// \t\t\t\ttsKey: key,\n\t// \t\t\t\tfield: tableConfig.columns[key] as PgColumn,\n\t// \t\t\t\trelationTableTsKey: undefined,\n\t// \t\t\t\tisJson: false,\n\t// \t\t\t\tselection: [],\n\t// \t\t\t})),\n\t// \t\t};\n\t// \t}\n\n\t// \tconst selectedRelationsWithoutPK:\n\n\t// \t// Process all relations without primary keys, because they need to be joined differently and will all be on the same query level\n\t// \tfor (\n\t// \t\tconst {\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tqueryConfig: selectedRelationConfigValue,\n\t// \t\t\trelation,\n\t// \t\t} of initiallySelectedRelations\n\t// \t) {\n\t// \t\tconst normalizedRelation = normalizeRelation(schema, tableNamesMap, relation);\n\t// \t\tconst relationTableName = relation.referencedTable[Table.Symbol.Name];\n\t// \t\tconst relationTableTsName = tableNamesMap[relationTableName]!;\n\t// \t\tconst relationTable = schema[relationTableTsName]!;\n\n\t// \t\tif (relationTable.primaryKey.length > 0) {\n\t// \t\t\tcontinue;\n\t// \t\t}\n\n\t// \t\tconst relationTableAlias = `${tableAlias}_${selectedRelationTsKey}`;\n\t// \t\tconst joinOn = and(\n\t// \t\t\t...normalizedRelation.fields.map((field, i) =>\n\t// \t\t\t\teq(\n\t// \t\t\t\t\taliasedTableColumn(normalizedRelation.references[i]!, relationTableAlias),\n\t// \t\t\t\t\taliasedTableColumn(field, tableAlias),\n\t// \t\t\t\t)\n\t// \t\t\t),\n\t// \t\t);\n\t// \t\tconst builtRelation = this.buildRelationalQueryWithoutPK({\n\t// \t\t\tfullSchema,\n\t// \t\t\tschema,\n\t// \t\t\ttableNamesMap,\n\t// \t\t\ttable: fullSchema[relationTableTsName] as PgTable,\n\t// \t\t\ttableConfig: schema[relationTableTsName]!,\n\t// \t\t\tqueryConfig: selectedRelationConfigValue,\n\t// \t\t\ttableAlias: relationTableAlias,\n\t// \t\t\tjoinOn,\n\t// \t\t\tnestedQueryRelation: relation,\n\t// \t\t});\n\t// \t\tconst field = sql`${sql.identifier(relationTableAlias)}.${sql.identifier('data')}`.as(selectedRelationTsKey);\n\t// \t\tjoins.push({\n\t// \t\t\ton: sql`true`,\n\t// \t\t\ttable: new Subquery(builtRelation.sql as SQL, {}, relationTableAlias),\n\t// \t\t\talias: relationTableAlias,\n\t// \t\t\tjoinType: 'left',\n\t// \t\t\tlateral: true,\n\t// \t\t});\n\t// \t\tselectedRelations.push({\n\t// \t\t\tdbKey: selectedRelationTsKey,\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tfield,\n\t// \t\t\trelationTableTsKey: relationTableTsName,\n\t// \t\t\tisJson: true,\n\t// \t\t\tselection: builtRelation.selection,\n\t// \t\t});\n\t// \t}\n\n\t// \tconst oneRelations = initiallySelectedRelations.filter((r): r is typeof r & { relation: One } =>\n\t// \t\tis(r.relation, One)\n\t// \t);\n\n\t// \t// Process all One relations with PKs, because they can all be joined on the same level\n\t// \tfor (\n\t// \t\tconst {\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tqueryConfig: selectedRelationConfigValue,\n\t// \t\t\trelation,\n\t// \t\t} of oneRelations\n\t// \t) {\n\t// \t\tconst normalizedRelation = normalizeRelation(schema, tableNamesMap, relation);\n\t// \t\tconst relationTableName = relation.referencedTable[Table.Symbol.Name];\n\t// \t\tconst relationTableTsName = tableNamesMap[relationTableName]!;\n\t// \t\tconst relationTableAlias = `${tableAlias}_${selectedRelationTsKey}`;\n\t// \t\tconst relationTable = schema[relationTableTsName]!;\n\n\t// \t\tif (relationTable.primaryKey.length === 0) {\n\t// \t\t\tcontinue;\n\t// \t\t}\n\n\t// \t\tconst joinOn = and(\n\t// \t\t\t...normalizedRelation.fields.map((field, i) =>\n\t// \t\t\t\teq(\n\t// \t\t\t\t\taliasedTableColumn(normalizedRelation.references[i]!, relationTableAlias),\n\t// \t\t\t\t\taliasedTableColumn(field, tableAlias),\n\t// \t\t\t\t)\n\t// \t\t\t),\n\t// \t\t);\n\t// \t\tconst builtRelation = this.buildRelationalQueryWithPK({\n\t// \t\t\tfullSchema,\n\t// \t\t\tschema,\n\t// \t\t\ttableNamesMap,\n\t// \t\t\ttable: fullSchema[relationTableTsName] as PgTable,\n\t// \t\t\ttableConfig: schema[relationTableTsName]!,\n\t// \t\t\tqueryConfig: selectedRelationConfigValue,\n\t// \t\t\ttableAlias: relationTableAlias,\n\t// \t\t\tjoinOn,\n\t// \t\t});\n\t// \t\tconst field = sql`case when ${sql.identifier(relationTableAlias)} is null then null else json_build_array(${\n\t// \t\t\tsql.join(\n\t// \t\t\t\tbuiltRelation.selection.map(({ field }) =>\n\t// \t\t\t\t\tis(field, SQL.Aliased)\n\t// \t\t\t\t\t\t? sql`${sql.identifier(relationTableAlias)}.${sql.identifier(field.fieldAlias)}`\n\t// \t\t\t\t\t\t: is(field, Column)\n\t// \t\t\t\t\t\t? aliasedTableColumn(field, relationTableAlias)\n\t// \t\t\t\t\t\t: field\n\t// \t\t\t\t),\n\t// \t\t\t\tsql`, `,\n\t// \t\t\t)\n\t// \t\t}) end`.as(selectedRelationTsKey);\n\t// \t\tconst isLateralJoin = is(builtRelation.sql, SQL);\n\t// \t\tjoins.push({\n\t// \t\t\ton: isLateralJoin ? sql`true` : joinOn,\n\t// \t\t\ttable: is(builtRelation.sql, SQL)\n\t// \t\t\t\t? new Subquery(builtRelation.sql, {}, relationTableAlias)\n\t// \t\t\t\t: aliasedTable(builtRelation.sql, relationTableAlias),\n\t// \t\t\talias: relationTableAlias,\n\t// \t\t\tjoinType: 'left',\n\t// \t\t\tlateral: is(builtRelation.sql, SQL),\n\t// \t\t});\n\t// \t\tselectedRelations.push({\n\t// \t\t\tdbKey: selectedRelationTsKey,\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tfield,\n\t// \t\t\trelationTableTsKey: relationTableTsName,\n\t// \t\t\tisJson: true,\n\t// \t\t\tselection: builtRelation.selection,\n\t// \t\t});\n\t// \t}\n\n\t// \tlet distinct: PgSelectConfig['distinct'];\n\t// \tlet tableFrom: PgTable | Subquery = table;\n\n\t// \t// Process first Many relation - each one requires a nested subquery\n\t// \tconst manyRelation = manyRelations[0];\n\t// \tif (manyRelation) {\n\t// \t\tconst {\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tqueryConfig: selectedRelationQueryConfig,\n\t// \t\t\trelation,\n\t// \t\t} = manyRelation;\n\n\t// \t\tdistinct = {\n\t// \t\t\ton: tableConfig.primaryKey.map((c) => aliasedTableColumn(c as PgColumn, tableAlias)),\n\t// \t\t};\n\n\t// \t\tconst normalizedRelation = normalizeRelation(schema, tableNamesMap, relation);\n\t// \t\tconst relationTableName = relation.referencedTable[Table.Symbol.Name];\n\t// \t\tconst relationTableTsName = tableNamesMap[relationTableName]!;\n\t// \t\tconst relationTableAlias = `${tableAlias}_${selectedRelationTsKey}`;\n\t// \t\tconst joinOn = and(\n\t// \t\t\t...normalizedRelation.fields.map((field, i) =>\n\t// \t\t\t\teq(\n\t// \t\t\t\t\taliasedTableColumn(normalizedRelation.references[i]!, relationTableAlias),\n\t// \t\t\t\t\taliasedTableColumn(field, tableAlias),\n\t// \t\t\t\t)\n\t// \t\t\t),\n\t// \t\t);\n\n\t// \t\tconst builtRelationJoin = this.buildRelationalQueryWithPK({\n\t// \t\t\tfullSchema,\n\t// \t\t\tschema,\n\t// \t\t\ttableNamesMap,\n\t// \t\t\ttable: fullSchema[relationTableTsName] as PgTable,\n\t// \t\t\ttableConfig: schema[relationTableTsName]!,\n\t// \t\t\tqueryConfig: selectedRelationQueryConfig,\n\t// \t\t\ttableAlias: relationTableAlias,\n\t// \t\t\tjoinOn,\n\t// \t\t});\n\n\t// \t\tconst builtRelationSelectionField = sql`case when ${\n\t// \t\t\tsql.identifier(relationTableAlias)\n\t// \t\t} is null then '[]' else json_agg(json_build_array(${\n\t// \t\t\tsql.join(\n\t// \t\t\t\tbuiltRelationJoin.selection.map(({ field }) =>\n\t// \t\t\t\t\tis(field, SQL.Aliased)\n\t// \t\t\t\t\t\t? sql`${sql.identifier(relationTableAlias)}.${sql.identifier(field.fieldAlias)}`\n\t// \t\t\t\t\t\t: is(field, Column)\n\t// \t\t\t\t\t\t? aliasedTableColumn(field, relationTableAlias)\n\t// \t\t\t\t\t\t: field\n\t// \t\t\t\t),\n\t// \t\t\t\tsql`, `,\n\t// \t\t\t)\n\t// \t\t})) over (partition by ${sql.join(distinct.on, sql`, `)}) end`.as(selectedRelationTsKey);\n\t// \t\tconst isLateralJoin = is(builtRelationJoin.sql, SQL);\n\t// \t\tjoins.push({\n\t// \t\t\ton: isLateralJoin ? sql`true` : joinOn,\n\t// \t\t\ttable: isLateralJoin\n\t// \t\t\t\t? new Subquery(builtRelationJoin.sql as SQL, {}, relationTableAlias)\n\t// \t\t\t\t: aliasedTable(builtRelationJoin.sql as PgTable, relationTableAlias),\n\t// \t\t\talias: relationTableAlias,\n\t// \t\t\tjoinType: 'left',\n\t// \t\t\tlateral: isLateralJoin,\n\t// \t\t});\n\n\t// \t\t// Build the \"from\" subquery with the remaining Many relations\n\t// \t\tconst builtTableFrom = this.buildRelationalQueryWithPK({\n\t// \t\t\tfullSchema,\n\t// \t\t\tschema,\n\t// \t\t\ttableNamesMap,\n\t// \t\t\ttable,\n\t// \t\t\ttableConfig,\n\t// \t\t\tqueryConfig: {\n\t// \t\t\t\t...config,\n\t// \t\t\t\twhere: undefined,\n\t// \t\t\t\torderBy: undefined,\n\t// \t\t\t\tlimit: undefined,\n\t// \t\t\t\toffset: undefined,\n\t// \t\t\t\twith: manyRelations.slice(1).reduce<NonNullable<typeof config['with']>>(\n\t// \t\t\t\t\t(result, { tsKey, queryConfig: configValue }) => {\n\t// \t\t\t\t\t\tresult[tsKey] = configValue;\n\t// \t\t\t\t\t\treturn result;\n\t// \t\t\t\t\t},\n\t// \t\t\t\t\t{},\n\t// \t\t\t\t),\n\t// \t\t\t},\n\t// \t\t\ttableAlias,\n\t// \t\t});\n\n\t// \t\tselectedRelations.push({\n\t// \t\t\tdbKey: selectedRelationTsKey,\n\t// \t\t\ttsKey: selectedRelationTsKey,\n\t// \t\t\tfield: builtRelationSelectionField,\n\t// \t\t\trelationTableTsKey: relationTableTsName,\n\t// \t\t\tisJson: true,\n\t// \t\t\tselection: builtRelationJoin.selection,\n\t// \t\t});\n\n\t// \t\t// selection = builtTableFrom.selection.map((item) =>\n\t// \t\t// \tis(item.field, SQL.Aliased)\n\t// \t\t// \t\t? { ...item, field: sql`${sql.identifier(tableAlias)}.${sql.identifier(item.field.fieldAlias)}` }\n\t// \t\t// \t\t: item\n\t// \t\t// );\n\t// \t\t// selectionForBuild = [{\n\t// \t\t// \tdbKey: '*',\n\t// \t\t// \ttsKey: '*',\n\t// \t\t// \tfield: sql`${sql.identifier(tableAlias)}.*`,\n\t// \t\t// \tselection: [],\n\t// \t\t// \tisJson: false,\n\t// \t\t// \trelationTableTsKey: undefined,\n\t// \t\t// }];\n\t// \t\t// const newSelectionItem: (typeof selection)[number] = {\n\t// \t\t// \tdbKey: selectedRelationTsKey,\n\t// \t\t// \ttsKey: selectedRelationTsKey,\n\t// \t\t// \tfield,\n\t// \t\t// \trelationTableTsKey: relationTableTsName,\n\t// \t\t// \tisJson: true,\n\t// \t\t// \tselection: builtRelationJoin.selection,\n\t// \t\t// };\n\t// \t\t// selection.push(newSelectionItem);\n\t// \t\t// selectionForBuild.push(newSelectionItem);\n\n\t// \t\ttableFrom = is(builtTableFrom.sql, PgTable)\n\t// \t\t\t? builtTableFrom.sql\n\t// \t\t\t: new Subquery(builtTableFrom.sql, {}, tableAlias);\n\t// \t}\n\n\t// \tif (selectedColumns.length === 0 && selectedRelations.length === 0 && selectedExtras.length === 0) {\n\t// \t\tthrow new DrizzleError(`No fields selected for table \"${tableConfig.tsName}\" (\"${tableAlias}\")`);\n\t// \t}\n\n\t// \tlet selection: BuildRelationalQueryResult<PgTable, PgColumn>['selection'];\n\n\t// \tfunction prepareSelectedColumns() {\n\t// \t\treturn selectedColumns.map((key) => ({\n\t// \t\t\tdbKey: tableConfig.columns[key]!.name,\n\t// \t\t\ttsKey: key,\n\t// \t\t\tfield: tableConfig.columns[key] as PgColumn,\n\t// \t\t\trelationTableTsKey: undefined,\n\t// \t\t\tisJson: false,\n\t// \t\t\tselection: [],\n\t// \t\t}));\n\t// \t}\n\n\t// \tfunction prepareSelectedExtras() {\n\t// \t\treturn selectedExtras.map((item) => ({\n\t// \t\t\tdbKey: item.value.fieldAlias,\n\t// \t\t\ttsKey: item.tsKey,\n\t// \t\t\tfield: item.value,\n\t// \t\t\trelationTableTsKey: undefined,\n\t// \t\t\tisJson: false,\n\t// \t\t\tselection: [],\n\t// \t\t}));\n\t// \t}\n\n\t// \tif (isRoot) {\n\t// \t\tselection = [\n\t// \t\t\t...prepareSelectedColumns(),\n\t// \t\t\t...prepareSelectedExtras(),\n\t// \t\t];\n\t// \t}\n\n\t// \tif (hasUserDefinedWhere || orderBy.length > 0) {\n\t// \t\ttableFrom = new Subquery(\n\t// \t\t\tthis.buildSelectQuery({\n\t// \t\t\t\ttable: is(tableFrom, PgTable) ? aliasedTable(tableFrom, tableAlias) : tableFrom,\n\t// \t\t\t\tfields: {},\n\t// \t\t\t\tfieldsFlat: selectionForBuild.map(({ field }) => ({\n\t// \t\t\t\t\tpath: [],\n\t// \t\t\t\t\tfield: is(field, Column) ? aliasedTableColumn(field, tableAlias) : field,\n\t// \t\t\t\t})),\n\t// \t\t\t\tjoins,\n\t// \t\t\t\tdistinct,\n\t// \t\t\t}),\n\t// \t\t\t{},\n\t// \t\t\ttableAlias,\n\t// \t\t);\n\t// \t\tselectionForBuild = selection.map((item) =>\n\t// \t\t\tis(item.field, SQL.Aliased)\n\t// \t\t\t\t? { ...item, field: sql`${sql.identifier(tableAlias)}.${sql.identifier(item.field.fieldAlias)}` }\n\t// \t\t\t\t: item\n\t// \t\t);\n\t// \t\tjoins = [];\n\t// \t\tdistinct = undefined;\n\t// \t}\n\n\t// \tconst result = this.buildSelectQuery({\n\t// \t\ttable: is(tableFrom, PgTable) ? aliasedTable(tableFrom, tableAlias) : tableFrom,\n\t// \t\tfields: {},\n\t// \t\tfieldsFlat: selectionForBuild.map(({ field }) => ({\n\t// \t\t\tpath: [],\n\t// \t\t\tfield: is(field, Column) ? aliasedTableColumn(field, tableAlias) : field,\n\t// \t\t})),\n\t// \t\twhere,\n\t// \t\tlimit,\n\t// \t\toffset,\n\t// \t\tjoins,\n\t// \t\torderBy,\n\t// \t\tdistinct,\n\t// \t});\n\n\t// \treturn {\n\t// \t\ttableTsKey: tableConfig.tsName,\n\t// \t\tsql: result,\n\t// \t\tselection,\n\t// \t};\n\t// }\n\n\tbuildRelationalQueryWithoutPK({\n\t\tfullSchema,\n\t\tschema,\n\t\ttableNamesMap,\n\t\ttable,\n\t\ttableConfig,\n\t\tqueryConfig: config,\n\t\ttableAlias,\n\t\tnestedQueryRelation,\n\t\tjoinOn,\n\t}: {\n\t\tfullSchema: Record<string, unknown>;\n\t\tschema: TablesRelationalConfig;\n\t\ttableNamesMap: Record<string, string>;\n\t\ttable: PgTable;\n\t\ttableConfig: TableRelationalConfig;\n\t\tqueryConfig: true | DBQueryConfig<'many', true>;\n\t\ttableAlias: string;\n\t\tnestedQueryRelation?: Relation;\n\t\tjoinOn?: SQL;\n\t}): BuildRelationalQueryResult<PgTable, PgColumn> {\n\t\tlet selection: BuildRelationalQueryResult<PgTable, PgColumn>['selection'] = [];\n\t\tlet limit, offset, orderBy: NonNullable<PgSelectConfig['orderBy']> = [], where;\n\t\tconst joins: PgSelectJoinConfig[] = [];\n\n\t\tif (config === true) {\n\t\t\tconst selectionEntries = Object.entries(tableConfig.columns);\n\t\t\tselection = selectionEntries.map((\n\t\t\t\t[key, value],\n\t\t\t) => ({\n\t\t\t\tdbKey: value.name,\n\t\t\t\ttsKey: key,\n\t\t\t\tfield: aliasedTableColumn(value as PgColumn, tableAlias),\n\t\t\t\trelationTableTsKey: undefined,\n\t\t\t\tisJson: false,\n\t\t\t\tselection: [],\n\t\t\t}));\n\t\t} else {\n\t\t\tconst aliasedColumns = Object.fromEntries(\n\t\t\t\tObject.entries(tableConfig.columns).map((\n\t\t\t\t\t[key, value],\n\t\t\t\t) => [key, aliasedTableColumn(value, tableAlias)]),\n\t\t\t);\n\n\t\t\tif (config.where) {\n\t\t\t\tconst whereSql = typeof config.where === 'function'\n\t\t\t\t\t? config.where(aliasedColumns, getOperators())\n\t\t\t\t\t: config.where;\n\t\t\t\twhere = whereSql && mapColumnsInSQLToAlias(whereSql, tableAlias);\n\t\t\t}\n\n\t\t\tconst fieldsSelection: { tsKey: string; value: PgColumn | SQL.Aliased }[] = [];\n\t\t\tlet selectedColumns: string[] = [];\n\n\t\t\t// Figure out which columns to select\n\t\t\tif (config.columns) {\n\t\t\t\tlet isIncludeMode = false;\n\n\t\t\t\tfor (const [field, value] of Object.entries(config.columns)) {\n\t\t\t\t\tif (value === undefined) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (field in tableConfig.columns) {\n\t\t\t\t\t\tif (!isIncludeMode && value === true) {\n\t\t\t\t\t\t\tisIncludeMode = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tselectedColumns.push(field);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (selectedColumns.length > 0) {\n\t\t\t\t\tselectedColumns = isIncludeMode\n\t\t\t\t\t\t? selectedColumns.filter((c) => config.columns?.[c] === true)\n\t\t\t\t\t\t: Object.keys(tableConfig.columns).filter((key) => !selectedColumns.includes(key));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Select all columns if selection is not specified\n\t\t\t\tselectedColumns = Object.keys(tableConfig.columns);\n\t\t\t}\n\n\t\t\tfor (const field of selectedColumns) {\n\t\t\t\tconst column = tableConfig.columns[field]! as PgColumn;\n\t\t\t\tfieldsSelection.push({ tsKey: field, value: column });\n\t\t\t}\n\n\t\t\tlet selectedRelations: {\n\t\t\t\ttsKey: string;\n\t\t\t\tqueryConfig: true | DBQueryConfig<'many', false>;\n\t\t\t\trelation: Relation;\n\t\t\t}[] = [];\n\n\t\t\t// Figure out which relations to select\n\t\t\tif (config.with) {\n\t\t\t\tselectedRelations = Object.entries(config.with)\n\t\t\t\t\t.filter((entry): entry is [typeof entry[0], NonNullable<typeof entry[1]>] => !!entry[1])\n\t\t\t\t\t.map(([tsKey, queryConfig]) => ({ tsKey, queryConfig, relation: tableConfig.relations[tsKey]! }));\n\t\t\t}\n\n\t\t\tlet extras;\n\n\t\t\t// Figure out which extras to select\n\t\t\tif (config.extras) {\n\t\t\t\textras = typeof config.extras === 'function'\n\t\t\t\t\t? config.extras(aliasedColumns, { sql })\n\t\t\t\t\t: config.extras;\n\t\t\t\tfor (const [tsKey, value] of Object.entries(extras)) {\n\t\t\t\t\tfieldsSelection.push({\n\t\t\t\t\t\ttsKey,\n\t\t\t\t\t\tvalue: mapColumnsInAliasedSQLToAlias(value, tableAlias),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Transform `fieldsSelection` into `selection`\n\t\t\t// `fieldsSelection` shouldn't be used after this point\n\t\t\tfor (const { tsKey, value } of fieldsSelection) {\n\t\t\t\tselection.push({\n\t\t\t\t\tdbKey: is(value, SQL.Aliased) ? value.fieldAlias : tableConfig.columns[tsKey]!.name,\n\t\t\t\t\ttsKey,\n\t\t\t\t\tfield: is(value, Column) ? aliasedTableColumn(value, tableAlias) : value,\n\t\t\t\t\trelationTableTsKey: undefined,\n\t\t\t\t\tisJson: false,\n\t\t\t\t\tselection: [],\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet orderByOrig = typeof config.orderBy === 'function'\n\t\t\t\t? config.orderBy(aliasedColumns, getOrderByOperators())\n\t\t\t\t: config.orderBy ?? [];\n\t\t\tif (!Array.isArray(orderByOrig)) {\n\t\t\t\torderByOrig = [orderByOrig];\n\t\t\t}\n\t\t\torderBy = orderByOrig.map((orderByValue) => {\n\t\t\t\tif (is(orderByValue, Column)) {\n\t\t\t\t\treturn aliasedTableColumn(orderByValue, tableAlias) as PgColumn;\n\t\t\t\t}\n\t\t\t\treturn mapColumnsInSQLToAlias(orderByValue, tableAlias);\n\t\t\t});\n\n\t\t\tlimit = config.limit;\n\t\t\toffset = config.offset;\n\n\t\t\t// Process all relations\n\t\t\tfor (\n\t\t\t\tconst {\n\t\t\t\t\ttsKey: selectedRelationTsKey,\n\t\t\t\t\tqueryConfig: selectedRelationConfigValue,\n\t\t\t\t\trelation,\n\t\t\t\t} of selectedRelations\n\t\t\t) {\n\t\t\t\tconst normalizedRelation = normalizeRelation(schema, tableNamesMap, relation);\n\t\t\t\tconst relationTableName = getTableUniqueName(relation.referencedTable);\n\t\t\t\tconst relationTableTsName = tableNamesMap[relationTableName]!;\n\t\t\t\tconst relationTableAlias = `${tableAlias}_${selectedRelationTsKey}`;\n\t\t\t\tconst joinOn = and(\n\t\t\t\t\t...normalizedRelation.fields.map((field, i) =>\n\t\t\t\t\t\teq(\n\t\t\t\t\t\t\taliasedTableColumn(normalizedRelation.references[i]!, relationTableAlias),\n\t\t\t\t\t\t\taliasedTableColumn(field, tableAlias),\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t\tconst builtRelation = this.buildRelationalQueryWithoutPK({\n\t\t\t\t\tfullSchema,\n\t\t\t\t\tschema,\n\t\t\t\t\ttableNamesMap,\n\t\t\t\t\ttable: fullSchema[relationTableTsName] as PgTable,\n\t\t\t\t\ttableConfig: schema[relationTableTsName]!,\n\t\t\t\t\tqueryConfig: is(relation, One)\n\t\t\t\t\t\t? (selectedRelationConfigValue === true\n\t\t\t\t\t\t\t? { limit: 1 }\n\t\t\t\t\t\t\t: { ...selectedRelationConfigValue, limit: 1 })\n\t\t\t\t\t\t: selectedRelationConfigValue,\n\t\t\t\t\ttableAlias: relationTableAlias,\n\t\t\t\t\tjoinOn,\n\t\t\t\t\tnestedQueryRelation: relation,\n\t\t\t\t});\n\t\t\t\tconst field = sql`${sql.identifier(relationTableAlias)}.${sql.identifier('data')}`.as(selectedRelationTsKey);\n\t\t\t\tjoins.push({\n\t\t\t\t\ton: sql`true`,\n\t\t\t\t\ttable: new Subquery(builtRelation.sql as SQL, {}, relationTableAlias),\n\t\t\t\t\talias: relationTableAlias,\n\t\t\t\t\tjoinType: 'left',\n\t\t\t\t\tlateral: true,\n\t\t\t\t});\n\t\t\t\tselection.push({\n\t\t\t\t\tdbKey: selectedRelationTsKey,\n\t\t\t\t\ttsKey: selectedRelationTsKey,\n\t\t\t\t\tfield,\n\t\t\t\t\trelationTableTsKey: relationTableTsName,\n\t\t\t\t\tisJson: true,\n\t\t\t\t\tselection: builtRelation.selection,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (selection.length === 0) {\n\t\t\tthrow new DrizzleError({ message: `No fields selected for table \"${tableConfig.tsName}\" (\"${tableAlias}\")` });\n\t\t}\n\n\t\tlet result;\n\n\t\twhere = and(joinOn, where);\n\n\t\tif (nestedQueryRelation) {\n\t\t\tlet field = sql`json_build_array(${\n\t\t\t\tsql.join(\n\t\t\t\t\tselection.map(({ field, tsKey, isJson }) =>\n\t\t\t\t\t\tisJson\n\t\t\t\t\t\t\t? sql`${sql.identifier(`${tableAlias}_${tsKey}`)}.${sql.identifier('data')}`\n\t\t\t\t\t\t\t: is(field, SQL.Aliased)\n\t\t\t\t\t\t\t? field.sql\n\t\t\t\t\t\t\t: field\n\t\t\t\t\t),\n\t\t\t\t\tsql`, `,\n\t\t\t\t)\n\t\t\t})`;\n\t\t\tif (is(nestedQueryRelation, Many)) {\n\t\t\t\tfield = sql`coalesce(json_agg(${field}${\n\t\t\t\t\torderBy.length > 0 ? sql` order by ${sql.join(orderBy, sql`, `)}` : undefined\n\t\t\t\t}), '[]'::json)`;\n\t\t\t\t// orderBy = [];\n\t\t\t}\n\t\t\tconst nestedSelection = [{\n\t\t\t\tdbKey: 'data',\n\t\t\t\ttsKey: 'data',\n\t\t\t\tfield: field.as('data'),\n\t\t\t\tisJson: true,\n\t\t\t\trelationTableTsKey: tableConfig.tsName,\n\t\t\t\tselection,\n\t\t\t}];\n\n\t\t\tconst needsSubquery = limit !== undefined || offset !== undefined || orderBy.length > 0;\n\n\t\t\tif (needsSubquery) {\n\t\t\t\tresult = this.buildSelectQuery({\n\t\t\t\t\ttable: aliasedTable(table, tableAlias),\n\t\t\t\t\tfields: {},\n\t\t\t\t\tfieldsFlat: [{\n\t\t\t\t\t\tpath: [],\n\t\t\t\t\t\tfield: sql.raw('*'),\n\t\t\t\t\t}],\n\t\t\t\t\twhere,\n\t\t\t\t\tlimit,\n\t\t\t\t\toffset,\n\t\t\t\t\torderBy,\n\t\t\t\t\tsetOperators: [],\n\t\t\t\t});\n\n\t\t\t\twhere = undefined;\n\t\t\t\tlimit = undefined;\n\t\t\t\toffset = undefined;\n\t\t\t\torderBy = [];\n\t\t\t} else {\n\t\t\t\tresult = aliasedTable(table, tableAlias);\n\t\t\t}\n\n\t\t\tresult = this.buildSelectQuery({\n\t\t\t\ttable: is(result, PgTable) ? result : new Subquery(result, {}, tableAlias),\n\t\t\t\tfields: {},\n\t\t\t\tfieldsFlat: nestedSelection.map(({ field }) => ({\n\t\t\t\t\tpath: [],\n\t\t\t\t\tfield: is(field, Column) ? aliasedTableColumn(field, tableAlias) : field,\n\t\t\t\t})),\n\t\t\t\tjoins,\n\t\t\t\twhere,\n\t\t\t\tlimit,\n\t\t\t\toffset,\n\t\t\t\torderBy,\n\t\t\t\tsetOperators: [],\n\t\t\t});\n\t\t} else {\n\t\t\tresult = this.buildSelectQuery({\n\t\t\t\ttable: aliasedTable(table, tableAlias),\n\t\t\t\tfields: {},\n\t\t\t\tfieldsFlat: selection.map(({ field }) => ({\n\t\t\t\t\tpath: [],\n\t\t\t\t\tfield: is(field, Column) ? aliasedTableColumn(field, tableAlias) : field,\n\t\t\t\t})),\n\t\t\t\tjoins,\n\t\t\t\twhere,\n\t\t\t\tlimit,\n\t\t\t\toffset,\n\t\t\t\torderBy,\n\t\t\t\tsetOperators: [],\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\ttableTsKey: tableConfig.tsName,\n\t\t\tsql: result,\n\t\t\tselection,\n\t\t};\n\t}\n}\n","import { ColumnAliasProxyHandler, TableAliasProxyHandler } from './alias.ts';\nimport { Column } from './column.ts';\nimport { entityKind, is } from './entity.ts';\nimport { SQL, View } from './sql/sql.ts';\nimport { Subquery } from './subquery.ts';\nimport { ViewBaseConfig } from './view-common.ts';\n\nexport class SelectionProxyHandler<T extends Subquery | Record<string, unknown> | View>\n\timplements ProxyHandler<Subquery | Record<string, unknown> | View>\n{\n\tstatic readonly [entityKind]: string = 'SelectionProxyHandler';\n\n\tprivate config: {\n\t\t/**\n\t\t * Table alias for the columns\n\t\t */\n\t\talias?: string;\n\t\t/**\n\t\t * What to do when a field is an instance of `SQL.Aliased` and it's not a selection field (from a subquery)\n\t\t *\n\t\t * `sql` - return the underlying SQL expression\n\t\t *\n\t\t * `alias` - return the field alias\n\t\t */\n\t\tsqlAliasedBehavior: 'sql' | 'alias';\n\t\t/**\n\t\t * What to do when a field is an instance of `SQL` and it doesn't have an alias declared\n\t\t *\n\t\t * `sql` - return the underlying SQL expression\n\t\t *\n\t\t * `error` - return a DrizzleTypeError on type level and throw an error on runtime\n\t\t */\n\t\tsqlBehavior: 'sql' | 'error';\n\n\t\t/**\n\t\t * Whether to replace the original name of the column with the alias\n\t\t * Should be set to `true` for views creation\n\t\t * @default false\n\t\t */\n\t\treplaceOriginalName?: boolean;\n\t};\n\n\tconstructor(config: SelectionProxyHandler<T>['config']) {\n\t\tthis.config = { ...config };\n\t}\n\n\tget(subquery: T, prop: string | symbol): any {\n\t\tif (prop === '_') {\n\t\t\treturn {\n\t\t\t\t...subquery['_' as keyof typeof subquery],\n\t\t\t\tselectedFields: new Proxy(\n\t\t\t\t\t(subquery as Subquery)._.selectedFields,\n\t\t\t\t\tthis as ProxyHandler<Record<string, unknown>>,\n\t\t\t\t),\n\t\t\t};\n\t\t}\n\n\t\tif (prop === ViewBaseConfig) {\n\t\t\treturn {\n\t\t\t\t...subquery[ViewBaseConfig as keyof typeof subquery],\n\t\t\t\tselectedFields: new Proxy(\n\t\t\t\t\t(subquery as View)[ViewBaseConfig].selectedFields,\n\t\t\t\t\tthis as ProxyHandler<Record<string, unknown>>,\n\t\t\t\t),\n\t\t\t};\n\t\t}\n\n\t\tif (typeof prop === 'symbol') {\n\t\t\treturn subquery[prop as keyof typeof subquery];\n\t\t}\n\n\t\tconst columns = is(subquery, Subquery)\n\t\t\t? subquery._.selectedFields\n\t\t\t: is(subquery, View)\n\t\t\t? subquery[ViewBaseConfig].selectedFields\n\t\t\t: subquery;\n\t\tconst value: unknown = columns[prop as keyof typeof columns];\n\n\t\tif (is(value, SQL.Aliased)) {\n\t\t\t// Never return the underlying SQL expression for a field previously selected in a subquery\n\t\t\tif (this.config.sqlAliasedBehavior === 'sql' && !value.isSelectionField) {\n\t\t\t\treturn value.sql;\n\t\t\t}\n\n\t\t\tconst newValue = value.clone();\n\t\t\tnewValue.isSelectionField = true;\n\t\t\treturn newValue;\n\t\t}\n\n\t\tif (is(value, SQL)) {\n\t\t\tif (this.config.sqlBehavior === 'sql') {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tthrow new Error(\n\t\t\t\t`You tried to reference \"${prop}\" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using \".as('alias')\" method.`,\n\t\t\t);\n\t\t}\n\n\t\tif (is(value, Column)) {\n\t\t\tif (this.config.alias) {\n\t\t\t\treturn new Proxy(\n\t\t\t\t\tvalue,\n\t\t\t\t\tnew ColumnAliasProxyHandler(\n\t\t\t\t\t\tnew Proxy(\n\t\t\t\t\t\t\tvalue.table,\n\t\t\t\t\t\t\tnew TableAliasProxyHandler(this.config.alias, this.config.replaceOriginalName ?? false),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn value;\n\t\t}\n\n\t\tif (typeof value !== 'object' || value === null) {\n\t\t\treturn value;\n\t\t}\n\n\t\treturn new Proxy(value, new SelectionProxyHandler(this.config));\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport type { SQL, SQLWrapper } from '~/sql/index.ts';\n\nexport abstract class TypedQueryBuilder<TSelection, TResult = unknown> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'TypedQueryBuilder';\n\n\tdeclare _: {\n\t\tselectedFields: TSelection;\n\t\tresult: TResult;\n\t};\n\n\t/** @internal */\n\tgetSelectedFields(): TSelection {\n\t\treturn this._.selectedFields;\n\t}\n\n\tabstract getSQL(): SQL;\n}\n","import { entityKind, is } from '~/entity.ts';\nimport type { PgColumn } from '~/pg-core/columns/index.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport type { PgSession, PreparedQueryConfig } from '~/pg-core/session.ts';\nimport type { SubqueryWithSelection } from '~/pg-core/subquery.ts';\nimport type { PgTable } from '~/pg-core/table.ts';\nimport { PgViewBase } from '~/pg-core/view-base.ts';\nimport { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport type {\n\tBuildSubquerySelection,\n\tGetSelectTableName,\n\tGetSelectTableSelection,\n\tJoinNullability,\n\tJoinType,\n\tSelectMode,\n\tSelectResult,\n\tSetOperator,\n} from '~/query-builders/select.types.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport { SQL, View } from '~/sql/sql.ts';\nimport type { ColumnsSelection, Placeholder, Query, SQLWrapper } from '~/sql/sql.ts';\nimport { Subquery } from '~/subquery.ts';\nimport { Table } from '~/table.ts';\nimport { tracer } from '~/tracing.ts';\nimport { applyMixins, getTableColumns, getTableLikeName, haveSameKeys, type ValueOrArray } from '~/utils.ts';\nimport { orderSelectedFields } from '~/utils.ts';\nimport { ViewBaseConfig } from '~/view-common.ts';\nimport type {\n\tAnyPgSelect,\n\tCreatePgSelectFromBuilderMode,\n\tGetPgSetOperators,\n\tLockConfig,\n\tLockStrength,\n\tPgCreateSetOperatorFn,\n\tPgSelectConfig,\n\tPgSelectDynamic,\n\tPgSelectHKT,\n\tPgSelectHKTBase,\n\tPgSelectJoinFn,\n\tPgSelectPrepare,\n\tPgSelectWithout,\n\tPgSetOperatorExcludedMethods,\n\tPgSetOperatorWithResult,\n\tSelectedFields,\n\tSetOperatorRightSelect,\n} from './select.types.ts';\n\nexport class PgSelectBuilder<\n\tTSelection extends SelectedFields | undefined,\n\tTBuilderMode extends 'db' | 'qb' = 'db',\n> {\n\tstatic readonly [entityKind]: string = 'PgSelectBuilder';\n\n\tprivate fields: TSelection;\n\tprivate session: PgSession | undefined;\n\tprivate dialect: PgDialect;\n\tprivate withList: Subquery[] = [];\n\tprivate distinct: boolean | {\n\t\ton: (PgColumn | SQLWrapper)[];\n\t} | undefined;\n\n\tconstructor(\n\t\tconfig: {\n\t\t\tfields: TSelection;\n\t\t\tsession: PgSession | undefined;\n\t\t\tdialect: PgDialect;\n\t\t\twithList?: Subquery[];\n\t\t\tdistinct?: boolean | {\n\t\t\t\ton: (PgColumn | SQLWrapper)[];\n\t\t\t};\n\t\t},\n\t) {\n\t\tthis.fields = config.fields;\n\t\tthis.session = config.session;\n\t\tthis.dialect = config.dialect;\n\t\tif (config.withList) {\n\t\t\tthis.withList = config.withList;\n\t\t}\n\t\tthis.distinct = config.distinct;\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\t/**\n\t * Specify the table, subquery, or other target that you're\n\t * building a select query against.\n\t *\n\t * {@link https://www.postgresql.org/docs/current/sql-select.html#SQL-FROM | Postgres from documentation}\n\t */\n\tfrom<TFrom extends PgTable | Subquery | PgViewBase | SQL>(\n\t\tsource: TFrom,\n\t): CreatePgSelectFromBuilderMode<\n\t\tTBuilderMode,\n\t\tGetSelectTableName<TFrom>,\n\t\tTSelection extends undefined ? GetSelectTableSelection<TFrom> : TSelection,\n\t\tTSelection extends undefined ? 'single' : 'partial'\n\t> {\n\t\tconst isPartialSelect = !!this.fields;\n\n\t\tlet fields: SelectedFields;\n\t\tif (this.fields) {\n\t\t\tfields = this.fields;\n\t\t} else if (is(source, Subquery)) {\n\t\t\t// This is required to use the proxy handler to get the correct field values from the subquery\n\t\t\tfields = Object.fromEntries(\n\t\t\t\tObject.keys(source._.selectedFields).map((\n\t\t\t\t\tkey,\n\t\t\t\t) => [key, source[key as unknown as keyof typeof source] as unknown as SelectedFields[string]]),\n\t\t\t);\n\t\t} else if (is(source, PgViewBase)) {\n\t\t\tfields = source[ViewBaseConfig].selectedFields as SelectedFields;\n\t\t} else if (is(source, SQL)) {\n\t\t\tfields = {};\n\t\t} else {\n\t\t\tfields = getTableColumns<PgTable>(source);\n\t\t}\n\n\t\treturn (this.authToken === undefined\n\t\t\t? new PgSelectBase({\n\t\t\t\ttable: source,\n\t\t\t\tfields,\n\t\t\t\tisPartialSelect,\n\t\t\t\tsession: this.session,\n\t\t\t\tdialect: this.dialect,\n\t\t\t\twithList: this.withList,\n\t\t\t\tdistinct: this.distinct,\n\t\t\t})\n\t\t\t: new PgSelectBase({\n\t\t\t\ttable: source,\n\t\t\t\tfields,\n\t\t\t\tisPartialSelect,\n\t\t\t\tsession: this.session,\n\t\t\t\tdialect: this.dialect,\n\t\t\t\twithList: this.withList,\n\t\t\t\tdistinct: this.distinct,\n\t\t\t}).setToken(this.authToken)) as any;\n\t}\n}\n\nexport abstract class PgSelectQueryBuilderBase<\n\tTHKT extends PgSelectHKTBase,\n\tTTableName extends string | undefined,\n\tTSelection extends ColumnsSelection,\n\tTSelectMode extends SelectMode,\n\tTNullabilityMap extends Record<string, JoinNullability> = TTableName extends string ? Record<TTableName, 'not-null'>\n\t\t: {},\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n\tTResult extends any[] = SelectResult<TSelection, TSelectMode, TNullabilityMap>[],\n\tTSelectedFields extends ColumnsSelection = BuildSubquerySelection<TSelection, TNullabilityMap>,\n> extends TypedQueryBuilder<TSelectedFields, TResult> {\n\tstatic override readonly [entityKind]: string = 'PgSelectQueryBuilder';\n\n\toverride readonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly hkt: THKT;\n\t\treadonly tableName: TTableName;\n\t\treadonly selection: TSelection;\n\t\treadonly selectMode: TSelectMode;\n\t\treadonly nullabilityMap: TNullabilityMap;\n\t\treadonly dynamic: TDynamic;\n\t\treadonly excludedMethods: TExcludedMethods;\n\t\treadonly result: TResult;\n\t\treadonly selectedFields: TSelectedFields;\n\t};\n\n\tprotected config: PgSelectConfig;\n\tprotected joinsNotNullableMap: Record<string, boolean>;\n\tprivate tableName: string | undefined;\n\tprivate isPartialSelect: boolean;\n\tprotected session: PgSession | undefined;\n\tprotected dialect: PgDialect;\n\n\tconstructor(\n\t\t{ table, fields, isPartialSelect, session, dialect, withList, distinct }: {\n\t\t\ttable: PgSelectConfig['table'];\n\t\t\tfields: PgSelectConfig['fields'];\n\t\t\tisPartialSelect: boolean;\n\t\t\tsession: PgSession | undefined;\n\t\t\tdialect: PgDialect;\n\t\t\twithList: Subquery[];\n\t\t\tdistinct: boolean | {\n\t\t\t\ton: (PgColumn | SQLWrapper)[];\n\t\t\t} | undefined;\n\t\t},\n\t) {\n\t\tsuper();\n\t\tthis.config = {\n\t\t\twithList,\n\t\t\ttable,\n\t\t\tfields: { ...fields },\n\t\t\tdistinct,\n\t\t\tsetOperators: [],\n\t\t};\n\t\tthis.isPartialSelect = isPartialSelect;\n\t\tthis.session = session;\n\t\tthis.dialect = dialect;\n\t\tthis._ = {\n\t\t\tselectedFields: fields as TSelectedFields,\n\t\t} as this['_'];\n\t\tthis.tableName = getTableLikeName(table);\n\t\tthis.joinsNotNullableMap = typeof this.tableName === 'string' ? { [this.tableName]: true } : {};\n\t}\n\n\tprivate createJoin<TJoinType extends JoinType>(\n\t\tjoinType: TJoinType,\n\t): PgSelectJoinFn<this, TDynamic, TJoinType> {\n\t\treturn (\n\t\t\ttable: PgTable | Subquery | PgViewBase | SQL,\n\t\t\ton: ((aliases: TSelection) => SQL | undefined) | SQL | undefined,\n\t\t) => {\n\t\t\tconst baseTableName = this.tableName;\n\t\t\tconst tableName = getTableLikeName(table);\n\n\t\t\tif (typeof tableName === 'string' && this.config.joins?.some((join) => join.alias === tableName)) {\n\t\t\t\tthrow new Error(`Alias \"${tableName}\" is already used in this query`);\n\t\t\t}\n\n\t\t\tif (!this.isPartialSelect) {\n\t\t\t\t// If this is the first join and this is not a partial select and we're not selecting from raw SQL, \"move\" the fields from the main table to the nested object\n\t\t\t\tif (Object.keys(this.joinsNotNullableMap).length === 1 && typeof baseTableName === 'string') {\n\t\t\t\t\tthis.config.fields = {\n\t\t\t\t\t\t[baseTableName]: this.config.fields,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (typeof tableName === 'string' && !is(table, SQL)) {\n\t\t\t\t\tconst selection = is(table, Subquery)\n\t\t\t\t\t\t? table._.selectedFields\n\t\t\t\t\t\t: is(table, View)\n\t\t\t\t\t\t? table[ViewBaseConfig].selectedFields\n\t\t\t\t\t\t: table[Table.Symbol.Columns];\n\t\t\t\t\tthis.config.fields[tableName] = selection;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof on === 'function') {\n\t\t\t\ton = on(\n\t\t\t\t\tnew Proxy(\n\t\t\t\t\t\tthis.config.fields,\n\t\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'sql', sqlBehavior: 'sql' }),\n\t\t\t\t\t) as TSelection,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (!this.config.joins) {\n\t\t\t\tthis.config.joins = [];\n\t\t\t}\n\n\t\t\tthis.config.joins.push({ on, table, joinType, alias: tableName });\n\n\t\t\tif (typeof tableName === 'string') {\n\t\t\t\tswitch (joinType) {\n\t\t\t\t\tcase 'left': {\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = false;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'right': {\n\t\t\t\t\t\tthis.joinsNotNullableMap = Object.fromEntries(\n\t\t\t\t\t\t\tObject.entries(this.joinsNotNullableMap).map(([key]) => [key, false]),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'inner': {\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'full': {\n\t\t\t\t\t\tthis.joinsNotNullableMap = Object.fromEntries(\n\t\t\t\t\t\t\tObject.entries(this.joinsNotNullableMap).map(([key]) => [key, false]),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = false;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this as any;\n\t\t};\n\t}\n\n\t/**\n\t * Executes a `left join` operation by adding another table to the current query.\n\t *\n\t * Calling this method associates each row of the table with the corresponding row from the joined table, if a match is found. If no matching row exists, it sets all columns of the joined table to null.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/joins#left-join}\n\t *\n\t * @param table the table to join.\n\t * @param on the `on` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all users and their pets\n\t * const usersWithPets: { user: User; pets: Pet | null }[] = await db.select()\n\t *   .from(users)\n\t *   .leftJoin(pets, eq(users.id, pets.ownerId))\n\t *\n\t * // Select userId and petId\n\t * const usersIdsAndPetIds: { userId: number; petId: number | null }[] = await db.select({\n\t *   userId: users.id,\n\t *   petId: pets.id,\n\t * })\n\t *   .from(users)\n\t *   .leftJoin(pets, eq(users.id, pets.ownerId))\n\t * ```\n\t */\n\tleftJoin = this.createJoin('left');\n\n\t/**\n\t * Executes a `right join` operation by adding another table to the current query.\n\t *\n\t * Calling this method associates each row of the joined table with the corresponding row from the main table, if a match is found. If no matching row exists, it sets all columns of the main table to null.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/joins#right-join}\n\t *\n\t * @param table the table to join.\n\t * @param on the `on` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all users and their pets\n\t * const usersWithPets: { user: User | null; pets: Pet }[] = await db.select()\n\t *   .from(users)\n\t *   .rightJoin(pets, eq(users.id, pets.ownerId))\n\t *\n\t * // Select userId and petId\n\t * const usersIdsAndPetIds: { userId: number | null; petId: number }[] = await db.select({\n\t *   userId: users.id,\n\t *   petId: pets.id,\n\t * })\n\t *   .from(users)\n\t *   .rightJoin(pets, eq(users.id, pets.ownerId))\n\t * ```\n\t */\n\trightJoin = this.createJoin('right');\n\n\t/**\n\t * Executes an `inner join` operation, creating a new table by combining rows from two tables that have matching values.\n\t *\n\t * Calling this method retrieves rows that have corresponding entries in both joined tables. Rows without matching entries in either table are excluded, resulting in a table that includes only matching pairs.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/joins#inner-join}\n\t *\n\t * @param table the table to join.\n\t * @param on the `on` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all users and their pets\n\t * const usersWithPets: { user: User; pets: Pet }[] = await db.select()\n\t *   .from(users)\n\t *   .innerJoin(pets, eq(users.id, pets.ownerId))\n\t *\n\t * // Select userId and petId\n\t * const usersIdsAndPetIds: { userId: number; petId: number }[] = await db.select({\n\t *   userId: users.id,\n\t *   petId: pets.id,\n\t * })\n\t *   .from(users)\n\t *   .innerJoin(pets, eq(users.id, pets.ownerId))\n\t * ```\n\t */\n\tinnerJoin = this.createJoin('inner');\n\n\t/**\n\t * Executes a `full join` operation by combining rows from two tables into a new table.\n\t *\n\t * Calling this method retrieves all rows from both main and joined tables, merging rows with matching values and filling in `null` for non-matching columns.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/joins#full-join}\n\t *\n\t * @param table the table to join.\n\t * @param on the `on` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all users and their pets\n\t * const usersWithPets: { user: User | null; pets: Pet | null }[] = await db.select()\n\t *   .from(users)\n\t *   .fullJoin(pets, eq(users.id, pets.ownerId))\n\t *\n\t * // Select userId and petId\n\t * const usersIdsAndPetIds: { userId: number | null; petId: number | null }[] = await db.select({\n\t *   userId: users.id,\n\t *   petId: pets.id,\n\t * })\n\t *   .from(users)\n\t *   .fullJoin(pets, eq(users.id, pets.ownerId))\n\t * ```\n\t */\n\tfullJoin = this.createJoin('full');\n\n\tprivate createSetOperator(\n\t\ttype: SetOperator,\n\t\tisAll: boolean,\n\t): <TValue extends PgSetOperatorWithResult<TResult>>(\n\t\trightSelection:\n\t\t\t| ((setOperators: GetPgSetOperators) => SetOperatorRightSelect<TValue, TResult>)\n\t\t\t| SetOperatorRightSelect<TValue, TResult>,\n\t) => PgSelectWithout<\n\t\tthis,\n\t\tTDynamic,\n\t\tPgSetOperatorExcludedMethods,\n\t\ttrue\n\t> {\n\t\treturn (rightSelection) => {\n\t\t\tconst rightSelect = (typeof rightSelection === 'function'\n\t\t\t\t? rightSelection(getPgSetOperators())\n\t\t\t\t: rightSelection) as TypedQueryBuilder<\n\t\t\t\t\tany,\n\t\t\t\t\tTResult\n\t\t\t\t>;\n\n\t\t\tif (!haveSameKeys(this.getSelectedFields(), rightSelect.getSelectedFields())) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Set operator error (union / intersect / except): selected fields are not the same or are in a different order',\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.config.setOperators.push({ type, isAll, rightSelect });\n\t\t\treturn this as any;\n\t\t};\n\t}\n\n\t/**\n\t * Adds `union` set operator to the query.\n\t *\n\t * Calling this method will combine the result sets of the `select` statements and remove any duplicate rows that appear across them.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#union}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all unique names from customers and users tables\n\t * await db.select({ name: users.name })\n\t *   .from(users)\n\t *   .union(\n\t *     db.select({ name: customers.name }).from(customers)\n\t *   );\n\t * // or\n\t * import { union } from 'drizzle-orm/pg-core'\n\t *\n\t * await union(\n\t *   db.select({ name: users.name }).from(users),\n\t *   db.select({ name: customers.name }).from(customers)\n\t * );\n\t * ```\n\t */\n\tunion = this.createSetOperator('union', false);\n\n\t/**\n\t * Adds `union all` set operator to the query.\n\t *\n\t * Calling this method will combine the result-set of the `select` statements and keep all duplicate rows that appear across them.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#union-all}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all transaction ids from both online and in-store sales\n\t * await db.select({ transaction: onlineSales.transactionId })\n\t *   .from(onlineSales)\n\t *   .unionAll(\n\t *     db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)\n\t *   );\n\t * // or\n\t * import { unionAll } from 'drizzle-orm/pg-core'\n\t *\n\t * await unionAll(\n\t *   db.select({ transaction: onlineSales.transactionId }).from(onlineSales),\n\t *   db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)\n\t * );\n\t * ```\n\t */\n\tunionAll = this.createSetOperator('union', true);\n\n\t/**\n\t * Adds `intersect` set operator to the query.\n\t *\n\t * Calling this method will retain only the rows that are present in both result sets and eliminate duplicates.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#intersect}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select course names that are offered in both departments A and B\n\t * await db.select({ courseName: depA.courseName })\n\t *   .from(depA)\n\t *   .intersect(\n\t *     db.select({ courseName: depB.courseName }).from(depB)\n\t *   );\n\t * // or\n\t * import { intersect } from 'drizzle-orm/pg-core'\n\t *\n\t * await intersect(\n\t *   db.select({ courseName: depA.courseName }).from(depA),\n\t *   db.select({ courseName: depB.courseName }).from(depB)\n\t * );\n\t * ```\n\t */\n\tintersect = this.createSetOperator('intersect', false);\n\n\t/**\n\t * Adds `intersect all` set operator to the query.\n\t *\n\t * Calling this method will retain only the rows that are present in both result sets including all duplicates.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#intersect-all}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all products and quantities that are ordered by both regular and VIP customers\n\t * await db.select({\n\t *   productId: regularCustomerOrders.productId,\n\t *   quantityOrdered: regularCustomerOrders.quantityOrdered\n\t * })\n\t * .from(regularCustomerOrders)\n\t * .intersectAll(\n\t *   db.select({\n\t *     productId: vipCustomerOrders.productId,\n\t *     quantityOrdered: vipCustomerOrders.quantityOrdered\n\t *   })\n\t *   .from(vipCustomerOrders)\n\t * );\n\t * // or\n\t * import { intersectAll } from 'drizzle-orm/pg-core'\n\t *\n\t * await intersectAll(\n\t *   db.select({\n\t *     productId: regularCustomerOrders.productId,\n\t *     quantityOrdered: regularCustomerOrders.quantityOrdered\n\t *   })\n\t *   .from(regularCustomerOrders),\n\t *   db.select({\n\t *     productId: vipCustomerOrders.productId,\n\t *     quantityOrdered: vipCustomerOrders.quantityOrdered\n\t *   })\n\t *   .from(vipCustomerOrders)\n\t * );\n\t * ```\n\t */\n\tintersectAll = this.createSetOperator('intersect', true);\n\n\t/**\n\t * Adds `except` set operator to the query.\n\t *\n\t * Calling this method will retrieve all unique rows from the left query, except for the rows that are present in the result set of the right query.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#except}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all courses offered in department A but not in department B\n\t * await db.select({ courseName: depA.courseName })\n\t *   .from(depA)\n\t *   .except(\n\t *     db.select({ courseName: depB.courseName }).from(depB)\n\t *   );\n\t * // or\n\t * import { except } from 'drizzle-orm/pg-core'\n\t *\n\t * await except(\n\t *   db.select({ courseName: depA.courseName }).from(depA),\n\t *   db.select({ courseName: depB.courseName }).from(depB)\n\t * );\n\t * ```\n\t */\n\texcept = this.createSetOperator('except', false);\n\n\t/**\n\t * Adds `except all` set operator to the query.\n\t *\n\t * Calling this method will retrieve all rows from the left query, except for the rows that are present in the result set of the right query.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/set-operations#except-all}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all products that are ordered by regular customers but not by VIP customers\n\t * await db.select({\n\t *   productId: regularCustomerOrders.productId,\n\t *   quantityOrdered: regularCustomerOrders.quantityOrdered,\n\t * })\n\t * .from(regularCustomerOrders)\n\t * .exceptAll(\n\t *   db.select({\n\t *     productId: vipCustomerOrders.productId,\n\t *     quantityOrdered: vipCustomerOrders.quantityOrdered,\n\t *   })\n\t *   .from(vipCustomerOrders)\n\t * );\n\t * // or\n\t * import { exceptAll } from 'drizzle-orm/pg-core'\n\t *\n\t * await exceptAll(\n\t *   db.select({\n\t *     productId: regularCustomerOrders.productId,\n\t *     quantityOrdered: regularCustomerOrders.quantityOrdered\n\t *   })\n\t *   .from(regularCustomerOrders),\n\t *   db.select({\n\t *     productId: vipCustomerOrders.productId,\n\t *     quantityOrdered: vipCustomerOrders.quantityOrdered\n\t *   })\n\t *   .from(vipCustomerOrders)\n\t * );\n\t * ```\n\t */\n\texceptAll = this.createSetOperator('except', true);\n\n\t/** @internal */\n\taddSetOperators(setOperators: PgSelectConfig['setOperators']): PgSelectWithout<\n\t\tthis,\n\t\tTDynamic,\n\t\tPgSetOperatorExcludedMethods,\n\t\ttrue\n\t> {\n\t\tthis.config.setOperators.push(...setOperators);\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `where` clause to the query.\n\t *\n\t * Calling this method will select only those rows that fulfill a specified condition.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#filtering}\n\t *\n\t * @param where the `where` clause.\n\t *\n\t * @example\n\t * You can use conditional operators and `sql function` to filter the rows to be selected.\n\t *\n\t * ```ts\n\t * // Select all cars with green color\n\t * await db.select().from(cars).where(eq(cars.color, 'green'));\n\t * // or\n\t * await db.select().from(cars).where(sql`${cars.color} = 'green'`)\n\t * ```\n\t *\n\t * You can logically combine conditional operators with `and()` and `or()` operators:\n\t *\n\t * ```ts\n\t * // Select all BMW cars with a green color\n\t * await db.select().from(cars).where(and(eq(cars.color, 'green'), eq(cars.brand, 'BMW')));\n\t *\n\t * // Select all cars with the green or blue color\n\t * await db.select().from(cars).where(or(eq(cars.color, 'green'), eq(cars.color, 'blue')));\n\t * ```\n\t */\n\twhere(\n\t\twhere: ((aliases: this['_']['selection']) => SQL | undefined) | SQL | undefined,\n\t): PgSelectWithout<this, TDynamic, 'where'> {\n\t\tif (typeof where === 'function') {\n\t\t\twhere = where(\n\t\t\t\tnew Proxy(\n\t\t\t\t\tthis.config.fields,\n\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'sql', sqlBehavior: 'sql' }),\n\t\t\t\t) as TSelection,\n\t\t\t);\n\t\t}\n\t\tthis.config.where = where;\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `having` clause to the query.\n\t *\n\t * Calling this method will select only those rows that fulfill a specified condition. It is typically used with aggregate functions to filter the aggregated data based on a specified condition.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#aggregations}\n\t *\n\t * @param having the `having` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all brands with more than one car\n\t * await db.select({\n\t * \tbrand: cars.brand,\n\t * \tcount: sql<number>`cast(count(${cars.id}) as int)`,\n\t * })\n\t *   .from(cars)\n\t *   .groupBy(cars.brand)\n\t *   .having(({ count }) => gt(count, 1));\n\t * ```\n\t */\n\thaving(\n\t\thaving: ((aliases: this['_']['selection']) => SQL | undefined) | SQL | undefined,\n\t): PgSelectWithout<this, TDynamic, 'having'> {\n\t\tif (typeof having === 'function') {\n\t\t\thaving = having(\n\t\t\t\tnew Proxy(\n\t\t\t\t\tthis.config.fields,\n\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'sql', sqlBehavior: 'sql' }),\n\t\t\t\t) as TSelection,\n\t\t\t);\n\t\t}\n\t\tthis.config.having = having;\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `group by` clause to the query.\n\t *\n\t * Calling this method will group rows that have the same values into summary rows, often used for aggregation purposes.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#aggregations}\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Group and count people by their last names\n\t * await db.select({\n\t *    lastName: people.lastName,\n\t *    count: sql<number>`cast(count(*) as int)`\n\t * })\n\t *   .from(people)\n\t *   .groupBy(people.lastName);\n\t * ```\n\t */\n\tgroupBy(\n\t\tbuilder: (aliases: this['_']['selection']) => ValueOrArray<PgColumn | SQL | SQL.Aliased>,\n\t): PgSelectWithout<this, TDynamic, 'groupBy'>;\n\tgroupBy(...columns: (PgColumn | SQL | SQL.Aliased)[]): PgSelectWithout<this, TDynamic, 'groupBy'>;\n\tgroupBy(\n\t\t...columns:\n\t\t\t| [(aliases: this['_']['selection']) => ValueOrArray<PgColumn | SQL | SQL.Aliased>]\n\t\t\t| (PgColumn | SQL | SQL.Aliased)[]\n\t): PgSelectWithout<this, TDynamic, 'groupBy'> {\n\t\tif (typeof columns[0] === 'function') {\n\t\t\tconst groupBy = columns[0](\n\t\t\t\tnew Proxy(\n\t\t\t\t\tthis.config.fields,\n\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'alias', sqlBehavior: 'sql' }),\n\t\t\t\t) as TSelection,\n\t\t\t);\n\t\t\tthis.config.groupBy = Array.isArray(groupBy) ? groupBy : [groupBy];\n\t\t} else {\n\t\t\tthis.config.groupBy = columns as (PgColumn | SQL | SQL.Aliased)[];\n\t\t}\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds an `order by` clause to the query.\n\t *\n\t * Calling this method will sort the result-set in ascending or descending order. By default, the sort order is ascending.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#order-by}\n\t *\n\t * @example\n\t *\n\t * ```\n\t * // Select cars ordered by year\n\t * await db.select().from(cars).orderBy(cars.year);\n\t * ```\n\t *\n\t * You can specify whether results are in ascending or descending order with the `asc()` and `desc()` operators.\n\t *\n\t * ```ts\n\t * // Select cars ordered by year in descending order\n\t * await db.select().from(cars).orderBy(desc(cars.year));\n\t *\n\t * // Select cars ordered by year and price\n\t * await db.select().from(cars).orderBy(asc(cars.year), desc(cars.price));\n\t * ```\n\t */\n\torderBy(\n\t\tbuilder: (aliases: this['_']['selection']) => ValueOrArray<PgColumn | SQL | SQL.Aliased>,\n\t): PgSelectWithout<this, TDynamic, 'orderBy'>;\n\torderBy(...columns: (PgColumn | SQL | SQL.Aliased)[]): PgSelectWithout<this, TDynamic, 'orderBy'>;\n\torderBy(\n\t\t...columns:\n\t\t\t| [(aliases: this['_']['selection']) => ValueOrArray<PgColumn | SQL | SQL.Aliased>]\n\t\t\t| (PgColumn | SQL | SQL.Aliased)[]\n\t): PgSelectWithout<this, TDynamic, 'orderBy'> {\n\t\tif (typeof columns[0] === 'function') {\n\t\t\tconst orderBy = columns[0](\n\t\t\t\tnew Proxy(\n\t\t\t\t\tthis.config.fields,\n\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'alias', sqlBehavior: 'sql' }),\n\t\t\t\t) as TSelection,\n\t\t\t);\n\n\t\t\tconst orderByArray = Array.isArray(orderBy) ? orderBy : [orderBy];\n\n\t\t\tif (this.config.setOperators.length > 0) {\n\t\t\t\tthis.config.setOperators.at(-1)!.orderBy = orderByArray;\n\t\t\t} else {\n\t\t\t\tthis.config.orderBy = orderByArray;\n\t\t\t}\n\t\t} else {\n\t\t\tconst orderByArray = columns as (PgColumn | SQL | SQL.Aliased)[];\n\n\t\t\tif (this.config.setOperators.length > 0) {\n\t\t\t\tthis.config.setOperators.at(-1)!.orderBy = orderByArray;\n\t\t\t} else {\n\t\t\t\tthis.config.orderBy = orderByArray;\n\t\t\t}\n\t\t}\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `limit` clause to the query.\n\t *\n\t * Calling this method will set the maximum number of rows that will be returned by this query.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#limit--offset}\n\t *\n\t * @param limit the `limit` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Get the first 10 people from this query.\n\t * await db.select().from(people).limit(10);\n\t * ```\n\t */\n\tlimit(limit: number | Placeholder): PgSelectWithout<this, TDynamic, 'limit'> {\n\t\tif (this.config.setOperators.length > 0) {\n\t\t\tthis.config.setOperators.at(-1)!.limit = limit;\n\t\t} else {\n\t\t\tthis.config.limit = limit;\n\t\t}\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds an `offset` clause to the query.\n\t *\n\t * Calling this method will skip a number of rows when returning results from this query.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#limit--offset}\n\t *\n\t * @param offset the `offset` clause.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Get the 10th-20th people from this query.\n\t * await db.select().from(people).offset(10).limit(10);\n\t * ```\n\t */\n\toffset(offset: number | Placeholder): PgSelectWithout<this, TDynamic, 'offset'> {\n\t\tif (this.config.setOperators.length > 0) {\n\t\t\tthis.config.setOperators.at(-1)!.offset = offset;\n\t\t} else {\n\t\t\tthis.config.offset = offset;\n\t\t}\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `for` clause to the query.\n\t *\n\t * Calling this method will specify a lock strength for this query that controls how strictly it acquires exclusive access to the rows being queried.\n\t *\n\t * See docs: {@link https://www.postgresql.org/docs/current/sql-select.html#SQL-FOR-UPDATE-SHARE}\n\t *\n\t * @param strength the lock strength.\n\t * @param config the lock configuration.\n\t */\n\tfor(strength: LockStrength, config: LockConfig = {}): PgSelectWithout<this, TDynamic, 'for'> {\n\t\tthis.config.lockingClause = { strength, config };\n\t\treturn this as any;\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this.dialect.buildSelectQuery(this.config);\n\t}\n\n\ttoSQL(): Query {\n\t\tconst { typings: _typings, ...rest } = this.dialect.sqlToQuery(this.getSQL());\n\t\treturn rest;\n\t}\n\n\tas<TAlias extends string>(\n\t\talias: TAlias,\n\t): SubqueryWithSelection<this['_']['selectedFields'], TAlias> {\n\t\treturn new Proxy(\n\t\t\tnew Subquery(this.getSQL(), this.config.fields, alias),\n\t\t\tnew SelectionProxyHandler({ alias, sqlAliasedBehavior: 'alias', sqlBehavior: 'error' }),\n\t\t) as SubqueryWithSelection<this['_']['selectedFields'], TAlias>;\n\t}\n\n\t/** @internal */\n\toverride getSelectedFields(): this['_']['selectedFields'] {\n\t\treturn new Proxy(\n\t\t\tthis.config.fields,\n\t\t\tnew SelectionProxyHandler({ alias: this.tableName, sqlAliasedBehavior: 'alias', sqlBehavior: 'error' }),\n\t\t) as this['_']['selectedFields'];\n\t}\n\n\t$dynamic(): PgSelectDynamic<this> {\n\t\treturn this;\n\t}\n}\n\nexport interface PgSelectBase<\n\tTTableName extends string | undefined,\n\tTSelection extends ColumnsSelection,\n\tTSelectMode extends SelectMode,\n\tTNullabilityMap extends Record<string, JoinNullability> = TTableName extends string ? Record<TTableName, 'not-null'>\n\t\t: {},\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n\tTResult extends any[] = SelectResult<TSelection, TSelectMode, TNullabilityMap>[],\n\tTSelectedFields extends ColumnsSelection = BuildSubquerySelection<TSelection, TNullabilityMap>,\n> extends\n\tPgSelectQueryBuilderBase<\n\t\tPgSelectHKT,\n\t\tTTableName,\n\t\tTSelection,\n\t\tTSelectMode,\n\t\tTNullabilityMap,\n\t\tTDynamic,\n\t\tTExcludedMethods,\n\t\tTResult,\n\t\tTSelectedFields\n\t>,\n\tQueryPromise<TResult>,\n\tSQLWrapper\n{}\n\nexport class PgSelectBase<\n\tTTableName extends string | undefined,\n\tTSelection extends ColumnsSelection,\n\tTSelectMode extends SelectMode,\n\tTNullabilityMap extends Record<string, JoinNullability> = TTableName extends string ? Record<TTableName, 'not-null'>\n\t\t: {},\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n\tTResult = SelectResult<TSelection, TSelectMode, TNullabilityMap>[],\n\tTSelectedFields = BuildSubquerySelection<TSelection, TNullabilityMap>,\n> extends PgSelectQueryBuilderBase<\n\tPgSelectHKT,\n\tTTableName,\n\tTSelection,\n\tTSelectMode,\n\tTNullabilityMap,\n\tTDynamic,\n\tTExcludedMethods,\n\tTResult,\n\tTSelectedFields\n> implements RunnableQuery<TResult, 'pg'>, SQLWrapper {\n\tstatic override readonly [entityKind]: string = 'PgSelect';\n\n\t/** @internal */\n\t_prepare(name?: string): PgSelectPrepare<this> {\n\t\tconst { session, config, dialect, joinsNotNullableMap, authToken } = this;\n\t\tif (!session) {\n\t\t\tthrow new Error('Cannot execute a query on a query builder. Please use a database instance instead.');\n\t\t}\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\tconst fieldsList = orderSelectedFields<PgColumn>(config.fields);\n\t\t\tconst query = session.prepareQuery<\n\t\t\t\tPreparedQueryConfig & { execute: TResult }\n\t\t\t>(dialect.sqlToQuery(this.getSQL()), fieldsList, name, true);\n\t\t\tquery.joinsNotNullableMap = joinsNotNullableMap;\n\n\t\t\treturn authToken === undefined ? query : query.setToken(authToken);\n\t\t});\n\t}\n\n\t/**\n\t * Create a prepared statement for this query. This allows\n\t * the database to remember this query for the given session\n\t * and call it by name, rather than specifying the full query.\n\t *\n\t * {@link https://www.postgresql.org/docs/current/sql-prepare.html | Postgres prepare documentation}\n\t */\n\tprepare(name: string): PgSelectPrepare<this> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\texecute: ReturnType<this['prepare']>['execute'] = (placeholderValues) => {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(placeholderValues, this.authToken);\n\t\t});\n\t};\n}\n\napplyMixins(PgSelectBase, [QueryPromise]);\n\nfunction createSetOperator(type: SetOperator, isAll: boolean): PgCreateSetOperatorFn {\n\treturn (leftSelect, rightSelect, ...restSelects) => {\n\t\tconst setOperators = [rightSelect, ...restSelects].map((select) => ({\n\t\t\ttype,\n\t\t\tisAll,\n\t\t\trightSelect: select as AnyPgSelect,\n\t\t}));\n\n\t\tfor (const setOperator of setOperators) {\n\t\t\tif (!haveSameKeys((leftSelect as any).getSelectedFields(), setOperator.rightSelect.getSelectedFields())) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Set operator error (union / intersect / except): selected fields are not the same or are in a different order',\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn (leftSelect as AnyPgSelect).addSetOperators(setOperators) as any;\n\t};\n}\n\nconst getPgSetOperators = () => ({\n\tunion,\n\tunionAll,\n\tintersect,\n\tintersectAll,\n\texcept,\n\texceptAll,\n});\n\n/**\n * Adds `union` set operator to the query.\n *\n * Calling this method will combine the result sets of the `select` statements and remove any duplicate rows that appear across them.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#union}\n *\n * @example\n *\n * ```ts\n * // Select all unique names from customers and users tables\n * import { union } from 'drizzle-orm/pg-core'\n *\n * await union(\n *   db.select({ name: users.name }).from(users),\n *   db.select({ name: customers.name }).from(customers)\n * );\n * // or\n * await db.select({ name: users.name })\n *   .from(users)\n *   .union(\n *     db.select({ name: customers.name }).from(customers)\n *   );\n * ```\n */\nexport const union = createSetOperator('union', false);\n\n/**\n * Adds `union all` set operator to the query.\n *\n * Calling this method will combine the result-set of the `select` statements and keep all duplicate rows that appear across them.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#union-all}\n *\n * @example\n *\n * ```ts\n * // Select all transaction ids from both online and in-store sales\n * import { unionAll } from 'drizzle-orm/pg-core'\n *\n * await unionAll(\n *   db.select({ transaction: onlineSales.transactionId }).from(onlineSales),\n *   db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)\n * );\n * // or\n * await db.select({ transaction: onlineSales.transactionId })\n *   .from(onlineSales)\n *   .unionAll(\n *     db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)\n *   );\n * ```\n */\nexport const unionAll = createSetOperator('union', true);\n\n/**\n * Adds `intersect` set operator to the query.\n *\n * Calling this method will retain only the rows that are present in both result sets and eliminate duplicates.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#intersect}\n *\n * @example\n *\n * ```ts\n * // Select course names that are offered in both departments A and B\n * import { intersect } from 'drizzle-orm/pg-core'\n *\n * await intersect(\n *   db.select({ courseName: depA.courseName }).from(depA),\n *   db.select({ courseName: depB.courseName }).from(depB)\n * );\n * // or\n * await db.select({ courseName: depA.courseName })\n *   .from(depA)\n *   .intersect(\n *     db.select({ courseName: depB.courseName }).from(depB)\n *   );\n * ```\n */\nexport const intersect = createSetOperator('intersect', false);\n\n/**\n * Adds `intersect all` set operator to the query.\n *\n * Calling this method will retain only the rows that are present in both result sets including all duplicates.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#intersect-all}\n *\n * @example\n *\n * ```ts\n * // Select all products and quantities that are ordered by both regular and VIP customers\n * import { intersectAll } from 'drizzle-orm/pg-core'\n *\n * await intersectAll(\n *   db.select({\n *     productId: regularCustomerOrders.productId,\n *     quantityOrdered: regularCustomerOrders.quantityOrdered\n *   })\n *   .from(regularCustomerOrders),\n *   db.select({\n *     productId: vipCustomerOrders.productId,\n *     quantityOrdered: vipCustomerOrders.quantityOrdered\n *   })\n *   .from(vipCustomerOrders)\n * );\n * // or\n * await db.select({\n *   productId: regularCustomerOrders.productId,\n *   quantityOrdered: regularCustomerOrders.quantityOrdered\n * })\n * .from(regularCustomerOrders)\n * .intersectAll(\n *   db.select({\n *     productId: vipCustomerOrders.productId,\n *     quantityOrdered: vipCustomerOrders.quantityOrdered\n *   })\n *   .from(vipCustomerOrders)\n * );\n * ```\n */\nexport const intersectAll = createSetOperator('intersect', true);\n\n/**\n * Adds `except` set operator to the query.\n *\n * Calling this method will retrieve all unique rows from the left query, except for the rows that are present in the result set of the right query.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#except}\n *\n * @example\n *\n * ```ts\n * // Select all courses offered in department A but not in department B\n * import { except } from 'drizzle-orm/pg-core'\n *\n * await except(\n *   db.select({ courseName: depA.courseName }).from(depA),\n *   db.select({ courseName: depB.courseName }).from(depB)\n * );\n * // or\n * await db.select({ courseName: depA.courseName })\n *   .from(depA)\n *   .except(\n *     db.select({ courseName: depB.courseName }).from(depB)\n *   );\n * ```\n */\nexport const except = createSetOperator('except', false);\n\n/**\n * Adds `except all` set operator to the query.\n *\n * Calling this method will retrieve all rows from the left query, except for the rows that are present in the result set of the right query.\n *\n * See docs: {@link https://orm.drizzle.team/docs/set-operations#except-all}\n *\n * @example\n *\n * ```ts\n * // Select all products that are ordered by regular customers but not by VIP customers\n * import { exceptAll } from 'drizzle-orm/pg-core'\n *\n * await exceptAll(\n *   db.select({\n *     productId: regularCustomerOrders.productId,\n *     quantityOrdered: regularCustomerOrders.quantityOrdered\n *   })\n *   .from(regularCustomerOrders),\n *   db.select({\n *     productId: vipCustomerOrders.productId,\n *     quantityOrdered: vipCustomerOrders.quantityOrdered\n *   })\n *   .from(vipCustomerOrders)\n * );\n * // or\n * await db.select({\n *   productId: regularCustomerOrders.productId,\n *   quantityOrdered: regularCustomerOrders.quantityOrdered,\n * })\n * .from(regularCustomerOrders)\n * .exceptAll(\n *   db.select({\n *     productId: vipCustomerOrders.productId,\n *     quantityOrdered: vipCustomerOrders.quantityOrdered,\n *   })\n *   .from(vipCustomerOrders)\n * );\n * ```\n */\nexport const exceptAll = createSetOperator('except', true);\n","import { entityKind, is } from '~/entity.ts';\nimport type { PgDialectConfig } from '~/pg-core/dialect.ts';\nimport { PgDialect } from '~/pg-core/dialect.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport type { ColumnsSelection, SQLWrapper } from '~/sql/sql.ts';\nimport { WithSubquery } from '~/subquery.ts';\nimport type { PgColumn } from '../columns/index.ts';\nimport type { WithSubqueryWithSelection } from '../subquery.ts';\nimport { PgSelectBuilder } from './select.ts';\nimport type { SelectedFields } from './select.types.ts';\n\nexport class QueryBuilder {\n\tstatic readonly [entityKind]: string = 'PgQueryBuilder';\n\n\tprivate dialect: PgDialect | undefined;\n\tprivate dialectConfig: PgDialectConfig | undefined;\n\n\tconstructor(dialect?: PgDialect | PgDialectConfig) {\n\t\tthis.dialect = is(dialect, PgDialect) ? dialect : undefined;\n\t\tthis.dialectConfig = is(dialect, PgDialect) ? undefined : dialect;\n\t}\n\n\t$with<TAlias extends string>(alias: TAlias) {\n\t\tconst queryBuilder = this;\n\n\t\treturn {\n\t\t\tas<TSelection extends ColumnsSelection>(\n\t\t\t\tqb: TypedQueryBuilder<TSelection> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelection>),\n\t\t\t): WithSubqueryWithSelection<TSelection, TAlias> {\n\t\t\t\tif (typeof qb === 'function') {\n\t\t\t\t\tqb = qb(queryBuilder);\n\t\t\t\t}\n\n\t\t\t\treturn new Proxy(\n\t\t\t\t\tnew WithSubquery(qb.getSQL(), qb.getSelectedFields() as SelectedFields, alias, true),\n\t\t\t\t\tnew SelectionProxyHandler({ alias, sqlAliasedBehavior: 'alias', sqlBehavior: 'error' }),\n\t\t\t\t) as WithSubqueryWithSelection<TSelection, TAlias>;\n\t\t\t},\n\t\t};\n\t}\n\n\twith(...queries: WithSubquery[]) {\n\t\tconst self = this;\n\n\t\tfunction select(): PgSelectBuilder<undefined, 'qb'>;\n\t\tfunction select<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection, 'qb'>;\n\t\tfunction select<TSelection extends SelectedFields>(\n\t\t\tfields?: TSelection,\n\t\t): PgSelectBuilder<TSelection | undefined, 'qb'> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: undefined,\n\t\t\t\tdialect: self.getDialect(),\n\t\t\t\twithList: queries,\n\t\t\t});\n\t\t}\n\n\t\tfunction selectDistinct(): PgSelectBuilder<undefined, 'qb'>;\n\t\tfunction selectDistinct<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection, 'qb'>;\n\t\tfunction selectDistinct(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined, 'qb'> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: undefined,\n\t\t\t\tdialect: self.getDialect(),\n\t\t\t\tdistinct: true,\n\t\t\t});\n\t\t}\n\n\t\tfunction selectDistinctOn(on: (PgColumn | SQLWrapper)[]): PgSelectBuilder<undefined, 'qb'>;\n\t\tfunction selectDistinctOn<TSelection extends SelectedFields>(\n\t\t\ton: (PgColumn | SQLWrapper)[],\n\t\t\tfields: TSelection,\n\t\t): PgSelectBuilder<TSelection, 'qb'>;\n\t\tfunction selectDistinctOn(\n\t\t\ton: (PgColumn | SQLWrapper)[],\n\t\t\tfields?: SelectedFields,\n\t\t): PgSelectBuilder<SelectedFields | undefined, 'qb'> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: undefined,\n\t\t\t\tdialect: self.getDialect(),\n\t\t\t\tdistinct: { on },\n\t\t\t});\n\t\t}\n\n\t\treturn { select, selectDistinct, selectDistinctOn };\n\t}\n\n\tselect(): PgSelectBuilder<undefined, 'qb'>;\n\tselect<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection, 'qb'>;\n\tselect<TSelection extends SelectedFields>(fields?: TSelection): PgSelectBuilder<TSelection | undefined, 'qb'> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: undefined,\n\t\t\tdialect: this.getDialect(),\n\t\t});\n\t}\n\n\tselectDistinct(): PgSelectBuilder<undefined>;\n\tselectDistinct<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection>;\n\tselectDistinct(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: undefined,\n\t\t\tdialect: this.getDialect(),\n\t\t\tdistinct: true,\n\t\t});\n\t}\n\n\tselectDistinctOn(on: (PgColumn | SQLWrapper)[]): PgSelectBuilder<undefined>;\n\tselectDistinctOn<TSelection extends SelectedFields>(\n\t\ton: (PgColumn | SQLWrapper)[],\n\t\tfields: TSelection,\n\t): PgSelectBuilder<TSelection>;\n\tselectDistinctOn(\n\t\ton: (PgColumn | SQLWrapper)[],\n\t\tfields?: SelectedFields,\n\t): PgSelectBuilder<SelectedFields | undefined> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: undefined,\n\t\t\tdialect: this.getDialect(),\n\t\t\tdistinct: { on },\n\t\t});\n\t}\n\n\t// Lazy load dialect to avoid circular dependency\n\tprivate getDialect() {\n\t\tif (!this.dialect) {\n\t\t\tthis.dialect = new PgDialect(this.dialectConfig);\n\t\t}\n\n\t\treturn this.dialect;\n\t}\n}\n","import { entityKind, is } from '~/entity.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport type { IndexColumn } from '~/pg-core/indexes.ts';\nimport type {\n\tPgPreparedQuery,\n\tPgQueryResultHKT,\n\tPgQueryResultKind,\n\tPgSession,\n\tPreparedQueryConfig,\n} from '~/pg-core/session.ts';\nimport type { PgTable, TableConfig } from '~/pg-core/table.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport type { SelectResultFields } from '~/query-builders/select.types.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport type { Placeholder, Query, SQLWrapper } from '~/sql/sql.ts';\nimport { Param, SQL, sql } from '~/sql/sql.ts';\nimport type { Subquery } from '~/subquery.ts';\nimport type { InferInsertModel } from '~/table.ts';\nimport { Columns, Table } from '~/table.ts';\nimport { tracer } from '~/tracing.ts';\nimport { haveSameKeys, mapUpdateSet, orderSelectedFields } from '~/utils.ts';\nimport type { AnyPgColumn, PgColumn } from '../columns/common.ts';\nimport { QueryBuilder } from './query-builder.ts';\nimport type { SelectedFieldsFlat, SelectedFieldsOrdered } from './select.types.ts';\nimport type { PgUpdateSetSource } from './update.ts';\n\nexport interface PgInsertConfig<TTable extends PgTable = PgTable> {\n\ttable: TTable;\n\tvalues: Record<string, Param | SQL>[] | PgInsertSelectQueryBuilder<TTable> | SQL;\n\twithList?: Subquery[];\n\tonConflict?: SQL;\n\treturning?: SelectedFieldsOrdered;\n\tselect?: boolean;\n\toverridingSystemValue_?: boolean;\n}\n\nexport type PgInsertValue<TTable extends PgTable<TableConfig>, OverrideT extends boolean = false> =\n\t& {\n\t\t[Key in keyof InferInsertModel<TTable, { dbColumnNames: false; override: OverrideT }>]:\n\t\t\t| InferInsertModel<TTable, { dbColumnNames: false; override: OverrideT }>[Key]\n\t\t\t| SQL\n\t\t\t| Placeholder;\n\t}\n\t& {};\n\nexport type PgInsertSelectQueryBuilder<TTable extends PgTable> = TypedQueryBuilder<\n\t{ [K in keyof TTable['$inferInsert']]: AnyPgColumn | SQL | SQL.Aliased | TTable['$inferInsert'][K] }\n>;\n\nexport class PgInsertBuilder<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tOverrideT extends boolean = false,\n> {\n\tstatic readonly [entityKind]: string = 'PgInsertBuilder';\n\n\tconstructor(\n\t\tprivate table: TTable,\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t\tprivate withList?: Subquery[],\n\t\tprivate overridingSystemValue_?: boolean,\n\t) {}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\toverridingSystemValue(): Omit<PgInsertBuilder<TTable, TQueryResult, true>, 'overridingSystemValue'> {\n\t\tthis.overridingSystemValue_ = true;\n\t\treturn this as any;\n\t}\n\n\tvalues(value: PgInsertValue<TTable, OverrideT>): PgInsertBase<TTable, TQueryResult>;\n\tvalues(values: PgInsertValue<TTable, OverrideT>[]): PgInsertBase<TTable, TQueryResult>;\n\tvalues(\n\t\tvalues: PgInsertValue<TTable, OverrideT> | PgInsertValue<TTable, OverrideT>[],\n\t): PgInsertBase<TTable, TQueryResult> {\n\t\tvalues = Array.isArray(values) ? values : [values];\n\t\tif (values.length === 0) {\n\t\t\tthrow new Error('values() must be called with at least one value');\n\t\t}\n\t\tconst mappedValues = values.map((entry) => {\n\t\t\tconst result: Record<string, Param | SQL> = {};\n\t\t\tconst cols = this.table[Table.Symbol.Columns];\n\t\t\tfor (const colKey of Object.keys(entry)) {\n\t\t\t\tconst colValue = entry[colKey as keyof typeof entry];\n\t\t\t\tresult[colKey] = is(colValue, SQL) ? colValue : new Param(colValue, cols[colKey]);\n\t\t\t}\n\t\t\treturn result;\n\t\t});\n\n\t\treturn this.authToken === undefined\n\t\t\t? new PgInsertBase(\n\t\t\t\tthis.table,\n\t\t\t\tmappedValues,\n\t\t\t\tthis.session,\n\t\t\t\tthis.dialect,\n\t\t\t\tthis.withList,\n\t\t\t\tfalse,\n\t\t\t\tthis.overridingSystemValue_,\n\t\t\t)\n\t\t\t: new PgInsertBase(\n\t\t\t\tthis.table,\n\t\t\t\tmappedValues,\n\t\t\t\tthis.session,\n\t\t\t\tthis.dialect,\n\t\t\t\tthis.withList,\n\t\t\t\tfalse,\n\t\t\t\tthis.overridingSystemValue_,\n\t\t\t).setToken(this.authToken) as any;\n\t}\n\n\tselect(selectQuery: (qb: QueryBuilder) => PgInsertSelectQueryBuilder<TTable>): PgInsertBase<TTable, TQueryResult>;\n\tselect(selectQuery: (qb: QueryBuilder) => SQL): PgInsertBase<TTable, TQueryResult>;\n\tselect(selectQuery: SQL): PgInsertBase<TTable, TQueryResult>;\n\tselect(selectQuery: PgInsertSelectQueryBuilder<TTable>): PgInsertBase<TTable, TQueryResult>;\n\tselect(\n\t\tselectQuery:\n\t\t\t| SQL\n\t\t\t| PgInsertSelectQueryBuilder<TTable>\n\t\t\t| ((qb: QueryBuilder) => PgInsertSelectQueryBuilder<TTable> | SQL),\n\t): PgInsertBase<TTable, TQueryResult> {\n\t\tconst select = typeof selectQuery === 'function' ? selectQuery(new QueryBuilder()) : selectQuery;\n\n\t\tif (\n\t\t\t!is(select, SQL)\n\t\t\t&& !haveSameKeys(this.table[Columns], select._.selectedFields)\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t'Insert select error: selected fields are not the same or are in a different order compared to the table definition',\n\t\t\t);\n\t\t}\n\n\t\treturn new PgInsertBase(this.table, select, this.session, this.dialect, this.withList, true);\n\t}\n}\n\nexport type PgInsertWithout<T extends AnyPgInsert, TDynamic extends boolean, K extends keyof T & string> =\n\tTDynamic extends true ? T\n\t\t: Omit<\n\t\t\tPgInsertBase<\n\t\t\t\tT['_']['table'],\n\t\t\t\tT['_']['queryResult'],\n\t\t\t\tT['_']['returning'],\n\t\t\t\tTDynamic,\n\t\t\t\tT['_']['excludedMethods'] | K\n\t\t\t>,\n\t\t\tT['_']['excludedMethods'] | K\n\t\t>;\n\nexport type PgInsertReturning<\n\tT extends AnyPgInsert,\n\tTDynamic extends boolean,\n\tTSelectedFields extends SelectedFieldsFlat,\n> = PgInsertBase<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tSelectResultFields<TSelectedFields>,\n\tTDynamic,\n\tT['_']['excludedMethods']\n>;\n\nexport type PgInsertReturningAll<T extends AnyPgInsert, TDynamic extends boolean> = PgInsertBase<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tT['_']['table']['$inferSelect'],\n\tTDynamic,\n\tT['_']['excludedMethods']\n>;\n\nexport interface PgInsertOnConflictDoUpdateConfig<T extends AnyPgInsert> {\n\ttarget: IndexColumn | IndexColumn[];\n\t/** @deprecated use either `targetWhere` or `setWhere` */\n\twhere?: SQL;\n\t// TODO: add tests for targetWhere and setWhere\n\ttargetWhere?: SQL;\n\tsetWhere?: SQL;\n\tset: PgUpdateSetSource<T['_']['table']>;\n}\n\nexport type PgInsertPrepare<T extends AnyPgInsert> = PgPreparedQuery<\n\tPreparedQueryConfig & {\n\t\texecute: T['_']['returning'] extends undefined ? PgQueryResultKind<T['_']['queryResult'], never>\n\t\t\t: T['_']['returning'][];\n\t}\n>;\n\nexport type PgInsertDynamic<T extends AnyPgInsert> = PgInsert<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tT['_']['returning']\n>;\n\nexport type AnyPgInsert = PgInsertBase<any, any, any, any, any>;\n\nexport type PgInsert<\n\tTTable extends PgTable = PgTable,\n\tTQueryResult extends PgQueryResultHKT = PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = Record<string, unknown> | undefined,\n> = PgInsertBase<TTable, TQueryResult, TReturning, true, never>;\n\nexport interface PgInsertBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n> extends\n\tQueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>,\n\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\tSQLWrapper\n{\n\treadonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly table: TTable;\n\t\treadonly queryResult: TQueryResult;\n\t\treadonly returning: TReturning;\n\t\treadonly dynamic: TDynamic;\n\t\treadonly excludedMethods: TExcludedMethods;\n\t\treadonly result: TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[];\n\t};\n}\n\nexport class PgInsertBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTDynamic extends boolean = false,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTExcludedMethods extends string = never,\n> extends QueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>\n\timplements\n\t\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\t\tSQLWrapper\n{\n\tstatic override readonly [entityKind]: string = 'PgInsert';\n\n\tprivate config: PgInsertConfig<TTable>;\n\n\tconstructor(\n\t\ttable: TTable,\n\t\tvalues: PgInsertConfig['values'],\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t\twithList?: Subquery[],\n\t\tselect?: boolean,\n\t\toverridingSystemValue_?: boolean,\n\t) {\n\t\tsuper();\n\t\tthis.config = { table, values: values as any, withList, select, overridingSystemValue_ };\n\t}\n\n\t/**\n\t * Adds a `returning` clause to the query.\n\t *\n\t * Calling this method will return the specified fields of the inserted rows. If no fields are specified, all fields will be returned.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/insert#insert-returning}\n\t *\n\t * @example\n\t * ```ts\n\t * // Insert one row and return all fields\n\t * const insertedCar: Car[] = await db.insert(cars)\n\t *   .values({ brand: 'BMW' })\n\t *   .returning();\n\t *\n\t * // Insert one row and return only the id\n\t * const insertedCarId: { id: number }[] = await db.insert(cars)\n\t *   .values({ brand: 'BMW' })\n\t *   .returning({ id: cars.id });\n\t * ```\n\t */\n\treturning(): PgInsertWithout<PgInsertReturningAll<this, TDynamic>, TDynamic, 'returning'>;\n\treturning<TSelectedFields extends SelectedFieldsFlat>(\n\t\tfields: TSelectedFields,\n\t): PgInsertWithout<PgInsertReturning<this, TDynamic, TSelectedFields>, TDynamic, 'returning'>;\n\treturning(\n\t\tfields: SelectedFieldsFlat = this.config.table[Table.Symbol.Columns],\n\t): PgInsertWithout<AnyPgInsert, TDynamic, 'returning'> {\n\t\tthis.config.returning = orderSelectedFields<PgColumn>(fields);\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds an `on conflict do nothing` clause to the query.\n\t *\n\t * Calling this method simply avoids inserting a row as its alternative action.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/insert#on-conflict-do-nothing}\n\t *\n\t * @param config The `target` and `where` clauses.\n\t *\n\t * @example\n\t * ```ts\n\t * // Insert one row and cancel the insert if there's a conflict\n\t * await db.insert(cars)\n\t *   .values({ id: 1, brand: 'BMW' })\n\t *   .onConflictDoNothing();\n\t *\n\t * // Explicitly specify conflict target\n\t * await db.insert(cars)\n\t *   .values({ id: 1, brand: 'BMW' })\n\t *   .onConflictDoNothing({ target: cars.id });\n\t * ```\n\t */\n\tonConflictDoNothing(\n\t\tconfig: { target?: IndexColumn | IndexColumn[]; where?: SQL } = {},\n\t): PgInsertWithout<this, TDynamic, 'onConflictDoNothing' | 'onConflictDoUpdate'> {\n\t\tif (config.target === undefined) {\n\t\t\tthis.config.onConflict = sql`do nothing`;\n\t\t} else {\n\t\t\tlet targetColumn = '';\n\t\t\ttargetColumn = Array.isArray(config.target)\n\t\t\t\t? config.target.map((it) => this.dialect.escapeName(this.dialect.casing.getColumnCasing(it))).join(',')\n\t\t\t\t: this.dialect.escapeName(this.dialect.casing.getColumnCasing(config.target));\n\n\t\t\tconst whereSql = config.where ? sql` where ${config.where}` : undefined;\n\t\t\tthis.config.onConflict = sql`(${sql.raw(targetColumn)})${whereSql} do nothing`;\n\t\t}\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds an `on conflict do update` clause to the query.\n\t *\n\t * Calling this method will update the existing row that conflicts with the row proposed for insertion as its alternative action.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/insert#upserts-and-conflicts}\n\t *\n\t * @param config The `target`, `set` and `where` clauses.\n\t *\n\t * @example\n\t * ```ts\n\t * // Update the row if there's a conflict\n\t * await db.insert(cars)\n\t *   .values({ id: 1, brand: 'BMW' })\n\t *   .onConflictDoUpdate({\n\t *     target: cars.id,\n\t *     set: { brand: 'Porsche' }\n\t *   });\n\t *\n\t * // Upsert with 'where' clause\n\t * await db.insert(cars)\n\t *   .values({ id: 1, brand: 'BMW' })\n\t *   .onConflictDoUpdate({\n\t *     target: cars.id,\n\t *     set: { brand: 'newBMW' },\n\t *     targetWhere: sql`${cars.createdAt} > '2023-01-01'::date`,\n\t *   });\n\t * ```\n\t */\n\tonConflictDoUpdate(\n\t\tconfig: PgInsertOnConflictDoUpdateConfig<this>,\n\t): PgInsertWithout<this, TDynamic, 'onConflictDoNothing' | 'onConflictDoUpdate'> {\n\t\tif (config.where && (config.targetWhere || config.setWhere)) {\n\t\t\tthrow new Error(\n\t\t\t\t'You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.',\n\t\t\t);\n\t\t}\n\t\tconst whereSql = config.where ? sql` where ${config.where}` : undefined;\n\t\tconst targetWhereSql = config.targetWhere ? sql` where ${config.targetWhere}` : undefined;\n\t\tconst setWhereSql = config.setWhere ? sql` where ${config.setWhere}` : undefined;\n\t\tconst setSql = this.dialect.buildUpdateSet(this.config.table, mapUpdateSet(this.config.table, config.set));\n\t\tlet targetColumn = '';\n\t\ttargetColumn = Array.isArray(config.target)\n\t\t\t? config.target.map((it) => this.dialect.escapeName(this.dialect.casing.getColumnCasing(it))).join(',')\n\t\t\t: this.dialect.escapeName(this.dialect.casing.getColumnCasing(config.target));\n\t\tthis.config.onConflict = sql`(${\n\t\t\tsql.raw(targetColumn)\n\t\t})${targetWhereSql} do update set ${setSql}${whereSql}${setWhereSql}`;\n\t\treturn this as any;\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this.dialect.buildInsertQuery(this.config);\n\t}\n\n\ttoSQL(): Query {\n\t\tconst { typings: _typings, ...rest } = this.dialect.sqlToQuery(this.getSQL());\n\t\treturn rest;\n\t}\n\n\t/** @internal */\n\t_prepare(name?: string): PgInsertPrepare<this> {\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\treturn this.session.prepareQuery<\n\t\t\t\tPreparedQueryConfig & {\n\t\t\t\t\texecute: TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[];\n\t\t\t\t}\n\t\t\t>(this.dialect.sqlToQuery(this.getSQL()), this.config.returning, name, true);\n\t\t});\n\t}\n\n\tprepare(name: string): PgInsertPrepare<this> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\toverride execute: ReturnType<this['prepare']>['execute'] = (placeholderValues) => {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(placeholderValues, this.authToken);\n\t\t});\n\t};\n\n\t$dynamic(): PgInsertDynamic<this> {\n\t\treturn this as any;\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport type {\n\tPgPreparedQuery,\n\tPgQueryResultHKT,\n\tPgQueryResultKind,\n\tPgSession,\n\tPreparedQueryConfig,\n} from '~/pg-core/session.ts';\nimport type { PgMaterializedView } from '~/pg-core/view.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport type { Query, SQL, SQLWrapper } from '~/sql/sql.ts';\nimport { tracer } from '~/tracing.ts';\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface PgRefreshMaterializedView<TQueryResult extends PgQueryResultHKT>\n\textends\n\t\tQueryPromise<PgQueryResultKind<TQueryResult, never>>,\n\t\tRunnableQuery<PgQueryResultKind<TQueryResult, never>, 'pg'>,\n\t\tSQLWrapper\n{\n\treadonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly result: PgQueryResultKind<TQueryResult, never>;\n\t};\n}\n\nexport class PgRefreshMaterializedView<TQueryResult extends PgQueryResultHKT>\n\textends QueryPromise<PgQueryResultKind<TQueryResult, never>>\n\timplements RunnableQuery<PgQueryResultKind<TQueryResult, never>, 'pg'>, SQLWrapper\n{\n\tstatic override readonly [entityKind]: string = 'PgRefreshMaterializedView';\n\n\tprivate config: {\n\t\tview: PgMaterializedView;\n\t\tconcurrently?: boolean;\n\t\twithNoData?: boolean;\n\t};\n\n\tconstructor(\n\t\tview: PgMaterializedView,\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t) {\n\t\tsuper();\n\t\tthis.config = { view };\n\t}\n\n\tconcurrently(): this {\n\t\tif (this.config.withNoData !== undefined) {\n\t\t\tthrow new Error('Cannot use concurrently and withNoData together');\n\t\t}\n\t\tthis.config.concurrently = true;\n\t\treturn this;\n\t}\n\n\twithNoData(): this {\n\t\tif (this.config.concurrently !== undefined) {\n\t\t\tthrow new Error('Cannot use concurrently and withNoData together');\n\t\t}\n\t\tthis.config.withNoData = true;\n\t\treturn this;\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this.dialect.buildRefreshMaterializedViewQuery(this.config);\n\t}\n\n\ttoSQL(): Query {\n\t\tconst { typings: _typings, ...rest } = this.dialect.sqlToQuery(this.getSQL());\n\t\treturn rest;\n\t}\n\n\t/** @internal */\n\t_prepare(name?: string): PgPreparedQuery<\n\t\tPreparedQueryConfig & {\n\t\t\texecute: PgQueryResultKind<TQueryResult, never>;\n\t\t}\n\t> {\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\treturn this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()), undefined, name, true);\n\t\t});\n\t}\n\n\tprepare(name: string): PgPreparedQuery<\n\t\tPreparedQueryConfig & {\n\t\t\texecute: PgQueryResultKind<TQueryResult, never>;\n\t\t}\n\t> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\texecute: ReturnType<this['prepare']>['execute'] = (placeholderValues) => {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(placeholderValues, this.authToken);\n\t\t});\n\t};\n}\n","import type { GetColumnData } from '~/column.ts';\nimport { entityKind, is } from '~/entity.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport type {\n\tPgPreparedQuery,\n\tPgQueryResultHKT,\n\tPgQueryResultKind,\n\tPgSession,\n\tPreparedQueryConfig,\n} from '~/pg-core/session.ts';\nimport { PgTable } from '~/pg-core/table.ts';\nimport type {\n\tAppendToNullabilityMap,\n\tAppendToResult,\n\tGetSelectTableName,\n\tGetSelectTableSelection,\n\tJoinNullability,\n\tJoinType,\n\tSelectMode,\n\tSelectResult,\n} from '~/query-builders/select.types.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport { type ColumnsSelection, type Query, SQL, type SQLWrapper } from '~/sql/sql.ts';\nimport { Subquery } from '~/subquery.ts';\nimport { Table } from '~/table.ts';\nimport { type Assume, getTableLikeName, mapUpdateSet, orderSelectedFields, type UpdateSet } from '~/utils.ts';\nimport { ViewBaseConfig } from '~/view-common.ts';\nimport type { PgColumn } from '../columns/common.ts';\nimport type { PgViewBase } from '../view-base.ts';\nimport type { PgSelectJoinConfig, SelectedFields, SelectedFieldsOrdered } from './select.types.ts';\n\nexport interface PgUpdateConfig {\n\twhere?: SQL | undefined;\n\tset: UpdateSet;\n\ttable: PgTable;\n\tfrom?: PgTable | Subquery | PgViewBase | SQL;\n\tjoins: PgSelectJoinConfig[];\n\treturning?: SelectedFieldsOrdered;\n\twithList?: Subquery[];\n}\n\nexport type PgUpdateSetSource<TTable extends PgTable> =\n\t& {\n\t\t[Key in keyof TTable['$inferInsert']]?:\n\t\t\t| GetColumnData<TTable['_']['columns'][Key]>\n\t\t\t| SQL\n\t\t\t| PgColumn;\n\t}\n\t& {};\n\nexport class PgUpdateBuilder<TTable extends PgTable, TQueryResult extends PgQueryResultHKT> {\n\tstatic readonly [entityKind]: string = 'PgUpdateBuilder';\n\n\tdeclare readonly _: {\n\t\treadonly table: TTable;\n\t};\n\n\tconstructor(\n\t\tprivate table: TTable,\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t\tprivate withList?: Subquery[],\n\t) {}\n\n\tprivate authToken?: string;\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\tset(\n\t\tvalues: PgUpdateSetSource<TTable>,\n\t): PgUpdateWithout<PgUpdateBase<TTable, TQueryResult>, false, 'leftJoin' | 'rightJoin' | 'innerJoin' | 'fullJoin'> {\n\t\treturn this.authToken === undefined\n\t\t\t? new PgUpdateBase<TTable, TQueryResult>(\n\t\t\t\tthis.table,\n\t\t\t\tmapUpdateSet(this.table, values),\n\t\t\t\tthis.session,\n\t\t\t\tthis.dialect,\n\t\t\t\tthis.withList,\n\t\t\t)\n\t\t\t: new PgUpdateBase<TTable, TQueryResult>(\n\t\t\t\tthis.table,\n\t\t\t\tmapUpdateSet(this.table, values),\n\t\t\t\tthis.session,\n\t\t\t\tthis.dialect,\n\t\t\t\tthis.withList,\n\t\t\t).setToken(this.authToken);\n\t}\n}\n\nexport type PgUpdateWithout<\n\tT extends AnyPgUpdate,\n\tTDynamic extends boolean,\n\tK extends keyof T & string,\n> = TDynamic extends true ? T : Omit<\n\tPgUpdateBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tT['_']['from'],\n\t\tT['_']['returning'],\n\t\tT['_']['nullabilityMap'],\n\t\tT['_']['joins'],\n\t\tTDynamic,\n\t\tT['_']['excludedMethods'] | K\n\t>,\n\tT['_']['excludedMethods'] | K\n>;\n\nexport type PgUpdateWithJoins<\n\tT extends AnyPgUpdate,\n\tTDynamic extends boolean,\n\tTFrom extends PgTable | Subquery | PgViewBase | SQL,\n> = TDynamic extends true ? T : Omit<\n\tPgUpdateBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tTFrom,\n\t\tT['_']['returning'],\n\t\tAppendToNullabilityMap<T['_']['nullabilityMap'], GetSelectTableName<TFrom>, 'inner'>,\n\t\t[...T['_']['joins'], {\n\t\t\tname: GetSelectTableName<TFrom>;\n\t\t\tjoinType: 'inner';\n\t\t\ttable: TFrom;\n\t\t}],\n\t\tTDynamic,\n\t\tExclude<T['_']['excludedMethods'] | 'from', 'leftJoin' | 'rightJoin' | 'innerJoin' | 'fullJoin'>\n\t>,\n\tExclude<T['_']['excludedMethods'] | 'from', 'leftJoin' | 'rightJoin' | 'innerJoin' | 'fullJoin'>\n>;\n\nexport type PgUpdateJoinFn<\n\tT extends AnyPgUpdate,\n\tTDynamic extends boolean,\n\tTJoinType extends JoinType,\n> = <\n\tTJoinedTable extends PgTable | Subquery | PgViewBase | SQL,\n>(\n\ttable: TJoinedTable,\n\ton:\n\t\t| (\n\t\t\t(\n\t\t\t\tupdateTable: T['_']['table']['_']['columns'],\n\t\t\t\tfrom: T['_']['from'] extends PgTable ? T['_']['from']['_']['columns']\n\t\t\t\t\t: T['_']['from'] extends Subquery | PgViewBase ? T['_']['from']['_']['selectedFields']\n\t\t\t\t\t: never,\n\t\t\t) => SQL | undefined\n\t\t)\n\t\t| SQL\n\t\t| undefined,\n) => PgUpdateJoin<T, TDynamic, TJoinType, TJoinedTable>;\n\nexport type PgUpdateJoin<\n\tT extends AnyPgUpdate,\n\tTDynamic extends boolean,\n\tTJoinType extends JoinType,\n\tTJoinedTable extends PgTable | Subquery | PgViewBase | SQL,\n> = TDynamic extends true ? T : PgUpdateBase<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tT['_']['from'],\n\tT['_']['returning'],\n\tAppendToNullabilityMap<T['_']['nullabilityMap'], GetSelectTableName<TJoinedTable>, TJoinType>,\n\t[...T['_']['joins'], {\n\t\tname: GetSelectTableName<TJoinedTable>;\n\t\tjoinType: TJoinType;\n\t\ttable: TJoinedTable;\n\t}],\n\tTDynamic,\n\tT['_']['excludedMethods']\n>;\n\ntype Join = {\n\tname: string | undefined;\n\tjoinType: JoinType;\n\ttable: PgTable | Subquery | PgViewBase | SQL;\n};\n\ntype AccumulateToResult<\n\tT extends AnyPgUpdate,\n\tTSelectMode extends SelectMode,\n\tTJoins extends Join[],\n\tTSelectedFields extends ColumnsSelection,\n> = TJoins extends [infer TJoin extends Join, ...infer TRest extends Join[]] ? AccumulateToResult<\n\t\tT,\n\t\tTSelectMode extends 'partial' ? TSelectMode : 'multiple',\n\t\tTRest,\n\t\tAppendToResult<\n\t\t\tT['_']['table']['_']['name'],\n\t\t\tTSelectedFields,\n\t\t\tTJoin['name'],\n\t\t\tTJoin['table'] extends Table ? TJoin['table']['_']['columns']\n\t\t\t\t: TJoin['table'] extends Subquery ? Assume<TJoin['table']['_']['selectedFields'], SelectedFields>\n\t\t\t\t: never,\n\t\t\tTSelectMode extends 'partial' ? TSelectMode : 'multiple'\n\t\t>\n\t>\n\t: TSelectedFields;\n\nexport type PgUpdateReturningAll<T extends AnyPgUpdate, TDynamic extends boolean> = PgUpdateWithout<\n\tPgUpdateBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tT['_']['from'],\n\t\tSelectResult<\n\t\t\tAccumulateToResult<\n\t\t\t\tT,\n\t\t\t\t'single',\n\t\t\t\tT['_']['joins'],\n\t\t\t\tGetSelectTableSelection<T['_']['table']>\n\t\t\t>,\n\t\t\t'partial',\n\t\t\tT['_']['nullabilityMap']\n\t\t>,\n\t\tT['_']['nullabilityMap'],\n\t\tT['_']['joins'],\n\t\tTDynamic,\n\t\tT['_']['excludedMethods']\n\t>,\n\tTDynamic,\n\t'returning'\n>;\n\nexport type PgUpdateReturning<\n\tT extends AnyPgUpdate,\n\tTDynamic extends boolean,\n\tTSelectedFields extends SelectedFields,\n> = PgUpdateWithout<\n\tPgUpdateBase<\n\t\tT['_']['table'],\n\t\tT['_']['queryResult'],\n\t\tT['_']['from'],\n\t\tSelectResult<\n\t\t\tAccumulateToResult<\n\t\t\t\tT,\n\t\t\t\t'partial',\n\t\t\t\tT['_']['joins'],\n\t\t\t\tTSelectedFields\n\t\t\t>,\n\t\t\t'partial',\n\t\t\tT['_']['nullabilityMap']\n\t\t>,\n\t\tT['_']['nullabilityMap'],\n\t\tT['_']['joins'],\n\t\tTDynamic,\n\t\tT['_']['excludedMethods']\n\t>,\n\tTDynamic,\n\t'returning'\n>;\n\nexport type PgUpdatePrepare<T extends AnyPgUpdate> = PgPreparedQuery<\n\tPreparedQueryConfig & {\n\t\texecute: T['_']['returning'] extends undefined ? PgQueryResultKind<T['_']['queryResult'], never>\n\t\t\t: T['_']['returning'][];\n\t}\n>;\n\nexport type PgUpdateDynamic<T extends AnyPgUpdate> = PgUpdate<\n\tT['_']['table'],\n\tT['_']['queryResult'],\n\tT['_']['from'],\n\tT['_']['returning'],\n\tT['_']['nullabilityMap']\n>;\n\nexport type PgUpdate<\n\tTTable extends PgTable = PgTable,\n\tTQueryResult extends PgQueryResultHKT = PgQueryResultHKT,\n\tTFrom extends PgTable | Subquery | PgViewBase | SQL | undefined = undefined,\n\tTReturning extends Record<string, unknown> | undefined = Record<string, unknown> | undefined,\n\tTNullabilityMap extends Record<string, JoinNullability> = Record<TTable['_']['name'], 'not-null'>,\n\tTJoins extends Join[] = [],\n> = PgUpdateBase<TTable, TQueryResult, TFrom, TReturning, TNullabilityMap, TJoins, true, never>;\n\nexport type AnyPgUpdate = PgUpdateBase<any, any, any, any, any, any, any, any>;\n\nexport interface PgUpdateBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTFrom extends PgTable | Subquery | PgViewBase | SQL | undefined = undefined,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\tTNullabilityMap extends Record<string, JoinNullability> = Record<TTable['_']['name'], 'not-null'>,\n\tTJoins extends Join[] = [],\n\tTDynamic extends boolean = false,\n\tTExcludedMethods extends string = never,\n> extends\n\tQueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>,\n\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\tSQLWrapper\n{\n\treadonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly table: TTable;\n\t\treadonly joins: TJoins;\n\t\treadonly nullabilityMap: TNullabilityMap;\n\t\treadonly queryResult: TQueryResult;\n\t\treadonly from: TFrom;\n\t\treadonly returning: TReturning;\n\t\treadonly dynamic: TDynamic;\n\t\treadonly excludedMethods: TExcludedMethods;\n\t\treadonly result: TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[];\n\t};\n}\n\nexport class PgUpdateBase<\n\tTTable extends PgTable,\n\tTQueryResult extends PgQueryResultHKT,\n\tTFrom extends PgTable | Subquery | PgViewBase | SQL | undefined = undefined,\n\tTReturning extends Record<string, unknown> | undefined = undefined,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTNullabilityMap extends Record<string, JoinNullability> = Record<TTable['_']['name'], 'not-null'>,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTJoins extends Join[] = [],\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTDynamic extends boolean = false,\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\tTExcludedMethods extends string = never,\n> extends QueryPromise<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[]>\n\timplements\n\t\tRunnableQuery<TReturning extends undefined ? PgQueryResultKind<TQueryResult, never> : TReturning[], 'pg'>,\n\t\tSQLWrapper\n{\n\tstatic override readonly [entityKind]: string = 'PgUpdate';\n\n\tprivate config: PgUpdateConfig;\n\tprivate tableName: string | undefined;\n\tprivate joinsNotNullableMap: Record<string, boolean>;\n\n\tconstructor(\n\t\ttable: TTable,\n\t\tset: UpdateSet,\n\t\tprivate session: PgSession,\n\t\tprivate dialect: PgDialect,\n\t\twithList?: Subquery[],\n\t) {\n\t\tsuper();\n\t\tthis.config = { set, table, withList, joins: [] };\n\t\tthis.tableName = getTableLikeName(table);\n\t\tthis.joinsNotNullableMap = typeof this.tableName === 'string' ? { [this.tableName]: true } : {};\n\t}\n\n\tfrom<TFrom extends PgTable | Subquery | PgViewBase | SQL>(\n\t\tsource: TFrom,\n\t): PgUpdateWithJoins<this, TDynamic, TFrom> {\n\t\tconst tableName = getTableLikeName(source);\n\t\tif (typeof tableName === 'string') {\n\t\t\tthis.joinsNotNullableMap[tableName] = true;\n\t\t}\n\t\tthis.config.from = source;\n\t\treturn this as any;\n\t}\n\n\tprivate getTableLikeFields(table: PgTable | Subquery | PgViewBase): Record<string, unknown> {\n\t\tif (is(table, PgTable)) {\n\t\t\treturn table[Table.Symbol.Columns];\n\t\t} else if (is(table, Subquery)) {\n\t\t\treturn table._.selectedFields;\n\t\t}\n\t\treturn table[ViewBaseConfig].selectedFields;\n\t}\n\n\tprivate createJoin<TJoinType extends JoinType>(\n\t\tjoinType: TJoinType,\n\t): PgUpdateJoinFn<this, TDynamic, TJoinType> {\n\t\treturn ((\n\t\t\ttable: PgTable | Subquery | PgViewBase | SQL,\n\t\t\ton: ((updateTable: TTable, from: TFrom) => SQL | undefined) | SQL | undefined,\n\t\t) => {\n\t\t\tconst tableName = getTableLikeName(table);\n\n\t\t\tif (typeof tableName === 'string' && this.config.joins.some((join) => join.alias === tableName)) {\n\t\t\t\tthrow new Error(`Alias \"${tableName}\" is already used in this query`);\n\t\t\t}\n\n\t\t\tif (typeof on === 'function') {\n\t\t\t\tconst from = this.config.from && !is(this.config.from, SQL)\n\t\t\t\t\t? this.getTableLikeFields(this.config.from)\n\t\t\t\t\t: undefined;\n\t\t\t\ton = on(\n\t\t\t\t\tnew Proxy(\n\t\t\t\t\t\tthis.config.table[Table.Symbol.Columns],\n\t\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'sql', sqlBehavior: 'sql' }),\n\t\t\t\t\t) as any,\n\t\t\t\t\tfrom && new Proxy(\n\t\t\t\t\t\tfrom,\n\t\t\t\t\t\tnew SelectionProxyHandler({ sqlAliasedBehavior: 'sql', sqlBehavior: 'sql' }),\n\t\t\t\t\t) as any,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.config.joins.push({ on, table, joinType, alias: tableName });\n\n\t\t\tif (typeof tableName === 'string') {\n\t\t\t\tswitch (joinType) {\n\t\t\t\t\tcase 'left': {\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = false;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'right': {\n\t\t\t\t\t\tthis.joinsNotNullableMap = Object.fromEntries(\n\t\t\t\t\t\t\tObject.entries(this.joinsNotNullableMap).map(([key]) => [key, false]),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'inner': {\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'full': {\n\t\t\t\t\t\tthis.joinsNotNullableMap = Object.fromEntries(\n\t\t\t\t\t\t\tObject.entries(this.joinsNotNullableMap).map(([key]) => [key, false]),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tthis.joinsNotNullableMap[tableName] = false;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this as any;\n\t\t}) as any;\n\t}\n\n\tleftJoin = this.createJoin('left');\n\n\trightJoin = this.createJoin('right');\n\n\tinnerJoin = this.createJoin('inner');\n\n\tfullJoin = this.createJoin('full');\n\n\t/**\n\t * Adds a 'where' clause to the query.\n\t *\n\t * Calling this method will update only those rows that fulfill a specified condition.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/update}\n\t *\n\t * @param where the 'where' clause.\n\t *\n\t * @example\n\t * You can use conditional operators and `sql function` to filter the rows to be updated.\n\t *\n\t * ```ts\n\t * // Update all cars with green color\n\t * await db.update(cars).set({ color: 'red' })\n\t *   .where(eq(cars.color, 'green'));\n\t * // or\n\t * await db.update(cars).set({ color: 'red' })\n\t *   .where(sql`${cars.color} = 'green'`)\n\t * ```\n\t *\n\t * You can logically combine conditional operators with `and()` and `or()` operators:\n\t *\n\t * ```ts\n\t * // Update all BMW cars with a green color\n\t * await db.update(cars).set({ color: 'red' })\n\t *   .where(and(eq(cars.color, 'green'), eq(cars.brand, 'BMW')));\n\t *\n\t * // Update all cars with the green or blue color\n\t * await db.update(cars).set({ color: 'red' })\n\t *   .where(or(eq(cars.color, 'green'), eq(cars.color, 'blue')));\n\t * ```\n\t */\n\twhere(where: SQL | undefined): PgUpdateWithout<this, TDynamic, 'where'> {\n\t\tthis.config.where = where;\n\t\treturn this as any;\n\t}\n\n\t/**\n\t * Adds a `returning` clause to the query.\n\t *\n\t * Calling this method will return the specified fields of the updated rows. If no fields are specified, all fields will be returned.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/update#update-with-returning}\n\t *\n\t * @example\n\t * ```ts\n\t * // Update all cars with the green color and return all fields\n\t * const updatedCars: Car[] = await db.update(cars)\n\t *   .set({ color: 'red' })\n\t *   .where(eq(cars.color, 'green'))\n\t *   .returning();\n\t *\n\t * // Update all cars with the green color and return only their id and brand fields\n\t * const updatedCarsIdsAndBrands: { id: number, brand: string }[] = await db.update(cars)\n\t *   .set({ color: 'red' })\n\t *   .where(eq(cars.color, 'green'))\n\t *   .returning({ id: cars.id, brand: cars.brand });\n\t * ```\n\t */\n\treturning(): PgUpdateReturningAll<this, TDynamic>;\n\treturning<TSelectedFields extends SelectedFields>(\n\t\tfields: TSelectedFields,\n\t): PgUpdateReturning<this, TDynamic, TSelectedFields>;\n\treturning(\n\t\tfields?: SelectedFields,\n\t): PgUpdateWithout<AnyPgUpdate, TDynamic, 'returning'> {\n\t\tif (!fields) {\n\t\t\tfields = Object.assign({}, this.config.table[Table.Symbol.Columns]);\n\n\t\t\tif (this.config.from) {\n\t\t\t\tconst tableName = getTableLikeName(this.config.from);\n\n\t\t\t\tif (typeof tableName === 'string' && this.config.from && !is(this.config.from, SQL)) {\n\t\t\t\t\tconst fromFields = this.getTableLikeFields(this.config.from);\n\t\t\t\t\tfields[tableName] = fromFields as any;\n\t\t\t\t}\n\n\t\t\t\tfor (const join of this.config.joins) {\n\t\t\t\t\tconst tableName = getTableLikeName(join.table);\n\n\t\t\t\t\tif (typeof tableName === 'string' && !is(join.table, SQL)) {\n\t\t\t\t\t\tconst fromFields = this.getTableLikeFields(join.table);\n\t\t\t\t\t\tfields[tableName] = fromFields as any;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.config.returning = orderSelectedFields<PgColumn>(fields);\n\t\treturn this as any;\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this.dialect.buildUpdateQuery(this.config);\n\t}\n\n\ttoSQL(): Query {\n\t\tconst { typings: _typings, ...rest } = this.dialect.sqlToQuery(this.getSQL());\n\t\treturn rest;\n\t}\n\n\t/** @internal */\n\t_prepare(name?: string): PgUpdatePrepare<this> {\n\t\tconst query = this.session.prepareQuery<\n\t\t\tPreparedQueryConfig & { execute: TReturning[] }\n\t\t>(this.dialect.sqlToQuery(this.getSQL()), this.config.returning, name, true);\n\t\tquery.joinsNotNullableMap = this.joinsNotNullableMap;\n\t\treturn query;\n\t}\n\n\tprepare(name: string): PgUpdatePrepare<this> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\toverride execute: ReturnType<this['prepare']>['execute'] = (placeholderValues) => {\n\t\treturn this._prepare().execute(placeholderValues, this.authToken);\n\t};\n\n\t$dynamic(): PgUpdateDynamic<this> {\n\t\treturn this as any;\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport { SQL, sql, type SQLWrapper } from '~/sql/sql.ts';\nimport type { PgSession } from '../session.ts';\nimport type { PgTable } from '../table.ts';\n\nexport class PgCountBuilder<\n\tTSession extends PgSession<any, any, any>,\n> extends SQL<number> implements Promise<number>, SQLWrapper {\n\tprivate sql: SQL<number>;\n\tprivate token?: string;\n\n\tstatic override readonly [entityKind] = 'PgCountBuilder';\n\t[Symbol.toStringTag] = 'PgCountBuilder';\n\n\tprivate session: TSession;\n\n\tprivate static buildEmbeddedCount(\n\t\tsource: PgTable | SQL | SQLWrapper,\n\t\tfilters?: SQL<unknown>,\n\t): SQL<number> {\n\t\treturn sql<number>`(select count(*) from ${source}${sql.raw(' where ').if(filters)}${filters})`;\n\t}\n\n\tprivate static buildCount(\n\t\tsource: PgTable | SQL | SQLWrapper,\n\t\tfilters?: SQL<unknown>,\n\t): SQL<number> {\n\t\treturn sql<number>`select count(*) as count from ${source}${sql.raw(' where ').if(filters)}${filters};`;\n\t}\n\n\tconstructor(\n\t\treadonly params: {\n\t\t\tsource: PgTable | SQL | SQLWrapper;\n\t\t\tfilters?: SQL<unknown>;\n\t\t\tsession: TSession;\n\t\t},\n\t) {\n\t\tsuper(PgCountBuilder.buildEmbeddedCount(params.source, params.filters).queryChunks);\n\n\t\tthis.mapWith(Number);\n\n\t\tthis.session = params.session;\n\n\t\tthis.sql = PgCountBuilder.buildCount(\n\t\t\tparams.source,\n\t\t\tparams.filters,\n\t\t);\n\t}\n\n\t/** @intrnal */\n\tsetToken(token: string) {\n\t\tthis.token = token;\n\t}\n\n\tthen<TResult1 = number, TResult2 = never>(\n\t\tonfulfilled?: ((value: number) => TResult1 | PromiseLike<TResult1>) | null | undefined,\n\t\tonrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | null | undefined,\n\t): Promise<TResult1 | TResult2> {\n\t\treturn Promise.resolve(this.session.count(this.sql, this.token))\n\t\t\t.then(\n\t\t\t\tonfulfilled,\n\t\t\t\tonrejected,\n\t\t\t);\n\t}\n\n\tcatch(\n\t\tonRejected?: ((reason: any) => any) | null | undefined,\n\t): Promise<number> {\n\t\treturn this.then(undefined, onRejected);\n\t}\n\n\tfinally(onFinally?: (() => void) | null | undefined): Promise<number> {\n\t\treturn this.then(\n\t\t\t(value) => {\n\t\t\t\tonFinally?.();\n\t\t\t\treturn value;\n\t\t\t},\n\t\t\t(reason) => {\n\t\t\t\tonFinally?.();\n\t\t\t\tthrow reason;\n\t\t\t},\n\t\t);\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport {\n\ttype BuildQueryResult,\n\ttype BuildRelationalQueryResult,\n\ttype DBQueryConfig,\n\tmapRelationalRow,\n\ttype TableRelationalConfig,\n\ttype TablesRelationalConfig,\n} from '~/relations.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport type { Query, QueryWithTypings, SQL, SQLWrapper } from '~/sql/sql.ts';\nimport { tracer } from '~/tracing.ts';\nimport type { KnownKeysOnly } from '~/utils.ts';\nimport type { PgDialect } from '../dialect.ts';\nimport type { PgPreparedQuery, PgSession, PreparedQueryConfig } from '../session.ts';\nimport type { PgTable } from '../table.ts';\n\nexport class RelationalQueryBuilder<TSchema extends TablesRelationalConfig, TFields extends TableRelationalConfig> {\n\tstatic readonly [entityKind]: string = 'PgRelationalQueryBuilder';\n\n\tconstructor(\n\t\tprivate fullSchema: Record<string, unknown>,\n\t\tprivate schema: TSchema,\n\t\tprivate tableNamesMap: Record<string, string>,\n\t\tprivate table: PgTable,\n\t\tprivate tableConfig: TableRelationalConfig,\n\t\tprivate dialect: PgDialect,\n\t\tprivate session: PgSession,\n\t) {}\n\n\tfindMany<TConfig extends DBQueryConfig<'many', true, TSchema, TFields>>(\n\t\tconfig?: KnownKeysOnly<TConfig, DBQueryConfig<'many', true, TSchema, TFields>>,\n\t): PgRelationalQuery<BuildQueryResult<TSchema, TFields, TConfig>[]> {\n\t\treturn new PgRelationalQuery(\n\t\t\tthis.fullSchema,\n\t\t\tthis.schema,\n\t\t\tthis.tableNamesMap,\n\t\t\tthis.table,\n\t\t\tthis.tableConfig,\n\t\t\tthis.dialect,\n\t\t\tthis.session,\n\t\t\tconfig ? (config as DBQueryConfig<'many', true>) : {},\n\t\t\t'many',\n\t\t);\n\t}\n\n\tfindFirst<TSelection extends Omit<DBQueryConfig<'many', true, TSchema, TFields>, 'limit'>>(\n\t\tconfig?: KnownKeysOnly<TSelection, Omit<DBQueryConfig<'many', true, TSchema, TFields>, 'limit'>>,\n\t): PgRelationalQuery<BuildQueryResult<TSchema, TFields, TSelection> | undefined> {\n\t\treturn new PgRelationalQuery(\n\t\t\tthis.fullSchema,\n\t\t\tthis.schema,\n\t\t\tthis.tableNamesMap,\n\t\t\tthis.table,\n\t\t\tthis.tableConfig,\n\t\t\tthis.dialect,\n\t\t\tthis.session,\n\t\t\tconfig ? { ...(config as DBQueryConfig<'many', true> | undefined), limit: 1 } : { limit: 1 },\n\t\t\t'first',\n\t\t);\n\t}\n}\n\nexport class PgRelationalQuery<TResult> extends QueryPromise<TResult>\n\timplements RunnableQuery<TResult, 'pg'>, SQLWrapper\n{\n\tstatic override readonly [entityKind]: string = 'PgRelationalQuery';\n\n\tdeclare readonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly result: TResult;\n\t};\n\n\tconstructor(\n\t\tprivate fullSchema: Record<string, unknown>,\n\t\tprivate schema: TablesRelationalConfig,\n\t\tprivate tableNamesMap: Record<string, string>,\n\t\tprivate table: PgTable,\n\t\tprivate tableConfig: TableRelationalConfig,\n\t\tprivate dialect: PgDialect,\n\t\tprivate session: PgSession,\n\t\tprivate config: DBQueryConfig<'many', true> | true,\n\t\tprivate mode: 'many' | 'first',\n\t) {\n\t\tsuper();\n\t}\n\n\t/** @internal */\n\t_prepare(name?: string): PgPreparedQuery<PreparedQueryConfig & { execute: TResult }> {\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\tconst { query, builtQuery } = this._toSQL();\n\n\t\t\treturn this.session.prepareQuery<PreparedQueryConfig & { execute: TResult }>(\n\t\t\t\tbuiltQuery,\n\t\t\t\tundefined,\n\t\t\t\tname,\n\t\t\t\ttrue,\n\t\t\t\t(rawRows, mapColumnValue) => {\n\t\t\t\t\tconst rows = rawRows.map((row) =>\n\t\t\t\t\t\tmapRelationalRow(this.schema, this.tableConfig, row, query.selection, mapColumnValue)\n\t\t\t\t\t);\n\t\t\t\t\tif (this.mode === 'first') {\n\t\t\t\t\t\treturn rows[0] as TResult;\n\t\t\t\t\t}\n\t\t\t\t\treturn rows as TResult;\n\t\t\t\t},\n\t\t\t);\n\t\t});\n\t}\n\n\tprepare(name: string): PgPreparedQuery<PreparedQueryConfig & { execute: TResult }> {\n\t\treturn this._prepare(name);\n\t}\n\n\tprivate _getQuery() {\n\t\treturn this.dialect.buildRelationalQueryWithoutPK({\n\t\t\tfullSchema: this.fullSchema,\n\t\t\tschema: this.schema,\n\t\t\ttableNamesMap: this.tableNamesMap,\n\t\t\ttable: this.table,\n\t\t\ttableConfig: this.tableConfig,\n\t\t\tqueryConfig: this.config,\n\t\t\ttableAlias: this.tableConfig.tsName,\n\t\t});\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this._getQuery().sql as SQL;\n\t}\n\n\tprivate _toSQL(): { query: BuildRelationalQueryResult; builtQuery: QueryWithTypings } {\n\t\tconst query = this._getQuery();\n\n\t\tconst builtQuery = this.dialect.sqlToQuery(query.sql as SQL);\n\n\t\treturn { query, builtQuery };\n\t}\n\n\ttoSQL(): Query {\n\t\treturn this._toSQL().builtQuery;\n\t}\n\n\tprivate authToken?: string;\n\t/** @internal */\n\tsetToken(token: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\toverride execute(): Promise<TResult> {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(undefined, this.authToken);\n\t\t});\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport type { PreparedQuery } from '~/session.ts';\nimport type { Query, SQL, SQLWrapper } from '~/sql/sql.ts';\n\nexport interface PgRaw<TResult> extends QueryPromise<TResult>, RunnableQuery<TResult, 'pg'>, SQLWrapper {}\n\nexport class PgRaw<TResult> extends QueryPromise<TResult>\n\timplements RunnableQuery<TResult, 'pg'>, SQLWrapper, PreparedQuery\n{\n\tstatic override readonly [entityKind]: string = 'PgRaw';\n\n\tdeclare readonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly result: TResult;\n\t};\n\n\tconstructor(\n\t\tpublic execute: () => Promise<TResult>,\n\t\tprivate sql: SQL,\n\t\tprivate query: Query,\n\t\tprivate mapBatchResult: (result: unknown) => unknown,\n\t) {\n\t\tsuper();\n\t}\n\n\t/** @internal */\n\tgetSQL() {\n\t\treturn this.sql;\n\t}\n\n\tgetQuery() {\n\t\treturn this.query;\n\t}\n\n\tmapResult(result: unknown, isFromBatch?: boolean) {\n\t\treturn isFromBatch ? this.mapBatchResult(result) : result;\n\t}\n\n\t_prepare(): PreparedQuery {\n\t\treturn this;\n\t}\n\n\t/** @internal */\n\tisResponseInArrayMode() {\n\t\treturn false;\n\t}\n}\n","import { entityKind } from '~/entity.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport {\n\tPgDeleteBase,\n\tPgInsertBuilder,\n\tPgSelectBuilder,\n\tPgUpdateBuilder,\n\tQueryBuilder,\n} from '~/pg-core/query-builders/index.ts';\nimport type {\n\tPgQueryResultHKT,\n\tPgQueryResultKind,\n\tPgSession,\n\tPgTransaction,\n\tPgTransactionConfig,\n\tPreparedQueryConfig,\n} from '~/pg-core/session.ts';\nimport type { PgTable } from '~/pg-core/table.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport type { ExtractTablesWithRelations, RelationalSchemaConfig, TablesRelationalConfig } from '~/relations.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport { type ColumnsSelection, type SQL, sql, type SQLWrapper } from '~/sql/sql.ts';\nimport { WithSubquery } from '~/subquery.ts';\nimport type { DrizzleTypeError } from '~/utils.ts';\nimport type { PgColumn } from './columns/index.ts';\nimport { PgCountBuilder } from './query-builders/count.ts';\nimport { RelationalQueryBuilder } from './query-builders/query.ts';\nimport { PgRaw } from './query-builders/raw.ts';\nimport { PgRefreshMaterializedView } from './query-builders/refresh-materialized-view.ts';\nimport type { SelectedFields } from './query-builders/select.types.ts';\nimport type { WithSubqueryWithSelection } from './subquery.ts';\nimport type { PgViewBase } from './view-base.ts';\nimport type { PgMaterializedView } from './view.ts';\n\nexport class PgDatabase<\n\tTQueryResult extends PgQueryResultHKT,\n\tTFullSchema extends Record<string, unknown> = Record<string, never>,\n\tTSchema extends TablesRelationalConfig = ExtractTablesWithRelations<TFullSchema>,\n> {\n\tstatic readonly [entityKind]: string = 'PgDatabase';\n\n\tdeclare readonly _: {\n\t\treadonly schema: TSchema | undefined;\n\t\treadonly fullSchema: TFullSchema;\n\t\treadonly tableNamesMap: Record<string, string>;\n\t\treadonly session: PgSession<TQueryResult, TFullSchema, TSchema>;\n\t};\n\n\tquery: TFullSchema extends Record<string, never>\n\t\t? DrizzleTypeError<'Seems like the schema generic is missing - did you forget to add it to your DB type?'>\n\t\t: {\n\t\t\t[K in keyof TSchema]: RelationalQueryBuilder<TSchema, TSchema[K]>;\n\t\t};\n\n\tconstructor(\n\t\t/** @internal */\n\t\treadonly dialect: PgDialect,\n\t\t/** @internal */\n\t\treadonly session: PgSession<any, any, any>,\n\t\tschema: RelationalSchemaConfig<TSchema> | undefined,\n\t) {\n\t\tthis._ = schema\n\t\t\t? {\n\t\t\t\tschema: schema.schema,\n\t\t\t\tfullSchema: schema.fullSchema as TFullSchema,\n\t\t\t\ttableNamesMap: schema.tableNamesMap,\n\t\t\t\tsession,\n\t\t\t}\n\t\t\t: {\n\t\t\t\tschema: undefined,\n\t\t\t\tfullSchema: {} as TFullSchema,\n\t\t\t\ttableNamesMap: {},\n\t\t\t\tsession,\n\t\t\t};\n\t\tthis.query = {} as typeof this['query'];\n\t\tif (this._.schema) {\n\t\t\tfor (const [tableName, columns] of Object.entries(this._.schema)) {\n\t\t\t\t(this.query as PgDatabase<TQueryResult, Record<string, any>>['query'])[tableName] = new RelationalQueryBuilder(\n\t\t\t\t\tschema!.fullSchema,\n\t\t\t\t\tthis._.schema,\n\t\t\t\t\tthis._.tableNamesMap,\n\t\t\t\t\tschema!.fullSchema[tableName] as PgTable,\n\t\t\t\t\tcolumns,\n\t\t\t\t\tdialect,\n\t\t\t\t\tsession,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a subquery that defines a temporary named result set as a CTE.\n\t *\n\t * It is useful for breaking down complex queries into simpler parts and for reusing the result set in subsequent parts of the query.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#with-clause}\n\t *\n\t * @param alias The alias for the subquery.\n\t *\n\t * Failure to provide an alias will result in a DrizzleTypeError, preventing the subquery from being referenced in other queries.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Create a subquery with alias 'sq' and use it in the select query\n\t * const sq = db.$with('sq').as(db.select().from(users).where(eq(users.id, 42)));\n\t *\n\t * const result = await db.with(sq).select().from(sq);\n\t * ```\n\t *\n\t * To select arbitrary SQL values as fields in a CTE and reference them in other CTEs or in the main query, you need to add aliases to them:\n\t *\n\t * ```ts\n\t * // Select an arbitrary SQL value as a field in a CTE and reference it in the main query\n\t * const sq = db.$with('sq').as(db.select({\n\t *   name: sql<string>`upper(${users.name})`.as('name'),\n\t * })\n\t * .from(users));\n\t *\n\t * const result = await db.with(sq).select({ name: sq.name }).from(sq);\n\t * ```\n\t */\n\t$with<TAlias extends string>(alias: TAlias) {\n\t\tconst self = this;\n\t\treturn {\n\t\t\tas<TSelection extends ColumnsSelection>(\n\t\t\t\tqb: TypedQueryBuilder<TSelection> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelection>),\n\t\t\t): WithSubqueryWithSelection<TSelection, TAlias> {\n\t\t\t\tif (typeof qb === 'function') {\n\t\t\t\t\tqb = qb(new QueryBuilder(self.dialect));\n\t\t\t\t}\n\n\t\t\t\treturn new Proxy(\n\t\t\t\t\tnew WithSubquery(qb.getSQL(), qb.getSelectedFields() as SelectedFields, alias, true),\n\t\t\t\t\tnew SelectionProxyHandler({ alias, sqlAliasedBehavior: 'alias', sqlBehavior: 'error' }),\n\t\t\t\t) as WithSubqueryWithSelection<TSelection, TAlias>;\n\t\t\t},\n\t\t};\n\t}\n\n\t$count(\n\t\tsource: PgTable | PgViewBase | SQL | SQLWrapper,\n\t\tfilters?: SQL<unknown>,\n\t) {\n\t\treturn new PgCountBuilder({ source, filters, session: this.session });\n\t}\n\n\t/**\n\t * Incorporates a previously defined CTE (using `$with`) into the main query.\n\t *\n\t * This method allows the main query to reference a temporary named result set.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#with-clause}\n\t *\n\t * @param queries The CTEs to incorporate into the main query.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Define a subquery 'sq' as a CTE using $with\n\t * const sq = db.$with('sq').as(db.select().from(users).where(eq(users.id, 42)));\n\t *\n\t * // Incorporate the CTE 'sq' into the main query and select from it\n\t * const result = await db.with(sq).select().from(sq);\n\t * ```\n\t */\n\twith(...queries: WithSubquery[]) {\n\t\tconst self = this;\n\n\t\t/**\n\t\t * Creates a select query.\n\t\t *\n\t\t * Calling this method with no arguments will select all columns from the table. Pass a selection object to specify the columns you want to select.\n\t\t *\n\t\t * Use `.from()` method to specify which table to select from.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/select}\n\t\t *\n\t\t * @param fields The selection object.\n\t\t *\n\t\t * @example\n\t\t *\n\t\t * ```ts\n\t\t * // Select all columns and all rows from the 'cars' table\n\t\t * const allCars: Car[] = await db.select().from(cars);\n\t\t *\n\t\t * // Select specific columns and all rows from the 'cars' table\n\t\t * const carsIdsAndBrands: { id: number; brand: string }[] = await db.select({\n\t\t *   id: cars.id,\n\t\t *   brand: cars.brand\n\t\t * })\n\t\t *   .from(cars);\n\t\t * ```\n\t\t *\n\t\t * Like in SQL, you can use arbitrary expressions as selection fields, not just table columns:\n\t\t *\n\t\t * ```ts\n\t\t * // Select specific columns along with expression and all rows from the 'cars' table\n\t\t * const carsIdsAndLowerNames: { id: number; lowerBrand: string }[] = await db.select({\n\t\t *   id: cars.id,\n\t\t *   lowerBrand: sql<string>`lower(${cars.brand})`,\n\t\t * })\n\t\t *   .from(cars);\n\t\t * ```\n\t\t */\n\t\tfunction select(): PgSelectBuilder<undefined>;\n\t\tfunction select<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection>;\n\t\tfunction select(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: self.session,\n\t\t\t\tdialect: self.dialect,\n\t\t\t\twithList: queries,\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Adds `distinct` expression to the select query.\n\t\t *\n\t\t * Calling this method will return only unique values. When multiple columns are selected, it returns rows with unique combinations of values in these columns.\n\t\t *\n\t\t * Use `.from()` method to specify which table to select from.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/select#distinct}\n\t\t *\n\t\t * @param fields The selection object.\n\t\t *\n\t\t * @example\n\t\t * ```ts\n\t\t * // Select all unique rows from the 'cars' table\n\t\t * await db.selectDistinct()\n\t\t *   .from(cars)\n\t\t *   .orderBy(cars.id, cars.brand, cars.color);\n\t\t *\n\t\t * // Select all unique brands from the 'cars' table\n\t\t * await db.selectDistinct({ brand: cars.brand })\n\t\t *   .from(cars)\n\t\t *   .orderBy(cars.brand);\n\t\t * ```\n\t\t */\n\t\tfunction selectDistinct(): PgSelectBuilder<undefined>;\n\t\tfunction selectDistinct<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection>;\n\t\tfunction selectDistinct(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: self.session,\n\t\t\t\tdialect: self.dialect,\n\t\t\t\twithList: queries,\n\t\t\t\tdistinct: true,\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Adds `distinct on` expression to the select query.\n\t\t *\n\t\t * Calling this method will specify how the unique rows are determined.\n\t\t *\n\t\t * Use `.from()` method to specify which table to select from.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/select#distinct}\n\t\t *\n\t\t * @param on The expression defining uniqueness.\n\t\t * @param fields The selection object.\n\t\t *\n\t\t * @example\n\t\t * ```ts\n\t\t * // Select the first row for each unique brand from the 'cars' table\n\t\t * await db.selectDistinctOn([cars.brand])\n\t\t *   .from(cars)\n\t\t *   .orderBy(cars.brand);\n\t\t *\n\t\t * // Selects the first occurrence of each unique car brand along with its color from the 'cars' table\n\t\t * await db.selectDistinctOn([cars.brand], { brand: cars.brand, color: cars.color })\n\t\t *   .from(cars)\n\t\t *   .orderBy(cars.brand, cars.color);\n\t\t * ```\n\t\t */\n\t\tfunction selectDistinctOn(on: (PgColumn | SQLWrapper)[]): PgSelectBuilder<undefined>;\n\t\tfunction selectDistinctOn<TSelection extends SelectedFields>(\n\t\t\ton: (PgColumn | SQLWrapper)[],\n\t\t\tfields: TSelection,\n\t\t): PgSelectBuilder<TSelection>;\n\t\tfunction selectDistinctOn(\n\t\t\ton: (PgColumn | SQLWrapper)[],\n\t\t\tfields?: SelectedFields,\n\t\t): PgSelectBuilder<SelectedFields | undefined> {\n\t\t\treturn new PgSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: self.session,\n\t\t\t\tdialect: self.dialect,\n\t\t\t\twithList: queries,\n\t\t\t\tdistinct: { on },\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Creates an update query.\n\t\t *\n\t\t * Calling this method without `.where()` clause will update all rows in a table. The `.where()` clause specifies which rows should be updated.\n\t\t *\n\t\t * Use `.set()` method to specify which values to update.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/update}\n\t\t *\n\t\t * @param table The table to update.\n\t\t *\n\t\t * @example\n\t\t *\n\t\t * ```ts\n\t\t * // Update all rows in the 'cars' table\n\t\t * await db.update(cars).set({ color: 'red' });\n\t\t *\n\t\t * // Update rows with filters and conditions\n\t\t * await db.update(cars).set({ color: 'red' }).where(eq(cars.brand, 'BMW'));\n\t\t *\n\t\t * // Update with returning clause\n\t\t * const updatedCar: Car[] = await db.update(cars)\n\t\t *   .set({ color: 'red' })\n\t\t *   .where(eq(cars.id, 1))\n\t\t *   .returning();\n\t\t * ```\n\t\t */\n\t\tfunction update<TTable extends PgTable>(table: TTable): PgUpdateBuilder<TTable, TQueryResult> {\n\t\t\treturn new PgUpdateBuilder(table, self.session, self.dialect, queries);\n\t\t}\n\n\t\t/**\n\t\t * Creates an insert query.\n\t\t *\n\t\t * Calling this method will create new rows in a table. Use `.values()` method to specify which values to insert.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/insert}\n\t\t *\n\t\t * @param table The table to insert into.\n\t\t *\n\t\t * @example\n\t\t *\n\t\t * ```ts\n\t\t * // Insert one row\n\t\t * await db.insert(cars).values({ brand: 'BMW' });\n\t\t *\n\t\t * // Insert multiple rows\n\t\t * await db.insert(cars).values([{ brand: 'BMW' }, { brand: 'Porsche' }]);\n\t\t *\n\t\t * // Insert with returning clause\n\t\t * const insertedCar: Car[] = await db.insert(cars)\n\t\t *   .values({ brand: 'BMW' })\n\t\t *   .returning();\n\t\t * ```\n\t\t */\n\t\tfunction insert<TTable extends PgTable>(table: TTable): PgInsertBuilder<TTable, TQueryResult> {\n\t\t\treturn new PgInsertBuilder(table, self.session, self.dialect, queries);\n\t\t}\n\n\t\t/**\n\t\t * Creates a delete query.\n\t\t *\n\t\t * Calling this method without `.where()` clause will delete all rows in a table. The `.where()` clause specifies which rows should be deleted.\n\t\t *\n\t\t * See docs: {@link https://orm.drizzle.team/docs/delete}\n\t\t *\n\t\t * @param table The table to delete from.\n\t\t *\n\t\t * @example\n\t\t *\n\t\t * ```ts\n\t\t * // Delete all rows in the 'cars' table\n\t\t * await db.delete(cars);\n\t\t *\n\t\t * // Delete rows with filters and conditions\n\t\t * await db.delete(cars).where(eq(cars.color, 'green'));\n\t\t *\n\t\t * // Delete with returning clause\n\t\t * const deletedCar: Car[] = await db.delete(cars)\n\t\t *   .where(eq(cars.id, 1))\n\t\t *   .returning();\n\t\t * ```\n\t\t */\n\t\tfunction delete_<TTable extends PgTable>(table: TTable): PgDeleteBase<TTable, TQueryResult> {\n\t\t\treturn new PgDeleteBase(table, self.session, self.dialect, queries);\n\t\t}\n\n\t\treturn { select, selectDistinct, selectDistinctOn, update, insert, delete: delete_ };\n\t}\n\n\t/**\n\t * Creates a select query.\n\t *\n\t * Calling this method with no arguments will select all columns from the table. Pass a selection object to specify the columns you want to select.\n\t *\n\t * Use `.from()` method to specify which table to select from.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select}\n\t *\n\t * @param fields The selection object.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Select all columns and all rows from the 'cars' table\n\t * const allCars: Car[] = await db.select().from(cars);\n\t *\n\t * // Select specific columns and all rows from the 'cars' table\n\t * const carsIdsAndBrands: { id: number; brand: string }[] = await db.select({\n\t *   id: cars.id,\n\t *   brand: cars.brand\n\t * })\n\t *   .from(cars);\n\t * ```\n\t *\n\t * Like in SQL, you can use arbitrary expressions as selection fields, not just table columns:\n\t *\n\t * ```ts\n\t * // Select specific columns along with expression and all rows from the 'cars' table\n\t * const carsIdsAndLowerNames: { id: number; lowerBrand: string }[] = await db.select({\n\t *   id: cars.id,\n\t *   lowerBrand: sql<string>`lower(${cars.brand})`,\n\t * })\n\t *   .from(cars);\n\t * ```\n\t */\n\tselect(): PgSelectBuilder<undefined>;\n\tselect<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection>;\n\tselect(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: this.session,\n\t\t\tdialect: this.dialect,\n\t\t});\n\t}\n\n\t/**\n\t * Adds `distinct` expression to the select query.\n\t *\n\t * Calling this method will return only unique values. When multiple columns are selected, it returns rows with unique combinations of values in these columns.\n\t *\n\t * Use `.from()` method to specify which table to select from.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#distinct}\n\t *\n\t * @param fields The selection object.\n\t *\n\t * @example\n\t * ```ts\n\t * // Select all unique rows from the 'cars' table\n\t * await db.selectDistinct()\n\t *   .from(cars)\n\t *   .orderBy(cars.id, cars.brand, cars.color);\n\t *\n\t * // Select all unique brands from the 'cars' table\n\t * await db.selectDistinct({ brand: cars.brand })\n\t *   .from(cars)\n\t *   .orderBy(cars.brand);\n\t * ```\n\t */\n\tselectDistinct(): PgSelectBuilder<undefined>;\n\tselectDistinct<TSelection extends SelectedFields>(fields: TSelection): PgSelectBuilder<TSelection>;\n\tselectDistinct(fields?: SelectedFields): PgSelectBuilder<SelectedFields | undefined> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: this.session,\n\t\t\tdialect: this.dialect,\n\t\t\tdistinct: true,\n\t\t});\n\t}\n\n\t/**\n\t * Adds `distinct on` expression to the select query.\n\t *\n\t * Calling this method will specify how the unique rows are determined.\n\t *\n\t * Use `.from()` method to specify which table to select from.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/select#distinct}\n\t *\n\t * @param on The expression defining uniqueness.\n\t * @param fields The selection object.\n\t *\n\t * @example\n\t * ```ts\n\t * // Select the first row for each unique brand from the 'cars' table\n\t * await db.selectDistinctOn([cars.brand])\n\t *   .from(cars)\n\t *   .orderBy(cars.brand);\n\t *\n\t * // Selects the first occurrence of each unique car brand along with its color from the 'cars' table\n\t * await db.selectDistinctOn([cars.brand], { brand: cars.brand, color: cars.color })\n\t *   .from(cars)\n\t *   .orderBy(cars.brand, cars.color);\n\t * ```\n\t */\n\tselectDistinctOn(on: (PgColumn | SQLWrapper)[]): PgSelectBuilder<undefined>;\n\tselectDistinctOn<TSelection extends SelectedFields>(\n\t\ton: (PgColumn | SQLWrapper)[],\n\t\tfields: TSelection,\n\t): PgSelectBuilder<TSelection>;\n\tselectDistinctOn(\n\t\ton: (PgColumn | SQLWrapper)[],\n\t\tfields?: SelectedFields,\n\t): PgSelectBuilder<SelectedFields | undefined> {\n\t\treturn new PgSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: this.session,\n\t\t\tdialect: this.dialect,\n\t\t\tdistinct: { on },\n\t\t});\n\t}\n\n\t/**\n\t * Creates an update query.\n\t *\n\t * Calling this method without `.where()` clause will update all rows in a table. The `.where()` clause specifies which rows should be updated.\n\t *\n\t * Use `.set()` method to specify which values to update.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/update}\n\t *\n\t * @param table The table to update.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Update all rows in the 'cars' table\n\t * await db.update(cars).set({ color: 'red' });\n\t *\n\t * // Update rows with filters and conditions\n\t * await db.update(cars).set({ color: 'red' }).where(eq(cars.brand, 'BMW'));\n\t *\n\t * // Update with returning clause\n\t * const updatedCar: Car[] = await db.update(cars)\n\t *   .set({ color: 'red' })\n\t *   .where(eq(cars.id, 1))\n\t *   .returning();\n\t * ```\n\t */\n\tupdate<TTable extends PgTable>(table: TTable): PgUpdateBuilder<TTable, TQueryResult> {\n\t\treturn new PgUpdateBuilder(table, this.session, this.dialect);\n\t}\n\n\t/**\n\t * Creates an insert query.\n\t *\n\t * Calling this method will create new rows in a table. Use `.values()` method to specify which values to insert.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/insert}\n\t *\n\t * @param table The table to insert into.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Insert one row\n\t * await db.insert(cars).values({ brand: 'BMW' });\n\t *\n\t * // Insert multiple rows\n\t * await db.insert(cars).values([{ brand: 'BMW' }, { brand: 'Porsche' }]);\n\t *\n\t * // Insert with returning clause\n\t * const insertedCar: Car[] = await db.insert(cars)\n\t *   .values({ brand: 'BMW' })\n\t *   .returning();\n\t * ```\n\t */\n\tinsert<TTable extends PgTable>(table: TTable): PgInsertBuilder<TTable, TQueryResult> {\n\t\treturn new PgInsertBuilder(table, this.session, this.dialect);\n\t}\n\n\t/**\n\t * Creates a delete query.\n\t *\n\t * Calling this method without `.where()` clause will delete all rows in a table. The `.where()` clause specifies which rows should be deleted.\n\t *\n\t * See docs: {@link https://orm.drizzle.team/docs/delete}\n\t *\n\t * @param table The table to delete from.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * // Delete all rows in the 'cars' table\n\t * await db.delete(cars);\n\t *\n\t * // Delete rows with filters and conditions\n\t * await db.delete(cars).where(eq(cars.color, 'green'));\n\t *\n\t * // Delete with returning clause\n\t * const deletedCar: Car[] = await db.delete(cars)\n\t *   .where(eq(cars.id, 1))\n\t *   .returning();\n\t * ```\n\t */\n\tdelete<TTable extends PgTable>(table: TTable): PgDeleteBase<TTable, TQueryResult> {\n\t\treturn new PgDeleteBase(table, this.session, this.dialect);\n\t}\n\n\trefreshMaterializedView<TView extends PgMaterializedView>(view: TView): PgRefreshMaterializedView<TQueryResult> {\n\t\treturn new PgRefreshMaterializedView(view, this.session, this.dialect);\n\t}\n\n\tprotected authToken?: string;\n\n\texecute<TRow extends Record<string, unknown> = Record<string, unknown>>(\n\t\tquery: SQLWrapper | string,\n\t): PgRaw<PgQueryResultKind<TQueryResult, TRow>> {\n\t\tconst sequel = typeof query === 'string' ? sql.raw(query) : query.getSQL();\n\t\tconst builtQuery = this.dialect.sqlToQuery(sequel);\n\t\tconst prepared = this.session.prepareQuery<\n\t\t\tPreparedQueryConfig & { execute: PgQueryResultKind<TQueryResult, TRow> }\n\t\t>(\n\t\t\tbuiltQuery,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\tfalse,\n\t\t);\n\t\treturn new PgRaw(\n\t\t\t() => prepared.execute(undefined, this.authToken),\n\t\t\tsequel,\n\t\t\tbuiltQuery,\n\t\t\t(result) => prepared.mapResult(result, true),\n\t\t);\n\t}\n\n\ttransaction<T>(\n\t\ttransaction: (tx: PgTransaction<TQueryResult, TFullSchema, TSchema>) => Promise<T>,\n\t\tconfig?: PgTransactionConfig,\n\t): Promise<T> {\n\t\treturn this.session.transaction(transaction, config);\n\t}\n}\n\nexport type PgWithReplicas<Q> = Q & { $primary: Q };\n\nexport const withReplicas = <\n\tHKT extends PgQueryResultHKT,\n\tTFullSchema extends Record<string, unknown>,\n\tTSchema extends TablesRelationalConfig,\n\tQ extends PgDatabase<\n\t\tHKT,\n\t\tTFullSchema,\n\t\tTSchema extends Record<string, unknown> ? ExtractTablesWithRelations<TFullSchema> : TSchema\n\t>,\n>(\n\tprimary: Q,\n\treplicas: [Q, ...Q[]],\n\tgetReplica: (replicas: Q[]) => Q = () => replicas[Math.floor(Math.random() * replicas.length)]!,\n): PgWithReplicas<Q> => {\n\tconst select: Q['select'] = (...args: []) => getReplica(replicas).select(...args);\n\tconst selectDistinct: Q['selectDistinct'] = (...args: []) => getReplica(replicas).selectDistinct(...args);\n\tconst selectDistinctOn: Q['selectDistinctOn'] = (...args: [any]) => getReplica(replicas).selectDistinctOn(...args);\n\tconst $with: Q['with'] = (...args: any) => getReplica(replicas).with(...args);\n\n\tconst update: Q['update'] = (...args: [any]) => primary.update(...args);\n\tconst insert: Q['insert'] = (...args: [any]) => primary.insert(...args);\n\tconst $delete: Q['delete'] = (...args: [any]) => primary.delete(...args);\n\tconst execute: Q['execute'] = (...args: [any]) => primary.execute(...args);\n\tconst transaction: Q['transaction'] = (...args: [any]) => primary.transaction(...args);\n\tconst refreshMaterializedView: Q['refreshMaterializedView'] = (...args: [any]) =>\n\t\tprimary.refreshMaterializedView(...args);\n\n\treturn {\n\t\t...primary,\n\t\tupdate,\n\t\tinsert,\n\t\tdelete: $delete,\n\t\texecute,\n\t\ttransaction,\n\t\trefreshMaterializedView,\n\t\t$primary: primary,\n\t\tselect,\n\t\tselectDistinct,\n\t\tselectDistinctOn,\n\t\twith: $with,\n\t\tget query() {\n\t\t\treturn getReplica(replicas).query;\n\t\t},\n\t};\n};\n","import { SQL } from '~/sql/sql.ts';\n\nimport { entityKind, is } from '~/entity.ts';\nimport type { ExtraConfigColumn, PgColumn } from './columns/index.ts';\nimport { IndexedColumn } from './columns/index.ts';\nimport type { PgTable } from './table.ts';\n\ninterface IndexConfig {\n\tname?: string;\n\n\tcolumns: Partial<IndexedColumn | SQL>[];\n\n\t/**\n\t * If true, the index will be created as `create unique index` instead of `create index`.\n\t */\n\tunique: boolean;\n\n\t/**\n\t * If true, the index will be created as `create index concurrently` instead of `create index`.\n\t */\n\tconcurrently?: boolean;\n\n\t/**\n\t * If true, the index will be created as `create index ... on only <table>` instead of `create index ... on <table>`.\n\t */\n\tonly: boolean;\n\n\t/**\n\t * Condition for partial index.\n\t */\n\twhere?: SQL;\n\n\t/**\n\t * The optional WITH clause specifies storage parameters for the index\n\t */\n\twith?: Record<string, any>;\n\n\t/**\n\t * The optional WITH clause method for the index\n\t */\n\tmethod?: 'btree' | string;\n}\n\nexport type IndexColumn = PgColumn;\n\nexport type PgIndexMethod = 'btree' | 'hash' | 'gist' | 'spgist' | 'gin' | 'brin' | 'hnsw' | 'ivfflat' | (string & {});\n\nexport type PgIndexOpClass =\n\t| 'abstime_ops'\n\t| 'access_method'\n\t| 'anyarray_eq'\n\t| 'anyarray_ge'\n\t| 'anyarray_gt'\n\t| 'anyarray_le'\n\t| 'anyarray_lt'\n\t| 'anyarray_ne'\n\t| 'bigint_ops'\n\t| 'bit_ops'\n\t| 'bool_ops'\n\t| 'box_ops'\n\t| 'bpchar_ops'\n\t| 'char_ops'\n\t| 'cidr_ops'\n\t| 'cstring_ops'\n\t| 'date_ops'\n\t| 'float_ops'\n\t| 'int2_ops'\n\t| 'int4_ops'\n\t| 'int8_ops'\n\t| 'interval_ops'\n\t| 'jsonb_ops'\n\t| 'macaddr_ops'\n\t| 'name_ops'\n\t| 'numeric_ops'\n\t| 'oid_ops'\n\t| 'oidint4_ops'\n\t| 'oidint8_ops'\n\t| 'oidname_ops'\n\t| 'oidvector_ops'\n\t| 'point_ops'\n\t| 'polygon_ops'\n\t| 'range_ops'\n\t| 'record_eq'\n\t| 'record_ge'\n\t| 'record_gt'\n\t| 'record_le'\n\t| 'record_lt'\n\t| 'record_ne'\n\t| 'text_ops'\n\t| 'time_ops'\n\t| 'timestamp_ops'\n\t| 'timestamptz_ops'\n\t| 'timetz_ops'\n\t| 'uuid_ops'\n\t| 'varbit_ops'\n\t| 'varchar_ops'\n\t// pg_vector types\n\t| 'xml_ops'\n\t| 'vector_l2_ops'\n\t| 'vector_ip_ops'\n\t| 'vector_cosine_ops'\n\t| 'vector_l1_ops'\n\t| 'bit_hamming_ops'\n\t| 'bit_jaccard_ops'\n\t| 'halfvec_l2_ops'\n\t| 'sparsevec_l2_op'\n\t| (string & {});\n\nexport class IndexBuilderOn {\n\tstatic readonly [entityKind]: string = 'PgIndexBuilderOn';\n\n\tconstructor(private unique: boolean, private name?: string) {}\n\n\ton(...columns: [Partial<ExtraConfigColumn> | SQL, ...Partial<ExtraConfigColumn | SQL>[]]): IndexBuilder {\n\t\treturn new IndexBuilder(\n\t\t\tcolumns.map((it) => {\n\t\t\t\tif (is(it, SQL)) {\n\t\t\t\t\treturn it;\n\t\t\t\t}\n\t\t\t\tit = it as ExtraConfigColumn;\n\t\t\t\tconst clonedIndexedColumn = new IndexedColumn(it.name, !!it.keyAsName, it.columnType!, it.indexConfig!);\n\t\t\t\tit.indexConfig = JSON.parse(JSON.stringify(it.defaultConfig));\n\t\t\t\treturn clonedIndexedColumn;\n\t\t\t}),\n\t\t\tthis.unique,\n\t\t\tfalse,\n\t\t\tthis.name,\n\t\t);\n\t}\n\n\tonOnly(...columns: [Partial<ExtraConfigColumn | SQL>, ...Partial<ExtraConfigColumn | SQL>[]]): IndexBuilder {\n\t\treturn new IndexBuilder(\n\t\t\tcolumns.map((it) => {\n\t\t\t\tif (is(it, SQL)) {\n\t\t\t\t\treturn it;\n\t\t\t\t}\n\t\t\t\tit = it as ExtraConfigColumn;\n\t\t\t\tconst clonedIndexedColumn = new IndexedColumn(it.name, !!it.keyAsName, it.columnType!, it.indexConfig!);\n\t\t\t\tit.indexConfig = it.defaultConfig;\n\t\t\t\treturn clonedIndexedColumn;\n\t\t\t}),\n\t\t\tthis.unique,\n\t\t\ttrue,\n\t\t\tthis.name,\n\t\t);\n\t}\n\n\t/**\n\t * Specify what index method to use. Choices are `btree`, `hash`, `gist`, `spgist`, `gin`, `brin`, or user-installed access methods like `bloom`. The default method is `btree.\n\t *\n\t * If you have the `pg_vector` extension installed in your database, you can use the `hnsw` and `ivfflat` options, which are predefined types.\n\t *\n\t * **You can always specify any string you want in the method, in case Drizzle doesn't have it natively in its types**\n\t *\n\t * @param method The name of the index method to be used\n\t * @param columns\n\t * @returns\n\t */\n\tusing(\n\t\tmethod: PgIndexMethod,\n\t\t...columns: [Partial<ExtraConfigColumn | SQL>, ...Partial<ExtraConfigColumn | SQL>[]]\n\t): IndexBuilder {\n\t\treturn new IndexBuilder(\n\t\t\tcolumns.map((it) => {\n\t\t\t\tif (is(it, SQL)) {\n\t\t\t\t\treturn it;\n\t\t\t\t}\n\t\t\t\tit = it as ExtraConfigColumn;\n\t\t\t\tconst clonedIndexedColumn = new IndexedColumn(it.name, !!it.keyAsName, it.columnType!, it.indexConfig!);\n\t\t\t\tit.indexConfig = JSON.parse(JSON.stringify(it.defaultConfig));\n\t\t\t\treturn clonedIndexedColumn;\n\t\t\t}),\n\t\t\tthis.unique,\n\t\t\ttrue,\n\t\t\tthis.name,\n\t\t\tmethod,\n\t\t);\n\t}\n}\n\nexport interface AnyIndexBuilder {\n\tbuild(table: PgTable): Index;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface IndexBuilder extends AnyIndexBuilder {}\n\nexport class IndexBuilder implements AnyIndexBuilder {\n\tstatic readonly [entityKind]: string = 'PgIndexBuilder';\n\n\t/** @internal */\n\tconfig: IndexConfig;\n\n\tconstructor(\n\t\tcolumns: Partial<IndexedColumn | SQL>[],\n\t\tunique: boolean,\n\t\tonly: boolean,\n\t\tname?: string,\n\t\tmethod: string = 'btree',\n\t) {\n\t\tthis.config = {\n\t\t\tname,\n\t\t\tcolumns,\n\t\t\tunique,\n\t\t\tonly,\n\t\t\tmethod,\n\t\t};\n\t}\n\n\tconcurrently(): this {\n\t\tthis.config.concurrently = true;\n\t\treturn this;\n\t}\n\n\twith(obj: Record<string, any>): this {\n\t\tthis.config.with = obj;\n\t\treturn this;\n\t}\n\n\twhere(condition: SQL): this {\n\t\tthis.config.where = condition;\n\t\treturn this;\n\t}\n\n\t/** @internal */\n\tbuild(table: PgTable): Index {\n\t\treturn new Index(this.config, table);\n\t}\n}\n\nexport class Index {\n\tstatic readonly [entityKind]: string = 'PgIndex';\n\n\treadonly config: IndexConfig & { table: PgTable };\n\n\tconstructor(config: IndexConfig, table: PgTable) {\n\t\tthis.config = { ...config, table };\n\t}\n}\n\nexport type GetColumnsTableName<TColumns> = TColumns extends PgColumn ? TColumns['_']['name']\n\t: TColumns extends PgColumn[] ? TColumns[number]['_']['name']\n\t: never;\n\nexport function index(name?: string): IndexBuilderOn {\n\treturn new IndexBuilderOn(false, name);\n}\n\nexport function uniqueIndex(name?: string): IndexBuilderOn {\n\treturn new IndexBuilderOn(true, name);\n}\n","import { entityKind } from '~/entity.ts';\nimport { TransactionRollbackError } from '~/errors.ts';\nimport type { TablesRelationalConfig } from '~/relations.ts';\nimport type { PreparedQuery } from '~/session.ts';\nimport { type Query, type SQL, sql } from '~/sql/index.ts';\nimport { tracer } from '~/tracing.ts';\nimport { PgDatabase } from './db.ts';\nimport type { PgDialect } from './dialect.ts';\nimport type { SelectedFieldsOrdered } from './query-builders/select.types.ts';\n\nexport interface PreparedQueryConfig {\n\texecute: unknown;\n\tall: unknown;\n\tvalues: unknown;\n}\n\nexport abstract class PgPreparedQuery<T extends PreparedQueryConfig> implements PreparedQuery {\n\tconstructor(protected query: Query) {}\n\n\tprotected authToken?: string;\n\n\tgetQuery(): Query {\n\t\treturn this.query;\n\t}\n\n\tmapResult(response: unknown, _isFromBatch?: boolean): unknown {\n\t\treturn response;\n\t}\n\n\t/** @internal */\n\tsetToken(token?: string) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\tstatic readonly [entityKind]: string = 'PgPreparedQuery';\n\n\t/** @internal */\n\tjoinsNotNullableMap?: Record<string, boolean>;\n\n\tabstract execute(placeholderValues?: Record<string, unknown>): Promise<T['execute']>;\n\t/** @internal */\n\tabstract execute(placeholderValues?: Record<string, unknown>, token?: string): Promise<T['execute']>;\n\t/** @internal */\n\tabstract execute(placeholderValues?: Record<string, unknown>, token?: string): Promise<T['execute']>;\n\n\t/** @internal */\n\tabstract all(placeholderValues?: Record<string, unknown>): Promise<T['all']>;\n\n\t/** @internal */\n\tabstract isResponseInArrayMode(): boolean;\n}\n\nexport interface PgTransactionConfig {\n\tisolationLevel?: 'read uncommitted' | 'read committed' | 'repeatable read' | 'serializable';\n\taccessMode?: 'read only' | 'read write';\n\tdeferrable?: boolean;\n}\n\nexport abstract class PgSession<\n\tTQueryResult extends PgQueryResultHKT = PgQueryResultHKT,\n\tTFullSchema extends Record<string, unknown> = Record<string, never>,\n\tTSchema extends TablesRelationalConfig = Record<string, never>,\n> {\n\tstatic readonly [entityKind]: string = 'PgSession';\n\n\tconstructor(protected dialect: PgDialect) {}\n\n\tabstract prepareQuery<T extends PreparedQueryConfig = PreparedQueryConfig>(\n\t\tquery: Query,\n\t\tfields: SelectedFieldsOrdered | undefined,\n\t\tname: string | undefined,\n\t\tisResponseInArrayMode: boolean,\n\t\tcustomResultMapper?: (rows: unknown[][], mapColumnValue?: (value: unknown) => unknown) => T['execute'],\n\t): PgPreparedQuery<T>;\n\n\texecute<T>(query: SQL): Promise<T>;\n\t/** @internal */\n\texecute<T>(query: SQL, token?: string): Promise<T>;\n\t/** @internal */\n\texecute<T>(query: SQL, token?: string): Promise<T> {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\tconst prepared = tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\t\treturn this.prepareQuery<PreparedQueryConfig & { execute: T }>(\n\t\t\t\t\tthis.dialect.sqlToQuery(query),\n\t\t\t\t\tundefined,\n\t\t\t\t\tundefined,\n\t\t\t\t\tfalse,\n\t\t\t\t);\n\t\t\t});\n\n\t\t\treturn prepared.setToken(token).execute(undefined, token);\n\t\t});\n\t}\n\n\tall<T = unknown>(query: SQL): Promise<T[]> {\n\t\treturn this.prepareQuery<PreparedQueryConfig & { all: T[] }>(\n\t\t\tthis.dialect.sqlToQuery(query),\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\tfalse,\n\t\t).all();\n\t}\n\n\tasync count(sql: SQL): Promise<number>;\n\t/** @internal */\n\tasync count(sql: SQL, token?: string): Promise<number>;\n\t/** @internal */\n\tasync count(sql: SQL, token?: string): Promise<number> {\n\t\tconst res = await this.execute<[{ count: string }]>(sql, token);\n\n\t\treturn Number(\n\t\t\tres[0]['count'],\n\t\t);\n\t}\n\n\tabstract transaction<T>(\n\t\ttransaction: (tx: PgTransaction<TQueryResult, TFullSchema, TSchema>) => Promise<T>,\n\t\tconfig?: PgTransactionConfig,\n\t): Promise<T>;\n}\n\nexport abstract class PgTransaction<\n\tTQueryResult extends PgQueryResultHKT,\n\tTFullSchema extends Record<string, unknown> = Record<string, never>,\n\tTSchema extends TablesRelationalConfig = Record<string, never>,\n> extends PgDatabase<TQueryResult, TFullSchema, TSchema> {\n\tstatic override readonly [entityKind]: string = 'PgTransaction';\n\n\tconstructor(\n\t\tdialect: PgDialect,\n\t\tsession: PgSession<any, any, any>,\n\t\tprotected schema: {\n\t\t\tfullSchema: Record<string, unknown>;\n\t\t\tschema: TSchema;\n\t\t\ttableNamesMap: Record<string, string>;\n\t\t} | undefined,\n\t\tprotected readonly nestedIndex = 0,\n\t) {\n\t\tsuper(dialect, session, schema);\n\t}\n\n\trollback(): never {\n\t\tthrow new TransactionRollbackError();\n\t}\n\n\t/** @internal */\n\tgetTransactionConfigSQL(config: PgTransactionConfig): SQL {\n\t\tconst chunks: string[] = [];\n\t\tif (config.isolationLevel) {\n\t\t\tchunks.push(`isolation level ${config.isolationLevel}`);\n\t\t}\n\t\tif (config.accessMode) {\n\t\t\tchunks.push(config.accessMode);\n\t\t}\n\t\tif (typeof config.deferrable === 'boolean') {\n\t\t\tchunks.push(config.deferrable ? 'deferrable' : 'not deferrable');\n\t\t}\n\t\treturn sql.raw(chunks.join(' '));\n\t}\n\n\tsetTransaction(config: PgTransactionConfig): Promise<void> {\n\t\treturn this.session.execute(sql`set transaction ${this.getTransactionConfigSQL(config)}`);\n\t}\n\n\tabstract override transaction<T>(\n\t\ttransaction: (tx: PgTransaction<TQueryResult, TFullSchema, TSchema>) => Promise<T>,\n\t): Promise<T>;\n}\n\nexport interface PgQueryResultHKT {\n\treadonly $brand: 'PgQueryResultHKT';\n\treadonly row: unknown;\n\treadonly type: unknown;\n}\n\nexport type PgQueryResultKind<TKind extends PgQueryResultHKT, TRow> = (TKind & {\n\treadonly row: TRow;\n})['type'];\n","import type { FullQueryResults, NeonQueryFunction, NeonQueryPromise } from '@neondatabase/serverless';\nimport type { BatchItem } from '~/batch.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { Logger } from '~/logger.ts';\nimport { NoopLogger } from '~/logger.ts';\nimport type { PgDialect } from '~/pg-core/dialect.ts';\nimport { PgTransaction } from '~/pg-core/index.ts';\nimport type { SelectedFieldsOrdered } from '~/pg-core/query-builders/select.types.ts';\nimport type { PgQueryResultHKT, PgTransactionConfig, PreparedQueryConfig } from '~/pg-core/session.ts';\nimport { PgPreparedQuery as PgPreparedQuery, PgSession } from '~/pg-core/session.ts';\nimport type { RelationalSchemaConfig, TablesRelationalConfig } from '~/relations.ts';\nimport type { PreparedQuery } from '~/session.ts';\nimport { fillPlaceholders, type Query, type SQL } from '~/sql/sql.ts';\nimport { mapResultRow } from '~/utils.ts';\n\nexport type NeonHttpClient = NeonQueryFunction<any, any>;\n\nconst rawQueryConfig = {\n\tarrayMode: false,\n\tfullResults: true,\n} as const;\nconst queryConfig = {\n\tarrayMode: true,\n\tfullResults: true,\n} as const;\n\nexport class NeonHttpPreparedQuery<T extends PreparedQueryConfig> extends PgPreparedQuery<T> {\n\tstatic override readonly [entityKind]: string = 'NeonHttpPreparedQuery';\n\n\tconstructor(\n\t\tprivate client: NeonHttpClient,\n\t\tquery: Query,\n\t\tprivate logger: Logger,\n\t\tprivate fields: SelectedFieldsOrdered | undefined,\n\t\tprivate _isResponseInArrayMode: boolean,\n\t\tprivate customResultMapper?: (rows: unknown[][]) => T['execute'],\n\t) {\n\t\tsuper(query);\n\t}\n\n\tasync execute(placeholderValues: Record<string, unknown> | undefined): Promise<T['execute']>;\n\t/** @internal */\n\tasync execute(placeholderValues: Record<string, unknown> | undefined, token?: string): Promise<T['execute']>;\n\t/** @internal */\n\tasync execute(\n\t\tplaceholderValues: Record<string, unknown> | undefined = {},\n\t\ttoken: string | undefined = this.authToken,\n\t): Promise<T['execute']> {\n\t\tconst params = fillPlaceholders(this.query.params, placeholderValues);\n\n\t\tthis.logger.logQuery(this.query.sql, params);\n\n\t\tconst { fields, client, query, customResultMapper } = this;\n\n\t\tif (!fields && !customResultMapper) {\n\t\t\treturn client(\n\t\t\t\tquery.sql,\n\t\t\t\tparams,\n\t\t\t\ttoken === undefined\n\t\t\t\t\t? rawQueryConfig\n\t\t\t\t\t: {\n\t\t\t\t\t\t...rawQueryConfig,\n\t\t\t\t\t\tauthToken: token,\n\t\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tconst result = await client(\n\t\t\tquery.sql,\n\t\t\tparams,\n\t\t\ttoken === undefined\n\t\t\t\t? queryConfig\n\t\t\t\t: {\n\t\t\t\t\t...queryConfig,\n\t\t\t\t\tauthToken: token,\n\t\t\t\t},\n\t\t);\n\n\t\treturn this.mapResult(result);\n\t}\n\n\toverride mapResult(result: unknown): unknown {\n\t\tif (!this.fields && !this.customResultMapper) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst rows = (result as FullQueryResults<true>).rows;\n\n\t\tif (this.customResultMapper) {\n\t\t\treturn this.customResultMapper(rows);\n\t\t}\n\n\t\treturn rows.map((row) => mapResultRow(this.fields!, row, this.joinsNotNullableMap));\n\t}\n\n\tall(placeholderValues: Record<string, unknown> | undefined = {}): Promise<T['all']> {\n\t\tconst params = fillPlaceholders(this.query.params, placeholderValues);\n\t\tthis.logger.logQuery(this.query.sql, params);\n\t\treturn this.client(\n\t\t\tthis.query.sql,\n\t\t\tparams,\n\t\t\tthis.authToken === undefined ? rawQueryConfig : {\n\t\t\t\t...rawQueryConfig,\n\t\t\t\tauthToken: this.authToken,\n\t\t\t},\n\t\t).then((result) => result.rows);\n\t}\n\n\tvalues(placeholderValues: Record<string, unknown> | undefined): Promise<T['values']>;\n\t/** @internal */\n\tvalues(placeholderValues: Record<string, unknown> | undefined, token?: string): Promise<T['values']>;\n\t/** @internal */\n\tvalues(placeholderValues: Record<string, unknown> | undefined = {}, token?: string): Promise<T['values']> {\n\t\tconst params = fillPlaceholders(this.query.params, placeholderValues);\n\t\tthis.logger.logQuery(this.query.sql, params);\n\t\treturn this.client(this.query.sql, params, { arrayMode: true, fullResults: true, authToken: token }).then((\n\t\t\tresult,\n\t\t) => result.rows);\n\t}\n\n\t/** @internal */\n\tisResponseInArrayMode() {\n\t\treturn this._isResponseInArrayMode;\n\t}\n}\n\nexport interface NeonHttpSessionOptions {\n\tlogger?: Logger;\n}\n\nexport class NeonHttpSession<\n\tTFullSchema extends Record<string, unknown>,\n\tTSchema extends TablesRelationalConfig,\n> extends PgSession<NeonHttpQueryResultHKT, TFullSchema, TSchema> {\n\tstatic override readonly [entityKind]: string = 'NeonHttpSession';\n\n\tprivate logger: Logger;\n\n\tconstructor(\n\t\tprivate client: NeonHttpClient,\n\t\tdialect: PgDialect,\n\t\tprivate schema: RelationalSchemaConfig<TSchema> | undefined,\n\t\tprivate options: NeonHttpSessionOptions = {},\n\t) {\n\t\tsuper(dialect);\n\t\tthis.logger = options.logger ?? new NoopLogger();\n\t}\n\n\tprepareQuery<T extends PreparedQueryConfig = PreparedQueryConfig>(\n\t\tquery: Query,\n\t\tfields: SelectedFieldsOrdered | undefined,\n\t\tname: string | undefined,\n\t\tisResponseInArrayMode: boolean,\n\t\tcustomResultMapper?: (rows: unknown[][]) => T['execute'],\n\t): PgPreparedQuery<T> {\n\t\treturn new NeonHttpPreparedQuery(\n\t\t\tthis.client,\n\t\t\tquery,\n\t\t\tthis.logger,\n\t\t\tfields,\n\t\t\tisResponseInArrayMode,\n\t\t\tcustomResultMapper,\n\t\t);\n\t}\n\n\tasync batch<U extends BatchItem<'pg'>, T extends Readonly<[U, ...U[]]>>(\n\t\tqueries: T,\n\t) {\n\t\tconst preparedQueries: PreparedQuery[] = [];\n\t\tconst builtQueries: NeonQueryPromise<any, true>[] = [];\n\n\t\tfor (const query of queries) {\n\t\t\tconst preparedQuery = query._prepare();\n\t\t\tconst builtQuery = preparedQuery.getQuery();\n\t\t\tpreparedQueries.push(preparedQuery);\n\t\t\tbuiltQueries.push(\n\t\t\t\tthis.client(builtQuery.sql, builtQuery.params, {\n\t\t\t\t\tfullResults: true,\n\t\t\t\t\tarrayMode: preparedQuery.isResponseInArrayMode(),\n\t\t\t\t}),\n\t\t\t);\n\t\t}\n\n\t\tconst batchResults = await this.client.transaction(builtQueries, queryConfig);\n\n\t\treturn batchResults.map((result, i) => preparedQueries[i]!.mapResult(result, true)) as any;\n\t}\n\n\t// change return type to QueryRows<true>\n\tasync query(query: string, params: unknown[]): Promise<FullQueryResults<true>> {\n\t\tthis.logger.logQuery(query, params);\n\t\tconst result = await this.client(query, params, { arrayMode: true, fullResults: true });\n\t\treturn result;\n\t}\n\n\t// change return type to QueryRows<false>\n\tasync queryObjects(\n\t\tquery: string,\n\t\tparams: unknown[],\n\t): Promise<FullQueryResults<false>> {\n\t\treturn this.client(query, params, { arrayMode: false, fullResults: true });\n\t}\n\n\toverride async count(sql: SQL): Promise<number>;\n\t/** @internal */\n\toverride async count(sql: SQL, token?: string): Promise<number>;\n\t/** @internal */\n\toverride async count(sql: SQL, token?: string): Promise<number> {\n\t\tconst res = await this.execute<{ rows: [{ count: string }] }>(sql, token);\n\n\t\treturn Number(\n\t\t\tres['rows'][0]['count'],\n\t\t);\n\t}\n\n\toverride async transaction<T>(\n\t\t_transaction: (tx: NeonTransaction<TFullSchema, TSchema>) => Promise<T>,\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t_config: PgTransactionConfig = {},\n\t): Promise<T> {\n\t\tthrow new Error('No transactions support in neon-http driver');\n\t}\n}\n\nexport class NeonTransaction<\n\tTFullSchema extends Record<string, unknown>,\n\tTSchema extends TablesRelationalConfig,\n> extends PgTransaction<NeonHttpQueryResultHKT, TFullSchema, TSchema> {\n\tstatic override readonly [entityKind]: string = 'NeonHttpTransaction';\n\n\toverride async transaction<T>(_transaction: (tx: NeonTransaction<TFullSchema, TSchema>) => Promise<T>): Promise<T> {\n\t\tthrow new Error('No transactions support in neon-http driver');\n\t\t// const savepointName = `sp${this.nestedIndex + 1}`;\n\t\t// const tx = new NeonTransaction(this.dialect, this.session, this.schema, this.nestedIndex + 1);\n\t\t// await tx.execute(sql.raw(`savepoint ${savepointName}`));\n\t\t// try {\n\t\t// \tconst result = await transaction(tx);\n\t\t// \tawait tx.execute(sql.raw(`release savepoint ${savepointName}`));\n\t\t// \treturn result;\n\t\t// } catch (e) {\n\t\t// \tawait tx.execute(sql.raw(`rollback to savepoint ${savepointName}`));\n\t\t// \tthrow e;\n\t\t// }\n\t}\n}\n\nexport type NeonHttpQueryResult<T> = Omit<FullQueryResults<false>, 'rows'> & { rows: T[] };\n\nexport interface NeonHttpQueryResultHKT extends PgQueryResultHKT {\n\ttype: NeonHttpQueryResult<this['row']>;\n}\n","// ===========================================\n// Lab404Electronics Database Schema\n// ===========================================\n\n// Categories\nexport * from './categories';\n\n// Products\nexport * from './products';\n\n// Customers\nexport * from './customers';\n\n// Orders\nexport * from './orders';\n\n// Promo Codes\nexport * from './promoCodes';\n\n// Quotations\nexport * from './quotations';\n\n// Blogs\nexport * from './blogs';\n\n// Settings\nexport * from './settings';\n\n// Carts\nexport * from './carts';\n\n// Imports\nexport * from './imports';\n\n// PDF Templates\nexport * from './pdfTemplates';\n\n// Verification Codes\nexport * from './verificationCodes';\n\n// Sessions\nexport * from './sessions';\n\n// Password History\nexport * from './passwordHistory';\n\n// Login Attempts\nexport * from './loginAttempts';\n\n// Breach Checks\nexport * from './breachChecks';\n\n// Security Audit Logs\nexport * from './securityAuditLogs';\n\n// IP Reputation\nexport * from './ipReputation';\n\n// Newsletter\nexport * from './newsletter';\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, type AnyPgColumn } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\n\nexport const categories = pgTable('categories', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  description: text('description'),\n  imageUrl: varchar('image_url', { length: 500 }),\n  parentId: uuid('parent_id').references((): AnyPgColumn => categories.id, { onDelete: 'set null' }),\n  isActive: boolean('is_active').default(true).notNull(),\n  sortOrder: integer('sort_order').default(0).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const categoriesRelations = relations(categories, ({ one, many }) => ({\n  parent: one(categories, {\n    fields: [categories.parentId],\n    references: [categories.id],\n    relationName: 'parentChild',\n  }),\n  children: many(categories, { relationName: 'parentChild' }),\n}));\n\nexport type Category = typeof categories.$inferSelect;\nexport type NewCategory = typeof categories.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, decimal, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { categories } from './categories';\n\n// Enums\nexport const productStatusEnum = pgEnum('product_status', ['draft', 'active', 'archived']);\n\n// Products table\nexport const products = pgTable('products', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  sku: varchar('sku', { length: 100 }).notNull().unique(),\n  barcode: varchar('barcode', { length: 100 }),\n  name: varchar('name', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  description: text('description'),\n  shortDescription: varchar('short_description', { length: 500 }),\n  categoryId: uuid('category_id').references(() => categories.id, { onDelete: 'set null' }),\n  brand: varchar('brand', { length: 255 }),\n\n  // Pricing - base price only, calculations done in backend\n  basePrice: decimal('base_price', { precision: 10, scale: 2 }).notNull(),\n  costPrice: decimal('cost_price', { precision: 10, scale: 2 }),\n  compareAtPrice: decimal('compare_at_price', { precision: 10, scale: 2 }),\n\n  // Physical attributes\n  weight: decimal('weight', { precision: 10, scale: 2 }), // in grams\n  dimensions: jsonb('dimensions').$type<{ width?: number; height?: number; depth?: number }>(),\n\n  // Inventory\n  stockQuantity: integer('stock_quantity').default(0).notNull(),\n  lowStockThreshold: integer('low_stock_threshold').default(5).notNull(),\n  trackInventory: boolean('track_inventory').default(true).notNull(),\n  allowBackorder: boolean('allow_backorder').default(false).notNull(),\n\n  // Media - stored as JSON arrays\n  images: jsonb('images').default([]).$type<Array<{ url: string; alt?: string; width?: number; height?: number }>>(),\n  videos: jsonb('videos').default([]).$type<Array<{ url: string; title?: string }>>(),\n  thumbnailUrl: varchar('thumbnail_url', { length: 500 }),\n\n  // Organization & categorization\n  tags: jsonb('tags').default([]).$type<string[]>(),\n  specifications: jsonb('specifications').default({}).$type<Record<string, string>>(),\n  features: jsonb('features').default([]).$type<string[]>(),\n\n  // SEO\n  metaTitle: varchar('meta_title', { length: 255 }),\n  metaDescription: varchar('meta_description', { length: 500 }),\n\n  // Status & flags\n  status: productStatusEnum('status').default('draft').notNull(),\n  isFeatured: boolean('is_featured').default(false).notNull(),\n  isDigital: boolean('is_digital').default(false).notNull(),\n  requiresShipping: boolean('requires_shipping').default(true).notNull(),\n\n  // Supplier information\n  supplierId: varchar('supplier_id', { length: 255 }),\n  supplierSku: varchar('supplier_sku', { length: 255 }),\n\n  // Import tracking\n  importedFrom: varchar('imported_from', { length: 255 }),\n  externalUrl: varchar('external_url', { length: 500 }),\n\n  // Timestamps\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Product variants table\nexport const productVariants = pgTable('product_variants', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'cascade' }).notNull(),\n  sku: varchar('sku', { length: 100 }).notNull().unique(),\n  name: varchar('name', { length: 255 }).notNull(),\n  options: jsonb('options').notNull().$type<Record<string, string>>(),\n  basePrice: decimal('base_price', { precision: 10, scale: 2 }).notNull(),\n  stockQuantity: integer('stock_quantity').default(0).notNull(),\n  imageUrl: varchar('image_url', { length: 500 }),\n  isActive: boolean('is_active').default(true).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  category: one(categories, {\n    fields: [products.categoryId],\n    references: [categories.id],\n  }),\n  variants: many(productVariants),\n}));\n\nexport const productVariantsRelations = relations(productVariants, ({ one }) => ({\n  product: one(products, {\n    fields: [productVariants.productId],\n    references: [products.id],\n  }),\n}));\n\n// Types\nexport type Product = typeof products.$inferSelect;\nexport type NewProduct = typeof products.$inferInsert;\nexport type ProductVariant = typeof productVariants.$inferSelect;\nexport type NewProductVariant = typeof productVariants.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, jsonb } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\n\n// Customers table\nexport const customers = pgTable('customers', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  authUserId: varchar('auth_user_id', { length: 255 }).unique(),\n  email: varchar('email', { length: 255 }).notNull(),\n  firstName: varchar('first_name', { length: 100 }),\n  lastName: varchar('last_name', { length: 100 }),\n  phone: varchar('phone', { length: 50 }),\n\n  // Authentication\n  passwordHash: varchar('password_hash', { length: 255 }),\n  role: varchar('role', { length: 20 }).default('customer').notNull(), // 'customer' | 'admin'\n\n  // Email verification\n  emailVerified: boolean('email_verified').default(false).notNull(),\n  emailVerifiedAt: timestamp('email_verified_at'),\n\n  // Default addresses stored as JSON\n  defaultShippingAddress: jsonb('default_shipping_address').$type<{\n    firstName: string;\n    lastName: string;\n    company?: string;\n    addressLine1: string;\n    addressLine2?: string;\n    city: string;\n    state?: string;\n    postalCode?: string;\n    country: string;\n    phone?: string;\n  }>(),\n  defaultBillingAddress: jsonb('default_billing_address').$type<{\n    firstName: string;\n    lastName: string;\n    company?: string;\n    addressLine1: string;\n    addressLine2?: string;\n    city: string;\n    state?: string;\n    postalCode?: string;\n    country: string;\n    phone?: string;\n  }>(),\n\n  // Account security\n  accountLocked: boolean('account_locked').default(false).notNull(),\n  accountLockedAt: timestamp('account_locked_at'),\n  accountLockedReason: text('account_locked_reason'),\n\n  // Customer data\n  isGuest: boolean('is_guest').default(false).notNull(),\n  isActive: boolean('is_active').default(true).notNull(),\n  acceptsMarketing: boolean('accepts_marketing').default(false).notNull(),\n  notes: text('notes'),\n  tags: varchar('tags', { length: 255 }).array(),\n\n  // Stats (count only, totals calculated)\n  orderCount: integer('order_count').default(0).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Customer addresses table\nexport const addresses = pgTable('addresses', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }).notNull(),\n  type: varchar('type', { length: 50 }).notNull(), // 'shipping' | 'billing'\n  firstName: varchar('first_name', { length: 100 }).notNull(),\n  lastName: varchar('last_name', { length: 100 }).notNull(),\n  company: varchar('company', { length: 255 }),\n  addressLine1: varchar('address_line1', { length: 255 }).notNull(),\n  addressLine2: varchar('address_line2', { length: 255 }),\n  city: varchar('city', { length: 100 }).notNull(),\n  state: varchar('state', { length: 100 }),\n  postalCode: varchar('postal_code', { length: 20 }),\n  country: varchar('country', { length: 100 }).notNull(),\n  phone: varchar('phone', { length: 50 }),\n  isDefault: boolean('is_default').default(false).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const customersRelations = relations(customers, ({ many }) => ({\n  addresses: many(addresses),\n}));\n\nexport const addressesRelations = relations(addresses, ({ one }) => ({\n  customer: one(customers, {\n    fields: [addresses.customerId],\n    references: [customers.id],\n  }),\n}));\n\n// Types\nexport type Customer = typeof customers.$inferSelect;\nexport type NewCustomer = typeof customers.$inferInsert;\nexport type Address = typeof addresses.$inferSelect;\nexport type NewAddress = typeof addresses.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, decimal, pgEnum } from 'drizzle-orm/pg-core';\n\n// Enums\nexport const discountTypeEnum = pgEnum('discount_type', ['percentage', 'fixed_amount']);\n\n// Promo codes table\nexport const promoCodes = pgTable('promo_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  code: varchar('code', { length: 50 }).notNull().unique(),\n  description: text('description'),\n\n  // Discount type\n  discountType: discountTypeEnum('discount_type').notNull(),\n  discountValue: decimal('discount_value', { precision: 10, scale: 2 }).notNull(),\n\n  // Constraints\n  minimumOrderAmount: decimal('minimum_order_amount', { precision: 10, scale: 2 }),\n  maximumDiscountAmount: decimal('maximum_discount_amount', { precision: 10, scale: 2 }),\n  usageLimit: integer('usage_limit'),\n  usageCount: integer('usage_count').default(0).notNull(),\n  usageLimitPerCustomer: integer('usage_limit_per_customer').default(1).notNull(),\n\n  // Validity\n  startsAt: timestamp('starts_at'),\n  expiresAt: timestamp('expires_at'),\n  isActive: boolean('is_active').default(true).notNull(),\n\n  // Restrictions (stored as UUID arrays)\n  appliesToProducts: uuid('applies_to_products').array(),\n  appliesToCategories: uuid('applies_to_categories').array(),\n  customerIds: uuid('customer_ids').array(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type PromoCode = typeof promoCodes.$inferSelect;\nexport type NewPromoCode = typeof promoCodes.$inferInsert;\n","import { pgTable, uuid, varchar, text, integer, timestamp, decimal, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\nimport { promoCodes } from './promoCodes';\n\n// Enums\nexport const orderStatusEnum = pgEnum('order_status', ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']);\nexport const paymentStatusEnum = pgEnum('payment_status', ['pending', 'paid', 'refunded', 'failed']);\nexport const paymentMethodEnum = pgEnum('payment_method', ['cod', 'stripe', 'paypal', 'bank_transfer', 'cash']);\n\n// Address type for JSON columns\ntype AddressJson = {\n  firstName: string;\n  lastName: string;\n  company?: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone?: string;\n};\n\n// Orders table\nexport const orders = pgTable('orders', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  orderNumber: varchar('order_number', { length: 50 }).notNull().unique(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Status tracking\n  status: orderStatusEnum('status').default('pending').notNull(),\n  paymentStatus: paymentStatusEnum('payment_status').default('pending').notNull(),\n\n  // Addresses (snapshot at time of order)\n  shippingAddress: jsonb('shipping_address').notNull().$type<AddressJson>(),\n  billingAddress: jsonb('billing_address').notNull().$type<AddressJson>(),\n\n  // Pricing stored as snapshot (calculated at checkout time)\n  // CRITICAL: These are snapshots, not live calculated values\n  currency: varchar('currency', { length: 3 }).default('USD').notNull(),\n  subtotalSnapshot: decimal('subtotal_snapshot', { precision: 10, scale: 2 }).notNull(),\n  taxRateSnapshot: decimal('tax_rate_snapshot', { precision: 5, scale: 4 }).notNull(),\n  taxAmountSnapshot: decimal('tax_amount_snapshot', { precision: 10, scale: 2 }).notNull(),\n  shippingAmountSnapshot: decimal('shipping_amount_snapshot', { precision: 10, scale: 2 }).default('0').notNull(),\n  discountAmountSnapshot: decimal('discount_amount_snapshot', { precision: 10, scale: 2 }).default('0').notNull(),\n  totalSnapshot: decimal('total_snapshot', { precision: 10, scale: 2 }).notNull(),\n\n  // Promo code used\n  promoCodeId: uuid('promo_code_id').references(() => promoCodes.id, { onDelete: 'set null' }),\n  promoCodeSnapshot: varchar('promo_code_snapshot', { length: 50 }),\n\n  // Payment\n  paymentMethod: paymentMethodEnum('payment_method').default('cod').notNull(),\n\n  // Shipping\n  shippingMethod: varchar('shipping_method', { length: 100 }),\n  trackingNumber: varchar('tracking_number', { length: 255 }),\n  confirmedAt: timestamp('confirmed_at'),\n  processingAt: timestamp('processing_at'),\n  shippedAt: timestamp('shipped_at'),\n  deliveredAt: timestamp('delivered_at'),\n\n  // Notes\n  customerNotes: text('customer_notes'),\n  adminNotes: text('admin_notes'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Order items table\nexport const orderItems = pgTable('order_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  orderId: uuid('order_id').references(() => orders.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'set null' }),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'set null' }),\n\n  // Snapshot data (in case product changes later)\n  productNameSnapshot: varchar('product_name_snapshot', { length: 255 }).notNull(),\n  skuSnapshot: varchar('sku_snapshot', { length: 100 }).notNull(),\n  variantOptionsSnapshot: jsonb('variant_options_snapshot').$type<Record<string, string>>(),\n\n  quantity: integer('quantity').notNull(),\n  unitPriceSnapshot: decimal('unit_price_snapshot', { precision: 10, scale: 2 }).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const ordersRelations = relations(orders, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [orders.customerId],\n    references: [customers.id],\n  }),\n  promoCode: one(promoCodes, {\n    fields: [orders.promoCodeId],\n    references: [promoCodes.id],\n  }),\n  items: many(orderItems),\n}));\n\nexport const orderItemsRelations = relations(orderItems, ({ one }) => ({\n  order: one(orders, {\n    fields: [orderItems.orderId],\n    references: [orders.id],\n  }),\n  product: one(products, {\n    fields: [orderItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [orderItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\n// Types\nexport type Order = typeof orders.$inferSelect;\nexport type NewOrder = typeof orders.$inferInsert;\nexport type OrderItem = typeof orderItems.$inferSelect;\nexport type NewOrderItem = typeof orderItems.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, boolean } from 'drizzle-orm/pg-core';\n\n/**\n * PDF Templates table\n * Stores customizable templates for quotation and invoice PDFs\n */\nexport const pdfTemplates = pgTable('pdf_templates', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 100 }).notNull(),\n  isDefault: boolean('is_default').default(false).notNull(),\n\n  // Branding\n  logoUrl: varchar('logo_url', { length: 500 }),\n  primaryColor: varchar('primary_color', { length: 7 }).default('#1a1a2e').notNull(),\n  accentColor: varchar('accent_color', { length: 7 }).default('#0066cc').notNull(),\n\n  // Display options\n  showCompanyLogo: boolean('show_company_logo').default(true).notNull(),\n  showLineItemImages: boolean('show_line_item_images').default(false).notNull(),\n  showLineItemDescription: boolean('show_line_item_description').default(false).notNull(),\n  showSku: boolean('show_sku').default(true).notNull(),\n\n  // Custom text\n  headerText: text('header_text'),\n  footerText: text('footer_text'),\n  thankYouMessage: text('thank_you_message'),\n\n  // Metadata\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type PdfTemplate = typeof pdfTemplates.$inferSelect;\nexport type NewPdfTemplate = typeof pdfTemplates.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, decimal, jsonb, pgEnum, integer } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\nimport { orders } from './orders';\nimport { pdfTemplates } from './pdfTemplates';\n\n// Enums\nexport const quotationStatusEnum = pgEnum('quotation_status', ['draft', 'sent', 'accepted', 'rejected', 'expired']);\n\n// Address type for JSON column\ntype AddressJson = {\n  firstName: string;\n  lastName: string;\n  company?: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone?: string;\n};\n\n// Quotations table\nexport const quotations = pgTable('quotations', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationNumber: varchar('quotation_number', { length: 50 }).notNull().unique(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Customer info (for non-registered customers)\n  customerName: varchar('customer_name', { length: 255 }).notNull(),\n  customerEmail: varchar('customer_email', { length: 255 }).notNull(),\n  customerPhone: varchar('customer_phone', { length: 50 }),\n  customerCompany: varchar('customer_company', { length: 255 }),\n  customerAddress: jsonb('customer_address').$type<AddressJson>(),\n\n  // Status\n  status: quotationStatusEnum('status').default('draft').notNull(),\n\n  // Validity\n  validUntil: timestamp('valid_until'),\n  validDays: integer('valid_days').default(30),\n\n  // Pricing (calculated at generation time)\n  currency: varchar('currency', { length: 3 }).default('USD').notNull(),\n  subtotal: decimal('subtotal', { precision: 10, scale: 2 }).notNull(),\n  taxRate: decimal('tax_rate', { precision: 5, scale: 4 }),\n  taxAmount: decimal('tax_amount', { precision: 10, scale: 2 }),\n  discountType: varchar('discount_type', { length: 20 }), // 'percentage' or 'fixed'\n  discountValue: decimal('discount_value', { precision: 10, scale: 2 }),\n  discountAmount: decimal('discount_amount', { precision: 10, scale: 2 }).default('0').notNull(),\n  total: decimal('total', { precision: 10, scale: 2 }).notNull(),\n\n  // Notes\n  notes: text('notes'),\n  termsAndConditions: text('terms_and_conditions'),\n\n  // PDF\n  pdfUrl: varchar('pdf_url', { length: 500 }),\n  pdfTemplateId: uuid('pdf_template_id').references(() => pdfTemplates.id, { onDelete: 'set null' }),\n\n  // Converted to order\n  convertedToOrderId: uuid('converted_to_order_id').references(() => orders.id, { onDelete: 'set null' }),\n\n  // Customer acceptance link\n  acceptanceToken: varchar('acceptance_token', { length: 64 }).unique(),\n  tokenExpiresAt: timestamp('token_expires_at'),\n  viewedAt: timestamp('viewed_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Quotation items table\nexport const quotationItems = pgTable('quotation_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'set null' }),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'set null' }),\n\n  // Item details (can be custom items not in catalog)\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  sku: varchar('sku', { length: 100 }),\n  quantity: integer('quantity').notNull(),\n  unitPrice: decimal('unit_price', { precision: 10, scale: 2 }).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const quotationsRelations = relations(quotations, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [quotations.customerId],\n    references: [customers.id],\n  }),\n  convertedToOrder: one(orders, {\n    fields: [quotations.convertedToOrderId],\n    references: [orders.id],\n  }),\n  pdfTemplate: one(pdfTemplates, {\n    fields: [quotations.pdfTemplateId],\n    references: [pdfTemplates.id],\n  }),\n  items: many(quotationItems),\n}));\n\nexport const quotationItemsRelations = relations(quotationItems, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationItems.quotationId],\n    references: [quotations.id],\n  }),\n  product: one(products, {\n    fields: [quotationItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [quotationItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\n// Quotation activities table (for timeline tracking)\nexport const quotationActivityTypeEnum = pgEnum('quotation_activity_type', [\n  'created',\n  'updated',\n  'sent',\n  'viewed',\n  'accepted',\n  'rejected',\n  'expired',\n  'converted',\n  'duplicated',\n  'pdf_generated',\n  'note_added',\n  'status_changed',\n]);\n\nexport const quotationActorTypeEnum = pgEnum('quotation_actor_type', [\n  'system',\n  'admin',\n  'customer',\n]);\n\nexport const quotationActivities = pgTable('quotation_activities', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n\n  // Activity type\n  activityType: quotationActivityTypeEnum('activity_type').notNull(),\n  description: text('description').notNull(),\n\n  // Who performed the action\n  actorType: quotationActorTypeEnum('actor_type').default('system').notNull(),\n  actorId: uuid('actor_id'), // admin user id or customer id (optional)\n  actorName: varchar('actor_name', { length: 255 }), // Display name\n\n  // Additional metadata (JSON for flexibility)\n  metadata: jsonb('metadata').$type<Record<string, unknown>>(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const quotationActivitiesRelations = relations(quotationActivities, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationActivities.quotationId],\n    references: [quotations.id],\n  }),\n}));\n\n// Quotation templates table\ninterface TemplateItem {\n  productId?: string;\n  name: string;\n  description?: string;\n  sku?: string;\n  quantity: number;\n  unitPrice: number;\n}\n\nexport const quotationTemplates = pgTable('quotation_templates', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n\n  // Template items (stored as JSON)\n  items: jsonb('items').$type<TemplateItem[]>().notNull().default([]),\n\n  // Default pricing settings\n  defaultDiscount: decimal('default_discount', { precision: 10, scale: 2 }),\n  defaultDiscountType: varchar('default_discount_type', { length: 20 }),\n  defaultTaxRate: decimal('default_tax_rate', { precision: 5, scale: 4 }),\n  defaultValidDays: integer('default_valid_days').default(30),\n\n  // Default terms\n  defaultTerms: text('default_terms'),\n\n  isActive: integer('is_active').default(1).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Quotation revisions table (for revision history)\ninterface RevisionSnapshot {\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string | null;\n  customerCompany?: string | null;\n  status: string;\n  subtotal: number;\n  taxRate?: number;\n  taxAmount?: number;\n  discountType?: string | null;\n  discountValue?: number;\n  discountAmount: number;\n  total: number;\n  validUntil?: Date | null;\n  notes?: string | null;\n  termsAndConditions?: string | null;\n  items: Array<{\n    productId?: string | null;\n    variantId?: string | null;\n    name: string;\n    description?: string | null;\n    sku?: string | null;\n    quantity: number;\n    unitPrice: number;\n  }>;\n}\n\nexport const quotationRevisions = pgTable('quotation_revisions', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n  versionNumber: integer('version_number').notNull(),\n  snapshot: jsonb('snapshot').$type<RevisionSnapshot>().notNull(),\n  changeDescription: text('change_description'),\n  createdBy: uuid('created_by'), // Admin user ID\n  createdByName: varchar('created_by_name', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const quotationRevisionsRelations = relations(quotationRevisions, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationRevisions.quotationId],\n    references: [quotations.id],\n  }),\n}));\n\n// Types\nexport type Quotation = typeof quotations.$inferSelect;\nexport type NewQuotation = typeof quotations.$inferInsert;\nexport type QuotationItem = typeof quotationItems.$inferSelect;\nexport type NewQuotationItem = typeof quotationItems.$inferInsert;\nexport type QuotationActivity = typeof quotationActivities.$inferSelect;\nexport type NewQuotationActivity = typeof quotationActivities.$inferInsert;\nexport type QuotationTemplate = typeof quotationTemplates.$inferSelect;\nexport type NewQuotationTemplate = typeof quotationTemplates.$inferInsert;\nexport type QuotationRevision = typeof quotationRevisions.$inferSelect;\nexport type NewQuotationRevision = typeof quotationRevisions.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, pgEnum } from 'drizzle-orm/pg-core';\n\n// Enums\nexport const blogStatusEnum = pgEnum('blog_status', ['draft', 'published', 'archived']);\n\n// Blogs table\nexport const blogs = pgTable('blogs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  title: varchar('title', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  content: text('content').notNull(),\n  excerpt: varchar('excerpt', { length: 500 }),\n  featuredImageUrl: varchar('featured_image_url', { length: 500 }),\n\n  authorId: uuid('author_id'),\n  authorName: varchar('author_name', { length: 255 }),\n\n  status: blogStatusEnum('status').default('draft').notNull(),\n  publishedAt: timestamp('published_at'),\n\n  // SEO\n  metaTitle: varchar('meta_title', { length: 255 }),\n  metaDescription: varchar('meta_description', { length: 500 }),\n  tags: varchar('tags', { length: 100 }).array(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type Blog = typeof blogs.$inferSelect;\nexport type NewBlog = typeof blogs.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, jsonb } from 'drizzle-orm/pg-core';\n\n// Settings table\nexport const settings = pgTable('settings', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  key: varchar('key', { length: 100 }).notNull().unique(),\n  value: jsonb('value').notNull(),\n  description: text('description'),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Admin activity log table\nexport const adminActivityLogs = pgTable('admin_activity_logs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  adminUserId: varchar('admin_user_id', { length: 255 }).notNull(),\n  action: varchar('action', { length: 100 }).notNull(),\n  entityType: varchar('entity_type', { length: 100 }).notNull(),\n  entityId: uuid('entity_id'),\n  details: jsonb('details'),\n  ipAddress: varchar('ip_address', { length: 50 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Types\nexport type Setting = typeof settings.$inferSelect;\nexport type NewSetting = typeof settings.$inferInsert;\nexport type AdminActivityLog = typeof adminActivityLogs.$inferSelect;\nexport type NewAdminActivityLog = typeof adminActivityLogs.$inferInsert;\n","import { pgTable, uuid, varchar, integer, timestamp } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\n\n// Carts table\nexport const carts = pgTable('carts', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n  sessionId: varchar('session_id', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Cart items table\nexport const cartItems = pgTable('cart_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  cartId: uuid('cart_id').references(() => carts.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'cascade' }).notNull(),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'cascade' }),\n  quantity: integer('quantity').notNull().default(1),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Cart promo codes table (for applied promo codes)\nexport const cartPromoCodes = pgTable('cart_promo_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  cartId: uuid('cart_id').references(() => carts.id, { onDelete: 'cascade' }).notNull().unique(),\n  promoCodeId: uuid('promo_code_id').notNull(),\n  code: varchar('code', { length: 50 }).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const cartsRelations = relations(carts, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [carts.customerId],\n    references: [customers.id],\n  }),\n  items: many(cartItems),\n  promoCode: one(cartPromoCodes),\n}));\n\nexport const cartItemsRelations = relations(cartItems, ({ one }) => ({\n  cart: one(carts, {\n    fields: [cartItems.cartId],\n    references: [carts.id],\n  }),\n  product: one(products, {\n    fields: [cartItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [cartItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\nexport const cartPromoCodesRelations = relations(cartPromoCodes, ({ one }) => ({\n  cart: one(carts, {\n    fields: [cartPromoCodes.cartId],\n    references: [carts.id],\n  }),\n}));\n\n// Types\nexport type Cart = typeof carts.$inferSelect;\nexport type NewCart = typeof carts.$inferInsert;\nexport type CartItem = typeof cartItems.$inferSelect;\nexport type NewCartItem = typeof cartItems.$inferInsert;\nexport type CartPromoCode = typeof cartPromoCodes.$inferSelect;\nexport type NewCartPromoCode = typeof cartPromoCodes.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { products } from './products';\n\n// Enums\nexport const importSourceEnum = pgEnum('import_source', ['amazon', 'aliexpress', 'ebay']);\nexport const importStatusEnum = pgEnum('import_status', ['pending', 'processing', 'completed', 'failed']);\n\n// Product import jobs table\nexport const productImportJobs = pgTable('product_import_jobs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  source: importSourceEnum('source').notNull(),\n  sourceUrl: varchar('source_url', { length: 500 }).notNull(),\n  status: importStatusEnum('status').default('pending').notNull(),\n  importedProductId: uuid('imported_product_id').references(() => products.id, { onDelete: 'set null' }),\n  errorMessage: text('error_message'),\n  rawData: jsonb('raw_data'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  completedAt: timestamp('completed_at'),\n});\n\n// Relations\nexport const productImportJobsRelations = relations(productImportJobs, ({ one }) => ({\n  importedProduct: one(products, {\n    fields: [productImportJobs.importedProductId],\n    references: [products.id],\n  }),\n}));\n\n// Types\nexport type ProductImportJob = typeof productImportJobs.$inferSelect;\nexport type NewProductImportJob = typeof productImportJobs.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, integer, boolean, pgEnum, index } from 'drizzle-orm/pg-core';\n\nexport const verificationCodeTypeEnum = pgEnum('verification_code_type', [\n  'password_reset',\n  'email_verification',\n  'account_unlock'\n]);\n\nexport const verificationCodes = pgTable('verification_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  // Code details\n  email: varchar('email', { length: 255 }).notNull(),\n  code: varchar('code', { length: 6 }).notNull(),\n  type: verificationCodeTypeEnum('type').notNull(),\n\n  // Security & tracking\n  attempts: integer('attempts').default(0).notNull(),\n  maxAttempts: integer('max_attempts').default(3).notNull(),\n\n  // Expiration\n  expiresAt: timestamp('expires_at').notNull(),\n\n  // Status tracking\n  isUsed: boolean('is_used').default(false).notNull(),\n  usedAt: timestamp('used_at'),\n\n  // IP tracking\n  ipAddress: varchar('ip_address', { length: 45 }),\n\n  // Timestamps\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n}, (table) => ({\n  emailIdx: index('verification_codes_email_idx').on(table.email),\n  expiresAtIdx: index('verification_codes_expires_at_idx').on(table.expiresAt),\n}));\n\n// Types\nexport type VerificationCode = typeof verificationCodes.$inferSelect;\nexport type NewVerificationCode = typeof verificationCodes.$inferInsert;\nexport type VerificationCodeType = 'password_reset' | 'email_verification' | 'account_unlock';\n","import { pgTable, uuid, varchar, text, timestamp, boolean, decimal, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const sessions = pgTable(\n  'sessions',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id')\n      .notNull()\n      .references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Token tracking\n    tokenHash: varchar('token_hash', { length: 255 }).unique().notNull(),\n\n    // Device information\n    deviceName: varchar('device_name', { length: 100 }),\n    deviceType: varchar('device_type', { length: 50 }), // desktop | mobile | tablet\n    deviceBrowser: varchar('device_browser', { length: 50 }),\n    browserVersion: varchar('browser_version', { length: 50 }),\n    osName: varchar('os_name', { length: 50 }),\n    osVersion: varchar('os_version', { length: 50 }),\n\n    // Network information\n    ipAddress: varchar('ip_address', { length: 45 }).notNull(),\n    ipCountry: varchar('ip_country', { length: 100 }),\n    ipCity: varchar('ip_city', { length: 100 }),\n    ipLatitude: decimal('ip_latitude', { precision: 10, scale: 8 }),\n    ipLongitude: decimal('ip_longitude', { precision: 11, scale: 8 }),\n\n    // Full user agent\n    userAgent: text('user_agent').notNull(),\n\n    // Activity tracking\n    loginAt: timestamp('login_at').notNull().defaultNow(),\n    lastActivityAt: timestamp('last_activity_at').notNull().defaultNow(),\n\n    // Session status\n    isActive: boolean('is_active').default(true).notNull(),\n    revokedAt: timestamp('revoked_at'),\n    revokeReason: varchar('revoke_reason', { length: 100 }), // user_action | security | admin_action\n\n    // Timestamps\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    customerIdx: index('sessions_customer_idx').on(table.customerId),\n    activeIdx: index('sessions_active_idx').on(table.isActive),\n    activityIdx: index('sessions_activity_idx').on(table.lastActivityAt),\n    tokenHashIdx: index('sessions_token_hash_idx').on(table.tokenHash),\n  })\n);\n\nexport type Session = typeof sessions.$inferSelect;\nexport type NewSession = typeof sessions.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const passwordHistory = pgTable(\n  'password_history',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id')\n      .notNull()\n      .references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Password hash (stored to prevent reuse)\n    passwordHash: varchar('password_hash', { length: 255 }).notNull(),\n\n    // Metadata\n    changedAt: timestamp('changed_at').notNull().defaultNow(),\n    ipAddress: varchar('ip_address', { length: 45 }),\n    userAgent: varchar('user_agent', { length: 500 }),\n\n    // Source of change\n    changeReason: varchar('change_reason', { length: 50 }), // user_action | admin_reset | password_reset | forced_change\n  },\n  (table) => ({\n    customerIdx: index('password_history_customer_idx').on(table.customerId),\n    changedAtIdx: index('password_history_changed_at_idx').on(table.changedAt),\n  })\n);\n\nexport type PasswordHistory = typeof passwordHistory.$inferSelect;\nexport type NewPasswordHistory = typeof passwordHistory.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, boolean, integer, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const loginAttempts = pgTable(\n  'login_attempts',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Attempt details\n    email: varchar('email', { length: 255 }).notNull(),\n    success: boolean('success').notNull(),\n    failureReason: varchar('failure_reason', { length: 100 }), // invalid_credentials | account_locked | email_unverified | account_disabled\n\n    // Device and network information\n    ipAddress: varchar('ip_address', { length: 45 }).notNull(),\n    userAgent: varchar('user_agent', { length: 500 }),\n    deviceType: varchar('device_type', { length: 50 }), // desktop | mobile | tablet\n    deviceBrowser: varchar('device_browser', { length: 50 }),\n\n    // Geographic information (optional)\n    ipCountry: varchar('ip_country', { length: 100 }),\n    ipCity: varchar('ip_city', { length: 100 }),\n\n    // Lockout tracking\n    triggeredLockout: boolean('triggered_lockout').default(false).notNull(),\n    consecutiveFailures: integer('consecutive_failures').default(0).notNull(),\n\n    // Timestamp\n    attemptedAt: timestamp('attempted_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    customerIdx: index('login_attempts_customer_idx').on(table.customerId),\n    emailIdx: index('login_attempts_email_idx').on(table.email),\n    attemptedAtIdx: index('login_attempts_attempted_at_idx').on(table.attemptedAt),\n    successIdx: index('login_attempts_success_idx').on(table.success),\n  })\n);\n\nexport type LoginAttempt = typeof loginAttempts.$inferSelect;\nexport type NewLoginAttempt = typeof loginAttempts.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, integer, boolean, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const breachChecks = pgTable(\n  'breach_checks',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Password hash prefix (k-anonymity - first 5 chars of SHA-1)\n    passwordHashPrefix: varchar('password_hash_prefix', { length: 5 }).notNull(),\n\n    // Breach status\n    isBreached: boolean('is_breached').notNull(),\n    breachCount: integer('breach_count').default(0).notNull(), // Number of times seen in breaches\n\n    // Check metadata\n    checkedAt: timestamp('checked_at').notNull().defaultNow(),\n    expiresAt: timestamp('expires_at').notNull(), // Cache for 30 days\n\n    // Context\n    checkReason: varchar('check_reason', { length: 50 }), // registration | password_change | password_reset | periodic_check\n    ipAddress: varchar('ip_address', { length: 45 }),\n  },\n  (table) => ({\n    customerIdx: index('breach_checks_customer_idx').on(table.customerId),\n    prefixIdx: index('breach_checks_prefix_idx').on(table.passwordHashPrefix),\n    expiresAtIdx: index('breach_checks_expires_at_idx').on(table.expiresAt),\n  })\n);\n\nexport type BreachCheck = typeof breachChecks.$inferSelect;\nexport type NewBreachCheck = typeof breachChecks.$inferInsert;\n","import { pgTable, uuid, timestamp, varchar, text, jsonb, index } from 'drizzle-orm/pg-core';\n\n/**\n * Security Audit Logs Table\n *\n * Immutable append-only log of all security-critical events.\n * Used for compliance, forensics, and security monitoring.\n *\n * Retention: 90 days\n * Compliance: SOC 2, GDPR, ISO 27001\n */\nexport const securityAuditLogs = pgTable(\n  'security_audit_logs',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    timestamp: timestamp('timestamp').notNull().defaultNow(),\n    eventType: varchar('event_type', { length: 100 }).notNull(),\n\n    // Actor (who performed the action)\n    actorType: varchar('actor_type', { length: 20 }).notNull(), // customer | admin | system\n    actorId: uuid('actor_id'),\n    actorEmail: varchar('actor_email', { length: 255 }),\n\n    // Target (what was acted upon)\n    targetType: varchar('target_type', { length: 50 }),\n    targetId: uuid('target_id'),\n\n    // Action\n    action: varchar('action', { length: 50 }).notNull(),\n    status: varchar('status', { length: 20 }).notNull(), // success | failure | denied\n\n    // Context\n    ipAddress: varchar('ip_address', { length: 45 }),\n    userAgent: text('user_agent'),\n    sessionId: uuid('session_id'),\n    requestId: uuid('request_id'),\n\n    // Event-specific metadata\n    metadata: jsonb('metadata'),\n\n    // Timestamp\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    // Performance indexes for common queries\n    timestampIdx: index('audit_logs_timestamp_idx').on(table.timestamp),\n    eventTypeIdx: index('audit_logs_event_type_idx').on(table.eventType),\n    actorIdx: index('audit_logs_actor_idx').on(table.actorId),\n    ipAddressIdx: index('audit_logs_ip_address_idx').on(table.ipAddress),\n    sessionIdx: index('audit_logs_session_idx').on(table.sessionId),\n  })\n);\n\nexport type SecurityAuditLog = typeof securityAuditLogs.$inferSelect;\nexport type NewSecurityAuditLog = typeof securityAuditLogs.$inferInsert;\n","import { pgTable, uuid, varchar, integer, timestamp, text, boolean, index } from 'drizzle-orm/pg-core';\n\n/**\n * IP Reputation Tracking Table\n *\n * Tracks IP addresses with reputation scores for abuse prevention.\n * Used to identify and block malicious IPs automatically.\n */\nexport const ipReputation = pgTable(\n  'ip_reputation',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    ipAddress: varchar('ip_address', { length: 45 }).notNull().unique(),\n\n    // Reputation scoring\n    reputationScore: integer('reputation_score').notNull().default(100), // 0-100, lower = worse\n\n    // Counters\n    failedLoginAttempts: integer('failed_login_attempts').notNull().default(0),\n    successfulLogins: integer('successful_logins').notNull().default(0),\n    rateLimitViolations: integer('rate_limit_violations').notNull().default(0),\n    abuseReports: integer('abuse_reports').notNull().default(0),\n\n    // Status\n    isBlocked: boolean('is_blocked').default(false).notNull(),\n    blockReason: varchar('block_reason', { length: 255 }),\n    blockedAt: timestamp('blocked_at'),\n    blockedUntil: timestamp('blocked_until'), // Null = permanent block\n\n    // Metadata\n    lastSeenAt: timestamp('last_seen_at').notNull().defaultNow(),\n    firstSeenAt: timestamp('first_seen_at').notNull().defaultNow(),\n    userAgent: text('user_agent'),\n    country: varchar('country', { length: 100 }),\n    notes: text('notes'),\n\n    // Timestamps\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    ipAddressIdx: index('ip_reputation_ip_address_idx').on(table.ipAddress),\n    isBlockedIdx: index('ip_reputation_is_blocked_idx').on(table.isBlocked),\n    reputationScoreIdx: index('ip_reputation_score_idx').on(table.reputationScore),\n  })\n);\n\nexport type IpReputation = typeof ipReputation.$inferSelect;\nexport type NewIpReputation = typeof ipReputation.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, jsonb, uniqueIndex } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\n\n// ===========================================\n// Newsletter Subscribers\n// ===========================================\n\nexport const newsletterSubscribers = pgTable('newsletter_subscribers', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  email: varchar('email', { length: 255 }).notNull(),\n  name: varchar('name', { length: 100 }),\n\n  // Link to customer if they have an account\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Status\n  status: varchar('status', { length: 20 }).default('active').notNull(), // 'active' | 'unsubscribed' | 'bounced'\n\n  // Source of subscription\n  source: varchar('source', { length: 50 }).default('footer').notNull(), // 'footer' | 'checkout' | 'popup' | 'import' | 'admin'\n\n  // Unsubscribe token for secure unsubscribe links\n  unsubscribeToken: varchar('unsubscribe_token', { length: 64 }).notNull(),\n\n  // Timestamps\n  subscribedAt: timestamp('subscribed_at').defaultNow().notNull(),\n  unsubscribedAt: timestamp('unsubscribed_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n}, (table) => [\n  uniqueIndex('newsletter_subscribers_email_idx').on(table.email),\n]);\n\n// ===========================================\n// Newsletter Campaigns\n// ===========================================\n\nexport const newsletterCampaigns = pgTable('newsletter_campaigns', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  // Campaign details\n  name: varchar('name', { length: 255 }).notNull(),\n  subject: varchar('subject', { length: 255 }).notNull(),\n  previewText: varchar('preview_text', { length: 255 }), // Email preview text\n  content: text('content').notNull(), // HTML content\n\n  // Status: draft | scheduled | sending | paused | completed | cancelled\n  status: varchar('status', { length: 20 }).default('draft').notNull(),\n\n  // Sending configuration\n  dailyLimit: integer('daily_limit').default(100).notNull(), // Max emails per day\n  sendTime: varchar('send_time', { length: 5 }), // Preferred send time HH:MM (24h format)\n\n  // Statistics\n  totalRecipients: integer('total_recipients').default(0).notNull(),\n  sentCount: integer('sent_count').default(0).notNull(),\n  failedCount: integer('failed_count').default(0).notNull(),\n  openCount: integer('open_count').default(0).notNull(),\n  clickCount: integer('click_count').default(0).notNull(),\n\n  // Timestamps\n  scheduledAt: timestamp('scheduled_at'), // When to start sending\n  startedAt: timestamp('started_at'), // When sending actually started\n  completedAt: timestamp('completed_at'), // When all emails were sent\n  lastSentAt: timestamp('last_sent_at'), // Last email sent timestamp\n\n  // Created by admin\n  createdBy: uuid('created_by').references(() => customers.id, { onDelete: 'set null' }),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// ===========================================\n// Newsletter Sends (Individual email tracking)\n// ===========================================\n\nexport const newsletterSends = pgTable('newsletter_sends', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  campaignId: uuid('campaign_id').references(() => newsletterCampaigns.id, { onDelete: 'cascade' }).notNull(),\n  subscriberId: uuid('subscriber_id').references(() => newsletterSubscribers.id, { onDelete: 'cascade' }).notNull(),\n\n  // Email address at time of send (in case subscriber changes email)\n  email: varchar('email', { length: 255 }).notNull(),\n\n  // Status: pending | sent | failed | bounced\n  status: varchar('status', { length: 20 }).default('pending').notNull(),\n\n  // Error tracking\n  errorMessage: text('error_message'),\n  retryCount: integer('retry_count').default(0).notNull(),\n\n  // Engagement tracking\n  openedAt: timestamp('opened_at'),\n  clickedAt: timestamp('clicked_at'),\n\n  // Timestamps\n  scheduledFor: timestamp('scheduled_for'), // When this email should be sent\n  sentAt: timestamp('sent_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// ===========================================\n// Relations\n// ===========================================\n\nexport const newsletterSubscribersRelations = relations(newsletterSubscribers, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [newsletterSubscribers.customerId],\n    references: [customers.id],\n  }),\n  sends: many(newsletterSends),\n}));\n\nexport const newsletterCampaignsRelations = relations(newsletterCampaigns, ({ one, many }) => ({\n  createdByCustomer: one(customers, {\n    fields: [newsletterCampaigns.createdBy],\n    references: [customers.id],\n  }),\n  sends: many(newsletterSends),\n}));\n\nexport const newsletterSendsRelations = relations(newsletterSends, ({ one }) => ({\n  campaign: one(newsletterCampaigns, {\n    fields: [newsletterSends.campaignId],\n    references: [newsletterCampaigns.id],\n  }),\n  subscriber: one(newsletterSubscribers, {\n    fields: [newsletterSends.subscriberId],\n    references: [newsletterSubscribers.id],\n  }),\n}));\n\n// ===========================================\n// Types\n// ===========================================\n\nexport type NewsletterSubscriber = typeof newsletterSubscribers.$inferSelect;\nexport type NewNewsletterSubscriber = typeof newsletterSubscribers.$inferInsert;\n\nexport type NewsletterCampaign = typeof newsletterCampaigns.$inferSelect;\nexport type NewNewsletterCampaign = typeof newsletterCampaigns.$inferInsert;\n\nexport type NewsletterSend = typeof newsletterSends.$inferSelect;\nexport type NewNewsletterSend = typeof newsletterSends.$inferInsert;\n","import { db, sessions, eq, and, or, lt, desc, ne } from '@lab404/database';\nimport bcrypt from 'bcryptjs';\nimport { UAParser } from 'ua-parser-js';\nimport { logger } from '../utils/logger';\n\ninterface CreateSessionOptions {\n  customerId: string;\n  userAgent: string;\n  ipAddress: string;\n}\n\ninterface SessionInfo {\n  id: string;\n  customerId: string;\n  deviceName: string;\n  deviceType: string;\n  deviceBrowser: string;\n  browserVersion: string;\n  osName: string;\n  osVersion: string;\n  ipAddress: string;\n  ipCity: string | null;\n  ipCountry: string | null;\n  loginAt: Date;\n  lastActivityAt: Date;\n  isActive: boolean;\n}\n\nclass SessionService {\n  /**\n   * Parse User-Agent string to extract device information\n   */\n  private parseUserAgent(userAgent: string) {\n    const parser = new UAParser(userAgent);\n    const result = parser.getResult();\n\n    const browser = result.browser.name || 'Unknown Browser';\n    const browserVersion = result.browser.version || '';\n    const os = result.os.name || 'Unknown OS';\n    const osVersion = result.os.version || '';\n    const deviceType = result.device.type || 'desktop'; // desktop | mobile | tablet\n\n    const deviceName = `${browser} on ${os}${osVersion ? ` ${osVersion}` : ''}`;\n\n    return {\n      deviceName,\n      deviceType,\n      deviceBrowser: browser,\n      browserVersion,\n      osName: os,\n      osVersion,\n    };\n  }\n\n  /**\n   * Create new session on login\n   * Returns sessionId for JWT embedding\n   */\n  async createSession(options: CreateSessionOptions): Promise<string> {\n    const { customerId, userAgent, ipAddress } = options;\n\n    // Parse device information\n    const deviceInfo = this.parseUserAgent(userAgent);\n\n    // Create session record (tokenHash will be set after JWT generation)\n    const [session] = await db\n      .insert(sessions)\n      .values({\n        customerId,\n        userAgent,\n        ipAddress,\n        ...deviceInfo,\n        tokenHash: 'pending', // Placeholder, will be updated after token generation\n        loginAt: new Date(),\n        lastActivityAt: new Date(),\n      })\n      .returning();\n\n    if (!session) {\n      throw new Error('Failed to create session');\n    }\n\n    logger.info('Session created', {\n      sessionId: session.id,\n      customerId,\n      deviceName: deviceInfo.deviceName,\n      ipAddress,\n    });\n\n    return session.id;\n  }\n\n  /**\n   * Update session with token hash after JWT generation\n   */\n  async setTokenHash(sessionId: string, token: string): Promise<void> {\n    const tokenHash = await bcrypt.hash(token, 10); // 10 rounds (faster than 12)\n\n    await db\n      .update(sessions)\n      .set({ tokenHash, updatedAt: new Date() })\n      .where(eq(sessions.id, sessionId));\n\n    logger.debug('Token hash set for session', { sessionId });\n  }\n\n  /**\n   * Validate session is active\n   */\n  async validateSession(sessionId: string): Promise<SessionInfo | null> {\n    const [session] = await db\n      .select()\n      .from(sessions)\n      .where(and(eq(sessions.id, sessionId), eq(sessions.isActive, true)))\n      .limit(1);\n\n    if (!session) {\n      return null;\n    }\n\n    return {\n      id: session.id,\n      customerId: session.customerId,\n      deviceName: session.deviceName || 'Unknown Device',\n      deviceType: session.deviceType || 'desktop',\n      deviceBrowser: session.deviceBrowser || '',\n      browserVersion: session.browserVersion || '',\n      osName: session.osName || '',\n      osVersion: session.osVersion || '',\n      ipAddress: session.ipAddress,\n      ipCity: session.ipCity,\n      ipCountry: session.ipCountry,\n      loginAt: session.loginAt,\n      lastActivityAt: session.lastActivityAt,\n      isActive: session.isActive,\n    };\n  }\n\n  /**\n   * Update last activity timestamp (async, non-blocking)\n   */\n  async updateActivity(sessionId: string): Promise<void> {\n    await db\n      .update(sessions)\n      .set({ lastActivityAt: new Date(), updatedAt: new Date() })\n      .where(eq(sessions.id, sessionId));\n  }\n\n  /**\n   * Get all active sessions for customer\n   */\n  async getActiveSessions(customerId: string): Promise<SessionInfo[]> {\n    const sessionList = await db\n      .select()\n      .from(sessions)\n      .where(and(eq(sessions.customerId, customerId), eq(sessions.isActive, true)))\n      .orderBy(desc(sessions.lastActivityAt));\n\n    return sessionList.map((session) => ({\n      id: session.id,\n      customerId: session.customerId,\n      deviceName: session.deviceName || 'Unknown Device',\n      deviceType: session.deviceType || 'desktop',\n      deviceBrowser: session.deviceBrowser || '',\n      browserVersion: session.browserVersion || '',\n      osName: session.osName || '',\n      osVersion: session.osVersion || '',\n      ipAddress: session.ipAddress,\n      ipCity: session.ipCity,\n      ipCountry: session.ipCountry,\n      loginAt: session.loginAt,\n      lastActivityAt: session.lastActivityAt,\n      isActive: session.isActive,\n    }));\n  }\n\n  /**\n   * Revoke specific session\n   */\n  async revokeSession(\n    sessionId: string,\n    reason: 'user_action' | 'security' | 'admin_action'\n  ): Promise<void> {\n    await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: reason,\n        updatedAt: new Date(),\n      })\n      .where(eq(sessions.id, sessionId));\n\n    logger.info('Session revoked', { sessionId, reason });\n  }\n\n  /**\n   * Revoke all sessions except current\n   */\n  async revokeOtherSessions(customerId: string, currentSessionId: string): Promise<number> {\n    const result = await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: 'user_action',\n        updatedAt: new Date(),\n      })\n      .where(\n        and(\n          eq(sessions.customerId, customerId),\n          eq(sessions.isActive, true),\n          ne(sessions.id, currentSessionId)\n        )\n      );\n\n    const count = result.rowCount || 0;\n    logger.info('Other sessions revoked', { customerId, count });\n    return count;\n  }\n\n  /**\n   * Revoke all sessions for customer\n   */\n  async revokeAllSessions(customerId: string): Promise<number> {\n    const result = await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: 'user_action',\n        updatedAt: new Date(),\n      })\n      .where(and(eq(sessions.customerId, customerId), eq(sessions.isActive, true)));\n\n    const count = result.rowCount || 0;\n    logger.info('All sessions revoked', { customerId, count });\n    return count;\n  }\n\n  /**\n   * Cleanup old/revoked sessions (for cron job)\n   */\n  async cleanupSessions(): Promise<number> {\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n    const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);\n\n    const result = await db\n      .delete(sessions)\n      .where(\n        or(\n          // Revoked sessions older than 30 days\n          and(eq(sessions.isActive, false), lt(sessions.revokedAt, thirtyDaysAgo)),\n          // Inactive sessions older than 7 days\n          and(eq(sessions.isActive, false), lt(sessions.lastActivityAt, sevenDaysAgo)),\n          // Very old sessions (90+ days)\n          lt(sessions.createdAt, ninetyDaysAgo)\n        )\n      );\n\n    const count = result.rowCount || 0;\n    logger.info('Sessions cleaned up', { count });\n    return count;\n  }\n}\n\nexport const sessionService = new SessionService();\n","import { Request, Response, NextFunction } from 'express';\nimport { ZodType, ZodTypeDef, ZodError } from 'zod';\nimport { ValidationError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n/**\n * Request validation middleware factory\n * Validates request body, query, or params against a Zod schema\n */\nexport function validate<T>(schema: ZodType<T, ZodTypeDef, unknown>, source: 'body' | 'query' | 'params' = 'body') {\n  return (req: Request, _res: Response, next: NextFunction): void => {\n    try {\n      const data = req[source];\n      const validated = schema.parse(data);\n\n      // Replace the source data with validated data\n      (req as unknown as Record<string, unknown>)[source] = validated;\n\n      next();\n    } catch (error) {\n      if (error instanceof ZodError) {\n        const details = error.errors.map((e) => ({\n          field: e.path.join('.'),\n          message: e.message,\n          code: e.code,\n        }));\n\n        // Log detailed validation errors for debugging\n        logger.error('Validation failed', {\n          path: req.path,\n          method: req.method,\n          errors: details,\n          receivedData: source === 'body' ? JSON.stringify(req.body).substring(0, 1000) : undefined,\n        });\n\n        next(new ValidationError('Validation failed', details));\n      } else {\n        next(error);\n      }\n    }\n  };\n}\n\n/**\n * Validate request body\n */\nexport function validateBody<T>(schema: ZodType<T, ZodTypeDef, unknown>) {\n  return validate(schema, 'body');\n}\n\n/**\n * Validate request query parameters\n */\nexport function validateQuery<T>(schema: ZodType<T, ZodTypeDef, unknown>) {\n  return validate(schema, 'query');\n}\n\n/**\n * Validate request URL parameters\n */\nexport function validateParams<T>(schema: ZodType<T, ZodTypeDef, unknown>) {\n  return validate(schema, 'params');\n}\n","import rateLimit from 'express-rate-limit';\nimport { sendError } from '../utils/response';\n\n/**\n * Default rate limiter - 100 requests per minute\n */\nexport const defaultLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 100,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Auth rate limiter - Strict limits for authentication endpoints\n * Production: 5 requests per 15 minutes (protects against brute force)\n * Development: 20 requests per 15 minutes (allows testing without being too permissive)\n * For login, register, password reset endpoints\n */\nexport const authLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: process.env['NODE_ENV'] === 'development' ? 20 : 5,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many authentication attempts, please try again later');\n  },\n});\n\n/**\n * API rate limiter - 30 requests per minute\n * For general API endpoints\n */\nexport const apiLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 30,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Strict rate limiter - 10 requests per minute\n * For sensitive operations like checkout\n */\nexport const strictLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 10,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Cron rate limiter - 10 requests per 15 minutes\n * For cron job endpoints to prevent abuse\n */\nexport const cronLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 10,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many cron requests, please try again later');\n  },\n});\n\n/**\n * Verification code rate limiter - 3 requests per hour\n * Rate limited by email address from request body (fallback to IP)\n * For verification code generation endpoints (password reset, email verification)\n */\nexport const verificationLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 hour\n  max: 3, // 3 requests per hour\n\n  // Rate limit by email address from request body, fallback to IP\n  keyGenerator: (req) => {\n    const email = req.body?.email;\n    return email ? email.toLowerCase() : req.ip;\n  },\n\n  standardHeaders: true,\n  legacyHeaders: false,\n\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS',\n      'Too many verification code requests. Please try again in 1 hour.');\n  },\n});\n","import { doubleCsrf } from 'csrf-csrf';\nimport { Request, Response } from 'express';\n\nconst {\n  generateCsrfToken,\n  doubleCsrfProtection,\n} = doubleCsrf({\n  getSecret: () => process.env['CSRF_SECRET'] || process.env['JWT_SECRET'] || '',\n  cookieName: 'x-csrf-token',\n  cookieOptions: {\n    httpOnly: true,\n    sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n    secure: process.env['NODE_ENV'] === 'production',\n    path: '/',\n  },\n  getCsrfTokenFromRequest: (req: Request) => req.headers['x-csrf-token'] as string,\n  getSessionIdentifier: (req: Request) => {\n    // Use session ID if available, otherwise use a combination of user-agent and IP\n    // This is safe because the secret is used for HMAC\n    return req.sessionId || `${req.headers['user-agent']}-${req.ip}`;\n  },\n});\n\n// Export the CSRF functions\nexport { generateCsrfToken, doubleCsrfProtection };\n","import xss, { IFilterXSSOptions, escapeAttrValue } from 'xss';\nimport { Request, Response, NextFunction } from 'express';\n\n/**\n * XSS filter options for strict sanitization (strips all HTML)\n */\nconst strictOptions: IFilterXSSOptions = {\n  whiteList: {}, // No tags allowed\n  stripIgnoreTag: true,\n  stripIgnoreTagBody: ['script', 'style'],\n};\n\n/**\n * XSS filter options for rich content (allows safe HTML for blogs)\n */\nconst richContentOptions: IFilterXSSOptions = {\n  whiteList: {\n    // Text formatting\n    p: ['style', 'class'], br: [], b: [], i: [], u: [], strong: [], em: [], span: ['style', 'class'],\n    // Links\n    a: ['href', 'title', 'target', 'style', 'class'],\n    // Lists\n    ul: ['style', 'class'], ol: ['style', 'class'], li: ['style', 'class'],\n    // Headings\n    h1: ['style', 'class'], h2: ['style', 'class'], h3: ['style', 'class'],\n    h4: ['style', 'class'], h5: ['style', 'class'], h6: ['style', 'class'],\n    // Block elements\n    blockquote: ['style', 'class'], code: ['class'], pre: ['style', 'class'],\n    div: ['style', 'class', 'id'],\n    // Media\n    img: ['src', 'alt', 'title', 'width', 'height', 'style', 'class'],\n    // Layout\n    hr: ['style'],\n    // Tables\n    table: ['style', 'class', 'border', 'cellpadding', 'cellspacing', 'width', 'align'],\n    thead: ['style'], tbody: ['style'], tfoot: ['style'],\n    tr: ['style', 'class'], th: ['style', 'class', 'colspan', 'rowspan', 'align', 'valign'],\n    td: ['style', 'class', 'colspan', 'rowspan', 'align', 'valign', 'width', 'height'],\n    caption: ['style'],\n  },\n  stripIgnoreTag: false,\n  stripIgnoreTagBody: ['script'],\n  onIgnoreTagAttr: function(tag, name, value, isWhiteAttr) {\n    if (name.startsWith('data-')) {\n      return `${name}=\"${escapeAttrValue(value)}\"`;\n    }\n  },\n};\n\n/**\n * Fields that should NOT be sanitized at all (raw HTML preserved)\n * These are admin-only fields for HTML email content\n */\nconst rawHtmlFields = ['content'];\n\n/**\n * Sanitize function - recursively sanitizes strings in objects\n * Skips sanitization entirely for rawHtmlFields (newsletter content)\n */\nconst sanitize = (obj: any, options: IFilterXSSOptions = strictOptions, fieldName?: string): any => {\n  if (typeof obj === 'string') {\n    // Skip sanitization entirely for raw HTML fields (newsletter content)\n    // These are admin-only and need full HTML support (doctype, link, style, etc.)\n    if (fieldName && rawHtmlFields.includes(fieldName)) {\n      return obj; // Return as-is, no sanitization\n    }\n    return xss(obj, options);\n  }\n  if (Array.isArray(obj)) {\n    return obj.map(item => sanitize(item, options, fieldName));\n  }\n  if (obj && typeof obj === 'object') {\n    const sanitized: any = {};\n    for (const key in obj) {\n      sanitized[key] = sanitize(obj[key], options, key);\n    }\n    return sanitized;\n  }\n  return obj;\n};\n\n/**\n * XSS Sanitization Middleware\n * Sanitizes all user input by default (strips all HTML)\n * EXCEPTION: 'content' field is NOT sanitized (for newsletter HTML emails)\n */\nexport const xssSanitize = (req: Request, res: Response, next: NextFunction) => {\n  // Sanitize body\n  if (req.body) {\n    req.body = sanitize(req.body);\n  }\n\n  // Sanitize query params\n  if (req.query) {\n    const sanitizedQuery = sanitize(req.query);\n    for (const key in sanitizedQuery) {\n      req.query[key] = sanitizedQuery[key];\n    }\n  }\n\n  // Sanitize route params\n  if (req.params) {\n    const sanitizedParams = sanitize(req.params);\n    for (const key in sanitizedParams) {\n      req.params[key] = sanitizedParams[key];\n    }\n  }\n\n  next();\n};\n\n/**\n * Sanitize rich content (blogs) - allow safe HTML\n * Use this function explicitly for fields that should allow HTML formatting\n */\nexport const sanitizeRichContent = (html: string): string => {\n  return xss(html, richContentOptions);\n};\n","import { Request, Response, NextFunction } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Request ID Middleware\n *\n * Generates a unique UUID for each request and attaches it to req.id\n * This enables correlation of logs, audit events, and errors across the system\n *\n * Usage:\n * ```ts\n * app.use(requestIdMiddleware);\n * ```\n *\n * The request ID can then be accessed in handlers:\n * ```ts\n * const requestId = req.id;\n * ```\n */\nexport function requestIdMiddleware(req: Request, res: Response, next: NextFunction): void {\n  // Check if request already has an ID (from load balancer/proxy)\n  const existingId = req.get('X-Request-ID');\n\n  // Use existing ID or generate new one\n  const requestId = existingId || uuidv4();\n\n  // Attach to request object\n  (req as any).id = requestId;\n\n  // Also send in response headers for client correlation\n  res.setHeader('X-Request-ID', requestId);\n\n  next();\n}\n","import { Router } from 'express';\n\n// Import route modules\nimport { authRoutes } from './auth.routes';\nimport { sessionsRoutes } from './sessions.routes';\nimport { productsRoutes } from './products.routes';\nimport { categoriesRoutes } from './categories.routes';\nimport { cartRoutes } from './cart.routes';\nimport { ordersRoutes } from './orders.routes';\nimport { customersRoutes } from './customers.routes';\nimport { promoCodesRoutes } from './promoCodes.routes';\nimport { quotationsRoutes } from './quotations.routes';\nimport { quotationTemplatesRoutes } from './quotation-templates.routes';\nimport { blogsRoutes } from './blogs.routes';\nimport { settingsRoutes } from './settings.routes';\nimport { analyticsRoutes } from './analytics.routes';\nimport { exportRoutes } from './export.routes';\nimport { importRoutes } from './import.routes';\nimport { contactRoutes } from './contact.routes';\nimport { uploadRoutes } from './upload.routes';\nimport { healthRoutes } from './health.routes';\nimport notificationsRoutes from './notifications.routes';\nimport { searchRoutes } from './search.routes';\nimport { googleImagesRoutes } from './google-images.routes';\nimport { pdfTemplatesRoutes } from './pdfTemplates.routes';\nimport { cronRoutes } from './cron.routes';\nimport { adminRoutes } from './admin.routes';\nimport { newsletterRoutes } from './newsletter.routes';\n\nexport const router = Router();\n\n// Health check routes (no /api prefix needed, handled at app level too)\nrouter.use('/health', healthRoutes);\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n// Authentication\nrouter.use('/auth', authRoutes);\n\n// Session Management (authenticated only)\nrouter.use('/auth/sessions', sessionsRoutes);\n\n// Products (public read, admin write)\nrouter.use('/products', productsRoutes);\n\n// Search (public search, admin sync)\nrouter.use('/search', searchRoutes);\n\n// Categories (public read, admin write)\nrouter.use('/categories', categoriesRoutes);\n\n// Cart\nrouter.use('/cart', cartRoutes);\n\n// Orders (public create, auth for user orders, admin for all)\nrouter.use('/orders', ordersRoutes);\n\n// Blogs (public read, admin write)\nrouter.use('/blogs', blogsRoutes);\n\n// Settings (public read for public settings, admin for all)\nrouter.use('/settings', settingsRoutes);\n\n// Promo Codes (public validate, admin CRUD)\nrouter.use('/promo-codes', promoCodesRoutes);\n\n// Contact form (public)\nrouter.use('/contact', contactRoutes);\n\n// ===========================================\n// Authenticated Routes\n// ===========================================\n\n// Customers (profile management, admin CRUD)\nrouter.use('/customers', customersRoutes);\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n// Quotations (Admin only)\nrouter.use('/quotations', quotationsRoutes);\n\n// Quotation Templates (Admin only)\nrouter.use('/quotation-templates', quotationTemplatesRoutes);\n\n// Analytics (Admin only)\nrouter.use('/analytics', analyticsRoutes);\n\n// Export (Admin only)\nrouter.use('/export', exportRoutes);\n\n// Import (Admin only)\nrouter.use('/import', importRoutes);\n\n// Upload / Media (Admin only)\nrouter.use('/upload', uploadRoutes);\n\n// Notifications (Admin only)\nrouter.use('/notifications', notificationsRoutes);\n\n// Google Images (Admin only)\nrouter.use('/google-images', googleImagesRoutes);\n\n// PDF Templates (Admin only)\nrouter.use('/pdf-templates', pdfTemplatesRoutes);\n\n// Admin (Admin only)\nrouter.use('/admin', adminRoutes);\n\n// Newsletter (Admin only)\nrouter.use('/newsletter', newsletterRoutes);\n\n// Cron Jobs (Protected by secret)\nrouter.use('/cron', cronRoutes);\n\n// ===========================================\n// API Info\n// ===========================================\n\nrouter.get('/', (_req, res) => {\n  res.json({\n    name: 'Lab404Electronics API',\n    version: '1.0.0',\n    documentation: '/api/docs',\n    endpoints: {\n      // Public\n      auth: '/api/auth',\n      products: '/api/products',\n      search: '/api/search',\n      categories: '/api/categories',\n      cart: '/api/cart',\n      orders: '/api/orders',\n      blogs: '/api/blogs',\n      contact: '/api/contact',\n      health: '/api/health',\n      // Authenticated\n      customers: '/api/customers',\n      // Admin\n      promoCodes: '/api/promo-codes',\n      quotations: '/api/quotations',\n      settings: '/api/settings',\n      analytics: '/api/analytics',\n      export: '/api/export',\n      import: '/api/import',\n      upload: '/api/upload',\n      notifications: '/api/notifications',\n      googleImages: '/api/google-images',\n      newsletter: '/api/newsletter',\n    },\n  });\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport bcrypt from 'bcryptjs';\nimport { getDb, customers, verificationCodes, eq, and, gte, desc } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { authLimiter, verificationLimiter } from '../middleware/rateLimiter';\nimport { requireAuth, generateToken, getTokenExpiration } from '../middleware/auth';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { ConflictError, NotFoundError, UnauthorizedError, BadRequestError } from '../utils/errors';\nimport { verificationCodeService, cartService } from '../services';\nimport { notificationService } from '../services/notification.service';\nimport { sessionService } from '../services/session.service';\nimport { PasswordSecurityService } from '../services/password-security.service';\nimport { LoginAttemptService } from '../services/login-attempt.service';\nimport { auditLogService } from '../services/audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\nimport { xssSanitize } from '../middleware/xss';\nimport { logger } from '../utils/logger';\n\nexport const authRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Common weak passwords to reject\nconst WEAK_PASSWORDS = [\n  '123456', '123456789', 'qwerty', 'password', '12345678',\n  '111111', '1234567890', '1234567', 'password1', '123123',\n  'abc123', 'qwerty123', '1q2w3e4r', 'admin', 'letmein',\n  'welcome', 'monkey', 'dragon', 'master', 'login'\n];\n\n// Sanitize email to prevent SQL injection\nconst sanitizeEmail = (email: string): string => {\n  // Remove any characters that could be used for SQL injection\n  return email.toLowerCase().replace(/['\";\\-\\-\\/\\*\\\\]/g, '').trim();\n};\n\n// Password strength validation\nconst isStrongPassword = (password: string): boolean => {\n  // Check if password is in weak passwords list\n  if (WEAK_PASSWORDS.includes(password.toLowerCase())) {\n    return false;\n  }\n  // Must have at least one uppercase, one lowercase, one number\n  const hasUppercase = /[A-Z]/.test(password);\n  const hasLowercase = /[a-z]/.test(password);\n  const hasNumber = /[0-9]/.test(password);\n  return hasUppercase && hasLowercase && hasNumber;\n};\n\nconst registerSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .max(255)\n    .transform(sanitizeEmail)\n    .refine(\n      (email) => !email.includes('--') && !email.includes('/*') && !email.includes('*/'),\n      { message: 'Invalid email format' }\n    ),\n  password: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(100)\n    .refine(\n      (password) => !WEAK_PASSWORDS.includes(password.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    )\n    .refine(\n      isStrongPassword,\n      { message: 'Password must contain at least one uppercase letter, one lowercase letter, and one number' }\n    ),\n  firstName: z.string().max(100).optional(),\n  lastName: z.string().max(100).optional(),\n  acceptsMarketing: z.boolean().optional().default(false),\n});\n\nconst loginSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  password: z.string().min(1, 'Password is required'),\n});\n\nconst forgotPasswordSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .max(255)\n    .transform(sanitizeEmail),\n});\n\nconst verifyResetCodeSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n});\n\nconst verifyEmailSchema = z.object({\n  email: z.string()\n    .email('Invalid email address')\n    .max(255, 'Email too long')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n});\n\nconst resendVerificationSchema = z.object({\n  email: z.string()\n    .email('Invalid email address')\n    .max(255, 'Email too long')\n    .transform(sanitizeEmail),\n});\n\nconst resetPasswordSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n  newPassword: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(100)\n    .refine(isStrongPassword, {\n      message: 'Password must contain uppercase, lowercase, and number'\n    })\n    .refine(\n      (p) => !WEAK_PASSWORDS.includes(p.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    ),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * POST /api/auth/register\n * Register a new customer account\n */\nauthRoutes.post(\n  '/register',\n  authLimiter,\n  validateBody(registerSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password, firstName, lastName, acceptsMarketing } = req.body;\n      const db = getDb();\n\n      // Check if email already exists\n      const [existing] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()));\n\n      if (existing && !existing.isGuest) {\n        throw new ConflictError('Email already registered');\n      }\n\n      // Hash password\n      const passwordHash = await bcrypt.hash(password, 12);\n\n      // Create customer (or update guest to registered)\n      let customer;\n\n      if (existing && existing.isGuest) {\n        // Convert guest to registered customer\n        const [updated] = await db\n          .update(customers)\n          .set({\n            firstName,\n            lastName,\n            isGuest: false,\n            acceptsMarketing,\n            passwordHash,\n            authUserId: `local_${existing.id}`, // Local auth\n            updatedAt: new Date(),\n          })\n          .where(eq(customers.id, existing.id))\n          .returning();\n        customer = updated;\n      } else {\n        // Create new customer\n        const [created] = await db\n          .insert(customers)\n          .values({\n            email: email.toLowerCase(),\n            firstName,\n            lastName,\n            isGuest: false,\n            acceptsMarketing,\n            passwordHash,\n            authUserId: `local_${Date.now()}`, // Will be updated after insert\n          })\n          .returning();\n        customer = created;\n\n        // Update with proper auth ID\n        if (customer) {\n          await db\n            .update(customers)\n            .set({ authUserId: `local_${customer.id}` })\n            .where(eq(customers.id, customer.id));\n        }\n      }\n\n      if (!customer) {\n        throw new Error('Failed to create or update customer');\n      }\n\n      // Generate verification code\n      const code = await verificationCodeService.createCode({\n        email: customer.email,\n        type: 'email_verification',\n        ipAddress: req.ip,\n        expiryMinutes: 15,\n      });\n\n      // Send verification email (non-blocking)\n      const emailSent = await notificationService.sendEmailVerification({\n        email: customer.email,\n        firstName: customer.firstName,\n        code,\n        expiryMinutes: 15,\n      });\n\n      if (!emailSent) {\n        logger.error('Failed to send verification email', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n      }\n\n      logger.info('Customer registered, verification email sent', {\n        customerId: customer.id,\n        email: customer.email,\n      });\n\n      // Log account creation\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.ACCOUNT_CREATED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'account_registration',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          registrationType: existing && existing.isGuest ? 'guest_conversion' : 'new',\n          emailVerified: false,\n        },\n      });\n\n      // Log email verification sent\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.EMAIL_VERIFICATION_SENT,\n        actorType: ActorType.SYSTEM,\n        targetType: 'customer',\n        targetId: customer.id,\n        action: 'send_verification_email',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          email: customer.email,\n          expiryMinutes: 15,\n        },\n      });\n\n      // NO TOKEN, NO COOKIE - User must verify email first\n      sendSuccess(res, {\n        message: 'Registration successful. Please check your email to verify your account.',\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          emailVerified: false,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n      }, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/login\n * Login with email and password\n */\nauthRoutes.post(\n  '/login',\n  authLimiter,\n  validateBody(loginSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password } = req.body;\n      const normalizedEmail = email.toLowerCase();\n      const db = getDb();\n\n      // Extract device info for logging\n      const deviceInfo = {\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n        userAgent: req.headers['user-agent'],\n      };\n\n      // Check lockout status BEFORE any other checks\n      const lockoutStatus = await LoginAttemptService.checkLockoutStatus(normalizedEmail);\n      if (lockoutStatus.isLocked) {\n        const remainingTime = LoginAttemptService.formatRemainingTime(\n          lockoutStatus.remainingTime || 0\n        );\n\n        logger.warn('Login blocked: Account locked', {\n          email: normalizedEmail,\n          remainingTime,\n        });\n\n        // Log lockout event\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_LOCKED,\n          actorType: ActorType.CUSTOMER,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: {\n            reason: 'account_locked',\n            remainingTime: lockoutStatus.remainingTime,\n            lockoutEndTime: lockoutStatus.lockoutEndTime?.toISOString(),\n          },\n        });\n\n        return sendError(\n          res,\n          403,\n          'ACCOUNT_LOCKED',\n          `Account temporarily locked due to too many failed login attempts. Please try again in ${remainingTime}.`\n        );\n      }\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail));\n\n      if (!customer || customer.isGuest) {\n        // Record failed attempt (no customer ID)\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          null,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'invalid_credentials' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Verify password against stored hash\n      if (!customer.passwordHash) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'no_password_hash' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      const isPasswordValid = await bcrypt.compare(password, customer.passwordHash);\n      if (!isPasswordValid) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'invalid_password' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Check email verification status\n      if (!customer.emailVerified) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'email_unverified',\n          deviceInfo\n        );\n\n        logger.info('Login blocked: Email not verified', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: { reason: 'email_unverified' },\n        });\n\n        return sendError(\n          res,\n          403,\n          'EMAIL_NOT_VERIFIED',\n          'Email not verified. Please check your inbox for the verification code.'\n        );\n      }\n\n      // Check if account is disabled\n      if (!customer.isActive) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'account_disabled',\n          deviceInfo\n        );\n\n        logger.warn('Login blocked: Account disabled', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: { reason: 'account_disabled' },\n        });\n\n        throw new UnauthorizedError('Account is disabled. Please contact support.');\n      }\n\n      // Record successful login attempt\n      await LoginAttemptService.recordAttempt(\n        normalizedEmail,\n        true,\n        customer.id,\n        null,\n        deviceInfo\n      );\n\n      // Clear any failed attempts and unlock account\n      await LoginAttemptService.clearFailedAttempts(normalizedEmail);\n\n      // Merge session cart if exists\n      const guestSessionId = req.sessionId || req.headers['x-session-id'] as string;\n      if (guestSessionId) {\n        const mergedItems = await cartService.mergeSessionCart(guestSessionId, customer.id);\n        logger.info('Session cart merged on login', {\n          customerId: customer.id,\n          guestSessionId,\n          itemsMerged: mergedItems,\n        });\n      }\n\n      // Create session\n      const sessionId = await sessionService.createSession({\n        customerId: customer.id,\n        userAgent: req.headers['user-agent'] || '',\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n      });\n\n      // Generate JWT token with sessionId\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: (customer.role || 'customer') as 'customer' | 'admin',\n        customerId: customer.id,\n        sessionId,\n      });\n\n      // Store token hash in session\n      await sessionService.setTokenHash(sessionId, token);\n\n      // Set httpOnly cookie for secure token storage\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      // Log successful login\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.AUTH_LOGIN_SUCCESS,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'login',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          sessionId,\n          deviceType: deviceInfo.userAgent,\n        },\n      });\n\n      logger.info('Login successful', {\n        email: customer.email,\n        customerId: customer.id,\n        sessionId,\n      });\n\n      sendSuccess(res, {\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: (customer.role || 'customer') as 'customer' | 'admin',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/auth/me\n * Get current authenticated user (customer or admin)\n */\nauthRoutes.get('/me', requireAuth, async (req, res, next) => {\n  try {\n    // Prevent caching of auth responses\n    res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n    res.setHeader('Pragma', 'no-cache');\n    res.setHeader('Expires', '0');\n\n    const db = getDb();\n\n    // Handle admin users\n    if (req.user?.role === 'admin') {\n      sendSuccess(res, {\n        id: req.user.id,\n        email: req.user.email,\n        role: 'admin',\n        isAdmin: true,\n      });\n      return;\n    }\n\n    // Handle customer users\n    if (!req.user?.customerId) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.id, req.user.customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    sendSuccess(res, {\n      id: customer.authUserId,\n      email: customer.email,\n      role: req.user.role,\n      customerId: customer.id,\n      firstName: customer.firstName,\n      lastName: customer.lastName,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/auth/logout\n * Logout current user (clear auth cookie)\n */\nauthRoutes.post('/logout', requireAuth, async (req, res, next) => {\n  try {\n    const sessionId = req.user?.sessionId;\n\n    // Revoke session if present\n    if (sessionId) {\n      await sessionService.revokeSession(sessionId, 'user_action');\n      logger.info('Session revoked on logout', {\n        sessionId,\n        customerId: req.user?.customerId,\n      });\n    }\n\n    // Log logout event\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.AUTH_LOGOUT,\n      actorType: ActorType.CUSTOMER,\n      actorId: req.user?.customerId,\n      actorEmail: req.user?.email,\n      action: 'logout',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        sessionId,\n      },\n    });\n\n    // Clear the auth cookie\n    res.clearCookie('auth_token', {\n      httpOnly: true,\n      secure: process.env['NODE_ENV'] === 'production',\n      sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n      domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n      path: '/',\n    });\n\n    sendSuccess(res, { message: 'Logged out successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/auth/admin/login\n * Admin login endpoint\n */\nauthRoutes.post(\n  '/admin/login',\n  authLimiter,\n  validateBody(loginSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password } = req.body;\n      const db = getDb();\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()));\n\n      if (!customer || customer.isGuest) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Verify password against stored hash\n      if (!customer.passwordHash) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      const isPasswordValid = await bcrypt.compare(password, customer.passwordHash);\n      if (!isPasswordValid) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Check if customer has admin role\n      if (customer.role !== 'admin') {\n        throw new UnauthorizedError('Access denied. Admin privileges required.');\n      }\n\n      // Check if account is active\n      if (!customer.isActive) {\n        throw new UnauthorizedError('Account is disabled. Please contact support.');\n      }\n\n      // Check if email is verified\n      if (!customer.emailVerified) {\n        throw new UnauthorizedError('Email not verified. Please verify your email address.');\n      }\n\n      // Create session for admin\n      const sessionId = await sessionService.createSession({\n        customerId: customer.id,\n        userAgent: req.headers['user-agent'] || '',\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n      });\n\n      // Generate JWT token with admin role and sessionId\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'admin',\n        customerId: customer.id,\n        sessionId,\n      });\n\n      // Store token hash in session\n      await sessionService.setTokenHash(sessionId, token);\n\n      // Set httpOnly cookie for secure token storage\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      sendSuccess(res, {\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: 'admin',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/forgot-password\n * Request password reset code\n * Rate limited: 3 requests per hour per email\n */\nauthRoutes.post(\n  '/forgot-password',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(forgotPasswordSchema),\n  async (req, res, next) => {\n    try {\n      const { email } = req.body;\n      const db = getDb();\n\n      // Look up customer by email (case-insensitive)\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()))\n        .limit(1);\n\n      // Security: Always return success (prevent user enumeration)\n      // Process reset only if customer exists, is active, and not guest\n      if (customer && customer.isActive && !customer.isGuest && customer.passwordHash) {\n        // Create verification code\n        const code = await verificationCodeService.createCode({\n          email: customer.email,\n          type: 'password_reset',\n          ipAddress: req.ip,\n          expiryMinutes: 15,\n        });\n\n        // Send verification code email\n        const emailSent = await notificationService.sendVerificationCode({\n          email: customer.email,\n          code,\n          type: 'password_reset',\n          expiryMinutes: 15,\n        });\n\n        if (!emailSent) {\n          logger.error('Failed to send password reset email', {\n            email: customer.email,\n            code\n          });\n        }\n\n        logger.info('Password reset code sent', {\n          email: customer.email,\n          ip: req.ip\n        });\n\n        // Log password reset requested event\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.PASSWORD_RESET_REQUESTED,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: customer.email,\n          action: 'password_reset_request',\n          status: EventStatus.SUCCESS,\n          metadata: {\n            method: 'email_code',\n            expiryMinutes: 15,\n          },\n        });\n      } else {\n        // Log attempt for security monitoring\n        const reason = !customer ? 'not_found'\n          : !customer.isActive ? 'inactive'\n          : customer.isGuest ? 'guest'\n          : !customer.passwordHash ? 'no_password'\n          : 'unknown';\n\n        logger.warn('Password reset attempt for invalid account', {\n          email,\n          reason,\n          ip: req.ip\n        });\n\n        // Small delay to prevent timing attacks\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n\n      // Always return success message (security: no user enumeration)\n      sendSuccess(res, {\n        message: 'If an account exists with this email, a verification code has been sent.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/verify-reset-code\n * Validate password reset code\n * Purpose: Frontend can validate code before showing password reset form\n * Rate limited: 3 requests per hour per email\n */\nauthRoutes.post(\n  '/verify-reset-code',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(verifyResetCodeSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code } = req.body;\n      const db = getDb();\n      const now = new Date();\n\n      // Find the most recent active code for this email/type\n      const [record] = await db\n        .select()\n        .from(verificationCodes)\n        .where(\n          and(\n            eq(verificationCodes.email, email.toLowerCase()),\n            eq(verificationCodes.type, 'password_reset'),\n            eq(verificationCodes.isUsed, false),\n            gte(verificationCodes.expiresAt, now)\n          )\n        )\n        .orderBy(desc(verificationCodes.createdAt))\n        .limit(1);\n\n      if (!record) {\n        logger.warn('Verification code not found or expired', { email, type: 'password_reset' });\n        throw new BadRequestError('Invalid or expired verification code');\n      }\n\n      // Check if max attempts exceeded\n      if (record.attempts >= record.maxAttempts) {\n        logger.warn('Max verification attempts exceeded', { email, type: 'password_reset', attempts: record.attempts });\n        throw new BadRequestError('Maximum verification attempts exceeded. Please request a new code.');\n      }\n\n      // Increment attempts\n      await db\n        .update(verificationCodes)\n        .set({ attempts: record.attempts + 1 })\n        .where(eq(verificationCodes.id, record.id));\n\n      // Validate code\n      if (record.code !== code) {\n        logger.warn('Invalid verification code attempt', { email, type: 'password_reset', attempts: record.attempts + 1 });\n        throw new BadRequestError('Invalid verification code');\n      }\n\n      // Code is valid - DO NOT mark as used (preserves for actual reset)\n      logger.info('Password reset code verified', {\n        email: email.toLowerCase()\n      });\n\n      sendSuccess(res, {\n        valid: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/reset-password\n * Reset password with valid verification code\n * Auto-logins user with new JWT token\n * Rate limited: 5 requests per 15 minutes (authLimiter)\n */\nauthRoutes.post(\n  '/reset-password',\n  authLimiter,\n  xssSanitize,\n  validateBody(resetPasswordSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code, newPassword } = req.body;\n      const normalizedEmail = email.toLowerCase();\n      const db = getDb();\n\n      // Validate code WITHOUT marking as used yet (throws if invalid/expired/max attempts)\n      // We'll mark it as used after password update succeeds\n      const isValid = await verificationCodeService.validateCodeWithoutMarking({\n        email: normalizedEmail,\n        code,\n        type: 'password_reset',\n      });\n\n      if (!isValid) {\n        throw new BadRequestError('Invalid or expired verification code');\n      }\n\n      // Look up customer\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      if (!customer) {\n        logger.error('Customer not found after valid code validation', {\n          email: normalizedEmail\n        });\n        throw new BadRequestError('Invalid verification code');\n      }\n\n      // Additional security checks\n      if (!customer.isActive) {\n        logger.warn('Password reset attempt for inactive account', {\n          customerId: customer.id\n        });\n        throw new BadRequestError('Account is inactive');\n      }\n\n      if (customer.isGuest) {\n        logger.warn('Password reset attempt for guest account', {\n          customerId: customer.id\n        });\n        throw new BadRequestError('Invalid account type');\n      }\n\n      // Validate new password with security checks\n      const userInputs = [customer.email, customer.firstName, customer.lastName].filter(Boolean) as string[];\n      const validation = await PasswordSecurityService.validatePassword(\n        newPassword,\n        customer.id,\n        userInputs\n      );\n\n      if (!validation.isValid) {\n        logger.warn('Password reset rejected due to security checks', {\n          customerId: customer.id,\n          errors: validation.errors\n        });\n\n        // Build helpful error message that guides user to try again\n        const errorMessage = validation.errors.join('. ') + ' You can try again with a different password using the same verification code.';\n        throw new BadRequestError(errorMessage);\n      }\n\n      // Hash new password\n      const passwordHash = await bcrypt.hash(newPassword, 12);\n\n      // Update password\n      await db\n        .update(customers)\n        .set({\n          passwordHash,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customer.id));\n\n      // Record password change in history\n      await PasswordSecurityService.recordPasswordChange({\n        customerId: customer.id,\n        passwordHash,\n        changeReason: 'password_reset',\n        ipAddress: req.ip || req.socket.remoteAddress,\n        userAgent: req.headers['user-agent'],\n      });\n\n      // Mark verification code as used (only after password update succeeded)\n      await verificationCodeService.markCodeAsUsed(normalizedEmail, 'password_reset');\n\n      // Log password reset completed event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.PASSWORD_RESET_COMPLETED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'password_reset_complete',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          method: 'email_code',\n          strengthScore: validation.strengthResult?.score,\n        },\n      });\n\n      // Invalidate all password_reset codes for this email\n      await verificationCodeService.invalidateCodes(\n        normalizedEmail,\n        'password_reset'\n      );\n\n      // Send password changed confirmation email (non-blocking)\n      const emailSent = await notificationService.sendPasswordChangedConfirmation({\n        email: customer.email,\n        firstName: customer.firstName,\n        timestamp: new Date(),\n        ipAddress: req.ip,\n      });\n\n      if (!emailSent) {\n        logger.error('Failed to send password changed email', {\n          email: customer.email,\n          customerId: customer.id\n        });\n        // Continue - don't fail the password reset if email fails\n      }\n\n      // Generate new JWT token (auto-login)\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'customer',\n        customerId: customer.id,\n      });\n\n      // Set auth cookie\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      logger.info('Password reset successful', {\n        customerId: customer.id,\n        email: customer.email\n      });\n\n      // Return user object and token (same as login)\n      sendSuccess(res, {\n        message: 'Password reset successfully',\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: 'customer',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/verify-email\n * Verify email address with code and auto-login\n *\n * Request body:\n * {\n *   email: string,\n *   code: string\n * }\n *\n * Response:\n * {\n *   user: { id, email, emailVerified, firstName, lastName },\n *   token: string,\n *   expiresAt: string\n * }\n *\n * Rate limit: 3 requests per hour (via verificationLimiter)\n * Security: Auto-login after successful verification\n */\nauthRoutes.post(\n  '/verify-email',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(verifyEmailSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code } = req.body;\n      const normalizedEmail = email.toLowerCase().trim();\n      const db = getDb();\n\n      // Validate verification code\n      const isValid = await verificationCodeService.validateCode({\n        email: normalizedEmail,\n        code,\n        type: 'email_verification',\n      });\n\n      if (!isValid) {\n        return sendError(res, 400, 'INVALID_CODE', 'Invalid or expired verification code.');\n      }\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      if (!customer || customer.isGuest) {\n        return sendError(res, 400, 'INVALID_CODE', 'Invalid verification code.');\n      }\n\n      // Check if already verified\n      if (customer.emailVerified) {\n        return sendError(res, 400, 'ALREADY_VERIFIED', 'Email already verified.');\n      }\n\n      // Update customer: mark email as verified\n      await db\n        .update(customers)\n        .set({\n          emailVerified: true,\n          emailVerifiedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customer.id));\n\n      // Invalidate all email_verification codes for this email\n      await verificationCodeService.invalidateCodes(\n        normalizedEmail,\n        'email_verification'\n      );\n\n      logger.info('Email verified successfully', {\n        email: customer.email,\n        customerId: customer.id,\n      });\n\n      // Log account verified event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.ACCOUNT_VERIFIED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'email_verification',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          verificationMethod: 'email_code',\n          verifiedAt: new Date().toISOString(),\n        },\n      });\n\n      // Generate JWT token (auto-login after verification)\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'customer',\n        customerId: customer.id,\n      });\n\n      // Set httpOnly cookie\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      const user = {\n        id: customer.authUserId,\n        email: customer.email,\n        emailVerified: true,\n        firstName: customer.firstName,\n        lastName: customer.lastName,\n        phone: customer.phone,\n        role: 'customer',\n        customerId: customer.id,\n      };\n\n      sendSuccess(res, {\n        message: 'Email verified successfully',\n        user,\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/resend-verification\n * Resend email verification code\n *\n * Request body:\n * {\n *   email: string\n * }\n *\n * Response:\n * {\n *   message: string (generic success message)\n * }\n *\n * Rate limit: 3 requests per hour (via verificationLimiter)\n * Security: No user enumeration, always returns success\n */\nauthRoutes.post(\n  '/resend-verification',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(resendVerificationSchema),\n  async (req, res, next) => {\n    try {\n      const { email } = req.body;\n      const normalizedEmail = email.toLowerCase().trim();\n      const db = getDb();\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      // Only send if account exists, is not guest, and is not verified\n      if (customer && !customer.isGuest && !customer.emailVerified) {\n        // Invalidate previous codes\n        await verificationCodeService.invalidateCodes(\n          normalizedEmail,\n          'email_verification'\n        );\n\n        // Generate new verification code\n        const code = await verificationCodeService.createCode({\n          email: customer.email,\n          type: 'email_verification',\n          ipAddress: req.ip,\n          expiryMinutes: 15,\n        });\n\n        // Send verification email\n        const emailSent = await notificationService.sendEmailVerification({\n          email: customer.email,\n          firstName: customer.firstName,\n          code,\n          expiryMinutes: 15,\n        });\n\n        if (!emailSent) {\n          logger.error('Failed to send verification email', {\n            email: customer.email,\n            customerId: customer.id,\n          });\n        } else {\n          logger.info('Verification email resent', {\n            email: customer.email,\n            customerId: customer.id,\n          });\n        }\n      }\n\n      // Always return success (no user enumeration)\n      sendSuccess(res, {\n        message: 'If an unverified account exists, a verification code has been sent.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/password/check\n * Check password strength and breach status\n *\n * Request body:\n * {\n *   password: string,\n *   email?: string,        // Optional: for personalized feedback\n *   customerId?: string    // Optional: for history checking\n * }\n *\n * Response:\n * {\n *   score: number,         // 0-4 (zxcvbn)\n *   feedback: {\n *     warning: string,\n *     suggestions: string[]\n *   },\n *   crackTime: string,\n *   isBreached: boolean,\n *   breachCount: number,\n *   isReused: boolean\n * }\n *\n * Rate limit: 10 requests per 15 minutes\n */\nconst passwordCheckSchema = z.object({\n  password: z.string().min(1),\n  email: z.string().email().optional(),\n  customerId: z.string().uuid().optional(),\n});\n\nauthRoutes.post(\n  '/password/check',\n  authLimiter,\n  validateBody(passwordCheckSchema),\n  async (req, res, next) => {\n    try {\n      const { password, email, customerId } = req.body;\n\n      // Build user inputs for personalized feedback\n      const userInputs: string[] = [];\n      if (email) {\n        userInputs.push(email);\n        const emailParts = email.split('@');\n        userInputs.push(emailParts[0]); // Add username part\n      }\n\n      // If customerId provided, check history and breach\n      let result;\n      if (customerId) {\n        const validation = await PasswordSecurityService.validatePassword(\n          password,\n          customerId,\n          userInputs\n        );\n        result = validation.strengthResult;\n      } else {\n        // New user - just check strength and breach\n        const validation = await PasswordSecurityService.validateNewPassword(\n          password,\n          userInputs\n        );\n        result = validation.strengthResult;\n      }\n\n      sendSuccess(res, result);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import slugify from 'slugify';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Generate a URL-friendly slug from a string\n */\nexport function generateSlug(text: string): string {\n  return slugify(text, {\n    lower: true,\n    strict: true,\n    trim: true,\n  });\n}\n\n/**\n * Generate a unique slug by appending a random suffix\n */\nexport function generateUniqueSlug(text: string): string {\n  const baseSlug = generateSlug(text);\n  const suffix = uuidv4().slice(0, 8);\n  return `${baseSlug}-${suffix}`;\n}\n\n/**\n * Generate an order number\n * Format: LAB-YYYY-NNNN\n */\nexport function generateOrderNumber(sequence: number): string {\n  const year = new Date().getFullYear();\n  const paddedSequence = String(sequence).padStart(4, '0');\n  return `LAB-${year}-${paddedSequence}`;\n}\n\n/**\n * Generate a quotation number\n * Format: QUO-YYYY-NNNN\n */\nexport function generateQuotationNumber(sequence: number): string {\n  const year = new Date().getFullYear();\n  const paddedSequence = String(sequence).padStart(4, '0');\n  return `QUO-${year}-${paddedSequence}`;\n}\n\n/**\n * Generate a random SKU\n * Format: LAB-XXXXXX\n */\nexport function generateSku(): string {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let sku = 'LAB-';\n  for (let i = 0; i < 6; i++) {\n    sku += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return sku;\n}\n\n/**\n * Round a number to specified decimal places\n */\nexport function round(value: number, decimals = 2): number {\n  const factor = Math.pow(10, decimals);\n  return Math.round(value * factor) / factor;\n}\n\n/**\n * Format a price with currency symbol\n */\nexport function formatPrice(amount: number, currency = 'USD'): string {\n  return new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency,\n  }).format(amount);\n}\n\n/**\n * Mask email address for privacy\n * example@domain.com -> e***e@domain.com\n */\nexport function maskEmail(email: string): string {\n  const [name, domain] = email.split('@');\n  if (!name || !domain) {return email;}\n\n  if (name.length <= 2) {\n    return `${name[0]}***@${domain}`;\n  }\n\n  return `${name[0]}***${name[name.length - 1]}@${domain}`;\n}\n\n/**\n * Mask phone number for privacy\n * +1234567890 -> +123****890\n */\nexport function maskPhone(phone: string): string {\n  if (phone.length < 7) {return phone;}\n\n  const start = phone.slice(0, 3);\n  const end = phone.slice(-3);\n  return `${start}****${end}`;\n}\n\n/**\n * Check if a string is a valid UUID\n */\nexport function isValidUuid(str: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(str);\n}\n\n/**\n * Omit specified keys from an object\n */\nexport function omit<T extends object, K extends keyof T>(\n  obj: T,\n  keys: K[]\n): Omit<T, K> {\n  const result = { ...obj };\n  for (const key of keys) {\n    delete result[key];\n  }\n  return result;\n}\n\n/**\n * Pick specified keys from an object\n */\nexport function pick<T extends object, K extends keyof T>(\n  obj: T,\n  keys: K[]\n): Pick<T, K> {\n  const result = {} as Pick<T, K>;\n  for (const key of keys) {\n    if (key in obj) {\n      result[key] = obj[key];\n    }\n  }\n  return result;\n}\n","import { getDb, products, productVariants, promoCodes, settings, eq, inArray } from '@lab404/database';\nimport type { CartCalculation, DiscountType } from '@lab404/shared-types';\nimport { round } from '../utils/helpers';\nimport { BadRequestError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n/**\n * Cart item input for calculation\n */\ninterface CartItemInput {\n  id?: string;        // Cart item database ID (for frontend operations)\n  productId: string;\n  variantId?: string;\n  quantity: number;\n}\n\n/**\n * Promo code validation result\n */\ninterface PromoCodeResult {\n  id: string;\n  code: string;\n  discountType: DiscountType;\n  discountValue: number;\n  minimumOrderAmount?: number;\n  maximumDiscountAmount?: number;\n  appliesToProducts: string[] | null;\n  appliesToCategories: string[] | null;\n}\n\n/**\n * Internal cart item with category info for promo calculation\n */\ninterface CartItemWithCategory {\n  productId: string;\n  categoryId: string | null;\n  lineTotal: number;\n}\n\n/**\n * CRITICAL: Pricing Service\n *\n * This service handles ALL price calculations.\n * NEVER calculate prices on the client side.\n * NEVER trust price values from client requests.\n *\n * All calculations are done using:\n * 1. Current product prices from database\n * 2. Tax rate from settings\n * 3. Validated promo codes\n */\nexport class PricingService {\n  private db = getDb();\n\n  /**\n   * Calculate cart totals\n   * This is the main method for cart calculation\n   *\n   * @param items - Cart items with product/variant IDs and quantities\n   * @param promoCode - Optional promo code to apply\n   * @returns Complete cart calculation with all totals\n   */\n  async calculateCart(\n    items: CartItemInput[],\n    promoCode?: string\n  ): Promise<CartCalculation> {\n    if (items.length === 0) {\n      return this.emptyCartCalculation();\n    }\n\n    // 1. Fetch current product prices from database\n    const productIds = items.map((item) => item.productId);\n    const productData = await this.db\n      .select()\n      .from(products)\n      .where(inArray(products.id, productIds));\n\n    // 2. Fetch variant prices if any variants are specified\n    const variantIds = items\n      .filter((item) => item.variantId)\n      .map((item) => item.variantId as string);\n\n    let variantData: Array<typeof productVariants.$inferSelect> = [];\n    if (variantIds.length > 0) {\n      variantData = await this.db\n        .select()\n        .from(productVariants)\n        .where(inArray(productVariants.id, variantIds));\n    }\n\n    // 3. Build cart items with current prices\n    const calculatedItems = items.map((item) => {\n      const product = productData.find((p) => p.id === item.productId);\n\n      if (!product) {\n        throw new BadRequestError(`Product not found: ${item.productId}`);\n      }\n\n      if (product.status !== 'active') {\n        throw new BadRequestError(`Product is not available: ${product.name}`);\n      }\n\n      let unitPrice = Number(product.basePrice);\n      let variant;\n\n      // If variant is specified, use variant price\n      if (item.variantId) {\n        variant = variantData.find((v) => v.id === item.variantId);\n\n        if (!variant) {\n          throw new BadRequestError(`Variant not found: ${item.variantId}`);\n        }\n\n        if (!variant.isActive) {\n          throw new BadRequestError(`Variant is not available: ${variant.name}`);\n        }\n\n        unitPrice = Number(variant.basePrice);\n      }\n\n      // Check stock\n      const stockQuantity = variant?.stockQuantity ?? product.stockQuantity;\n      const inStock = stockQuantity > 0 || product.allowBackorder;\n\n      if (!inStock) {\n        throw new BadRequestError(`Product is out of stock: ${product.name}`);\n      }\n\n      if (item.quantity > stockQuantity && !product.allowBackorder) {\n        throw new BadRequestError(\n          `Not enough stock for ${product.name}. Available: ${stockQuantity}`\n        );\n      }\n\n      const lineTotal = round(unitPrice * item.quantity, 2);\n\n      return {\n        id: item.id || item.variantId || item.productId,\n        productId: item.productId,\n        variantId: item.variantId,\n        product: {\n          id: product.id,\n          name: product.name,\n          slug: product.slug,\n          sku: product.sku,\n          thumbnailUrl: this.getProductImage(product),\n          basePrice: unitPrice,\n          stockQuantity,\n          inStock,\n        },\n        variant: variant\n          ? {\n              id: variant.id,\n              name: variant.name,\n              sku: variant.sku,\n              options: variant.options as Record<string, string>,\n              basePrice: Number(variant.basePrice),\n            }\n          : undefined,\n        quantity: item.quantity,\n        unitPrice,\n        lineTotal,\n      };\n    });\n\n    // 4. Calculate subtotal from database prices\n    const subtotal = round(\n      calculatedItems.reduce((sum, item) => sum + item.lineTotal, 0),\n      2\n    );\n\n    // 5. Build category mapping for promo code restrictions\n    const itemsWithCategory: CartItemWithCategory[] = calculatedItems.map((item) => {\n      const product = productData.find((p) => p.id === item.productId);\n      return {\n        productId: item.productId,\n        categoryId: product?.categoryId || null,\n        lineTotal: item.lineTotal,\n      };\n    });\n\n    // 6. Validate and calculate promo code discount\n    let discountAmount = 0;\n    let eligibleItemIds: string[] = [];\n    let promoCodeResult: PromoCodeResult | undefined;\n\n    if (promoCode) {\n      promoCodeResult = await this.validatePromoCode(promoCode, subtotal);\n\n      if (promoCodeResult) {\n        const discountResult = this.calculateDiscount(promoCodeResult, itemsWithCategory);\n        discountAmount = discountResult.discountAmount;\n        eligibleItemIds = discountResult.eligibleItemIds;\n      }\n    }\n\n    // 7. Get tax rate from settings\n    const taxRate = await this.getTaxRate();\n\n    // 8. Calculate tax (IMPORTANT: tax applies to discounted amount, not original subtotal)\n    // This is standard practice: customers pay tax on what they actually pay\n    // Formula: taxAmount = (subtotal - discount) * taxRate\n    const taxableAmount = subtotal - discountAmount;\n    const taxAmount = round(taxableAmount * taxRate, 2);\n\n    // 9. Calculate shipping (can be extended later)\n    const shippingAmount = 0; // Free shipping for now\n\n    // 10. Calculate final total\n    // Formula: total = (subtotal - discount) + tax + shipping\n    // Simplified: total = taxableAmount + taxAmount + shippingAmount\n    const total = round(taxableAmount + taxAmount + shippingAmount, 2);\n\n    // 11. Calculate item count\n    const itemCount = calculatedItems.reduce((sum, item) => sum + item.quantity, 0);\n\n    return {\n      items: calculatedItems,\n      itemCount,\n      subtotal,\n      taxRate,\n      taxAmount,\n      shippingAmount,\n      discountAmount,\n      promoCode: promoCodeResult?.code,\n      promoCodeId: promoCodeResult?.id,\n      eligibleItemIds: eligibleItemIds.length > 0 ? eligibleItemIds : undefined,\n      total,\n      currency: 'USD',\n    };\n  }\n\n  /**\n   * Calculate order totals for checkout\n   * Similar to calculateCart but creates snapshots for order creation\n   */\n  async calculateOrderTotals(\n    items: CartItemInput[],\n    promoCode?: string\n  ): Promise<{\n    subtotal: number;\n    taxRate: number;\n    taxAmount: number;\n    shippingAmount: number;\n    discountAmount: number;\n    total: number;\n    promoCodeId?: string;\n    promoCodeSnapshot?: string;\n  }> {\n    const cartCalc = await this.calculateCart(items, promoCode);\n\n    return {\n      subtotal: cartCalc.subtotal,\n      taxRate: cartCalc.taxRate,\n      taxAmount: cartCalc.taxAmount,\n      shippingAmount: cartCalc.shippingAmount,\n      discountAmount: cartCalc.discountAmount,\n      total: cartCalc.total,\n      promoCodeId: cartCalc.promoCodeId,\n      promoCodeSnapshot: cartCalc.promoCode,\n    };\n  }\n\n  /**\n   * Validate a promo code\n   */\n  async validatePromoCode(\n    code: string,\n    subtotal: number\n  ): Promise<PromoCodeResult | undefined> {\n    const [promoCodeData] = await this.db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.code, code.toUpperCase()));\n\n    if (!promoCodeData) {\n      return undefined;\n    }\n\n    // Check if active\n    if (!promoCodeData.isActive) {\n      return undefined;\n    }\n\n    // Check dates\n    const now = new Date();\n\n    if (promoCodeData.startsAt && new Date(promoCodeData.startsAt) > now) {\n      return undefined;\n    }\n\n    if (promoCodeData.expiresAt && new Date(promoCodeData.expiresAt) < now) {\n      return undefined;\n    }\n\n    // Check usage limit\n    if (\n      promoCodeData.usageLimit !== null &&\n      promoCodeData.usageCount >= promoCodeData.usageLimit\n    ) {\n      return undefined;\n    }\n\n    // Check minimum order amount\n    if (\n      promoCodeData.minimumOrderAmount !== null &&\n      subtotal < Number(promoCodeData.minimumOrderAmount)\n    ) {\n      return undefined;\n    }\n\n    return {\n      id: promoCodeData.id,\n      code: promoCodeData.code,\n      discountType: promoCodeData.discountType,\n      discountValue: Number(promoCodeData.discountValue),\n      minimumOrderAmount: promoCodeData.minimumOrderAmount\n        ? Number(promoCodeData.minimumOrderAmount)\n        : undefined,\n      maximumDiscountAmount: promoCodeData.maximumDiscountAmount\n        ? Number(promoCodeData.maximumDiscountAmount)\n        : undefined,\n      appliesToProducts: promoCodeData.appliesToProducts || null,\n      appliesToCategories: promoCodeData.appliesToCategories || null,\n    };\n  }\n\n  /**\n   * Check if an item is eligible for a promo code based on product/category restrictions\n   */\n  private isItemEligibleForPromo(\n    productId: string,\n    categoryId: string | null,\n    promoCode: PromoCodeResult\n  ): boolean {\n    const hasProductRestrictions = promoCode.appliesToProducts && promoCode.appliesToProducts.length > 0;\n    const hasCategoryRestrictions = promoCode.appliesToCategories && promoCode.appliesToCategories.length > 0;\n\n    // If no restrictions, all products are eligible\n    if (!hasProductRestrictions && !hasCategoryRestrictions) {\n      return true;\n    }\n\n    // Check product whitelist\n    if (hasProductRestrictions && promoCode.appliesToProducts!.includes(productId)) {\n      return true;\n    }\n\n    // Check category whitelist\n    if (hasCategoryRestrictions && categoryId && promoCode.appliesToCategories!.includes(categoryId)) {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Calculate discount amount from promo code\n   * Only applies to eligible items based on product/category restrictions\n   */\n  private calculateDiscount(\n    promoCode: PromoCodeResult,\n    items: CartItemWithCategory[]\n  ): { discountAmount: number; eligibleItemIds: string[] } {\n    // Filter items to only those eligible for this promo code\n    const eligibleItems = items.filter((item) =>\n      this.isItemEligibleForPromo(item.productId, item.categoryId, promoCode)\n    );\n\n    // No eligible items = no discount\n    if (eligibleItems.length === 0) {\n      return { discountAmount: 0, eligibleItemIds: [] };\n    }\n\n    // Calculate eligible subtotal (only eligible items)\n    const eligibleSubtotal = round(\n      eligibleItems.reduce((sum, item) => sum + item.lineTotal, 0),\n      2\n    );\n\n    let discount = 0;\n\n    if (promoCode.discountType === 'percentage') {\n      discount = eligibleSubtotal * (promoCode.discountValue / 100);\n    } else {\n      // Fixed amount - cap at eligible subtotal\n      discount = Math.min(promoCode.discountValue, eligibleSubtotal);\n    }\n\n    // Apply maximum discount cap\n    if (promoCode.maximumDiscountAmount) {\n      discount = Math.min(discount, promoCode.maximumDiscountAmount);\n    }\n\n    // Discount cannot exceed eligible subtotal\n    discount = Math.min(discount, eligibleSubtotal);\n\n    return {\n      discountAmount: round(discount, 2),\n      eligibleItemIds: eligibleItems.map((item) => item.productId),\n    };\n  }\n\n  /**\n   * Get current tax rate from settings\n   *\n   * Tax settings are stored in the database with key 'tax':\n   * {\n   *   tax_enabled: boolean,\n   *   tax_rate: number,     // Percentage (0-100)\n   *   tax_label: string     // Display label (e.g., \"VAT\", \"Sales Tax\")\n   * }\n   *\n   * Configure tax via:\n   * - Admin Dashboard  Settings  Tax\n   * - API: PUT /api/settings with tax object\n   *\n   * Fallback behavior: If no tax setting exists in database, returns 0 (no tax applied).\n   * This is a safe default that prevents unexpected charges. Admins must explicitly\n   * enable and configure tax rates.\n   */\n  private async getTaxRate(): Promise<number> {\n    const [taxSetting] = await this.db\n      .select()\n      .from(settings)\n      .where(eq(settings.key, 'tax'));\n\n    if (taxSetting && taxSetting.value && typeof taxSetting.value === 'object') {\n      const taxValue = taxSetting.value as { tax_rate?: number; tax_enabled?: boolean };\n\n      // Only apply tax if tax_enabled is true\n      if (taxValue.tax_enabled && typeof taxValue.tax_rate === 'number') {\n        // Tax rate is stored as percentage (0-100), convert to decimal (0-1)\n        return taxValue.tax_rate / 100;\n      }\n\n      // If tax is disabled, return 0\n      if (taxValue.tax_enabled === false) {\n        return 0;\n      }\n    }\n\n    // No tax setting found in database - return 0 (no tax)\n    // Admins must configure tax via settings API or admin dashboard\n    logger.warn('Tax setting not found in database, applying 0% tax rate');\n    return 0;\n  }\n\n  /**\n   * Return empty cart calculation\n   */\n  private emptyCartCalculation(): CartCalculation {\n    return {\n      items: [],\n      itemCount: 0,\n      subtotal: 0,\n      taxRate: 0, // Tax rate will be applied when items are added\n      taxAmount: 0,\n      shippingAmount: 0,\n      discountAmount: 0,\n      total: 0,\n      currency: 'USD',\n    };\n  }\n\n  /**\n   * Get product image with fallback priority:\n   * 1. thumbnailUrl\n   * 2. First image from images array\n   * 3. undefined (no image)\n   */\n  private getProductImage(product: typeof products.$inferSelect): string | undefined {\n    if (product.thumbnailUrl) {\n      return product.thumbnailUrl;\n    }\n\n    if (product.images && Array.isArray(product.images) && product.images.length > 0) {\n      const firstImage = product.images[0];\n      if (firstImage && typeof firstImage === 'object' && 'url' in firstImage) {\n        return firstImage.url;\n      }\n    }\n\n    return undefined;\n  }\n}\n\n// Export singleton instance\nexport const pricingService = new PricingService();\n","/**\n * PDF Service\n * Handles PDF generation for quotations and invoices\n * Uses PDFKit for server-side PDF generation\n */\n\nimport PDFDocument from 'pdfkit';\n\ninterface QuotationItem {\n  productName: string;\n  sku?: string;\n  description?: string;\n  quantity: number;\n  unitPrice: number;\n  lineTotal: number;\n  variantOptions?: Record<string, string>;\n  imageUrl?: string;\n  productUrl?: string; // URL to product page on website\n}\n\ninterface QuotationData {\n  quotationNumber: string;\n  createdAt: Date;\n  validUntil?: Date;\n  status: string;\n\n  // Customer info\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string;\n  customerCompany?: string;\n  customerAddress?: Record<string, string>;\n\n  // Items\n  items: QuotationItem[];\n\n  // Totals (CALCULATED SERVER-SIDE)\n  subtotal: number;\n  taxRate: number;\n  taxAmount: number;\n  shippingAmount: number;\n  discountAmount: number;\n  total: number;\n  currency: string;\n\n  // Notes\n  notes?: string;\n  terms?: string;\n\n  // Company info\n  companyName: string;\n  companyAddress: string;\n  companyPhone: string;\n  companyEmail: string;\n  companyWebsite?: string;\n  companyLogo?: string;\n}\n\ninterface InvoiceData extends QuotationData {\n  invoiceNumber: string;\n  orderNumber: string;\n  paymentStatus: string;\n  paymentMethod: string;\n  paidAt?: Date;\n}\n\ninterface PdfTemplateConfig {\n  primaryColor?: string;\n  accentColor?: string;\n  logoUrl?: string;\n  showCompanyLogo?: boolean;\n  showLineItemImages?: boolean;\n  showLineItemDescription?: boolean;\n  showSku?: boolean;\n  headerText?: string;\n  footerText?: string;\n  thankYouMessage?: string;\n}\n\nexport class PDFService {\n  // Default colors (can be overridden by template)\n  private primaryColor = '#1a1a2e';\n  private accentColor = '#0066cc';\n  private readonly textColor = '#333333';\n  private readonly lightGray = '#f5f5f5';\n\n  // Template config (set per generation)\n  private template: PdfTemplateConfig = {};\n\n  /**\n   * Parse HTML content to plain text for PDF rendering\n   * Converts HTML tags to readable plain text format\n   */\n  private parseHtmlToText(html: string): string {\n    if (!html) {return '';}\n\n    let text = html;\n\n    // Replace <br> and <br/> with newlines\n    text = text.replace(/<br\\s*\\/?>/gi, '\\n');\n\n    // Replace </p> with double newline (paragraph break)\n    text = text.replace(/<\\/p>/gi, '\\n\\n');\n\n    // Replace <p> tags (opening) with nothing\n    text = text.replace(/<p[^>]*>/gi, '');\n\n    // Handle strong/bold - keep the text\n    text = text.replace(/<\\/?strong>/gi, '');\n    text = text.replace(/<\\/?b>/gi, '');\n\n    // Handle emphasis/italic\n    text = text.replace(/<\\/?em>/gi, '');\n    text = text.replace(/<\\/?i>/gi, '');\n\n    // Handle underline\n    text = text.replace(/<\\/?u>/gi, '');\n\n    // Handle lists - convert to bullet points\n    text = text.replace(/<li[^>]*>/gi, ' ');\n    text = text.replace(/<\\/li>/gi, '\\n');\n    text = text.replace(/<\\/?[ou]l[^>]*>/gi, '\\n');\n\n    // Handle headings - add newlines\n    text = text.replace(/<h[1-6][^>]*>/gi, '\\n');\n    text = text.replace(/<\\/h[1-6]>/gi, '\\n');\n\n    // Handle div and span\n    text = text.replace(/<\\/?div[^>]*>/gi, '\\n');\n    text = text.replace(/<\\/?span[^>]*>/gi, '');\n\n    // Remove any remaining HTML tags\n    text = text.replace(/<[^>]+>/g, '');\n\n    // Decode common HTML entities\n    text = text.replace(/&nbsp;/gi, ' ');\n    text = text.replace(/&amp;/gi, '&');\n    text = text.replace(/&lt;/gi, '<');\n    text = text.replace(/&gt;/gi, '>');\n    text = text.replace(/&quot;/gi, '\"');\n    text = text.replace(/&#39;/gi, \"'\");\n    text = text.replace(/&apos;/gi, \"'\");\n\n    // Clean up multiple newlines (max 2)\n    text = text.replace(/\\n{3,}/g, '\\n\\n');\n\n    // Trim whitespace from each line and remove leading/trailing whitespace\n    text = text.split('\\n').map(line => line.trim()).join('\\n').trim();\n\n    return text;\n  }\n\n  /**\n   * Apply template configuration\n   */\n  private applyTemplate(template?: PdfTemplateConfig): void {\n    this.template = template || {};\n    if (template?.primaryColor) {\n      this.primaryColor = template.primaryColor;\n    } else {\n      this.primaryColor = '#1a1a2e';\n    }\n    if (template?.accentColor) {\n      this.accentColor = template.accentColor;\n    } else {\n      this.accentColor = '#0066cc';\n    }\n  }\n\n  /**\n   * Generate a quotation PDF\n   */\n  async generateQuotationPDF(data: QuotationData, template?: PdfTemplateConfig): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      try {\n        this.applyTemplate(template);\n\n        const doc = new PDFDocument({\n          size: 'A4',\n          margin: 50,\n          bufferPages: true,\n        });\n\n        const chunks: Buffer[] = [];\n\n        doc.on('data', (chunk) => chunks.push(chunk));\n        doc.on('end', () => resolve(Buffer.concat(chunks)));\n        doc.on('error', reject);\n\n        // Custom header text if provided\n        if (this.template.headerText) {\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(this.template.headerText, 50, 30, { align: 'center', width: 495 });\n          doc.y = 50;\n        }\n\n        // Header\n        this.addHeader(doc, data, 'QUOTATION');\n\n        // Customer info\n        this.addCustomerInfo(doc, data);\n\n        // Items table\n        this.addItemsTable(doc, data.items);\n\n        // Totals\n        this.addTotals(doc, data);\n\n        // Thank you message if provided\n        if (this.template.thankYouMessage) {\n          doc.moveDown();\n          doc.fontSize(11).fillColor(this.accentColor);\n          doc.text(this.template.thankYouMessage, 50, doc.y, { align: 'center', width: 495 });\n        }\n\n        // Notes and terms\n        this.addNotesAndTerms(doc, data);\n\n        // Footer\n        this.addFooter(doc, data);\n\n        doc.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /**\n   * Generate an invoice PDF\n   */\n  async generateInvoicePDF(data: InvoiceData, template?: PdfTemplateConfig): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      try {\n        this.applyTemplate(template);\n\n        const doc = new PDFDocument({\n          size: 'A4',\n          margin: 50,\n          bufferPages: true,\n        });\n\n        const chunks: Buffer[] = [];\n\n        doc.on('data', (chunk) => chunks.push(chunk));\n        doc.on('end', () => resolve(Buffer.concat(chunks)));\n        doc.on('error', reject);\n\n        // Custom header text if provided\n        if (this.template.headerText) {\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(this.template.headerText, 50, 30, { align: 'center', width: 495 });\n          doc.y = 50;\n        }\n\n        // Header\n        this.addHeader(doc, data, 'INVOICE');\n\n        // Invoice-specific info\n        doc.fontSize(10).fillColor(this.textColor);\n        doc.text(`Invoice #: ${data.invoiceNumber}`, 50, doc.y);\n        doc.text(`Order #: ${data.orderNumber}`);\n        doc.text(`Payment Status: ${data.paymentStatus.toUpperCase()}`);\n        if (data.paidAt) {\n          doc.text(`Paid On: ${data.paidAt.toLocaleDateString()}`);\n        }\n        doc.moveDown();\n\n        // Customer info\n        this.addCustomerInfo(doc, data);\n\n        // Items table\n        this.addItemsTable(doc, data.items);\n\n        // Totals\n        this.addTotals(doc, data);\n\n        // Payment info\n        if (data.paymentMethod) {\n          doc.moveDown();\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(`Payment Method: ${data.paymentMethod.toUpperCase()}`);\n        }\n\n        // Thank you message if provided\n        if (this.template.thankYouMessage) {\n          doc.moveDown();\n          doc.fontSize(11).fillColor(this.accentColor);\n          doc.text(this.template.thankYouMessage, 50, doc.y, { align: 'center', width: 495 });\n        }\n\n        // Footer\n        this.addFooter(doc, data);\n\n        doc.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  private addHeader(doc: PDFKit.PDFDocument, data: QuotationData, title: string): void {\n    // Company name/logo\n    doc.fontSize(24).fillColor(this.primaryColor);\n    doc.text(data.companyName, 50, 50);\n\n    // Title\n    doc.fontSize(20).fillColor(this.accentColor);\n    doc.text(title, 400, 50, { align: 'right' });\n\n    // Document info\n    doc.fontSize(10).fillColor(this.textColor);\n    doc.text(`#: ${data.quotationNumber}`, 400, 80, { align: 'right' });\n    doc.text(`Date: ${data.createdAt.toLocaleDateString()}`, { align: 'right' });\n    if (data.validUntil) {\n      doc.text(`Valid Until: ${data.validUntil.toLocaleDateString()}`, { align: 'right' });\n    }\n\n    // Company details (address, phone, email)\n    doc.fontSize(9).fillColor('#666666');\n    if (data.companyAddress) {\n      doc.text(data.companyAddress, 50, 80);\n    }\n    if (data.companyPhone) {\n      doc.text(`Phone: ${data.companyPhone}`);\n    }\n    if (data.companyEmail) {\n      doc.text(`Email: ${data.companyEmail}`);\n    }\n    if (data.companyWebsite) {\n      doc.text(`Web: ${data.companyWebsite}`);\n    }\n\n    // Divider\n    doc.moveTo(50, 150).lineTo(545, 150).stroke(this.lightGray);\n    doc.y = 160;\n  }\n\n  private addCustomerInfo(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    doc.fontSize(12).fillColor(this.primaryColor);\n    doc.text('Bill To:', 50, doc.y);\n\n    doc.fontSize(10).fillColor(this.textColor);\n    doc.text(data.customerName);\n    if (data.customerCompany) {\n      doc.text(data.customerCompany);\n    }\n    doc.text(data.customerEmail);\n    if (data.customerPhone) {\n      doc.text(data.customerPhone);\n    }\n\n    doc.moveDown(2);\n  }\n\n  private addItemsTable(doc: PDFKit.PDFDocument, items: QuotationItem[]): void {\n    const tableTop = doc.y;\n    const tableLeft = 50;\n    const showSku = this.template.showSku !== false; // Default true\n    const showDescription = this.template.showLineItemDescription === true;\n\n    // Table header - adjust columns based on showSku\n    doc.rect(tableLeft, tableTop, 495, 25).fill(this.primaryColor);\n    doc.fontSize(10).fillColor('#ffffff');\n\n    if (showSku) {\n      doc.text('Product', tableLeft + 10, tableTop + 8);\n      doc.text('SKU', tableLeft + 210, tableTop + 8);\n      doc.text('Qty', tableLeft + 290, tableTop + 8);\n      doc.text('Price', tableLeft + 350, tableTop + 8);\n      doc.text('Total', tableLeft + 420, tableTop + 8);\n    } else {\n      doc.text('Product', tableLeft + 10, tableTop + 8);\n      doc.text('Qty', tableLeft + 290, tableTop + 8);\n      doc.text('Price', tableLeft + 350, tableTop + 8);\n      doc.text('Total', tableLeft + 420, tableTop + 8);\n    }\n\n    // Table rows\n    let y = tableTop + 30;\n    doc.fillColor(this.textColor);\n\n    items.forEach((item, index) => {\n      const rowHeight = showDescription && item.description ? 40 : 25;\n\n      // Alternate row background\n      if (index % 2 === 0) {\n        doc.rect(tableLeft, y - 5, 495, rowHeight).fill(this.lightGray);\n        doc.fillColor(this.textColor);\n      }\n\n      doc.fontSize(9);\n\n      // Product name with variant options\n      let productName = item.productName;\n      if (item.variantOptions) {\n        const options = Object.entries(item.variantOptions)\n          .map(([k, v]) => `${k}: ${v}`)\n          .join(', ');\n        productName += ` (${options})`;\n      }\n\n      // Truncate long names based on whether SKU is shown\n      const maxNameLength = showSku ? 40 : 60;\n      if (productName.length > maxNameLength) {\n        productName = productName.substring(0, maxNameLength - 3) + '...';\n      }\n\n      // Product name - make it a clickable link if URL is provided\n      if (item.productUrl) {\n        doc.fillColor(this.accentColor);\n        doc.text(productName, tableLeft + 10, y, {\n          width: showSku ? 190 : 270,\n          link: item.productUrl,\n          underline: true,\n        });\n        doc.fillColor(this.textColor);\n      } else {\n        doc.text(productName, tableLeft + 10, y, { width: showSku ? 190 : 270 });\n      }\n\n      if (showSku) {\n        doc.text(item.sku || '-', tableLeft + 210, y, { width: 70 });\n      }\n\n      doc.text(item.quantity.toString(), tableLeft + 290, y, { width: 50 });\n      doc.text(`$${item.unitPrice.toFixed(2)}`, tableLeft + 350, y, { width: 60 });\n      doc.text(`$${item.lineTotal.toFixed(2)}`, tableLeft + 420, y, { width: 70 });\n\n      // Show description if enabled\n      if (showDescription && item.description) {\n        doc.fontSize(8).fillColor('#666666');\n        const desc = item.description.length > 80\n          ? item.description.substring(0, 77) + '...'\n          : item.description;\n        doc.text(desc, tableLeft + 10, y + 12, { width: 270 });\n        doc.fillColor(this.textColor);\n      }\n\n      y += rowHeight;\n\n      // New page if needed\n      if (y > 700) {\n        doc.addPage();\n        y = 50;\n      }\n    });\n\n    // Table border\n    doc.rect(tableLeft, tableTop, 495, y - tableTop).stroke('#cccccc');\n\n    doc.y = y + 10;\n  }\n\n  private addTotals(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    const totalsX = 350;\n    let y = doc.y + 10;\n\n    doc.fontSize(10).fillColor(this.textColor);\n\n    // Subtotal\n    doc.text('Subtotal:', totalsX, y);\n    doc.text(`$${data.subtotal.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n    y += 20;\n\n    // Discount (if any)\n    if (data.discountAmount > 0) {\n      doc.text('Discount:', totalsX, y);\n      doc.fillColor('#cc0000');\n      doc.text(`-$${data.discountAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n      doc.fillColor(this.textColor);\n      y += 20;\n    }\n\n    // Tax\n    doc.text(`Tax (${(data.taxRate * 100).toFixed(0)}%):`, totalsX, y);\n    doc.text(`$${data.taxAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n    y += 20;\n\n    // Shipping\n    if (data.shippingAmount > 0) {\n      doc.text('Shipping:', totalsX, y);\n      doc.text(`$${data.shippingAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n      y += 20;\n    }\n\n    // Divider\n    doc.moveTo(totalsX, y).lineTo(545, y).stroke('#cccccc');\n    y += 10;\n\n    // Total\n    doc.fontSize(14).fillColor(this.primaryColor);\n    doc.text('Total:', totalsX, y);\n    doc.text(`${data.currency} $${data.total.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n\n    doc.y = y + 30;\n  }\n\n  private addNotesAndTerms(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    if (data.notes || data.terms) {\n      doc.moveDown();\n\n      if (data.notes) {\n        doc.fontSize(11).fillColor(this.primaryColor);\n        doc.text('Notes:', 50, doc.y);\n        doc.fontSize(9).fillColor(this.textColor);\n        doc.text(data.notes, { width: 495 });\n        doc.moveDown();\n      }\n\n      if (data.terms) {\n        doc.fontSize(11).fillColor(this.primaryColor);\n        doc.text('Terms & Conditions:', 50, doc.y);\n        doc.fontSize(9).fillColor(this.textColor);\n        // Parse HTML to plain text for PDF rendering\n        const parsedTerms = this.parseHtmlToText(data.terms);\n        doc.text(parsedTerms, { width: 495 });\n      }\n    }\n  }\n\n  private addFooter(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    const pageCount = doc.bufferedPageRange().count;\n\n    for (let i = 0; i < pageCount; i++) {\n      doc.switchToPage(i);\n\n      // Footer line\n      doc.moveTo(50, 780).lineTo(545, 780).stroke(this.lightGray);\n\n      // Footer text - use template footer or default\n      const footerText = this.template.footerText\n        || `Generated by ${data.companyName} | Page ${i + 1} of ${pageCount}`;\n\n      doc.fontSize(8).fillColor('#666666');\n      doc.text(\n        footerText,\n        50,\n        785,\n        { align: 'center', width: 495 }\n      );\n    }\n  }\n\n  /**\n   * Generate PDF stream for direct response\n   */\n  generatePDFStream(data: QuotationData, type: 'quotation' | 'invoice' = 'quotation'): PDFKit.PDFDocument {\n    const doc = new PDFDocument({\n      size: 'A4',\n      margin: 50,\n      bufferPages: true,\n    });\n\n    // Add content based on type\n    if (type === 'quotation') {\n      this.addHeader(doc, data, 'QUOTATION');\n    } else {\n      this.addHeader(doc, data, 'INVOICE');\n    }\n\n    this.addCustomerInfo(doc, data);\n    this.addItemsTable(doc, data.items);\n    this.addTotals(doc, data);\n    this.addNotesAndTerms(doc, data);\n    this.addFooter(doc, data);\n\n    doc.end();\n\n    return doc;\n  }\n}\n\nexport const pdfService = new PDFService();\n","/**\n * Export Service\n * Handles data export in various formats (CSV, JSON, XLSX)\n */\n\ninterface ExportColumn<T> {\n  key: keyof T | string;\n  header: string;\n  formatter?: (value: unknown, row: T) => string;\n}\n\nexport class ExportService {\n  /**\n   * Export data to CSV format\n   */\n  toCSV<T extends Record<string, unknown>>(\n    data: T[],\n    columns: ExportColumn<T>[]\n  ): string {\n    if (data.length === 0) {\n      return columns.map(c => c.header).join(',');\n    }\n\n    // Header row\n    const headers = columns.map(c => this.escapeCSV(c.header));\n\n    // Data rows\n    const rows = data.map(row => {\n      return columns.map(col => {\n        const value = this.getNestedValue(row, col.key as string);\n        const formatted = col.formatter ? col.formatter(value, row) : value;\n        return this.escapeCSV(String(formatted ?? ''));\n      });\n    });\n\n    return [headers.join(','), ...rows.map(r => r.join(','))].join('\\n');\n  }\n\n  /**\n   * Export data to JSON format\n   */\n  toJSON<T>(data: T[], pretty = true): string {\n    return pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);\n  }\n\n  /**\n   * Export data to JSONL format (JSON Lines - one object per line)\n   */\n  toJSONL<T>(data: T[]): string {\n    return data.map(row => JSON.stringify(row)).join('\\n');\n  }\n\n  /**\n   * Get export content type and file extension\n   */\n  getContentType(format: 'csv' | 'json' | 'jsonl' | 'xlsx'): {\n    contentType: string;\n    extension: string;\n  } {\n    switch (format) {\n      case 'csv':\n        return { contentType: 'text/csv', extension: 'csv' };\n      case 'json':\n        return { contentType: 'application/json', extension: 'json' };\n      case 'jsonl':\n        return { contentType: 'application/x-ndjson', extension: 'jsonl' };\n      case 'xlsx':\n        return { contentType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', extension: 'xlsx' };\n      default:\n        return { contentType: 'application/octet-stream', extension: 'bin' };\n    }\n  }\n\n  /**\n   * Get export filename\n   */\n  getFilename(prefix: string, format: string): string {\n    const date = new Date().toISOString().split('T')[0];\n    return `${prefix}-export-${date}.${format}`;\n  }\n\n  // ===========================================\n  // Predefined Export Configurations\n  // ===========================================\n\n  /**\n   * Product export columns - ALL fields\n   */\n  getProductColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'sku', header: 'SKU' },\n      { key: 'barcode', header: 'Barcode' },\n      { key: 'name', header: 'Name' },\n      { key: 'slug', header: 'Slug' },\n      { key: 'description', header: 'Description' },\n      { key: 'shortDescription', header: 'Short Description' },\n      { key: 'categoryId', header: 'Category ID' },\n      { key: 'categoryName', header: 'Category' },\n      { key: 'brand', header: 'Brand' },\n      { key: 'basePrice', header: 'Base Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'costPrice', header: 'Cost Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'compareAtPrice', header: 'Compare At Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'weight', header: 'Weight (g)', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'dimensions', header: 'Dimensions', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'stockQuantity', header: 'Stock Quantity' },\n      { key: 'lowStockThreshold', header: 'Low Stock Threshold' },\n      { key: 'trackInventory', header: 'Track Inventory', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'allowBackorder', header: 'Allow Backorder', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'images', header: 'Images', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'videos', header: 'Videos', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'thumbnailUrl', header: 'Thumbnail URL' },\n      { key: 'tags', header: 'Tags', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'specifications', header: 'Specifications', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'features', header: 'Features', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'metaTitle', header: 'Meta Title' },\n      { key: 'metaDescription', header: 'Meta Description' },\n      { key: 'status', header: 'Status' },\n      { key: 'isFeatured', header: 'Featured', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'isDigital', header: 'Digital Product', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'requiresShipping', header: 'Requires Shipping', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'supplierId', header: 'Supplier ID' },\n      { key: 'supplierSku', header: 'Supplier SKU' },\n      { key: 'importedFrom', header: 'Imported From' },\n      { key: 'externalUrl', header: 'External URL' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Order export columns - ALL fields\n   */\n  getOrderColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'orderNumber', header: 'Order Number' },\n      { key: 'customerId', header: 'Customer ID' },\n      { key: 'customerEmail', header: 'Customer Email' },\n      { key: 'customerName', header: 'Customer Name' },\n      { key: 'status', header: 'Status' },\n      { key: 'paymentStatus', header: 'Payment Status' },\n      { key: 'paymentMethod', header: 'Payment Method' },\n      { key: 'shippingAddress', header: 'Shipping Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'billingAddress', header: 'Billing Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'currency', header: 'Currency' },\n      { key: 'subtotalSnapshot', header: 'Subtotal', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'taxRateSnapshot', header: 'Tax Rate', formatter: (v) => v ? (Number(v) * 100).toFixed(2) + '%' : '' },\n      { key: 'taxAmountSnapshot', header: 'Tax Amount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'shippingAmountSnapshot', header: 'Shipping', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'discountAmountSnapshot', header: 'Discount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'totalSnapshot', header: 'Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'promoCodeId', header: 'Promo Code ID' },\n      { key: 'promoCodeSnapshot', header: 'Promo Code Used' },\n      { key: 'shippingMethod', header: 'Shipping Method' },\n      { key: 'trackingNumber', header: 'Tracking Number' },\n      { key: 'confirmedAt', header: 'Confirmed At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'processingAt', header: 'Processing At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'shippedAt', header: 'Shipped At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'deliveredAt', header: 'Delivered At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'customerNotes', header: 'Customer Notes' },\n      { key: 'adminNotes', header: 'Admin Notes' },\n      { key: 'createdAt', header: 'Order Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Customer export columns - ALL fields\n   */\n  getCustomerColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'authUserId', header: 'Auth User ID' },\n      { key: 'email', header: 'Email' },\n      { key: 'firstName', header: 'First Name' },\n      { key: 'lastName', header: 'Last Name' },\n      { key: 'phone', header: 'Phone' },\n      { key: 'defaultShippingAddress', header: 'Default Shipping Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'defaultBillingAddress', header: 'Default Billing Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'isGuest', header: 'Guest', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'isActive', header: 'Active', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'acceptsMarketing', header: 'Accepts Marketing', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'notes', header: 'Notes' },\n      { key: 'tags', header: 'Tags', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'orderCount', header: 'Order Count' },\n      { key: 'createdAt', header: 'Registered At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Promo code export columns - ALL fields\n   */\n  getPromoCodeColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'code', header: 'Code' },\n      { key: 'description', header: 'Description' },\n      { key: 'discountType', header: 'Discount Type' },\n      { key: 'discountValue', header: 'Discount Value', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'minimumOrderAmount', header: 'Min Order Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'maximumDiscountAmount', header: 'Max Discount Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'usageLimit', header: 'Usage Limit' },\n      { key: 'usageCount', header: 'Times Used' },\n      { key: 'usageLimitPerCustomer', header: 'Usage Limit Per Customer' },\n      { key: 'isActive', header: 'Active', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'startsAt', header: 'Start Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'expiresAt', header: 'Expiry Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'appliesToProducts', header: 'Applies To Products', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'appliesToCategories', header: 'Applies To Categories', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'customerIds', header: 'Restricted Customer IDs', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Quotation export columns - ALL fields\n   */\n  getQuotationColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'quotationNumber', header: 'Quotation Number' },\n      { key: 'customerId', header: 'Customer ID' },\n      { key: 'customerName', header: 'Customer Name' },\n      { key: 'customerEmail', header: 'Customer Email' },\n      { key: 'customerPhone', header: 'Customer Phone' },\n      { key: 'customerCompany', header: 'Customer Company' },\n      { key: 'customerAddress', header: 'Customer Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'status', header: 'Status' },\n      { key: 'validUntil', header: 'Valid Until', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'validDays', header: 'Valid Days' },\n      { key: 'currency', header: 'Currency' },\n      { key: 'subtotal', header: 'Subtotal', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'taxRate', header: 'Tax Rate', formatter: (v) => v ? (Number(v) * 100).toFixed(2) + '%' : '' },\n      { key: 'taxAmount', header: 'Tax Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'discountType', header: 'Discount Type' },\n      { key: 'discountValue', header: 'Discount Value', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'discountAmount', header: 'Discount Amount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'total', header: 'Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'notes', header: 'Notes' },\n      { key: 'termsAndConditions', header: 'Terms & Conditions' },\n      { key: 'pdfUrl', header: 'PDF URL' },\n      { key: 'pdfTemplateId', header: 'PDF Template ID' },\n      { key: 'convertedToOrderId', header: 'Converted To Order ID' },\n      { key: 'acceptanceToken', header: 'Acceptance Token' },\n      { key: 'tokenExpiresAt', header: 'Token Expires At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'viewedAt', header: 'Viewed At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Order Items export columns\n   */\n  getOrderItemColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'orderId', header: 'Order ID' },\n      { key: 'orderNumber', header: 'Order Number' },\n      { key: 'productId', header: 'Product ID' },\n      { key: 'variantId', header: 'Variant ID' },\n      { key: 'productNameSnapshot', header: 'Product Name' },\n      { key: 'skuSnapshot', header: 'SKU' },\n      { key: 'variantOptionsSnapshot', header: 'Variant Options', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'quantity', header: 'Quantity' },\n      { key: 'unitPriceSnapshot', header: 'Unit Price', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'lineTotal', header: 'Line Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Quotation Items export columns\n   */\n  getQuotationItemColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'quotationId', header: 'Quotation ID' },\n      { key: 'quotationNumber', header: 'Quotation Number' },\n      { key: 'productId', header: 'Product ID' },\n      { key: 'variantId', header: 'Variant ID' },\n      { key: 'name', header: 'Item Name' },\n      { key: 'description', header: 'Description' },\n      { key: 'sku', header: 'SKU' },\n      { key: 'quantity', header: 'Quantity' },\n      { key: 'unitPrice', header: 'Unit Price', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'lineTotal', header: 'Line Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  // ===========================================\n  // Helper Methods\n  // ===========================================\n\n  private escapeCSV(value: string): string {\n    // If value contains comma, quote, or newline, wrap in quotes and escape quotes\n    if (value.includes(',') || value.includes('\"') || value.includes('\\n')) {\n      return `\"${value.replace(/\"/g, '\"\"')}\"`;\n    }\n    return value;\n  }\n\n  private getNestedValue(obj: Record<string, unknown>, path: string): unknown {\n    return path.split('.').reduce<unknown>((o, p) => (o as Record<string, unknown>)?.[p], obj);\n  }\n}\n\nexport const exportService = new ExportService();\n","/**\n * Import Service\n * Handles data import from CSV files and external sources\n */\n\nimport { z } from 'zod';\n\nexport interface ImportResult<T> {\n  success: boolean;\n  totalRows: number;\n  successCount: number;\n  errorCount: number;\n  errors: Array<{\n    row: number;\n    field?: string;\n    message: string;\n  }>;\n  data: T[];\n}\n\ninterface ColumnMapping {\n  csvColumn: string;\n  field: string;\n  required?: boolean;\n  transform?: (value: string) => unknown;\n}\n\nexport class ImportService {\n  /**\n   * Parse CSV string into array of objects\n   */\n  parseCSV(csvContent: string): Record<string, string>[] {\n    const lines = csvContent.trim().split('\\n');\n    if (lines.length < 2) {\n      return [];\n    }\n\n    const headerLine = lines[0];\n    if (!headerLine) {\n      return [];\n    }\n\n    const headers = this.parseCSVLine(headerLine);\n    const data: Record<string, string>[] = [];\n\n    for (let i = 1; i < lines.length; i++) {\n      const line = lines[i];\n      if (!line) {continue;}\n\n      const values = this.parseCSVLine(line);\n      const row: Record<string, string> = {};\n\n      headers.forEach((header, index) => {\n        row[header.trim()] = values[index]?.trim() || '';\n      });\n\n      data.push(row);\n    }\n\n    return data;\n  }\n\n  /**\n   * Parse a single CSV line handling quoted values\n   */\n  private parseCSVLine(line: string): string[] {\n    const result: string[] = [];\n    let current = '';\n    let inQuotes = false;\n\n    for (let i = 0; i < line.length; i++) {\n      const char = line[i];\n\n      if (char === '\"') {\n        if (inQuotes && line[i + 1] === '\"') {\n          // Escaped quote\n          current += '\"';\n          i++;\n        } else {\n          inQuotes = !inQuotes;\n        }\n      } else if (char === ',' && !inQuotes) {\n        result.push(current);\n        current = '';\n      } else {\n        current += char;\n      }\n    }\n\n    result.push(current);\n    return result;\n  }\n\n  /**\n   * Map CSV data to objects with validation\n   */\n  mapAndValidate<T>(\n    data: Record<string, string>[],\n    mappings: ColumnMapping[],\n    schema: z.ZodSchema<T>\n  ): ImportResult<T> {\n    const result: ImportResult<T> = {\n      success: true,\n      totalRows: data.length,\n      successCount: 0,\n      errorCount: 0,\n      errors: [],\n      data: [],\n    };\n\n    for (let i = 0; i < data.length; i++) {\n      const row = data[i];\n      if (!row) {continue;}\n\n      const rowNumber = i + 2; // Account for header row and 0-indexing\n\n      try {\n        // Map columns\n        const mapped: Record<string, unknown> = {};\n\n        for (const mapping of mappings) {\n          const value = row[mapping.csvColumn];\n\n          if (mapping.required && (!value || value.trim() === '')) {\n            throw new Error(`Missing required field: ${mapping.csvColumn}`);\n          }\n\n          if (value && value.trim() !== '') {\n            mapped[mapping.field] = mapping.transform\n              ? mapping.transform(value)\n              : value;\n          }\n        }\n\n        // Validate with schema\n        const validated = schema.parse(mapped);\n        result.data.push(validated);\n        result.successCount++;\n      } catch (error) {\n        result.errorCount++;\n        result.success = false;\n\n        if (error instanceof z.ZodError) {\n          error.errors.forEach(e => {\n            result.errors.push({\n              row: rowNumber,\n              field: e.path.join('.'),\n              message: e.message,\n            });\n          });\n        } else if (error instanceof Error) {\n          result.errors.push({\n            row: rowNumber,\n            message: error.message,\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  // ===========================================\n  // Predefined Import Configurations\n  // ===========================================\n\n  /**\n   * Product import mapping - ALL fields\n   */\n  getProductMappings(): ColumnMapping[] {\n    return [\n      // Required fields\n      { csvColumn: 'name', field: 'name', required: true },\n      { csvColumn: 'sku', field: 'sku', required: true },\n      {\n        csvColumn: 'price',\n        field: 'basePrice',\n        required: true,\n        transform: (v) => parseFloat(v.replace(/[^0-9.]/g, '')),\n      },\n      // Basic info\n      { csvColumn: 'barcode', field: 'barcode' },\n      { csvColumn: 'description', field: 'description' },\n      { csvColumn: 'short_description', field: 'shortDescription' },\n      { csvColumn: 'category', field: 'categoryName' },\n      { csvColumn: 'brand', field: 'brand' },\n      // Pricing\n      {\n        csvColumn: 'cost_price',\n        field: 'costPrice',\n        transform: (v) => v ? parseFloat(v.replace(/[^0-9.]/g, '')) : undefined,\n      },\n      {\n        csvColumn: 'compare_at_price',\n        field: 'compareAtPrice',\n        transform: (v) => v ? parseFloat(v.replace(/[^0-9.]/g, '')) : undefined,\n      },\n      // Inventory\n      {\n        csvColumn: 'quantity',\n        field: 'stockQuantity',\n        transform: (v) => parseInt(v) || 0,\n      },\n      {\n        csvColumn: 'low_stock_threshold',\n        field: 'lowStockThreshold',\n        transform: (v) => parseInt(v) || 5,\n      },\n      {\n        csvColumn: 'track_inventory',\n        field: 'trackInventory',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'allow_backorder',\n        field: 'allowBackorder',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // Shipping\n      {\n        csvColumn: 'weight',\n        field: 'weight',\n        transform: (v) => v ? parseFloat(v) : undefined,\n      },\n      {\n        csvColumn: 'dimensions',\n        field: 'dimensions',\n        transform: (v) => {\n          if (!v) {return undefined;}\n          try {\n            // Support JSON format: {\"width\": 10, \"height\": 20, \"depth\": 5}\n            if (v.startsWith('{')) {return JSON.parse(v);}\n            // Support simple format: 10x20x5\n            const parts = v.split('x').map(p => parseFloat(p.trim()));\n            if (parts.length === 3) {\n              return { width: parts[0], height: parts[1], depth: parts[2] };\n            }\n            return undefined;\n          } catch {\n            return undefined;\n          }\n        },\n      },\n      {\n        csvColumn: 'is_digital',\n        field: 'isDigital',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'requires_shipping',\n        field: 'requiresShipping',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      // Media\n      { csvColumn: 'image_url', field: 'thumbnailUrl' },\n      {\n        csvColumn: 'images',\n        field: 'images',\n        transform: (v) => {\n          if (!v) {return [];}\n          try {\n            if (v.startsWith('[')) {return JSON.parse(v);}\n            // Support comma-separated URLs\n            return v.split(',').map(url => ({ url: url.trim() })).filter(img => img.url);\n          } catch {\n            return [];\n          }\n        },\n      },\n      // Status\n      {\n        csvColumn: 'status',\n        field: 'status',\n        transform: (v) => {\n          const normalized = v.toLowerCase().trim();\n          if (['active', 'draft', 'archived'].includes(normalized)) {\n            return normalized;\n          }\n          return 'draft';\n        },\n      },\n      {\n        csvColumn: 'featured',\n        field: 'isFeatured',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // SEO\n      { csvColumn: 'meta_title', field: 'metaTitle' },\n      { csvColumn: 'meta_description', field: 'metaDescription' },\n      // Tags and features\n      {\n        csvColumn: 'tags',\n        field: 'tags',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      {\n        csvColumn: 'features',\n        field: 'features',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      {\n        csvColumn: 'specifications',\n        field: 'specifications',\n        transform: (v) => {\n          if (!v) {return {};}\n          try {\n            if (v.startsWith('{')) {return JSON.parse(v);}\n            // Support simple format: key1:value1,key2:value2\n            const specs: Record<string, string> = {};\n            v.split(',').forEach(pair => {\n              const [key, value] = pair.split(':').map(s => s.trim());\n              if (key && value) {specs[key] = value;}\n            });\n            return specs;\n          } catch {\n            return {};\n          }\n        },\n      },\n      // Supplier\n      { csvColumn: 'supplier_id', field: 'supplierId' },\n      { csvColumn: 'supplier_sku', field: 'supplierSku' },\n    ];\n  }\n\n  /**\n   * Product import schema - ALL fields\n   */\n  getProductSchema() {\n    return z.object({\n      // Required\n      name: z.string().min(1).max(255),\n      sku: z.string().min(1).max(100),\n      basePrice: z.number().positive(),\n      // Basic\n      barcode: z.string().max(100).optional(),\n      description: z.string().optional(),\n      shortDescription: z.string().max(500).optional(),\n      categoryName: z.string().optional(),\n      brand: z.string().max(255).optional(),\n      // Pricing\n      costPrice: z.number().positive().optional(),\n      compareAtPrice: z.number().positive().optional(),\n      // Inventory\n      stockQuantity: z.number().int().min(0).optional().default(0),\n      lowStockThreshold: z.number().int().min(0).optional().default(5),\n      trackInventory: z.boolean().optional().default(true),\n      allowBackorder: z.boolean().optional().default(false),\n      // Shipping\n      weight: z.number().optional(),\n      dimensions: z.object({\n        width: z.number().optional(),\n        height: z.number().optional(),\n        depth: z.number().optional(),\n      }).optional(),\n      isDigital: z.boolean().optional().default(false),\n      requiresShipping: z.boolean().optional().default(true),\n      // Media\n      thumbnailUrl: z.string().url().optional(),\n      images: z.array(z.object({\n        url: z.string().url(),\n        alt: z.string().optional(),\n      })).optional(),\n      // Status\n      status: z.enum(['active', 'draft', 'archived']).optional().default('draft'),\n      isFeatured: z.boolean().optional().default(false),\n      // SEO\n      metaTitle: z.string().max(255).optional(),\n      metaDescription: z.string().max(500).optional(),\n      // Tags and features\n      tags: z.array(z.string()).optional(),\n      features: z.array(z.string()).optional(),\n      specifications: z.record(z.string()).optional(),\n      // Supplier\n      supplierId: z.string().optional(),\n      supplierSku: z.string().optional(),\n    });\n  }\n\n  /**\n   * Customer import mapping - ALL fields including addresses\n   */\n  getCustomerMappings(): ColumnMapping[] {\n    return [\n      // Required\n      { csvColumn: 'email', field: 'email', required: true },\n      // Basic info\n      { csvColumn: 'first_name', field: 'firstName' },\n      { csvColumn: 'last_name', field: 'lastName' },\n      { csvColumn: 'phone', field: 'phone' },\n      // Status\n      {\n        csvColumn: 'is_active',\n        field: 'isActive',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'accepts_marketing',\n        field: 'acceptsMarketing',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // Notes and tags\n      { csvColumn: 'notes', field: 'notes' },\n      {\n        csvColumn: 'tags',\n        field: 'tags',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      // Shipping address fields\n      { csvColumn: 'shipping_first_name', field: 'shippingFirstName' },\n      { csvColumn: 'shipping_last_name', field: 'shippingLastName' },\n      { csvColumn: 'shipping_company', field: 'shippingCompany' },\n      { csvColumn: 'shipping_address_line1', field: 'shippingAddressLine1' },\n      { csvColumn: 'shipping_address_line2', field: 'shippingAddressLine2' },\n      { csvColumn: 'shipping_city', field: 'shippingCity' },\n      { csvColumn: 'shipping_state', field: 'shippingState' },\n      { csvColumn: 'shipping_postal_code', field: 'shippingPostalCode' },\n      { csvColumn: 'shipping_country', field: 'shippingCountry' },\n      { csvColumn: 'shipping_phone', field: 'shippingPhone' },\n      // Billing address fields\n      { csvColumn: 'billing_first_name', field: 'billingFirstName' },\n      { csvColumn: 'billing_last_name', field: 'billingLastName' },\n      { csvColumn: 'billing_company', field: 'billingCompany' },\n      { csvColumn: 'billing_address_line1', field: 'billingAddressLine1' },\n      { csvColumn: 'billing_address_line2', field: 'billingAddressLine2' },\n      { csvColumn: 'billing_city', field: 'billingCity' },\n      { csvColumn: 'billing_state', field: 'billingState' },\n      { csvColumn: 'billing_postal_code', field: 'billingPostalCode' },\n      { csvColumn: 'billing_country', field: 'billingCountry' },\n      { csvColumn: 'billing_phone', field: 'billingPhone' },\n    ];\n  }\n\n  /**\n   * Customer import schema - ALL fields\n   */\n  getCustomerSchema() {\n    return z.object({\n      // Required\n      email: z.string().email(),\n      // Basic\n      firstName: z.string().max(100).optional(),\n      lastName: z.string().max(100).optional(),\n      phone: z.string().max(50).optional(),\n      // Status\n      isActive: z.boolean().optional().default(true),\n      acceptsMarketing: z.boolean().optional().default(false),\n      // Notes and tags\n      notes: z.string().optional(),\n      tags: z.array(z.string()).optional(),\n      // Shipping address fields (will be combined into JSON)\n      shippingFirstName: z.string().optional(),\n      shippingLastName: z.string().optional(),\n      shippingCompany: z.string().optional(),\n      shippingAddressLine1: z.string().optional(),\n      shippingAddressLine2: z.string().optional(),\n      shippingCity: z.string().optional(),\n      shippingState: z.string().optional(),\n      shippingPostalCode: z.string().optional(),\n      shippingCountry: z.string().optional(),\n      shippingPhone: z.string().optional(),\n      // Billing address fields (will be combined into JSON)\n      billingFirstName: z.string().optional(),\n      billingLastName: z.string().optional(),\n      billingCompany: z.string().optional(),\n      billingAddressLine1: z.string().optional(),\n      billingAddressLine2: z.string().optional(),\n      billingCity: z.string().optional(),\n      billingState: z.string().optional(),\n      billingPostalCode: z.string().optional(),\n      billingCountry: z.string().optional(),\n      billingPhone: z.string().optional(),\n    });\n  }\n\n  /**\n   * Generate CSV template for products - ALL fields\n   */\n  getProductTemplate(): string {\n    const headers = [\n      'name',\n      'sku',\n      'price',\n      'barcode',\n      'description',\n      'short_description',\n      'category',\n      'brand',\n      'cost_price',\n      'compare_at_price',\n      'quantity',\n      'low_stock_threshold',\n      'track_inventory',\n      'allow_backorder',\n      'weight',\n      'dimensions',\n      'is_digital',\n      'requires_shipping',\n      'image_url',\n      'images',\n      'status',\n      'featured',\n      'meta_title',\n      'meta_description',\n      'tags',\n      'features',\n      'specifications',\n      'supplier_id',\n      'supplier_sku',\n    ];\n\n    const exampleRow = [\n      'Arduino Uno R3',\n      'ARD-UNO-R3',\n      '29.99',\n      '123456789',\n      'The Arduino Uno R3 is a microcontroller board based on the ATmega328P.',\n      'Popular microcontroller board for beginners',\n      'Microcontrollers',\n      'Arduino',\n      '15.00',\n      '39.99',\n      '100',\n      '10',\n      'Yes',\n      'No',\n      '25',\n      '10x5x2',\n      'No',\n      'Yes',\n      'https://example.com/arduino.jpg',\n      '',\n      'active',\n      'Yes',\n      'Arduino Uno R3 - Buy Online',\n      'Shop the Arduino Uno R3 microcontroller board',\n      'arduino,microcontroller,electronics',\n      'Easy to program,USB powered,14 digital pins',\n      'Processor:ATmega328P,Voltage:5V,Clock:16MHz',\n      'SUP001',\n      'ARD-001',\n    ];\n\n    return `${headers.join(',')}\\n\"${exampleRow.join('\",\"')}\"`;\n  }\n\n  /**\n   * Generate CSV template for customers - ALL fields\n   */\n  getCustomerTemplate(): string {\n    const headers = [\n      'email',\n      'first_name',\n      'last_name',\n      'phone',\n      'is_active',\n      'accepts_marketing',\n      'notes',\n      'tags',\n      'shipping_first_name',\n      'shipping_last_name',\n      'shipping_company',\n      'shipping_address_line1',\n      'shipping_address_line2',\n      'shipping_city',\n      'shipping_state',\n      'shipping_postal_code',\n      'shipping_country',\n      'shipping_phone',\n      'billing_first_name',\n      'billing_last_name',\n      'billing_company',\n      'billing_address_line1',\n      'billing_address_line2',\n      'billing_city',\n      'billing_state',\n      'billing_postal_code',\n      'billing_country',\n      'billing_phone',\n    ];\n\n    const exampleRow = [\n      'john@example.com',\n      'John',\n      'Doe',\n      '+1-555-123-4567',\n      'Yes',\n      'Yes',\n      'VIP customer',\n      'wholesale,priority',\n      'John',\n      'Doe',\n      'Acme Inc',\n      '123 Main Street',\n      'Suite 100',\n      'New York',\n      'NY',\n      '10001',\n      'USA',\n      '+1-555-123-4567',\n      'John',\n      'Doe',\n      'Acme Inc',\n      '123 Main Street',\n      'Suite 100',\n      'New York',\n      'NY',\n      '10001',\n      'USA',\n      '+1-555-123-4567',\n    ];\n\n    return `${headers.join(',')}\\n\"${exampleRow.join('\",\"')}\"`;\n  }\n\n  /**\n   * Build address JSON from flat fields\n   */\n  buildAddressFromFlatFields(data: Record<string, unknown>, prefix: 'shipping' | 'billing'): Record<string, unknown> | null {\n    const addressLine1 = data[`${prefix}AddressLine1`];\n    if (!addressLine1) {return null;}\n\n    return {\n      firstName: data[`${prefix}FirstName`] || '',\n      lastName: data[`${prefix}LastName`] || '',\n      company: data[`${prefix}Company`] || undefined,\n      addressLine1: addressLine1,\n      addressLine2: data[`${prefix}AddressLine2`] || undefined,\n      city: data[`${prefix}City`] || '',\n      state: data[`${prefix}State`] || undefined,\n      postalCode: data[`${prefix}PostalCode`] || undefined,\n      country: data[`${prefix}Country`] || '',\n      phone: data[`${prefix}Phone`] || undefined,\n    };\n  }\n}\n\nexport const importService = new ImportService();\n","import { MeiliSearch, Index, SearchParams, SearchResponse } from 'meilisearch';\nimport { getDb, products, categories, eq } from '@lab404/database';\n\n// ===========================================\n// Configuration\n// ===========================================\n\nconst MEILISEARCH_HOST = process.env['MEILISEARCH_HOST'] || 'http://localhost:7700';\nconst MEILISEARCH_API_KEY = process.env['MEILISEARCH_API_KEY'] || '';\n\n// Index names\nexport const PRODUCTS_INDEX = 'products';\n\n// ===========================================\n// Types\n// ===========================================\n\nexport interface ProductDocument {\n    id: string;\n    sku: string;\n    name: string;\n    slug: string;\n    description: string | null;\n    shortDescription: string | null;\n    brand: string | null;\n    categoryId: string | null;\n    categoryName: string | null;\n    categorySlug: string | null;\n    basePrice: number;\n    compareAtPrice: number | null;\n    stockQuantity: number;\n    inStock: boolean;\n    isFeatured: boolean;\n    tags: string[];\n    thumbnailUrl: string | null;\n    images: Array<{ url: string; alt?: string }>;\n    createdAt: number;\n    updatedAt: number;\n}\n\nexport interface SearchResult {\n    hits: ProductDocument[];\n    query: string;\n    processingTimeMs: number;\n    estimatedTotalHits: number;\n    limit: number;\n    offset: number;\n    facetDistribution?: Record<string, Record<string, number>>;\n}\n\n// ===========================================\n// Meilisearch Service\n// ===========================================\n\nclass SearchService {\n    private client: MeiliSearch | null = null;\n    private initialized = false;\n\n    /**\n     * Get or create Meilisearch client\n     */\n    private getClient(): MeiliSearch {\n        if (!this.client) {\n            this.client = new MeiliSearch({\n                host: MEILISEARCH_HOST,\n                apiKey: MEILISEARCH_API_KEY,\n            });\n        }\n        return this.client;\n    }\n\n    /**\n     * Check if Meilisearch is available\n     */\n    async isAvailable(): Promise<boolean> {\n        try {\n            const client = this.getClient();\n            await client.health();\n            return true;\n        } catch (error) {\n            console.warn('Meilisearch is not available:', error instanceof Error ? error.message : 'Unknown error');\n            return false;\n        }\n    }\n\n    /**\n     * Initialize the search index with proper settings\n     */\n    async initialize(): Promise<void> {\n        if (this.initialized) {return;}\n\n        try {\n            const client = this.getClient();\n\n            // Create products index if it doesn't exist\n            try {\n                await client.getIndex(PRODUCTS_INDEX);\n            } catch {\n                await client.createIndex(PRODUCTS_INDEX, { primaryKey: 'id' });\n            }\n\n            const index = client.index(PRODUCTS_INDEX);\n\n            // Configure searchable attributes\n            await index.updateSearchableAttributes([\n                'name',\n                'description',\n                'shortDescription',\n                'sku',\n                'brand',\n                'categoryName',\n                'tags',\n            ]);\n\n            // Configure filterable attributes for faceted search\n            await index.updateFilterableAttributes([\n                'categoryId',\n                'categorySlug',\n                'inStock',\n                'isFeatured',\n                'basePrice',\n                'brand',\n                'tags',\n            ]);\n\n            // Configure sortable attributes\n            await index.updateSortableAttributes([\n                'name',\n                'basePrice',\n                'createdAt',\n                'stockQuantity',\n            ]);\n\n            // Configure ranking rules\n            await index.updateRankingRules([\n                'words',\n                'typo',\n                'proximity',\n                'attribute',\n                'sort',\n                'exactness',\n            ]);\n\n            // Configure typo tolerance\n            await index.updateTypoTolerance({\n                enabled: true,\n                minWordSizeForTypos: {\n                    oneTypo: 4,\n                    twoTypos: 8,\n                },\n            });\n\n            this.initialized = true;\n            console.log('Meilisearch initialized successfully');\n        } catch (error) {\n            console.error('Failed to initialize Meilisearch:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Get the products index\n     */\n    getProductsIndex(): Index<ProductDocument> {\n        return this.getClient().index(PRODUCTS_INDEX);\n    }\n\n    /**\n     * Index a single product\n     */\n    async indexProduct(product: ProductDocument): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.addDocuments([product]);\n        } catch (error) {\n            console.error('Failed to index product:', error);\n        }\n    }\n\n    /**\n     * Index multiple products\n     */\n    async indexProducts(productDocs: ProductDocument[]): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.addDocuments(productDocs);\n        } catch (error) {\n            console.error('Failed to index products:', error);\n        }\n    }\n\n    /**\n     * Update a product in the index\n     */\n    async updateProduct(product: ProductDocument): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.updateDocuments([product]);\n        } catch (error) {\n            console.error('Failed to update product in index:', error);\n        }\n    }\n\n    /**\n     * Remove a product from the index\n     */\n    async removeProduct(productId: string): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.deleteDocument(productId);\n        } catch (error) {\n            console.error('Failed to remove product from index:', error);\n        }\n    }\n\n    /**\n     * Search products\n     */\n    async searchProducts(\n        query: string,\n        options: {\n            limit?: number;\n            offset?: number;\n            filters?: string[];\n            sort?: string[];\n            facets?: string[];\n        } = {}\n    ): Promise<SearchResult> {\n        const { limit = 20, offset = 0, filters = [], sort = [], facets = [] } = options;\n\n        const searchParams: SearchParams = {\n            limit,\n            offset,\n            attributesToRetrieve: [\n                'id',\n                'sku',\n                'name',\n                'slug',\n                'shortDescription',\n                'brand',\n                'categoryId',\n                'categoryName',\n                'categorySlug',\n                'basePrice',\n                'compareAtPrice',\n                'stockQuantity',\n                'inStock',\n                'isFeatured',\n                'tags',\n                'thumbnailUrl',\n                'images',\n            ],\n        };\n\n        // Add filters\n        if (filters.length > 0) {\n            searchParams.filter = filters;\n        }\n\n        // Add sorting\n        if (sort.length > 0) {\n            searchParams.sort = sort;\n        }\n\n        // Add facets for filtering UI\n        if (facets.length > 0) {\n            searchParams.facets = facets;\n        }\n\n        try {\n            const index = this.getProductsIndex();\n            const response = await index.search(query, searchParams);\n\n            return {\n                hits: response.hits as ProductDocument[],\n                query: response.query,\n                processingTimeMs: response.processingTimeMs,\n                estimatedTotalHits: response.estimatedTotalHits || 0,\n                limit,\n                offset,\n                facetDistribution: response.facetDistribution,\n            };\n        } catch (error) {\n            console.error('Search failed:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Sync all products from database to Meilisearch\n     */\n    async syncAllProducts(): Promise<{ indexed: number; errors: number }> {\n        const db = getDb();\n        let indexed = 0;\n        let errors = 0;\n\n        try {\n            // Get all active products\n            const productList = await db\n                .select()\n                .from(products)\n                .where(eq(products.status, 'active'));\n\n            // Get all categories for lookup\n            const categoryList = await db.select().from(categories);\n            const categoryMap = new Map(categoryList.map(c => [c.id, c]));\n\n            // Transform products to search documents\n            const documents: ProductDocument[] = productList.map(product => {\n                const category = product.categoryId ? categoryMap.get(product.categoryId) : null;\n\n                return {\n                    id: product.id,\n                    sku: product.sku,\n                    name: product.name,\n                    slug: product.slug,\n                    description: product.description,\n                    shortDescription: product.shortDescription,\n                    brand: product.brand,\n                    categoryId: product.categoryId,\n                    categoryName: category?.name || null,\n                    categorySlug: category?.slug || null,\n                    basePrice: Number(product.basePrice),\n                    compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n                    stockQuantity: product.stockQuantity,\n                    inStock: product.stockQuantity > 0 || product.allowBackorder,\n                    isFeatured: product.isFeatured,\n                    tags: product.tags as string[] || [],\n                    thumbnailUrl: product.thumbnailUrl,\n                    images: product.images as Array<{ url: string; alt?: string }> || [],\n                    createdAt: new Date(product.createdAt).getTime(),\n                    updatedAt: new Date(product.updatedAt).getTime(),\n                };\n            });\n\n            // Index all products\n            if (documents.length > 0) {\n                const index = this.getProductsIndex();\n                // Replace all documents to ensure clean sync\n                await index.deleteAllDocuments();\n                await index.addDocuments(documents);\n                indexed = documents.length;\n            }\n\n            console.log(`Synced ${indexed} products to Meilisearch`);\n        } catch (error) {\n            console.error('Failed to sync products:', error);\n            errors++;\n        }\n\n        return { indexed, errors };\n    }\n\n    /**\n     * Get index stats\n     */\n    async getIndexStats(): Promise<{\n        numberOfDocuments: number;\n        isIndexing: boolean;\n    }> {\n        try {\n            const index = this.getProductsIndex();\n            const stats = await index.getStats();\n            return {\n                numberOfDocuments: stats.numberOfDocuments,\n                isIndexing: stats.isIndexing,\n            };\n        } catch (error) {\n            console.error('Failed to get index stats:', error);\n            return { numberOfDocuments: 0, isIndexing: false };\n        }\n    }\n}\n\n// Export singleton instance\nexport const searchService = new SearchService();\nexport { SearchService };\n","import crypto from 'crypto';\n\n/**\n * Generate a cryptographically secure random token\n * @param length Length of the token in bytes (default 32 = 64 hex chars)\n */\nexport function generateSecureToken(length = 32): string {\n  return crypto.randomBytes(length).toString('hex');\n}\n\n/**\n * Generate a short secure token (for URLs)\n * @param length Length of the token in bytes (default 24 = 48 hex chars)\n */\nexport function generateShortToken(length = 24): string {\n  return crypto.randomBytes(length).toString('hex');\n}\n\n/**\n * Hash a token using SHA256\n */\nexport function hashToken(token: string): string {\n  return crypto.createHash('sha256').update(token).digest('hex');\n}\n\n/**\n * Generate a URL-safe base64 token\n */\nexport function generateUrlSafeToken(length = 32): string {\n  return crypto.randomBytes(length).toString('base64url');\n}\n\n/**\n * Generate a cryptographically secure 6-digit verification code\n * @returns 6-digit string (000000-999999)\n */\nexport function generateVerificationCode(): string {\n  // Generate random number between 0 and 999999\n  const code = crypto.randomInt(0, 1000000);\n\n  // Pad with leading zeros to ensure 6 digits\n  return code.toString().padStart(6, '0');\n}\n","import { getDb, verificationCodes, VerificationCodeType, eq, and, gte, desc, or, lte } from '@lab404/database';\nimport { generateVerificationCode } from '../utils/crypto';\nimport { BadRequestError, TooManyRequestsError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\ninterface CreateCodeOptions {\n  email: string;\n  type: VerificationCodeType;\n  ipAddress?: string;\n  expiryMinutes?: number;\n}\n\ninterface ValidateCodeOptions {\n  email: string;\n  code: string;\n  type: VerificationCodeType;\n}\n\nclass VerificationCodeService {\n  private readonly DEFAULT_EXPIRY_MINUTES = 15;\n  private readonly MAX_ATTEMPTS = 10;\n\n  /**\n   * Generate and store a new verification code\n   * Invalidates any existing unused codes for the same email/type\n   */\n  async createCode(options: CreateCodeOptions): Promise<string> {\n    const { email, type, ipAddress, expiryMinutes = this.DEFAULT_EXPIRY_MINUTES } = options;\n    const db = getDb();\n\n    // Invalidate any existing unused codes for this email/type\n    await this.invalidateCodes(email, type);\n\n    // Generate 6-digit code\n    const code = generateVerificationCode();\n\n    // Calculate expiration\n    const expiresAt = new Date();\n    expiresAt.setMinutes(expiresAt.getMinutes() + expiryMinutes);\n\n    // Store in database\n    await db.insert(verificationCodes).values({\n      email: email.toLowerCase(),\n      code,\n      type,\n      expiresAt,\n      ipAddress,\n      maxAttempts: this.MAX_ATTEMPTS,\n    });\n\n    logger.info('Verification code created', { email, type, expiresAt });\n    return code;\n  }\n\n  /**\n   * Validate a verification code\n   * Tracks attempts and enforces expiration\n   */\n  async validateCode(options: ValidateCodeOptions): Promise<boolean> {\n    const { email, code, type } = options;\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (!record) {\n      logger.warn('Verification code not found or expired', { email, type });\n      throw new BadRequestError('Invalid or expired verification code');\n    }\n\n    // Check if max attempts exceeded\n    if (record.attempts >= record.maxAttempts) {\n      logger.warn('Max verification attempts exceeded', { email, type, attempts: record.attempts });\n      throw new TooManyRequestsError('Maximum verification attempts exceeded. Please request a new code.');\n    }\n\n    // Increment attempts\n    await db\n      .update(verificationCodes)\n      .set({ attempts: record.attempts + 1 })\n      .where(eq(verificationCodes.id, record.id));\n\n    // Validate code\n    if (record.code !== code) {\n      logger.warn('Invalid verification code attempt', { email, type, attempts: record.attempts + 1 });\n      throw new BadRequestError('Invalid verification code');\n    }\n\n    // Mark as used\n    await db\n      .update(verificationCodes)\n      .set({\n        isUsed: true,\n        usedAt: now,\n      })\n      .where(eq(verificationCodes.id, record.id));\n\n    logger.info('Verification code validated successfully', { email, type });\n    return true;\n  }\n\n  /**\n   * Validate a verification code without marking it as used\n   * Use this when you need to perform additional operations before marking as used\n   * Tracks attempts and enforces expiration\n   */\n  async validateCodeWithoutMarking(options: ValidateCodeOptions): Promise<boolean> {\n    const { email, code, type } = options;\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (!record) {\n      logger.warn('Verification code not found or expired', { email, type });\n      throw new BadRequestError('Invalid or expired verification code');\n    }\n\n    // Check if max attempts exceeded\n    if (record.attempts >= record.maxAttempts) {\n      logger.warn('Max verification attempts exceeded', { email, type, attempts: record.attempts });\n      throw new TooManyRequestsError('Maximum verification attempts exceeded. Please request a new code.');\n    }\n\n    // Increment attempts\n    await db\n      .update(verificationCodes)\n      .set({ attempts: record.attempts + 1 })\n      .where(eq(verificationCodes.id, record.id));\n\n    // Validate code\n    if (record.code !== code) {\n      logger.warn('Invalid verification code attempt', { email, type, attempts: record.attempts + 1 });\n      throw new BadRequestError('Invalid verification code');\n    }\n\n    logger.info('Verification code validated (not marked as used yet)', { email, type });\n    return true;\n  }\n\n  /**\n   * Mark a validated verification code as used\n   * Call this after validateCodeWithoutMarking() once the operation succeeds\n   */\n  async markCodeAsUsed(email: string, type: VerificationCodeType): Promise<void> {\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (record) {\n      await db\n        .update(verificationCodes)\n        .set({\n          isUsed: true,\n          usedAt: now,\n        })\n        .where(eq(verificationCodes.id, record.id));\n\n      logger.info('Verification code marked as used', { email, type });\n    }\n  }\n\n  /**\n   * Invalidate all unused codes for a specific email/type\n   */\n  async invalidateCodes(email: string, type: VerificationCodeType): Promise<void> {\n    const db = getDb();\n    const now = new Date();\n\n    const result = await db\n      .update(verificationCodes)\n      .set({ isUsed: true, usedAt: now })\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false)\n        )\n      )\n      .returning({ id: verificationCodes.id });\n\n    if (result.length > 0) {\n      logger.info('Invalidated existing verification codes', {\n        email,\n        type,\n        count: result.length\n      });\n    }\n  }\n\n  /**\n   * Cleanup expired and used verification codes\n   * Called by cron job\n   */\n  async cleanupExpiredCodes(): Promise<number> {\n    const db = getDb();\n    const now = new Date();\n\n    // Delete codes that are:\n    // 1. Expired for more than 24 hours, OR\n    // 2. Used and usedAt is more than 24 hours ago\n    const cutoffDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n\n    const deleted = await db\n      .delete(verificationCodes)\n      .where(\n        or(\n          lte(verificationCodes.expiresAt, cutoffDate),\n          and(\n            eq(verificationCodes.isUsed, true),\n            lte(verificationCodes.usedAt, cutoffDate)\n          )\n        )\n      )\n      .returning({ id: verificationCodes.id });\n\n    logger.info('Verification codes cleanup completed', {\n      deletedCount: deleted.length\n    });\n\n    return deleted.length;\n  }\n}\n\nexport const verificationCodeService = new VerificationCodeService();\n","import { db, ipReputation, type IpReputation, type NewIpReputation, eq, and, lt, lte, gte } from '@lab404/database';\nimport { Request } from 'express';\nimport { logger } from '../utils/logger';\n\n/**\n * IP Reputation Service\n *\n * Tracks IP addresses with reputation scores for abuse prevention.\n * Used to identify and block malicious IPs automatically.\n *\n * Reputation Score System (0-100):\n * - Start: 100 (neutral)\n * - Failed login: -5\n * - Rate limit violation: -10\n * - Abuse report: -20\n * - Successful login: +2\n * - Block threshold: score < 20\n * - Suspicious threshold: score < 50\n */\nclass IpReputationService {\n  /**\n   * Track an IP action and update reputation\n   *\n   * @param ip - IP address\n   * @param action - Action type\n   * @param success - Whether the action was successful\n   * @param metadata - Additional metadata\n   */\n  async trackIP(\n    ip: string,\n    action: 'login' | 'rate_limit' | 'abuse_report' | 'api_request',\n    success: boolean,\n    metadata?: {\n      userAgent?: string;\n      country?: string;\n      reason?: string;\n    }\n  ): Promise<void> {\n    try {\n      // Get or create IP record\n      const ipRecord = await this.getOrCreateIP(ip, metadata);\n\n      // Update counters based on action\n      const updates: Partial<IpReputation> = {\n        lastSeenAt: new Date(),\n        updatedAt: new Date(),\n      };\n\n      if (action === 'login') {\n        if (success) {\n          updates.successfulLogins = (ipRecord.successfulLogins || 0) + 1;\n        } else {\n          updates.failedLoginAttempts = (ipRecord.failedLoginAttempts || 0) + 1;\n        }\n      } else if (action === 'rate_limit') {\n        updates.rateLimitViolations = (ipRecord.rateLimitViolations || 0) + 1;\n      } else if (action === 'abuse_report') {\n        updates.abuseReports = (ipRecord.abuseReports || 0) + 1;\n      }\n\n      // Update metadata if provided\n      if (metadata?.userAgent) {\n        updates.userAgent = metadata.userAgent;\n      }\n      if (metadata?.country) {\n        updates.country = metadata.country;\n      }\n\n      // Calculate new reputation score\n      const newScore = await this.calculateScore(ip);\n      updates.reputationScore = newScore;\n\n      // Auto-block if score drops below threshold\n      if (newScore < 20 && !ipRecord.isBlocked) {\n        updates.isBlocked = true;\n        updates.blockedAt = new Date();\n        updates.blockReason = 'Automatic block due to low reputation score';\n        updates.blockedUntil = null; // Permanent until manually unblocked\n\n        logger.warn('IP automatically blocked due to low reputation', {\n          ip,\n          reputationScore: newScore,\n          failedLogins: updates.failedLoginAttempts,\n          rateLimitViolations: updates.rateLimitViolations,\n          abuseReports: updates.abuseReports,\n        });\n      }\n\n      // Update the record\n      await db\n        .update(ipReputation)\n        .set(updates)\n        .where(eq(ipReputation.ipAddress, ip));\n    } catch (error) {\n      logger.error('Failed to track IP', {\n        ip,\n        action,\n        success,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      // Don't throw - tracking failures shouldn't break requests\n    }\n  }\n\n  /**\n   * Get IP reputation record\n   *\n   * @param ip - IP address\n   * @returns IP reputation or null\n   */\n  async getReputation(ip: string): Promise<IpReputation | null> {\n    try {\n      const results = await db\n        .select()\n        .from(ipReputation)\n        .where(eq(ipReputation.ipAddress, ip))\n        .limit(1);\n\n      return results[0] || null;\n    } catch (error) {\n      logger.error('Failed to get IP reputation', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Check if an IP is blocked\n   *\n   * @param ip - IP address\n   * @returns True if blocked, false otherwise\n   */\n  async isBlocked(ip: string): Promise<boolean> {\n    try {\n      const record = await this.getReputation(ip);\n\n      if (!record || !record.isBlocked) {\n        return false;\n      }\n\n      // Check if temporary block has expired\n      if (record.blockedUntil && record.blockedUntil < new Date()) {\n        // Unblock automatically\n        await this.unblockIP(ip);\n        return false;\n      }\n\n      return true;\n    } catch (error) {\n      logger.error('Failed to check if IP is blocked', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      // Default to not blocked on error to avoid false positives\n      return false;\n    }\n  }\n\n  /**\n   * Block an IP address\n   *\n   * @param ip - IP address\n   * @param reason - Block reason\n   * @param duration - Optional duration in hours (null = permanent)\n   */\n  async blockIP(ip: string, reason: string, duration?: number): Promise<void> {\n    try {\n      // Get or create IP record\n      await this.getOrCreateIP(ip);\n\n      const blockedUntil = duration\n        ? new Date(Date.now() + duration * 60 * 60 * 1000)\n        : null;\n\n      await db\n        .update(ipReputation)\n        .set({\n          isBlocked: true,\n          blockReason: reason,\n          blockedAt: new Date(),\n          blockedUntil,\n          updatedAt: new Date(),\n        })\n        .where(eq(ipReputation.ipAddress, ip));\n\n      logger.info('IP blocked', {\n        ip,\n        reason,\n        duration: duration ? `${duration} hours` : 'permanent',\n        blockedUntil: blockedUntil?.toISOString(),\n      });\n    } catch (error) {\n      logger.error('Failed to block IP', {\n        ip,\n        reason,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Unblock an IP address\n   *\n   * @param ip - IP address\n   */\n  async unblockIP(ip: string): Promise<void> {\n    try {\n      await db\n        .update(ipReputation)\n        .set({\n          isBlocked: false,\n          blockReason: null,\n          blockedAt: null,\n          blockedUntil: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(ipReputation.ipAddress, ip));\n\n      logger.info('IP unblocked', { ip });\n    } catch (error) {\n      logger.error('Failed to unblock IP', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Calculate reputation score for an IP\n   *\n   * Score calculation:\n   * - Start: 100\n   * - Failed login: -5\n   * - Rate limit violation: -10\n   * - Abuse report: -20\n   * - Successful login: +2\n   *\n   * @param ip - IP address\n   * @returns Reputation score (0-100)\n   */\n  async calculateScore(ip: string): Promise<number> {\n    try {\n      const record = await this.getReputation(ip);\n\n      if (!record) {\n        return 100; // New IPs start with perfect score\n      }\n\n      let score = 100;\n\n      // Deduct for bad behavior\n      score -= (record.failedLoginAttempts || 0) * 5;\n      score -= (record.rateLimitViolations || 0) * 10;\n      score -= (record.abuseReports || 0) * 20;\n\n      // Add for good behavior\n      score += (record.successfulLogins || 0) * 2;\n\n      // Clamp between 0 and 100\n      return Math.max(0, Math.min(100, score));\n    } catch (error) {\n      logger.error('Failed to calculate IP score', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      return 100; // Default to neutral score on error\n    }\n  }\n\n  /**\n   * Cleanup expired temporary blocks and improve reputation scores\n   *\n   * This should be run periodically (e.g., daily cron job)\n   * - Removes expired temporary blocks\n   * - Gradually improves reputation scores for IPs with score < 100\n   *\n   * @returns Object with cleanup statistics\n   */\n  async cleanupExpiredBlocks(): Promise<{\n    unblockedCount: number;\n    improvedCount: number;\n  }> {\n    try {\n      const now = new Date();\n\n      // Find and unblock expired temporary blocks\n      const expiredBlocks = await db\n        .select()\n        .from(ipReputation)\n        .where(\n          and(\n            eq(ipReputation.isBlocked, true),\n            lt(ipReputation.blockedUntil, now)\n          )\n        );\n\n      let unblockedCount = 0;\n      for (const record of expiredBlocks) {\n        if (record.blockedUntil !== null) {\n          await this.unblockIP(record.ipAddress);\n          unblockedCount++;\n        }\n      }\n\n      // Gradually improve reputation scores (increase by 10 for IPs with score < 100)\n      const ipsToImprove = await db\n        .select()\n        .from(ipReputation)\n        .where(lt(ipReputation.reputationScore, 100));\n\n      let improvedCount = 0;\n      for (const record of ipsToImprove) {\n        const newScore = Math.min(100, (record.reputationScore || 0) + 10);\n        await db\n          .update(ipReputation)\n          .set({\n            reputationScore: newScore,\n            updatedAt: new Date(),\n          })\n          .where(eq(ipReputation.ipAddress, record.ipAddress));\n        improvedCount++;\n      }\n\n      logger.info('IP reputation cleanup completed', {\n        unblockedCount,\n        improvedCount,\n        timestamp: new Date().toISOString(),\n      });\n\n      return { unblockedCount, improvedCount };\n    } catch (error) {\n      logger.error('Failed to cleanup IP reputation', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get statistics about IP reputation\n   *\n   * @returns Statistics object\n   */\n  async getStatistics(): Promise<{\n    totalIPs: number;\n    blockedIPs: number;\n    suspiciousIPs: number;\n    goodIPs: number;\n    averageScore: number;\n  }> {\n    try {\n      const allIPs = await db.select().from(ipReputation);\n\n      const stats = {\n        totalIPs: allIPs.length,\n        blockedIPs: allIPs.filter((ip) => ip.isBlocked).length,\n        suspiciousIPs: allIPs.filter(\n          (ip) => !ip.isBlocked && (ip.reputationScore || 0) < 50\n        ).length,\n        goodIPs: allIPs.filter((ip) => (ip.reputationScore || 0) >= 50).length,\n        averageScore:\n          allIPs.length > 0\n            ? allIPs.reduce((sum, ip) => sum + (ip.reputationScore || 0), 0) /\n              allIPs.length\n            : 100,\n      };\n\n      return stats;\n    } catch (error) {\n      logger.error('Failed to get IP reputation statistics', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Query IP reputations with filters and pagination\n   *\n   * @param filters - Query filters\n   * @returns Array of IP reputations\n   */\n  async query(filters: {\n    isBlocked?: boolean;\n    minScore?: number;\n    maxScore?: number;\n    limit?: number;\n    offset?: number;\n  }): Promise<IpReputation[]> {\n    try {\n      const conditions = [];\n\n      if (filters.isBlocked !== undefined) {\n        conditions.push(eq(ipReputation.isBlocked, filters.isBlocked));\n      }\n\n      if (filters.minScore !== undefined) {\n        conditions.push(gte(ipReputation.reputationScore, filters.minScore));\n      }\n\n      if (filters.maxScore !== undefined) {\n        conditions.push(lte(ipReputation.reputationScore, filters.maxScore));\n      }\n\n      const baseQuery = db.select().from(ipReputation);\n\n      const results = conditions.length > 0\n        ? await baseQuery\n            .where(and(...conditions))\n            .limit(filters.limit || 50)\n            .offset(filters.offset || 0)\n        : await baseQuery\n            .limit(filters.limit || 50)\n            .offset(filters.offset || 0);\n\n      return results;\n    } catch (error) {\n      logger.error('Failed to query IP reputations', {\n        filters,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get or create an IP reputation record\n   *\n   * @param ip - IP address\n   * @param metadata - Optional metadata\n   * @returns IP reputation record\n   */\n  private async getOrCreateIP(\n    ip: string,\n    metadata?: {\n      userAgent?: string;\n      country?: string;\n    }\n  ): Promise<IpReputation> {\n    try {\n      const existing = await this.getReputation(ip);\n\n      if (existing) {\n        return existing;\n      }\n\n      // Create new record\n      const newRecord: NewIpReputation = {\n        ipAddress: ip,\n        reputationScore: 100,\n        failedLoginAttempts: 0,\n        successfulLogins: 0,\n        rateLimitViolations: 0,\n        abuseReports: 0,\n        isBlocked: false,\n        lastSeenAt: new Date(),\n        firstSeenAt: new Date(),\n        userAgent: metadata?.userAgent || null,\n        country: metadata?.country || null,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n\n      const [created] = await db.insert(ipReputation).values(newRecord).returning();\n\n      if (!created) {\n        throw new Error('Failed to create IP reputation record');\n      }\n\n      return created;\n    } catch (error) {\n      logger.error('Failed to get or create IP', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get client IP address from request\n   *\n   * Handles X-Forwarded-For header for proxies\n   *\n   * @param req - Express request\n   * @returns IP address\n   */\n  getClientIp(req: Request): string {\n    const forwardedFor = req.get('x-forwarded-for');\n    if (forwardedFor) {\n      const firstIp = forwardedFor.split(',')[0];\n      return firstIp?.trim() || 'unknown';\n    }\n    return req.ip || req.socket.remoteAddress || 'unknown';\n  }\n}\n\nexport const ipReputationService = new IpReputationService();\n","import { getDb, carts, cartItems, eq, and, isNull } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\n/**\n * Cart Service\n * Handles cart operations including merging session carts on login\n */\nexport class CartService {\n  /**\n   * Merge session cart into customer cart on login\n   * Combines quantities for duplicate items (same product + variant)\n   *\n   * @param sessionId - Session ID from x-session-id header\n   * @param customerId - Customer ID from authenticated user\n   * @returns Number of items merged\n   */\n  async mergeSessionCart(sessionId: string, customerId: string): Promise<number> {\n    const db = getDb();\n\n    try {\n      // Find session cart\n      const [sessionCart] = await db\n        .select()\n        .from(carts)\n        .where(eq(carts.sessionId, sessionId));\n\n      if (!sessionCart) {\n        logger.debug('No session cart to merge', { sessionId, customerId });\n        return 0;\n      }\n\n      // Find or create customer cart\n      let [customerCart] = await db\n        .select()\n        .from(carts)\n        .where(eq(carts.customerId, customerId));\n\n      if (!customerCart) {\n        // Create customer cart\n        [customerCart] = await db\n          .insert(carts)\n          .values({ customerId })\n          .returning();\n\n        if (!customerCart) {\n          throw new Error('Failed to create customer cart');\n        }\n      }\n\n      // Get all session cart items\n      const sessionItems = await db\n        .select()\n        .from(cartItems)\n        .where(eq(cartItems.cartId, sessionCart.id));\n\n      if (sessionItems.length === 0) {\n        // Empty session cart - just delete it\n        await db.delete(carts).where(eq(carts.id, sessionCart.id));\n        return 0;\n      }\n\n      let mergedCount = 0;\n\n      // Process each session item\n      for (const item of sessionItems) {\n        // Check if customer cart has same product+variant\n        const [existingItem] = await db\n          .select()\n          .from(cartItems)\n          .where(\n            and(\n              eq(cartItems.cartId, customerCart.id),\n              eq(cartItems.productId, item.productId),\n              item.variantId\n                ? eq(cartItems.variantId, item.variantId)\n                : isNull(cartItems.variantId)\n            )\n          );\n\n        if (existingItem) {\n          // Duplicate found - merge quantities\n          await db\n            .update(cartItems)\n            .set({\n              quantity: existingItem.quantity + item.quantity,\n              updatedAt: new Date(),\n            })\n            .where(eq(cartItems.id, existingItem.id));\n\n          logger.debug('Merged cart item quantities', {\n            productId: item.productId,\n            variantId: item.variantId,\n            oldQuantity: existingItem.quantity,\n            addedQuantity: item.quantity,\n            newQuantity: existingItem.quantity + item.quantity,\n          });\n        } else {\n          // New item - transfer to customer cart\n          await db\n            .update(cartItems)\n            .set({\n              cartId: customerCart.id,\n              updatedAt: new Date(),\n            })\n            .where(eq(cartItems.id, item.id));\n\n          logger.debug('Transferred cart item to customer', {\n            cartItemId: item.id,\n            productId: item.productId,\n          });\n        }\n\n        mergedCount++;\n      }\n\n      // Delete session cart (cascade deletes any remaining items)\n      await db.delete(carts).where(eq(carts.id, sessionCart.id));\n\n      logger.info('Cart merge completed', {\n        sessionId,\n        customerId,\n        itemsMerged: mergedCount,\n      });\n\n      return mergedCount;\n    } catch (error) {\n      logger.error('Cart merge failed', error, {\n        sessionId,\n        customerId,\n      });\n      // Don't throw - merge failure shouldn't block login\n      return 0;\n    }\n  }\n}\n\n// Export singleton instance\nexport const cartService = new CartService();\n","import nodemailer, { Transporter } from 'nodemailer';\nimport { logger } from '../utils/logger';\n\ninterface EmailAttachment {\n  filename: string;\n  content: Buffer;\n  contentType?: string;\n}\n\ninterface EmailOptions {\n  to: string | string[];\n  subject: string;\n  html: string;\n  text?: string;\n  attachments?: EmailAttachment[];\n}\n\ninterface SMTPConfig {\n  host: string;\n  port: number;\n  secure: boolean;\n  auth: {\n    user: string;\n    pass: string;\n  };\n}\n\nclass MailerService {\n  private transporter: Transporter | null = null;\n  private fromEmail: string;\n  private fromName: string;\n  private isConfigured: boolean = false;\n\n  constructor() {\n    // Use SMTP_FROM_EMAIL if set, otherwise fall back to SMTP_USER (the authenticated account)\n    // This prevents \"Sender address rejected\" errors when FROM doesn't match authenticated user\n    this.fromEmail = process.env['SMTP_FROM_EMAIL'] || process.env['SMTP_USER'] || 'noreply@lab404electronics.com';\n    this.fromName = process.env['SMTP_FROM_NAME'] || 'Lab404 Electronics';\n    this.initialize();\n  }\n\n  private initialize() {\n    const host = process.env['SMTP_HOST'];\n    const port = parseInt(process.env['SMTP_PORT'] || '587', 10);\n    const user = process.env['SMTP_USER'];\n    const pass = process.env['SMTP_PASS'];\n\n    if (!host || !user || !pass) {\n      logger.warn('SMTP not configured. Email notifications will be disabled.');\n      this.isConfigured = false;\n      return;\n    }\n\n    const config: SMTPConfig = {\n      host,\n      port,\n      secure: port === 465,\n      auth: { user, pass },\n    };\n\n    this.transporter = nodemailer.createTransport(config);\n    this.isConfigured = true;\n    logger.info('SMTP mailer initialized', { host, port });\n  }\n\n  async sendEmail(options: EmailOptions): Promise<boolean> {\n    if (!this.isConfigured || !this.transporter) {\n      logger.warn('Email not sent - SMTP not configured', { to: options.to, subject: options.subject });\n      return false;\n    }\n\n    try {\n      const mailOptions: nodemailer.SendMailOptions = {\n        from: `\"${this.fromName}\" <${this.fromEmail}>`,\n        to: Array.isArray(options.to) ? options.to.join(', ') : options.to,\n        subject: options.subject,\n        html: options.html,\n        text: options.text || this.stripHtml(options.html),\n      };\n\n      // Add attachments if provided\n      if (options.attachments && options.attachments.length > 0) {\n        mailOptions.attachments = options.attachments.map(att => ({\n          filename: att.filename,\n          content: att.content,\n          contentType: att.contentType || 'application/pdf',\n        }));\n      }\n\n      const info = await this.transporter.sendMail(mailOptions);\n\n      logger.info('Email sent successfully', { messageId: info.messageId, to: options.to });\n      return true;\n    } catch (error) {\n      logger.error('Failed to send email', { error, to: options.to, subject: options.subject });\n      return false;\n    }\n  }\n\n  private stripHtml(html: string): string {\n    return html.replace(/<[^>]*>/g, '').replace(/\\s+/g, ' ').trim();\n  }\n\n  // Verify SMTP connection\n  async verifyConnection(): Promise<boolean> {\n    if (!this.isConfigured || !this.transporter) {\n      return false;\n    }\n\n    try {\n      await this.transporter.verify();\n      logger.info('SMTP connection verified');\n      return true;\n    } catch (error) {\n      logger.error('SMTP connection verification failed', { error });\n      return false;\n    }\n  }\n\n  isReady(): boolean {\n    return this.isConfigured;\n  }\n}\n\nexport const mailerService = new MailerService();\n","import { mailerService } from './mailer.service';\nimport { logger } from '../utils/logger';\n\nexport type NotificationType =\n  | 'new_order'\n  | 'order_status_change'\n  | 'low_stock_alert'\n  | 'new_customer'\n  | 'new_contact_message'\n  | 'quotation_request'\n  | 'payment_received'\n  | 'refund_processed';\n\ninterface NotificationData {\n  [key: string]: string | number | boolean | undefined;\n}\n\ninterface NotificationSettings {\n  enabled: boolean;\n  adminEmails: string[];\n  notifications: {\n    [key in NotificationType]: boolean;\n  };\n}\n\n// Default notification settings\nconst defaultSettings: NotificationSettings = {\n  enabled: true,\n  adminEmails: [process.env['ADMIN_EMAIL'] || 'admin@lab404electronics.com'],\n  notifications: {\n    new_order: true,\n    order_status_change: true,\n    low_stock_alert: true,\n    new_customer: true,\n    new_contact_message: true,\n    quotation_request: true,\n    payment_received: true,\n    refund_processed: true,\n  },\n};\n\n// Helper to get data value safely\nfunction getData(data: NotificationData, key: string): string {\n  const value = data[key];\n  return value !== undefined ? String(value) : '';\n}\n\ninterface QuotationEmailData {\n  quotationNumber: string;\n  customerName: string;\n  customerEmail: string;\n  total: number;\n  validUntil: Date | null;\n  currency: string;\n  itemCount: number;\n  companyName: string;\n  companyEmail?: string;\n  companyPhone?: string;\n}\n\nclass NotificationService {\n  private settings: NotificationSettings = defaultSettings;\n\n  updateSettings(newSettings: Partial<NotificationSettings>) {\n    this.settings = { ...this.settings, ...newSettings };\n    logger.info('Notification settings updated', { settings: this.settings });\n  }\n\n  getSettings(): NotificationSettings {\n    return this.settings;\n  }\n\n  async notify(type: NotificationType, data: NotificationData): Promise<boolean> {\n    if (!this.settings.enabled || !this.settings.notifications[type]) {\n      logger.debug('Notification skipped - disabled', { type });\n      return false;\n    }\n\n    const template = this.getTemplate(type, data);\n    if (!template) {\n      logger.warn('No template found for notification type', { type });\n      return false;\n    }\n\n    return mailerService.sendEmail({\n      to: this.settings.adminEmails,\n      subject: template.subject,\n      html: template.html,\n    });\n  }\n\n  private getAdminUrl(): string {\n    return process.env['ADMIN_URL'] || 'http://localhost:3001';\n  }\n\n  private getTemplate(type: NotificationType, data: NotificationData): { subject: string; html: string } | null {\n    const adminUrl = this.getAdminUrl();\n\n    const templates: Record<NotificationType, () => { subject: string; html: string }> = {\n      new_order: () => ({\n        subject: `New Order #${getData(data, 'orderId')} - Lab404 Electronics`,\n        html: this.wrapTemplate(`\n          <h2>New Order Received</h2>\n          <p>A new order has been placed on your store.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Customer:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Total:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">$${getData(data, 'total')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'itemCount')} item(s)</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      order_status_change: () => ({\n        subject: `Order #${getData(data, 'orderId')} Status Changed to ${getData(data, 'newStatus')}`,\n        html: this.wrapTemplate(`\n          <h2>Order Status Updated</h2>\n          <p>Order #${getData(data, 'orderId')} status has been changed.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Previous Status:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'previousStatus')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>New Status:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong style=\"color: #2563eb;\">${getData(data, 'newStatus')}</strong></td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      low_stock_alert: () => ({\n        subject: `Low Stock Alert: ${getData(data, 'productName')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #dc2626;\">Low Stock Alert</h2>\n          <p>The following product is running low on stock:</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Product:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'productName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>SKU:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'sku')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Current Stock:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #dc2626;\"><strong>${getData(data, 'currentStock')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Threshold:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'threshold')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/products/${getData(data, 'productId')}\" style=\"background: #dc2626; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">Update Stock</a></p>\n        `),\n      }),\n\n      new_customer: () => ({\n        subject: `New Customer Registration - ${getData(data, 'customerName')}`,\n        html: this.wrapTemplate(`\n          <h2>New Customer Registered</h2>\n          <p>A new customer has registered on your store.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Name:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Registered:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${new Date().toLocaleString()}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/customers/${getData(data, 'customerId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Customer</a></p>\n        `),\n      }),\n\n      new_contact_message: () => ({\n        subject: `New Contact Message from ${getData(data, 'name')}`,\n        html: this.wrapTemplate(`\n          <h2>New Contact Message</h2>\n          <p>You have received a new message through the contact form.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Name:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'name')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'email')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Subject:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'subject')}</td>\n            </tr>\n          </table>\n          <div style=\"background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0;\">\n            <strong>Message:</strong>\n            <p style=\"margin-top: 10px;\">${getData(data, 'message')}</p>\n          </div>\n        `),\n      }),\n\n      quotation_request: () => ({\n        subject: `New Quotation Request #${getData(data, 'quotationId')}`,\n        html: this.wrapTemplate(`\n          <h2>New Quotation Request</h2>\n          <p>A new quotation request has been submitted.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Quotation ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'quotationId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Customer:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'itemCount')} item(s)</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/quotations/${getData(data, 'quotationId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Quotation</a></p>\n        `),\n      }),\n\n      payment_received: () => ({\n        subject: `Payment Received for Order #${getData(data, 'orderId')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #16a34a;\">Payment Received</h2>\n          <p>Payment has been successfully received for an order.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Amount:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #16a34a;\"><strong>$${getData(data, 'amount')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Payment Method:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'paymentMethod')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Transaction ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'transactionId')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #16a34a; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      refund_processed: () => ({\n        subject: `Refund Processed for Order #${getData(data, 'orderId')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #f59e0b;\">Refund Processed</h2>\n          <p>A refund has been processed for an order.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Refund Amount:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #f59e0b;\"><strong>$${getData(data, 'amount')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Reason:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'reason')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #f59e0b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n    };\n\n    const templateFn = templates[type];\n    return templateFn ? templateFn() : null;\n  }\n\n  private wrapTemplate(content: string): string {\n    return `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; text-align: center; border-radius: 8px 8px 0 0;\">\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">Lab404 Electronics</h1>\n            <p style=\"color: rgba(255,255,255,0.8); margin: 5px 0 0 0;\">Admin Notification</p>\n          </div>\n          <div style=\"background: white; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px;\">\n            ${content}\n          </div>\n          <div style=\"text-align: center; padding: 20px; color: #6b7280; font-size: 12px;\">\n            <p>This is an automated notification from Lab404 Electronics Admin.</p>\n            <p>&copy; ${new Date().getFullYear()} Lab404 Electronics. All rights reserved.</p>\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * Send quotation email to customer with PDF attachment\n   */\n  async sendQuotationToCustomer(\n    data: QuotationEmailData,\n    pdfBuffer: Buffer\n  ): Promise<boolean> {\n    const formatCurrency = (amount: number, currency: string) => {\n      return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: currency || 'USD',\n      }).format(amount);\n    };\n\n    const formatDate = (date: Date | null) => {\n      if (!date) {return 'No expiration';}\n      return new Date(date).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n      });\n    };\n\n    const html = this.wrapCustomerTemplate(`\n      <h2>Quotation ${data.quotationNumber}</h2>\n      <p>Dear ${data.customerName},</p>\n      <p>Thank you for your interest. Please find attached your quotation from ${data.companyName}.</p>\n\n      <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Quotation Number:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${data.quotationNumber}</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${data.itemCount} item(s)</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Total Amount:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong style=\"color: #2563eb;\">${formatCurrency(data.total, data.currency)}</strong></td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Valid Until:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${formatDate(data.validUntil)}</td>\n        </tr>\n      </table>\n\n      <p>The detailed quotation is attached as a PDF document.</p>\n\n      <p>If you have any questions or would like to proceed with this quotation, please don't hesitate to contact us:</p>\n      <ul style=\"list-style: none; padding: 0;\">\n        ${data.companyEmail ? `<li style=\"padding: 5px 0;\">Email: <a href=\"mailto:${data.companyEmail}\">${data.companyEmail}</a></li>` : ''}\n        ${data.companyPhone ? `<li style=\"padding: 5px 0;\">Phone: ${data.companyPhone}</li>` : ''}\n      </ul>\n\n      <p>We look forward to doing business with you!</p>\n      <p>Best regards,<br/>${data.companyName}</p>\n    `, data.companyName);\n\n    return mailerService.sendEmail({\n      to: data.customerEmail,\n      subject: `Quotation ${data.quotationNumber} from ${data.companyName}`,\n      html,\n      attachments: [\n        {\n          filename: `${data.quotationNumber}.pdf`,\n          content: pdfBuffer,\n          contentType: 'application/pdf',\n        },\n      ],\n    });\n  }\n\n  private wrapCustomerTemplate(content: string, companyName: string): string {\n    return `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; text-align: center; border-radius: 8px 8px 0 0;\">\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">${companyName}</h1>\n          </div>\n          <div style=\"background: white; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px;\">\n            ${content}\n          </div>\n          <div style=\"text-align: center; padding: 20px; color: #6b7280; font-size: 12px;\">\n            <p>&copy; ${new Date().getFullYear()} ${companyName}. All rights reserved.</p>\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * Send verification code email\n   */\n  async sendVerificationCode(data: {\n    email: string;\n    code: string;\n    type: 'password_reset' | 'email_verification' | 'account_unlock';\n    expiryMinutes: number;\n  }): Promise<boolean> {\n    const { email, code, type, expiryMinutes } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    // Subject based on type\n    const subjects = {\n      password_reset: 'Password Reset Verification Code',\n      email_verification: 'Email Verification Code',\n      account_unlock: 'Account Unlock Verification Code',\n    };\n    const subject = subjects[type];\n\n    // Title based on type\n    const titles = {\n      password_reset: 'Reset Your Password',\n      email_verification: 'Verify Your Email',\n      account_unlock: 'Unlock Your Account',\n    };\n    const title = titles[type];\n\n    const html = this.wrapCustomerTemplate(`\n      <h2 style=\"color: #1f2937; margin-bottom: 24px;\">${title}</h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        Your verification code is:\n      </p>\n\n      <div style=\"text-align: center; margin: 30px 0;\">\n        <div style=\"display: inline-block; background: #f3f4f6; padding: 20px 40px; border-radius: 8px; border: 2px dashed #d1d5db;\">\n          <span style=\"font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #1f2937; font-family: 'Courier New', monospace;\">\n            ${code}\n          </span>\n        </div>\n      </div>\n\n      <p style=\"color: #dc2626; font-weight: bold; font-size: 14px; margin: 20px 0;\">\n         This code will expire in ${expiryMinutes} minutes.\n      </p>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        If you didn't request this code, please ignore this email or contact our support team if you have concerns.\n      </p>\n    `, companyName);\n\n    logger.info('Sending verification code email', { email, type });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject,\n      html,\n    });\n  }\n\n  /**\n   * Send password changed confirmation email\n   * Notifies user of successful password change with timestamp and IP\n   */\n  async sendPasswordChangedConfirmation(data: {\n    email: string;\n    firstName: string | null;\n    timestamp: Date;\n    ipAddress?: string;\n  }): Promise<boolean> {\n    const { email, firstName, timestamp, ipAddress } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    // Format timestamp for display\n    const formattedTimestamp = timestamp.toLocaleString('en-US', {\n      month: 'long',\n      day: 'numeric',\n      year: 'numeric',\n      hour: 'numeric',\n      minute: '2-digit',\n      timeZoneName: 'short'\n    });\n\n    const greeting = firstName ? `Hello ${firstName},` : 'Hello,';\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <div style=\"display: inline-block; background: #16a34a; color: white; width: 48px; height: 48px; border-radius: 50%; line-height: 48px; font-size: 24px; margin-bottom: 16px;\">\n          \n        </div>\n      </div>\n\n      <h2 style=\"color: #1f2937; margin-bottom: 24px; text-align: center;\">\n        Password Changed Successfully\n      </h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        ${greeting}\n      </p>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        Your password was successfully changed on <strong>${formattedTimestamp}</strong>.\n      </p>\n\n      ${ipAddress ? `\n        <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 24px 0; border-left: 4px solid #2563eb;\">\n          <p style=\"margin: 0; color: #6b7280; font-size: 14px;\">\n            <strong>Security Details:</strong><br>\n            From IP address: <code style=\"background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace;\">${ipAddress}</code>\n          </p>\n        </div>\n      ` : ''}\n\n      <div style=\"background: #fef2f2; border: 1px solid #fecaca; padding: 20px; border-radius: 8px; margin: 30px 0;\">\n        <p style=\"color: #dc2626; font-weight: bold; font-size: 16px; margin: 0 0 12px 0;\">\n           Did you make this change?\n        </p>\n        <p style=\"color: #991b1b; font-size: 14px; line-height: 20px; margin: 0;\">\n          If you did not change your password, please contact our support team immediately to secure your account.\n        </p>\n      </div>\n\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"mailto:contact@lab404electronics.com?subject=Unauthorized%20Password%20Change\"\n           style=\"display: inline-block; background: #2563eb; color: white; text-decoration: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; font-size: 16px;\">\n          Contact Support\n        </a>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        For security reasons, we recommend using a strong, unique password and enabling two-factor authentication when available.\n      </p>\n    `, companyName);\n\n    logger.info('Sending password changed confirmation email', { email });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject: `Your Password Was Changed - ${companyName}`,\n      html,\n    });\n  }\n\n  /**\n   * Send email verification code for new account registration\n   * Welcomes user and provides 6-digit verification code\n   */\n  async sendEmailVerification(data: {\n    email: string;\n    firstName: string | null;\n    code: string;\n    expiryMinutes: number;\n  }): Promise<boolean> {\n    const { email, firstName, code, expiryMinutes } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    const greeting = firstName ? `Hello ${firstName},` : 'Hello,';\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <div style=\"display: inline-block; background: #2563eb; color: white; width: 48px; height: 48px; border-radius: 50%; line-height: 48px; font-size: 24px; margin-bottom: 16px;\">\n          \n        </div>\n      </div>\n\n      <h2 style=\"color: #1f2937; margin-bottom: 24px; text-align: center;\">\n        Welcome to ${companyName}!\n      </h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        ${greeting}\n      </p>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 30px;\">\n        Thank you for creating an account with us. To complete your registration and activate your account, please verify your email address using the code below.\n      </p>\n\n      <div style=\"background: #eff6ff; border: 2px solid #2563eb; padding: 24px; border-radius: 8px; margin: 30px 0; text-align: center;\">\n        <p style=\"color: #1e40af; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;\">\n          Your Verification Code\n        </p>\n        <p style=\"color: #1e3a8a; font-size: 36px; font-weight: bold; letter-spacing: 8px; margin: 0; font-family: 'Courier New', monospace;\">\n          ${code}\n        </p>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-bottom: 20px; text-align: center;\">\n        This code will expire in <strong>${expiryMinutes} minutes</strong>.\n      </p>\n\n      <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 24px 0;\">\n        <p style=\"margin: 0; color: #6b7280; font-size: 14px; line-height: 20px;\">\n          <strong>Didn't create an account?</strong><br>\n          If you didn't request this verification code, you can safely ignore this email. Your email address will not be used without verification.\n        </p>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        Need help? Contact our support team at <a href=\"mailto:contact@lab404electronics.com\" style=\"color: #2563eb; text-decoration: none;\">contact@lab404electronics.com</a>\n      </p>\n    `, companyName);\n\n    logger.info('Sending email verification code', { email });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject: `Verify Your Email Address - ${companyName}`,\n      html,\n    });\n  }\n\n  /**\n   * Send quotation expiry reminder to customer\n   */\n  async sendQuotationExpiryReminder(\n    customerEmail: string,\n    customerName: string,\n    quotationNumber: string,\n    daysUntilExpiry: number,\n    expiryDate: Date,\n    acceptanceToken?: string\n  ): Promise<boolean> {\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n    const websiteUrl = process.env['WEBSITE_URL'] || 'https://lab404electronics.com';\n\n    const formatDate = (date: Date) => {\n      return new Date(date).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n      });\n    };\n\n    const urgencyColor = daysUntilExpiry <= 1 ? '#dc2626' : daysUntilExpiry <= 3 ? '#f59e0b' : '#3b82f6';\n    const urgencyText = daysUntilExpiry <= 1 ? 'Expires Tomorrow!' : `Expires in ${daysUntilExpiry} Days`;\n\n    const viewLink = acceptanceToken\n      ? `${websiteUrl}/quotations/view/${acceptanceToken}`\n      : null;\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; padding: 20px 0;\">\n        <span style=\"background: ${urgencyColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px;\">\n          ${urgencyText}\n        </span>\n      </div>\n\n      <h2>Quotation Expiry Reminder</h2>\n      <p>Dear ${customerName},</p>\n      <p>This is a friendly reminder that your quotation <strong>${quotationNumber}</strong> will expire on <strong style=\"color: ${urgencyColor};\">${formatDate(expiryDate)}</strong>.</p>\n\n      <div style=\"background: #f8fafc; border-left: 4px solid ${urgencyColor}; padding: 15px; margin: 20px 0;\">\n        <p style=\"margin: 0;\"><strong>Don't miss out!</strong> Review and accept your quotation before it expires to secure your pricing.</p>\n      </div>\n\n      ${viewLink ? `\n        <p style=\"text-align: center; margin: 30px 0;\">\n          <a href=\"${viewLink}\" style=\"background: #2563eb; color: white; padding: 14px 28px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;\">\n            View & Accept Quotation\n          </a>\n        </p>\n      ` : ''}\n\n      <p>If you have any questions or need to discuss the quotation, please don't hesitate to contact us.</p>\n\n      <p>Best regards,<br/>${companyName}</p>\n    `, companyName);\n\n    return mailerService.sendEmail({\n      to: customerEmail,\n      subject: `${urgencyText}: Quotation ${quotationNumber} - ${companyName}`,\n      html,\n    });\n  }\n}\n\nexport const notificationService = new NotificationService();\n","import bcrypt from 'bcryptjs';\nimport zxcvbn from 'zxcvbn';\nimport { getDb, passwordHistory, eq, desc, NewPasswordHistory } from '@lab404/database';\nimport { HIBPService } from './hibp.service';\n\n/**\n * Password Security Service\n *\n * Handles password strength calculation, history tracking, and breach checking.\n * Enforces password reuse prevention and provides feedback on password quality.\n */\n\ninterface PasswordStrengthResult {\n  score: number; // 0-4 (zxcvbn scale)\n  feedback: {\n    warning: string;\n    suggestions: string[];\n  };\n  crackTime: string; // Human-readable crack time estimate\n  isBreached: boolean;\n  breachCount: number;\n  isReused: boolean;\n}\n\ninterface PasswordValidationResult {\n  isValid: boolean;\n  errors: string[];\n  strengthResult?: PasswordStrengthResult;\n}\n\nexport class PasswordSecurityService {\n  private static readonly HISTORY_LIMIT = 10; // Store last 10 passwords\n  private static readonly MIN_STRENGTH_SCORE = 2; // Require at least score 2 (fair)\n\n  /**\n   * Calculate password strength using zxcvbn\n   *\n   * @param password - Plain text password\n   * @param userInputs - Optional array of user-specific strings (email, name, etc.)\n   * @returns Strength analysis\n   */\n  static async calculateStrength(\n    password: string,\n    userInputs?: string[]\n  ): Promise<Omit<PasswordStrengthResult, 'isBreached' | 'breachCount' | 'isReused'>> {\n    const result = zxcvbn(password, userInputs);\n\n    return {\n      score: result.score,\n      feedback: {\n        warning: result.feedback.warning || '',\n        suggestions: result.feedback.suggestions || [],\n      },\n      crackTime: String(result.crack_times_display.offline_slow_hashing_1e4_per_second),\n    };\n  }\n\n  /**\n   * Check if password has been used before by this customer\n   *\n   * @param customerId - Customer ID\n   * @param password - Plain text password to check\n   * @returns True if password was used before\n   */\n  static async checkPasswordHistory(\n    customerId: string,\n    password: string\n  ): Promise<boolean> {\n    try {\n      const db = getDb();\n\n      // Get last N password hashes\n      const history = await db\n        .select()\n        .from(passwordHistory)\n        .where(eq(passwordHistory.customerId, customerId))\n        .orderBy(desc(passwordHistory.changedAt))\n        .limit(this.HISTORY_LIMIT);\n\n      // Check if new password matches any previous hash\n      for (const entry of history) {\n        const matches = await bcrypt.compare(password, entry.passwordHash);\n        if (matches) {\n          return true; // Password was used before\n        }\n      }\n\n      return false;\n    } catch (error) {\n      // Table doesn't exist or query failed - skip history check\n      console.warn('Failed to check password history (table may not exist):', error);\n      return false; // Allow password since we can't verify history\n    }\n  }\n\n  /**\n   * Record password change in history\n   *\n   * @param data - Password history entry data\n   */\n  static async recordPasswordChange(data: NewPasswordHistory): Promise<void> {\n    try {\n      const db = getDb();\n\n      await db.insert(passwordHistory).values(data);\n\n      // Keep only last N passwords\n      const allHistory = await db\n        .select()\n        .from(passwordHistory)\n        .where(eq(passwordHistory.customerId, data.customerId))\n        .orderBy(desc(passwordHistory.changedAt));\n\n      if (allHistory.length > this.HISTORY_LIMIT) {\n        const idsToDelete = allHistory\n          .slice(this.HISTORY_LIMIT)\n          .map((entry) => entry.id);\n\n        if (idsToDelete.length > 0 && idsToDelete[0]) {\n          await db\n            .delete(passwordHistory)\n            .where(eq(passwordHistory.id, idsToDelete[0])); // Simplified for demo\n        }\n      }\n    } catch (error) {\n      // Table doesn't exist or insert failed - non-critical, just log warning\n      // Password change will still succeed, history just won't be recorded\n      console.warn('Failed to record password change (table may not exist):', error);\n      // Don't throw - allow password change to succeed\n    }\n  }\n\n  /**\n   * Validate password with comprehensive checks\n   *\n   * @param password - Plain text password\n   * @param customerId - Customer ID\n   * @param userInputs - Optional array of user-specific strings\n   * @returns Validation result with detailed feedback\n   */\n  static async validatePassword(\n    password: string,\n    customerId: string,\n    userInputs?: string[]\n  ): Promise<PasswordValidationResult> {\n    const errors: string[] = [];\n\n    // Basic length check\n    if (password.length < 8) {\n      errors.push(' Password Length: Must be at least 8 characters long. Current length: ' + password.length);\n    }\n\n    if (password.length > 100) {\n      errors.push(' Password Length: Must not exceed 100 characters. Current length: ' + password.length);\n    }\n\n    // Calculate strength\n    const strength = await this.calculateStrength(password, userInputs);\n\n    if (strength.score < this.MIN_STRENGTH_SCORE) {\n      const warningText = strength.feedback.warning || 'This password is too predictable.';\n      errors.push(\n        ` Password Strength: Your password is too weak (${strength.score}/4). ${warningText}`\n      );\n      if (strength.feedback.suggestions.length > 0) {\n        errors.push(` Suggestions: ${strength.feedback.suggestions.join(' ')}`);\n      }\n    }\n\n    // Check breach status\n    const breachResult = await HIBPService.checkPassword(password, customerId);\n\n    if (breachResult.isBreached) {\n      const breachText = breachResult.breachCount > 1000\n        ? `${(breachResult.breachCount / 1000).toFixed(1)}k+`\n        : breachResult.breachCount.toString();\n\n      errors.push(\n        ` Security Alert: This password has been exposed in ${breachText} data breaches and is not safe to use. Please choose a unique password that you haven't used elsewhere.`\n      );\n    }\n\n    // Check password history\n    const isReused = await this.checkPasswordHistory(customerId, password);\n\n    if (isReused) {\n      errors.push(' Password History: You\\'ve used this password before. For security, please choose a new password you haven\\'t used on this account.');\n    }\n\n    // Build complete strength result\n    const strengthResult: PasswordStrengthResult = {\n      ...strength,\n      isBreached: breachResult.isBreached,\n      breachCount: breachResult.breachCount,\n      isReused,\n    };\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n      strengthResult,\n    };\n  }\n\n  /**\n   * Validate password without checking history (for new users)\n   *\n   * @param password - Plain text password\n   * @param userInputs - Optional array of user-specific strings\n   * @returns Validation result\n   */\n  static async validateNewPassword(\n    password: string,\n    userInputs?: string[]\n  ): Promise<PasswordValidationResult> {\n    const errors: string[] = [];\n\n    // Basic length check\n    if (password.length < 8) {\n      errors.push(' Password Length: Must be at least 8 characters long. Current length: ' + password.length);\n    }\n\n    if (password.length > 100) {\n      errors.push(' Password Length: Must not exceed 100 characters. Current length: ' + password.length);\n    }\n\n    // Calculate strength\n    const strength = await this.calculateStrength(password, userInputs);\n\n    if (strength.score < this.MIN_STRENGTH_SCORE) {\n      const warningText = strength.feedback.warning || 'This password is too predictable.';\n      errors.push(\n        ` Password Strength: Your password is too weak (${strength.score}/4). ${warningText}`\n      );\n      if (strength.feedback.suggestions.length > 0) {\n        errors.push(` Suggestions: ${strength.feedback.suggestions.join(' ')}`);\n      }\n    }\n\n    // Check breach status (no customer ID for caching)\n    const breachResult = await HIBPService.checkPassword(password);\n\n    if (breachResult.isBreached) {\n      const breachText = breachResult.breachCount > 1000\n        ? `${(breachResult.breachCount / 1000).toFixed(1)}k+`\n        : breachResult.breachCount.toString();\n\n      errors.push(\n        ` Security Alert: This password has been exposed in ${breachText} data breaches and is not safe to use. Please choose a unique password that you haven't used elsewhere.`\n      );\n    }\n\n    const strengthResult: PasswordStrengthResult = {\n      ...strength,\n      isBreached: breachResult.isBreached,\n      breachCount: breachResult.breachCount,\n      isReused: false,\n    };\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n      strengthResult,\n    };\n  }\n}\n","import crypto from 'crypto';\nimport { getDb, breachChecks, eq, and } from '@lab404/database';\n\n/**\n * Have I Been Pwned (HIBP) Service\n *\n * Checks passwords against the HIBP Pwned Passwords API using k-anonymity.\n * This ensures password privacy by only sending the first 5 characters of the SHA-1 hash.\n *\n * API Documentation: https://haveibeenpwned.com/API/v3#PwnedPasswords\n */\n\ninterface BreachCheckResult {\n  isBreached: boolean;\n  breachCount: number;\n  cached: boolean;\n}\n\nexport class HIBPService {\n  private static readonly HIBP_API_URL = 'https://api.pwnedpasswords.com/range';\n  private static readonly CACHE_DURATION_DAYS = 30;\n\n  /**\n   * Check if a password has been found in data breaches\n   * Uses k-anonymity to protect password privacy\n   *\n   * @param password - Plain text password to check\n   * @param customerId - Optional customer ID for caching\n   * @returns Breach status and count\n   */\n  static async checkPassword(\n    password: string,\n    customerId?: string\n  ): Promise<BreachCheckResult> {\n    // Generate SHA-1 hash of password\n    const hash = crypto.createHash('sha1').update(password).digest('hex').toUpperCase();\n    const hashPrefix = hash.substring(0, 5);\n    const hashSuffix = hash.substring(5);\n\n    // Check cache first if customer ID provided\n    if (customerId) {\n      const cachedResult = await this.getCachedResult(customerId, hashPrefix);\n      if (cachedResult) {\n        return cachedResult;\n      }\n    }\n\n    // Query HIBP API with hash prefix (k-anonymity)\n    try {\n      const response = await fetch(`${this.HIBP_API_URL}/${hashPrefix}`, {\n        headers: {\n          'User-Agent': 'Lab404-Electronics-Auth-System',\n        },\n      });\n\n      if (!response.ok) {\n        // If HIBP is down, gracefully degrade (allow password but log warning)\n        console.warn(`HIBP API returned ${response.status}, allowing password by default`);\n        return { isBreached: false, breachCount: 0, cached: false };\n      }\n\n      const body = await response.text();\n      const lines = body.split('\\n');\n\n      // Check if our hash suffix appears in the results\n      let breachCount = 0;\n      for (const line of lines) {\n        const parts = line.split(':');\n        const suffix = parts[0];\n        const count = parts[1];\n        if (suffix && suffix.trim() === hashSuffix) {\n          breachCount = parseInt(count?.trim() || '0', 10);\n          break;\n        }\n      }\n\n      const result: BreachCheckResult = {\n        isBreached: breachCount > 0,\n        breachCount,\n        cached: false,\n      };\n\n      // Cache result if customer ID provided\n      if (customerId) {\n        await this.setCachedResult(customerId, hashPrefix, result);\n      }\n\n      return result;\n    } catch (error) {\n      // Network error or API unavailable - gracefully degrade\n      console.error('HIBP API check failed:', error);\n      return { isBreached: false, breachCount: 0, cached: false };\n    }\n  }\n\n  /**\n   * Get cached breach check result\n   *\n   * @param customerId - Customer ID\n   * @param hashPrefix - First 5 characters of SHA-1 hash\n   * @returns Cached result if valid, null otherwise\n   */\n  private static async getCachedResult(\n    customerId: string,\n    hashPrefix: string\n  ): Promise<BreachCheckResult | null> {\n    try {\n      const db = getDb();\n\n      const cached = await db\n        .select()\n        .from(breachChecks)\n        .where(\n          and(\n            eq(breachChecks.customerId, customerId),\n            eq(breachChecks.passwordHashPrefix, hashPrefix)\n          )\n        )\n        .limit(1);\n\n      const check = cached[0];\n      if (!check) {\n        return null;\n      }\n\n      // Check if cache is still valid\n      if (new Date() > check.expiresAt) {\n        return null;\n      }\n\n      return {\n        isBreached: check.isBreached,\n        breachCount: check.breachCount,\n        cached: true,\n      };\n    } catch (error) {\n      // Table doesn't exist or query failed - skip cache\n      console.warn('Failed to get cached breach check result:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Cache breach check result\n   *\n   * @param customerId - Customer ID\n   * @param hashPrefix - First 5 characters of SHA-1 hash\n   * @param result - Breach check result to cache\n   */\n  private static async setCachedResult(\n    customerId: string,\n    hashPrefix: string,\n    result: BreachCheckResult\n  ): Promise<void> {\n    try {\n      const db = getDb();\n\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + this.CACHE_DURATION_DAYS);\n\n      await db.insert(breachChecks).values({\n        customerId,\n        passwordHashPrefix: hashPrefix,\n        isBreached: result.isBreached,\n        breachCount: result.breachCount,\n        expiresAt,\n        checkReason: 'password_change',\n      });\n    } catch (error) {\n      // Cache insertion failed or table doesn't exist - non-critical, just log\n      console.warn('Failed to cache HIBP result:', error);\n    }\n  }\n\n  /**\n   * Clean up expired cache entries\n   * Should be called periodically via cron job\n   */\n  static async cleanupExpiredCache(): Promise<number> {\n    const db = getDb();\n\n    try {\n      const result = await db\n        .delete(breachChecks)\n        .where(eq(breachChecks.expiresAt, new Date()));\n\n      return result.rowCount || 0;\n    } catch (error) {\n      console.error('Failed to cleanup expired breach checks:', error);\n      return 0;\n    }\n  }\n}\n","import { getDb, securityAuditLogs, type SecurityAuditLog, type NewSecurityAuditLog, eq, and, gte, lte, inArray, desc, sql } from '@lab404/database';\nimport { Request } from 'express';\nimport type {\n  SecurityEventType,\n  ActorType,\n  EventStatus,\n  AuditLogEvent,\n} from '../types/audit-events';\nimport { logger } from '../utils/logger';\n\n/**\n * Audit Log Service\n *\n * Handles security audit logging for compliance, forensics, and monitoring.\n *\n * Key Features:\n * - Async, non-blocking logging (fire-and-forget)\n * - Automatic context extraction from Express requests\n * - Immutable append-only logs\n * - 90-day retention\n * - Query and export interfaces\n */\nclass AuditLogService {\n  /**\n   * Log a security event\n   *\n   * @param event - The security event to log\n   * @returns Promise<void> - Fire-and-forget, errors are logged but don't throw\n   */\n  async log(event: AuditLogEvent): Promise<void> {\n    try {\n      const db = getDb();\n      const logEntry: NewSecurityAuditLog = {\n        timestamp: new Date(),\n        eventType: event.eventType,\n        actorType: event.actorType,\n        actorId: event.actorId || null,\n        actorEmail: event.actorEmail || null,\n        targetType: event.targetType || null,\n        targetId: event.targetId || null,\n        action: event.action,\n        status: event.status,\n        ipAddress: event.ipAddress || null,\n        userAgent: event.userAgent || null,\n        sessionId: event.sessionId || null,\n        requestId: event.requestId || null,\n        metadata: event.metadata || null,\n        createdAt: new Date(),\n      };\n\n      await db.insert(securityAuditLogs).values(logEntry);\n    } catch (error) {\n      // Log failures don't break requests\n      logger.error('Failed to write audit log', {\n        event,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n    }\n  }\n\n  /**\n   * Log a security event from an Express request\n   *\n   * Automatically extracts context (IP, User-Agent, session, etc.)\n   *\n   * @param req - Express request object\n   * @param event - Partial event (context auto-filled)\n   */\n  async logFromRequest(\n    req: Request,\n    event: Omit<AuditLogEvent, 'ipAddress' | 'userAgent' | 'sessionId' | 'requestId'>\n  ): Promise<void> {\n    const fullEvent: AuditLogEvent = {\n      ...event,\n      ipAddress: this.getClientIp(req),\n      userAgent: req.get('user-agent') || undefined,\n      sessionId: (req as any).user?.sessionId || undefined,\n      requestId: (req as any).id || undefined,\n    };\n\n    await this.log(fullEvent);\n  }\n\n  /**\n   * Query audit logs with filters and pagination\n   *\n   * @param filters - Query filters\n   * @returns Array of audit logs\n   */\n  async query(filters: {\n    actorId?: string;\n    eventTypes?: SecurityEventType[];\n    status?: EventStatus;\n    ipAddress?: string;\n    sessionId?: string;\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n    offset?: number;\n  }): Promise<SecurityAuditLog[]> {\n    try {\n      const db = getDb();\n      const conditions = [];\n\n      if (filters.actorId) {\n        conditions.push(eq(securityAuditLogs.actorId, filters.actorId));\n      }\n\n      if (filters.eventTypes && filters.eventTypes.length > 0) {\n        conditions.push(inArray(securityAuditLogs.eventType, filters.eventTypes));\n      }\n\n      if (filters.status) {\n        conditions.push(eq(securityAuditLogs.status, filters.status));\n      }\n\n      if (filters.ipAddress) {\n        conditions.push(eq(securityAuditLogs.ipAddress, filters.ipAddress));\n      }\n\n      if (filters.sessionId) {\n        conditions.push(eq(securityAuditLogs.sessionId, filters.sessionId));\n      }\n\n      if (filters.startDate) {\n        conditions.push(gte(securityAuditLogs.timestamp, filters.startDate));\n      }\n\n      if (filters.endDate) {\n        conditions.push(lte(securityAuditLogs.timestamp, filters.endDate));\n      }\n\n      const baseQuery = db\n        .select()\n        .from(securityAuditLogs);\n\n      const results = conditions.length > 0\n        ? await baseQuery\n            .where(and(...conditions))\n            .orderBy(desc(securityAuditLogs.timestamp))\n            .limit(filters.limit || 50)\n            .offset(filters.offset || 0)\n        : await baseQuery\n            .orderBy(desc(securityAuditLogs.timestamp))\n            .limit(filters.limit || 50)\n            .offset(filters.offset || 0);\n\n      return results;\n    } catch (error) {\n      logger.error('Failed to query audit logs', {\n        filters,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get a single audit log by ID\n   *\n   * @param id - Audit log ID\n   * @returns Audit log or null\n   */\n  async getById(id: string): Promise<SecurityAuditLog | null> {\n    try {\n      const db = getDb();\n      const results = await db\n        .select()\n        .from(securityAuditLogs)\n        .where(eq(securityAuditLogs.id, id))\n        .limit(1);\n\n      return results[0] || null;\n    } catch (error) {\n      logger.error('Failed to get audit log by ID', {\n        id,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Export audit logs to JSON\n   *\n   * @param filters - Query filters\n   * @returns JSON string of audit logs\n   */\n  async exportToJSON(filters: Parameters<typeof this.query>[0]): Promise<string> {\n    const logs = await this.query({ ...filters, limit: 10000 });\n    return JSON.stringify(logs, null, 2);\n  }\n\n  /**\n   * Export audit logs to CSV\n   *\n   * @param filters - Query filters\n   * @returns CSV string of audit logs\n   */\n  async exportToCSV(filters: Parameters<typeof this.query>[0]): Promise<string> {\n    const logs = await this.query({ ...filters, limit: 10000 });\n\n    if (logs.length === 0) {\n      return 'No logs found';\n    }\n\n    // CSV headers\n    const headers = [\n      'ID',\n      'Timestamp',\n      'Event Type',\n      'Actor Type',\n      'Actor ID',\n      'Actor Email',\n      'Target Type',\n      'Target ID',\n      'Action',\n      'Status',\n      'IP Address',\n      'User Agent',\n      'Session ID',\n      'Request ID',\n      'Metadata',\n    ].join(',');\n\n    // CSV rows\n    const rows = logs.map((log) => {\n      return [\n        log.id,\n        log.timestamp.toISOString(),\n        log.eventType,\n        log.actorType,\n        log.actorId || '',\n        log.actorEmail || '',\n        log.targetType || '',\n        log.targetId || '',\n        log.action,\n        log.status,\n        log.ipAddress || '',\n        log.userAgent ? `\"${log.userAgent.replace(/\"/g, '\"\"')}\"` : '',\n        log.sessionId || '',\n        log.requestId || '',\n        log.metadata ? `\"${JSON.stringify(log.metadata).replace(/\"/g, '\"\"')}\"` : '',\n      ].join(',');\n    });\n\n    return `${headers}\\n${rows.join('\\n')}`;\n  }\n\n  /**\n   * Delete audit logs older than retention period (90 days)\n   *\n   * @returns Number of deleted logs\n   */\n  async cleanup(): Promise<number> {\n    try {\n      const db = getDb();\n      const retentionDays = 90;\n      const cutoffDate = new Date();\n      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\n\n      const deletedLogs = await db\n        .delete(securityAuditLogs)\n        .where(lte(securityAuditLogs.timestamp, cutoffDate))\n        .returning({ id: securityAuditLogs.id });\n\n      logger.info('Audit log cleanup completed', {\n        deletedCount: deletedLogs.length,\n        cutoffDate: cutoffDate.toISOString(),\n      });\n\n      return deletedLogs.length;\n    } catch (error) {\n      logger.error('Failed to cleanup audit logs', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get statistics about audit logs\n   *\n   * @param filters - Optional filters\n   * @returns Statistics object\n   */\n  async getStatistics(filters?: {\n    startDate?: Date;\n    endDate?: Date;\n    actorId?: string;\n  }): Promise<{\n    totalLogs: number;\n    successCount: number;\n    failureCount: number;\n    deniedCount: number;\n    eventTypeCounts: Record<string, number>;\n  }> {\n    try {\n      const db = getDb();\n      const conditions = [];\n\n      if (filters?.startDate) {\n        conditions.push(gte(securityAuditLogs.timestamp, filters.startDate));\n      }\n\n      if (filters?.endDate) {\n        conditions.push(lte(securityAuditLogs.timestamp, filters.endDate));\n      }\n\n      if (filters?.actorId) {\n        conditions.push(eq(securityAuditLogs.actorId, filters.actorId));\n      }\n\n      const baseLogsQuery = db.select().from(securityAuditLogs);\n\n      const logs = conditions.length > 0\n        ? await baseLogsQuery.where(and(...conditions))\n        : await baseLogsQuery;\n\n      const stats = {\n        totalLogs: logs.length,\n        successCount: logs.filter((log) => log.status === 'success').length,\n        failureCount: logs.filter((log) => log.status === 'failure').length,\n        deniedCount: logs.filter((log) => log.status === 'denied').length,\n        eventTypeCounts: logs.reduce(\n          (acc, log) => {\n            acc[log.eventType] = (acc[log.eventType] || 0) + 1;\n            return acc;\n          },\n          {} as Record<string, number>\n        ),\n      };\n\n      return stats;\n    } catch (error) {\n      logger.error('Failed to get audit log statistics', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get client IP address from request\n   *\n   * Handles X-Forwarded-For header for proxies\n   *\n   * @param req - Express request\n   * @returns IP address\n   */\n  private getClientIp(req: Request): string {\n    const forwardedFor = req.get('x-forwarded-for');\n    if (forwardedFor) {\n      const firstIp = forwardedFor.split(',')[0];\n      return firstIp?.trim() || 'unknown';\n    }\n    return req.ip || req.socket.remoteAddress || 'unknown';\n  }\n}\n\nexport const auditLogService = new AuditLogService();\n","/**\n * Security Audit Event Types\n *\n * Comprehensive enum of all security-relevant events for audit logging.\n * Used by AuditLogService to categorize and track security events.\n */\n\nexport enum SecurityEventType {\n  // Authentication Events\n  AUTH_LOGIN_SUCCESS = 'auth.login.success',\n  AUTH_LOGIN_FAILURE = 'auth.login.failure',\n  AUTH_LOGIN_LOCKED = 'auth.login.locked',\n  AUTH_LOGOUT = 'auth.logout',\n  AUTH_SESSION_CREATED = 'auth.session.created',\n  AUTH_SESSION_REVOKED = 'auth.session.revoked',\n\n  // Password Events\n  PASSWORD_CHANGED = 'password.changed',\n  PASSWORD_RESET_REQUESTED = 'password.reset.requested',\n  PASSWORD_RESET_COMPLETED = 'password.reset.completed',\n  PASSWORD_BREACH_DETECTED = 'password.breach.detected',\n  PASSWORD_REUSE_BLOCKED = 'password.reuse.blocked',\n\n  // Account Management Events\n  ACCOUNT_CREATED = 'account.created',\n  ACCOUNT_VERIFIED = 'account.verified',\n  ACCOUNT_LOCKED = 'account.locked',\n  ACCOUNT_UNLOCKED = 'account.unlocked',\n  ACCOUNT_DISABLED = 'account.disabled',\n  EMAIL_CHANGED = 'email.changed',\n  EMAIL_VERIFICATION_SENT = 'email.verification.sent',\n\n  // Authorization Events\n  PERMISSION_DENIED = 'permission.denied',\n  ADMIN_ACCESS_GRANTED = 'admin.access.granted',\n  ADMIN_ACTION = 'admin.action.performed',\n\n  // Security Events\n  RATE_LIMIT_EXCEEDED = 'rate_limit.exceeded',\n  SUSPICIOUS_ACTIVITY = 'suspicious_activity.detected',\n}\n\nexport enum ActorType {\n  CUSTOMER = 'customer',\n  ADMIN = 'admin',\n  SYSTEM = 'system',\n}\n\nexport enum EventStatus {\n  SUCCESS = 'success',\n  FAILURE = 'failure',\n  DENIED = 'denied',\n}\n\nexport interface AuditLogEvent {\n  eventType: SecurityEventType;\n  actorType: ActorType;\n  actorId?: string;\n  actorEmail?: string;\n  targetType?: string;\n  targetId?: string;\n  action: string;\n  status: EventStatus;\n  ipAddress?: string;\n  userAgent?: string;\n  sessionId?: string;\n  requestId?: string;\n  metadata?: Record<string, any>;\n}\n","import { getDb, loginAttempts, customers, eq, desc, and, gte, NewLoginAttempt } from '@lab404/database';\nimport { auditLogService } from './audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\n\n/**\n * Login Attempt Service\n *\n * Tracks login attempts and manages account lockouts.\n * Implements exponential backoff and automatic lockout after repeated failures.\n */\n\ninterface LockoutStatus {\n  isLocked: boolean;\n  lockoutEndTime?: Date;\n  consecutiveFailures: number;\n  remainingTime?: number; // milliseconds\n}\n\ninterface DeviceInfo {\n  deviceType?: string;\n  deviceBrowser?: string;\n  ipAddress: string;\n  userAgent?: string;\n  ipCountry?: string;\n  ipCity?: string;\n}\n\nexport class LoginAttemptService {\n  private static readonly MAX_ATTEMPTS = 5; // Lock after 5 failures\n  private static readonly LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutes\n  private static readonly ATTEMPT_WINDOW_MS = 30 * 60 * 1000; // 30-minute window for counting attempts\n\n  /**\n   * Record a login attempt\n   *\n   * @param email - Email address attempted\n   * @param success - Whether login was successful\n   * @param customerId - Customer ID (if successful)\n   * @param failureReason - Reason for failure (if unsuccessful)\n   * @param deviceInfo - Device and network information\n   */\n  static async recordAttempt(\n    email: string,\n    success: boolean,\n    customerId: string | null,\n    failureReason: string | null,\n    deviceInfo: DeviceInfo\n  ): Promise<void> {\n    const db = getDb();\n\n    // Get consecutive failures in the attempt window\n    const recentFailures = await this.getRecentFailures(email);\n    const consecutiveFailures = success ? 0 : recentFailures + 1;\n\n    // Check if this attempt triggers a lockout\n    const triggeredLockout = !success && consecutiveFailures >= this.MAX_ATTEMPTS;\n\n    // Record the attempt\n    const attemptData: NewLoginAttempt = {\n      customerId: customerId || undefined,\n      email,\n      success,\n      failureReason: failureReason || undefined,\n      ipAddress: deviceInfo.ipAddress,\n      userAgent: deviceInfo.userAgent,\n      deviceType: deviceInfo.deviceType,\n      deviceBrowser: deviceInfo.deviceBrowser,\n      ipCountry: deviceInfo.ipCountry,\n      ipCity: deviceInfo.ipCity,\n      triggeredLockout,\n      consecutiveFailures,\n    };\n\n    await db.insert(loginAttempts).values(attemptData);\n\n    // If lockout triggered and we have a customer ID, update customer record\n    if (triggeredLockout && customerId) {\n      await this.lockAccount(customerId);\n    }\n  }\n\n  /**\n   * Check if an account is currently locked\n   *\n   * @param email - Email address to check\n   * @returns Lockout status\n   */\n  static async checkLockoutStatus(email: string): Promise<LockoutStatus> {\n    const db = getDb();\n\n    // Get the most recent lockout trigger\n    const recentAttempts = await db\n      .select()\n      .from(loginAttempts)\n      .where(\n        and(\n          eq(loginAttempts.email, email),\n          eq(loginAttempts.triggeredLockout, true)\n        )\n      )\n      .orderBy(desc(loginAttempts.attemptedAt))\n      .limit(1);\n\n    const lastLockout = recentAttempts[0];\n    if (!lastLockout) {\n      return {\n        isLocked: false,\n        consecutiveFailures: await this.getRecentFailures(email),\n      };\n    }\n\n    const lockoutEndTime = new Date(\n      lastLockout.attemptedAt.getTime() + this.LOCKOUT_DURATION_MS\n    );\n    const now = new Date();\n\n    // Check if lockout has expired\n    if (now >= lockoutEndTime) {\n      return {\n        isLocked: false,\n        consecutiveFailures: 0, // Reset after lockout expires\n      };\n    }\n\n    return {\n      isLocked: true,\n      lockoutEndTime,\n      consecutiveFailures: lastLockout.consecutiveFailures,\n      remainingTime: lockoutEndTime.getTime() - now.getTime(),\n    };\n  }\n\n  /**\n   * Get count of recent failed attempts in the attempt window\n   *\n   * @param email - Email address\n   * @returns Number of consecutive failures\n   */\n  private static async getRecentFailures(email: string): Promise<number> {\n    const db = getDb();\n    const windowStart = new Date(Date.now() - this.ATTEMPT_WINDOW_MS);\n\n    const recentAttempts = await db\n      .select()\n      .from(loginAttempts)\n      .where(\n        and(\n          eq(loginAttempts.email, email),\n          gte(loginAttempts.attemptedAt, windowStart)\n        )\n      )\n      .orderBy(desc(loginAttempts.attemptedAt));\n\n    // Count consecutive failures from most recent\n    let failures = 0;\n    for (const attempt of recentAttempts) {\n      if (attempt.success) {\n        break; // Stop at first success\n      }\n      failures++;\n    }\n\n    return failures;\n  }\n\n  /**\n   * Clear failed attempts after successful login\n   *\n   * @param email - Email address\n   */\n  static async clearFailedAttempts(email: string): Promise<void> {\n    // Successful login is recorded, which breaks the consecutive failure chain\n    // No need to delete old attempts - they provide audit trail\n    // The getRecentFailures() method will return 0 after a successful login\n\n    // However, we should unlock the customer account if it was locked\n    const db = getDb();\n    const customer = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.email, email))\n      .limit(1);\n\n    const foundCustomer = customer[0];\n    if (foundCustomer && foundCustomer.accountLocked) {\n      await db\n        .update(customers)\n        .set({\n          accountLocked: false,\n          accountLockedAt: null,\n          accountLockedReason: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, foundCustomer.id));\n    }\n  }\n\n  /**\n   * Lock a customer account\n   *\n   * @param customerId - Customer ID to lock\n   */\n  private static async lockAccount(customerId: string): Promise<void> {\n    const db = getDb();\n\n    // Get customer email for audit logging\n    const [customer] = await db\n      .select({ email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, customerId))\n      .limit(1);\n\n    await db\n      .update(customers)\n      .set({\n        accountLocked: true,\n        accountLockedAt: new Date(),\n        accountLockedReason: 'Too many failed login attempts',\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, customerId));\n\n    // Log account locked event\n    if (customer) {\n      await auditLogService.log({\n        eventType: SecurityEventType.ACCOUNT_LOCKED,\n        actorType: ActorType.SYSTEM,\n        actorId: customerId,\n        actorEmail: customer.email,\n        action: 'account_lockout',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          reason: 'too_many_failed_attempts',\n          lockoutDuration: '15_minutes',\n        },\n      });\n    }\n  }\n\n  /**\n   * Get login attempt history for a customer\n   *\n   * @param customerId - Customer ID\n   * @param limit - Maximum number of attempts to return\n   * @returns Array of login attempts\n   */\n  static async getAttemptHistory(\n    customerId: string,\n    limit: number = 50\n  ): Promise<typeof loginAttempts.$inferSelect[]> {\n    const db = getDb();\n\n    return await db\n      .select()\n      .from(loginAttempts)\n      .where(eq(loginAttempts.customerId, customerId))\n      .orderBy(desc(loginAttempts.attemptedAt))\n      .limit(limit);\n  }\n\n  /**\n   * Admin: Unlock a customer account\n   *\n   * @param customerId - Customer ID to unlock\n   */\n  static async unlockAccount(customerId: string): Promise<void> {\n    const db = getDb();\n\n    // Get customer email for audit logging\n    const [customer] = await db\n      .select({ email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, customerId))\n      .limit(1);\n\n    await db\n      .update(customers)\n      .set({\n        accountLocked: false,\n        accountLockedAt: null,\n        accountLockedReason: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, customerId));\n\n    // Log account unlocked event\n    if (customer) {\n      await auditLogService.log({\n        eventType: SecurityEventType.ACCOUNT_UNLOCKED,\n        actorType: ActorType.ADMIN,\n        targetType: 'customer',\n        targetId: customerId,\n        action: 'account_unlock',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          method: 'admin_action',\n        },\n      });\n    }\n  }\n\n  /**\n   * Format remaining lockout time for display\n   *\n   * @param milliseconds - Remaining time in milliseconds\n   * @returns Human-readable time string\n   */\n  static formatRemainingTime(milliseconds: number): string {\n    const minutes = Math.ceil(milliseconds / 60000);\n    if (minutes === 1) {\n      return '1 minute';\n    }\n    return `${minutes} minutes`;\n  }\n}\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { sessionService } from '../services/session.service';\nimport { requireAuth } from '../middleware/auth';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { logger } from '../utils/logger';\n\nconst sessionsRoutes = Router();\n\n/**\n * GET /api/auth/sessions\n * List all active sessions for current user\n */\nsessionsRoutes.get(\n  '/',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n      const currentSessionId = req.user?.sessionId;\n\n      if (!customerId) {\n        return sendError(res, 400, 'BAD_REQUEST', 'Customer ID not found');\n      }\n\n      // Get all active sessions\n      const sessions = await sessionService.getActiveSessions(customerId);\n\n      // Add isCurrent flag\n      const sessionsWithCurrent = sessions.map((session) => ({\n        ...session,\n        isCurrent: session.id === currentSessionId,\n      }));\n\n      sendSuccess(res, {\n        sessions: sessionsWithCurrent,\n        currentSessionId,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/auth/sessions/:sessionId\n * Revoke specific session\n */\nsessionsRoutes.delete(\n  '/:sessionId',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { sessionId } = req.params;\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        return sendError(res, 400, 'BAD_REQUEST', 'Customer ID not found');\n      }\n\n      // Verify session belongs to customer\n      const sessions = await sessionService.getActiveSessions(customerId);\n      const session = sessions.find((s) => s.id === sessionId);\n\n      if (!session) {\n        return sendError(res, 404, 'NOT_FOUND', 'Session not found or already revoked');\n      }\n\n      // Revoke session\n      await sessionService.revokeSession(sessionId as string, 'user_action');\n\n      logger.info('Session revoked via API', {\n        sessionId,\n        customerId,\n        deviceName: session.deviceName,\n      });\n\n      sendSuccess(res, { message: 'Session revoked successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/sessions/logout-others\n * Logout all other sessions except current\n */\nsessionsRoutes.post(\n  '/logout-others',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n      const currentSessionId = req.user?.sessionId;\n\n      if (!customerId || !currentSessionId) {\n        return sendError(res, 400, 'BAD_REQUEST', 'Session information not found');\n      }\n\n      const count = await sessionService.revokeOtherSessions(customerId, currentSessionId);\n\n      logger.info('Other sessions revoked', { customerId, count });\n\n      sendSuccess(res, {\n        message: `${count} session(s) logged out successfully`,\n        count,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/sessions/logout-all\n * Logout all sessions including current\n */\nsessionsRoutes.post(\n  '/logout-all',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        return sendError(res, 400, 'BAD_REQUEST', 'Customer ID not found');\n      }\n\n      const count = await sessionService.revokeAllSessions(customerId);\n\n      // Clear current cookie\n      res.clearCookie('auth_token');\n\n      logger.info('All sessions revoked', { customerId, count });\n\n      sendSuccess(res, {\n        message: `All ${count} session(s) logged out successfully`,\n        count,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\nexport { sessionsRoutes };\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, productVariants, eq, ilike, and, or, gte, lte, sql, desc, asc } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin, optionalAuth } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug, generateSku } from '../utils/helpers';\nimport { searchService } from '../services';\nimport { logger } from '../utils/logger';\n\nexport const productsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst productFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  categoryId: z.string().uuid().optional(),\n  categorySlug: z.string().optional(),\n  category: z.string().optional(), // Alias for categorySlug\n  brand: z.string().optional(),\n  status: z.enum(['draft', 'active', 'archived']).optional(),\n  isFeatured: z.enum(['true', 'false']).optional(),\n  minPrice: z.string().optional(),\n  maxPrice: z.string().optional(),\n  inStock: z.enum(['true', 'false']).optional(),\n  sortBy: z.enum(['name', 'basePrice', 'createdAt', 'stockQuantity']).optional(),\n  sortOrder: z.enum(['asc', 'desc']).optional(),\n});\n\nconst createProductSchema = z.object({\n  // Basic info\n  sku: z.string().min(1).max(100).optional(),\n  barcode: z.string().max(100).optional(),\n  name: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  description: z.string().optional(),\n  shortDescription: z.string().max(500).optional(),\n  categoryId: z.string().uuid().optional().nullable(),\n  brand: z.string().max(255).optional(),\n\n  // Pricing\n  basePrice: z.number().positive().max(999999.99),\n  costPrice: z.number().positive().max(999999.99).optional().nullable(),\n  compareAtPrice: z.number().positive().max(999999.99).optional().nullable(),\n\n  // Physical attributes\n  weight: z.number().positive().optional().nullable(),\n  dimensions: z.object({\n    width: z.number().positive().optional(),\n    height: z.number().positive().optional(),\n    depth: z.number().positive().optional(),\n  }).optional().nullable(),\n\n  // Inventory\n  stockQuantity: z.number().int().min(0).optional().default(0),\n  lowStockThreshold: z.number().int().min(0).optional().default(5),\n  trackInventory: z.boolean().optional().default(true),\n  allowBackorder: z.boolean().optional().default(false),\n\n  // Media\n  images: z.array(z.object({\n    url: z.string().url(),\n    alt: z.string().optional(),\n    width: z.number().optional(),\n    height: z.number().optional(),\n  })).optional().default([]),\n  videos: z.array(z.object({\n    url: z.string().url(),\n    title: z.string().optional(),\n  })).optional().default([]),\n  thumbnailUrl: z.string().url().optional().nullable(),\n\n  // Organization & categorization\n  tags: z.array(z.string()).max(20).optional().default([]),\n  specifications: z.record(z.string()).optional().default({}),\n  features: z.array(z.string()).max(20).optional().default([]),\n\n  // SEO\n  metaTitle: z.string().max(255).optional(),\n  metaDescription: z.string().max(500).optional(),\n\n  // Status & flags\n  status: z.enum(['draft', 'active', 'archived']).optional().default('draft'),\n  isFeatured: z.boolean().optional().default(false),\n  isDigital: z.boolean().optional().default(false),\n  requiresShipping: z.boolean().optional().default(true),\n\n  // Supplier\n  supplierId: z.string().max(255).optional(),\n  supplierSku: z.string().max(255).optional(),\n\n  // Import\n  importedFrom: z.string().max(255).optional(),\n  externalUrl: z.string().url().max(500).optional(),\n});\n\nconst updateProductSchema = createProductSchema.partial();\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/products\n * List products with pagination and filters\n */\nproductsRoutes.get('/', validateQuery(productFiltersSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const filters = req.query;\n\n    // Build where conditions\n    const conditions = [];\n\n    // Only show active products for public\n    conditions.push(eq(products.status, 'active'));\n\n    const search = filters['search'] as string | undefined;\n    const categoryId = filters['categoryId'] as string | undefined;\n    // Support both 'category' and 'categorySlug' for filtering by slug\n    const categorySlug = (filters['categorySlug'] || filters['category']) as string | undefined;\n    const brand = filters['brand'] as string | undefined;\n    const minPrice = filters['minPrice'] as string | undefined;\n    const maxPrice = filters['maxPrice'] as string | undefined;\n    const inStock = filters['inStock'] as string | undefined;\n    const isFeatured = filters['isFeatured'] as string | undefined;\n    const sortBy = (filters['sortBy'] as string) || 'createdAt';\n    const sortOrder = (filters['sortOrder'] as string) || 'desc';\n\n    if (search) {\n      conditions.push(\n        or(\n          ilike(products.name, `%${search}%`),\n          ilike(products.sku, `%${search}%`)\n        )\n      );\n    }\n\n    if (categoryId) {\n      conditions.push(eq(products.categoryId, categoryId));\n    }\n\n    // Handle categorySlug filter by looking up the category ID\n    if (categorySlug) {\n      const [cat] = await db.select({ id: categories.id })\n        .from(categories)\n        .where(eq(categories.slug, categorySlug));\n      if (cat) {\n        conditions.push(eq(products.categoryId, cat.id));\n      }\n    }\n\n    // Handle brand filter\n    if (brand) {\n      conditions.push(eq(products.brand, brand));\n    }\n\n    if (minPrice) {\n      conditions.push(gte(products.basePrice, minPrice));\n    }\n\n    if (maxPrice) {\n      conditions.push(lte(products.basePrice, maxPrice));\n    }\n\n    if (inStock === 'true') {\n      conditions.push(\n        or(\n          sql`${products.stockQuantity} > 0`,\n          eq(products.allowBackorder, true)\n        )\n      );\n    }\n\n    if (isFeatured === 'true') {\n      conditions.push(eq(products.isFeatured, true));\n    }\n\n    // Get total count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(products)\n      .where(and(...conditions));\n    const count = countResult[0]?.count ?? 0;\n\n    // Create a mapping of sort columns\n    const sortColumnMap: Record<string, typeof products.name | typeof products.basePrice | typeof products.createdAt | typeof products.stockQuantity> = {\n      name: products.name,\n      basePrice: products.basePrice,\n      createdAt: products.createdAt,\n      stockQuantity: products.stockQuantity,\n    };\n    const sortColumn = sortColumnMap[sortBy] || products.createdAt;\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        name: products.name,\n        slug: products.slug,\n        thumbnailUrl: products.thumbnailUrl,\n        images: products.images,\n        basePrice: products.basePrice,\n        compareAtPrice: products.compareAtPrice,\n        stockQuantity: products.stockQuantity,\n        lowStockThreshold: products.lowStockThreshold,\n        status: products.status,\n        isFeatured: products.isFeatured,\n        categoryId: products.categoryId,\n        categoryName: categories.name,\n        categorySlug: categories.slug,\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.categoryId, categories.id))\n      .where(and(...conditions))\n      .orderBy(sortOrder === 'desc' ? desc(sortColumn) : asc(sortColumn))\n      .limit(limit)\n      .offset(offset);\n\n    // Add computed inStock field, category object, and ensure images is an array\n    const productsWithStock = productList.map(p => ({\n      ...p,\n      basePrice: Number(p.basePrice),\n      compareAtPrice: p.compareAtPrice ? Number(p.compareAtPrice) : undefined,\n      images: p.images || [],\n      inStock: p.stockQuantity > 0,\n      category: p.categoryId && p.categoryName ? {\n        id: p.categoryId,\n        name: p.categoryName,\n        slug: p.categorySlug,\n      } : null,\n    }));\n\n    sendSuccess(res, productsWithStock, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/featured\n * Get featured products\n */\nproductsRoutes.get('/featured', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const limit = Math.min(20, parseInt(req.query['limit'] as string || '8', 10));\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        name: products.name,\n        slug: products.slug,\n        thumbnailUrl: products.thumbnailUrl,\n        basePrice: products.basePrice,\n        compareAtPrice: products.compareAtPrice,\n        stockQuantity: products.stockQuantity,\n      })\n      .from(products)\n      .where(and(eq(products.status, 'active'), eq(products.isFeatured, true)))\n      .orderBy(desc(products.createdAt))\n      .limit(limit);\n\n    const productsWithStock = productList.map(p => ({\n      ...p,\n      basePrice: Number(p.basePrice),\n      compareAtPrice: p.compareAtPrice ? Number(p.compareAtPrice) : undefined,\n      inStock: p.stockQuantity > 0,\n    }));\n\n    sendSuccess(res, productsWithStock);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/:productId/variants\n * Get all variants for a product\n */\nproductsRoutes.get('/:productId/variants', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const productId = req.params['productId'] as string;\n\n    // Validate UUID format\n    if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(productId)) {\n      // Not a UUID, pass to next route (slug handler)\n      return next();\n    }\n\n    // Check if product exists\n    const [product] = await db\n      .select({ id: products.id, name: products.name })\n      .from(products)\n      .where(eq(products.id, productId));\n\n    if (!product) {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get variants\n    const variants = await db\n      .select()\n      .from(productVariants)\n      .where(and(\n        eq(productVariants.productId, productId),\n        eq(productVariants.isActive, true)\n      ))\n      .orderBy(asc(productVariants.name));\n\n    sendSuccess(res, variants.map(v => ({\n      ...v,\n      basePrice: Number(v.basePrice),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/:slug\n * Get product by slug\n */\nproductsRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const slug = req.params['slug'] as string;\n\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.slug, slug));\n\n    if (!product || product.status !== 'active') {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get category\n    let category;\n    if (product.categoryId) {\n      [category] = await db\n        .select({ id: categories.id, name: categories.name, slug: categories.slug })\n        .from(categories)\n        .where(eq(categories.id, product.categoryId));\n    }\n\n    sendSuccess(res, {\n      ...product,\n      basePrice: Number(product.basePrice),\n      costPrice: product.costPrice ? Number(product.costPrice) : undefined,\n      compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : undefined,\n      inStock: product.stockQuantity > 0 || product.allowBackorder,\n      category,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/products/admin/:id\n * Get product by ID (Admin only - returns any status)\n */\nproductsRoutes.get('/admin/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.id, id));\n\n    if (!product) {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get category\n    let category;\n    if (product.categoryId) {\n      [category] = await db\n        .select({ id: categories.id, name: categories.name, slug: categories.slug })\n        .from(categories)\n        .where(eq(categories.id, product.categoryId));\n    }\n\n    sendSuccess(res, {\n      ...product,\n      basePrice: Number(product.basePrice),\n      costPrice: product.costPrice ? Number(product.costPrice) : undefined,\n      compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : undefined,\n      weight: product.weight ? Number(product.weight) : undefined,\n      inStock: product.stockQuantity > 0 || product.allowBackorder,\n      category,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/products\n * Create a new product (Admin only)\n */\nproductsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createProductSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate SKU if not provided\n      const sku = data.sku || generateSku();\n\n      // Check if SKU already exists\n      const [existingSku] = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.sku, sku));\n\n      if (existingSku) {\n        throw new ConflictError('SKU already exists');\n      }\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.name);\n\n      // Check if slug already exists\n      const [existingSlug] = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.slug, slug));\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Create product\n      const insertResult = await db\n        .insert(products)\n        .values({\n          ...data,\n          sku,\n          slug,\n          basePrice: String(data.basePrice),\n          costPrice: data.costPrice ? String(data.costPrice) : null,\n          compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : null,\n          weight: data.weight ? String(data.weight) : null,\n          categoryId: data.categoryId || null,\n          thumbnailUrl: data.thumbnailUrl || null,\n        })\n        .returning();\n\n      const product = insertResult[0];\n      if (!product) {\n        throw new Error('Failed to create product');\n      }\n\n      // Sync to search index\n      try {\n        if (await searchService.isAvailable()) {\n          // Fetch category info for the search document\n          let categoryName = '';\n          let categorySlugValue = '';\n          if (product.categoryId) {\n            const [cat] = await db.select({ name: categories.name, slug: categories.slug })\n              .from(categories)\n              .where(eq(categories.id, product.categoryId));\n            if (cat) {\n              categoryName = cat.name;\n              categorySlugValue = cat.slug;\n            }\n          }\n\n          await searchService.indexProduct({\n            id: product.id,\n            sku: product.sku,\n            name: product.name,\n            slug: product.slug,\n            description: product.description,\n            shortDescription: product.shortDescription,\n            brand: product.brand,\n            categoryId: product.categoryId,\n            categoryName,\n            categorySlug: categorySlugValue,\n            basePrice: Number(product.basePrice),\n            compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n            stockQuantity: product.stockQuantity,\n            inStock: product.stockQuantity > 0 || product.allowBackorder,\n            isFeatured: product.isFeatured,\n            tags: product.tags as string[] || [],\n            thumbnailUrl: product.thumbnailUrl,\n            images: product.images as Array<{ url: string; alt?: string }> || [],\n            createdAt: new Date(product.createdAt).getTime(),\n            updatedAt: new Date(product.updatedAt).getTime(),\n          });\n        }\n      } catch (e) {\n        logger.error('Failed to index product in search', { error: e, productId: product.id });\n      }\n\n      sendCreated(res, {\n        ...product,\n        basePrice: Number(product.basePrice),\n        costPrice: product.costPrice ? Number(product.costPrice) : null,\n        compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n        weight: product.weight ? Number(product.weight) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/products/:id\n * Update a product (Admin only)\n */\nproductsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateProductSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      // Check if product exists\n      const [existing] = await db\n        .select()\n        .from(products)\n        .where(eq(products.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Product not found');\n      }\n\n      // Update product\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      // Convert decimal fields to strings for database\n      if (data.basePrice !== undefined) {\n        updateData['basePrice'] = String(data.basePrice);\n      }\n      if (data.costPrice !== undefined) {\n        updateData['costPrice'] = data.costPrice ? String(data.costPrice) : null;\n      }\n      if (data.compareAtPrice !== undefined) {\n        updateData['compareAtPrice'] = data.compareAtPrice ? String(data.compareAtPrice) : null;\n      }\n      if (data.weight !== undefined) {\n        updateData['weight'] = data.weight ? String(data.weight) : null;\n      }\n      // Handle nullable fields\n      if (data.categoryId !== undefined) {\n        updateData['categoryId'] = data.categoryId || null;\n      }\n      if (data.thumbnailUrl !== undefined) {\n        updateData['thumbnailUrl'] = data.thumbnailUrl || null;\n      }\n\n      const updateResult = await db\n        .update(products)\n        .set(updateData)\n        .where(eq(products.id, id))\n        .returning();\n\n      const product = updateResult[0];\n      if (!product) {\n        throw new NotFoundError('Product not found');\n      }\n\n      // Sync to search index\n      try {\n        if (await searchService.isAvailable()) {\n          // Fetch category info for the search document\n          let categoryName = '';\n          let categorySlugValue = '';\n          if (product.categoryId) {\n            const [cat] = await db.select({ name: categories.name, slug: categories.slug })\n              .from(categories)\n              .where(eq(categories.id, product.categoryId));\n            if (cat) {\n              categoryName = cat.name;\n              categorySlugValue = cat.slug;\n            }\n          }\n\n          await searchService.updateProduct({\n            id: product.id,\n            sku: product.sku,\n            name: product.name,\n            slug: product.slug,\n            description: product.description,\n            shortDescription: product.shortDescription,\n            brand: product.brand,\n            categoryId: product.categoryId,\n            categoryName,\n            categorySlug: categorySlugValue,\n            basePrice: Number(product.basePrice),\n            compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n            stockQuantity: product.stockQuantity,\n            inStock: product.stockQuantity > 0 || product.allowBackorder,\n            isFeatured: product.isFeatured,\n            tags: product.tags as string[] || [],\n            thumbnailUrl: product.thumbnailUrl,\n            images: product.images as Array<{ url: string; alt?: string }> || [],\n            createdAt: new Date(product.createdAt).getTime(),\n            updatedAt: new Date(product.updatedAt).getTime(),\n          });\n        }\n      } catch (e) {\n        logger.error('Failed to update product in search', { error: e, productId: product.id });\n      }\n\n      sendSuccess(res, {\n        ...product,\n        basePrice: Number(product.basePrice),\n        costPrice: product.costPrice ? Number(product.costPrice) : null,\n        compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n        weight: product.weight ? Number(product.weight) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/products/:id\n * Delete a product (Admin only)\n */\nproductsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: products.id })\n      .from(products)\n      .where(eq(products.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Product not found');\n    }\n\n    await db.delete(products).where(eq(products.id, id));\n\n    // Remove from search index\n    try {\n      if (await searchService.isAvailable()) {\n        await searchService.removeProduct(id);\n      }\n    } catch (e) {\n      logger.error('Failed to remove product from search', { error: e, productId: id });\n    }\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, categories, products, eq, isNull, sql } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug } from '../utils/helpers';\n\nexport const categoriesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createCategorySchema = z.object({\n  name: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  description: z.string().optional(),\n  imageUrl: z.string().url().optional(),\n  parentId: z.string().uuid().optional(),\n  isActive: z.boolean().optional().default(true),\n  sortOrder: z.number().int().min(0).optional().default(0),\n});\n\nconst updateCategorySchema = createCategorySchema.partial();\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/categories\n * List all categories (hierarchical)\n */\ncategoriesRoutes.get('/', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Get all active categories\n    const categoryList = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.isActive, true))\n      .orderBy(categories.sortOrder);\n\n    // Build hierarchy\n    const rootCategories = categoryList.filter(c => !c.parentId);\n    const categoryMap = new Map(categoryList.map(c => [c.id, { ...c, children: [] as typeof categoryList }]));\n\n    for (const category of categoryList) {\n      if (category.parentId) {\n        const parent = categoryMap.get(category.parentId);\n        if (parent) {\n          parent.children.push(categoryMap.get(category.id)!);\n        }\n      }\n    }\n\n    const hierarchicalCategories = rootCategories.map(c => categoryMap.get(c.id)!);\n\n    sendSuccess(res, hierarchicalCategories);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/categories/:slug\n * Get category by slug with products\n */\ncategoriesRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const slug = req.params['slug'] as string;\n\n    const categoryResult = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.slug, slug));\n\n    const category = categoryResult[0];\n\n    if (!category || !category.isActive) {\n      throw new NotFoundError('Category not found');\n    }\n\n    // Get product count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(products)\n      .where(eq(products.categoryId, category.id));\n\n    const count = countResult[0]?.count ?? 0;\n\n    // Get subcategories\n    const subcategories = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.parentId, category.id));\n\n    sendSuccess(res, {\n      ...category,\n      productCount: Number(count),\n      children: subcategories,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * POST /api/categories\n * Create a new category (Admin only)\n */\ncategoriesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createCategorySchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.name);\n\n      // Check if slug already exists\n      const existingSlugResult = await db\n        .select({ id: categories.id })\n        .from(categories)\n        .where(eq(categories.slug, slug));\n\n      const existingSlug = existingSlugResult[0];\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Create category\n      const categoryResult = await db\n        .insert(categories)\n        .values({\n          ...data,\n          slug,\n        })\n        .returning();\n\n      const category = categoryResult[0];\n\n      sendCreated(res, category);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/categories/:id\n * Update a category (Admin only)\n */\ncategoriesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateCategorySchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const existingResult = await db\n        .select()\n        .from(categories)\n        .where(eq(categories.id, id));\n\n      const existing = existingResult[0];\n\n      if (!existing) {\n        throw new NotFoundError('Category not found');\n      }\n\n      const categoryResult = await db\n        .update(categories)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(categories.id, id))\n        .returning();\n\n      const category = categoryResult[0];\n\n      sendSuccess(res, category);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/categories/:id\n * Delete a category (Admin only)\n */\ncategoriesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const existingResult = await db\n      .select({ id: categories.id })\n      .from(categories)\n      .where(eq(categories.id, id));\n\n    const existing = existingResult[0];\n\n    if (!existing) {\n      throw new NotFoundError('Category not found');\n    }\n\n    // Update products to remove category reference\n    await db\n      .update(products)\n      .set({ categoryId: null })\n      .where(eq(products.categoryId, id));\n\n    // Update child categories to remove parent\n    await db\n      .update(categories)\n      .set({ parentId: null })\n      .where(eq(categories.parentId, id));\n\n    await db.delete(categories).where(eq(categories.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, carts, cartItems, cartPromoCodes, products, productVariants, eq, and, isNull } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { optionalAuth } from '../middleware/auth';\nimport { sendSuccess, sendNoContent } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { logger } from '../utils/logger';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport const cartRoutes = Router();\n\n// Apply optional auth to all cart routes\ncartRoutes.use(optionalAuth);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst addToCartSchema = z.object({\n  productId: z.string().uuid(),\n  variantId: z.string().uuid().optional(),\n  quantity: z.preprocess(\n    (val) => (typeof val === 'string' ? parseInt(val, 10) : val),\n    z.number()\n      .int('Quantity must be a whole number')\n      .positive('Quantity must be positive')\n      .min(1, 'Quantity must be at least 1')\n      .max(9999, 'Quantity cannot exceed 9999')\n  ),\n});\n\nconst updateCartItemSchema = z.object({\n  quantity: z.preprocess(\n    (val) => (typeof val === 'string' ? parseInt(val, 10) : val),\n    z.number()\n      .int('Quantity must be a whole number')\n      .positive('Quantity must be positive')\n      .min(1, 'Quantity must be at least 1')\n      .max(9999, 'Quantity cannot exceed 9999')\n  ),\n});\n\nconst applyPromoSchema = z.object({\n  code: z.string().min(1).max(50),\n});\n\n// ===========================================\n// Helper Functions\n// ===========================================\n\nasync function getOrCreateCart(userId?: string, sessionId?: string): Promise<typeof carts.$inferSelect> {\n  const db = getDb();\n\n  // Try to find existing cart\n  let cart: typeof carts.$inferSelect | undefined;\n\n  if (userId) {\n    const [existing] = await db\n      .select()\n      .from(carts)\n      .where(eq(carts.customerId, userId));\n    cart = existing;\n  } else if (sessionId) {\n    const [existing] = await db\n      .select()\n      .from(carts)\n      .where(eq(carts.sessionId, sessionId));\n    cart = existing;\n  }\n\n  // Create new cart if not found\n  if (!cart) {\n    const newSessionId = sessionId || uuidv4();\n    const [created] = await db\n      .insert(carts)\n      .values({\n        customerId: userId,\n        sessionId: userId ? undefined : newSessionId,\n      })\n      .returning();\n    if (!created) {\n      throw new Error('Failed to create cart');\n    }\n    cart = created;\n  }\n\n  return cart;\n}\n\nasync function getCartItems(cartId: string) {\n  const db = getDb();\n\n  return db\n    .select()\n    .from(cartItems)\n    .where(eq(cartItems.cartId, cartId));\n}\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/cart\n * Get current cart\n */\ncartRoutes.get('/', async (req, res, next) => {\n  try {\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      // Return empty cart for anonymous users without session\n      return sendSuccess(res, {\n        id: null,\n        items: [],\n        itemCount: 0,\n      });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    sendSuccess(res, {\n      id: cart.id,\n      sessionId: cart.sessionId,\n      items,\n      itemCount: items.reduce((sum, item) => sum + item.quantity, 0),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/cart/calculate\n * Calculate cart totals (CRITICAL - server-side calculation)\n */\ncartRoutes.get('/calculate', async (req, res, next) => {\n  try {\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      return sendSuccess(res, {\n        items: [],\n        itemCount: 0,\n        subtotal: 0,\n        taxRate: 0, // Tax rate will be applied when items are added\n        taxAmount: 0,\n        shippingAmount: 0,\n        discountAmount: 0,\n        total: 0,\n        currency: 'USD',\n      });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    if (items.length === 0) {\n      return sendSuccess(res, {\n        items: [],\n        itemCount: 0,\n        subtotal: 0,\n        taxRate: 0, // Tax rate will be applied when items are added\n        taxAmount: 0,\n        shippingAmount: 0,\n        discountAmount: 0,\n        total: 0,\n        currency: 'USD',\n      });\n    }\n\n    // Get promo code if applied\n    const db = getDb();\n    const [promoCode] = await db\n      .select()\n      .from(cartPromoCodes)\n      .where(eq(cartPromoCodes.cartId, cart.id));\n\n    // Calculate totals using pricing service\n    const cartInput = items.map(item => ({\n      id: item.id,  // Pass actual cart item ID to pricing service\n      productId: item.productId,\n      variantId: item.variantId || undefined,\n      quantity: item.quantity,\n    }));\n\n    const calculation = await pricingService.calculateCart(\n      cartInput,\n      promoCode?.code\n    );\n\n    sendSuccess(res, calculation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/items\n * Add item to cart\n */\ncartRoutes.post('/items', validateBody(addToCartSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string || uuidv4();\n    const { productId, variantId, quantity } = req.body;\n\n    // Validate product exists\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.id, productId));\n\n    if (!product || product.status !== 'active') {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Validate variant if provided\n    if (variantId) {\n      const [variant] = await db\n        .select()\n        .from(productVariants)\n        .where(eq(productVariants.id, variantId));\n\n      if (!variant || !variant.isActive) {\n        throw new NotFoundError('Variant not found');\n      }\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Check if item already in cart\n    const [existingItem] = await db\n      .select()\n      .from(cartItems)\n      .where(\n        and(\n          eq(cartItems.cartId, cart.id),\n          eq(cartItems.productId, productId),\n          variantId ? eq(cartItems.variantId, variantId) : isNull(cartItems.variantId)\n        )\n      );\n\n    let cartItem;\n\n    if (existingItem) {\n      // Update quantity\n      [cartItem] = await db\n        .update(cartItems)\n        .set({\n          quantity: existingItem.quantity + quantity,\n          updatedAt: new Date(),\n        })\n        .where(eq(cartItems.id, existingItem.id))\n        .returning();\n    } else {\n      // Add new item\n      const [created] = await db\n        .insert(cartItems)\n        .values({\n          cartId: cart.id,\n          productId,\n          variantId,\n          quantity,\n        })\n        .returning();\n      cartItem = created;\n    }\n\n    if (!cartItem) {\n      throw new Error('Failed to add item to cart');\n    }\n\n    sendSuccess(res, {\n      id: cartItem.id,\n      cartId: cart.id,\n      sessionId: cart.sessionId,\n      productId: cartItem.productId,\n      variantId: cartItem.variantId,\n      quantity: cartItem.quantity,\n    }, 201);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/cart/items/:id\n * Update cart item quantity\n */\ncartRoutes.put('/items/:id', validateBody(updateCartItemSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const { quantity } = req.body;\n\n    // Get user's cart for ownership verification\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Verify cart item belongs to user's cart\n    const [cartItem] = await db\n      .select()\n      .from(cartItems)\n      .where(and(\n        eq(cartItems.id, id),\n        eq(cartItems.cartId, cart.id)\n      ));\n\n    if (!cartItem) {\n      logger.warn('Cart item not found for update', {\n        requestedId: id,\n        cartId: cart.id,\n        userId: req.user?.customerId,\n        sessionId: req.sessionId || req.headers['x-session-id'],\n        requestBody: req.body,\n      });\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const [updated] = await db\n      .update(cartItems)\n      .set({\n        quantity,\n        updatedAt: new Date(),\n      })\n      .where(eq(cartItems.id, id))\n      .returning();\n\n    sendSuccess(res, updated);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/cart/items/:id\n * Remove item from cart\n */\ncartRoutes.delete('/items/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Get user's cart for ownership verification\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Verify cart item belongs to user's cart\n    const [cartItem] = await db\n      .select()\n      .from(cartItems)\n      .where(and(\n        eq(cartItems.id, id),\n        eq(cartItems.cartId, cart.id)\n      ));\n\n    if (!cartItem) {\n      logger.warn('Cart item not found for deletion', {\n        requestedId: id,\n        cartId: cart.id,\n        userId: req.user?.customerId,\n        sessionId: req.sessionId || req.headers['x-session-id'],\n      });\n      throw new NotFoundError('Cart item not found');\n    }\n\n    await db.delete(cartItems).where(eq(cartItems.id, id));\n\n    logger.info('Cart item deleted', {\n      cartItemId: id,\n      productId: cartItem.productId,\n      quantity: cartItem.quantity,\n      userId: req.user?.customerId,\n    });\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/apply-promo\n * Apply promo code to cart\n */\ncartRoutes.post('/apply-promo', validateBody(applyPromoSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n    const { code } = req.body;\n\n    if (!userId && !sessionId) {\n      throw new BadRequestError('Cart not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    if (items.length === 0) {\n      throw new BadRequestError('Cart is empty');\n    }\n\n    // Calculate current subtotal\n    const cartInput = items.map(item => ({\n      productId: item.productId,\n      variantId: item.variantId || undefined,\n      quantity: item.quantity,\n    }));\n\n    // Validate promo code and check eligibility\n    const calculation = await pricingService.calculateCart(cartInput, code);\n\n    // Check if promo code was validated\n    if (!calculation.promoCodeId) {\n      throw new BadRequestError('Invalid or expired promo code');\n    }\n\n    // Check if any items are eligible for this promo code\n    // If promo has restrictions but no items match, reject it\n    if (calculation.discountAmount === 0 && calculation.promoCode) {\n      throw new BadRequestError(\n        'This promo code does not apply to any items in your cart. ' +\n        'It may only be valid for specific products or categories.'\n      );\n    }\n\n    // Remove existing promo code\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    // Apply new promo code\n    await db.insert(cartPromoCodes).values({\n      cartId: cart.id,\n      promoCodeId: calculation.promoCodeId,\n      code: calculation.promoCode!,\n    });\n\n    sendSuccess(res, calculation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/cart/promo\n * Remove promo code from cart\n */\ncartRoutes.delete('/promo', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new BadRequestError('Cart not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/clear\n * Clear all items from cart\n */\ncartRoutes.post('/clear', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      return sendSuccess(res, { success: true, itemsRemoved: 0 });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Delete all cart items\n    const deleted = await db.delete(cartItems).where(eq(cartItems.cartId, cart.id)).returning();\n\n    // Also remove any applied promo codes\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    logger.info('Cart cleared', {\n      cartId: cart.id,\n      itemsRemoved: deleted.length,\n      userId: req.user?.customerId,\n    });\n\n    sendSuccess(res, { success: true, itemsRemoved: deleted.length });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, orders, orderItems, customers, carts, cartItems, cartPromoCodes, products, productVariants, promoCodes, settings, eq, sql, desc, and, or, ilike } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { optionalAuth, requireAuth, requireAdmin } from '../middleware/auth';\nimport { strictLimiter } from '../middleware/rateLimiter';\nimport { sendSuccess, sendCreated, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError, ForbiddenError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { pdfService } from '../services/pdf.service';\nimport { generateOrderNumber } from '../utils/helpers';\nimport { emailTemplatesService } from '../services/email-templates.service';\nimport { mailerService } from '../services/mailer.service';\nimport { logger } from '../utils/logger';\n\nexport const ordersRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst addressSchema = z.object({\n  firstName: z.string().min(1).max(100),\n  lastName: z.string().min(1).max(100),\n  company: z.string().max(255).optional(),\n  addressLine1: z.string().min(1).max(255),\n  addressLine2: z.string().max(255).optional(),\n  city: z.string().min(1).max(100),\n  state: z.string().max(100).optional(),\n  postalCode: z.string().max(20).optional(),\n  country: z.string().min(1).max(100),\n  phone: z.string().max(50).optional(),\n});\n\nconst createOrderSchema = z.object({\n  shippingAddress: addressSchema,\n  billingAddress: addressSchema.optional(),\n  sameAsShipping: z.boolean().optional().default(true),\n  customerEmail: z.string().email(),\n  customerNotes: z.string().max(1000).optional(),\n  paymentMethod: z.enum(['cod']).default('cod'),\n});\n\nconst updateOrderSchema = z.object({\n  status: z.enum(['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']).optional(),\n  paymentStatus: z.enum(['pending', 'paid', 'refunded', 'failed']).optional(),\n  trackingNumber: z.string().max(255).optional(),\n  shippingMethod: z.string().max(100).optional(),\n  adminNotes: z.string().max(1000).optional(),\n  shippingAddress: addressSchema.optional(),\n  billingAddress: addressSchema.optional(),\n});\n\nconst orderFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']).optional(),\n  paymentStatus: z.enum(['pending', 'paid', 'refunded', 'failed']).optional(),\n  search: z.string().optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * POST /api/orders\n * Create a new order (checkout)\n */\nordersRoutes.post(\n  '/',\n  strictLimiter,\n  optionalAuth,\n  validateBody(createOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const userId = req.user?.customerId;\n      const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n      const data = req.body;\n\n      if (!userId && !sessionId) {\n        throw new BadRequestError('No cart found');\n      }\n\n      // Get cart\n      let cart;\n      if (userId) {\n        [cart] = await db.select().from(carts).where(eq(carts.customerId, userId));\n      } else if (sessionId) {\n        [cart] = await db.select().from(carts).where(eq(carts.sessionId, sessionId));\n      }\n\n      if (!cart) {\n        throw new BadRequestError('Cart not found');\n      }\n\n      // Get cart items\n      const items = await db\n        .select()\n        .from(cartItems)\n        .where(eq(cartItems.cartId, cart.id));\n\n      if (items.length === 0) {\n        throw new BadRequestError('Cart is empty');\n      }\n\n      // Get promo code if applied\n      const [promoCode] = await db\n        .select()\n        .from(cartPromoCodes)\n        .where(eq(cartPromoCodes.cartId, cart.id));\n\n      // Calculate totals using pricing service\n      const cartInput = items.map(item => ({\n        productId: item.productId,\n        variantId: item.variantId || undefined,\n        quantity: item.quantity,\n      }));\n\n      const totals = await pricingService.calculateOrderTotals(\n        cartInput,\n        promoCode?.code\n      );\n\n      // Get or create customer\n      let customer;\n      if (userId) {\n        [customer] = await db.select().from(customers).where(eq(customers.id, userId));\n      } else {\n        // Create guest customer\n        [customer] = await db\n          .insert(customers)\n          .values({\n            email: data.customerEmail.toLowerCase(),\n            firstName: data.shippingAddress.firstName,\n            lastName: data.shippingAddress.lastName,\n            phone: data.shippingAddress.phone,\n            isGuest: true,\n          })\n          .returning();\n      }\n\n      // Generate order number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(orders);\n      const count = countResult[0]?.count ?? 0;\n      const orderNumber = generateOrderNumber(Number(count) + 1);\n\n      // Determine billing address\n      const billingAddress = data.sameAsShipping\n        ? data.shippingAddress\n        : data.billingAddress || data.shippingAddress;\n\n      if (!customer) {\n        throw new BadRequestError('Failed to create or find customer');\n      }\n\n      // Create order\n      const orderResult = await db\n        .insert(orders)\n        .values({\n          orderNumber,\n          customerId: customer.id,\n          status: 'pending',\n          paymentStatus: 'pending',\n          shippingAddress: data.shippingAddress,\n          billingAddress,\n          currency: 'USD',\n          subtotalSnapshot: String(totals.subtotal),\n          taxRateSnapshot: String(totals.taxRate),\n          taxAmountSnapshot: String(totals.taxAmount),\n          shippingAmountSnapshot: String(totals.shippingAmount),\n          discountAmountSnapshot: String(totals.discountAmount),\n          totalSnapshot: String(totals.total),\n          promoCodeId: totals.promoCodeId,\n          promoCodeSnapshot: totals.promoCodeSnapshot,\n          paymentMethod: data.paymentMethod,\n          customerNotes: data.customerNotes,\n        })\n        .returning();\n      const order = orderResult[0];\n\n      if (!order) {\n        throw new BadRequestError('Failed to create order');\n      }\n\n      // Create order items with product snapshots\n      for (const item of items) {\n        const productResult = await db\n          .select()\n          .from(products)\n          .where(eq(products.id, item.productId));\n        const product = productResult[0];\n\n        if (!product) {\n          throw new BadRequestError(`Product not found: ${item.productId}`);\n        }\n\n        let variant;\n        if (item.variantId) {\n          const variantResult = await db\n            .select()\n            .from(productVariants)\n            .where(eq(productVariants.id, item.variantId));\n          variant = variantResult[0];\n        }\n\n        const unitPrice = variant ? Number(variant.basePrice) : Number(product.basePrice);\n\n        await db.insert(orderItems).values({\n          orderId: order.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          productNameSnapshot: product.name,\n          skuSnapshot: variant?.sku || product.sku,\n          variantOptionsSnapshot: variant?.options,\n          quantity: item.quantity,\n          unitPriceSnapshot: String(unitPrice),\n        });\n      }\n\n      // Deduct stock for each item\n      for (const item of items) {\n        if (item.variantId) {\n          // Deduct from variant\n          await db\n            .update(productVariants)\n            .set({\n              stockQuantity: sql`${productVariants.stockQuantity} - ${item.quantity}`,\n              updatedAt: new Date(),\n            })\n            .where(eq(productVariants.id, item.variantId));\n        } else {\n          // Check if product tracks inventory\n          const [product] = await db.select({ trackInventory: products.trackInventory })\n            .from(products)\n            .where(eq(products.id, item.productId));\n\n          if (product?.trackInventory) {\n            await db\n              .update(products)\n              .set({\n                stockQuantity: sql`${products.stockQuantity} - ${item.quantity}`,\n                updatedAt: new Date(),\n              })\n              .where(eq(products.id, item.productId));\n          }\n        }\n      }\n\n      // Update promo code usage\n      if (totals.promoCodeId) {\n        await db\n          .update(promoCodes)\n          .set({ usageCount: sql`${promoCodes.usageCount} + 1` })\n          .where(eq(promoCodes.id, totals.promoCodeId));\n      }\n\n      // Update customer order count\n      await db\n        .update(customers)\n        .set({ orderCount: sql`${customers.orderCount} + 1` })\n        .where(eq(customers.id, customer.id));\n\n      // Clear cart\n      await db.delete(cartItems).where(eq(cartItems.cartId, cart.id));\n      await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n      sendCreated(res, {\n        orderId: order.id,\n        orderNumber: order.orderNumber,\n        total: totals.total,\n        status: order.status,\n        paymentMethod: order.paymentMethod,\n      });\n\n      // Send emails asynchronously (don't block response)\n      // Email failures will not affect order creation\n      try {\n        // Fetch full order with items for email\n        const orderWithItems = await db.query.orders.findFirst({\n          where: eq(orders.id, order.id),\n          with: {\n            items: true,\n          },\n        });\n\n        if (!orderWithItems) {\n          logger.warn('Order not found for email notification', { orderId: order.id });\n          return;\n        }\n\n        // Get settings for admin email\n        const [storeSettings] = await db\n          .select()\n          .from(settings)\n          .where(eq(settings.key, 'store'));\n\n        const storeConfig = (storeSettings?.value as {\n          orderNotificationEmail?: string;\n          storeEmail?: string;\n          storeName?: string;\n        }) || {};\n\n        // Prepare email data\n        const customerEmail = data['customerEmail'] as string;\n        const emailData = {\n          orderNumber: order.orderNumber,\n          customerName: `${order.shippingAddress.firstName} ${order.shippingAddress.lastName}`,\n          customerEmail,\n          shippingAddress: { ...order.shippingAddress, email: customerEmail, phone: order.shippingAddress.phone || '' },\n          items: orderWithItems.items.map((item) => ({\n            productName: item.productNameSnapshot,\n            sku: item.skuSnapshot,\n            quantity: item.quantity,\n            unitPrice: Number(item.unitPriceSnapshot),\n            lineTotal: Number(item.unitPriceSnapshot) * item.quantity,\n          })),\n          subtotal: Number(order.subtotalSnapshot),\n          taxRate: Number(order.taxRateSnapshot),\n          taxAmount: Number(order.taxAmountSnapshot),\n          shippingAmount: Number(order.shippingAmountSnapshot),\n          discountAmount: Number(order.discountAmountSnapshot),\n          total: Number(order.totalSnapshot),\n          currency: order.currency,\n          promoCode: order.promoCodeSnapshot || undefined,\n          customerNotes: order.customerNotes || undefined,\n          orderDate: order.createdAt.toISOString(),\n          paymentMethod: order.paymentMethod,\n        };\n\n        // Send customer confirmation email\n        const customerEmailHtml = emailTemplatesService.generateOrderConfirmationEmail(emailData);\n        mailerService\n          .sendEmail({\n            to: emailData.customerEmail,\n            subject: `Order Confirmation - ${order.orderNumber}`,\n            html: customerEmailHtml,\n          })\n          .then((success) => {\n            if (success) {\n              logger.info('Order confirmation email sent', {\n                orderId: order.id,\n                orderNumber: order.orderNumber,\n                customerEmail: emailData.customerEmail,\n              });\n            }\n          })\n          .catch((error) => {\n            logger.error('Failed to send customer order confirmation email', {\n              error,\n              orderId: order.id,\n              orderNumber: order.orderNumber,\n              customerEmail: emailData.customerEmail,\n            });\n          });\n\n        // Send admin notification email (if configured)\n        if (storeConfig.orderNotificationEmail) {\n          const adminEmailHtml = emailTemplatesService.generateNewOrderNotificationEmail(emailData);\n          mailerService\n            .sendEmail({\n              to: storeConfig.orderNotificationEmail,\n              subject: `New Order: ${order.orderNumber}`,\n              html: adminEmailHtml,\n            })\n            .then((success) => {\n              if (success) {\n                logger.info('Admin order notification email sent', {\n                  orderId: order.id,\n                  orderNumber: order.orderNumber,\n                  adminEmail: storeConfig.orderNotificationEmail,\n                });\n              }\n            })\n            .catch((error) => {\n              logger.error('Failed to send admin order notification email', {\n                error,\n                orderId: order.id,\n                orderNumber: order.orderNumber,\n                adminEmail: storeConfig.orderNotificationEmail,\n              });\n            });\n        }\n      } catch (emailError) {\n        // Log email errors but don't fail the request\n        logger.error('Error in email notification process', {\n          error: emailError,\n          orderId: order.id,\n          orderNumber: order.orderNumber,\n        });\n      }\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/orders/track/:orderNumber\n * Public order tracking\n */\nordersRoutes.get('/track/:orderNumber', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const orderNumber = req.params['orderNumber'] as string;\n\n    const [order] = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.orderNumber, orderNumber));\n\n    if (!order) {\n      throw new NotFoundError('Order not found');\n    }\n\n    // Get order items\n    const items = await db\n      .select()\n      .from(orderItems)\n      .where(eq(orderItems.orderId, order.id));\n\n    // Build timeline with accurate timestamps\n    const timeline = [\n      { status: 'pending', timestamp: order.createdAt.toISOString(), description: 'Order placed' },\n    ];\n\n    if (order.status !== 'pending' && order.status !== 'cancelled' && order.confirmedAt) {\n      timeline.push({ status: 'confirmed', timestamp: order.confirmedAt.toISOString(), description: 'Order confirmed' });\n    }\n\n    if (['processing', 'shipped', 'delivered'].includes(order.status) && order.processingAt) {\n      timeline.push({ status: 'processing', timestamp: order.processingAt.toISOString(), description: 'Order is being processed' });\n    }\n\n    if (['shipped', 'delivered'].includes(order.status) && order.shippedAt) {\n      timeline.push({ status: 'shipped', timestamp: order.shippedAt.toISOString(), description: 'Order shipped' });\n    }\n\n    if (order.status === 'delivered' && order.deliveredAt) {\n      timeline.push({ status: 'delivered', timestamp: order.deliveredAt.toISOString(), description: 'Order delivered' });\n    }\n\n    // Extract shipping location (city/country only for privacy)\n    const shippingAddress = order.shippingAddress as { city?: string; country?: string } | null;\n\n    sendSuccess(res, {\n      orderNumber: order.orderNumber,\n      status: order.status,\n      paymentStatus: order.paymentStatus,\n      shippingMethod: order.shippingMethod,\n      trackingNumber: order.trackingNumber,\n      createdAt: order.createdAt.toISOString(),\n      total: Number(order.totalSnapshot),\n      itemCount: items.length,\n      items: items.map(item => ({\n        productName: item.productNameSnapshot,\n        quantity: item.quantity,\n        price: Number(item.unitPriceSnapshot),\n      })),\n      shippingLocation: shippingAddress ? {\n        city: shippingAddress.city,\n        country: shippingAddress.country,\n      } : null,\n      timeline,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Routes\n// ===========================================\n\n/**\n * GET /api/orders\n * Get customer's orders\n */\nordersRoutes.get('/', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(orders)\n      .where(eq(orders.customerId, customerId));\n    const count = countResult[0]?.count ?? 0;\n\n    const orderList = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        totalSnapshot: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, customerId))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    const ordersWithTotals = orderList.map(o => ({\n      ...o,\n      totalSnapshot: Number(o.totalSnapshot),\n    }));\n\n    sendSuccess(res, ordersWithTotals, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/orders/:id\n * Get order details\n */\nordersRoutes.get('/:id', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const customerId = req.user?.customerId;\n    const isAdmin = req.user?.role === 'admin';\n\n    const [order] = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.id, id));\n\n    if (!order) {\n      throw new NotFoundError('Order not found');\n    }\n\n    // Check ownership (unless admin)\n    if (!isAdmin && order.customerId !== customerId) {\n      throw new ForbiddenError('Access denied');\n    }\n\n    // Get order items\n    const items = await db\n      .select()\n      .from(orderItems)\n      .where(eq(orderItems.orderId, order.id));\n\n    // Get customer info if exists\n    let customer = null;\n    if (order.customerId) {\n      const [customerData] = await db\n        .select({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n        })\n        .from(customers)\n        .where(eq(customers.id, order.customerId));\n      customer = customerData || null;\n    }\n\n    sendSuccess(res, {\n      id: order.id,\n      orderNumber: order.orderNumber,\n      customerId: order.customerId,\n      customer,\n\n      // Status\n      status: order.status,\n      paymentStatus: order.paymentStatus,\n\n      // Financial\n      currency: order.currency,\n      subtotal: Number(order.subtotalSnapshot),\n      taxRate: Number(order.taxRateSnapshot),\n      tax: Number(order.taxAmountSnapshot),\n      shipping: Number(order.shippingAmountSnapshot),\n      discount: Number(order.discountAmountSnapshot),\n      total: Number(order.totalSnapshot),\n\n      // Promo\n      promoCodeId: order.promoCodeId,\n      promoCodeSnapshot: order.promoCodeSnapshot,\n\n      // Payment & Shipping\n      paymentMethod: order.paymentMethod,\n      shippingMethod: order.shippingMethod,\n      trackingNumber: order.trackingNumber,\n\n      // Addresses\n      shippingAddress: order.shippingAddress,\n      billingAddress: order.billingAddress,\n\n      // Notes\n      customerNotes: order.customerNotes,\n      adminNotes: order.adminNotes,\n\n      // Status Timestamps\n      confirmedAt: order.confirmedAt?.toISOString(),\n      processingAt: order.processingAt?.toISOString(),\n      shippedAt: order.shippedAt?.toISOString(),\n      deliveredAt: order.deliveredAt?.toISOString(),\n      createdAt: order.createdAt.toISOString(),\n      updatedAt: order.updatedAt.toISOString(),\n\n      // Items\n      items: items.map(item => ({\n        id: item.id,\n        productId: item.productId,\n        productName: item.productNameSnapshot,\n        productImage: null,\n        sku: item.skuSnapshot,\n        variantOptions: item.variantOptionsSnapshot,\n        quantity: item.quantity,\n        price: Number(item.unitPriceSnapshot),\n        total: Number(item.unitPriceSnapshot) * item.quantity,\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/orders/admin/all\n * Get all orders (Admin only)\n */\nordersRoutes.get(\n  '/admin/all',\n  requireAuth,\n  requireAdmin,\n  validateQuery(orderFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const filters = req.query;\n\n      const conditions = [];\n\n      if (filters['status']) {\n        conditions.push(eq(orders.status, filters['status'] as 'pending' | 'confirmed' | 'processing' | 'shipped' | 'delivered' | 'cancelled'));\n      }\n\n      if (filters['paymentStatus']) {\n        conditions.push(eq(orders.paymentStatus, filters['paymentStatus'] as 'pending' | 'paid' | 'refunded' | 'failed'));\n      }\n\n      // Search by customer name, email, or order number\n      if (filters['search']) {\n        const searchTerm = `%${filters['search']}%`;\n        conditions.push(\n          or(\n            ilike(orders.orderNumber, searchTerm),\n            ilike(customers.email, searchTerm),\n            ilike(customers.firstName, searchTerm),\n            ilike(customers.lastName, searchTerm),\n            sql`CONCAT(${customers.firstName}, ' ', ${customers.lastName}) ILIKE ${searchTerm}`\n          )\n        );\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Count query needs join when searching by customer fields\n      const countQuery = filters['search']\n        ? db.select({ count: sql<number>`count(*)` })\n            .from(orders)\n            .leftJoin(customers, eq(orders.customerId, customers.id))\n            .where(whereClause)\n        : db.select({ count: sql<number>`count(*)` })\n            .from(orders)\n            .where(whereClause);\n      const countResult = await countQuery;\n      const count = countResult[0]?.count ?? 0;\n\n      const orderList = await db\n        .select({\n          id: orders.id,\n          orderNumber: orders.orderNumber,\n          customerId: orders.customerId,\n          status: orders.status,\n          paymentStatus: orders.paymentStatus,\n          totalSnapshot: orders.totalSnapshot,\n          shippingAddress: orders.shippingAddress,\n          adminNotes: orders.adminNotes,\n          createdAt: orders.createdAt,\n          updatedAt: orders.updatedAt,\n          customer: {\n            id: customers.id,\n            email: customers.email,\n            firstName: customers.firstName,\n            lastName: customers.lastName,\n          },\n        })\n        .from(orders)\n        .leftJoin(customers, eq(orders.customerId, customers.id))\n        .where(whereClause)\n        .orderBy(desc(orders.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      // Format the response with proper totals\n      const formattedOrders = orderList.map(o => ({\n        ...o,\n        total: Number(o.totalSnapshot),\n        customer: o.customer?.id ? o.customer : null,\n      }));\n\n      sendSuccess(res, formattedOrders, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/orders/:id\n * Update order (Admin only)\n */\nordersRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Validate status transitions\n      const validTransitions: Record<string, string[]> = {\n        pending: ['confirmed', 'cancelled'],\n        confirmed: ['processing', 'cancelled'],\n        processing: ['shipped', 'cancelled'],\n        shipped: ['delivered'],\n        delivered: [],\n        cancelled: [],\n      };\n\n      if (data.status && data.status !== existing.status) {\n        const allowedNextStates = validTransitions[existing.status] || [];\n        if (!allowedNextStates.includes(data.status)) {\n          throw new BadRequestError(\n            `Cannot transition from '${existing.status}' to '${data.status}'`\n          );\n        }\n      }\n\n      // Restore stock on cancellation\n      if (data.status === 'cancelled' && existing.status !== 'cancelled') {\n        // Get order items\n        const orderItemsList = await db.select().from(orderItems)\n          .where(eq(orderItems.orderId, id));\n\n        // Restore stock for each item\n        for (const item of orderItemsList) {\n          if (item.variantId) {\n            await db.update(productVariants)\n              .set({\n                stockQuantity: sql`${productVariants.stockQuantity} + ${item.quantity}`,\n              })\n              .where(eq(productVariants.id, item.variantId));\n          } else if (item.productId) {\n            await db.update(products)\n              .set({\n                stockQuantity: sql`${products.stockQuantity} + ${item.quantity}`,\n              })\n              .where(eq(products.id, item.productId));\n          }\n        }\n      }\n\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      // Set timestamp when status changes to confirmed\n      if (data.status === 'confirmed' && existing.status !== 'confirmed') {\n        updateData['confirmedAt'] = new Date();\n      }\n\n      // Set timestamp when status changes to processing\n      if (data.status === 'processing' && existing.status !== 'processing') {\n        updateData['processingAt'] = new Date();\n      }\n\n      // Set shipped date if status changed to shipped\n      if (data.status === 'shipped' && existing.status !== 'shipped') {\n        updateData['shippedAt'] = new Date();\n      }\n\n      // Set delivered date if status changed to delivered\n      if (data.status === 'delivered' && existing.status !== 'delivered') {\n        updateData['deliveredAt'] = new Date();\n      }\n\n      const orderResult = await db\n        .update(orders)\n        .set(updateData)\n        .where(eq(orders.id, id))\n        .returning();\n      const order = orderResult[0];\n\n      sendSuccess(res, order);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/orders/:id/invoice\n * Download order invoice as PDF (Admin only)\n */\nordersRoutes.get(\n  '/:id/invoice',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [order] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!order) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Get order items\n      const items = await db\n        .select()\n        .from(orderItems)\n        .where(eq(orderItems.orderId, order.id));\n\n      // Get customer info\n      let customer = null;\n      if (order.customerId) {\n        const [customerData] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.id, order.customerId));\n        customer = customerData || null;\n      }\n\n      // Get shipping address for customer details\n      const shippingAddress = order.shippingAddress as {\n        firstName: string;\n        lastName: string;\n        phone?: string;\n        company?: string;\n      } | null;\n\n      // Prepare invoice data\n      const invoiceData = {\n        invoiceNumber: `INV-${order.orderNumber}`,\n        orderNumber: order.orderNumber,\n        quotationNumber: order.orderNumber,\n        createdAt: order.createdAt,\n        validUntil: new Date(order.createdAt.getTime() + 30 * 24 * 60 * 60 * 1000), // 30 days\n        status: order.status,\n        paymentStatus: order.paymentStatus,\n        paymentMethod: order.paymentMethod || 'cod',\n        paidAt: order.paymentStatus === 'paid' ? order.updatedAt : undefined,\n\n        // Customer info\n        customerName: customer\n          ? `${customer.firstName} ${customer.lastName}`\n          : shippingAddress\n            ? `${shippingAddress.firstName} ${shippingAddress.lastName}`\n            : 'Guest Customer',\n        customerEmail: customer?.email || '',\n        customerPhone: customer?.phone || shippingAddress?.phone,\n        customerCompany: shippingAddress?.company,\n\n        // Items\n        items: items.map(item => ({\n          productName: item.productNameSnapshot || 'Unknown Product',\n          sku: item.skuSnapshot || '',\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPriceSnapshot),\n          lineTotal: Number(item.unitPriceSnapshot) * item.quantity,\n          variantOptions: item.variantOptionsSnapshot as Record<string, string> | undefined,\n        })),\n\n        // Totals\n        subtotal: Number(order.subtotalSnapshot),\n        taxRate: Number(order.taxRateSnapshot),\n        taxAmount: Number(order.taxAmountSnapshot),\n        shippingAmount: Number(order.shippingAmountSnapshot),\n        discountAmount: Number(order.discountAmountSnapshot),\n        total: Number(order.totalSnapshot),\n        currency: order.currency || 'USD',\n\n        // Company info (can be configured via env)\n        companyName: process.env['COMPANY_NAME'] || 'Lab404',\n        companyAddress: process.env['COMPANY_ADDRESS'] || '123 Business Street, City, State 12345',\n        companyPhone: process.env['COMPANY_PHONE'] || '+1 (555) 123-4567',\n        companyEmail: process.env['COMPANY_EMAIL'] || 'contact@lab404.com',\n        companyWebsite: process.env['COMPANY_WEBSITE'] || 'https://lab404.com',\n      };\n\n      // Generate PDF\n      const pdfBuffer = await pdfService.generateInvoicePDF(invoiceData);\n\n      // Set response headers\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader(\n        'Content-Disposition',\n        `attachment; filename=\"invoice-${order.orderNumber}.pdf\"`\n      );\n      res.setHeader('Content-Length', pdfBuffer.length);\n\n      // Send PDF\n      res.send(pdfBuffer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Admin Order Creation\n// ===========================================\n\nconst adminCreateOrderSchema = z.object({\n  // Customer - either existing or new\n  customerId: z.string().uuid().optional(),\n  customerEmail: z.string().email().optional(),\n  customerFirstName: z.string().max(100).optional(),\n  customerLastName: z.string().max(100).optional(),\n  customerPhone: z.string().max(50).optional(),\n\n  // Items (required)\n  items: z.array(z.object({\n    productId: z.string().uuid(),\n    variantId: z.string().uuid().optional(),\n    quantity: z.number().int().positive(),\n  })).min(1, 'At least one item is required'),\n\n  // Addresses\n  shippingAddress: addressSchema,\n  billingAddress: addressSchema.optional(),\n  sameAsShipping: z.boolean().default(true),\n\n  // Payment\n  paymentMethod: z.enum(['cod', 'bank_transfer', 'cash']),\n  paymentStatus: z.enum(['pending', 'paid']).default('pending'),\n\n  // Discounts\n  promoCode: z.string().optional(),\n  manualDiscount: z.number().min(0).optional(),\n\n  // Notes\n  adminNotes: z.string().max(1000).optional(),\n  customerNotes: z.string().max(1000).optional(),\n});\n\n/**\n * POST /api/orders/admin\n * Create a new order (Admin only - bypasses cart)\n */\nordersRoutes.post(\n  '/admin',\n  requireAuth,\n  requireAdmin,\n  validateBody(adminCreateOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // 1. Resolve customer\n      let customer;\n      if (data.customerId) {\n        // Use existing customer\n        const [existingCustomer] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.id, data.customerId));\n\n        if (!existingCustomer) {\n          throw new BadRequestError('Customer not found');\n        }\n        customer = existingCustomer;\n      } else if (data.customerEmail) {\n        // Find or create guest customer\n        const [existingCustomer] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.email, data.customerEmail.toLowerCase()));\n\n        if (existingCustomer) {\n          customer = existingCustomer;\n        } else {\n          // Create new guest customer\n          const [newCustomer] = await db\n            .insert(customers)\n            .values({\n              email: data.customerEmail.toLowerCase(),\n              firstName: data.customerFirstName || data.shippingAddress.firstName,\n              lastName: data.customerLastName || data.shippingAddress.lastName,\n              phone: data.customerPhone || data.shippingAddress.phone,\n              isGuest: true,\n            })\n            .returning();\n          customer = newCustomer;\n        }\n      } else {\n        throw new BadRequestError('Either customerId or customerEmail is required');\n      }\n\n      if (!customer) {\n        throw new BadRequestError('Failed to resolve customer');\n      }\n\n      // 2. Calculate totals using pricing service\n      const cartInput = data.items.map((item: { productId: string; variantId?: string; quantity: number }) => ({\n        productId: item.productId,\n        variantId: item.variantId,\n        quantity: item.quantity,\n      }));\n\n      const totals = await pricingService.calculateOrderTotals(\n        cartInput,\n        data.promoCode\n      );\n\n      // 3. Apply manual discount if provided\n      let finalDiscount = totals.discountAmount;\n      let finalTotal = totals.total;\n\n      if (data.manualDiscount && data.manualDiscount > 0) {\n        // Add manual discount (cap at remaining subtotal after promo discount)\n        const maxManualDiscount = totals.subtotal - totals.discountAmount;\n        const appliedManualDiscount = Math.min(data.manualDiscount, maxManualDiscount);\n        finalDiscount += appliedManualDiscount;\n        finalTotal = totals.subtotal - finalDiscount + totals.taxAmount + totals.shippingAmount;\n\n        // Recalculate tax on discounted amount\n        const discountedSubtotal = totals.subtotal - finalDiscount;\n        const newTax = discountedSubtotal * totals.taxRate;\n        finalTotal = discountedSubtotal + newTax + totals.shippingAmount;\n      }\n\n      // 4. Generate order number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(orders);\n      const count = countResult[0]?.count ?? 0;\n      const orderNumber = generateOrderNumber(Number(count) + 1);\n\n      // 5. Determine billing address\n      const billingAddress = data.sameAsShipping\n        ? data.shippingAddress\n        : data.billingAddress || data.shippingAddress;\n\n      // 6. Create order\n      const [order] = await db\n        .insert(orders)\n        .values({\n          orderNumber,\n          customerId: customer.id,\n          status: 'pending',\n          paymentStatus: data.paymentStatus,\n          shippingAddress: data.shippingAddress,\n          billingAddress,\n          currency: 'USD',\n          subtotalSnapshot: String(totals.subtotal),\n          taxRateSnapshot: String(totals.taxRate),\n          taxAmountSnapshot: String(data.manualDiscount ? (totals.subtotal - finalDiscount) * totals.taxRate : totals.taxAmount),\n          shippingAmountSnapshot: String(totals.shippingAmount),\n          discountAmountSnapshot: String(finalDiscount),\n          totalSnapshot: String(finalTotal),\n          promoCodeId: totals.promoCodeId,\n          promoCodeSnapshot: totals.promoCodeSnapshot,\n          paymentMethod: data.paymentMethod,\n          customerNotes: data.customerNotes,\n          adminNotes: data.adminNotes,\n        })\n        .returning();\n\n      if (!order) {\n        throw new BadRequestError('Failed to create order');\n      }\n\n      // 7. Create order items with product snapshots\n      for (const item of data.items) {\n        const [product] = await db\n          .select()\n          .from(products)\n          .where(eq(products.id, item.productId));\n\n        if (!product) {\n          throw new BadRequestError(`Product not found: ${item.productId}`);\n        }\n\n        let variant;\n        if (item.variantId) {\n          const [variantResult] = await db\n            .select()\n            .from(productVariants)\n            .where(eq(productVariants.id, item.variantId));\n          variant = variantResult;\n        }\n\n        const unitPrice = variant ? Number(variant.basePrice) : Number(product.basePrice);\n\n        await db.insert(orderItems).values({\n          orderId: order.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          productNameSnapshot: product.name,\n          skuSnapshot: variant?.sku || product.sku,\n          variantOptionsSnapshot: variant?.options,\n          quantity: item.quantity,\n          unitPriceSnapshot: String(unitPrice),\n        });\n      }\n\n      // 8. Update promo code usage if used\n      if (totals.promoCodeId) {\n        await db\n          .update(promoCodes)\n          .set({ usageCount: sql`${promoCodes.usageCount} + 1` })\n          .where(eq(promoCodes.id, totals.promoCodeId));\n      }\n\n      // 9. Update customer order count\n      await db\n        .update(customers)\n        .set({ orderCount: sql`${customers.orderCount} + 1` })\n        .where(eq(customers.id, customer.id));\n\n      sendCreated(res, {\n        id: order.id,\n        orderNumber: order.orderNumber,\n        total: finalTotal,\n        status: order.status,\n        paymentStatus: order.paymentStatus,\n        paymentMethod: order.paymentMethod,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/orders/:id\n * Delete a cancelled order (Admin only)\n */\nordersRoutes.delete(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [order] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!order) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Only allow deletion of cancelled orders\n      if (order.status !== 'cancelled') {\n        throw new BadRequestError('Only cancelled orders can be deleted');\n      }\n\n      // Delete order items first (cascade should handle this, but being explicit)\n      await db.delete(orderItems).where(eq(orderItems.orderId, id));\n\n      // Delete the order\n      await db.delete(orders).where(eq(orders.id, id));\n\n      sendSuccess(res, { message: 'Order deleted successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","/**\n * Email Templates Service\n *\n * Generates HTML email templates for order notifications and confirmations.\n * Uses inline CSS and table-based layouts for email client compatibility.\n */\n\ninterface AddressJson {\n  firstName: string;\n  lastName: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone: string;\n  email: string;\n}\n\ninterface OrderEmailData {\n  orderNumber: string;\n  customerName: string;\n  customerEmail: string;\n  shippingAddress: AddressJson;\n  items: Array<{\n    productName: string;\n    sku: string;\n    quantity: number;\n    unitPrice: number;\n    lineTotal: number;\n  }>;\n  subtotal: number;\n  taxRate: number;\n  taxAmount: number;\n  shippingAmount: number;\n  discountAmount: number;\n  total: number;\n  currency: string;\n  promoCode?: string;\n  customerNotes?: string;\n  orderDate: string;\n  paymentMethod: string;\n}\n\nclass EmailTemplatesService {\n  /**\n   * Generate customer order confirmation email HTML\n   */\n  generateOrderConfirmationEmail(data: OrderEmailData): string {\n    const itemsHtml = data.items\n      .map(\n        (item) => `\n      <tr>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937;\">\n          <strong>${this.escapeHtml(item.productName)}</strong><br>\n          <span style=\"color: #6b7280; font-size: 12px;\">SKU: ${this.escapeHtml(item.sku)}</span>\n        </td>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; color: #1f2937;\">\n          ${item.quantity}\n        </td>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #1f2937;\">\n          ${this.formatCurrency(item.lineTotal, data.currency)}\n        </td>\n      </tr>\n    `\n      )\n      .join('');\n\n    const content = `\n      <!-- Order Confirmation Message -->\n      <tr>\n        <td style=\"padding: 40px 40px 20px;\">\n          <h2 style=\"margin: 0 0 10px; color: #1f2937; font-size: 24px; font-weight: bold;\">Order Confirmed!</h2>\n          <p style=\"margin: 0; color: #6b7280; font-size: 16px; line-height: 1.5;\">\n            Thank you for your order. We'll prepare it and contact you for delivery.\n          </p>\n        </td>\n      </tr>\n\n      <!-- Order Number -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <div style=\"background-color: #f3f4f6; padding: 20px; border-radius: 6px; text-align: center;\">\n            <p style=\"margin: 0 0 5px; font-size: 14px; color: #6b7280;\">Order Number</p>\n            <p style=\"margin: 0; font-size: 24px; font-weight: bold; color: #1f2937;\">#${this.escapeHtml(data.orderNumber)}</p>\n          </div>\n        </td>\n      </tr>\n\n      <!-- Order Items -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 15px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Details</h3>\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border: 1px solid #e5e7eb; border-radius: 6px;\">\n            <thead>\n              <tr style=\"background-color: #f9fafb;\">\n                <th style=\"padding: 12px 8px; text-align: left; font-size: 14px; color: #6b7280; font-weight: 600;\">Item</th>\n                <th style=\"padding: 12px 8px; text-align: center; font-size: 14px; color: #6b7280; font-weight: 600;\">Qty</th>\n                <th style=\"padding: 12px 8px; text-align: right; font-size: 14px; color: #6b7280; font-weight: 600;\">Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${itemsHtml}\n            </tbody>\n          </table>\n        </td>\n      </tr>\n\n      <!-- Price Breakdown -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <table width=\"100%\" cellpadding=\"8\" cellspacing=\"0\">\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Subtotal</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">${this.formatCurrency(data.subtotal, data.currency)}</td>\n            </tr>\n            ${\n              data.discountAmount > 0\n                ? `\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">\n                Discount ${data.promoCode ? `(${this.escapeHtml(data.promoCode)})` : ''}\n              </td>\n              <td style=\"text-align: right; font-size: 14px; color: #10b981;\">-${this.formatCurrency(data.discountAmount, data.currency)}</td>\n            </tr>\n            `\n                : ''\n            }\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Tax (${(data.taxRate * 100).toFixed(0)}%)</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">${this.formatCurrency(data.taxAmount, data.currency)}</td>\n            </tr>\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Shipping</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">\n                ${data.shippingAmount > 0 ? this.formatCurrency(data.shippingAmount, data.currency) : 'Free'}\n              </td>\n            </tr>\n            <tr style=\"border-top: 2px solid #e5e7eb;\">\n              <td style=\"font-size: 18px; font-weight: bold; color: #1f2937; padding-top: 12px;\">Total</td>\n              <td style=\"text-align: right; font-size: 18px; font-weight: bold; color: #1f2937; padding-top: 12px;\">\n                ${this.formatCurrency(data.total, data.currency)}\n              </td>\n            </tr>\n          </table>\n        </td>\n      </tr>\n\n      <!-- COD Payment Notice -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <div style=\"background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 4px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #92400e; line-height: 1.6;\">\n              <strong>Payment Method:</strong> Cash on Delivery (COD)<br>\n              Pay with cash when you receive your order.\n            </p>\n          </div>\n        </td>\n      </tr>\n\n      <!-- Shipping Address -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Shipping Address</h3>\n          <p style=\"margin: 0; font-size: 14px; color: #6b7280; line-height: 1.8;\">\n            ${this.formatAddress(data.shippingAddress)}\n          </p>\n        </td>\n      </tr>\n\n      ${\n        data.customerNotes\n          ? `\n      <!-- Customer Notes -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Notes</h3>\n          <p style=\"margin: 0; font-size: 14px; color: #6b7280; line-height: 1.6;\">\n            ${this.escapeHtml(data.customerNotes)}\n          </p>\n        </td>\n      </tr>\n      `\n          : ''\n      }\n    `;\n\n    return this.generateEmailLayout(content, `Order Confirmation - #${data.orderNumber}`);\n  }\n\n  /**\n   * Generate admin new order notification email HTML\n   */\n  generateNewOrderNotificationEmail(data: OrderEmailData): string {\n    const itemsHtml = data.items\n      .map(\n        (item) => `\n      <tr>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937;\">\n          <strong>${this.escapeHtml(item.productName)}</strong><br>\n          <span style=\"color: #6b7280; font-size: 12px;\">SKU: ${this.escapeHtml(item.sku)}</span>\n        </td>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; color: #1f2937;\">\n          ${item.quantity}\n        </td>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #1f2937;\">\n          ${this.formatCurrency(item.lineTotal, data.currency)}\n        </td>\n      </tr>\n    `\n      )\n      .join('');\n\n    const content = `\n      <tr>\n        <td style=\"padding: 40px;\">\n          <h2 style=\"margin: 0 0 20px; color: #1f2937; font-size: 24px; font-weight: bold;\">New Order Received</h2>\n\n          <div style=\"background-color: #dbeafe; padding: 15px; border-radius: 6px; margin-bottom: 20px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #1e40af;\">\n              <strong>Order Number:</strong> #${this.escapeHtml(data.orderNumber)}\n            </p>\n          </div>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Customer</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.8;\">\n            <strong>${this.escapeHtml(data.customerName)}</strong><br>\n            ${this.escapeHtml(data.customerEmail)}<br>\n            ${this.escapeHtml(data.shippingAddress.phone)}\n          </p>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Summary</h3>\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border: 1px solid #e5e7eb; margin-bottom: 20px; border-radius: 6px;\">\n            <thead>\n              <tr style=\"background-color: #f9fafb;\">\n                <th style=\"padding: 12px 8px; text-align: left; font-size: 14px; color: #6b7280; font-weight: 600;\">Item</th>\n                <th style=\"padding: 12px 8px; text-align: center; font-size: 14px; color: #6b7280; font-weight: 600;\">Qty</th>\n                <th style=\"padding: 12px 8px; text-align: right; font-size: 14px; color: #6b7280; font-weight: 600;\">Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${itemsHtml}\n            </tbody>\n          </table>\n\n          <div style=\"text-align: right; font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 20px;\">\n            Total: ${this.formatCurrency(data.total, data.currency)}\n          </div>\n\n          <div style=\"background-color: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 20px;\">\n            <p style=\"margin: 0; color: #92400e; font-size: 14px;\">\n              <strong>Payment:</strong> Cash on Delivery (COD)\n            </p>\n          </div>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Shipping Address</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.8;\">\n            ${this.formatAddress(data.shippingAddress)}\n          </p>\n\n          ${\n            data.customerNotes\n              ? `\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Customer Notes</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.6;\">\n            ${this.escapeHtml(data.customerNotes)}\n          </p>\n          `\n              : ''\n          }\n\n          <div style=\"text-align: center; margin-top: 30px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #6b7280;\">\n              Log in to your admin dashboard to view and manage this order.\n            </p>\n          </div>\n        </td>\n      </tr>\n    `;\n\n    return this.generateEmailLayout(content, `New Order: #${data.orderNumber}`);\n  }\n\n  /**\n   * Generate email layout wrapper with header and footer\n   */\n  private generateEmailLayout(content: string, title: string): string {\n    return `<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>${this.escapeHtml(title)}</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; background-color: #f4f4f4; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #f4f4f4;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 20px 0;\">\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px;\">\n\n          <!-- Header -->\n          <tr>\n            <td style=\"background-color: #2563eb; color: #ffffff; padding: 30px 40px; text-align: center; border-radius: 8px 8px 0 0;\">\n              <h1 style=\"margin: 0; font-size: 28px; font-weight: bold; letter-spacing: -0.5px;\">Lab404 Electronics</h1>\n            </td>\n          </tr>\n\n          <!-- Content -->\n          ${content}\n\n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #f9fafb; padding: 30px 40px; text-align: center; border-top: 1px solid #e5e7eb; border-radius: 0 0 8px 8px;\">\n              <p style=\"margin: 0 0 10px; font-size: 14px; color: #6b7280; line-height: 1.6;\">\n                Questions? Contact us at <a href=\"mailto:contact@lab404electronics.com\" style=\"color: #2563eb; text-decoration: none;\">contact@lab404electronics.com</a>\n              </p>\n              <p style=\"margin: 0; font-size: 12px; color: #9ca3af;\">\n                &copy; 2026 Lab404 Electronics. All rights reserved.\n              </p>\n            </td>\n          </tr>\n\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  /**\n   * Format currency for display\n   */\n  private formatCurrency(amount: number, currency: string): string {\n    // Simple USD formatting - can be extended for other currencies\n    return `$${amount.toFixed(2)}`;\n  }\n\n  /**\n   * Format address for display\n   */\n  private formatAddress(address: AddressJson): string {\n    const parts: string[] = [];\n\n    parts.push(`<strong>${this.escapeHtml(address.firstName)} ${this.escapeHtml(address.lastName)}</strong>`);\n    parts.push(this.escapeHtml(address.addressLine1));\n\n    if (address.addressLine2) {\n      parts.push(this.escapeHtml(address.addressLine2));\n    }\n\n    const cityStateLine: string[] = [];\n    cityStateLine.push(this.escapeHtml(address.city));\n    if (address.state) {\n      cityStateLine.push(this.escapeHtml(address.state));\n    }\n    if (address.postalCode) {\n      cityStateLine.push(this.escapeHtml(address.postalCode));\n    }\n    parts.push(cityStateLine.join(', '));\n\n    parts.push(this.escapeHtml(address.country));\n    parts.push(this.escapeHtml(address.phone));\n\n    return parts.join('<br>');\n  }\n\n  /**\n   * Escape HTML to prevent XSS in email templates\n   */\n  private escapeHtml(text: string): string {\n    const map: { [key: string]: string } = {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#039;',\n    };\n    return text.replace(/[&<>\"']/g, (char) => map[char] || char);\n  }\n}\n\nexport const emailTemplatesService = new EmailTemplatesService();\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport bcrypt from 'bcryptjs';\nimport { getDb, customers, addresses, orders, eq, sql, desc, like, or, and } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ForbiddenError, BadRequestError } from '../utils/errors';\nimport { PasswordSecurityService } from '../services/password-security.service';\nimport { LoginAttemptService } from '../services/login-attempt.service';\nimport { notificationService } from '../services/notification.service';\nimport { auditLogService } from '../services/audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\n\nexport const customersRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Common weak passwords to reject\nconst WEAK_PASSWORDS = [\n  '123456', '123456789', 'qwerty', 'password', '12345678',\n  '111111', '1234567890', '1234567', 'password1', '123123',\n  'abc123', 'qwerty123', '1q2w3e4r', 'admin', 'letmein',\n  'welcome', 'monkey', 'dragon', 'master', 'login'\n];\n\nconst updateProfileSchema = z.object({\n  firstName: z.string().min(1).max(100).optional(),\n  lastName: z.string().min(1).max(100).optional(),\n  phone: z.string().max(50).optional(),\n});\n\nconst changePasswordSchema = z.object({\n  currentPassword: z.string().min(1, 'Current password is required'),\n  newPassword: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(72, 'Password must be less than 72 characters')\n    .refine(\n      (password) => {\n        const hasUppercase = /[A-Z]/.test(password);\n        const hasLowercase = /[a-z]/.test(password);\n        const hasNumber = /[0-9]/.test(password);\n        return hasUppercase && hasLowercase && hasNumber;\n      },\n      { message: 'Password must contain uppercase, lowercase, and number' }\n    )\n    .refine(\n      (password) => !WEAK_PASSWORDS.includes(password.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    ),\n  confirmPassword: z.string().min(1, 'Please confirm your password'),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\nconst addressSchema = z.object({\n  type: z.enum(['shipping', 'billing'], {\n    errorMap: () => ({ message: 'Address type must be shipping or billing' })\n  }),\n  isDefault: z.boolean().optional().default(false),\n  firstName: z.string()\n    .min(1, 'First name is required')\n    .max(100, 'First name must be less than 100 characters'),\n  lastName: z.string()\n    .min(1, 'Last name is required')\n    .max(100, 'Last name must be less than 100 characters'),\n  company: z.string()\n    .max(255, 'Company must be less than 255 characters')\n    .optional(),\n  addressLine1: z.string()\n    .min(1, 'Address is required')\n    .max(255, 'Address must be less than 255 characters'),\n  addressLine2: z.string()\n    .max(255, 'Address line 2 must be less than 255 characters')\n    .optional(),\n  city: z.string()\n    .min(1, 'City is required')\n    .max(100, 'City must be less than 100 characters'),\n  state: z.string()\n    .max(100, 'State must be less than 100 characters')\n    .optional(),\n  postalCode: z.string()\n    .max(20, 'Postal code must be less than 20 characters')\n    .optional(),\n  country: z.string()\n    .min(1, 'Country is required')\n    .max(100, 'Country must be less than 100 characters'),\n  phone: z.string()\n    .max(50, 'Phone must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n});\n\nconst customerFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  isGuest: z.enum(['true', 'false']).optional(),\n});\n\nconst auditLogFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst adminUpdateCustomerSchema = z.object({\n  email: z.string()\n    .email('Please enter a valid email address')\n    .max(255, 'Email must be less than 255 characters')\n    .optional(),\n  firstName: z.string()\n    .min(1, 'First name cannot be empty')\n    .max(100, 'First name must be less than 100 characters')\n    .optional(),\n  lastName: z.string()\n    .min(1, 'Last name cannot be empty')\n    .max(100, 'Last name must be less than 100 characters')\n    .optional(),\n  phone: z.string()\n    .max(50, 'Phone number must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n  isGuest: z.boolean().optional(),\n  isActive: z.boolean().optional(),\n  acceptsMarketing: z.boolean().optional(),\n  notes: z.string()\n    .max(5000, 'Notes must be less than 5000 characters')\n    .optional(),\n  tags: z.array(\n    z.string().max(50, 'Each tag must be less than 50 characters')\n  ).optional(),\n});\n\nconst createCustomerSchema = z.object({\n  email: z.string()\n    .min(1, 'Email is required')\n    .email('Please enter a valid email address')\n    .max(255, 'Email must be less than 255 characters'),\n  firstName: z.string()\n    .min(1, 'First name cannot be empty')\n    .max(100, 'First name must be less than 100 characters')\n    .optional(),\n  lastName: z.string()\n    .min(1, 'Last name cannot be empty')\n    .max(100, 'Last name must be less than 100 characters')\n    .optional(),\n  phone: z.string()\n    .max(50, 'Phone number must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n  isGuest: z.boolean().optional().default(false),\n  isActive: z.boolean().optional().default(true),\n  acceptsMarketing: z.boolean().optional().default(false),\n  notes: z.string()\n    .max(5000, 'Notes must be less than 5000 characters')\n    .optional(),\n  tags: z.array(\n    z.string().max(50, 'Each tag must be less than 50 characters')\n  ).optional(),\n});\n\n// ===========================================\n// Customer Profile Routes (Authenticated)\n// ===========================================\n\n/**\n * GET /api/customers/me\n * Get current customer profile\n */\ncustomersRoutes.get('/me', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const [customer] = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        phone: customers.phone,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n      })\n      .from(customers)\n      .where(eq(customers.id, customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Get addresses\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, {\n      ...customer,\n      addresses: customerAddresses,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/customers/me\n * Update current customer profile\n */\ncustomersRoutes.put(\n  '/me',\n  requireAuth,\n  validateBody(updateProfileSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      const customerResult = await db\n        .update(customers)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customerId))\n        .returning({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n          phone: customers.phone,\n        });\n      const customer = customerResult[0];\n\n      sendSuccess(res, customer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/me/password\n * Change customer password\n */\ncustomersRoutes.put(\n  '/me/password',\n  requireAuth,\n  validateBody(changePasswordSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const { currentPassword, newPassword } = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // Get customer with password hash and email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer || !customer.passwordHash) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Verify current password\n      const isPasswordValid = await bcrypt.compare(currentPassword, customer.passwordHash);\n      if (!isPasswordValid) {\n        throw new BadRequestError('Current password is incorrect');\n      }\n\n      // Validate new password with security checks\n      const userInputs = [customer.email, customer.firstName, customer.lastName].filter(Boolean) as string[];\n      const validation = await PasswordSecurityService.validatePassword(\n        newPassword,\n        customerId,\n        userInputs\n      );\n\n      if (!validation.isValid) {\n        throw new BadRequestError(validation.errors.join('. '));\n      }\n\n      // Hash new password\n      const newPasswordHash = await bcrypt.hash(newPassword, 12);\n\n      // Update password\n      await db\n        .update(customers)\n        .set({\n          passwordHash: newPasswordHash,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customerId));\n\n      // Record password change in history\n      await PasswordSecurityService.recordPasswordChange({\n        customerId,\n        passwordHash: newPasswordHash,\n        changeReason: 'user_action',\n        ipAddress: req.ip || req.socket.remoteAddress,\n        userAgent: req.headers['user-agent'],\n      });\n\n      // Log password change event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.PASSWORD_CHANGED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customerId,\n        actorEmail: customer.email,\n        action: 'password_change',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          changeReason: 'user_action',\n          strengthScore: validation.strengthResult?.score,\n        },\n      });\n\n      // Log breach/reuse warnings if any\n      if (validation.strengthResult?.isBreached) {\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.PASSWORD_BREACH_DETECTED,\n          actorType: ActorType.CUSTOMER,\n          actorId: customerId,\n          actorEmail: customer.email,\n          action: 'password_breach_check',\n          status: EventStatus.SUCCESS,\n          metadata: { breachCount: validation.strengthResult?.breachCount || 0 },\n        });\n      }\n\n      // Send confirmation email (non-blocking)\n      notificationService.sendPasswordChangedConfirmation({\n        email: customer.email,\n        firstName: customer.firstName,\n        timestamp: new Date(),\n        ipAddress: req.ip || req.socket.remoteAddress,\n      }).catch((error) => {\n        console.error('Failed to send password change confirmation:', error);\n      });\n\n      sendSuccess(res, { message: 'Password changed successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Customer Address Routes\n// ===========================================\n\n/**\n * GET /api/customers/me/addresses\n * Get customer addresses\n */\ncustomersRoutes.get('/me/addresses', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, customerAddresses);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/customers/me/addresses\n * Add new address\n */\ncustomersRoutes.post(\n  '/me/addresses',\n  requireAuth,\n  validateBody(addressSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .insert(addresses)\n        .values({\n          customerId,\n          ...data,\n        })\n        .returning();\n      const address = addressResult[0];\n\n      sendCreated(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/me/addresses/:id\n * Update address\n */\ncustomersRoutes.put(\n  '/me/addresses/:id',\n  requireAuth,\n  validateBody(addressSchema.partial()),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // Verify ownership\n      const [existing] = await db\n        .select()\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, id),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type || existing.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .update(addresses)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(addresses.id, id))\n        .returning();\n      const address = addressResult[0];\n\n      sendSuccess(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/me/addresses/:id\n * Delete address\n */\ncustomersRoutes.delete('/me/addresses/:id', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n    const id = req.params['id'] as string;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    // Verify ownership\n    const [existing] = await db\n      .select({ id: addresses.id })\n      .from(addresses)\n      .where(\n        and(\n          eq(addresses.id, id),\n          eq(addresses.customerId, customerId)\n        )\n      );\n\n    if (!existing) {\n      throw new NotFoundError('Address not found');\n    }\n\n    await db.delete(addresses).where(eq(addresses.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/customers\n * List all customers (Admin only)\n */\ncustomersRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(customerFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const search = req.query['search'];\n      const isGuest = req.query['isGuest'];\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(customers.email, `%${search}%`),\n            like(customers.firstName, `%${search}%`),\n            like(customers.lastName, `%${search}%`)\n          )\n        );\n      }\n\n      if (isGuest !== undefined) {\n        conditions.push(eq(customers.isGuest, isGuest === 'true'));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(customers)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const customerList = await db\n        .select({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n          phone: customers.phone,\n          isGuest: customers.isGuest,\n          isActive: customers.isActive,\n          orderCount: sql<number>`COUNT(${orders.id})`.as('order_count'),\n          paidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} = 'paid' THEN 1 END)`.as('paid_orders'),\n          unpaidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} != 'paid' AND ${orders.id} IS NOT NULL THEN 1 END)`.as('unpaid_orders'),\n          totalSpent: sql<number>`COALESCE(SUM(CASE WHEN ${orders.paymentStatus} = 'paid' THEN ${orders.totalSnapshot} ELSE 0 END), 0)`.as('total_spent'),\n          debt: sql<number>`COALESCE(SUM(CASE WHEN ${orders.paymentStatus} != 'paid' THEN ${orders.totalSnapshot} ELSE 0 END), 0)`.as('debt'),\n          createdAt: customers.createdAt,\n        })\n        .from(customers)\n        .leftJoin(orders, eq(orders.customerId, customers.id))\n        .where(whereClause)\n        .groupBy(\n          customers.id,\n          customers.email,\n          customers.firstName,\n          customers.lastName,\n          customers.phone,\n          customers.isGuest,\n          customers.isActive,\n          customers.createdAt\n        )\n        .orderBy(desc(customers.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      // Map orderCount to totalOrders for frontend consistency\n      const formattedList = customerList.map(c => ({\n        ...c,\n        totalOrders: c.orderCount,\n        paidOrders: Number(c.paidOrders),\n        unpaidOrders: Number(c.unpaidOrders),\n        totalSpent: Number(c.totalSpent),\n        debt: Number(c.debt),\n        orderCount: undefined,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/customers\n * Create new customer (Admin only)\n */\ncustomersRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createCustomerSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Check if email already exists\n      const [existingCustomer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.email, data.email));\n\n      if (existingCustomer) {\n        throw new BadRequestError('A customer with this email already exists');\n      }\n\n      // Create customer\n      const customerResult = await db\n        .insert(customers)\n        .values({\n          email: data.email,\n          firstName: data.firstName || null,\n          lastName: data.lastName || null,\n          phone: data.phone || null,\n          isGuest: data.isGuest ?? false,\n          isActive: data.isActive ?? true,\n          acceptsMarketing: data.acceptsMarketing ?? false,\n          notes: data.notes || null,\n          tags: data.tags || null,\n        })\n        .returning();\n      const customer = customerResult[0];\n\n      sendCreated(res, customer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/customers/:id\n * Get customer details (Admin only)\n */\ncustomersRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Get addresses\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, id));\n\n    // Get recent orders\n    const recentOrders = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        totalSnapshot: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, id))\n      .orderBy(desc(orders.createdAt))\n      .limit(10);\n\n    // Calculate total spent (paid orders only)\n    const totalSpentResult = await db\n      .select({\n        totalSpent: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          eq(orders.customerId, id),\n          eq(orders.paymentStatus, 'paid')\n        )\n      );\n    const totalSpent = Number(totalSpentResult[0]?.totalSpent ?? 0);\n\n    // Calculate debt (unpaid orders)\n    const debtResult = await db\n      .select({\n        debt: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          eq(orders.customerId, id),\n          sql`${orders.paymentStatus} != 'paid'`\n        )\n      );\n    const debt = Number(debtResult[0]?.debt ?? 0);\n\n    // Calculate order counts\n    const orderCountsResult = await db\n      .select({\n        totalOrders: sql<number>`COUNT(*)`,\n        paidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} = 'paid' THEN 1 END)`,\n        unpaidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} != 'paid' THEN 1 END)`,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, id));\n    const totalOrders = Number(orderCountsResult[0]?.totalOrders ?? 0);\n    const paidOrders = Number(orderCountsResult[0]?.paidOrders ?? 0);\n    const unpaidOrders = Number(orderCountsResult[0]?.unpaidOrders ?? 0);\n\n    sendSuccess(res, {\n      ...customer,\n      passwordHash: undefined, // Never expose password hash\n      totalOrders,\n      paidOrders,\n      unpaidOrders,\n      totalSpent,\n      debt,\n      addresses: customerAddresses,\n      recentOrders: recentOrders.map(o => ({\n        ...o,\n        totalSnapshot: Number(o.totalSnapshot),\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/customers/:id\n * Update customer (Admin only)\n */\ncustomersRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(adminUpdateCustomerSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Check email uniqueness if email is being updated\n      if (data.email) {\n        const [emailExists] = await db\n          .select({ id: customers.id })\n          .from(customers)\n          .where(\n            and(\n              eq(customers.email, data.email),\n              sql`${customers.id} != ${id}`\n            )\n          );\n\n        if (emailExists) {\n          throw new BadRequestError('A customer with this email already exists');\n        }\n      }\n\n      const customerResult = await db\n        .update(customers)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, id))\n        .returning();\n      const customer = customerResult[0];\n\n      sendSuccess(res, {\n        ...customer,\n        passwordHash: undefined, // Never expose password hash\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/:id\n * Soft delete customer (Admin only)\n */\ncustomersRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: customers.id })\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Soft delete - just deactivate\n    await db\n      .update(customers)\n      .set({\n        isActive: false,\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Customer Address Routes\n// ===========================================\n\n/**\n * GET /api/customers/:id/addresses\n * Get customer addresses (Admin only)\n */\ncustomersRoutes.get('/:id/addresses', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.params['id'] as string;\n\n    // Verify customer exists\n    const [customer] = await db\n      .select({ id: customers.id })\n      .from(customers)\n      .where(eq(customers.id, customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, customerAddresses);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/customers/:id/addresses\n * Add address to customer (Admin only)\n */\ncustomersRoutes.post(\n  '/:id/addresses',\n  requireAuth,\n  requireAdmin,\n  validateBody(addressSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const data = req.body;\n\n      // Verify customer exists\n      const [customer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .insert(addresses)\n        .values({\n          customerId,\n          ...data,\n        })\n        .returning();\n      const address = addressResult[0];\n\n      sendCreated(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/:id/addresses/:addressId\n * Update customer address (Admin only)\n */\ncustomersRoutes.put(\n  '/:id/addresses/:addressId',\n  requireAuth,\n  requireAdmin,\n  validateBody(addressSchema.partial()),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const addressId = req.params['addressId'] as string;\n      const data = req.body;\n\n      // Verify customer exists\n      const [customer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Verify address belongs to customer\n      const [existing] = await db\n        .select()\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, addressId),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type || existing.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .update(addresses)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(addresses.id, addressId))\n        .returning();\n      const address = addressResult[0];\n\n      sendSuccess(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/:id/addresses/:addressId\n * Delete customer address (Admin only)\n */\ncustomersRoutes.delete(\n  '/:id/addresses/:addressId',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const addressId = req.params['addressId'] as string;\n\n      // Verify address belongs to customer\n      const [existing] = await db\n        .select({ id: addresses.id })\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, addressId),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      await db.delete(addresses).where(eq(addresses.id, addressId));\n\n      sendNoContent(res);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/customers/:id/orders\n * Get customer orders (Admin only)\n */\ncustomersRoutes.get('/:id/orders', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(orders)\n      .where(eq(orders.customerId, id));\n    const count = countResult[0]?.count ?? 0;\n\n    const orderList = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.customerId, id))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(\n      res,\n      orderList.map(o => ({\n        id: o.id,\n        orderNumber: o.orderNumber,\n        status: o.status,\n        paymentStatus: o.paymentStatus,\n        total: Number(o.totalSnapshot),\n        createdAt: o.createdAt,\n      })),\n      200,\n      createPaginationMeta(page, limit, Number(count))\n    );\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Security Routes\n// ===========================================\n\n/**\n * GET /api/customers/me/security/login-attempts\n * Get login attempt history for the current customer\n */\ncustomersRoutes.get('/me/security/login-attempts', requireAuth, async (req, res, next) => {\n  try {\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const attempts = await LoginAttemptService.getAttemptHistory(customerId, 50);\n\n    sendSuccess(res, attempts);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/customers/me/audit-logs\n * Get audit logs for the current customer\n */\ncustomersRoutes.get(\n  '/me/audit-logs',\n  requireAuth,\n  validateQuery(auditLogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      const {\n        startDate,\n        endDate,\n        eventType,\n        limit,\n        offset,\n      } = req.query;\n\n      // Parse query parameters\n      const filters: Parameters<typeof auditLogService.query>[0] = {\n        actorId: customerId, // Only return logs for this customer\n        startDate: startDate ? new Date(startDate as string) : undefined,\n        endDate: endDate ? new Date(endDate as string) : undefined,\n        eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n        limit: limit ? parseInt(limit as string, 10) : 50,\n        offset: offset ? parseInt(offset as string, 10) : 0,\n      };\n\n      const logs = await auditLogService.query(filters);\n\n      sendSuccess(res, logs);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/admin/customers/:id/unlock\n * Admin: Unlock a customer account\n */\ncustomersRoutes.post('/admin/customers/:id/unlock', requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const db = getDb();\n\n    // Verify customer exists\n    const [customer] = await db\n      .select({ id: customers.id, email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Unlock the account\n    await LoginAttemptService.unlockAccount(id);\n\n    sendSuccess(res, {\n      message: 'Customer account unlocked successfully',\n      customerId: id,\n      email: customer.email,\n    });\n  } catch (error) {\n    next(error);\n  }\n});","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, promoCodes, eq, sql, desc, and, gte, lte, or, like } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError, BadRequestError } from '../utils/errors';\n\nexport const promoCodesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createPromoCodeSchema = z.object({\n  code: z.string().min(3).max(50).transform(s => s.toUpperCase()),\n  description: z.string().max(500).optional(),\n  discountType: z.enum(['percentage', 'fixed_amount']),\n  discountValue: z.number().positive(),\n  minimumOrderAmount: z.number().min(0).optional(),\n  maximumDiscountAmount: z.number().positive().optional(),\n  usageLimit: z.number().int().positive().optional(),\n  usageLimitPerCustomer: z.number().int().positive().optional(),\n  startsAt: z.string().datetime().optional(),\n  expiresAt: z.string().datetime().optional(),\n  isActive: z.boolean().optional().default(true),\n});\n\nconst updatePromoCodeSchema = createPromoCodeSchema.partial().omit({ code: true });\n\nconst promoCodeFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  isActive: z.enum(['true', 'false']).optional(),\n  status: z.enum(['active', 'expired', 'upcoming']).optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * POST /api/promo-codes/validate\n * Validate a promo code (public endpoint for cart)\n */\npromoCodesRoutes.post(\n  '/validate',\n  validateBody(z.object({ code: z.string().min(1), orderAmount: z.number().min(0) })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { code, orderAmount } = req.body;\n\n      const [promoCode] = await db\n        .select()\n        .from(promoCodes)\n        .where(eq(promoCodes.code, code.toUpperCase()));\n\n      if (!promoCode) {\n        throw new BadRequestError('Invalid promo code');\n      }\n\n      // Check if active\n      if (!promoCode.isActive) {\n        throw new BadRequestError('Promo code is not active');\n      }\n\n      // Check dates\n      const now = new Date();\n      if (promoCode.startsAt && new Date(promoCode.startsAt) > now) {\n        throw new BadRequestError('Promo code is not yet valid');\n      }\n      if (promoCode.expiresAt && new Date(promoCode.expiresAt) < now) {\n        throw new BadRequestError('Promo code has expired');\n      }\n\n      // Check usage limit\n      if (promoCode.usageLimit && promoCode.usageCount >= promoCode.usageLimit) {\n        throw new BadRequestError('Promo code usage limit reached');\n      }\n\n      // Check minimum order amount\n      if (promoCode.minimumOrderAmount && orderAmount < Number(promoCode.minimumOrderAmount)) {\n        throw new BadRequestError(\n          `Minimum order amount of $${promoCode.minimumOrderAmount} required`\n        );\n      }\n\n      // Calculate discount\n      let discountAmount: number;\n      if (promoCode.discountType === 'percentage') {\n        discountAmount = (orderAmount * Number(promoCode.discountValue)) / 100;\n        // Apply maximum discount cap if set\n        if (promoCode.maximumDiscountAmount) {\n          discountAmount = Math.min(discountAmount, Number(promoCode.maximumDiscountAmount));\n        }\n      } else {\n        discountAmount = Math.min(Number(promoCode.discountValue), orderAmount);\n      }\n\n      sendSuccess(res, {\n        valid: true,\n        code: promoCode.code,\n        discountType: promoCode.discountType,\n        discountValue: Number(promoCode.discountValue),\n        discountAmount: Math.round(discountAmount * 100) / 100,\n        description: promoCode.description,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/promo-codes\n * List all promo codes (Admin only)\n */\npromoCodesRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(promoCodeFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, isActive, status } = req.query;\n\n      const conditions = [];\n      const now = new Date();\n\n      if (search) {\n        conditions.push(\n          or(\n            like(promoCodes.code, `%${(search as string).toUpperCase()}%`),\n            like(promoCodes.description, `%${search}%`)\n          )\n        );\n      }\n\n      if (isActive !== undefined) {\n        conditions.push(eq(promoCodes.isActive, isActive === 'true'));\n      }\n\n      if (status === 'active') {\n        conditions.push(eq(promoCodes.isActive, true));\n        conditions.push(\n          or(\n            sql`${promoCodes.startsAt} IS NULL`,\n            lte(promoCodes.startsAt, now)\n          )\n        );\n        conditions.push(\n          or(\n            sql`${promoCodes.expiresAt} IS NULL`,\n            gte(promoCodes.expiresAt, now)\n          )\n        );\n      } else if (status === 'expired') {\n        conditions.push(lte(promoCodes.expiresAt, now));\n      } else if (status === 'upcoming') {\n        conditions.push(gte(promoCodes.startsAt, now));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(promoCodes)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const promoCodeList = await db\n        .select()\n        .from(promoCodes)\n        .where(whereClause)\n        .orderBy(desc(promoCodes.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      const formattedList = promoCodeList.map(pc => ({\n        ...pc,\n        discountValue: Number(pc.discountValue),\n        minimumOrderAmount: pc.minimumOrderAmount ? Number(pc.minimumOrderAmount) : null,\n        maximumDiscountAmount: pc.maximumDiscountAmount ? Number(pc.maximumDiscountAmount) : null,\n        isExpired: pc.expiresAt ? new Date(pc.expiresAt) < now : false,\n        isUpcoming: pc.startsAt ? new Date(pc.startsAt) > now : false,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/promo-codes/:id\n * Get promo code details (Admin only)\n */\npromoCodesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [promoCode] = await db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!promoCode) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    sendSuccess(res, {\n      ...promoCode,\n      discountValue: Number(promoCode.discountValue),\n      minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n      maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/promo-codes\n * Create a new promo code (Admin only)\n */\npromoCodesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createPromoCodeSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Check if code already exists\n      const [existing] = await db\n        .select({ id: promoCodes.id })\n        .from(promoCodes)\n        .where(eq(promoCodes.code, data.code));\n\n      if (existing) {\n        throw new ConflictError('Promo code already exists');\n      }\n\n      // Validate percentage discount\n      if (data.discountType === 'percentage' && data.discountValue > 100) {\n        throw new BadRequestError('Percentage discount cannot exceed 100%');\n      }\n\n      // Validate dates\n      if (data.startsAt && data.expiresAt) {\n        if (new Date(data.startsAt) >= new Date(data.expiresAt)) {\n          throw new BadRequestError('Start date must be before expiry date');\n        }\n      }\n\n      const promoCodeResult = await db\n        .insert(promoCodes)\n        .values({\n          ...data,\n          startsAt: data.startsAt ? new Date(data.startsAt) : undefined,\n          expiresAt: data.expiresAt ? new Date(data.expiresAt) : undefined,\n        })\n        .returning();\n      const promoCode = promoCodeResult[0];\n\n      if (!promoCode) {\n        throw new BadRequestError('Failed to create promo code');\n      }\n\n      sendCreated(res, {\n        ...promoCode,\n        discountValue: Number(promoCode.discountValue),\n        minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n        maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/promo-codes/:id\n * Update a promo code (Admin only)\n */\npromoCodesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updatePromoCodeSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(promoCodes)\n        .where(eq(promoCodes.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Promo code not found');\n      }\n\n      // Validate percentage discount\n      if (data.discountType === 'percentage' && data.discountValue && data.discountValue > 100) {\n        throw new BadRequestError('Percentage discount cannot exceed 100%');\n      }\n\n      // Validate dates\n      const startsAt = data.startsAt ? new Date(data.startsAt) : existing.startsAt;\n      const expiresAt = data.expiresAt ? new Date(data.expiresAt) : existing.expiresAt;\n      if (startsAt && expiresAt && startsAt >= expiresAt) {\n        throw new BadRequestError('Start date must be before expiry date');\n      }\n\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      if (data['startsAt']) {\n        updateData['startsAt'] = new Date(data['startsAt'] as string);\n      }\n      if (data['expiresAt']) {\n        updateData['expiresAt'] = new Date(data['expiresAt'] as string);\n      }\n\n      const promoCodeResult = await db\n        .update(promoCodes)\n        .set(updateData)\n        .where(eq(promoCodes.id, id))\n        .returning();\n      const promoCode = promoCodeResult[0];\n\n      if (!promoCode) {\n        throw new NotFoundError('Promo code not found');\n      }\n\n      sendSuccess(res, {\n        ...promoCode,\n        discountValue: Number(promoCode.discountValue),\n        minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n        maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/promo-codes/:id\n * Delete a promo code (Admin only)\n */\npromoCodesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: promoCodes.id, usageCount: promoCodes.usageCount })\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    // Prevent deletion if code has been used\n    if (existing.usageCount > 0) {\n      throw new BadRequestError(\n        'Cannot delete promo code that has been used. Consider deactivating it instead.'\n      );\n    }\n\n    await db.delete(promoCodes).where(eq(promoCodes.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/promo-codes/:id/toggle\n * Toggle promo code active status (Admin only)\n */\npromoCodesRoutes.post('/:id/toggle', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    const promoCodeResult = await db\n      .update(promoCodes)\n      .set({\n        isActive: !existing.isActive,\n        updatedAt: new Date(),\n      })\n      .where(eq(promoCodes.id, id))\n      .returning();\n    const promoCode = promoCodeResult[0];\n\n    if (!promoCode) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    sendSuccess(res, {\n      ...promoCode,\n      discountValue: Number(promoCode.discountValue),\n      minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n      maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/promo-codes/stats/summary\n * Get promo code usage statistics (Admin only)\n */\npromoCodesRoutes.get('/stats/summary', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n\n    // Total promo codes\n    const totalResult = await db\n      .select({ total: sql<number>`count(*)` })\n      .from(promoCodes);\n    const total = totalResult[0]?.total ?? 0;\n\n    // Active promo codes\n    const activeResult = await db\n      .select({ active: sql<number>`count(*)` })\n      .from(promoCodes)\n      .where(\n        and(\n          eq(promoCodes.isActive, true),\n          or(\n            sql`${promoCodes.startsAt} IS NULL`,\n            lte(promoCodes.startsAt, now)\n          ),\n          or(\n            sql`${promoCodes.expiresAt} IS NULL`,\n            gte(promoCodes.expiresAt, now)\n          )\n        )\n      );\n    const active = activeResult[0]?.active ?? 0;\n\n    // Total usage\n    const usageResult = await db\n      .select({ totalUsage: sql<number>`COALESCE(sum(${promoCodes.usageCount}), 0)` })\n      .from(promoCodes);\n    const totalUsage = usageResult[0]?.totalUsage ?? 0;\n\n    // Most used promo codes\n    const topCodes = await db\n      .select({\n        code: promoCodes.code,\n        usageCount: promoCodes.usageCount,\n        discountType: promoCodes.discountType,\n        discountValue: promoCodes.discountValue,\n      })\n      .from(promoCodes)\n      .where(sql`${promoCodes.usageCount} > 0`)\n      .orderBy(desc(promoCodes.usageCount))\n      .limit(5);\n\n    sendSuccess(res, {\n      total: Number(total),\n      active: Number(active),\n      expired: Number(total) - Number(active),\n      totalUsage: Number(totalUsage),\n      topCodes: topCodes.map(c => ({\n        ...c,\n        discountValue: Number(c.discountValue),\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, quotations, quotationItems, customers, products, productVariants, settings, pdfTemplates, eq, sql, desc, and, or, like, gte, lte, isNull } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { pdfService } from '../services/pdf.service';\nimport { notificationService } from '../services/notification.service';\nimport { quotationActivityService } from '../services/quotation-activity.service';\nimport { quotationRevisionService } from '../services/quotation-revision.service';\nimport { generateSecureToken } from '../utils/crypto';\nimport { logger } from '../utils/logger';\n\nexport const quotationsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Schema for quotation items - supports both product-based and custom items\nconst quotationItemSchema = z.object({\n  // For product-based items\n  productId: z.string().uuid().optional(),\n  variantId: z.string().uuid().optional(),\n\n  // For custom items (required if no productId)\n  name: z.string().min(1).max(200).optional(),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  unitPrice: z.number().positive().optional(),\n\n  // Common fields\n  quantity: z.number().int().min(1),\n  customPrice: z.number().positive().optional(), // Override price for product items\n}).refine(\n  (data) => {\n    // Either productId OR (name + unitPrice) must be provided\n    if (data.productId) {\n      return true; // Product-based item\n    }\n    return data.name && data.unitPrice; // Custom item needs name and price\n  },\n  { message: 'Either productId or (name and unitPrice) is required' }\n);\n\nconst createQuotationSchema = z.object({\n  customerId: z.string().uuid().optional(),\n  customerName: z.string().min(1).max(200),\n  customerEmail: z.string().email(),\n  customerPhone: z.string().max(50).optional(),\n  customerCompany: z.string().max(255).optional(),\n  items: z.array(quotationItemSchema).min(1),\n  notes: z.string().max(2000).optional(),\n  terms: z.string().max(2000).optional(),\n  validDays: z.number().int().min(1).max(365).optional().default(30),\n  discountType: z.enum(['percentage', 'fixed']).optional(),\n  discountValue: z.number().min(0).optional(),\n});\n\n// Schema for update quotation items - supports both product-based and custom items\nconst updateQuotationItemSchema = z.object({\n  // For product-based items\n  productId: z.string().uuid().optional(),\n  variantId: z.string().uuid().optional(),\n\n  // For custom items\n  name: z.string().min(1).max(200).optional(),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  unitPrice: z.number().positive().optional(),\n\n  // Common fields\n  quantity: z.number().int().min(1),\n  customPrice: z.number().positive().optional(),\n}).refine(\n  (data) => {\n    if (data.productId) {\n      return true;\n    }\n    return data.name && data.unitPrice;\n  },\n  { message: 'Either productId or (name and unitPrice) is required' }\n);\n\nconst updateQuotationSchema = z.object({\n  customerName: z.string().min(1).max(200).optional(),\n  customerEmail: z.string().email().optional(),\n  customerPhone: z.string().max(50).optional().nullable(),\n  customerCompany: z.string().max(255).optional().nullable(),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n  notes: z.string().max(2000).optional().nullable(),\n  terms: z.string().max(2000).optional().nullable(),\n  validDays: z.number().int().min(1).max(365).optional(),\n  discountType: z.enum(['percentage', 'fixed']).optional(),\n  discountValue: z.number().min(0).optional(),\n  taxRate: z.number().min(0).max(1).optional(), // Decimal 0-1\n  items: z.array(updateQuotationItemSchema).min(1).optional(),\n});\n\nconst quotationFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n  customerId: z.string().uuid().optional(),\n});\n\n// Helper to generate quotation number\nfunction generateQuotationNumber(count: number): string {\n  const year = new Date().getFullYear();\n  const sequence = String(count).padStart(5, '0');\n  return `QT-${year}-${sequence}`;\n}\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/quotations\n * List all quotations (Admin only)\n */\nquotationsRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(quotationFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, status, customerId } = req.query;\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(quotations.quotationNumber, `%${search}%`),\n            like(quotations.customerName, `%${search}%`),\n            like(quotations.customerEmail, `%${search}%`)\n          )\n        );\n      }\n\n      if (status) {\n        conditions.push(eq(quotations.status, status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired'));\n      }\n\n      if (customerId) {\n        conditions.push(eq(quotations.customerId, customerId as string));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(quotations)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const quotationList = await db\n        .select()\n        .from(quotations)\n        .where(whereClause)\n        .orderBy(desc(quotations.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      const formattedList = quotationList.map(q => ({\n        ...q,\n        subtotal: Number(q.subtotal),\n        taxAmount: Number(q.taxAmount || 0),\n        discountAmount: Number(q.discountAmount),\n        total: Number(q.total),\n        isExpired: q.validUntil ? new Date(q.validUntil) < new Date() : false,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/quotations/stats\n * Get quotation statistics (Admin only)\n */\nquotationsRoutes.get('/stats', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);\n\n    // Get total count\n    const [totalResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations);\n\n    // Get counts by status\n    const statusCounts = await db\n      .select({\n        status: quotations.status,\n        count: sql<number>`count(*)`,\n      })\n      .from(quotations)\n      .groupBy(quotations.status);\n\n    // Get total value of all quotations\n    const [totalValueResult] = await db\n      .select({ total: sql<number>`COALESCE(SUM(total), 0)` })\n      .from(quotations);\n\n    // Get total value of accepted quotations\n    const [acceptedValueResult] = await db\n      .select({ total: sql<number>`COALESCE(SUM(total), 0)` })\n      .from(quotations)\n      .where(eq(quotations.status, 'accepted'));\n\n    // Get quotations expiring soon (within 7 days, status = sent)\n    const [expiringSoonResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations)\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          gte(quotations.validUntil, now),\n          lte(quotations.validUntil, sevenDaysFromNow)\n        )\n      );\n\n    // Get quotations created this month\n    const [thisMonthResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations)\n      .where(gte(quotations.createdAt, startOfMonth));\n\n    // Calculate conversion rate (accepted / (accepted + rejected))\n    const statusMap = statusCounts.reduce((acc, item) => {\n      acc[item.status] = Number(item.count);\n      return acc;\n    }, {} as Record<string, number>);\n\n    const acceptedCount = statusMap['accepted'] || 0;\n    const rejectedCount = statusMap['rejected'] || 0;\n    const convertedCount = statusMap['converted'] || 0;\n    const totalDecided = acceptedCount + rejectedCount + convertedCount;\n    const conversionRate = totalDecided > 0 ? ((acceptedCount + convertedCount) / totalDecided) * 100 : 0;\n\n    sendSuccess(res, {\n      total: Number(totalResult?.count ?? 0),\n      byStatus: {\n        draft: statusMap['draft'] || 0,\n        sent: statusMap['sent'] || 0,\n        accepted: statusMap['accepted'] || 0,\n        rejected: statusMap['rejected'] || 0,\n        expired: statusMap['expired'] || 0,\n        converted: statusMap['converted'] || 0,\n      },\n      totalValue: Number(totalValueResult?.total ?? 0),\n      acceptedValue: Number(acceptedValueResult?.total ?? 0),\n      conversionRate: Math.round(conversionRate * 100) / 100,\n      expiringSoon: Number(expiringSoonResult?.count ?? 0),\n      thisMonth: Number(thisMonthResult?.count ?? 0),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Check and Update Expired Quotations\n// ===========================================\n\nquotationsRoutes.post('/check-expired', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n\n    // Find quotations that should be expired:\n    // - Only 'sent' quotations are checked (drafts don't expire automatically)\n    // - validUntil date has passed (validUntil is set when quotation is sent)\n    const expiredQuotations = await db\n      .select({ id: quotations.id, quotationNumber: quotations.quotationNumber })\n      .from(quotations)\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      );\n\n    if (expiredQuotations.length === 0) {\n      sendSuccess(res, {\n        updated: 0,\n        message: 'No quotations to expire'\n      });\n      return;\n    }\n\n    // Update all expired quotations\n    await db\n      .update(quotations)\n      .set({\n        status: 'expired',\n        updatedAt: now\n      })\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      );\n\n    // Log activity for each expired quotation\n    for (const q of expiredQuotations) {\n      await quotationActivityService.logActivity({\n        quotationId: q.id,\n        activityType: 'status_changed',\n        description: `Quotation automatically expired (past valid date)`,\n        actorType: 'system',\n        actorName: 'System',\n        metadata: {\n          previousStatus: 'sent',\n          newStatus: 'expired',\n          automatic: true\n        },\n      });\n    }\n\n    logger.info('Auto-expired quotations', {\n      count: expiredQuotations.length,\n      quotationNumbers: expiredQuotations.map(q => q.quotationNumber)\n    });\n\n    sendSuccess(res, {\n      updated: expiredQuotations.length,\n      quotations: expiredQuotations.map(q => q.quotationNumber),\n      message: `${expiredQuotations.length} quotation(s) marked as expired`\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Bulk Actions Schema\n// ===========================================\n\nconst bulkActionsSchema = z.object({\n  action: z.enum(['delete', 'send', 'changeStatus']),\n  ids: z.array(z.string().uuid()).min(1).max(100),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n}).refine(\n  (data) => {\n    if (data.action === 'changeStatus' && !data.status) {\n      return false;\n    }\n    return true;\n  },\n  { message: 'Status is required for changeStatus action' }\n);\n\n/**\n * POST /api/quotations/bulk\n * Perform bulk actions on quotations (Admin only)\n */\nquotationsRoutes.post(\n  '/bulk',\n  requireAuth,\n  requireAdmin,\n  validateBody(bulkActionsSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { action, ids, status } = req.body;\n      const results: { success: string[]; failed: string[] } = { success: [], failed: [] };\n\n      for (const id of ids) {\n        try {\n          const [quotation] = await db\n            .select()\n            .from(quotations)\n            .where(eq(quotations.id, id));\n\n          if (!quotation) {\n            results.failed.push(id);\n            continue;\n          }\n\n          switch (action) {\n            case 'delete':\n              // Delete associated items first (cascade should handle this but being explicit)\n              await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n              await db.delete(quotations).where(eq(quotations.id, id));\n              results.success.push(id);\n              break;\n\n            case 'send':\n              // Only send draft quotations\n              if (quotation.status !== 'draft') {\n                results.failed.push(id);\n                continue;\n              }\n\n              // Generate acceptance token\n              const acceptanceToken = generateSecureToken(32);\n              const tokenExpiresAt = new Date();\n              tokenExpiresAt.setDate(tokenExpiresAt.getDate() + 30);\n\n              await db\n                .update(quotations)\n                .set({\n                  status: 'sent',\n                  acceptanceToken,\n                  tokenExpiresAt,\n                  updatedAt: new Date(),\n                })\n                .where(eq(quotations.id, id));\n\n              // Log activity\n              await quotationActivityService.logSent(\n                id,\n                quotation.customerEmail,\n                (req as { user?: { name?: string } }).user?.name\n              ).catch(() => {}); // Non-blocking\n\n              results.success.push(id);\n              break;\n\n            case 'changeStatus':\n              if (!status) {\n                results.failed.push(id);\n                continue;\n              }\n\n              await db\n                .update(quotations)\n                .set({\n                  status,\n                  updatedAt: new Date(),\n                })\n                .where(eq(quotations.id, id));\n\n              // Log activity\n              await quotationActivityService.logStatusChanged(\n                id,\n                quotation.status,\n                status,\n                (req as { user?: { name?: string } }).user?.name\n              ).catch(() => {}); // Non-blocking\n\n              results.success.push(id);\n              break;\n          }\n        } catch (error) {\n          logger.error(`Bulk action ${action} failed for ${id}:`, error);\n          results.failed.push(id);\n        }\n      }\n\n      sendSuccess(res, {\n        action,\n        results,\n        message: `Bulk ${action} completed: ${results.success.length} successful, ${results.failed.length} failed`,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/quotations/:id\n * Get quotation details (Admin only)\n */\nquotationsRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    sendSuccess(res, {\n      ...quotation,\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      items: items.map(item => ({\n        ...item,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations\n * Create a new quotation (Admin only)\n */\nquotationsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createQuotationSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate quotation number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(quotations);\n      const qCount = countResult[0]?.count ?? 0;\n      const quotationNumber = generateQuotationNumber(Number(qCount) + 1);\n\n      // Calculate valid until date\n      const validUntil = new Date();\n      validUntil.setDate(validUntil.getDate() + (data.validDays || 30));\n\n      // Process items and calculate totals\n      const processedItems: Array<{\n        productId: string | null;\n        variantId?: string | null;\n        name: string;\n        description?: string;\n        sku: string | null;\n        quantity: number;\n        unitPrice: number;\n        isCustomItem: boolean;\n      }> = [];\n\n      let subtotal = 0;\n\n      for (const item of data.items) {\n        // Check if this is a product-based item or a custom item\n        if (item.productId) {\n          // Product-based item\n          const [product] = await db\n            .select()\n            .from(products)\n            .where(eq(products.id, item.productId));\n\n          if (!product) {\n            throw new BadRequestError(`Product not found: ${item.productId}`);\n          }\n\n          let unitPrice = Number(product.basePrice);\n          let sku = product.sku;\n          let variantId: string | null = null;\n\n          if (item.variantId) {\n            const [variant] = await db\n              .select()\n              .from(productVariants)\n              .where(eq(productVariants.id, item.variantId));\n\n            if (variant) {\n              unitPrice = Number(variant.basePrice);\n              sku = variant.sku;\n              variantId = variant.id;\n            }\n          }\n\n          // Use custom price if provided (admin override)\n          if (item.customPrice) {\n            unitPrice = item.customPrice;\n          }\n\n          const lineTotal = unitPrice * item.quantity;\n          subtotal += lineTotal;\n\n          processedItems.push({\n            productId: item.productId,\n            variantId,\n            name: product.name,\n            description: product.description || undefined,\n            sku,\n            quantity: item.quantity,\n            unitPrice,\n            isCustomItem: false,\n          });\n        } else {\n          // Custom item (no productId)\n          const unitPrice = item.unitPrice!; // Already validated by schema\n          const lineTotal = unitPrice * item.quantity;\n          subtotal += lineTotal;\n\n          processedItems.push({\n            productId: null,\n            variantId: null,\n            name: item.name!, // Already validated by schema\n            description: item.description,\n            sku: item.sku || null,\n            quantity: item.quantity,\n            unitPrice,\n            isCustomItem: true,\n          });\n        }\n      }\n\n      // Apply discount\n      let discountAmount = 0;\n      if (data.discountValue && data.discountValue > 0) {\n        if (data.discountType === 'percentage') {\n          discountAmount = (subtotal * data.discountValue) / 100;\n        } else {\n          discountAmount = Math.min(data.discountValue, subtotal);\n        }\n      }\n\n      // Get tax rate from settings (key is 'tax', not 'tax_rate')\n      const [taxSetting] = await db\n        .select()\n        .from(settings)\n        .where(eq(settings.key, 'tax'));\n\n      // Extract tax rate from the JSON structure\n      let taxRate = 0;\n      if (taxSetting && taxSetting.value && typeof taxSetting.value === 'object') {\n        const taxValue = taxSetting.value as { tax_rate?: number; tax_enabled?: boolean };\n        if (taxValue.tax_enabled && typeof taxValue.tax_rate === 'number') {\n          taxRate = taxValue.tax_rate / 100; // Convert percentage to decimal\n        }\n      }\n\n      // Calculate tax on discounted subtotal\n      const taxableAmount = subtotal - discountAmount;\n      const taxAmount = taxableAmount * taxRate;\n\n      // Calculate total\n      const total = taxableAmount + taxAmount;\n\n      // Create quotation\n      const quotationResult = await db\n        .insert(quotations)\n        .values({\n          quotationNumber,\n          customerId: data.customerId,\n          customerName: data.customerName,\n          customerEmail: data.customerEmail.toLowerCase(),\n          customerPhone: data.customerPhone,\n          customerCompany: data.customerCompany,\n          status: 'draft',\n          currency: 'USD',\n          subtotal: String(subtotal),\n          taxRate: String(taxRate),\n          taxAmount: String(taxAmount),\n          discountType: data.discountType,\n          discountValue: data.discountValue ? String(data.discountValue) : null,\n          discountAmount: String(discountAmount),\n          total: String(total),\n          validUntil,\n          validDays: data.validDays || 30,\n          notes: data.notes,\n          termsAndConditions: data.terms,\n        })\n        .returning();\n      const quotation = quotationResult[0];\n\n      if (!quotation) {\n        throw new BadRequestError('Failed to create quotation');\n      }\n\n      // Create quotation items\n      for (const item of processedItems) {\n        await db.insert(quotationItems).values({\n          quotationId: quotation.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: String(item.unitPrice),\n        });\n      }\n\n      // Log activity\n      await quotationActivityService.logCreated(\n        quotation.id,\n        quotation.quotationNumber\n      );\n\n      sendCreated(res, {\n        id: quotation.id,\n        quotationNumber: quotation.quotationNumber,\n        status: quotation.status,\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/quotations/:id\n * Update quotation (Admin only)\n */\nquotationsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateQuotationSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Quotation not found');\n      }\n\n      // Check what's being updated\n      const isStatusOnlyUpdate = Object.keys(data).length === 1 && data['status'] !== undefined;\n\n      // Only allow editing draft quotations (except for status-only updates)\n      if (existing.status !== 'draft' && !isStatusOnlyUpdate) {\n        throw new BadRequestError('Only draft quotations can be edited. Non-draft quotations can only have their status changed.');\n      }\n\n      // Create revision before making changes\n      await quotationRevisionService.createRevision(\n        id,\n        'Quotation updated',\n        (req as { user?: { id?: string } }).user?.id,\n        (req as { user?: { name?: string } }).user?.name\n      ).catch(() => {}); // Non-blocking\n\n      // Build update data object with proper field mappings\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      // Customer fields\n      if (data['customerName'] !== undefined) {updateData['customerName'] = data['customerName'];}\n      if (data['customerEmail'] !== undefined) {updateData['customerEmail'] = (data['customerEmail'] as string).toLowerCase();}\n      if (data['customerPhone'] !== undefined) {updateData['customerPhone'] = data['customerPhone'] || null;}\n      if (data['customerCompany'] !== undefined) {updateData['customerCompany'] = data['customerCompany'] || null;}\n\n      // Status\n      if (data['status'] !== undefined) {updateData['status'] = data['status'];}\n\n      // Notes and terms (map 'terms' to 'termsAndConditions')\n      if (data['notes'] !== undefined) {updateData['notes'] = data['notes'] || null;}\n      if (data['terms'] !== undefined) {updateData['termsAndConditions'] = data['terms'] || null;}\n\n      // Discount and tax fields\n      if (data['discountType'] !== undefined) {updateData['discountType'] = data['discountType'];}\n      if (data['discountValue'] !== undefined) {updateData['discountValue'] = String(data['discountValue']);}\n      if (data['taxRate'] !== undefined) {updateData['taxRate'] = String(data['taxRate']);}\n\n      // Update valid until if validDays provided\n      if (data['validDays'] !== undefined) {\n        const validUntil = new Date();\n        validUntil.setDate(validUntil.getDate() + (data['validDays'] as number));\n        updateData['validUntil'] = validUntil;\n      }\n\n      // Recalculate totals if discount/tax changed or items updated\n      const dataItems = data['items'] as Array<{productId?: string; variantId?: string; name?: string; description?: string; sku?: string; quantity: number; unitPrice?: number; customPrice?: number}> | undefined;\n      const shouldRecalculate = data['discountType'] !== undefined ||\n                                 data['discountValue'] !== undefined ||\n                                 data['taxRate'] !== undefined ||\n                                 (dataItems && dataItems.length > 0);\n\n      // Handle items update if provided\n      if (dataItems && dataItems.length > 0) {\n        // Delete existing items\n        await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n\n        // Process new items and calculate new subtotal\n        let subtotal = 0;\n        const processedItems: Array<{\n          productId: string | null;\n          variantId?: string | null;\n          name: string;\n          description?: string;\n          sku: string | null;\n          quantity: number;\n          unitPrice: number;\n        }> = [];\n\n        for (const item of dataItems) {\n          // Check if this is a product-based item or a custom item\n          if (item.productId) {\n            // Product-based item\n            const [product] = await db\n              .select()\n              .from(products)\n              .where(eq(products.id, item.productId));\n\n            if (!product) {\n              throw new BadRequestError(`Product not found: ${item.productId}`);\n            }\n\n            let unitPrice = Number(product.basePrice);\n            let sku = product.sku;\n\n            let variantId: string | null = null;\n            if (item.variantId) {\n              const [variant] = await db\n                .select()\n                .from(productVariants)\n                .where(eq(productVariants.id, item.variantId));\n\n              if (variant) {\n                unitPrice = Number(variant.basePrice);\n                sku = variant.sku;\n                variantId = variant.id;\n              }\n            }\n\n            // Use custom price if provided\n            if (item.customPrice) {\n              unitPrice = item.customPrice;\n            }\n\n            const lineTotal = unitPrice * item.quantity;\n            subtotal += lineTotal;\n\n            processedItems.push({\n              productId: item.productId,\n              variantId,\n              name: product.name,\n              description: product.description || undefined,\n              sku,\n              quantity: item.quantity,\n              unitPrice,\n            });\n          } else {\n            // Custom item (no productId)\n            const unitPrice = item.unitPrice!; // Validated by schema\n            const lineTotal = unitPrice * item.quantity;\n            subtotal += lineTotal;\n\n            processedItems.push({\n              productId: null,\n              variantId: null,\n              name: item.name!, // Validated by schema\n              description: item.description,\n              sku: item.sku || null,\n              quantity: item.quantity,\n              unitPrice,\n            });\n          }\n        }\n\n        // Get discount and tax values (prefer new values, fallback to existing)\n        const discountType = data.discountType ?? existing.discountType ?? 'percentage';\n        const discountValue = data.discountValue ?? Number(existing.discountValue || 0);\n        const taxRate = data.taxRate ?? Number(existing.taxRate || 0);\n\n        // Calculate discount amount based on type\n        let discountAmount = 0;\n        if (discountType === 'percentage') {\n          discountAmount = (subtotal * discountValue) / 100;\n        } else {\n          discountAmount = Math.min(discountValue, subtotal);\n        }\n\n        // Calculate tax and total\n        const taxableAmount = subtotal - discountAmount;\n        const taxAmount = taxableAmount * taxRate;\n        const total = taxableAmount + taxAmount;\n\n        // Update pricing fields\n        updateData['subtotal'] = String(subtotal);\n        updateData['discountAmount'] = String(discountAmount);\n        updateData['taxAmount'] = String(taxAmount);\n        updateData['total'] = String(total);\n\n        // Insert new items\n        for (const item of processedItems) {\n          await db.insert(quotationItems).values({\n            quotationId: id,\n            productId: item.productId,\n            variantId: item.variantId,\n            name: item.name,\n            description: item.description,\n            sku: item.sku,\n            quantity: item.quantity,\n            unitPrice: String(item.unitPrice),\n          });\n        }\n      } else if (shouldRecalculate) {\n        // Recalculate totals based on existing items when only discount/tax changed\n        const existingItems = await db\n          .select()\n          .from(quotationItems)\n          .where(eq(quotationItems.quotationId, id));\n\n        const subtotal = existingItems.reduce((sum, item) => {\n          return sum + Number(item.unitPrice) * item.quantity;\n        }, 0);\n\n        // Get discount and tax values\n        const discountType = (data['discountType'] ?? existing.discountType ?? 'percentage') as string;\n        const discountValue = (data['discountValue'] ?? Number(existing.discountValue || 0)) as number;\n        const taxRate = (data['taxRate'] ?? Number(existing.taxRate || 0)) as number;\n\n        // Calculate discount amount based on type\n        let discountAmount = 0;\n        if (discountType === 'percentage') {\n          discountAmount = (subtotal * discountValue) / 100;\n        } else {\n          discountAmount = Math.min(discountValue, subtotal);\n        }\n\n        // Calculate tax and total\n        const taxableAmount = subtotal - discountAmount;\n        const taxAmount = taxableAmount * taxRate;\n        const total = taxableAmount + taxAmount;\n\n        // Update pricing fields\n        updateData['subtotal'] = String(subtotal);\n        updateData['discountAmount'] = String(discountAmount);\n        updateData['taxAmount'] = String(taxAmount);\n        updateData['total'] = String(total);\n      }\n\n      const quotationResult = await db\n        .update(quotations)\n        .set(updateData)\n        .where(eq(quotations.id, id))\n        .returning();\n      const quotation = quotationResult[0];\n\n      if (!quotation) {\n        throw new NotFoundError('Quotation not found');\n      }\n\n      // Fetch updated items\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, id));\n\n      sendSuccess(res, {\n        ...quotation,\n        subtotal: Number(quotation.subtotal),\n        taxRate: Number(quotation.taxRate || 0),\n        taxAmount: Number(quotation.taxAmount || 0),\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        items: items.map(item => ({\n          ...item,\n          unitPrice: Number(item.unitPrice),\n          lineTotal: Number(item.unitPrice) * item.quantity,\n        })),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/quotations/:id\n * Delete quotation (Admin only)\n */\nquotationsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: quotations.id, status: quotations.status })\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Only allow deletion of draft, rejected, or expired quotations\n    // Sent and accepted quotations should be preserved for business records\n    const deletableStatuses = ['draft', 'rejected', 'expired'];\n    if (!deletableStatuses.includes(existing.status)) {\n      throw new BadRequestError('Only draft, rejected, or expired quotations can be deleted. Sent and accepted quotations must be preserved.');\n    }\n\n    // Delete items first\n    await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n\n    // Delete quotation\n    await db.delete(quotations).where(eq(quotations.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/activities\n * Get activity timeline for a quotation (Admin only)\n */\nquotationsRoutes.get('/:id/activities', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n\n    const activities = await quotationActivityService.getActivities(id);\n\n    sendSuccess(res, activities);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions\n * Get revision history for a quotation (Admin only)\n */\nquotationsRoutes.get('/:id/revisions', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisions = await quotationRevisionService.getRevisions(id);\n    sendSuccess(res, revisions);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions/:revisionId\n * Get a specific revision (Admin only)\n */\nquotationsRoutes.get('/:id/revisions/:revisionId', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const revisionId = req.params['revisionId'] as string;\n    const revision = await quotationRevisionService.getRevision(revisionId);\n\n    if (!revision) {\n      throw new NotFoundError('Revision not found');\n    }\n\n    sendSuccess(res, revision);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/revisions/:revisionId/restore\n * Restore a quotation to a previous revision (Admin only)\n */\nquotationsRoutes.post('/:id/revisions/:revisionId/restore', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisionId = req.params['revisionId'] as string;\n\n    const success = await quotationRevisionService.restoreRevision(\n      id,\n      revisionId,\n      (req as { user?: { id?: string } }).user?.id,\n      (req as { user?: { name?: string } }).user?.name\n    );\n\n    if (!success) {\n      throw new NotFoundError('Revision not found or does not belong to this quotation');\n    }\n\n    // Log activity\n    await quotationActivityService.logUpdated(id, '', ['Restored from previous version']).catch(() => {});\n\n    sendSuccess(res, { message: 'Quotation restored from revision successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions/:revisionId/compare\n * Compare a revision with current state or another revision (Admin only)\n * Query param: ?compareWith=<revisionId> to compare with another revision\n */\nquotationsRoutes.get('/:id/revisions/:revisionId/compare', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisionId = req.params['revisionId'] as string;\n    const compareWith = req.query['compareWith'] as string | undefined;\n\n    const comparison = await quotationRevisionService.compareRevisions(id, revisionId, compareWith);\n\n    if (!comparison) {\n      throw new NotFoundError('Revision not found');\n    }\n\n    sendSuccess(res, comparison);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/pdf\n * Generate and download quotation PDF (Admin only)\n * Optional query param: ?templateId=<uuid> to use specific template\n */\nquotationsRoutes.get('/:id/pdf', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const templateId = req.query['templateId'] as string | undefined;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items with product slug for linking\n    const items = await db\n      .select({\n        id: quotationItems.id,\n        quotationId: quotationItems.quotationId,\n        productId: quotationItems.productId,\n        variantId: quotationItems.variantId,\n        name: quotationItems.name,\n        description: quotationItems.description,\n        sku: quotationItems.sku,\n        quantity: quotationItems.quantity,\n        unitPrice: quotationItems.unitPrice,\n        createdAt: quotationItems.createdAt,\n        productSlug: products.slug,\n      })\n      .from(quotationItems)\n      .leftJoin(products, eq(quotationItems.productId, products.id))\n      .where(eq(quotationItems.quotationId, id));\n\n    // Build website URL for product links\n    const websiteUrl = process.env['WEB_URL'] || 'https://lab404electronics.com';\n\n    // Get company settings\n    const companySettings = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map<string, string>(companySettings.map(s => [s.key, s.value as string]));\n\n    // Get PDF template (use specified, quotation's template, or default)\n    let template = null;\n\n    if (templateId) {\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, templateId));\n    } else if (quotation.pdfTemplateId) {\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, quotation.pdfTemplateId));\n    } else {\n      // Get default template\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.isDefault, true))\n        .limit(1);\n    }\n\n    // Build template config for PDF service\n    const templateConfig = template ? {\n      primaryColor: template.primaryColor,\n      accentColor: template.accentColor,\n      logoUrl: template.logoUrl || undefined,\n      showCompanyLogo: template.showCompanyLogo,\n      showLineItemImages: template.showLineItemImages,\n      showLineItemDescription: template.showLineItemDescription,\n      showSku: template.showSku,\n      headerText: template.headerText || undefined,\n      footerText: template.footerText || undefined,\n      thankYouMessage: template.thankYouMessage || undefined,\n    } : undefined;\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      createdAt: quotation.createdAt,\n      validUntil: quotation.validUntil!,\n      status: quotation.status,\n\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n\n      items: items.map(item => ({\n        productName: item.name,\n        sku: item.sku || '',\n        description: item.description || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n        variantOptions: undefined,\n        productUrl: item.productSlug ? `${websiteUrl}/products/${item.productSlug}` : undefined,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0, // Not in schema\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || settingsMap.get('quotation_terms') || undefined,\n\n      companyName: settingsMap.get('company_name') || 'Lab404 Electronics',\n      companyAddress: settingsMap.get('company_address') || '',\n      companyPhone: settingsMap.get('company_phone') || '',\n      companyEmail: settingsMap.get('company_email') || '',\n      companyWebsite: settingsMap.get('company_website') || undefined,\n    }, templateConfig);\n\n    // Set response headers\n    res.setHeader('Content-Type', 'application/pdf');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"${quotation.quotationNumber}.pdf\"`\n    );\n    res.setHeader('Content-Length', pdfBuffer.length);\n\n    res.send(pdfBuffer);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/send\n * Send quotation to customer via email (Admin only)\n */\nquotationsRoutes.post('/:id/send', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    if (quotation.status !== 'draft') {\n      throw new BadRequestError('Only draft quotations can be sent');\n    }\n\n    // Get quotation items with product slug for linking\n    const items = await db\n      .select({\n        id: quotationItems.id,\n        quotationId: quotationItems.quotationId,\n        productId: quotationItems.productId,\n        variantId: quotationItems.variantId,\n        name: quotationItems.name,\n        description: quotationItems.description,\n        sku: quotationItems.sku,\n        quantity: quotationItems.quantity,\n        unitPrice: quotationItems.unitPrice,\n        createdAt: quotationItems.createdAt,\n        productSlug: products.slug,\n      })\n      .from(quotationItems)\n      .leftJoin(products, eq(quotationItems.productId, products.id))\n      .where(eq(quotationItems.quotationId, id));\n\n    // Build website URL for product links\n    const websiteUrl = process.env['WEB_URL'] || 'https://lab404electronics.com';\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    // Get PDF template config if exists\n    let templateConfig = {};\n    if (quotation.pdfTemplateId) {\n      const [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, quotation.pdfTemplateId));\n      if (template) {\n        templateConfig = {\n          primaryColor: template.primaryColor || undefined,\n          accentColor: template.accentColor || undefined,\n          logoUrl: template.logoUrl || undefined,\n          showCompanyLogo: template.showCompanyLogo ?? true,\n          showLineItemImages: template.showLineItemImages ?? false,\n          headerText: template.headerText || undefined,\n          footerText: template.footerText || undefined,\n        };\n      }\n    }\n\n    const companyName = (settingsMap.get('company_name') as string) || 'Lab404 Electronics';\n    const companyEmail = (settingsMap.get('company_email') as string) || undefined;\n    const companyPhone = (settingsMap.get('company_phone') as string) || undefined;\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n      customerAddress: quotation.customerAddress as Record<string, string> | undefined,\n\n      status: quotation.status,\n      validUntil: quotation.validUntil || undefined,\n      createdAt: quotation.createdAt,\n\n      items: items.map(item => ({\n        productName: item.name,\n        description: item.description || undefined,\n        sku: item.sku || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n        productUrl: item.productSlug ? `${websiteUrl}/products/${item.productSlug}` : undefined,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0,\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || (settingsMap.get('quotation_terms') as string) || undefined,\n\n      companyName,\n      companyAddress: (settingsMap.get('company_address') as string) || '',\n      companyPhone: companyPhone || '',\n      companyEmail: companyEmail || '',\n      companyWebsite: (settingsMap.get('company_website') as string) || undefined,\n    }, templateConfig);\n\n    // Send email with PDF attachment\n    const emailSent = await notificationService.sendQuotationToCustomer(\n      {\n        quotationNumber: quotation.quotationNumber,\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil || null,\n        currency: quotation.currency,\n        itemCount: items.length,\n        companyName: companyName as string,\n        companyEmail: companyEmail as string | undefined,\n        companyPhone: companyPhone as string | undefined,\n      },\n      pdfBuffer\n    );\n\n    if (!emailSent) {\n      logger.warn('Email not sent - SMTP may not be configured', {\n        quotationId: id,\n        customerEmail: quotation.customerEmail,\n      });\n    }\n\n    // Generate acceptance token (valid for 30 days)\n    const acceptanceToken = generateSecureToken(32);\n    const tokenExpiresAt = new Date();\n    tokenExpiresAt.setDate(tokenExpiresAt.getDate() + 30);\n\n    // Calculate validUntil from NOW + quotation's validDays\n    // This ensures the expiry countdown starts when the quotation is sent\n    const validDays = quotation.validDays || 30;\n    const newValidUntil = new Date();\n    newValidUntil.setDate(newValidUntil.getDate() + validDays);\n\n    // Update status to sent, recalculate validUntil, and add acceptance token\n    await db\n      .update(quotations)\n      .set({\n        status: 'sent',\n        validUntil: newValidUntil,\n        acceptanceToken,\n        tokenExpiresAt,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, id));\n\n    // Log activity\n    await quotationActivityService.logSent(id, quotation.customerEmail);\n\n    // Generate acceptance link\n    const baseUrl = process.env['WEB_APP_URL'] || 'http://localhost:3000';\n    const acceptanceLink = `${baseUrl}/quotations/view/${acceptanceToken}`;\n\n    sendSuccess(res, {\n      message: emailSent ? 'Quotation sent successfully' : 'Quotation marked as sent (email not configured)',\n      emailSent,\n      quotationNumber: quotation.quotationNumber,\n      sentTo: quotation.customerEmail,\n      acceptanceLink,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/convert-to-order\n * Convert accepted quotation to order (Admin only)\n */\nquotationsRoutes.post('/:id/convert-to-order', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    if (quotation.status !== 'accepted') {\n      throw new BadRequestError('Only accepted quotations can be converted to orders');\n    }\n\n    if (quotation.convertedToOrderId) {\n      throw new BadRequestError('Quotation has already been converted to an order');\n    }\n\n    // TODO: Implement order creation from quotation\n    // This would involve creating an order with the quotation's items and pricing\n\n    sendSuccess(res, {\n      message: 'Order creation from quotation not yet implemented',\n      quotationId: quotation.id,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/duplicate\n * Duplicate a quotation (Admin only)\n */\nquotationsRoutes.post('/:id/duplicate', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [original] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!original) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    // Generate new quotation number\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations);\n    const count = countResult[0]?.count ?? 0;\n    const quotationNumber = generateQuotationNumber(Number(count) + 1);\n\n    // Calculate new valid until\n    const validUntil = new Date();\n    validUntil.setDate(validUntil.getDate() + 30);\n\n    // Create new quotation\n    const [newQuotation] = await db\n      .insert(quotations)\n      .values({\n        quotationNumber,\n        customerId: original.customerId,\n        customerName: original.customerName,\n        customerEmail: original.customerEmail,\n        customerPhone: original.customerPhone,\n        customerCompany: original.customerCompany,\n        status: 'draft',\n        currency: original.currency,\n        subtotal: original.subtotal,\n        taxRate: original.taxRate,\n        taxAmount: original.taxAmount,\n        discountAmount: original.discountAmount,\n        total: original.total,\n        validUntil,\n        notes: original.notes,\n        termsAndConditions: original.termsAndConditions,\n      })\n      .returning();\n\n    if (!newQuotation) {\n      throw new BadRequestError('Failed to create quotation');\n    }\n\n    // Copy items\n    for (const item of items) {\n      await db.insert(quotationItems).values({\n        quotationId: newQuotation.id,\n        productId: item.productId,\n        name: item.name,\n        sku: item.sku,\n        description: item.description,\n        quantity: item.quantity,\n        unitPrice: item.unitPrice,\n      });\n    }\n\n    // Log activities for both original and new quotation\n    await quotationActivityService.logDuplicated(\n      original.id,\n      newQuotation.id,\n      newQuotation.quotationNumber\n    );\n    await quotationActivityService.logCreated(\n      newQuotation.id,\n      newQuotation.quotationNumber\n    );\n\n    sendCreated(res, {\n      id: newQuotation.id,\n      quotationNumber: newQuotation.quotationNumber,\n      status: newQuotation.status,\n      total: Number(newQuotation.total),\n      validUntil: newQuotation.validUntil,\n      duplicatedFrom: original.quotationNumber,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Public Routes (No Authentication Required)\n// ===========================================\n\n/**\n * GET /api/quotations/public/:token\n * View quotation by acceptance token (Public - no auth)\n */\nquotationsRoutes.get('/public/:token', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, quotation.id));\n\n    // Update viewedAt if not already viewed\n    if (!quotation.viewedAt) {\n      await db\n        .update(quotations)\n        .set({ viewedAt: new Date() })\n        .where(eq(quotations.id, quotation.id));\n\n      // Log activity\n      await quotationActivityService.logViewed(quotation.id, quotation.customerName);\n    }\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    sendSuccess(res, {\n      id: quotation.id,\n      quotationNumber: quotation.quotationNumber,\n      status: quotation.status,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerCompany: quotation.customerCompany,\n\n      items: items.map(item => ({\n        name: item.name,\n        description: item.description,\n        sku: item.sku,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes,\n      termsAndConditions: quotation.termsAndConditions,\n      validUntil: quotation.validUntil,\n      createdAt: quotation.createdAt,\n\n      company: {\n        name: settingsMap.get('company_name') || 'Lab404 Electronics',\n        email: settingsMap.get('company_email'),\n        phone: settingsMap.get('company_phone'),\n        address: settingsMap.get('company_address'),\n        website: settingsMap.get('company_website'),\n      },\n\n      canAccept: quotation.status === 'sent',\n      canReject: quotation.status === 'sent',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/public/:token/accept\n * Accept quotation (Public - no auth)\n */\nquotationsRoutes.post('/public/:token/accept', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    if (quotation.status !== 'sent') {\n      throw new BadRequestError(`Quotation cannot be accepted (current status: ${quotation.status})`);\n    }\n\n    // Update status to accepted\n    await db\n      .update(quotations)\n      .set({\n        status: 'accepted',\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotation.id));\n\n    // Log activity\n    await quotationActivityService.logAccepted(quotation.id, quotation.customerName);\n\n    sendSuccess(res, {\n      message: 'Quotation accepted successfully',\n      quotationNumber: quotation.quotationNumber,\n      status: 'accepted',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\nconst rejectQuotationSchema = z.object({\n  reason: z.string().max(1000).optional(),\n});\n\n/**\n * POST /api/quotations/public/:token/reject\n * Reject quotation (Public - no auth)\n */\nquotationsRoutes.post('/public/:token/reject', validateBody(rejectQuotationSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n    const { reason } = req.body;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    if (quotation.status !== 'sent') {\n      throw new BadRequestError(`Quotation cannot be rejected (current status: ${quotation.status})`);\n    }\n\n    // Update status to rejected\n    await db\n      .update(quotations)\n      .set({\n        status: 'rejected',\n        notes: reason ? `${quotation.notes || ''}\\n\\nRejection reason: ${reason}`.trim() : quotation.notes,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotation.id));\n\n    // Log activity\n    await quotationActivityService.logRejected(quotation.id, reason, quotation.customerName);\n\n    sendSuccess(res, {\n      message: 'Quotation rejected',\n      quotationNumber: quotation.quotationNumber,\n      status: 'rejected',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/public/:token/pdf\n * Download quotation PDF (Public - no auth)\n */\nquotationsRoutes.get('/public/:token/pdf', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    // Get items with product slug for linking\n    const items = await db\n      .select({\n        id: quotationItems.id,\n        quotationId: quotationItems.quotationId,\n        productId: quotationItems.productId,\n        variantId: quotationItems.variantId,\n        name: quotationItems.name,\n        description: quotationItems.description,\n        sku: quotationItems.sku,\n        quantity: quotationItems.quantity,\n        unitPrice: quotationItems.unitPrice,\n        createdAt: quotationItems.createdAt,\n        productSlug: products.slug,\n      })\n      .from(quotationItems)\n      .leftJoin(products, eq(quotationItems.productId, products.id))\n      .where(eq(quotationItems.quotationId, quotation.id));\n\n    // Build website URL for product links\n    const websiteUrl = process.env['WEB_URL'] || 'https://lab404electronics.com';\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n      customerAddress: quotation.customerAddress as Record<string, string> | undefined,\n\n      status: quotation.status,\n      validUntil: quotation.validUntil || undefined,\n      createdAt: quotation.createdAt,\n\n      items: items.map(item => ({\n        productName: item.name,\n        description: item.description || undefined,\n        sku: item.sku || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n        productUrl: item.productSlug ? `${websiteUrl}/products/${item.productSlug}` : undefined,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0,\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || (settingsMap.get('quotation_terms') as string) || undefined,\n\n      companyName: (settingsMap.get('company_name') as string) || 'Lab404 Electronics',\n      companyAddress: (settingsMap.get('company_address') as string) || '',\n      companyPhone: (settingsMap.get('company_phone') as string) || '',\n      companyEmail: (settingsMap.get('company_email') as string) || '',\n      companyWebsite: (settingsMap.get('company_website') as string) || undefined,\n    });\n\n    res.setHeader('Content-Type', 'application/pdf');\n    res.setHeader('Content-Disposition', `attachment; filename=\"${quotation.quotationNumber}.pdf\"`);\n    res.send(pdfBuffer);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { getDb, quotationActivities, desc, eq } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\ntype ActivityType =\n  | 'created'\n  | 'updated'\n  | 'sent'\n  | 'viewed'\n  | 'accepted'\n  | 'rejected'\n  | 'expired'\n  | 'converted'\n  | 'duplicated'\n  | 'pdf_generated'\n  | 'note_added'\n  | 'status_changed';\n\ntype ActorType = 'system' | 'admin' | 'customer';\n\ninterface LogActivityParams {\n  quotationId: string;\n  activityType: ActivityType;\n  description: string;\n  actorType?: ActorType;\n  actorId?: string;\n  actorName?: string;\n  metadata?: Record<string, unknown>;\n}\n\ninterface Activity {\n  id: string;\n  quotationId: string;\n  activityType: string;\n  description: string;\n  actorType: string;\n  actorId: string | null;\n  actorName: string | null;\n  metadata: Record<string, unknown> | null;\n  createdAt: Date;\n}\n\nclass QuotationActivityService {\n  /**\n   * Log an activity for a quotation\n   */\n  async logActivity(params: LogActivityParams): Promise<void> {\n    try {\n      const db = getDb();\n\n      await db.insert(quotationActivities).values({\n        quotationId: params.quotationId,\n        activityType: params.activityType,\n        description: params.description,\n        actorType: params.actorType || 'system',\n        actorId: params.actorId,\n        actorName: params.actorName,\n        metadata: params.metadata,\n      });\n\n      logger.debug('Activity logged', {\n        quotationId: params.quotationId,\n        activityType: params.activityType,\n      });\n    } catch (error) {\n      // Don't throw - activity logging should not break main flow\n      logger.error('Failed to log activity', { error, params });\n    }\n  }\n\n  /**\n   * Get activities for a quotation\n   */\n  async getActivities(quotationId: string, limit = 50): Promise<Activity[]> {\n    const db = getDb();\n\n    const activities = await db\n      .select()\n      .from(quotationActivities)\n      .where(eq(quotationActivities.quotationId, quotationId))\n      .orderBy(desc(quotationActivities.createdAt))\n      .limit(limit);\n\n    return activities as Activity[];\n  }\n\n  // Helper methods for common activity types\n\n  async logCreated(quotationId: string, quotationNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'created',\n      description: `Quotation ${quotationNumber} was created`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { quotationNumber },\n    });\n  }\n\n  async logUpdated(quotationId: string, quotationNumber: string, changes?: string[], actorName?: string): Promise<void> {\n    const description = changes?.length\n      ? `Quotation updated: ${changes.join(', ')}`\n      : `Quotation ${quotationNumber} was updated`;\n\n    await this.logActivity({\n      quotationId,\n      activityType: 'updated',\n      description,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { changes },\n    });\n  }\n\n  async logSent(quotationId: string, recipientEmail: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'sent',\n      description: `Quotation sent to ${recipientEmail}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { recipientEmail },\n    });\n  }\n\n  async logViewed(quotationId: string, viewerInfo?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'viewed',\n      description: viewerInfo ? `Quotation viewed by ${viewerInfo}` : 'Quotation was viewed',\n      actorType: 'customer',\n      metadata: { viewerInfo },\n    });\n  }\n\n  async logAccepted(quotationId: string, customerName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'accepted',\n      description: customerName\n        ? `Quotation accepted by ${customerName}`\n        : 'Quotation was accepted',\n      actorType: 'customer',\n      actorName: customerName,\n    });\n  }\n\n  async logRejected(quotationId: string, reason?: string, customerName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'rejected',\n      description: reason\n        ? `Quotation rejected: ${reason}`\n        : 'Quotation was rejected',\n      actorType: 'customer',\n      actorName: customerName,\n      metadata: { reason },\n    });\n  }\n\n  async logExpired(quotationId: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'expired',\n      description: 'Quotation has expired',\n      actorType: 'system',\n    });\n  }\n\n  async logConverted(quotationId: string, orderId: string, orderNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'converted',\n      description: `Quotation converted to order ${orderNumber}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { orderId, orderNumber },\n    });\n  }\n\n  async logDuplicated(quotationId: string, newQuotationId: string, newQuotationNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'duplicated',\n      description: `Quotation duplicated as ${newQuotationNumber}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { newQuotationId, newQuotationNumber },\n    });\n  }\n\n  async logPdfGenerated(quotationId: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'pdf_generated',\n      description: 'PDF was generated',\n      actorType: 'system',\n    });\n  }\n\n  async logStatusChanged(quotationId: string, oldStatus: string, newStatus: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'status_changed',\n      description: `Status changed from ${oldStatus} to ${newStatus}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { oldStatus, newStatus },\n    });\n  }\n}\n\nexport const quotationActivityService = new QuotationActivityService();\n","import { getDb, quotations, quotationItems, quotationRevisions, eq, desc, sql } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\ninterface RevisionSnapshot {\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string | null;\n  customerCompany?: string | null;\n  status: string;\n  subtotal: number;\n  taxRate?: number;\n  taxAmount?: number;\n  discountType?: string | null;\n  discountValue?: number;\n  discountAmount: number;\n  total: number;\n  validUntil?: Date | null;\n  notes?: string | null;\n  termsAndConditions?: string | null;\n  items: Array<{\n    productId?: string | null;\n    variantId?: string | null;\n    name: string;\n    description?: string | null;\n    sku?: string | null;\n    quantity: number;\n    unitPrice: number;\n  }>;\n}\n\ninterface Revision {\n  id: string;\n  quotationId: string;\n  versionNumber: number;\n  snapshot: RevisionSnapshot;\n  changeDescription: string | null;\n  createdBy: string | null;\n  createdByName: string | null;\n  createdAt: Date;\n}\n\nclass QuotationRevisionService {\n  /**\n   * Create a revision snapshot before updating a quotation\n   */\n  async createRevision(\n    quotationId: string,\n    changeDescription?: string,\n    createdBy?: string,\n    createdByName?: string\n  ): Promise<void> {\n    try {\n      const db = getDb();\n\n      // Get current quotation state\n      const [quotation] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, quotationId));\n\n      if (!quotation) {\n        logger.warn('Cannot create revision: Quotation not found', { quotationId });\n        return;\n      }\n\n      // Get current items\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, quotationId));\n\n      // Get the next version number\n      const [lastRevision] = await db\n        .select({ maxVersion: sql<number>`COALESCE(MAX(${quotationRevisions.versionNumber}), 0)` })\n        .from(quotationRevisions)\n        .where(eq(quotationRevisions.quotationId, quotationId));\n\n      const nextVersion = (lastRevision?.maxVersion || 0) + 1;\n\n      // Create snapshot\n      const snapshot: RevisionSnapshot = {\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        customerPhone: quotation.customerPhone,\n        customerCompany: quotation.customerCompany,\n        status: quotation.status,\n        subtotal: Number(quotation.subtotal),\n        taxRate: quotation.taxRate ? Number(quotation.taxRate) : undefined,\n        taxAmount: quotation.taxAmount ? Number(quotation.taxAmount) : undefined,\n        discountType: quotation.discountType,\n        discountValue: quotation.discountValue ? Number(quotation.discountValue) : undefined,\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n        notes: quotation.notes,\n        termsAndConditions: quotation.termsAndConditions,\n        items: items.map((item) => ({\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPrice),\n        })),\n      };\n\n      // Save revision\n      await db.insert(quotationRevisions).values({\n        quotationId,\n        versionNumber: nextVersion,\n        snapshot,\n        changeDescription,\n        createdBy,\n        createdByName,\n      });\n\n      logger.debug('Revision created', {\n        quotationId,\n        versionNumber: nextVersion,\n      });\n    } catch (error) {\n      // Don't throw - revision creation should not break main flow\n      logger.error('Failed to create revision', { error, quotationId });\n    }\n  }\n\n  /**\n   * Get all revisions for a quotation\n   */\n  async getRevisions(quotationId: string): Promise<Revision[]> {\n    const db = getDb();\n\n    const revisions = await db\n      .select()\n      .from(quotationRevisions)\n      .where(eq(quotationRevisions.quotationId, quotationId))\n      .orderBy(desc(quotationRevisions.versionNumber));\n\n    return revisions as Revision[];\n  }\n\n  /**\n   * Get a specific revision\n   */\n  async getRevision(revisionId: string): Promise<Revision | null> {\n    const db = getDb();\n\n    const [revision] = await db\n      .select()\n      .from(quotationRevisions)\n      .where(eq(quotationRevisions.id, revisionId));\n\n    return (revision as Revision) || null;\n  }\n\n  /**\n   * Compare two revisions or a revision with current state\n   */\n  async compareRevisions(\n    quotationId: string,\n    revisionIdA: string,\n    revisionIdB?: string // If not provided, compare with current state\n  ): Promise<{\n    versionA: number | 'current';\n    versionB: number | 'current';\n    snapshotA: RevisionSnapshot;\n    snapshotB: RevisionSnapshot;\n    changes: Array<{\n      field: string;\n      oldValue: unknown;\n      newValue: unknown;\n    }>;\n  } | null> {\n    const db = getDb();\n\n    // Get revision A\n    const revisionA = await this.getRevision(revisionIdA);\n    if (!revisionA) {return null;}\n\n    let snapshotB: RevisionSnapshot;\n    let versionB: number | 'current';\n\n    if (revisionIdB) {\n      // Compare with another revision\n      const revisionB = await this.getRevision(revisionIdB);\n      if (!revisionB) {return null;}\n      snapshotB = revisionB.snapshot;\n      versionB = revisionB.versionNumber;\n    } else {\n      // Compare with current state\n      const [quotation] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, quotationId));\n\n      if (!quotation) {return null;}\n\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, quotationId));\n\n      snapshotB = {\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        customerPhone: quotation.customerPhone,\n        customerCompany: quotation.customerCompany,\n        status: quotation.status,\n        subtotal: Number(quotation.subtotal),\n        taxRate: quotation.taxRate ? Number(quotation.taxRate) : undefined,\n        taxAmount: quotation.taxAmount ? Number(quotation.taxAmount) : undefined,\n        discountType: quotation.discountType,\n        discountValue: quotation.discountValue ? Number(quotation.discountValue) : undefined,\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n        notes: quotation.notes,\n        termsAndConditions: quotation.termsAndConditions,\n        items: items.map((item) => ({\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPrice),\n        })),\n      };\n      versionB = 'current';\n    }\n\n    // Compute changes\n    const changes: Array<{ field: string; oldValue: unknown; newValue: unknown }> = [];\n\n    const fieldsToCompare = [\n      'customerName',\n      'customerEmail',\n      'customerPhone',\n      'customerCompany',\n      'status',\n      'subtotal',\n      'taxRate',\n      'taxAmount',\n      'discountType',\n      'discountValue',\n      'discountAmount',\n      'total',\n      'notes',\n      'termsAndConditions',\n    ];\n\n    for (const field of fieldsToCompare) {\n      const oldValue = (revisionA.snapshot as unknown as Record<string, unknown>)[field];\n      const newValue = (snapshotB as unknown as Record<string, unknown>)[field];\n      if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {\n        changes.push({ field, oldValue, newValue });\n      }\n    }\n\n    // Compare items (simplified - just check if different)\n    if (JSON.stringify(revisionA.snapshot.items) !== JSON.stringify(snapshotB.items)) {\n      changes.push({\n        field: 'items',\n        oldValue: `${revisionA.snapshot.items.length} items`,\n        newValue: `${snapshotB.items.length} items`,\n      });\n    }\n\n    return {\n      versionA: revisionA.versionNumber,\n      versionB,\n      snapshotA: revisionA.snapshot,\n      snapshotB,\n      changes,\n    };\n  }\n\n  /**\n   * Restore a quotation to a previous revision\n   */\n  async restoreRevision(\n    quotationId: string,\n    revisionId: string,\n    restoredBy?: string,\n    restoredByName?: string\n  ): Promise<boolean> {\n    const db = getDb();\n\n    const revision = await this.getRevision(revisionId);\n    if (!revision || revision.quotationId !== quotationId) {\n      return false;\n    }\n\n    // Create a revision of current state before restoring\n    await this.createRevision(\n      quotationId,\n      `Restored from version ${revision.versionNumber}`,\n      restoredBy,\n      restoredByName\n    );\n\n    // Delete current items\n    await db.delete(quotationItems).where(eq(quotationItems.quotationId, quotationId));\n\n    // Restore quotation fields\n    await db\n      .update(quotations)\n      .set({\n        customerName: revision.snapshot.customerName,\n        customerEmail: revision.snapshot.customerEmail,\n        customerPhone: revision.snapshot.customerPhone,\n        customerCompany: revision.snapshot.customerCompany,\n        status: revision.snapshot.status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired',\n        subtotal: String(revision.snapshot.subtotal),\n        taxRate: revision.snapshot.taxRate ? String(revision.snapshot.taxRate) : null,\n        taxAmount: revision.snapshot.taxAmount ? String(revision.snapshot.taxAmount) : null,\n        discountType: revision.snapshot.discountType,\n        discountValue: revision.snapshot.discountValue ? String(revision.snapshot.discountValue) : null,\n        discountAmount: String(revision.snapshot.discountAmount),\n        total: String(revision.snapshot.total),\n        notes: revision.snapshot.notes,\n        termsAndConditions: revision.snapshot.termsAndConditions,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotationId));\n\n    // Restore items\n    for (const item of revision.snapshot.items) {\n      await db.insert(quotationItems).values({\n        quotationId,\n        productId: item.productId,\n        variantId: item.variantId,\n        name: item.name,\n        description: item.description,\n        sku: item.sku,\n        quantity: item.quantity,\n        unitPrice: String(item.unitPrice),\n      });\n    }\n\n    logger.info('Quotation restored from revision', {\n      quotationId,\n      revisionId,\n      versionNumber: revision.versionNumber,\n    });\n\n    return true;\n  }\n}\n\nexport const quotationRevisionService = new QuotationRevisionService();\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, quotationTemplates, eq, desc } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\n\nexport const quotationTemplatesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst templateItemSchema = z.object({\n  productId: z.string().uuid().optional(),\n  name: z.string().min(1).max(200),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  quantity: z.number().int().min(1),\n  unitPrice: z.number().min(0),\n});\n\nconst createTemplateSchema = z.object({\n  name: z.string().min(1).max(255),\n  description: z.string().max(2000).optional(),\n  items: z.array(templateItemSchema).min(1),\n  defaultDiscount: z.number().min(0).optional(),\n  defaultDiscountType: z.enum(['percentage', 'fixed']).optional(),\n  defaultTaxRate: z.number().min(0).max(1).optional(),\n  defaultValidDays: z.number().int().min(1).max(365).optional(),\n  defaultTerms: z.string().max(5000).optional(),\n});\n\nconst updateTemplateSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  description: z.string().max(2000).optional().nullable(),\n  items: z.array(templateItemSchema).min(1).optional(),\n  defaultDiscount: z.number().min(0).optional().nullable(),\n  defaultDiscountType: z.enum(['percentage', 'fixed']).optional().nullable(),\n  defaultTaxRate: z.number().min(0).max(1).optional().nullable(),\n  defaultValidDays: z.number().int().min(1).max(365).optional(),\n  defaultTerms: z.string().max(5000).optional().nullable(),\n  isActive: z.boolean().optional(),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/quotation-templates\n * List all quotation templates (Admin only)\n */\nquotationTemplatesRoutes.get('/', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const activeOnly = req.query['activeOnly'] !== 'false';\n\n    const baseQuery = db.select().from(quotationTemplates);\n\n    const templates = activeOnly\n      ? await baseQuery.where(eq(quotationTemplates.isActive, 1)).orderBy(desc(quotationTemplates.createdAt))\n      : await baseQuery.orderBy(desc(quotationTemplates.createdAt));\n\n    sendSuccess(res, templates.map(t => ({\n      ...t,\n      defaultDiscount: t.defaultDiscount ? Number(t.defaultDiscount) : null,\n      defaultTaxRate: t.defaultTaxRate ? Number(t.defaultTaxRate) : null,\n      isActive: Boolean(t.isActive),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotation-templates/:id\n * Get template details (Admin only)\n */\nquotationTemplatesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [template] = await db\n      .select()\n      .from(quotationTemplates)\n      .where(eq(quotationTemplates.id, id));\n\n    if (!template) {\n      throw new NotFoundError('Template not found');\n    }\n\n    sendSuccess(res, {\n      ...template,\n      defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n      defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n      isActive: Boolean(template.isActive),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotation-templates\n * Create a new template (Admin only)\n */\nquotationTemplatesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      const [template] = await db\n        .insert(quotationTemplates)\n        .values({\n          name: data['name'],\n          description: data['description'],\n          items: data['items'],\n          defaultDiscount: data['defaultDiscount'] ? String(data['defaultDiscount']) : null,\n          defaultDiscountType: data['defaultDiscountType'],\n          defaultTaxRate: data['defaultTaxRate'] ? String(data['defaultTaxRate']) : null,\n          defaultValidDays: data['defaultValidDays'],\n          defaultTerms: data['defaultTerms'],\n        })\n        .returning();\n\n      if (!template) {\n        throw new NotFoundError('Failed to create template');\n      }\n\n      sendCreated(res, {\n        ...template,\n        defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n        defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n        isActive: Boolean(template.isActive),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/quotation-templates/:id\n * Update a template (Admin only)\n */\nquotationTemplatesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(quotationTemplates)\n        .where(eq(quotationTemplates.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Template not found');\n      }\n\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      if (data['name'] !== undefined) {updateData['name'] = data['name'];}\n      if (data['description'] !== undefined) {updateData['description'] = data['description'];}\n      if (data['items'] !== undefined) {updateData['items'] = data['items'];}\n      if (data['defaultDiscount'] !== undefined) {\n        updateData['defaultDiscount'] = data['defaultDiscount'] !== null ? String(data['defaultDiscount']) : null;\n      }\n      if (data['defaultDiscountType'] !== undefined) {updateData['defaultDiscountType'] = data['defaultDiscountType'];}\n      if (data['defaultTaxRate'] !== undefined) {\n        updateData['defaultTaxRate'] = data['defaultTaxRate'] !== null ? String(data['defaultTaxRate']) : null;\n      }\n      if (data['defaultValidDays'] !== undefined) {updateData['defaultValidDays'] = data['defaultValidDays'];}\n      if (data['defaultTerms'] !== undefined) {updateData['defaultTerms'] = data['defaultTerms'];}\n      if (data['isActive'] !== undefined) {updateData['isActive'] = data['isActive'] ? 1 : 0;}\n\n      const [template] = await db\n        .update(quotationTemplates)\n        .set(updateData)\n        .where(eq(quotationTemplates.id, id))\n        .returning();\n\n      if (!template) {\n        throw new NotFoundError('Template not found');\n      }\n\n      sendSuccess(res, {\n        ...template,\n        defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n        defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n        isActive: Boolean(template.isActive),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/quotation-templates/:id\n * Delete a template (Admin only)\n */\nquotationTemplatesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(quotationTemplates)\n      .where(eq(quotationTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Template not found');\n    }\n\n    await db.delete(quotationTemplates).where(eq(quotationTemplates.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, blogs, eq, sql, desc, and, or, like, gte, lte } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug } from '../utils/helpers';\nimport { sanitizeRichContent } from '../middleware/xss';\n\nexport const blogsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createBlogSchema = z.object({\n  title: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  excerpt: z.string().max(500).optional(),\n  content: z.string().min(1),\n  featuredImageUrl: z.string().url().optional(),\n  tags: z.array(z.string()).optional(),\n  status: z.enum(['draft', 'published']).optional().default('draft'),\n  publishedAt: z.string().datetime().optional(),\n  metaTitle: z.string().max(100).optional(),\n  metaDescription: z.string().max(200).optional(),\n});\n\nconst updateBlogSchema = createBlogSchema.partial();\n\nconst blogFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  status: z.enum(['draft', 'published']).optional(),\n  tag: z.string().optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/blogs\n * List published blog posts (Public)\n */\nblogsRoutes.get('/', validateQuery(blogFiltersSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const { search, tag } = req.query;\n    const isAdmin = req.user?.role === 'admin';\n\n    const conditions = [];\n\n    // Non-admins only see published posts\n    if (!isAdmin) {\n      conditions.push(eq(blogs.status, 'published'));\n      conditions.push(lte(blogs.publishedAt, new Date()));\n    }\n\n    if (search) {\n      conditions.push(\n        or(\n          like(blogs.title, `%${search}%`),\n          like(blogs.excerpt, `%${search}%`)\n        )\n      );\n    }\n\n    if (tag) {\n      conditions.push(sql`${tag} = ANY(${blogs.tags})`);\n    }\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(blogs)\n      .where(whereClause);\n    const count = countResult[0]?.count ?? 0;\n\n    const blogList = await db\n      .select({\n        id: blogs.id,\n        title: blogs.title,\n        slug: blogs.slug,\n        excerpt: blogs.excerpt,\n        featuredImageUrl: blogs.featuredImageUrl,\n        tags: blogs.tags,\n        status: blogs.status,\n        publishedAt: blogs.publishedAt,\n        createdAt: blogs.createdAt,\n      })\n      .from(blogs)\n      .where(whereClause)\n      .orderBy(desc(blogs.publishedAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, blogList, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/tags\n * Get all unique tags (Public)\n */\nblogsRoutes.get('/tags', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Get all unique tags from published posts\n    const result = await db\n      .select({ tags: blogs.tags })\n      .from(blogs)\n      .where(eq(blogs.status, 'published'));\n\n    // Flatten and get unique tags\n    const allTags = result\n      .flatMap(r => r.tags || [])\n      .filter((tag, index, self) => self.indexOf(tag) === index)\n      .sort();\n\n    sendSuccess(res, allTags);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/:slug\n * Get blog post by slug (Public)\n */\nblogsRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { slug } = req.params;\n    const isAdmin = req.user?.role === 'admin';\n\n    const [blog] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.slug, slug));\n\n    if (!blog) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Non-admins can only view published posts\n    if (!isAdmin && blog.status !== 'published') {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Note: viewCount tracking removed - not in current schema\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/:slug/related\n * Get related blog posts (Public)\n */\nblogsRoutes.get('/:slug/related', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { slug } = req.params;\n    const limitParam = parseInt(req.query['limit'] as string) || 3;\n\n    // Get current blog\n    const [currentBlog] = await db\n      .select({ id: blogs.id, tags: blogs.tags })\n      .from(blogs)\n      .where(eq(blogs.slug, slug));\n\n    if (!currentBlog) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Find related posts by tags\n    let relatedPosts: Array<{\n      id: string;\n      title: string;\n      slug: string;\n      excerpt: string | null;\n      featuredImageUrl: string | null;\n      publishedAt: Date | null;\n    }> = [];\n\n    if (currentBlog.tags && currentBlog.tags.length > 0) {\n      // Get posts with matching tags\n      relatedPosts = await db\n        .select({\n          id: blogs.id,\n          title: blogs.title,\n          slug: blogs.slug,\n          excerpt: blogs.excerpt,\n          featuredImageUrl: blogs.featuredImageUrl,\n          publishedAt: blogs.publishedAt,\n        })\n        .from(blogs)\n        .where(\n          and(\n            eq(blogs.status, 'published'),\n            sql`${blogs.id} != ${currentBlog.id}`,\n            sql`${blogs.tags} && ${currentBlog.tags}` // Array overlap\n          )\n        )\n        .orderBy(desc(blogs.publishedAt))\n        .limit(limitParam);\n    }\n\n    // If not enough related posts, get recent posts\n    if (relatedPosts.length < limitParam) {\n      const existing = relatedPosts.map(p => p.id);\n      const needed = limitParam - relatedPosts.length;\n\n      const recentPosts = await db\n        .select({\n          id: blogs.id,\n          title: blogs.title,\n          slug: blogs.slug,\n          excerpt: blogs.excerpt,\n          featuredImageUrl: blogs.featuredImageUrl,\n          publishedAt: blogs.publishedAt,\n        })\n        .from(blogs)\n        .where(\n          and(\n            eq(blogs.status, 'published'),\n            sql`${blogs.id} != ${currentBlog.id}`,\n            existing.length > 0 ? sql`${blogs.id} != ALL(${existing})` : sql`true`\n          )\n        )\n        .orderBy(desc(blogs.publishedAt))\n        .limit(needed);\n\n      relatedPosts = [...relatedPosts, ...recentPosts];\n    }\n\n    sendSuccess(res, relatedPosts);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/blogs/admin/all\n * List all blog posts including drafts (Admin only)\n */\nblogsRoutes.get(\n  '/admin/all',\n  requireAuth,\n  requireAdmin,\n  validateQuery(blogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, status, tag } = req.query;\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(blogs.title, `%${search}%`),\n            like(blogs.excerpt, `%${search}%`)\n          )\n        );\n      }\n\n      if (status) {\n        conditions.push(eq(blogs.status, status as 'draft' | 'published' | 'archived'));\n      }\n\n      if (tag) {\n        conditions.push(sql`${tag} = ANY(${blogs.tags})`);\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(blogs)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const blogList = await db\n        .select()\n        .from(blogs)\n        .where(whereClause)\n        .orderBy(desc(blogs.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, blogList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/blogs/admin/:id\n * Get blog post by ID (Admin only)\n */\nblogsRoutes.get(\n  '/admin/:id',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [blog] = await db\n        .select()\n        .from(blogs)\n        .where(eq(blogs.id, id));\n\n      if (!blog) {\n        throw new NotFoundError('Blog post not found');\n      }\n\n      sendSuccess(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/blogs\n * Create a new blog post (Admin only)\n */\nblogsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createBlogSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.title);\n\n      // Check if slug exists\n      const [existingSlug] = await db\n        .select({ id: blogs.id })\n        .from(blogs)\n        .where(eq(blogs.slug, slug));\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Set publishedAt if publishing\n      let publishedAt = data.publishedAt ? new Date(data.publishedAt) : undefined;\n      if (data.status === 'published' && !publishedAt) {\n        publishedAt = new Date();\n      }\n\n      // Generate excerpt if not provided\n      let excerpt = data.excerpt;\n      if (!excerpt && data.content) {\n        // Strip HTML and truncate\n        const plainText = data.content.replace(/<[^>]*>/g, '');\n        excerpt = plainText.substring(0, 200) + (plainText.length > 200 ? '...' : '');\n      }\n\n      // Sanitize rich content (allow safe HTML for blog content)\n      const sanitizedContent = sanitizeRichContent(data.content);\n\n      // Only set authorId if it's a valid UUID\n      const isValidUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(req.user?.id || '');\n\n      const [blog] = await db\n        .insert(blogs)\n        .values({\n          title: data.title,\n          slug,\n          excerpt,\n          content: sanitizedContent,\n          featuredImageUrl: data.featuredImageUrl,\n          tags: data.tags || [],\n          status: data.status || 'draft',\n          publishedAt,\n          metaTitle: data.metaTitle || data.title,\n          metaDescription: data.metaDescription || excerpt,\n          authorId: isValidUuid ? req.user?.id : undefined,\n          authorName: req.user?.email?.split('@')[0] || 'Admin',\n        })\n        .returning();\n\n      sendCreated(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/blogs/:id\n * Update a blog post (Admin only)\n */\nblogsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateBlogSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(blogs)\n        .where(eq(blogs.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Blog post not found');\n      }\n\n      // Sanitize content if provided (allow safe HTML for blog content)\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      if (data['content']) {\n        updateData['content'] = sanitizeRichContent(data['content']);\n      }\n\n      // Handle slug update\n      if (data.slug && data.slug !== existing.slug) {\n        const [existingSlug] = await db\n          .select({ id: blogs.id })\n          .from(blogs)\n          .where(and(eq(blogs.slug, data.slug), sql`${blogs.id} != ${id}`));\n\n        if (existingSlug) {\n          throw new ConflictError('Slug already exists');\n        }\n      }\n\n      // Handle publishedAt\n      if (data['publishedAt']) {\n        updateData['publishedAt'] = new Date(data['publishedAt']);\n      } else if (data.status === 'published' && !existing.publishedAt) {\n        updateData['publishedAt'] = new Date();\n      }\n\n      const [blog] = await db\n        .update(blogs)\n        .set(updateData)\n        .where(eq(blogs.id, id))\n        .returning();\n\n      sendSuccess(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/blogs/:id\n * Delete a blog post (Admin only)\n */\nblogsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: blogs.id })\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    await db.delete(blogs).where(eq(blogs.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/publish\n * Publish a blog post (Admin only)\n */\nblogsRoutes.post('/:id/publish', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    const [blog] = await db\n      .update(blogs)\n      .set({\n        status: 'published',\n        publishedAt: existing.publishedAt || new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(blogs.id, id))\n      .returning();\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/unpublish\n * Unpublish a blog post (Admin only)\n */\nblogsRoutes.post('/:id/unpublish', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: blogs.id })\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    const [blog] = await db\n      .update(blogs)\n      .set({\n        status: 'draft',\n        updatedAt: new Date(),\n      })\n      .where(eq(blogs.id, id))\n      .returning();\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/duplicate\n * Duplicate a blog post (Admin only)\n */\nblogsRoutes.post('/:id/duplicate', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [original] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!original) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Generate new slug\n    const slug = `${original.slug}-copy-${Date.now()}`;\n\n    const [blog] = await db\n      .insert(blogs)\n      .values({\n        title: `${original.title} (Copy)`,\n        slug,\n        excerpt: original.excerpt,\n        content: original.content,\n        featuredImageUrl: original.featuredImageUrl,\n        tags: original.tags,\n        status: 'draft',\n        metaTitle: original.metaTitle,\n        metaDescription: original.metaDescription,\n        authorId: req.user?.id,\n      })\n      .returning();\n\n    sendCreated(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, settings, adminActivityLogs, eq, desc, and, gte, inArray, sql } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\n\nexport const settingsRoutes = Router();\n\n// ===========================================\n// Types for grouped settings in database\n// ===========================================\n\ninterface BusinessSettings {\n  business_name: string;\n  business_email: string;\n  business_phone: string;\n  business_address: string;\n  currency: string;\n  currency_symbol: string;\n}\n\ninterface TaxSettings {\n  tax_rate: number;\n  tax_label: string;\n  tax_enabled: boolean;\n}\n\ninterface DeliverySettings {\n  delivery_fee: number;\n  delivery_enabled: boolean;\n  free_delivery_threshold: number;\n  delivery_time_min: number;\n  delivery_time_max: number;\n}\n\ninterface NotificationSettings {\n  email_notifications: boolean;\n  sound_notifications: boolean;\n  low_stock_notifications: boolean;\n  new_order_notifications: boolean;\n}\n\ninterface SystemSettings {\n  site_title: string;\n  site_description: string;\n  maintenance_mode: boolean;\n  allow_guest_checkout: boolean;\n  max_cart_items: number;\n}\n\n// Default values for grouped settings\n// These defaults are returned when settings don't exist in the database yet.\n// Admins can update these values via PUT /api/settings endpoint.\nconst DEFAULT_BUSINESS: BusinessSettings = {\n  business_name: 'Lab404 Electronics',\n  business_email: 'info@lab404.com',\n  business_phone: '',\n  business_address: '',\n  currency: 'USD',\n  currency_symbol: '$',\n};\n\n// Tax is DISABLED by default with 0% rate for safety.\n// Admins must explicitly enable tax and set the rate via settings.\n// This prevents unexpected charges to customers.\nconst DEFAULT_TAX: TaxSettings = {\n  tax_rate: 0,\n  tax_label: 'VAT',\n  tax_enabled: false,\n};\n\nconst DEFAULT_DELIVERY: DeliverySettings = {\n  delivery_fee: 0,\n  delivery_enabled: false,\n  free_delivery_threshold: 0,\n  delivery_time_min: 7,\n  delivery_time_max: 14,\n};\n\nconst DEFAULT_NOTIFICATIONS: NotificationSettings = {\n  email_notifications: true,\n  sound_notifications: true,\n  low_stock_notifications: true,\n  new_order_notifications: true,\n};\n\nconst DEFAULT_SYSTEM: SystemSettings = {\n  site_title: 'Lab404 Electronics',\n  site_description: 'Your trusted electronics store',\n  maintenance_mode: false,\n  allow_guest_checkout: true,\n  max_cart_items: 99,\n};\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst activityLogFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  adminId: z.string().uuid().optional(),\n  action: z.string().optional(),\n  entityType: z.string().optional(),\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n});\n\n// Schema for updating all admin settings at once\nconst updateAdminSettingsSchema = z.object({\n  // Business/Store Info\n  business_name: z.string().min(1).optional(),\n  business_email: z.string().email().optional(),\n  business_phone: z.string().optional(),\n  business_address: z.string().optional(),\n  currency: z.string().optional(),\n  currency_symbol: z.string().optional(),\n  // Tax\n  tax_rate: z.number().min(0).max(100).optional(),\n  tax_label: z.string().optional(),\n  tax_enabled: z.boolean().optional(),\n  // Delivery/Shipping\n  delivery_fee: z.number().min(0).optional(),\n  delivery_enabled: z.boolean().optional(),\n  free_delivery_threshold: z.number().min(0).optional(),\n  // System\n  site_title: z.string().optional(),\n  site_description: z.string().optional(),\n  low_stock_threshold: z.number().min(0).optional(),\n  // Notifications\n  email_notifications: z.boolean().optional(),\n  low_stock_notifications: z.boolean().optional(),\n  new_order_notifications: z.boolean().optional(),\n});\n\n// ===========================================\n// Helper Functions\n// ===========================================\n\nasync function getGroupedSetting<T>(db: ReturnType<typeof getDb>, key: string, defaultValue: T): Promise<T> {\n  const [result] = await db\n    .select()\n    .from(settings)\n    .where(eq(settings.key, key));\n\n  if (result && result.value) {\n    return { ...defaultValue, ...(result.value as T) };\n  }\n  return defaultValue;\n}\n\nasync function updateGroupedSetting<T extends object>(\n  db: ReturnType<typeof getDb>,\n  key: string,\n  updates: Partial<T>,\n  description: string\n): Promise<T> {\n  // Get current value\n  const [existing] = await db\n    .select()\n    .from(settings)\n    .where(eq(settings.key, key));\n\n  let currentValue: T;\n  if (existing && existing.value) {\n    currentValue = existing.value as T;\n  } else {\n    // Get default based on key\n    switch (key) {\n      case 'business': currentValue = DEFAULT_BUSINESS as T; break;\n      case 'tax': currentValue = DEFAULT_TAX as T; break;\n      case 'delivery': currentValue = DEFAULT_DELIVERY as T; break;\n      case 'notifications': currentValue = DEFAULT_NOTIFICATIONS as T; break;\n      case 'system': currentValue = DEFAULT_SYSTEM as T; break;\n      default: currentValue = {} as T;\n    }\n  }\n\n  // Merge updates\n  const newValue = { ...currentValue, ...updates };\n\n  if (existing) {\n    await db\n      .update(settings)\n      .set({ value: newValue, updatedAt: new Date() })\n      .where(eq(settings.key, key));\n  } else {\n    await db.insert(settings).values({\n      key,\n      value: newValue,\n      description,\n    });\n  }\n\n  return newValue;\n}\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/settings/public\n * Get public settings (non-sensitive) - reads from grouped settings\n */\nsettingsRoutes.get('/public', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Fetch grouped settings\n    const [businessRow, taxRow, deliveryRow, systemRow] = await Promise.all([\n      db.select().from(settings).where(eq(settings.key, 'business')),\n      db.select().from(settings).where(eq(settings.key, 'tax')),\n      db.select().from(settings).where(eq(settings.key, 'delivery')),\n      db.select().from(settings).where(eq(settings.key, 'system')),\n    ]);\n\n    const business = businessRow[0]?.value as BusinessSettings || DEFAULT_BUSINESS;\n    const tax = taxRow[0]?.value as TaxSettings || DEFAULT_TAX;\n    const delivery = deliveryRow[0]?.value as DeliverySettings || DEFAULT_DELIVERY;\n    const system = systemRow[0]?.value as SystemSettings || DEFAULT_SYSTEM;\n\n    // Return flattened public settings\n    sendSuccess(res, {\n      // Business\n      company_name: business.business_name,\n      company_email: business.business_email,\n      company_phone: business.business_phone,\n      company_address: business.business_address,\n      currency: business.currency,\n      currency_symbol: business.currency_symbol,\n      // Tax\n      tax_rate: tax.tax_rate,\n      tax_label: tax.tax_label,\n      tax_enabled: tax.tax_enabled,\n      // Delivery\n      delivery_fee: delivery.delivery_fee,\n      delivery_enabled: delivery.delivery_enabled,\n      free_delivery_threshold: delivery.free_delivery_threshold,\n      // System\n      site_title: system.site_title,\n      site_description: system.site_description,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/settings\n * Get all settings for admin panel - returns flat structure for easy form binding\n */\nsettingsRoutes.get('/', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Fetch all grouped settings\n    const [businessRow, taxRow, deliveryRow, notificationsRow, systemRow] = await Promise.all([\n      db.select().from(settings).where(eq(settings.key, 'business')),\n      db.select().from(settings).where(eq(settings.key, 'tax')),\n      db.select().from(settings).where(eq(settings.key, 'delivery')),\n      db.select().from(settings).where(eq(settings.key, 'notifications')),\n      db.select().from(settings).where(eq(settings.key, 'system')),\n    ]);\n\n    const business = { ...DEFAULT_BUSINESS, ...(businessRow[0]?.value as BusinessSettings || {}) };\n    const tax = { ...DEFAULT_TAX, ...(taxRow[0]?.value as TaxSettings || {}) };\n    const delivery = { ...DEFAULT_DELIVERY, ...(deliveryRow[0]?.value as DeliverySettings || {}) };\n    const notifications = { ...DEFAULT_NOTIFICATIONS, ...(notificationsRow[0]?.value as NotificationSettings || {}) };\n    const system = { ...DEFAULT_SYSTEM, ...(systemRow[0]?.value as SystemSettings || {}) };\n\n    // Return flat structure for admin form\n    sendSuccess(res, {\n      // Store/Business Information\n      business_name: business.business_name,\n      business_email: business.business_email,\n      business_phone: business.business_phone,\n      business_address: business.business_address,\n\n      // Currency\n      currency: business.currency,\n      currency_symbol: business.currency_symbol,\n\n      // Tax\n      tax_rate: tax.tax_rate,\n      tax_label: tax.tax_label,\n      tax_enabled: tax.tax_enabled,\n\n      // Delivery/Shipping\n      delivery_fee: delivery.delivery_fee,\n      delivery_enabled: delivery.delivery_enabled,\n      free_delivery_threshold: delivery.free_delivery_threshold,\n      delivery_time_min: delivery.delivery_time_min,\n      delivery_time_max: delivery.delivery_time_max,\n\n      // Notifications\n      email_notifications: notifications.email_notifications,\n      sound_notifications: notifications.sound_notifications,\n      low_stock_notifications: notifications.low_stock_notifications,\n      new_order_notifications: notifications.new_order_notifications,\n\n      // System\n      site_title: system.site_title,\n      site_description: system.site_description,\n      maintenance_mode: system.maintenance_mode,\n      allow_guest_checkout: system.allow_guest_checkout,\n      max_cart_items: system.max_cart_items,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/settings\n * Update settings - accepts flat structure and updates grouped settings\n */\nsettingsRoutes.put(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateAdminSettingsSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const updates = req.body;\n      const updatedGroups: string[] = [];\n\n      // Group updates by category\n      const businessUpdates: Partial<BusinessSettings> = {};\n      const taxUpdates: Partial<TaxSettings> = {};\n      const deliveryUpdates: Partial<DeliverySettings> = {};\n      const notificationUpdates: Partial<NotificationSettings> = {};\n      const systemUpdates: Partial<SystemSettings> = {};\n\n      // Map flat fields to groups\n      if (updates.business_name !== undefined) {businessUpdates.business_name = updates.business_name;}\n      if (updates.business_email !== undefined) {businessUpdates.business_email = updates.business_email;}\n      if (updates.business_phone !== undefined) {businessUpdates.business_phone = updates.business_phone;}\n      if (updates.business_address !== undefined) {businessUpdates.business_address = updates.business_address;}\n      if (updates.currency !== undefined) {businessUpdates.currency = updates.currency;}\n      if (updates.currency_symbol !== undefined) {businessUpdates.currency_symbol = updates.currency_symbol;}\n\n      if (updates.tax_rate !== undefined) {taxUpdates.tax_rate = updates.tax_rate;}\n      if (updates.tax_label !== undefined) {taxUpdates.tax_label = updates.tax_label;}\n      if (updates.tax_enabled !== undefined) {taxUpdates.tax_enabled = updates.tax_enabled;}\n\n      if (updates.delivery_fee !== undefined) {deliveryUpdates.delivery_fee = updates.delivery_fee;}\n      if (updates.delivery_enabled !== undefined) {deliveryUpdates.delivery_enabled = updates.delivery_enabled;}\n      if (updates.free_delivery_threshold !== undefined) {deliveryUpdates.free_delivery_threshold = updates.free_delivery_threshold;}\n\n      if (updates.email_notifications !== undefined) {notificationUpdates.email_notifications = updates.email_notifications;}\n      if (updates.low_stock_notifications !== undefined) {notificationUpdates.low_stock_notifications = updates.low_stock_notifications;}\n      if (updates.new_order_notifications !== undefined) {notificationUpdates.new_order_notifications = updates.new_order_notifications;}\n\n      if (updates.site_title !== undefined) {systemUpdates.site_title = updates.site_title;}\n      if (updates.site_description !== undefined) {systemUpdates.site_description = updates.site_description;}\n\n      // Update each group if there are changes\n      if (Object.keys(businessUpdates).length > 0) {\n        await updateGroupedSetting(db, 'business', businessUpdates, 'Business settings');\n        updatedGroups.push('business');\n      }\n\n      if (Object.keys(taxUpdates).length > 0) {\n        await updateGroupedSetting(db, 'tax', taxUpdates, 'Tax settings');\n        updatedGroups.push('tax');\n      }\n\n      if (Object.keys(deliveryUpdates).length > 0) {\n        await updateGroupedSetting(db, 'delivery', deliveryUpdates, 'Delivery settings');\n        updatedGroups.push('delivery');\n      }\n\n      if (Object.keys(notificationUpdates).length > 0) {\n        await updateGroupedSetting(db, 'notifications', notificationUpdates, 'Notification settings');\n        updatedGroups.push('notifications');\n      }\n\n      if (Object.keys(systemUpdates).length > 0) {\n        await updateGroupedSetting(db, 'system', systemUpdates, 'System settings');\n        updatedGroups.push('system');\n      }\n\n      // Log activity\n      if (updatedGroups.length > 0) {\n        await db.insert(adminActivityLogs).values({\n          adminUserId: req.user!.id,\n          action: 'update',\n          entityType: 'settings',\n          details: { updatedGroups, updatedFields: Object.keys(updates) },\n        });\n      }\n\n      sendSuccess(res, {\n        message: 'Settings updated successfully',\n        updatedGroups,\n        updatedFields: Object.keys(updates),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/settings/:key\n * Get a specific grouped setting (Admin only)\n */\nsettingsRoutes.get('/:key', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const key = req.params['key'] as string;\n\n    const [setting] = await db\n      .select()\n      .from(settings)\n      .where(eq(settings.key, key));\n\n    if (!setting) {\n      // Return default if it's a known group\n      const defaults: Record<string, unknown> = {\n        business: DEFAULT_BUSINESS,\n        tax: DEFAULT_TAX,\n        delivery: DEFAULT_DELIVERY,\n        notifications: DEFAULT_NOTIFICATIONS,\n        system: DEFAULT_SYSTEM,\n      };\n\n      if (defaults[key]) {\n        return sendSuccess(res, {\n          key,\n          value: defaults[key],\n          isDefault: true,\n        });\n      }\n      throw new NotFoundError('Setting not found');\n    }\n\n    sendSuccess(res, setting);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/settings/reset\n * Reset settings to defaults (Admin only)\n */\nsettingsRoutes.post('/reset', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { groups } = req.body as { groups?: string[] };\n\n    const validGroups = ['business', 'tax', 'delivery', 'notifications', 'system'];\n\n    if (groups && groups.length > 0) {\n      // Reset specific groups\n      for (const group of groups) {\n        if (validGroups.includes(group)) {\n          await db.delete(settings).where(eq(settings.key, group));\n        }\n      }\n    } else {\n      // Reset all grouped settings\n      for (const group of validGroups) {\n        await db.delete(settings).where(eq(settings.key, group));\n      }\n    }\n\n    // Log activity\n    await db.insert(adminActivityLogs).values({\n      adminUserId: req.user!.id,\n      action: 'reset',\n      entityType: 'settings',\n      details: { resetGroups: groups || 'all' },\n    });\n\n    sendSuccess(res, { message: 'Settings reset to defaults' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Activity Log Routes\n// ===========================================\n\n/**\n * GET /api/settings/activity-logs\n * Get admin activity logs (Admin only)\n */\nsettingsRoutes.get(\n  '/activity-logs',\n  requireAuth,\n  requireAdmin,\n  validateQuery(activityLogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { adminId, action, entityType, startDate, endDate } = req.query;\n\n      const conditions = [];\n\n      if (adminId) {\n        conditions.push(eq(adminActivityLogs.adminUserId, adminId as string));\n      }\n\n      if (action) {\n        conditions.push(eq(adminActivityLogs.action, action as string));\n      }\n\n      if (entityType) {\n        conditions.push(eq(adminActivityLogs.entityType, entityType as string));\n      }\n\n      if (startDate) {\n        conditions.push(gte(adminActivityLogs.createdAt, new Date(startDate as string)));\n      }\n\n      if (endDate) {\n        const end = new Date(endDate as string);\n        end.setHours(23, 59, 59, 999);\n        conditions.push(sql`${adminActivityLogs.createdAt} <= ${end}`);\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(adminActivityLogs)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const logs = await db\n        .select({\n          id: adminActivityLogs.id,\n          adminUserId: adminActivityLogs.adminUserId,\n          action: adminActivityLogs.action,\n          entityType: adminActivityLogs.entityType,\n          entityId: adminActivityLogs.entityId,\n          details: adminActivityLogs.details,\n          ipAddress: adminActivityLogs.ipAddress,\n          createdAt: adminActivityLogs.createdAt,\n        })\n        .from(adminActivityLogs)\n        .where(whereClause)\n        .orderBy(desc(adminActivityLogs.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, logs, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, orders, orderItems, customers, products, productVariants, sql, desc, eq, and, gte, lte } from '@lab404/database';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\n\nexport const analyticsRoutes = Router();\n\n// Apply admin auth to all routes\nanalyticsRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst dateRangeSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  period: z.enum(['today', 'yesterday', 'week', 'month', 'quarter', 'year', 'all']).optional(),\n});\n\n// Helper to get date range\nfunction getDateRange(query: { startDate?: string; endDate?: string; period?: string }) {\n  const now = new Date();\n  let startDate: Date | undefined;\n  let endDate: Date | undefined = new Date(now);\n  endDate.setHours(23, 59, 59, 999);\n\n  if (query.period) {\n    switch (query.period) {\n      case 'today':\n        startDate = new Date(now);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'yesterday':\n        startDate = new Date(now);\n        startDate.setDate(startDate.getDate() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        endDate = new Date(startDate);\n        endDate.setHours(23, 59, 59, 999);\n        break;\n      case 'week':\n        startDate = new Date(now);\n        startDate.setDate(startDate.getDate() - 7);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'month':\n        startDate = new Date(now);\n        startDate.setMonth(startDate.getMonth() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'quarter':\n        startDate = new Date(now);\n        startDate.setMonth(startDate.getMonth() - 3);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'year':\n        startDate = new Date(now);\n        startDate.setFullYear(startDate.getFullYear() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'all':\n        startDate = undefined;\n        endDate = undefined;\n        break;\n    }\n  } else {\n    if (query.startDate) {\n      startDate = new Date(query.startDate);\n      startDate.setHours(0, 0, 0, 0);\n    }\n    if (query.endDate) {\n      endDate = new Date(query.endDate);\n      endDate.setHours(23, 59, 59, 999);\n    }\n  }\n\n  return { startDate, endDate };\n}\n\n// ===========================================\n// Dashboard Overview\n// ===========================================\n\n/**\n * GET /api/analytics/dashboard\n * Get dashboard overview stats\n */\nanalyticsRoutes.get('/dashboard', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    // Build date conditions\n    const orderConditions = [];\n    if (startDate) {orderConditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {orderConditions.push(lte(orders.createdAt, endDate));}\n    const orderWhere = orderConditions.length > 0 ? and(...orderConditions) : undefined;\n\n    // Total revenue\n    const [revenueResult] = await db\n      .select({\n        totalRevenue: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          orderWhere,\n          eq(orders.paymentStatus, 'paid')\n        )\n      );\n\n    // Pending orders\n    const [pendingResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(orders)\n      .where(\n        and(\n          orderWhere,\n          eq(orders.status, 'pending')\n        )\n      );\n\n    // Total customers\n    const customerConditions = [];\n    if (startDate) {customerConditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {customerConditions.push(lte(customers.createdAt, endDate));}\n    const customerWhere = customerConditions.length > 0 ? and(...customerConditions) : undefined;\n\n    const [customerResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(customerWhere);\n\n    // Average order value\n    const averageOrderValue = revenueResult?.orderCount && revenueResult.orderCount > 0\n      ? Number(revenueResult.totalRevenue) / Number(revenueResult.orderCount)\n      : 0;\n\n    // Compare with previous period\n    let previousPeriodData = null;\n    if (startDate && endDate) {\n      const periodLength = endDate.getTime() - startDate.getTime();\n      const prevStart = new Date(startDate.getTime() - periodLength);\n      const prevEnd = new Date(startDate.getTime() - 1);\n\n      const [prevRevenue] = await db\n        .select({\n          totalRevenue: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n          orderCount: sql<number>`COUNT(*)`,\n        })\n        .from(orders)\n        .where(\n          and(\n            gte(orders.createdAt, prevStart),\n            lte(orders.createdAt, prevEnd),\n            eq(orders.paymentStatus, 'paid')\n          )\n        );\n\n      const [prevCustomers] = await db\n        .select({ count: sql<number>`COUNT(*)` })\n        .from(customers)\n        .where(\n          and(\n            gte(customers.createdAt, prevStart),\n            lte(customers.createdAt, prevEnd)\n          )\n        );\n\n      const currentRevenue = Number(revenueResult?.totalRevenue ?? 0);\n      const prevRevenueNum = Number(prevRevenue?.totalRevenue ?? 0);\n\n      previousPeriodData = {\n        revenueChange: prevRevenueNum > 0\n          ? ((currentRevenue - prevRevenueNum) / prevRevenueNum) * 100\n          : currentRevenue > 0 ? 100 : 0,\n        orderCountChange: Number(prevRevenue?.orderCount ?? 0) > 0\n          ? ((Number(revenueResult?.orderCount ?? 0) - Number(prevRevenue?.orderCount ?? 0)) / Number(prevRevenue?.orderCount ?? 1)) * 100\n          : Number(revenueResult?.orderCount ?? 0) > 0 ? 100 : 0,\n        customerCountChange: Number(prevCustomers?.count ?? 0) > 0\n          ? ((Number(customerResult?.count ?? 0) - Number(prevCustomers?.count ?? 0)) / Number(prevCustomers?.count ?? 1)) * 100\n          : Number(customerResult?.count ?? 0) > 0 ? 100 : 0,\n      };\n    }\n\n    sendSuccess(res, {\n      totalRevenue: Number(revenueResult?.totalRevenue ?? 0),\n      orderCount: Number(revenueResult?.orderCount ?? 0),\n      pendingOrders: Number(pendingResult?.count ?? 0),\n      customerCount: Number(customerResult?.count ?? 0),\n      averageOrderValue: Math.round(averageOrderValue * 100) / 100,\n      previousPeriodComparison: previousPeriodData,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Sales Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/sales\n * Get sales data over time\n */\nanalyticsRoutes.get('/sales', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const groupBy = (req.query['groupBy'] as string) || 'day';\n\n    let dateFormat: string;\n    switch (groupBy) {\n      case 'hour':\n        dateFormat = 'YYYY-MM-DD HH24:00';\n        break;\n      case 'day':\n        dateFormat = 'YYYY-MM-DD';\n        break;\n      case 'week':\n        dateFormat = 'IYYY-IW';\n        break;\n      case 'month':\n        dateFormat = 'YYYY-MM';\n        break;\n      default:\n        dateFormat = 'YYYY-MM-DD';\n    }\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Create the period expression as a reusable SQL fragment\n    const periodExpr = sql`TO_CHAR(${orders.createdAt}, ${sql.raw(`'${dateFormat}'`)})`;\n\n    const salesData = await db\n      .select({\n        period: sql<string>`${periodExpr}`,\n        revenue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n        averageOrderValue: sql<number>`AVG(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n      })\n      .from(orders)\n      .where(and(...conditions))\n      .groupBy(periodExpr)\n      .orderBy(periodExpr);\n\n    sendSuccess(res, salesData.map(row => ({\n      period: row.period,\n      revenue: Number(row.revenue),\n      orderCount: Number(row.orderCount),\n      averageOrderValue: Math.round(Number(row.averageOrderValue) * 100) / 100,\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/sales/by-status\n * Get sales breakdown by order status\n */\nanalyticsRoutes.get('/sales/by-status', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const statusData = await db\n      .select({\n        status: orders.status,\n        count: sql<number>`COUNT(*)`,\n        totalValue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n      })\n      .from(orders)\n      .where(whereClause)\n      .groupBy(orders.status);\n\n    sendSuccess(res, statusData.map(row => ({\n      status: row.status,\n      count: Number(row.count),\n      totalValue: Number(row.totalValue) || 0,\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Product Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/products/top-selling\n * Get top selling products\n */\nanalyticsRoutes.get('/products/top-selling', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const limit = parseInt(req.query['limit'] as string) || 10;\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Only count delivered/completed orders\n    conditions.push(eq(orders.paymentStatus, 'paid'));\n\n    const topProducts = await db\n      .select({\n        productId: orderItems.productId,\n        productName: orderItems.productNameSnapshot,\n        totalQuantity: sql<number>`SUM(${orderItems.quantity})`,\n        totalRevenue: sql<number>`SUM(CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity})`,\n        orderCount: sql<number>`COUNT(DISTINCT ${orderItems.orderId})`,\n      })\n      .from(orderItems)\n      .innerJoin(orders, eq(orderItems.orderId, orders.id))\n      .where(and(...conditions))\n      .groupBy(orderItems.productId, orderItems.productNameSnapshot)\n      .orderBy(desc(sql`SUM(${orderItems.quantity})`))\n      .limit(limit);\n\n    sendSuccess(res, topProducts.map(row => ({\n      productId: row.productId,\n      productName: row.productName,\n      totalQuantity: Number(row.totalQuantity),\n      totalRevenue: Number(row.totalRevenue),\n      orderCount: Number(row.orderCount),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/products/low-stock\n * Get products with low stock\n */\nanalyticsRoutes.get('/products/low-stock', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const threshold = parseInt(req.query['threshold'] as string) || 10;\n\n    // Products with low stock\n    const lowStockProducts = await db\n      .select({\n        id: products.id,\n        name: products.name,\n        sku: products.sku,\n        stockQuantity: products.stockQuantity,\n        status: products.status,\n      })\n      .from(products)\n      .where(\n        and(\n          eq(products.status, 'active'),\n          lte(products.stockQuantity, threshold)\n        )\n      )\n      .orderBy(products.stockQuantity)\n      .limit(50);\n\n    // Variants with low stock\n    const lowStockVariants = await db\n      .select({\n        id: productVariants.id,\n        productId: productVariants.productId,\n        productName: products.name,\n        sku: productVariants.sku,\n        options: productVariants.options,\n        stockQuantity: productVariants.stockQuantity,\n      })\n      .from(productVariants)\n      .innerJoin(products, eq(productVariants.productId, products.id))\n      .where(\n        and(\n          eq(productVariants.isActive, true),\n          lte(productVariants.stockQuantity, threshold)\n        )\n      )\n      .orderBy(productVariants.stockQuantity)\n      .limit(50);\n\n    sendSuccess(res, {\n      products: lowStockProducts,\n      variants: lowStockVariants,\n      threshold,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/customers/overview\n * Get customer analytics overview\n */\nanalyticsRoutes.get('/customers/overview', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(customers.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    // Total customers\n    const [totalResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(whereClause);\n\n    // Guest vs registered\n    const [guestResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(\n        and(\n          whereClause,\n          eq(customers.isGuest, true)\n        )\n      );\n\n    // Customers with orders\n    const [withOrdersResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(\n        and(\n          whereClause,\n          sql`${customers.orderCount} > 0`\n        )\n      );\n\n    // Top customers by order count\n    const topCustomers = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        orderCount: customers.orderCount,\n      })\n      .from(customers)\n      .where(sql`${customers.orderCount} > 0`)\n      .orderBy(desc(customers.orderCount))\n      .limit(10);\n\n    sendSuccess(res, {\n      totalCustomers: Number(totalResult?.count ?? 0),\n      guestCustomers: Number(guestResult?.count ?? 0),\n      registeredCustomers: Number(totalResult?.count ?? 0) - Number(guestResult?.count ?? 0),\n      customersWithOrders: Number(withOrdersResult?.count ?? 0),\n      topCustomers,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/customers/new\n * Get new customer registrations over time\n */\nanalyticsRoutes.get('/customers/new', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const groupBy = (req.query['groupBy'] as string) || 'day';\n\n    let dateFormat: string;\n    switch (groupBy) {\n      case 'day':\n        dateFormat = 'YYYY-MM-DD';\n        break;\n      case 'week':\n        dateFormat = 'IYYY-IW';\n        break;\n      case 'month':\n        dateFormat = 'YYYY-MM';\n        break;\n      default:\n        dateFormat = 'YYYY-MM-DD';\n    }\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(customers.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const customerData = await db\n      .select({\n        period: sql<string>`TO_CHAR(${customers.createdAt}, ${dateFormat})`,\n        total: sql<number>`COUNT(*)`,\n        guests: sql<number>`COUNT(*) FILTER (WHERE ${customers.isGuest} = true)`,\n        registered: sql<number>`COUNT(*) FILTER (WHERE ${customers.isGuest} = false)`,\n      })\n      .from(customers)\n      .where(whereClause)\n      .groupBy(sql`TO_CHAR(${customers.createdAt}, ${dateFormat})`)\n      .orderBy(sql`TO_CHAR(${customers.createdAt}, ${dateFormat})`);\n\n    sendSuccess(res, customerData.map(row => ({\n      period: row.period,\n      total: Number(row.total),\n      guests: Number(row.guests),\n      registered: Number(row.registered),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Revenue Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/revenue/breakdown\n * Get revenue breakdown\n */\nanalyticsRoutes.get('/revenue/breakdown', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    const [breakdown] = await db\n      .select({\n        subtotal: sql<number>`SUM(CAST(${orders.subtotalSnapshot} AS DECIMAL))`,\n        taxAmount: sql<number>`SUM(CAST(${orders.taxAmountSnapshot} AS DECIMAL))`,\n        shippingAmount: sql<number>`SUM(CAST(${orders.shippingAmountSnapshot} AS DECIMAL))`,\n        discountAmount: sql<number>`SUM(CAST(${orders.discountAmountSnapshot} AS DECIMAL))`,\n        total: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(and(...conditions));\n\n    sendSuccess(res, {\n      subtotal: Number(breakdown?.subtotal) || 0,\n      taxAmount: Number(breakdown?.taxAmount) || 0,\n      shippingAmount: Number(breakdown?.shippingAmount) || 0,\n      discountAmount: Number(breakdown?.discountAmount) || 0,\n      total: Number(breakdown?.total) || 0,\n      orderCount: Number(breakdown?.orderCount) || 0,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/revenue/by-payment-method\n * Get revenue by payment method\n */\nanalyticsRoutes.get('/revenue/by-payment-method', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    const byPaymentMethod = await db\n      .select({\n        paymentMethod: orders.paymentMethod,\n        revenue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(and(...conditions))\n      .groupBy(orders.paymentMethod);\n\n    sendSuccess(res, byPaymentMethod.map(row => ({\n      paymentMethod: row.paymentMethod || 'unknown',\n      revenue: Number(row.revenue),\n      orderCount: Number(row.orderCount),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Recent Orders\n// ===========================================\n\n/**\n * GET /api/analytics/orders/recent\n * Get most recent orders for dashboard display\n */\nanalyticsRoutes.get('/orders/recent', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const limit = parseInt(req.query['limit'] as string) || 10;\n\n    const recentOrders = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        customerId: orders.customerId,\n        customerEmail: customers.email,\n        customerFirstName: customers.firstName,\n        customerLastName: customers.lastName,\n        total: orders.totalSnapshot,\n        status: orders.status,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .leftJoin(customers, eq(orders.customerId, customers.id))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit);\n\n    sendSuccess(res, recentOrders.map(order => ({\n      id: order.id,\n      orderNumber: order.orderNumber,\n      customer: order.customerFirstName && order.customerLastName\n        ? `${order.customerFirstName} ${order.customerLastName}`\n        : order.customerEmail || 'Guest',\n      total: Number(order.total),\n      status: order.status,\n      createdAt: order.createdAt?.toISOString() || new Date().toISOString(),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Export Analytics Data\n// ===========================================\n\n/**\n * GET /api/analytics/export\n * Export analytics data as JSON\n */\nanalyticsRoutes.get('/export', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    // Gather all analytics data\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Get all orders in range\n    const orderData = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        total: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    // Get customer data\n    const customerConditions = [];\n    if (startDate) {customerConditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {customerConditions.push(lte(customers.createdAt, endDate));}\n\n    const customerData = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        isGuest: customers.isGuest,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n      })\n      .from(customers)\n      .where(customerConditions.length > 0 ? and(...customerConditions) : undefined);\n\n    const exportData = {\n      exportedAt: new Date().toISOString(),\n      dateRange: { startDate, endDate },\n      summary: {\n        totalOrders: orderData.length,\n        totalCustomers: customerData.length,\n        totalRevenue: orderData\n          .filter(o => o.paymentStatus === 'paid')\n          .reduce((sum, o) => sum + Number(o.total), 0),\n      },\n      orders: orderData.map(o => ({\n        ...o,\n        total: Number(o.total),\n      })),\n      customers: customerData,\n    };\n\n    res.setHeader('Content-Type', 'application/json');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"analytics-export-${new Date().toISOString().split('T')[0]}.json\"`\n    );\n\n    res.json(exportData);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, orders, customers, promoCodes, quotations, orderItems, quotationItems, eq, desc, and, gte, lte, sql } from '@lab404/database';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { exportService } from '../services/export.service';\n\nexport const exportRoutes = Router();\n\n// Apply admin auth to all routes\nexportRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst exportQuerySchema = z.object({\n  format: z.enum(['csv', 'json', 'jsonl']).optional().default('csv'),\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  status: z.string().optional(),\n});\n\n// Helper to set export headers\nfunction setExportHeaders(res: any, filename: string, contentType: string) {\n  res.setHeader('Content-Type', contentType);\n  res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n}\n\n// ===========================================\n// Product Export\n// ===========================================\n\n/**\n * GET /api/export/products\n * Export all products - ALL fields\n */\nexportRoutes.get('/products', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, status } = req.query;\n\n    const conditions = [];\n    if (status) {\n      conditions.push(eq(products.status, status as 'draft' | 'active' | 'archived'));\n    }\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        barcode: products.barcode,\n        name: products.name,\n        slug: products.slug,\n        description: products.description,\n        shortDescription: products.shortDescription,\n        categoryId: products.categoryId,\n        categoryName: categories.name,\n        brand: products.brand,\n        basePrice: products.basePrice,\n        costPrice: products.costPrice,\n        compareAtPrice: products.compareAtPrice,\n        weight: products.weight,\n        dimensions: products.dimensions,\n        stockQuantity: products.stockQuantity,\n        lowStockThreshold: products.lowStockThreshold,\n        trackInventory: products.trackInventory,\n        allowBackorder: products.allowBackorder,\n        images: products.images,\n        videos: products.videos,\n        thumbnailUrl: products.thumbnailUrl,\n        tags: products.tags,\n        specifications: products.specifications,\n        features: products.features,\n        metaTitle: products.metaTitle,\n        metaDescription: products.metaDescription,\n        status: products.status,\n        isFeatured: products.isFeatured,\n        isDigital: products.isDigital,\n        requiresShipping: products.requiresShipping,\n        supplierId: products.supplierId,\n        supplierSku: products.supplierSku,\n        importedFrom: products.importedFrom,\n        externalUrl: products.externalUrl,\n        createdAt: products.createdAt,\n        updatedAt: products.updatedAt,\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.categoryId, categories.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(products.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('products', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(productList as any[], exportService.getProductColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(productList));\n    } else {\n      res.send(exportService.toJSON(productList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Order Export\n// ===========================================\n\n/**\n * GET /api/export/orders\n * Export orders - ALL fields\n */\nexportRoutes.get('/orders', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate, status } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(orders.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(orders.createdAt, end));\n    }\n    if (status) {\n      conditions.push(eq(orders.status, status as 'pending' | 'confirmed' | 'processing' | 'shipped' | 'delivered' | 'cancelled'));\n    }\n\n    const orderList = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        customerId: orders.customerId,\n        customerEmail: customers.email,\n        customerName: sql<string>`CONCAT(${customers.firstName}, ' ', ${customers.lastName})`,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        paymentMethod: orders.paymentMethod,\n        shippingAddress: orders.shippingAddress,\n        billingAddress: orders.billingAddress,\n        currency: orders.currency,\n        subtotalSnapshot: orders.subtotalSnapshot,\n        taxRateSnapshot: orders.taxRateSnapshot,\n        taxAmountSnapshot: orders.taxAmountSnapshot,\n        shippingAmountSnapshot: orders.shippingAmountSnapshot,\n        discountAmountSnapshot: orders.discountAmountSnapshot,\n        totalSnapshot: orders.totalSnapshot,\n        promoCodeId: orders.promoCodeId,\n        promoCodeSnapshot: orders.promoCodeSnapshot,\n        shippingMethod: orders.shippingMethod,\n        trackingNumber: orders.trackingNumber,\n        confirmedAt: orders.confirmedAt,\n        processingAt: orders.processingAt,\n        shippedAt: orders.shippedAt,\n        deliveredAt: orders.deliveredAt,\n        customerNotes: orders.customerNotes,\n        adminNotes: orders.adminNotes,\n        createdAt: orders.createdAt,\n        updatedAt: orders.updatedAt,\n      })\n      .from(orders)\n      .leftJoin(customers, eq(orders.customerId, customers.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('orders', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(orderList as any[], exportService.getOrderColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(orderList));\n    } else {\n      res.send(exportService.toJSON(orderList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/orders/:id/items\n * Export order items for a specific order\n */\nexportRoutes.get('/orders/:id/items', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const format = (req.query['format'] as string) || 'csv';\n\n    // Get order number for context\n    const [order] = await db.select({ orderNumber: orders.orderNumber }).from(orders).where(eq(orders.id, id));\n\n    const items = await db\n      .select({\n        id: orderItems.id,\n        orderId: orderItems.orderId,\n        orderNumber: sql<string>`${order?.orderNumber || ''}`,\n        productId: orderItems.productId,\n        variantId: orderItems.variantId,\n        productNameSnapshot: orderItems.productNameSnapshot,\n        skuSnapshot: orderItems.skuSnapshot,\n        variantOptionsSnapshot: orderItems.variantOptionsSnapshot,\n        quantity: orderItems.quantity,\n        unitPriceSnapshot: orderItems.unitPriceSnapshot,\n        lineTotal: sql<string>`CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity}`,\n        createdAt: orderItems.createdAt,\n      })\n      .from(orderItems)\n      .where(eq(orderItems.orderId, id));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename(`order-${order?.orderNumber || id}-items`, extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getOrderItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/order-items\n * Export ALL order items (bulk export)\n */\nexportRoutes.get('/order-items', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(orders.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(orders.createdAt, end));\n    }\n\n    const items = await db\n      .select({\n        id: orderItems.id,\n        orderId: orderItems.orderId,\n        orderNumber: orders.orderNumber,\n        productId: orderItems.productId,\n        variantId: orderItems.variantId,\n        productNameSnapshot: orderItems.productNameSnapshot,\n        skuSnapshot: orderItems.skuSnapshot,\n        variantOptionsSnapshot: orderItems.variantOptionsSnapshot,\n        quantity: orderItems.quantity,\n        unitPriceSnapshot: orderItems.unitPriceSnapshot,\n        lineTotal: sql<string>`CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity}`,\n        createdAt: orderItems.createdAt,\n      })\n      .from(orderItems)\n      .innerJoin(orders, eq(orderItems.orderId, orders.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('order-items', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getOrderItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Export\n// ===========================================\n\n/**\n * GET /api/export/customers\n * Export customers - ALL fields\n */\nexportRoutes.get('/customers', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(customers.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(customers.createdAt, end));\n    }\n\n    const customerList = await db\n      .select({\n        id: customers.id,\n        authUserId: customers.authUserId,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        phone: customers.phone,\n        defaultShippingAddress: customers.defaultShippingAddress,\n        defaultBillingAddress: customers.defaultBillingAddress,\n        isGuest: customers.isGuest,\n        isActive: customers.isActive,\n        acceptsMarketing: customers.acceptsMarketing,\n        notes: customers.notes,\n        tags: customers.tags,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n        updatedAt: customers.updatedAt,\n      })\n      .from(customers)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(customers.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('customers', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(customerList as any[], exportService.getCustomerColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(customerList));\n    } else {\n      res.send(exportService.toJSON(customerList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Promo Code Export\n// ===========================================\n\n/**\n * GET /api/export/promo-codes\n * Export promo codes - ALL fields\n */\nexportRoutes.get('/promo-codes', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format } = req.query;\n\n    const promoCodeList = await db\n      .select()\n      .from(promoCodes)\n      .orderBy(desc(promoCodes.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('promo-codes', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(promoCodeList as any[], exportService.getPromoCodeColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(promoCodeList));\n    } else {\n      res.send(exportService.toJSON(promoCodeList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Quotation Export\n// ===========================================\n\n/**\n * GET /api/export/quotations\n * Export quotations - ALL fields\n */\nexportRoutes.get('/quotations', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate, status } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(quotations.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(quotations.createdAt, end));\n    }\n    if (status) {\n      conditions.push(eq(quotations.status, status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired'));\n    }\n\n    const quotationList = await db\n      .select()\n      .from(quotations)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(quotations.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('quotations', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(quotationList as any[], exportService.getQuotationColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(quotationList));\n    } else {\n      res.send(exportService.toJSON(quotationList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/quotation-items\n * Export ALL quotation items (bulk export)\n */\nexportRoutes.get('/quotation-items', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(quotations.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(quotations.createdAt, end));\n    }\n\n    const items = await db\n      .select({\n        id: quotationItems.id,\n        quotationId: quotationItems.quotationId,\n        quotationNumber: quotations.quotationNumber,\n        productId: quotationItems.productId,\n        variantId: quotationItems.variantId,\n        name: quotationItems.name,\n        description: quotationItems.description,\n        sku: quotationItems.sku,\n        quantity: quotationItems.quantity,\n        unitPrice: quotationItems.unitPrice,\n        lineTotal: sql<string>`CAST(${quotationItems.unitPrice} AS DECIMAL) * ${quotationItems.quantity}`,\n        createdAt: quotationItems.createdAt,\n      })\n      .from(quotationItems)\n      .innerJoin(quotations, eq(quotationItems.quotationId, quotations.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(quotations.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('quotation-items', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getQuotationItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, customers, productImportJobs, eq } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\nimport { importService } from '../services/import.service';\nimport { generateSlug } from '../utils/helpers';\n\n// Address type for customer imports\ntype CustomerAddress = {\n  firstName: string;\n  lastName: string;\n  company?: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone?: string;\n} | null | undefined;\n\nexport const importRoutes = Router();\n\n// Apply admin auth to all routes\nimportRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst csvImportSchema = z.object({\n  csvContent: z.string().min(1),\n  dryRun: z.boolean().optional().default(false),\n  updateExisting: z.boolean().optional().default(false),\n});\n\nconst urlImportSchema = z.object({\n  url: z.string().url(),\n  source: z.enum(['amazon', 'aliexpress', 'ebay', 'other']).optional().default('other'),\n});\n\n// ===========================================\n// Template Downloads\n// ===========================================\n\n/**\n * GET /api/import/templates/products\n * Download product import template\n */\nimportRoutes.get('/templates/products', (_req, res) => {\n  res.setHeader('Content-Type', 'text/csv');\n  res.setHeader('Content-Disposition', 'attachment; filename=\"product-import-template.csv\"');\n  res.send(importService.getProductTemplate());\n});\n\n/**\n * GET /api/import/templates/customers\n * Download customer import template\n */\nimportRoutes.get('/templates/customers', (_req, res) => {\n  res.setHeader('Content-Type', 'text/csv');\n  res.setHeader('Content-Disposition', 'attachment; filename=\"customer-import-template.csv\"');\n  res.send(importService.getCustomerTemplate());\n});\n\n// ===========================================\n// Product Import\n// ===========================================\n\n/**\n * POST /api/import/products\n * Import products from CSV\n */\nimportRoutes.post(\n  '/products',\n  validateBody(csvImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { csvContent, dryRun, updateExisting } = req.body;\n\n      // Parse CSV\n      const rawData = importService.parseCSV(csvContent);\n\n      if (rawData.length === 0) {\n        throw new BadRequestError('CSV file is empty or invalid');\n      }\n\n      // Validate and map data\n      const result = importService.mapAndValidate(\n        rawData,\n        importService.getProductMappings(),\n        importService.getProductSchema()\n      );\n\n      // If dry run, just return validation results\n      if (dryRun) {\n        return sendSuccess(res, {\n          dryRun: true,\n          ...result,\n          data: result.data.slice(0, 5), // Only return first 5 for preview\n        });\n      }\n\n      // Import products\n      let importedCount = 0;\n      let updatedCount = 0;\n      let skippedCount = 0;\n\n      for (const productData of result.data) {\n        const data = productData as z.infer<ReturnType<typeof importService.getProductSchema>>;\n\n        // Check if product with same SKU exists\n        const [existingProduct] = await db\n          .select({ id: products.id })\n          .from(products)\n          .where(eq(products.sku, data.sku));\n\n        if (existingProduct) {\n          if (updateExisting) {\n            // Update existing product with ALL fields\n            await db\n              .update(products)\n              .set({\n                name: data.name,\n                barcode: data.barcode,\n                description: data.description,\n                shortDescription: data.shortDescription,\n                basePrice: String(data.basePrice),\n                costPrice: data.costPrice ? String(data.costPrice) : undefined,\n                compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : undefined,\n                stockQuantity: data.stockQuantity,\n                lowStockThreshold: data.lowStockThreshold,\n                trackInventory: data.trackInventory,\n                allowBackorder: data.allowBackorder,\n                weight: data.weight ? String(data.weight) : undefined,\n                dimensions: data.dimensions,\n                brand: data.brand,\n                status: data.status,\n                isFeatured: data.isFeatured,\n                isDigital: data.isDigital,\n                requiresShipping: data.requiresShipping,\n                thumbnailUrl: data.thumbnailUrl,\n                images: data.images,\n                metaTitle: data.metaTitle,\n                metaDescription: data.metaDescription,\n                tags: data.tags,\n                features: data.features,\n                specifications: data.specifications,\n                supplierId: data.supplierId,\n                supplierSku: data.supplierSku,\n                updatedAt: new Date(),\n              })\n              .where(eq(products.id, existingProduct.id));\n            updatedCount++;\n          } else {\n            skippedCount++;\n          }\n          continue;\n        }\n\n        // Get category ID if category name provided\n        let categoryId: string | undefined;\n        if (data.categoryName) {\n          const [category] = await db\n            .select({ id: categories.id })\n            .from(categories)\n            .where(eq(categories.name, data.categoryName));\n\n          if (category) {\n            categoryId = category.id;\n          }\n        }\n\n        // Generate slug\n        const slug = generateSlug(data.name);\n\n        // Create product with ALL fields\n        await db.insert(products).values({\n          name: data.name,\n          slug: `${slug}-${Date.now()}`, // Ensure unique slug\n          sku: data.sku,\n          barcode: data.barcode,\n          description: data.description,\n          shortDescription: data.shortDescription,\n          basePrice: String(data.basePrice),\n          costPrice: data.costPrice ? String(data.costPrice) : undefined,\n          compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : undefined,\n          stockQuantity: data.stockQuantity || 0,\n          lowStockThreshold: data.lowStockThreshold || 5,\n          trackInventory: data.trackInventory ?? true,\n          allowBackorder: data.allowBackorder || false,\n          weight: data.weight ? String(data.weight) : undefined,\n          dimensions: data.dimensions,\n          categoryId,\n          brand: data.brand,\n          status: data.status || 'draft',\n          isFeatured: data.isFeatured || false,\n          isDigital: data.isDigital || false,\n          requiresShipping: data.requiresShipping ?? true,\n          thumbnailUrl: data.thumbnailUrl,\n          images: data.images || [],\n          metaTitle: data.metaTitle,\n          metaDescription: data.metaDescription,\n          tags: data.tags || [],\n          features: data.features || [],\n          specifications: data.specifications || {},\n          supplierId: data.supplierId,\n          supplierSku: data.supplierSku,\n        });\n\n        importedCount++;\n      }\n\n      sendSuccess(res, {\n        success: true,\n        totalRows: result.totalRows,\n        imported: importedCount,\n        updated: updatedCount,\n        skipped: skippedCount,\n        errors: result.errors,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Customer Import\n// ===========================================\n\n/**\n * POST /api/import/customers\n * Import customers from CSV\n */\nimportRoutes.post(\n  '/customers',\n  validateBody(csvImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { csvContent, dryRun, updateExisting } = req.body;\n\n      // Parse CSV\n      const rawData = importService.parseCSV(csvContent);\n\n      if (rawData.length === 0) {\n        throw new BadRequestError('CSV file is empty or invalid');\n      }\n\n      // Validate and map data\n      const result = importService.mapAndValidate(\n        rawData,\n        importService.getCustomerMappings(),\n        importService.getCustomerSchema()\n      );\n\n      // If dry run, just return validation results\n      if (dryRun) {\n        return sendSuccess(res, {\n          dryRun: true,\n          ...result,\n          data: result.data.slice(0, 5),\n        });\n      }\n\n      // Import customers\n      let importedCount = 0;\n      let updatedCount = 0;\n      let skippedCount = 0;\n\n      for (const customerData of result.data) {\n        const data = customerData as z.infer<ReturnType<typeof importService.getCustomerSchema>>;\n\n        // Check if customer with same email exists\n        const [existingCustomer] = await db\n          .select({ id: customers.id })\n          .from(customers)\n          .where(eq(customers.email, data.email.toLowerCase()));\n\n        if (existingCustomer) {\n          if (updateExisting) {\n            // Build address JSON from flat fields\n            const shippingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'shipping') as CustomerAddress;\n            const billingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'billing') as CustomerAddress;\n\n            await db\n              .update(customers)\n              .set({\n                firstName: data.firstName,\n                lastName: data.lastName,\n                phone: data.phone,\n                isActive: data.isActive,\n                acceptsMarketing: data.acceptsMarketing,\n                notes: data.notes,\n                tags: data.tags,\n                defaultShippingAddress: shippingAddress,\n                defaultBillingAddress: billingAddress,\n                updatedAt: new Date(),\n              })\n              .where(eq(customers.id, existingCustomer.id));\n            updatedCount++;\n          } else {\n            skippedCount++;\n          }\n          continue;\n        }\n\n        // Build address JSON from flat fields\n        const shippingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'shipping') as CustomerAddress;\n        const billingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'billing') as CustomerAddress;\n\n        // Create customer with ALL fields\n        await db.insert(customers).values({\n          email: data.email.toLowerCase(),\n          firstName: data.firstName,\n          lastName: data.lastName,\n          phone: data.phone,\n          isActive: data.isActive ?? true,\n          isGuest: false,\n          acceptsMarketing: data.acceptsMarketing || false,\n          notes: data.notes,\n          tags: data.tags || [],\n          defaultShippingAddress: shippingAddress,\n          defaultBillingAddress: billingAddress,\n        });\n\n        importedCount++;\n      }\n\n      sendSuccess(res, {\n        success: true,\n        totalRows: result.totalRows,\n        imported: importedCount,\n        updated: updatedCount,\n        skipped: skippedCount,\n        errors: result.errors,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// URL Import (Web Scraping)\n// ===========================================\n\n/**\n * POST /api/import/from-url\n * Create import job from URL (Amazon, AliExpress, eBay)\n */\nimportRoutes.post(\n  '/from-url',\n  validateBody(urlImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { url, source } = req.body;\n\n      // Validate URL domain matches source\n      const urlObj = new URL(url);\n      const hostname = urlObj.hostname.toLowerCase();\n\n      let detectedSource = source;\n      if (hostname.includes('amazon')) {\n        detectedSource = 'amazon';\n      } else if (hostname.includes('aliexpress')) {\n        detectedSource = 'aliexpress';\n      } else if (hostname.includes('ebay')) {\n        detectedSource = 'ebay';\n      }\n\n      // Create import job\n      const jobResult = await db\n        .insert(productImportJobs)\n        .values({\n          source: detectedSource as 'amazon' | 'aliexpress' | 'ebay',\n          sourceUrl: url,\n          status: 'pending',\n        })\n        .returning();\n      const job = jobResult[0];\n\n      if (!job) {\n        throw new BadRequestError('Failed to create import job');\n      }\n\n      // TODO: Queue job for background processing\n      // For now, just return the job ID\n\n      sendCreated(res, {\n        jobId: job.id,\n        status: job.status,\n        source: detectedSource,\n        url,\n        message: 'Import job created. Product data will be extracted in the background.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/import/jobs\n * List import jobs\n */\nimportRoutes.get('/jobs', async (req, res, next) => {\n  try {\n    const db = getDb();\n\n    const jobs = await db\n      .select()\n      .from(productImportJobs)\n      .orderBy(productImportJobs.createdAt);\n\n    sendSuccess(res, jobs);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/import/jobs/:id\n * Get import job status\n */\nimportRoutes.get('/jobs/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select()\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    sendSuccess(res, job);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/import/jobs/:id/retry\n * Retry failed import job\n */\nimportRoutes.post('/jobs/:id/retry', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select()\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    if (job.status !== 'failed') {\n      throw new BadRequestError('Only failed jobs can be retried');\n    }\n\n    // Reset job status\n    await db\n      .update(productImportJobs)\n      .set({\n        status: 'pending',\n        errorMessage: null,\n      })\n      .where(eq(productImportJobs.id, id));\n\n    // TODO: Re-queue job for processing\n\n    sendSuccess(res, { message: 'Job queued for retry' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/import/jobs/:id\n * Delete import job\n */\nimportRoutes.delete('/jobs/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select({ id: productImportJobs.id })\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    await db.delete(productImportJobs).where(eq(productImportJobs.id, id));\n\n    sendSuccess(res, { message: 'Import job deleted' });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport crypto from 'crypto';\nimport { getDb, newsletterSubscribers, eq } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { strictLimiter } from '../middleware/rateLimiter';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\n\nexport const contactRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst contactFormSchema = z.object({\n  name: z.string().min(1).max(100),\n  email: z.string().email(),\n  phone: z.string().max(50).optional(),\n  subject: z.string().min(1).max(200),\n  message: z.string().min(10).max(5000),\n  recaptchaToken: z.string().optional(), // For future reCAPTCHA integration\n});\n\nconst newsletterSchema = z.object({\n  email: z.string().email(),\n  name: z.string().max(100).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional(),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * POST /api/contact\n * Submit contact form\n */\ncontactRoutes.post(\n  '/',\n  strictLimiter,\n  validateBody(contactFormSchema),\n  async (req, res, next) => {\n    try {\n      const { name, email, phone, subject, message } = req.body;\n\n      // TODO: Integrate with email service to send contact form\n      // TODO: Optionally store in database for admin review\n      // TODO: Integrate reCAPTCHA validation\n\n      // For now, just return success\n      // In production, this would send an email\n\n      // Log the contact form submission\n      console.log('Contact form submission:', {\n        name,\n        email,\n        phone,\n        subject,\n        messageLength: message.length,\n        timestamp: new Date().toISOString(),\n      });\n\n      sendSuccess(res, {\n        message: 'Thank you for contacting us. We will get back to you soon.',\n        received: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/newsletter\n * Subscribe to newsletter\n */\ncontactRoutes.post(\n  '/newsletter',\n  strictLimiter,\n  validateBody(newsletterSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { email, name, source = 'footer' } = req.body;\n\n      // Check if already subscribed\n      const [existing] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.email, email.toLowerCase()));\n\n      if (existing) {\n        // If unsubscribed, resubscribe them\n        if (existing.status === 'unsubscribed') {\n          await db\n            .update(newsletterSubscribers)\n            .set({\n              status: 'active',\n              name: name || existing.name,\n              unsubscribedAt: null,\n              updatedAt: new Date(),\n            })\n            .where(eq(newsletterSubscribers.id, existing.id));\n\n          return sendSuccess(res, {\n            message: 'Welcome back! You have been resubscribed to our newsletter.',\n            subscribed: true,\n          });\n        }\n\n        // Already active\n        return sendSuccess(res, {\n          message: 'You are already subscribed to our newsletter.',\n          subscribed: true,\n        });\n      }\n\n      // Generate unsubscribe token\n      const unsubscribeToken = crypto.randomBytes(32).toString('hex');\n\n      // Create new subscriber\n      await db.insert(newsletterSubscribers).values({\n        email: email.toLowerCase(),\n        name: name || null,\n        source,\n        unsubscribeToken,\n        status: 'active',\n      });\n\n      sendSuccess(res, {\n        message: 'Successfully subscribed to the newsletter.',\n        subscribed: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/contact/newsletter/unsubscribe/:token\n * Get unsubscribe info (for unsubscribe page)\n */\ncontactRoutes.get(\n  '/newsletter/unsubscribe/:token',\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { token } = req.params;\n\n      const [subscriber] = await db\n        .select({ email: newsletterSubscribers.email, status: newsletterSubscribers.status })\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.unsubscribeToken, token));\n\n      if (!subscriber) {\n        throw new NotFoundError('Invalid unsubscribe link');\n      }\n\n      sendSuccess(res, {\n        email: subscriber.email,\n        status: subscriber.status,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/newsletter/unsubscribe/:token\n * Process unsubscribe request\n */\ncontactRoutes.post(\n  '/newsletter/unsubscribe/:token',\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { token } = req.params;\n\n      const [subscriber] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.unsubscribeToken, token));\n\n      if (!subscriber) {\n        throw new NotFoundError('Invalid unsubscribe link');\n      }\n\n      if (subscriber.status === 'unsubscribed') {\n        return sendSuccess(res, {\n          message: 'You have already unsubscribed from our newsletter.',\n          unsubscribed: true,\n        });\n      }\n\n      await db\n        .update(newsletterSubscribers)\n        .set({\n          status: 'unsubscribed',\n          unsubscribedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(newsletterSubscribers.id, subscriber.id));\n\n      sendSuccess(res, {\n        message: 'You have been successfully unsubscribed from our newsletter.',\n        unsubscribed: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/quote-request\n * Request a quote\n */\ncontactRoutes.post(\n  '/quote-request',\n  strictLimiter,\n  validateBody(\n    z.object({\n      name: z.string().min(1).max(100),\n      email: z.string().email(),\n      phone: z.string().max(50).optional(),\n      company: z.string().max(255).optional(),\n      products: z\n        .array(\n          z.object({\n            productId: z.string().uuid(),\n            quantity: z.number().int().min(1),\n          })\n        )\n        .min(1),\n      message: z.string().max(2000).optional(),\n    })\n  ),\n  async (req, res, next) => {\n    try {\n      const { name, email, phone, company, products, message } = req.body;\n\n      // TODO: Create quotation in database\n      // TODO: Send notification email to admin\n      // TODO: Send confirmation email to customer\n\n      console.log('Quote request:', {\n        name,\n        email,\n        phone,\n        company,\n        productCount: products.length,\n        timestamp: new Date().toISOString(),\n      });\n\n      sendSuccess(res, {\n        message: 'Quote request received. We will contact you shortly with pricing.',\n        received: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport ImageKit from 'imagekit';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError } from '../utils/errors';\nimport { config } from '../config';\n\nexport const uploadRoutes = Router();\n\n// Initialize ImageKit\nlet imagekit: ImageKit | null = null;\n\nfunction getImageKit(): ImageKit {\n  if (!imagekit) {\n    if (\n      !config.imagekit.publicKey ||\n      !config.imagekit.privateKey ||\n      !config.imagekit.urlEndpoint\n    ) {\n      throw new BadRequestError('ImageKit is not configured');\n    }\n\n    imagekit = new ImageKit({\n      publicKey: config.imagekit.publicKey,\n      privateKey: config.imagekit.privateKey,\n      urlEndpoint: config.imagekit.urlEndpoint,\n    });\n  }\n  return imagekit;\n}\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst uploadSchema = z.object({\n  file: z.string().min(1), // Base64 encoded file\n  fileName: z.string().min(1).max(255),\n  folder: z.string().optional().default('/uploads'),\n});\n\nconst uploadUrlSchema = z.object({\n  url: z.string().url(),\n  fileName: z.string().min(1).max(255),\n  folder: z.string().optional().default('/uploads'),\n});\n\nconst deleteSchema = z.object({\n  fileId: z.string().min(1),\n});\n\n// ===========================================\n// Auth Required for All Routes\n// ===========================================\n\nuploadRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/upload/auth\n * Get ImageKit authentication parameters for client-side uploads\n */\nuploadRoutes.get('/auth', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const authParams = ik.getAuthenticationParameters();\n\n    sendSuccess(res, authParams);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/upload\n * Upload a file (base64)\n */\nuploadRoutes.post(\n  '/',\n  validateBody(uploadSchema),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { file, fileName, folder } = req.body;\n\n      const result = await ik.upload({\n        file,\n        fileName,\n        folder,\n        useUniqueFileName: true,\n      });\n\n      sendSuccess(res, {\n        fileId: result.fileId,\n        name: result.name,\n        url: result.url,\n        thumbnailUrl: result.thumbnailUrl,\n        filePath: result.filePath,\n        fileType: result.fileType,\n        size: result.size,\n        width: result.width,\n        height: result.height,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/upload/from-url\n * Upload a file from URL\n */\nuploadRoutes.post(\n  '/from-url',\n  validateBody(uploadUrlSchema),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { url, fileName, folder } = req.body;\n\n      const result = await ik.upload({\n        file: url,\n        fileName,\n        folder,\n        useUniqueFileName: true,\n      });\n\n      sendSuccess(res, {\n        fileId: result.fileId,\n        name: result.name,\n        url: result.url,\n        thumbnailUrl: result.thumbnailUrl,\n        filePath: result.filePath,\n        fileType: result.fileType,\n        size: result.size,\n        width: result.width,\n        height: result.height,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/upload/:fileId\n * Delete a file\n */\nuploadRoutes.delete('/:fileId', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { fileId } = req.params;\n\n    await ik.deleteFile(fileId);\n\n    sendSuccess(res, { message: 'File deleted successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/upload/list\n * List files in a folder\n */\nuploadRoutes.get('/list', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { folder, limit, skip } = req.query;\n\n    const files = await ik.listFiles({\n      path: (folder as string) || '/uploads',\n      limit: limit ? parseInt(limit as string) : 20,\n      skip: skip ? parseInt(skip as string) : 0,\n    });\n\n    sendSuccess(res, files);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/upload/:fileId\n * Get file details\n */\nuploadRoutes.get('/:fileId', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { fileId } = req.params;\n\n    const file = await ik.getFileDetails(fileId);\n\n    sendSuccess(res, file);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/upload/bulk-delete\n * Delete multiple files\n */\nuploadRoutes.post(\n  '/bulk-delete',\n  validateBody(z.object({ fileIds: z.array(z.string()).min(1).max(100) })),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { fileIds } = req.body;\n\n      await ik.bulkDeleteFiles(fileIds);\n\n      sendSuccess(res, {\n        message: `${fileIds.length} files deleted successfully`,\n        deletedCount: fileIds.length,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/upload/transform\n * Get transformed image URL\n */\nuploadRoutes.get('/transform/:filePath(*)', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { filePath } = req.params;\n    const { width, height, quality, format, crop } = req.query;\n\n    const transformations: Array<{ width?: number; height?: number; quality?: number; format?: string; cropMode?: string }> = [];\n\n    if (width || height || quality || format || crop) {\n      const transform: typeof transformations[0] = {};\n      if (width) {transform.width = parseInt(width as string);}\n      if (height) {transform.height = parseInt(height as string);}\n      if (quality) {transform.quality = parseInt(quality as string);}\n      if (format) {transform.format = format as string;}\n      if (crop) {transform.cropMode = crop as string;}\n      transformations.push(transform);\n    }\n\n    const url = ik.url({\n      path: `/${filePath}`,\n      transformation: transformations.length > 0 ? transformations : undefined,\n    });\n\n    sendSuccess(res, { url });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { checkDbHealth, verifySchema, testConnection } from '../utils/db-health';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\n\nexport const healthRoutes = Router();\n\n/**\n * GET /api/health\n * Basic health check (public)\n */\nhealthRoutes.get('/', async (_req, res) => {\n  const dbConnected = await testConnection();\n\n  res.json({\n    status: dbConnected ? 'ok' : 'degraded',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    database: dbConnected ? 'connected' : 'disconnected',\n  });\n});\n\n/**\n * GET /api/health/detailed\n * Detailed health check (admin only)\n */\nhealthRoutes.get('/detailed', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const dbHealth = await checkDbHealth();\n    const schemaStatus = await verifySchema();\n\n    sendSuccess(res, {\n      status: dbHealth.connected && schemaStatus.valid ? 'healthy' : 'unhealthy',\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n      memory: {\n        heapUsed: Math.round(process.memoryUsage().heapUsed / 1024 / 1024),\n        heapTotal: Math.round(process.memoryUsage().heapTotal / 1024 / 1024),\n        rss: Math.round(process.memoryUsage().rss / 1024 / 1024),\n      },\n      database: {\n        connected: dbHealth.connected,\n        latency: dbHealth.latency,\n        version: dbHealth.version,\n        error: dbHealth.error,\n      },\n      schema: {\n        valid: schemaStatus.valid,\n        tablesCount: dbHealth.tables.length,\n        missingTables: schemaStatus.missingTables,\n      },\n      environment: process.env['NODE_ENV'] || 'development',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/health/ready\n * Readiness probe for Kubernetes/Docker\n */\nhealthRoutes.get('/ready', async (_req, res) => {\n  const dbConnected = await testConnection();\n\n  if (dbConnected) {\n    res.status(200).json({ ready: true });\n  } else {\n    res.status(503).json({ ready: false, reason: 'Database not connected' });\n  }\n});\n\n/**\n * GET /api/health/live\n * Liveness probe for Kubernetes/Docker\n */\nhealthRoutes.get('/live', (_req, res) => {\n  res.status(200).json({ alive: true });\n});\n","/**\n * Database Health Check Utility\n * Verifies NeonDB connection and schema integrity\n */\n\nimport { getDb, sql } from '@lab404/database';\n\nexport interface DbHealthStatus {\n  connected: boolean;\n  latency: number;\n  version: string;\n  tables: string[];\n  error?: string;\n}\n\n/**\n * Check database connection and health\n */\nexport async function checkDbHealth(): Promise<DbHealthStatus> {\n  const startTime = Date.now();\n\n  try {\n    const db = getDb();\n\n    // Test connection with simple query\n    const versionResult = await db.execute(sql`SELECT version()`);\n    const rows = versionResult.rows as Array<{ version: string }>;\n    const version = rows[0]?.version || 'unknown';\n\n    const latency = Date.now() - startTime;\n\n    // Get list of tables\n    const tablesResult = await db.execute(sql`\n      SELECT table_name\n      FROM information_schema.tables\n      WHERE table_schema = 'public'\n      ORDER BY table_name\n    `);\n\n    const tableRows = tablesResult.rows as Array<{ table_name: string }>;\n    const tables = tableRows.map(t => t.table_name);\n\n    return {\n      connected: true,\n      latency,\n      version,\n      tables,\n    };\n  } catch (error) {\n    return {\n      connected: false,\n      latency: Date.now() - startTime,\n      version: 'unknown',\n      tables: [],\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Verify all required tables exist\n */\nexport async function verifySchema(): Promise<{\n  valid: boolean;\n  missingTables: string[];\n  extraTables: string[];\n}> {\n  const requiredTables = [\n    'addresses',\n    'admin_activity_logs',\n    'blogs',\n    'cart_items',\n    'cart_promo_codes',\n    'carts',\n    'categories',\n    'customers',\n    'order_items',\n    'orders',\n    'product_import_jobs',\n    'product_variants',\n    'products',\n    'promo_codes',\n    'quotation_items',\n    'quotations',\n    'settings',\n  ];\n\n  try {\n    const health = await checkDbHealth();\n\n    if (!health.connected) {\n      return {\n        valid: false,\n        missingTables: requiredTables,\n        extraTables: [],\n      };\n    }\n\n    const existingTables = new Set(health.tables);\n    const missingTables = requiredTables.filter(t => !existingTables.has(t));\n    const extraTables = health.tables.filter(t => !requiredTables.includes(t));\n\n    return {\n      valid: missingTables.length === 0,\n      missingTables,\n      extraTables,\n    };\n  } catch (error) {\n    return {\n      valid: false,\n      missingTables: requiredTables,\n      extraTables: [],\n    };\n  }\n}\n\n/**\n * Run database connection test\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const db = getDb();\n    await db.execute(sql`SELECT 1`);\n    return true;\n  } catch {\n    return false;\n  }\n}\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { notificationService, NotificationType } from '../services/notification.service';\nimport { mailerService } from '../services/mailer.service';\nimport { validateBody } from '../middleware/validator';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\n\nconst router = Router();\n\n// Schema for updating notification settings\nconst updateSettingsSchema = z.object({\n  enabled: z.boolean().optional(),\n  adminEmails: z.array(z.string().email()).optional(),\n  notifications: z.object({\n    new_order: z.boolean().optional(),\n    order_status_change: z.boolean().optional(),\n    low_stock_alert: z.boolean().optional(),\n    new_customer: z.boolean().optional(),\n    new_contact_message: z.boolean().optional(),\n    quotation_request: z.boolean().optional(),\n    payment_received: z.boolean().optional(),\n    refund_processed: z.boolean().optional(),\n  }).optional(),\n});\n\n// Schema for sending test notification\nconst testNotificationSchema = z.object({\n  type: z.enum([\n    'new_order',\n    'order_status_change',\n    'low_stock_alert',\n    'new_customer',\n    'new_contact_message',\n    'quotation_request',\n    'payment_received',\n    'refund_processed',\n  ]),\n  email: z.string().email().optional(),\n});\n\n/**\n * @route GET /api/notifications/settings\n * @desc Get notification settings\n * @access Admin\n */\nrouter.get('/settings', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const settings = notificationService.getSettings();\n    const smtpConfigured = mailerService.isReady();\n\n    sendSuccess(res, {\n      ...settings,\n      smtpConfigured,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * @route PUT /api/notifications/settings\n * @desc Update notification settings\n * @access Admin\n */\nrouter.put(\n  '/settings',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateSettingsSchema),\n  async (req, res, next) => {\n    try {\n      const updates = req.body;\n      notificationService.updateSettings(updates);\n\n      sendSuccess(res, {\n        message: 'Notification settings updated successfully',\n        settings: notificationService.getSettings(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * @route POST /api/notifications/test\n * @desc Send a test notification\n * @access Admin\n */\nrouter.post(\n  '/test',\n  requireAuth,\n  requireAdmin,\n  validateBody(testNotificationSchema),\n  async (req, res, next) => {\n    try {\n      const { type, email } = req.body;\n\n      if (!mailerService.isReady()) {\n        return sendError(res, 400, 'SMTP_NOT_CONFIGURED', 'SMTP not configured. Please configure SMTP settings first.');\n      }\n\n      // Test data for different notification types\n      const testData: Record<NotificationType, Record<string, string | number>> = {\n        new_order: {\n          orderId: 'TEST-001',\n          customerName: 'Test Customer',\n          customerEmail: 'test@example.com',\n          total: '299.99',\n          itemCount: 3,\n        },\n        order_status_change: {\n          orderId: 'TEST-001',\n          previousStatus: 'pending',\n          newStatus: 'processing',\n        },\n        low_stock_alert: {\n          productId: 'prod_123',\n          productName: 'Arduino Uno R3',\n          sku: 'ARD-UNO-R3',\n          currentStock: 5,\n          threshold: 10,\n        },\n        new_customer: {\n          customerId: 'cust_123',\n          customerName: 'John Doe',\n          customerEmail: 'john@example.com',\n        },\n        new_contact_message: {\n          name: 'Jane Smith',\n          email: 'jane@example.com',\n          subject: 'Product Inquiry',\n          message: 'I would like to know more about your Arduino kits.',\n        },\n        quotation_request: {\n          quotationId: 'QT-001',\n          customerName: 'Acme Corp',\n          customerEmail: 'purchasing@acme.com',\n          itemCount: 5,\n        },\n        payment_received: {\n          orderId: 'ORD-001',\n          amount: '499.99',\n          paymentMethod: 'Credit Card',\n          transactionId: 'txn_abc123',\n        },\n        refund_processed: {\n          orderId: 'ORD-001',\n          amount: '99.99',\n          reason: 'Customer requested cancellation',\n        },\n      };\n\n      // Temporarily override admin emails if a test email is provided\n      const originalSettings = notificationService.getSettings();\n      if (email) {\n        notificationService.updateSettings({ adminEmails: [email] });\n      }\n\n      const success = await notificationService.notify(type as NotificationType, testData[type as NotificationType]);\n\n      // Restore original settings\n      if (email) {\n        notificationService.updateSettings({ adminEmails: originalSettings.adminEmails });\n      }\n\n      if (success) {\n        sendSuccess(res, {\n          message: `Test ${type} notification sent successfully`,\n          sentTo: email || originalSettings.adminEmails,\n        });\n      } else {\n        sendError(res, 500, 'NOTIFICATION_FAILED', 'Failed to send test notification');\n      }\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * @route POST /api/notifications/verify-smtp\n * @desc Verify SMTP connection\n * @access Admin\n */\nrouter.post('/verify-smtp', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const isConnected = await mailerService.verifyConnection();\n\n    if (isConnected) {\n      sendSuccess(res, {\n        message: 'SMTP connection verified successfully',\n        connected: true,\n      });\n    } else {\n      sendError(res, 400, 'SMTP_CONNECTION_FAILED', 'SMTP connection failed. Please check your settings.');\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\nexport default router;\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { searchService } from '../services';\n\nexport const searchRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst searchQuerySchema = z.object({\n    q: z.string().min(1).max(200),\n    limit: z.coerce.number().min(1).max(100).optional(),\n    offset: z.coerce.number().min(0).optional(),\n    category: z.string().optional(),\n    minPrice: z.coerce.number().optional(),\n    maxPrice: z.coerce.number().optional(),\n    inStock: z.string().optional(),\n    brand: z.string().optional(),\n    sort: z.enum(['name:asc', 'name:desc', 'basePrice:asc', 'basePrice:desc', 'createdAt:desc']).optional(),\n    facets: z.string().optional(), // comma-separated list of facet fields\n});\n\nconst autocompleteSchema = z.object({\n    q: z.string().min(1).max(100),\n    limit: z.coerce.number().min(1).max(10).optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/search\n * Full-text product search with filters and facets\n */\nsearchRoutes.get('/', validateQuery(searchQuerySchema), async (req, res, next) => {\n    try {\n        const { q, limit = 20, offset = 0, category, minPrice, maxPrice, inStock, brand, sort, facets } = req.query;\n\n        // Check if Meilisearch is available\n        const isAvailable = await searchService.isAvailable();\n        if (!isAvailable) {\n            return sendSuccess(res, {\n                hits: [],\n                query: q as string,\n                processingTimeMs: 0,\n                estimatedTotalHits: 0,\n                limit: Number(limit),\n                offset: Number(offset),\n                error: 'Search service temporarily unavailable',\n            });\n        }\n\n        // Build filters\n        const filters: string[] = [];\n\n        if (category) {\n            filters.push(`categorySlug = \"${category}\"`);\n        }\n\n        if (minPrice !== undefined) {\n            filters.push(`basePrice >= ${minPrice}`);\n        }\n\n        if (maxPrice !== undefined) {\n            filters.push(`basePrice <= ${maxPrice}`);\n        }\n\n        if (inStock === 'true') {\n            filters.push('inStock = true');\n        }\n\n        if (brand) {\n            filters.push(`brand = \"${brand}\"`);\n        }\n\n        // Build sort array\n        const sortArray: string[] = [];\n        if (sort) {\n            sortArray.push(sort as string);\n        }\n\n        // Build facets array\n        const facetFields = facets ? (facets as string).split(',') : ['categorySlug', 'brand', 'inStock'];\n\n        // Perform search\n        const result = await searchService.searchProducts(q as string, {\n            limit: Number(limit),\n            offset: Number(offset),\n            filters,\n            sort: sortArray,\n            facets: facetFields,\n        });\n\n        sendSuccess(res, result);\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * GET /api/search/autocomplete\n * Quick autocomplete suggestions\n */\nsearchRoutes.get('/autocomplete', validateQuery(autocompleteSchema), async (req, res, next) => {\n    try {\n        const { q, limit = 5 } = req.query;\n\n        // Check if Meilisearch is available\n        const isAvailable = await searchService.isAvailable();\n        if (!isAvailable) {\n            return sendSuccess(res, { suggestions: [] });\n        }\n\n        const result = await searchService.searchProducts(q as string, {\n            limit: Number(limit),\n            offset: 0,\n        });\n\n        // Return simplified suggestions\n        const suggestions = result.hits.map(hit => ({\n            id: hit.id,\n            name: hit.name,\n            slug: hit.slug,\n            thumbnailUrl: hit.thumbnailUrl,\n            basePrice: hit.basePrice,\n            categoryName: hit.categoryName,\n        }));\n\n        sendSuccess(res, { suggestions, query: q });\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * GET /api/search/health\n * Check search service health\n */\nsearchRoutes.get('/health', async (req, res, next) => {\n    try {\n        const isAvailable = await searchService.isAvailable();\n        const stats = isAvailable ? await searchService.getIndexStats() : null;\n\n        sendSuccess(res, {\n            available: isAvailable,\n            stats,\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * POST /api/search/sync\n * Sync all products to search index (Admin only)\n */\nsearchRoutes.post('/sync', requireAuth, requireAdmin, async (req, res, next) => {\n    try {\n        // Initialize the index if needed\n        await searchService.initialize();\n\n        // Sync all products\n        const result = await searchService.syncAllProducts();\n\n        sendSuccess(res, {\n            message: 'Products synced successfully',\n            ...result,\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * POST /api/search/initialize\n * Initialize search index with settings (Admin only)\n */\nsearchRoutes.post('/initialize', requireAuth, requireAdmin, async (req, res, next) => {\n    try {\n        await searchService.initialize();\n\n        sendSuccess(res, {\n            message: 'Search index initialized successfully',\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { z } from 'zod';\nimport { google } from 'googleapis';\nimport ImageKit from 'imagekit';\nimport { config } from '../config';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { validateQuery, validateBody } from '../middleware/validator';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError } from '../utils/errors';\n\nexport const googleImagesRoutes = Router();\n\n// ===========================================\n// ImageKit Instance\n// ===========================================\n\nlet imagekit: ImageKit | null = null;\n\nfunction getImageKit(): ImageKit {\n  if (!imagekit) {\n    if (\n      !config.imagekit.publicKey ||\n      !config.imagekit.privateKey ||\n      !config.imagekit.urlEndpoint\n    ) {\n      throw new BadRequestError('ImageKit is not configured');\n    }\n\n    imagekit = new ImageKit({\n      publicKey: config.imagekit.publicKey,\n      privateKey: config.imagekit.privateKey,\n      urlEndpoint: config.imagekit.urlEndpoint,\n    });\n  }\n  return imagekit;\n}\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst searchQuerySchema = z.object({\n  query: z.string().min(1, 'Search query is required').max(200, 'Query too long'),\n  limit: z.string().optional().transform(val => Math.min(parseInt(val || '10', 10), 10)),\n  start: z.string().optional().transform(val => Math.max(parseInt(val || '1', 10), 1)),\n  safeSearch: z.enum(['off', 'medium', 'high']).optional().default('medium'),\n  imageSize: z.enum(['huge', 'icon', 'large', 'medium', 'small', 'xlarge', 'xxlarge']).optional(),\n  imageType: z.enum(['clipart', 'face', 'lineart', 'stock', 'photo', 'animated']).optional(),\n  fileType: z.enum(['jpg', 'png', 'gif', 'bmp', 'svg', 'webp', 'ico']).optional(),\n});\n\nconst downloadSchema = z.object({\n  imageUrl: z.string().url('Invalid image URL').optional(),\n  imageUrls: z.array(z.string().url('Invalid image URL')).max(10, 'Maximum 10 images per batch').optional(),\n  folder: z.string().optional().default('/products'),\n});\n\n// Cache for search results\ninterface CacheEntry {\n  data: any;\n  timestamp: number;\n}\n\nconst CACHE_TTL = 5 * 60 * 1000; // 5 minutes\nconst searchCache = new Map<string, CacheEntry>();\n\n// Initialize Google Custom Search client\nlet customSearch: any = null;\n\nfunction getCustomSearchClient() {\n  if (!customSearch) {\n    customSearch = google.customsearch('v1');\n  }\n  return customSearch;\n}\n\n// Generate cache key\nfunction generateCacheKey(options: any): string {\n  return JSON.stringify({\n    q: options.query,\n    start: options.start || 1,\n    num: options.limit || 10,\n    safe: options.safeSearch || 'medium',\n    imgSize: options.imageSize,\n    imgType: options.imageType,\n    fileType: options.fileType,\n  });\n}\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/google-images/search\n * Search Google Images with filters and pagination\n */\ngoogleImagesRoutes.get(\n  '/search',\n  requireAuth,\n  requireAdmin,\n  validateQuery(searchQuerySchema),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { query, limit, start, safeSearch, imageSize, imageType, fileType } = req.query as any;\n\n      // Check if Google API is configured\n      if (!config.google.apiKey || !config.google.searchEngineId) {\n        throw new BadRequestError('Google API is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID environment variables.');\n      }\n\n      // Generate cache key\n      const cacheKey = generateCacheKey({ query, limit, start, safeSearch, imageSize, imageType, fileType });\n\n      // Check cache\n      const cached = searchCache.get(cacheKey);\n      if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n        return sendSuccess(res, cached.data);\n      }\n\n      // Initialize client\n      const client = getCustomSearchClient();\n\n      // Build search params\n      const searchParams: any = {\n        auth: config.google.apiKey,\n        cx: config.google.searchEngineId,\n        q: query,\n        searchType: 'image',\n        num: limit || 10,\n        start: start || 1,\n        safe: safeSearch || 'medium',\n      };\n\n      if (imageSize) {searchParams.imgSize = imageSize;}\n      if (imageType) {searchParams.imgType = imageType;}\n      if (fileType) {searchParams.fileType = fileType;}\n\n      // Execute search\n      const response = await client.cse.list(searchParams);\n\n      if (!response || !response.data) {\n        throw new BadRequestError('Invalid response from Google API');\n      }\n\n      const result = {\n        query,\n        results: (response.data.items || []).map((item: any) => ({\n          title: item.title,\n          link: item.link,\n          thumbnail: item.image?.thumbnailLink,\n          displayLink: item.displayLink,\n          snippet: item.snippet,\n          mime: item.mime,\n          image: {\n            contextLink: item.image?.contextLink,\n            height: item.image?.height,\n            width: item.image?.width,\n            byteSize: item.image?.byteSize,\n            thumbnailLink: item.image?.thumbnailLink,\n            thumbnailHeight: item.image?.thumbnailHeight,\n            thumbnailWidth: item.image?.thumbnailWidth,\n          },\n        })),\n        totalResults: response.data.searchInformation?.totalResults || '0',\n        searchTime: response.data.searchInformation?.searchTime || 0,\n        pagination: {\n          start: start || 1,\n          limit: limit || 10,\n          hasNextPage: !!response.data.queries?.nextPage,\n          nextStart: response.data.queries?.nextPage?.[0]?.startIndex,\n        },\n      };\n\n      // Cache the result\n      searchCache.set(cacheKey, { data: result, timestamp: Date.now() });\n\n      // Clean old cache entries\n      if (searchCache.size > 100) {\n        const entries = Array.from(searchCache.entries())\n          .sort((a, b) => a[1].timestamp - b[1].timestamp);\n        const oldestEntry = entries[0];\n        if (oldestEntry) {\n          searchCache.delete(oldestEntry[0]);\n        }\n      }\n\n      sendSuccess(res, result);\n    } catch (error: any) {\n      // Handle specific Google API errors\n      if (error.code === 429) {\n        return next(new BadRequestError('Daily API quota exceeded. Please try again tomorrow.'));\n      }\n      if (error.code === 403) {\n        return next(new BadRequestError('Invalid API credentials. Please check your Google API configuration.'));\n      }\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/google-images/upload-to-imagekit\n * Download images from URLs and upload to ImageKit\n * Returns ImageKit URLs to be saved in the database\n */\ngoogleImagesRoutes.post(\n  '/upload-to-imagekit',\n  requireAuth,\n  requireAdmin,\n  validateBody(downloadSchema),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { imageUrl, imageUrls, folder } = req.body;\n\n      // Determine if single or batch upload\n      const urls: string[] = imageUrls || (imageUrl ? [imageUrl] : []);\n\n      if (urls.length === 0) {\n        throw new BadRequestError('At least one image URL is required');\n      }\n\n      const ik = getImageKit();\n\n      const results = await Promise.all(\n        urls.map(async (url: string, index: number) => {\n          try {\n            // Generate unique filename\n            const timestamp = Date.now();\n            const random = Math.random().toString(36).substring(2, 8);\n            const urlPath = new URL(url).pathname;\n            const extension = urlPath.split('.').pop()?.toLowerCase() || 'jpg';\n            const fileName = `google-image-${timestamp}-${index}-${random}.${extension}`;\n\n            // Upload to ImageKit using URL\n            const uploadResult = await ik.upload({\n              file: url, // ImageKit accepts URL directly\n              fileName,\n              folder: folder || '/products',\n              useUniqueFileName: true,\n              tags: ['google-images', 'product-image'],\n            });\n\n            return {\n              success: true,\n              originalUrl: url,\n              imagekitUrl: uploadResult.url,\n              imagekitFileId: uploadResult.fileId,\n              thumbnailUrl: uploadResult.thumbnailUrl,\n              metadata: {\n                width: uploadResult.width,\n                height: uploadResult.height,\n                size: uploadResult.size,\n                fileType: uploadResult.fileType,\n                filePath: uploadResult.filePath,\n              },\n            };\n          } catch (error: any) {\n            console.error(`Failed to upload image: ${url}`, error.message);\n            return {\n              success: false,\n              originalUrl: url,\n              error: error.message || 'Upload failed',\n            };\n          }\n        })\n      );\n\n      const successCount = results.filter((r) => r.success).length;\n      const failureCount = results.length - successCount;\n\n      // Extract just the successful ImageKit URLs for easy access\n      const imagekitUrls = results\n        .filter((r) => r.success)\n        .map((r) => r.imagekitUrl);\n\n      sendSuccess(res, {\n        results,\n        imagekitUrls, // Array of successful ImageKit URLs ready to use\n        summary: {\n          total: results.length,\n          success: successCount,\n          failed: failureCount,\n        },\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/google-images/cache-stats\n * Get cache statistics (Admin only)\n */\ngoogleImagesRoutes.get(\n  '/cache-stats',\n  requireAuth,\n  requireAdmin,\n  async (_req: Request, res: Response) => {\n    const now = Date.now();\n    const entries = Array.from(searchCache.entries()).map(([key, entry]) => {\n      const parsed = JSON.parse(key);\n      return {\n        query: parsed.q,\n        age: Math.floor((now - entry.timestamp) / 1000),\n      };\n    });\n\n    sendSuccess(res, {\n      size: searchCache.size,\n      ttl: Math.floor(CACHE_TTL / 1000),\n      entries,\n    });\n  }\n);\n\n/**\n * DELETE /api/google-images/cache\n * Clear the search cache (Admin only)\n */\ngoogleImagesRoutes.delete(\n  '/cache',\n  requireAuth,\n  requireAdmin,\n  async (_req: Request, res: Response) => {\n    const size = searchCache.size;\n    searchCache.clear();\n    sendSuccess(res, { cleared: size });\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, pdfTemplates, eq, desc, sql } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\n\nexport const pdfTemplatesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createTemplateSchema = z.object({\n  name: z.string().min(1).max(100),\n  isDefault: z.boolean().optional().default(false),\n  logoUrl: z.string().max(500).optional().nullable(),\n  primaryColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional().default('#1a1a2e'),\n  accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional().default('#0066cc'),\n  showCompanyLogo: z.boolean().optional().default(true),\n  showLineItemImages: z.boolean().optional().default(false),\n  showLineItemDescription: z.boolean().optional().default(false),\n  showSku: z.boolean().optional().default(true),\n  headerText: z.string().max(500).optional().nullable(),\n  footerText: z.string().max(500).optional().nullable(),\n  thankYouMessage: z.string().max(500).optional().nullable(),\n});\n\nconst updateTemplateSchema = z.object({\n  name: z.string().min(1).max(100).optional(),\n  isDefault: z.boolean().optional(),\n  logoUrl: z.string().max(500).optional().nullable(),\n  primaryColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional(),\n  accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional(),\n  showCompanyLogo: z.boolean().optional(),\n  showLineItemImages: z.boolean().optional(),\n  showLineItemDescription: z.boolean().optional(),\n  showSku: z.boolean().optional(),\n  headerText: z.string().max(500).optional().nullable(),\n  footerText: z.string().max(500).optional().nullable(),\n  thankYouMessage: z.string().max(500).optional().nullable(),\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/pdf-templates\n * Get all PDF templates (Admin only)\n */\npdfTemplatesRoutes.get('/', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(pdfTemplates);\n    const count = countResult[0]?.count ?? 0;\n\n    const templates = await db\n      .select()\n      .from(pdfTemplates)\n      .orderBy(desc(pdfTemplates.isDefault), desc(pdfTemplates.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, templates, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/pdf-templates/default\n * Get the default PDF template (Admin only)\n */\npdfTemplatesRoutes.get('/default', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    const [template] = await db\n      .select()\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.isDefault, true))\n      .limit(1);\n\n    if (!template) {\n      // Return default built-in values\n      return sendSuccess(res, {\n        id: null,\n        name: 'Default Template',\n        isDefault: true,\n        primaryColor: '#1a1a2e',\n        accentColor: '#0066cc',\n        showCompanyLogo: true,\n        showLineItemImages: false,\n        showLineItemDescription: false,\n        showSku: true,\n        headerText: null,\n        footerText: null,\n        thankYouMessage: null,\n      });\n    }\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/pdf-templates/:id\n * Get single PDF template (Admin only)\n */\npdfTemplatesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [template] = await db\n      .select()\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!template) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/pdf-templates\n * Create new PDF template (Admin only)\n */\npdfTemplatesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // If this is being set as default, unset other defaults\n      if (data.isDefault) {\n        await db\n          .update(pdfTemplates)\n          .set({ isDefault: false, updatedAt: new Date() })\n          .where(eq(pdfTemplates.isDefault, true));\n      }\n\n      const [template] = await db\n        .insert(pdfTemplates)\n        .values({\n          name: data.name,\n          isDefault: data.isDefault || false,\n          logoUrl: data.logoUrl,\n          primaryColor: data.primaryColor || '#1a1a2e',\n          accentColor: data.accentColor || '#0066cc',\n          showCompanyLogo: data.showCompanyLogo ?? true,\n          showLineItemImages: data.showLineItemImages ?? false,\n          showLineItemDescription: data.showLineItemDescription ?? false,\n          showSku: data.showSku ?? true,\n          headerText: data.headerText,\n          footerText: data.footerText,\n          thankYouMessage: data.thankYouMessage,\n        })\n        .returning();\n\n      sendSuccess(res, template, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/pdf-templates/:id\n * Update PDF template (Admin only)\n */\npdfTemplatesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      // Check exists\n      const [existing] = await db\n        .select({ id: pdfTemplates.id })\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('PDF template not found');\n      }\n\n      // If this is being set as default, unset other defaults\n      if (data['isDefault']) {\n        await db\n          .update(pdfTemplates)\n          .set({ isDefault: false, updatedAt: new Date() })\n          .where(eq(pdfTemplates.isDefault, true));\n      }\n\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      if (data['name'] !== undefined) {updateData['name'] = data['name'];}\n      if (data['isDefault'] !== undefined) {updateData['isDefault'] = data['isDefault'];}\n      if (data['logoUrl'] !== undefined) {updateData['logoUrl'] = data['logoUrl'];}\n      if (data['primaryColor'] !== undefined) {updateData['primaryColor'] = data['primaryColor'];}\n      if (data['accentColor'] !== undefined) {updateData['accentColor'] = data['accentColor'];}\n      if (data['showCompanyLogo'] !== undefined) {updateData['showCompanyLogo'] = data['showCompanyLogo'];}\n      if (data['showLineItemImages'] !== undefined) {updateData['showLineItemImages'] = data['showLineItemImages'];}\n      if (data['showLineItemDescription'] !== undefined) {updateData['showLineItemDescription'] = data['showLineItemDescription'];}\n      if (data['showSku'] !== undefined) {updateData['showSku'] = data['showSku'];}\n      if (data['headerText'] !== undefined) {updateData['headerText'] = data['headerText'];}\n      if (data['footerText'] !== undefined) {updateData['footerText'] = data['footerText'];}\n      if (data['thankYouMessage'] !== undefined) {updateData['thankYouMessage'] = data['thankYouMessage'];}\n\n      const [template] = await db\n        .update(pdfTemplates)\n        .set(updateData)\n        .where(eq(pdfTemplates.id, id))\n        .returning();\n\n      sendSuccess(res, template);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/pdf-templates/:id\n * Delete PDF template (Admin only)\n */\npdfTemplatesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Check exists\n    const [existing] = await db\n      .select({ id: pdfTemplates.id, isDefault: pdfTemplates.isDefault })\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    if (existing.isDefault) {\n      throw new BadRequestError('Cannot delete the default template. Set another template as default first.');\n    }\n\n    await db.delete(pdfTemplates).where(eq(pdfTemplates.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/pdf-templates/:id/set-default\n * Set template as default (Admin only)\n */\npdfTemplatesRoutes.post('/:id/set-default', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Check exists\n    const [existing] = await db\n      .select({ id: pdfTemplates.id })\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    // Unset all defaults\n    await db\n      .update(pdfTemplates)\n      .set({ isDefault: false, updatedAt: new Date() })\n      .where(eq(pdfTemplates.isDefault, true));\n\n    // Set this as default\n    const [template] = await db\n      .update(pdfTemplates)\n      .set({ isDefault: true, updatedAt: new Date() })\n      .where(eq(pdfTemplates.id, id))\n      .returning();\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { getDb, quotations, settings, newsletterCampaigns, newsletterSends, newsletterSubscribers, eq, and, lte, gte, sql, asc } from '@lab404/database';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { notificationService } from '../services/notification.service';\nimport { quotationActivityService } from '../services/quotation-activity.service';\nimport { verificationCodeService } from '../services';\nimport { mailerService } from '../services/mailer.service';\nimport { logger } from '../utils/logger';\nimport { cronLimiter } from '../middleware/rateLimiter';\nimport juice from 'juice';\n\nexport const cronRoutes = Router();\n\n// Apply rate limiting to all cron routes\ncronRoutes.use(cronLimiter);\n\n// Middleware to verify cron secret (for security)\n// Supports: x-cron-secret header, query param, and Vercel Cron Authorization header\nconst verifyCronSecret = (req: Request, res: Response, next: NextFunction) => {\n  const expectedSecret = process.env['CRON_SECRET'];\n\n  // CRON_SECRET is required in all environments (no dev bypass for security)\n  if (!expectedSecret) {\n    logger.error('CRON_SECRET not configured');\n    return sendError(res, 503, 'CRON_NOT_CONFIGURED', 'Cron jobs not configured');\n  }\n\n  // Check various auth methods:\n  // 1. Custom x-cron-secret header\n  // 2. Query parameter ?secret=xxx\n  // 3. Vercel Cron sends Authorization: Bearer <CRON_SECRET>\n  const cronSecret = req.headers['x-cron-secret'] || req.query['secret'];\n  const authHeader = req.headers['authorization'];\n  const vercelCronSecret = authHeader?.startsWith('Bearer ') ? authHeader.slice(7) : null;\n\n  if (cronSecret !== expectedSecret && vercelCronSecret !== expectedSecret) {\n    logger.warn('Invalid cron secret attempt', { ip: req.ip });\n    return sendError(res, 403, 'FORBIDDEN', 'Forbidden');\n  }\n\n  next();\n};\n\ninterface ExpiryNotificationResult {\n  quotationId: string;\n  quotationNumber: string;\n  customerEmail: string;\n  daysUntilExpiry: number;\n  status: 'sent' | 'failed';\n  error?: string;\n}\n\n/**\n * POST /api/cron/quotation-expiry-check\n * Check for quotations expiring soon and send notifications\n *\n * Should be called daily by a cron job (e.g., Vercel cron, GitHub Actions, or external service)\n */\ncronRoutes.post('/quotation-expiry-check', verifyCronSecret, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const results: ExpiryNotificationResult[] = [];\n\n    // Define expiry windows (days from now)\n    const expiryWindows = [1, 3, 7];\n\n    for (const days of expiryWindows) {\n      // Calculate the target date range\n      const targetDateStart = new Date(now);\n      targetDateStart.setDate(targetDateStart.getDate() + days);\n      targetDateStart.setHours(0, 0, 0, 0);\n\n      const targetDateEnd = new Date(targetDateStart);\n      targetDateEnd.setHours(23, 59, 59, 999);\n\n      // Find quotations expiring on this day\n      // Only check 'sent' status quotations (not draft, accepted, etc.)\n      const expiringQuotations = await db\n        .select()\n        .from(quotations)\n        .where(\n          and(\n            eq(quotations.status, 'sent'),\n            gte(quotations.validUntil, targetDateStart),\n            lte(quotations.validUntil, targetDateEnd)\n          )\n        );\n\n      logger.info(`Found ${expiringQuotations.length} quotations expiring in ${days} day(s)`);\n\n      for (const quotation of expiringQuotations) {\n        try {\n          // Send expiry notification email\n          await notificationService.sendQuotationExpiryReminder(\n            quotation.customerEmail,\n            quotation.customerName,\n            quotation.quotationNumber,\n            days,\n            quotation.validUntil!,\n            quotation.acceptanceToken || undefined\n          );\n\n          // Log activity\n          await quotationActivityService.logActivity({\n            quotationId: quotation.id,\n            activityType: 'note_added',\n            description: `Expiry reminder sent (${days} day${days === 1 ? '' : 's'} remaining)`,\n            actorType: 'system',\n          }).catch(() => {}); // Non-blocking\n\n          results.push({\n            quotationId: quotation.id,\n            quotationNumber: quotation.quotationNumber,\n            customerEmail: quotation.customerEmail,\n            daysUntilExpiry: days,\n            status: 'sent',\n          });\n        } catch (error) {\n          logger.error(`Failed to send expiry notification for ${quotation.quotationNumber}:`, error);\n          results.push({\n            quotationId: quotation.id,\n            quotationNumber: quotation.quotationNumber,\n            customerEmail: quotation.customerEmail,\n            daysUntilExpiry: days,\n            status: 'failed',\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n        }\n      }\n    }\n\n    // Auto-expire quotations past their valid date\n    const expiredResult = await db\n      .update(quotations)\n      .set({\n        status: 'expired',\n        updatedAt: now,\n      })\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      )\n      .returning({ id: quotations.id, quotationNumber: quotations.quotationNumber });\n\n    // Log expiry activities\n    for (const expired of expiredResult) {\n      await quotationActivityService.logExpired(expired.id).catch(() => {}); // Non-blocking\n    }\n\n    const summary = {\n      processedAt: now.toISOString(),\n      notificationsSent: results.filter(r => r.status === 'sent').length,\n      notificationsFailed: results.filter(r => r.status === 'failed').length,\n      autoExpired: expiredResult.length,\n      details: results,\n      expiredQuotations: expiredResult.map(q => q.quotationNumber),\n    };\n\n    logger.info('Quotation expiry check completed:', summary);\n    sendSuccess(res, summary);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cron/cleanup-verification-codes\n * Remove expired and used verification codes older than 24 hours\n *\n * Should be called every 6 hours by a cron job (Vercel cron, GitHub Actions, or external service)\n */\ncronRoutes.post('/cleanup-verification-codes', verifyCronSecret, async (req, res, next) => {\n  try {\n    const startTime = Date.now();\n\n    const deletedCount = await verificationCodeService.cleanupExpiredCodes();\n\n    const duration = Date.now() - startTime;\n\n    logger.info('Verification codes cleanup cron completed', {\n      deletedCount,\n      durationMs: duration\n    });\n\n    sendSuccess(res, {\n      message: 'Verification codes cleanup completed',\n      deletedCount,\n      durationMs: duration,\n      processedAt: new Date().toISOString(),\n    });\n  } catch (error) {\n    logger.error('Verification codes cleanup cron failed', { error });\n    next(error);\n  }\n});\n\n/**\n * GET /api/cron/health\n * Health check for cron jobs\n */\ncronRoutes.get('/health', (req, res) => {\n  sendSuccess(res, { status: 'ok', timestamp: new Date().toISOString() });\n});\n\n/**\n * POST /api/cron/newsletter-send\n * Process newsletter sending queue\n *\n * Should be called every hour by a cron job.\n * Sends emails up to the daily limit for each active campaign.\n */\ncronRoutes.post('/newsletter-send', verifyCronSecret, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const startOfDay = new Date(now);\n    startOfDay.setHours(0, 0, 0, 0);\n\n    const results: {\n      campaignId: string;\n      campaignName: string;\n      emailsSent: number;\n      emailsFailed: number;\n      completed: boolean;\n    }[] = [];\n\n    // Get all active (sending) campaigns\n    const activeCampaigns = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.status, 'sending'));\n\n    logger.info(`Processing ${activeCampaigns.length} active newsletter campaigns`);\n\n    for (const campaign of activeCampaigns) {\n      // Count emails sent today for this campaign\n      const [todayStats] = await db\n        .select({\n          sentToday: sql<number>`count(*) filter (where ${newsletterSends.sentAt} >= ${startOfDay})`,\n        })\n        .from(newsletterSends)\n        .where(eq(newsletterSends.campaignId, campaign.id));\n\n      const sentToday = Number(todayStats?.sentToday || 0);\n      const remainingToday = Math.max(0, campaign.dailyLimit - sentToday);\n\n      if (remainingToday === 0) {\n        logger.info(`Campaign ${campaign.name}: Daily limit reached (${campaign.dailyLimit})`);\n        continue;\n      }\n\n      // Get pending sends for this campaign (up to remaining daily limit)\n      const pendingSends = await db\n        .select({\n          id: newsletterSends.id,\n          email: newsletterSends.email,\n          subscriberId: newsletterSends.subscriberId,\n        })\n        .from(newsletterSends)\n        .where(\n          and(\n            eq(newsletterSends.campaignId, campaign.id),\n            eq(newsletterSends.status, 'pending')\n          )\n        )\n        .orderBy(asc(newsletterSends.createdAt))\n        .limit(remainingToday);\n\n      if (pendingSends.length === 0) {\n        // No more pending - mark campaign as completed\n        await db\n          .update(newsletterCampaigns)\n          .set({\n            status: 'completed',\n            completedAt: now,\n            updatedAt: now,\n          })\n          .where(eq(newsletterCampaigns.id, campaign.id));\n\n        results.push({\n          campaignId: campaign.id,\n          campaignName: campaign.name,\n          emailsSent: 0,\n          emailsFailed: 0,\n          completed: true,\n        });\n\n        logger.info(`Campaign ${campaign.name}: Completed (all emails sent)`);\n        continue;\n      }\n\n      let emailsSent = 0;\n      let emailsFailed = 0;\n\n      // Process each pending send\n      for (const send of pendingSends) {\n        try {\n          // Get subscriber for unsubscribe token\n          const [subscriber] = await db\n            .select({ unsubscribeToken: newsletterSubscribers.unsubscribeToken })\n            .from(newsletterSubscribers)\n            .where(eq(newsletterSubscribers.id, send.subscriberId));\n\n          // Build unsubscribe URL\n          const baseUrl = process.env['WEBSITE_URL'] || 'http://localhost:3000';\n          const unsubscribeUrl = `${baseUrl}/unsubscribe/${subscriber?.unsubscribeToken || ''}`;\n\n          // Add unsubscribe link to content\n          const contentWithUnsubscribe = campaign.content + `\n            <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #eee;\">\n            <p style=\"font-size: 12px; color: #666; text-align: center;\">\n              You received this email because you subscribed to our newsletter.\n              <br>\n              <a href=\"${unsubscribeUrl}\" style=\"color: #666;\">Unsubscribe</a>\n            </p>\n          `;\n\n          // Inline CSS for email client compatibility\n          const inlinedHtml = juice(contentWithUnsubscribe, {\n            removeStyleTags: true,\n            preserveMediaQueries: true,\n            preserveFontFaces: true,\n          });\n\n          // Send email\n          const success = await mailerService.sendEmail({\n            to: send.email,\n            subject: campaign.subject,\n            html: inlinedHtml,\n          });\n\n          if (success) {\n            await db\n              .update(newsletterSends)\n              .set({\n                status: 'sent',\n                sentAt: now,\n              })\n              .where(eq(newsletterSends.id, send.id));\n\n            emailsSent++;\n          } else {\n            await db\n              .update(newsletterSends)\n              .set({\n                status: 'failed',\n                errorMessage: 'Email service returned failure',\n                retryCount: sql`${newsletterSends.retryCount} + 1`,\n              })\n              .where(eq(newsletterSends.id, send.id));\n\n            emailsFailed++;\n          }\n        } catch (error) {\n          logger.error(`Failed to send newsletter to ${send.email}:`, error);\n\n          await db\n            .update(newsletterSends)\n            .set({\n              status: 'failed',\n              errorMessage: error instanceof Error ? error.message : 'Unknown error',\n              retryCount: sql`${newsletterSends.retryCount} + 1`,\n            })\n            .where(eq(newsletterSends.id, send.id));\n\n          emailsFailed++;\n        }\n      }\n\n      // Update campaign stats\n      await db\n        .update(newsletterCampaigns)\n        .set({\n          sentCount: sql`${newsletterCampaigns.sentCount} + ${emailsSent}`,\n          failedCount: sql`${newsletterCampaigns.failedCount} + ${emailsFailed}`,\n          lastSentAt: emailsSent > 0 ? now : campaign.lastSentAt,\n          updatedAt: now,\n        })\n        .where(eq(newsletterCampaigns.id, campaign.id));\n\n      results.push({\n        campaignId: campaign.id,\n        campaignName: campaign.name,\n        emailsSent,\n        emailsFailed,\n        completed: false,\n      });\n\n      logger.info(`Campaign ${campaign.name}: Sent ${emailsSent}, Failed ${emailsFailed}`);\n    }\n\n    const summary = {\n      processedAt: now.toISOString(),\n      campaignsProcessed: results.length,\n      totalEmailsSent: results.reduce((sum, r) => sum + r.emailsSent, 0),\n      totalEmailsFailed: results.reduce((sum, r) => sum + r.emailsFailed, 0),\n      campaignsCompleted: results.filter(r => r.completed).length,\n      details: results,\n    };\n\n    logger.info('Newsletter send cron completed:', summary);\n    sendSuccess(res, summary);\n  } catch (error) {\n    logger.error('Newsletter send cron failed:', error);\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { validateQuery, validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\nimport { auditLogService } from '../services/audit-log.service';\nimport { ipReputationService } from '../services/ip-reputation.service';\nimport { SecurityEventType, EventStatus, ActorType } from '../types/audit-events';\n\nexport const adminRoutes = Router();\n\n// Apply admin auth to all routes\nadminRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst auditLogFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  status: z.nativeEnum(EventStatus).optional(),\n  actorId: z.string().optional(),\n  ipAddress: z.string().optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst exportFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  status: z.nativeEnum(EventStatus).optional(),\n  actorId: z.string().optional(),\n  ipAddress: z.string().optional(),\n  format: z.enum(['csv', 'json']).optional().default('json'),\n});\n\nconst ipListFiltersSchema = z.object({\n  isBlocked: z.string().optional(),\n  minScore: z.string().optional(),\n  maxScore: z.string().optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst blockIPSchema = z.object({\n  reason: z.string().min(1, 'Block reason is required'),\n  duration: z.number().positive().optional(),\n});\n\n// ===========================================\n// Admin Audit Log Routes\n// ===========================================\n\n/**\n * GET /api/admin/audit-logs\n * List audit logs with pagination and filters\n */\nadminRoutes.get('/audit-logs', validateQuery(auditLogFiltersSchema), async (req, res, next) => {\n  try {\n    const {\n      startDate,\n      endDate,\n      eventType,\n      status,\n      actorId,\n      ipAddress,\n      limit,\n      offset,\n    } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof auditLogService.query>[0] = {\n      startDate: startDate ? new Date(startDate as string) : undefined,\n      endDate: endDate ? new Date(endDate as string) : undefined,\n      eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n      status: status as EventStatus | undefined,\n      actorId: actorId as string | undefined,\n      ipAddress: ipAddress as string | undefined,\n      limit: limit ? parseInt(limit as string, 10) : 50,\n      offset: offset ? parseInt(offset as string, 10) : 0,\n    };\n\n    const logs = await auditLogService.query(filters);\n\n    sendSuccess(res, logs);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/audit-logs/:id\n * Get a specific audit log by ID\n */\nadminRoutes.get('/audit-logs/:id', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n\n    const log = await auditLogService.getById(id);\n\n    if (!log) {\n      throw new NotFoundError('Audit log not found');\n    }\n\n    sendSuccess(res, log);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/audit-logs/export\n * Export audit logs to CSV or JSON\n */\nadminRoutes.get('/audit-logs/export', validateQuery(exportFiltersSchema), async (req, res, next) => {\n  try {\n    const {\n      startDate,\n      endDate,\n      eventType,\n      status,\n      actorId,\n      ipAddress,\n      format,\n    } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof auditLogService.query>[0] = {\n      startDate: startDate ? new Date(startDate as string) : undefined,\n      endDate: endDate ? new Date(endDate as string) : undefined,\n      eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n      status: status as EventStatus | undefined,\n      actorId: actorId as string | undefined,\n      ipAddress: ipAddress as string | undefined,\n    };\n\n    let exportData: string;\n    let contentType: string;\n    let filename: string;\n\n    if (format === 'csv') {\n      exportData = await auditLogService.exportToCSV(filters);\n      contentType = 'text/csv';\n      filename = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;\n    } else {\n      exportData = await auditLogService.exportToJSON(filters);\n      contentType = 'application/json';\n      filename = `audit-logs-${new Date().toISOString().split('T')[0]}.json`;\n    }\n\n    res.setHeader('Content-Type', contentType);\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    res.send(exportData);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Abuse Management Routes\n// ===========================================\n\n/**\n * GET /api/admin/abuse/ips\n * List IP reputations with pagination and filters\n */\nadminRoutes.get('/abuse/ips', validateQuery(ipListFiltersSchema), async (req, res, next) => {\n  try {\n    const { isBlocked, minScore, maxScore, limit, offset } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof ipReputationService.query>[0] = {\n      isBlocked: isBlocked ? isBlocked === 'true' : undefined,\n      minScore: minScore ? parseInt(minScore as string, 10) : undefined,\n      maxScore: maxScore ? parseInt(maxScore as string, 10) : undefined,\n      limit: limit ? parseInt(limit as string, 10) : 50,\n      offset: offset ? parseInt(offset as string, 10) : 0,\n    };\n\n    const ips = await ipReputationService.query(filters);\n\n    sendSuccess(res, ips);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/abuse/ips/:ip\n * Get specific IP reputation details\n */\nadminRoutes.get('/abuse/ips/:ip', async (req, res, next) => {\n  try {\n    const ip = req.params.ip as string;\n\n    const reputation = await ipReputationService.getReputation(ip);\n\n    if (!reputation) {\n      throw new NotFoundError('IP reputation not found');\n    }\n\n    sendSuccess(res, reputation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/admin/abuse/ips/:ip/block\n * Manually block an IP address\n */\nadminRoutes.post('/abuse/ips/:ip/block', validateBody(blockIPSchema), async (req, res, next) => {\n  try {\n    const ip = req.params['ip'] as string;\n    const { reason, duration } = req.body;\n\n    // Block the IP\n    await ipReputationService.blockIP(ip, reason, duration);\n\n    // Log the admin action\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.ADMIN_ACTION,\n      actorType: ActorType.ADMIN,\n      actorId: (req as any).user?.id,\n      actorEmail: (req as any).user?.email,\n      action: 'block_ip',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        targetIp: ip,\n        reason,\n        duration: duration || 'permanent',\n      },\n    });\n\n    sendSuccess(res, { message: 'IP blocked successfully', ip, reason, duration });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/admin/abuse/ips/:ip/unblock\n * Unblock an IP address\n */\nadminRoutes.delete('/abuse/ips/:ip/unblock', async (req, res, next) => {\n  try {\n    const ip = req.params['ip'] as string;\n\n    // Unblock the IP\n    await ipReputationService.unblockIP(ip);\n\n    // Log the admin action\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.ADMIN_ACTION,\n      actorType: ActorType.ADMIN,\n      actorId: (req as any).user?.id,\n      actorEmail: (req as any).user?.email,\n      action: 'unblock_ip',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        targetIp: ip,\n      },\n    });\n\n    sendSuccess(res, { message: 'IP unblocked successfully', ip });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/abuse/stats\n * Get abuse prevention statistics\n */\nadminRoutes.get('/abuse/stats', async (req, res, next) => {\n  try {\n    const stats = await ipReputationService.getStatistics();\n\n    sendSuccess(res, stats);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport crypto from 'crypto';\nimport juice from 'juice';\nimport {\n  getDb,\n  newsletterSubscribers,\n  newsletterCampaigns,\n  newsletterSends,\n  eq,\n  desc,\n  asc,\n  and,\n  sql,\n  inArray,\n} from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\nimport { mailerService } from '../services/mailer.service';\n\nexport const newsletterRoutes = Router();\n\n// Apply admin auth to all routes\nnewsletterRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst subscriberFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['active', 'unsubscribed', 'bounced']).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional(),\n  search: z.string().optional(),\n});\n\nconst addSubscriberSchema = z.object({\n  email: z.string().email(),\n  name: z.string().max(100).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional().default('admin'),\n});\n\nconst importSubscribersSchema = z.object({\n  subscribers: z.array(\n    z.object({\n      email: z.string().email(),\n      name: z.string().max(100).optional(),\n    })\n  ).min(1).max(10000),\n});\n\nconst campaignFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['draft', 'scheduled', 'sending', 'paused', 'completed', 'cancelled']).optional(),\n});\n\nconst createCampaignSchema = z.object({\n  name: z.string().min(1).max(255),\n  subject: z.string().min(1).max(255),\n  previewText: z.string().max(255).optional().or(z.literal('')),\n  content: z.string().min(1),\n  dailyLimit: z.coerce.number().int().min(1).max(10000).optional().default(100),\n  sendTime: z.string().regex(/^([01]\\d|2[0-3]):([0-5]\\d)$/).optional().or(z.literal('')), // HH:MM format or empty\n  scheduledAt: z.string().datetime().optional().or(z.literal('')),\n});\n\nconst updateCampaignSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  subject: z.string().min(1).max(255).optional(),\n  previewText: z.string().max(255).optional().or(z.literal('')),\n  content: z.string().min(1).optional(),\n  dailyLimit: z.coerce.number().int().min(1).max(10000).optional(),\n  sendTime: z.string().regex(/^([01]\\d|2[0-3]):([0-5]\\d)$/).optional().or(z.literal('')),\n  scheduledAt: z.string().datetime().optional().or(z.literal('')),\n});\n\n// ===========================================\n// Subscriber Routes\n// ===========================================\n\n/**\n * GET /api/newsletter/subscribers\n * List all subscribers with pagination and filters\n */\nnewsletterRoutes.get(\n  '/subscribers',\n  validateQuery(subscriberFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { status, source, search } = req.query;\n\n      const conditions = [];\n\n      if (status) {\n        conditions.push(eq(newsletterSubscribers.status, status as string));\n      }\n\n      if (source) {\n        conditions.push(eq(newsletterSubscribers.source, source as string));\n      }\n\n      if (search) {\n        conditions.push(\n          sql`(${newsletterSubscribers.email} ILIKE ${`%${search}%`} OR ${newsletterSubscribers.name} ILIKE ${`%${search}%`})`\n        );\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Get total count\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterSubscribers)\n        .where(whereClause);\n      const total = Number(countResult[0]?.count ?? 0);\n\n      // Get subscribers\n      const subscribers = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(whereClause)\n        .orderBy(desc(newsletterSubscribers.subscribedAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, subscribers, 200, createPaginationMeta(page, limit, total));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/newsletter/subscribers/stats\n * Get subscriber statistics\n */\nnewsletterRoutes.get('/subscribers/stats', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    const statsResult = await db\n      .select({\n        total: sql<number>`count(*)`,\n        active: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'active')`,\n        unsubscribed: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'unsubscribed')`,\n        bounced: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'bounced')`,\n        thisMonth: sql<number>`count(*) filter (where ${newsletterSubscribers.subscribedAt} >= date_trunc('month', current_date))`,\n        thisWeek: sql<number>`count(*) filter (where ${newsletterSubscribers.subscribedAt} >= date_trunc('week', current_date))`,\n      })\n      .from(newsletterSubscribers);\n\n    const stats = statsResult[0];\n\n    // Get by source\n    const bySource = await db\n      .select({\n        source: newsletterSubscribers.source,\n        count: sql<number>`count(*)`,\n      })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'))\n      .groupBy(newsletterSubscribers.source);\n\n    sendSuccess(res, {\n      total: Number(stats?.total ?? 0),\n      active: Number(stats?.active ?? 0),\n      unsubscribed: Number(stats?.unsubscribed ?? 0),\n      bounced: Number(stats?.bounced ?? 0),\n      thisMonth: Number(stats?.thisMonth ?? 0),\n      thisWeek: Number(stats?.thisWeek ?? 0),\n      bySource: bySource.reduce((acc, item) => {\n        acc[item.source] = Number(item.count);\n        return acc;\n      }, {} as Record<string, number>),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/newsletter/subscribers/export\n * Export subscribers as CSV\n */\nnewsletterRoutes.get('/subscribers/export', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { status } = req.query;\n\n    const conditions = [];\n    if (status) {\n      conditions.push(eq(newsletterSubscribers.status, status as string));\n    }\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const subscribers = await db\n      .select({\n        email: newsletterSubscribers.email,\n        name: newsletterSubscribers.name,\n        status: newsletterSubscribers.status,\n        source: newsletterSubscribers.source,\n        subscribedAt: newsletterSubscribers.subscribedAt,\n        unsubscribedAt: newsletterSubscribers.unsubscribedAt,\n      })\n      .from(newsletterSubscribers)\n      .where(whereClause)\n      .orderBy(desc(newsletterSubscribers.subscribedAt));\n\n    // Generate CSV\n    const headers = ['Email', 'Name', 'Status', 'Source', 'Subscribed At', 'Unsubscribed At'];\n    const rows = subscribers.map((s) => [\n      s.email,\n      s.name || '',\n      s.status,\n      s.source,\n      s.subscribedAt.toISOString(),\n      s.unsubscribedAt?.toISOString() || '',\n    ]);\n\n    const csv = [\n      headers.join(','),\n      ...rows.map((row) => row.map((cell) => `\"${cell.replace(/\"/g, '\"\"')}\"`).join(',')),\n    ].join('\\n');\n\n    res.setHeader('Content-Type', 'text/csv');\n    res.setHeader('Content-Disposition', `attachment; filename=\"subscribers-${new Date().toISOString().split('T')[0]}.csv\"`);\n    res.send(csv);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/subscribers\n * Add a new subscriber (admin)\n */\nnewsletterRoutes.post(\n  '/subscribers',\n  validateBody(addSubscriberSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { email, name, source } = req.body;\n\n      // Check if already exists\n      const [existing] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.email, email.toLowerCase()));\n\n      if (existing) {\n        throw new BadRequestError('Email already subscribed');\n      }\n\n      const unsubscribeToken = crypto.randomBytes(32).toString('hex');\n\n      const [subscriber] = await db\n        .insert(newsletterSubscribers)\n        .values({\n          email: email.toLowerCase(),\n          name,\n          source,\n          unsubscribeToken,\n          status: 'active',\n        })\n        .returning();\n\n      sendSuccess(res, subscriber, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/newsletter/subscribers/import\n * Bulk import subscribers\n */\nnewsletterRoutes.post(\n  '/subscribers/import',\n  validateBody(importSubscribersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { subscribers: inputSubscribers } = req.body;\n\n      const results = {\n        imported: 0,\n        skipped: 0,\n        errors: [] as string[],\n      };\n\n      // Get existing emails\n      const existingEmails = new Set(\n        (await db.select({ email: newsletterSubscribers.email }).from(newsletterSubscribers))\n          .map((s) => s.email.toLowerCase())\n      );\n\n      // Filter out existing\n      const newSubscribers = inputSubscribers.filter((s: { email: string }) => {\n        if (existingEmails.has(s.email.toLowerCase())) {\n          results.skipped++;\n          return false;\n        }\n        return true;\n      });\n\n      // Insert in batches\n      const batchSize = 100;\n      for (let i = 0; i < newSubscribers.length; i += batchSize) {\n        const batch = newSubscribers.slice(i, i + batchSize);\n        const values = batch.map((s: { email: string; name?: string }) => ({\n          email: s.email.toLowerCase(),\n          name: s.name || null,\n          source: 'import' as const,\n          unsubscribeToken: crypto.randomBytes(32).toString('hex'),\n          status: 'active' as const,\n        }));\n\n        await db.insert(newsletterSubscribers).values(values);\n        results.imported += batch.length;\n      }\n\n      sendSuccess(res, {\n        message: `Import completed: ${results.imported} imported, ${results.skipped} skipped`,\n        ...results,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/newsletter/subscribers/:id\n * Remove a subscriber\n */\nnewsletterRoutes.delete('/subscribers/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [deleted] = await db\n      .delete(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.id, id))\n      .returning();\n\n    if (!deleted) {\n      throw new NotFoundError('Subscriber not found');\n    }\n\n    sendSuccess(res, { message: 'Subscriber removed successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/newsletter/subscribers/bulk\n * Bulk delete subscribers\n */\nnewsletterRoutes.post(\n  '/subscribers/bulk-delete',\n  validateBody(z.object({ ids: z.array(z.string().uuid()).min(1) })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { ids } = req.body;\n\n      const deleted = await db\n        .delete(newsletterSubscribers)\n        .where(inArray(newsletterSubscribers.id, ids))\n        .returning();\n\n      sendSuccess(res, { message: `${deleted.length} subscribers removed` });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Campaign Routes\n// ===========================================\n\n/**\n * GET /api/newsletter/campaigns\n * List all campaigns\n */\nnewsletterRoutes.get(\n  '/campaigns',\n  validateQuery(campaignFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { status } = req.query;\n\n      const conditions = [];\n      if (status) {\n        conditions.push(eq(newsletterCampaigns.status, status as string));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Get total count\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterCampaigns)\n        .where(whereClause);\n      const total = Number(countResult[0]?.count ?? 0);\n\n      // Get campaigns\n      const campaigns = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(whereClause)\n        .orderBy(desc(newsletterCampaigns.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, campaigns, 200, createPaginationMeta(page, limit, total));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/newsletter/campaigns/:id\n * Get a specific campaign\n */\nnewsletterRoutes.get('/campaigns/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    sendSuccess(res, campaign);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns\n * Create a new campaign\n */\nnewsletterRoutes.post(\n  '/campaigns',\n  validateBody(createCampaignSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { name, subject, previewText, content, dailyLimit, sendTime, scheduledAt } = req.body;\n\n      // Get total active subscribers\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.status, 'active'));\n      const subscriberCount = Number(countResult[0]?.count ?? 0);\n\n      // Only set createdBy if user ID is a valid UUID\n      const userId = (req as any).user?.id;\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n      const createdBy = userId && uuidRegex.test(userId) ? userId : null;\n\n      const [campaign] = await db\n        .insert(newsletterCampaigns)\n        .values({\n          name,\n          subject,\n          previewText: previewText || null,\n          content, // Raw HTML preserved - admin-only content\n          dailyLimit,\n          sendTime: sendTime || null,\n          scheduledAt: scheduledAt ? new Date(scheduledAt) : null,\n          totalRecipients: subscriberCount,\n          status: scheduledAt ? 'scheduled' : 'draft',\n          createdBy,\n        })\n        .returning();\n\n      sendSuccess(res, campaign, 201);\n    } catch (error) {\n      console.error('Campaign creation error:', error);\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/newsletter/campaigns/:id\n * Update a campaign (only draft/paused campaigns)\n */\nnewsletterRoutes.put(\n  '/campaigns/:id',\n  validateBody(updateCampaignSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const updates = req.body as Record<string, unknown>;\n\n      const [existing] = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(eq(newsletterCampaigns.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Campaign not found');\n      }\n\n      if (!['draft', 'paused', 'scheduled'].includes(existing.status)) {\n        throw new BadRequestError('Can only edit draft, scheduled, or paused campaigns');\n      }\n\n      // If updating scheduledAt, also update status\n      const additionalUpdates: Record<string, unknown> = {};\n      if (updates['scheduledAt']) {\n        additionalUpdates['scheduledAt'] = new Date(updates['scheduledAt'] as string);\n        if (existing.status === 'draft') {\n          additionalUpdates['status'] = 'scheduled';\n        }\n      }\n\n      // If content changed, recalculate recipient count\n      if (updates['content']) {\n        // Raw HTML preserved - admin-only content\n        const countResult = await db\n          .select({ count: sql<number>`count(*)` })\n          .from(newsletterSubscribers)\n          .where(eq(newsletterSubscribers.status, 'active'));\n        additionalUpdates['totalRecipients'] = Number(countResult[0]?.count ?? 0);\n      }\n\n      const [campaign] = await db\n        .update(newsletterCampaigns)\n        .set({\n          ...updates,\n          ...additionalUpdates,\n          updatedAt: new Date(),\n        })\n        .where(eq(newsletterCampaigns.id, id))\n        .returning();\n\n      sendSuccess(res, campaign);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/newsletter/campaigns/:id\n * Delete a campaign (only draft campaigns)\n */\nnewsletterRoutes.delete('/campaigns/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (existing.status !== 'draft') {\n      throw new BadRequestError('Can only delete draft campaigns');\n    }\n\n    await db.delete(newsletterCampaigns).where(eq(newsletterCampaigns.id, id));\n\n    sendSuccess(res, { message: 'Campaign deleted successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/start\n * Start sending a campaign\n */\nnewsletterRoutes.post('/campaigns/:id/start', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (!['draft', 'scheduled', 'paused'].includes(campaign.status)) {\n      throw new BadRequestError('Campaign cannot be started in its current state');\n    }\n\n    // Get active subscribers count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'));\n\n    const totalRecipients = Number(countResult[0]?.count ?? 0);\n\n    if (totalRecipients === 0) {\n      throw new BadRequestError('No active subscribers to send to');\n    }\n\n    // Create send records for all active subscribers who haven't received this campaign\n    const activeSubscribers = await db\n      .select({ id: newsletterSubscribers.id, email: newsletterSubscribers.email })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'));\n\n    // Check for existing sends\n    const existingSends = await db\n      .select({ subscriberId: newsletterSends.subscriberId })\n      .from(newsletterSends)\n      .where(eq(newsletterSends.campaignId, id));\n\n    const existingSubscriberIds = new Set(existingSends.map((s) => s.subscriberId));\n\n    // Filter out subscribers who already have sends\n    const newSubscribers = activeSubscribers.filter((s) => !existingSubscriberIds.has(s.id));\n\n    if (newSubscribers.length > 0) {\n      // Insert in batches\n      const batchSize = 500;\n      for (let i = 0; i < newSubscribers.length; i += batchSize) {\n        const batch = newSubscribers.slice(i, i + batchSize);\n        await db.insert(newsletterSends).values(\n          batch.map((s) => ({\n            campaignId: id,\n            subscriberId: s.id,\n            email: s.email,\n            status: 'pending' as const,\n          }))\n        );\n      }\n    }\n\n    // Update campaign status\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'sending',\n        totalRecipients,\n        startedAt: campaign.startedAt || new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, {\n      message: 'Campaign started',\n      campaign: updated,\n      pendingSends: newSubscribers.length,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/pause\n * Pause a sending campaign\n */\nnewsletterRoutes.post('/campaigns/:id/pause', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (campaign.status !== 'sending') {\n      throw new BadRequestError('Can only pause campaigns that are sending');\n    }\n\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'paused',\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, { message: 'Campaign paused', campaign: updated });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/cancel\n * Cancel a campaign\n */\nnewsletterRoutes.post('/campaigns/:id/cancel', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (['completed', 'cancelled'].includes(campaign.status)) {\n      throw new BadRequestError('Campaign cannot be cancelled in its current state');\n    }\n\n    // Delete pending sends\n    await db\n      .delete(newsletterSends)\n      .where(\n        and(\n          eq(newsletterSends.campaignId, id),\n          eq(newsletterSends.status, 'pending')\n        )\n      );\n\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'cancelled',\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, { message: 'Campaign cancelled', campaign: updated });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/newsletter/campaigns/:id/sends\n * Get send details for a campaign\n */\nnewsletterRoutes.get('/campaigns/:id/sends', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const { status } = req.query;\n\n    const conditions = [eq(newsletterSends.campaignId, id)];\n    if (status) {\n      conditions.push(eq(newsletterSends.status, status as string));\n    }\n\n    const whereClause = and(...conditions);\n\n    // Get total count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(newsletterSends)\n      .where(whereClause);\n    const total = Number(countResult[0]?.count ?? 0);\n\n    // Get sends\n    const sends = await db\n      .select()\n      .from(newsletterSends)\n      .where(whereClause)\n      .orderBy(asc(newsletterSends.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, sends, 200, createPaginationMeta(page, limit, total));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/test\n * Send a test email for a campaign\n */\nnewsletterRoutes.post(\n  '/campaigns/:id/test',\n  validateBody(z.object({ email: z.string().email() })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const { email } = req.body;\n\n      const [campaign] = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(eq(newsletterCampaigns.id, id));\n\n      if (!campaign) {\n        throw new NotFoundError('Campaign not found');\n      }\n\n      // Build test email with unsubscribe footer\n      const websiteUrl = process.env['WEBSITE_URL'] || 'https://lab404.com';\n      const unsubscribeUrl = `${websiteUrl}/newsletter/unsubscribe?token=test-preview`;\n      const unsubscribeFooter = `\n        <hr style=\"margin-top: 40px; border: none; border-top: 1px solid #eee;\">\n        <p style=\"font-size: 12px; color: #666; text-align: center;\">\n          This is a test email preview.<br>\n          <a href=\"${unsubscribeUrl}\">Unsubscribe</a>\n        </p>\n      `;\n      const contentWithFooter = campaign.content + unsubscribeFooter;\n\n      // Inline CSS for email client compatibility\n      // This converts <style> tags to inline styles\n      const inlinedHtml = juice(contentWithFooter, {\n        removeStyleTags: true,\n        preserveMediaQueries: true,\n        preserveFontFaces: true,\n      });\n\n      // Send actual test email\n      const success = await mailerService.sendEmail({\n        to: email,\n        subject: `[TEST] ${campaign.subject}`,\n        html: inlinedHtml,\n      });\n\n      if (!success) {\n        throw new BadRequestError('Failed to send test email. Check SMTP configuration.');\n      }\n\n      sendSuccess(res, {\n        message: `Test email sent to ${email}`,\n        campaign: {\n          id: campaign.id,\n          subject: campaign.subject,\n        },\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAA,IAAAA,mBAAoB;AACpB,kBAAiB;AACjB,oBAAmB;AACnB,oBAAmB;AACnB,yBAAwB;AACxB,2BAAyB;;;ACLzB,oBAAmB;AACnB,kBAAiB;AAGjB,cAAAC,QAAO,OAAO,EAAE,MAAM,YAAAC,QAAK,QAAQ,WAAW,kBAAkB,EAAE,CAAC;AAE5D,IAAM,SAAS;AAAA;AAAA,EAEpB,KAAK,QAAQ,IAAI,UAAU,KAAK;AAAA,EAChC,OAAO,QAAQ,IAAI,UAAU,MAAM;AAAA,EACnC,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA;AAAA,EAGpC,MAAM,SAAS,QAAQ,IAAI,UAAU,KAAK,QAAQ,EAAE;AAAA,EACpD,QAAQ,QAAQ,IAAI,SAAS,KAAK;AAAA;AAAA,EAGlC,aAAa,QAAQ,IAAI,cAAc,KAAK;AAAA;AAAA,EAG5C,WAAW,QAAQ,IAAI,YAAY;AAAA,EACnC,cAAc,QAAQ,IAAI,gBAAgB,KAAK;AAAA;AAAA,EAG/C,cAAc,QAAQ,IAAI,cAAc,KAAK,+CAC1C,MAAM,GAAG,EACT,IAAI,YAAU,OAAO,KAAK,CAAC,EAC3B,OAAO,YAAU,OAAO,SAAS,CAAC;AAAA;AAAA,EAGrC,UAAU;AAAA,IACR,WAAW,QAAQ,IAAI,qBAAqB,KAAK;AAAA,IACjD,YAAY,QAAQ,IAAI,sBAAsB,KAAK;AAAA,IACnD,aAAa,QAAQ,IAAI,uBAAuB,KAAK;AAAA,EACvD;AAAA;AAAA,EAGA,MAAM;AAAA,IACJ,MAAM,QAAQ,IAAI,WAAW,KAAK;AAAA,IAClC,MAAM,SAAS,QAAQ,IAAI,WAAW,KAAK,OAAO,EAAE;AAAA,IACpD,QAAQ,QAAQ,IAAI,aAAa,MAAM;AAAA,IACvC,MAAM,QAAQ,IAAI,WAAW,KAAK;AAAA,IAClC,MAAM,QAAQ,IAAI,WAAW,KAAK;AAAA,IAClC,MAAM,QAAQ,IAAI,YAAY,KAAK;AAAA,EACrC;AAAA;AAAA,EAGA,QAAQ;AAAA,IACN,WAAW,QAAQ,IAAI,mBAAmB,KAAK;AAAA,IAC/C,eAAe,QAAQ,IAAI,uBAAuB,KAAK;AAAA,EACzD;AAAA;AAAA,EAGA,QAAQ;AAAA,IACN,QAAQ,QAAQ,IAAI,gBAAgB,KAAK;AAAA,IACzC,gBAAgB,QAAQ,IAAI,yBAAyB,KAAK;AAAA,EAC5D;AAAA;AAAA,EAGA,OAAO;AAAA,IACL,MAAM,QAAQ,IAAI,YAAY,KAAK;AAAA,IACnC,UAAU,QAAQ,IAAI,gBAAgB,KAAK;AAAA,EAC7C;AAAA;AAAA,EAGA,MAAM;AAAA,IACJ,OAAO,QAAQ,IAAI,WAAW,KAAK;AAAA,IACnC,KAAK,QAAQ,IAAI,SAAS,KAAK;AAAA,EACjC;AACF;;;ACpEA,iBAAyB;;;ACGlB,IAAM,WAAN,cAAuB,MAAM;AAAA,EAClB;AAAA,EACA;AAAA,EACA;AAAA,EAEhB,YACE,YACA,MACA,SACA,SACA;AACA,UAAM,OAAO;AACb,SAAK,aAAa;AAClB,SAAK,OAAO;AACZ,SAAK,UAAU;AACf,SAAK,OAAO;AAGZ,UAAM,kBAAkB,MAAM,KAAK,WAAW;AAAA,EAChD;AACF;AAKO,IAAM,kBAAN,cAA8B,SAAS;AAAA,EAC5C,YAAY,UAAU,eAAe,SAAqD;AACxF,UAAM,KAAK,eAAe,SAAS,OAAO;AAC1C,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,oBAAN,cAAgC,SAAS;AAAA,EAC9C,YAAY,UAAU,gBAAgB;AACpC,UAAM,KAAK,gBAAgB,OAAO;AAClC,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,iBAAN,cAA6B,SAAS;AAAA,EAC3C,YAAY,UAAU,aAAa;AACjC,UAAM,KAAK,aAAa,OAAO;AAC/B,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,gBAAN,cAA4B,SAAS;AAAA,EAC1C,YAAY,UAAU,sBAAsB;AAC1C,UAAM,KAAK,aAAa,OAAO;AAC/B,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,gBAAN,cAA4B,SAAS;AAAA,EAC1C,YAAY,UAAU,2BAA2B;AAC/C,UAAM,KAAK,YAAY,OAAO;AAC9B,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,kBAAN,cAA8B,SAAS;AAAA,EAC5C,YAAY,UAAU,qBAAqB,SAAqD;AAC9F,UAAM,KAAK,oBAAoB,SAAS,OAAO;AAC/C,SAAK,OAAO;AAAA,EACd;AACF;AAKO,IAAM,uBAAN,cAAmC,SAAS;AAAA,EACjD,YAAY,UAAU,qBAAqB;AACzC,UAAM,KAAK,qBAAqB,OAAO;AACvC,SAAK,OAAO;AAAA,EACd;AACF;;;ACxFO,SAAS,YACd,KACA,MACA,aAAa,KACb,MACU;AACV,QAAM,WAA2B;AAAA,IAC/B,SAAS;AAAA,IACT;AAAA,IACA,GAAI,QAAQ,EAAE,KAAK;AAAA,EACrB;AAEA,SAAO,IAAI,OAAO,UAAU,EAAE,KAAK,QAAQ;AAC7C;AAKO,SAAS,YAAe,KAAe,MAAmB;AAC/D,SAAO,YAAY,KAAK,MAAM,GAAG;AACnC;AAKO,SAAS,cAAc,KAAyB;AACrD,SAAO,IAAI,OAAO,GAAG,EAAE,KAAK;AAC9B;AAKO,SAAS,UACd,KACA,YACA,MACA,SACA,SACU;AACV,QAAM,WAA+B;AAAA,IACnC,SAAS;AAAA,IACT,OAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,GAAI,WAAW,EAAE,QAAQ;AAAA,IAC3B;AAAA,EACF;AAEA,SAAO,IAAI,OAAO,UAAU,EAAE,KAAK,QAAQ;AAC7C;AAKO,SAAS,qBACd,MACA,OACA,OACgB;AAChB,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA,YAAY,KAAK,KAAK,QAAQ,KAAK;AAAA,EACrC;AACF;AAMO,SAAS,sBAAsB,OAGc;AAElD,MAAI,aAAa,SAAS,MAAM,QAAQ,KAAK,EAAE;AAC/C,MAAI,cAAc,SAAS,MAAM,SAAS,MAAM,EAAE;AAGlD,MAAI,CAAC,OAAO,SAAS,UAAU,KAAK,aAAa,GAAG;AAClD,iBAAa;AAAA,EACf;AACA,MAAI,CAAC,OAAO,SAAS,WAAW,KAAK,cAAc,GAAG;AACpD,kBAAc;AAAA,EAChB;AAGA,QAAM,WAAW;AACjB,QAAM,YAAY;AAElB,QAAM,OAAO,KAAK,IAAI,UAAU,KAAK,IAAI,GAAG,UAAU,CAAC;AACvD,QAAM,QAAQ,KAAK,IAAI,WAAW,KAAK,IAAI,GAAG,WAAW,CAAC;AAC1D,QAAM,UAAU,OAAO,KAAK;AAE5B,SAAO,EAAE,MAAM,OAAO,OAAO;AAC/B;;;AC1FA,IAAM,SAAN,MAAa;AAAA,EACH,cAAc,OAAiB,SAAiB,SAA8B;AACpF,UAAMC,cAAY,oBAAI,KAAK,GAAE,YAAY;AACzC,UAAM,aAAa,UAAU,IAAI,KAAK,UAAU,OAAO,CAAC,KAAK;AAC7D,WAAO,IAAIA,UAAS,MAAM,MAAM,YAAY,CAAC,KAAK,OAAO,GAAG,UAAU;AAAA,EACxE;AAAA,EAEA,MAAM,SAAiB,SAA4B;AACjD,QAAI,OAAO,OAAO;AAChB,cAAQ,MAAM,KAAK,cAAc,SAAS,SAAS,OAAO,CAAC;AAAA,IAC7D;AAAA,EACF;AAAA,EAEA,KAAK,SAAiB,SAA4B;AAChD,YAAQ,KAAK,KAAK,cAAc,QAAQ,SAAS,OAAO,CAAC;AAAA,EAC3D;AAAA,EAEA,KAAK,SAAiB,SAA4B;AAChD,YAAQ,KAAK,KAAK,cAAc,QAAQ,SAAS,OAAO,CAAC;AAAA,EAC3D;AAAA,EAEA,MAAM,SAAiB,OAAyB,SAA4B;AAC1E,UAAM,eAA2B,EAAE,GAAG,QAAQ;AAE9C,QAAI,iBAAiB,OAAO;AAC1B,mBAAa,WAAW,IAAI,MAAM;AAClC,mBAAa,cAAc,IAAI,MAAM;AAGrC,UAAI,OAAO,OAAO;AAChB,qBAAa,OAAO,IAAI,MAAM;AAAA,MAChC;AAAA,IACF,WAAW,OAAO;AAChB,mBAAa,OAAO,IAAI;AAAA,IAC1B;AAEA,YAAQ,MAAM,KAAK,cAAc,SAAS,SAAS,YAAY,CAAC;AAAA,EAClE;AAAA;AAAA;AAAA;AAAA,EAKA,KAAK,SAAuB;AAC1B,YAAQ,IAAI,KAAI,oBAAI,KAAK,GAAE,YAAY,CAAC,YAAY,OAAO,EAAE;AAAA,EAC/D;AACF;AAEO,IAAM,SAAS,IAAI,OAAO;;;AHhD1B,SAAS,aACd,KACA,KACA,KACA,OACU;AAEV,SAAO,MAAM,iBAAiB,KAAK;AAAA,IACjC,QAAQ,IAAI;AAAA,IACZ,MAAM,IAAI;AAAA,IACV,IAAI,IAAI;AAAA,EACV,CAAC;AAGD,MAAI,eAAe,UAAU;AAC3B,WAAO,UAAU,KAAK,IAAI,YAAY,IAAI,MAAM,IAAI,SAAS,IAAI,OAAO;AAAA,EAC1E;AAGA,MAAI,eAAe,qBAAU;AAC3B,UAAM,UAAU,IAAI,OAAO,IAAI,CAAC,OAAO;AAAA,MACrC,OAAO,EAAE,KAAK,KAAK,GAAG;AAAA,MACtB,SAAS,EAAE;AAAA,IACb,EAAE;AAEF,WAAO,UAAU,KAAK,KAAK,oBAAoB,qBAAqB,OAAO;AAAA,EAC7E;AAGA,QAAM,UAAU,OAAO,QAAQ,IAAI,UAAU;AAE7C,SAAO,UAAU,KAAK,KAAK,yBAAyB,OAAO;AAC7D;AAKO,SAAS,gBAAgB,KAAc,KAAyB;AACrE,SAAO,UAAU,KAAK,KAAK,aAAa,SAAS,IAAI,MAAM,IAAI,IAAI,IAAI,YAAY;AACrF;;;AIjDA,0BAAgB;AAChB,IAAAC,eAAyC;;;ACFzC,IAAAC,qBAAqB;;;ACCrB,wBAA4B;;;ACDrB,IAAM,aAAa,uBAAO,IAAI,oBAAoB;AAWlD,SAAS,GAAsC,OAAY,MAAmC;AACpG,MAAI,CAAC,SAAS,OAAO,UAAU,UAAU;AACxC,WAAO;EACR;AAEA,MAAI,iBAAiB,MAAM;AAC1B,WAAO;EACR;AAEA,MAAI,CAAC,OAAO,UAAU,eAAe,KAAK,MAAM,UAAU,GAAG;AAC5D,UAAM,IAAI;MACT,UACC,KAAK,QAAQ,WACd;IACD;EACD;AAEA,MAAI,MAAM,OAAO,eAAe,KAAK,EAAE;AACvC,MAAI,KAAK;AAER,WAAO,KAAK;AACX,UAAI,cAAc,OAAO,IAAI,UAAU,MAAM,KAAK,UAAU,GAAG;AAC9D,eAAO;MACR;AAEA,YAAM,OAAO,eAAe,GAAG;IAChC;EACD;AAEA,SAAO;AACR;;;AC/BO,IAAM,mBAAN,MAA4C;EAClD,QAAiB,UAAU,IAAY;EAEvC,MAAM,SAAiB;AACtB,YAAQ,IAAI,OAAO;EACpB;AACD;AAEO,IAAM,gBAAN,MAAsC;EAC5C,QAAiB,UAAU,IAAY;EAE9B;EAET,YAAYC,SAAgC;AAC3C,SAAK,SAASA,SAAQ,UAAU,IAAI,iBAAiB;EACtD;EAEA,SAAS,OAAe,QAAyB;AAChD,UAAM,oBAAoB,OAAO,IAAI,CAAC,MAAM;AAC3C,UAAI;AACH,eAAO,KAAK,UAAU,CAAC;MACxB,QAAQ;AACP,eAAO,OAAO,CAAC;MAChB;IACD,CAAC;AACD,UAAM,YAAY,kBAAkB,SAAS,gBAAgB,kBAAkB,KAAK,IAAI,CAAC,MAAM;AAC/F,SAAK,OAAO,MAAM,UAAU,KAAK,GAAG,SAAS,EAAE;EAChD;AACD;AAEO,IAAM,aAAN,MAAmC;EACzC,QAAiB,UAAU,IAAY;EAEvC,WAAiB;EAEjB;AACD;;;AC5CO,IAAe,eAAf,MAAqD;EAC3D,QAAiB,UAAU,IAAY;EAEvC,CAAC,OAAO,WAAW,IAAI;EAEvB,MACC,YACuB;AACvB,WAAO,KAAK,KAAK,QAAW,UAAU;EACvC;EAEA,QAAQ,WAAyD;AAChE,WAAO,KAAK;MACX,CAAC,UAAU;AACV,oBAAY;AACZ,eAAO;MACR;MACA,CAAC,WAAW;AACX,oBAAY;AACZ,cAAM;MACP;IACD;EACD;EAEA,KACC,aACA,YAC+B;AAC/B,WAAO,KAAK,QAAQ,EAAE,KAAK,aAAa,UAAU;EACnD;AAGD;;;ACjCO,IAAM,YAAY,uBAAO,IAAI,cAAc;;;ACmB3C,IAAM,SAAS,uBAAO,IAAI,gBAAgB;AAG1C,IAAM,UAAU,uBAAO,IAAI,iBAAiB;AAG5C,IAAM,qBAAqB,uBAAO,IAAI,4BAA4B;AAGlE,IAAM,eAAe,uBAAO,IAAI,sBAAsB;AAGtD,IAAM,WAAW,uBAAO,IAAI,kBAAkB;AAG9C,IAAM,UAAU,uBAAO,IAAI,iBAAiB;AAG5C,IAAM,qBAAqB,uBAAO,IAAI,4BAA4B;AAEzE,IAAM,iBAAiB,uBAAO,IAAI,wBAAwB;AASnD,IAAM,QAAN,MAAuE;EAC7E,QAAiB,UAAU,IAAY;;EAgBvC,OAAgB,SAAS;IACxB,MAAM;IACN;IACA;IACA;IACA;IACA;IACA;IACA;EACD;;;;;EAMA,CAAC,SAAS;;;;;EAMV,CAAC,YAAY;;EAGb,CAAC,MAAM;;EAGP,CAAC,OAAO;;EAGR,CAAC,kBAAkB;;;;;EAMnB,CAAC,QAAQ;;EAGT,CAAC,OAAO,IAAI;;EAGZ,CAAC,cAAc,IAAI;;EAGnB,CAAC,kBAAkB,IAAsE;EAEzF,YAAY,MAAc,QAA4B,UAAkB;AACvE,SAAK,SAAS,IAAI,KAAK,YAAY,IAAI;AACvC,SAAK,MAAM,IAAI;AACf,SAAK,QAAQ,IAAI;EAClB;AACD;AAyBO,SAAS,aAA8B,OAA0B;AACvE,SAAO,MAAM,SAAS;AACvB;AAEO,SAAS,mBAAoC,OAAmD;AACtG,SAAO,GAAG,MAAM,MAAM,KAAK,QAAQ,IAAI,MAAM,SAAS,CAAC;AACxD;;;ACrJO,SAAS,KAA6B,OAA0B,MAAY;AAClF,SAAO,GAAG,GAAG,IAAI;AAClB;;;ACDA,IAAI,UAAU;;;ACGd,IAAI;AACJ,IAAI;AAkBG,IAAM,SAAS;EACrB,gBAAoD,MAAgB,IAAsB;AACzF,QAAI,CAAC,MAAM;AACV,aAAO,GAAG;IACX;AAEA,QAAI,CAAC,WAAW;AACf,kBAAY,KAAK,MAAM,UAAU,eAAe,OAAU;IAC3D;AAEA,WAAO;MACN,CAACC,OAAMC,eACNA,WAAU;QACT;QACC,CAAC,SAAe;AAChB,cAAI;AACH,mBAAO,GAAG,IAAI;UACf,SAAS,GAAG;AACX,iBAAK,UAAU;cACd,MAAMD,MAAK,eAAe;cAC1B,SAAS,aAAa,QAAQ,EAAE,UAAU;;YAC3C,CAAC;AACD,kBAAM;UACP,UAAA;AACC,iBAAK,IAAI;UACV;QACD;MACD;MACD;MACA;IACD;EACD;AACD;;;ACOO,IAAe,SAAf,MAIiE;EAwBvE,YACU,OACTE,SACC;AAFQ,SAAA,QAAA;AAGT,SAAK,SAASA;AACd,SAAK,OAAOA,QAAO;AACnB,SAAK,YAAYA,QAAO;AACxB,SAAK,UAAUA,QAAO;AACtB,SAAK,UAAUA,QAAO;AACtB,SAAK,YAAYA,QAAO;AACxB,SAAK,aAAaA,QAAO;AACzB,SAAK,aAAaA,QAAO;AACzB,SAAK,UAAUA,QAAO;AACtB,SAAK,WAAWA,QAAO;AACvB,SAAK,aAAaA,QAAO;AACzB,SAAK,aAAaA,QAAO;AACzB,SAAK,WAAWA,QAAO;AACvB,SAAK,aAAaA,QAAO;AACzB,SAAK,YAAYA,QAAO;AACxB,SAAK,oBAAoBA,QAAO;EACjC;EA3CA,QAAiB,UAAU,IAAY;EAI9B;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA,aAA8B;EAC9B,YAA0D;EAC1D,oBAAyD;EAExD;EA0BV,mBAAmB,OAAyB;AAC3C,WAAO;EACR;EAEA,iBAAiB,OAAyB;AACzC,WAAO;EACR;;EAGA,sBAA+B;AAC9B,WAAO,KAAK,OAAO,cAAc,UAAa,KAAK,OAAO,UAAU,SAAS;EAC9E;AACD;;;ACkDO,IAAe,gBAAf,MAKwC;EAC9C,QAAiB,UAAU,IAAY;EAI7B;EAEV,YAAY,MAAiB,UAAyB,YAA6B;AAClF,SAAK,SAAS;MACb;MACA,WAAW,SAAS;MACpB,SAAS;MACT,SAAS;MACT,YAAY;MACZ,YAAY;MACZ,UAAU;MACV,YAAY;MACZ,YAAY;MACZ;MACA;MACA,WAAW;IACZ;EACD;;;;;;;;;;;;EAaA,QAAmC;AAClC,WAAO;EACR;;;;;;EAOA,UAAyB;AACxB,SAAK,OAAO,UAAU;AACtB,WAAO;EACR;;;;;;;;EASA,QAAQ,OAA+F;AACtG,SAAK,OAAO,UAAU;AACtB,SAAK,OAAO,aAAa;AACzB,WAAO;EACR;;;;;;;EAQA,WACC,IACsC;AACtC,SAAK,OAAO,YAAY;AACxB,SAAK,OAAO,aAAa;AACzB,WAAO;EACR;;;;EAKA,WAAW,KAAK;;;;;;;;EAShB,YACC,IACmB;AACnB,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,aAAa;AACzB,WAAO;EACR;;;;EAKA,YAAY,KAAK;;;;;;EAOjB,aAEA;AACC,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;AACtB,WAAO;EAER;;EAUA,QAAQ,MAAc;AACrB,QAAI,KAAK,OAAO,SAAS;AAAI;AAC7B,SAAK,OAAO,OAAO;EACpB;AACD;;;ACtSO,IAAM,oBAAN,MAAwB;EAC9B,QAAiB,UAAU,IAAY;;EAGvC;;EAGA,YAA4C;;EAG5C,YAA4C;EAE5C,YACCC,SAKA,SAIC;AACD,SAAK,YAAY,MAAM;AACtB,YAAM,EAAE,MAAM,SAAS,eAAe,IAAIA,QAAO;AACjD,aAAO,EAAE,MAAM,SAAS,cAAc,eAAe,CAAC,EAAG,OAAkB,eAAe;IAC3F;AACA,QAAI,SAAS;AACZ,WAAK,YAAY,QAAQ;AACzB,WAAK,YAAY,QAAQ;IAC1B;EACD;EAEA,SAAS,QAAkC;AAC1C,SAAK,YAAY,WAAW,SAAY,cAAc;AACtD,WAAO;EACR;EAEA,SAAS,QAAkC;AAC1C,SAAK,YAAY,WAAW,SAAY,cAAc;AACtD,WAAO;EACR;;EAGA,MAAM,OAA4B;AACjC,WAAO,IAAI,WAAW,OAAO,IAAI;EAClC;AACD;AAIO,IAAM,aAAN,MAAiB;EAOvB,YAAqB,OAAgB,SAA4B;AAA5C,SAAA,QAAA;AACpB,SAAK,YAAY,QAAQ;AACzB,SAAK,WAAW,QAAQ;AACxB,SAAK,WAAW,QAAQ;EACzB;EAVA,QAAiB,UAAU,IAAY;EAE9B;EACA;EACA;EAQT,UAAkB;AACjB,UAAM,EAAE,MAAM,SAAS,eAAe,IAAI,KAAK,UAAU;AACzD,UAAM,cAAc,QAAQ,IAAI,CAAC,WAAW,OAAO,IAAI;AACvD,UAAM,qBAAqB,eAAe,IAAI,CAAC,WAAW,OAAO,IAAI;AACrE,UAAM,SAAS;MACd,KAAK,MAAM,SAAS;MACpB,GAAG;MACH,eAAe,CAAC,EAAG,MAAM,SAAS;MAClC,GAAG;IACJ;AACA,WAAO,QAAQ,GAAG,OAAO,KAAK,GAAG,CAAC;EACnC;AACD;;;ACjFO,SAAS,cAAc,OAAgB,SAAmB;AAChE,SAAO,GAAG,MAAM,SAAS,CAAC,IAAI,QAAQ,KAAK,GAAG,CAAC;AAChD;AAEO,IAAM,0BAAN,MAA8B;EAQpC,YACC,SACQ,MACP;AADO,SAAA,OAAA;AAER,SAAK,UAAU;EAChB;EAZA,QAAiB,UAAU,IAAY;;EAGvC;;EAEA,yBAAyB;EASzB,mBAAmB;AAClB,SAAK,yBAAyB;AAC9B,WAAO;EACR;;EAGA,MAAM,OAAkC;AACvC,WAAO,IAAI,iBAAiB,OAAO,KAAK,SAAS,KAAK,wBAAwB,KAAK,IAAI;EACxF;AACD;AAEO,IAAM,4BAAN,MAAgC;EACtC,QAAiB,UAAU,IAAY;;EAGvC;EAEA,YACC,MACC;AACD,SAAK,OAAO;EACb;EAEA,MAAM,SAAoC;AACzC,WAAO,IAAI,wBAAwB,SAAS,KAAK,IAAI;EACtD;AACD;AAEO,IAAM,mBAAN,MAAuB;EAO7B,YAAqB,OAAgB,SAAqB,kBAA2B,MAAe;AAA/E,SAAA,QAAA;AACpB,SAAK,UAAU;AACf,SAAK,OAAO,QAAQ,cAAc,KAAK,OAAO,KAAK,QAAQ,IAAI,CAAC,WAAW,OAAO,IAAI,CAAC;AACvF,SAAK,mBAAmB;EACzB;EAVA,QAAiB,UAAU,IAAY;EAE9B;EACA;EACA,mBAA4B;EAQrC,UAAU;AACT,WAAO,KAAK;EACb;AACD;;;ACxEA,SAAS,kBAAkB,aAAqB,WAAmB,UAAqC;AACvG,WAAS,IAAI,WAAW,IAAI,YAAY,QAAQ,KAAK;AACpD,UAAMC,QAAO,YAAY,CAAC;AAE1B,QAAIA,UAAS,MAAM;AAClB;AACA;IACD;AAEA,QAAIA,UAAS,KAAK;AACjB,aAAO,CAAC,YAAY,MAAM,WAAW,CAAC,EAAE,QAAQ,OAAO,EAAE,GAAG,IAAI,CAAC;IAClE;AAEA,QAAI,UAAU;AACb;IACD;AAEA,QAAIA,UAAS,OAAOA,UAAS,KAAK;AACjC,aAAO,CAAC,YAAY,MAAM,WAAW,CAAC,EAAE,QAAQ,OAAO,EAAE,GAAG,CAAC;IAC9D;EACD;AAEA,SAAO,CAAC,YAAY,MAAM,SAAS,EAAE,QAAQ,OAAO,EAAE,GAAG,YAAY,MAAM;AAC5E;AAEO,SAAS,mBAAmB,aAAqB,YAAY,GAAoB;AACvF,QAAM,SAAgB,CAAC;AACvB,MAAI,IAAI;AACR,MAAI,kBAAkB;AAEtB,SAAO,IAAI,YAAY,QAAQ;AAC9B,UAAMA,QAAO,YAAY,CAAC;AAE1B,QAAIA,UAAS,KAAK;AACjB,UAAI,mBAAmB,MAAM,WAAW;AACvC,eAAO,KAAK,EAAE;MACf;AACA,wBAAkB;AAClB;AACA;IACD;AAEA,sBAAkB;AAElB,QAAIA,UAAS,MAAM;AAClB,WAAK;AACL;IACD;AAEA,QAAIA,UAAS,KAAK;AACjB,YAAM,CAACC,QAAOC,UAAS,IAAI,kBAAkB,aAAa,IAAI,GAAG,IAAI;AACrE,aAAO,KAAKD,MAAK;AACjB,UAAIC;AACJ;IACD;AAEA,QAAIF,UAAS,KAAK;AACjB,aAAO,CAAC,QAAQ,IAAI,CAAC;IACtB;AAEA,QAAIA,UAAS,KAAK;AACjB,YAAM,CAACC,QAAOC,UAAS,IAAI,mBAAmB,aAAa,IAAI,CAAC;AAChE,aAAO,KAAKD,MAAK;AACjB,UAAIC;AACJ;IACD;AAEA,UAAM,CAAC,OAAO,YAAY,IAAI,kBAAkB,aAAa,GAAG,KAAK;AACrE,WAAO,KAAK,KAAK;AACjB,QAAI;EACL;AAEA,SAAO,CAAC,QAAQ,CAAC;AAClB;AAEO,SAAS,aAAa,aAA4B;AACxD,QAAM,CAAC,MAAM,IAAI,mBAAmB,aAAa,CAAC;AAClD,SAAO;AACR;AAEO,SAAS,YAAY,OAAsB;AACjD,SAAO,IACN,MAAM,IAAI,CAAC,SAAS;AACnB,QAAI,MAAM,QAAQ,IAAI,GAAG;AACxB,aAAO,YAAY,IAAI;IACxB;AAEA,QAAI,OAAO,SAAS,UAAU;AAC7B,aAAO,IAAI,KAAK,QAAQ,OAAO,MAAM,EAAE,QAAQ,MAAM,KAAK,CAAC;IAC5D;AAEA,WAAO,GAAG,IAAI;EACf,CAAC,EAAE,KAAK,GAAG,CACZ;AACD;;;ACzDO,IAAe,kBAAf,cAKG,cAEV;EACS,oBAAuC,CAAC;EAEhD,QAA0B,UAAU,IAAY;EAEhD,MAAM,MAYJ;AACD,WAAO,IAAI,eAAe,KAAK,OAAO,MAAM,MAAmC,IAAI;EACpF;EAEA,WACC,KACA,UAAsC,CAAC,GAChC;AACP,SAAK,kBAAkB,KAAK,EAAE,KAAK,QAAQ,CAAC;AAC5C,WAAO;EACR;EAEA,OACC,MACAC,SACO;AACP,SAAK,OAAO,WAAW;AACvB,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,aAAaA,SAAQ;AACjC,WAAO;EACR;EAEA,kBAAkB,IAEf;AACF,SAAK,OAAO,YAAY;MACvB;MACA,MAAM;MACN,MAAM;IACP;AACA,WAAO;EAGR;;EAGA,iBAAiB,QAAkB,OAA8B;AAChE,WAAO,KAAK,kBAAkB,IAAI,CAAC,EAAE,KAAK,QAAQ,MAAM;AACvD,aAAO;QACN,CAACC,MAAKC,aAAY;AACjB,gBAAM,UAAU,IAAI,kBAAkB,MAAM;AAC3C,kBAAM,gBAAgBD,KAAI;AAC1B,mBAAO,EAAE,SAAS,CAAC,MAAM,GAAG,gBAAgB,CAAC,aAAa,EAAE;UAC7D,CAAC;AACD,cAAIC,SAAQ,UAAU;AACrB,oBAAQ,SAASA,SAAQ,QAAQ;UAClC;AACA,cAAIA,SAAQ,UAAU;AACrB,oBAAQ,SAASA,SAAQ,QAAQ;UAClC;AACA,iBAAO,QAAQ,MAAM,KAAK;QAC3B;QACA;QACA;MACD;IACD,CAAC;EACF;;EAQA,uBACC,OACoB;AACpB,WAAO,IAAI,kBAAkB,OAAO,KAAK,MAAM;EAChD;AACD;AAGO,IAAe,WAAf,cAIG,OAA2D;EAGpE,YACmB,OAClBF,SACC;AACD,QAAI,CAACA,QAAO,YAAY;AACvB,MAAAA,QAAO,aAAa,cAAc,OAAO,CAACA,QAAO,IAAI,CAAC;IACvD;AACA,UAAM,OAAOA,OAAM;AAND,SAAA,QAAA;EAOnB;EAVA,QAA0B,UAAU,IAAY;AAWjD;AAIO,IAAM,oBAAN,cAEG,SAAoC;EAC7C,QAA0B,UAAU,IAAY;EAEvC,aAAqB;AAC7B,WAAO,KAAK,WAAW;EACxB;EAEA,cAAsC;IACrC,OAAO,KAAK,OAAO,SAAS;IAC5B,OAAO,KAAK,OAAO,SAAS;IAC5B,SAAS,KAAK,OAAO;EACtB;EACA,gBAAwC;IACvC,OAAO;IACP,OAAO;IACP,SAAS;EACV;EAEA,MAAkC;AACjC,SAAK,YAAY,QAAQ;AACzB,WAAO;EACR;EAEA,OAAmC;AAClC,SAAK,YAAY,QAAQ;AACzB,WAAO;EACR;EAEA,aAAqD;AACpD,SAAK,YAAY,QAAQ;AACzB,WAAO;EACR;EAEA,YAAoD;AACnD,SAAK,YAAY,QAAQ;AACzB,WAAO;EACR;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA+BA,GAAG,SAA2C;AAC7C,SAAK,YAAY,UAAU;AAC3B,WAAO;EACR;AACD;AAEO,IAAM,gBAAN,MAAoB;EAC1B,QAAiB,UAAU,IAAY;EACvC,YACC,MACA,WACA,MACA,aACC;AACD,SAAK,OAAO;AACZ,SAAK,YAAY;AACjB,SAAK,OAAO;AACZ,SAAK,cAAc;EACpB;EAEA;EACA;EACA;EACA;AACD;AAMO,IAAM,iBAAN,cAGG,gBASR;EACD,QAA0B,UAAU,IAAI;EAExC,YACC,MACA,aACA,MACC;AACD,UAAM,MAAM,SAAS,SAAS;AAC9B,SAAK,OAAO,cAAc;AAC1B,SAAK,OAAO,OAAO;EACpB;;EAGS,MACR,OACkD;AAClD,UAAM,aAAa,KAAK,OAAO,YAAY,MAAM,KAAK;AACtD,WAAO,IAAI;MACV;MACA,KAAK;MACL;IACD;EACD;AACD;AAEO,IAAM,UAAN,MAAM,iBAGH,SAAY;EAKrB,YACC,OACAA,SACS,YACA,OACR;AACD,UAAM,OAAOA,OAAM;AAHV,SAAA,aAAA;AACA,SAAA,QAAA;AAGT,SAAK,OAAOA,QAAO;EACpB;EAZS;EAET,QAA0B,UAAU,IAAY;EAYhD,aAAqB;AACpB,WAAO,GAAG,KAAK,WAAW,WAAW,CAAC,IAAI,OAAO,KAAK,SAAS,WAAW,KAAK,OAAO,EAAE;EACzF;EAES,mBAAmB,OAAsC;AACjE,QAAI,OAAO,UAAU,UAAU;AAE9B,cAAQ,aAAa,KAAK;IAC3B;AACA,WAAO,MAAM,IAAI,CAAC,MAAM,KAAK,WAAW,mBAAmB,CAAC,CAAC;EAC9D;EAES,iBAAiB,OAAkB,gBAAgB,OAA2B;AACtF,UAAM,IAAI,MAAM;MAAI,CAAC,MACpB,MAAM,OACH,OACA,GAAG,KAAK,YAAY,QAAO,IAC3B,KAAK,WAAW,iBAAiB,GAAgB,IAAI,IACrD,KAAK,WAAW,iBAAiB,CAAC;IACtC;AACA,QAAI;AAAe,aAAO;AAC1B,WAAO,YAAY,CAAC;EACrB;AACD;;;AC1TA,IAAM,cAAc,uBAAO,IAAI,kBAAkB;AAa1C,SAAS,SAAS,KAAoD;AAC5E,SAAO,CAAC,CAAC,OAAO,OAAO,QAAQ,cAAc,eAAe,OAAO,IAAI,WAAW,MAAM;AACzF;AAEO,IAAM,sBAAN,cAEG,gBAAsD;EAC/D,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB,cAAuC;AACnE,UAAM,MAAM,UAAU,cAAc;AACpC,SAAK,OAAO,OAAO;EACpB;;EAGS,MACR,OACgD;AAChD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,eAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,OAAO,KAAK,OAAO;EACV,aAAa,KAAK,OAAO,KAAK;EAEhD,YACC,OACAG,SACC;AACD,UAAM,OAAOA,OAAM;AACnB,SAAK,OAAOA,QAAO;EACpB;EAEA,aAAqB;AACpB,WAAO,KAAK,KAAK;EAClB;AACD;AAGO,SAAS,OACf,UACA,QACsB;AACtB,SAAO,iBAAiB,UAAU,QAAQ,MAAS;AACpD;AAGO,SAAS,iBACf,UACA,QACA,QACsB;AACtB,QAAM,eAAoC,OAAO;IAChD,CAAuB,SACtB,IAAI,oBAAoB,QAAQ,IAAa,YAAY;IAC1D;MACC;MACA,YAAY;MACZ;MACA,CAAC,WAAW,GAAG;IAChB;EACD;AAEA,SAAO;AACR;;;AC3FO,IAAM,WAAN,MAGiB;EACvB,QAAiB,UAAU,IAAY;EAUvC,YAAYC,MAAU,WAAoC,OAAe,SAAS,OAAO;AACxF,SAAK,IAAI;MACR,OAAO;MACP,KAAAA;MACA,gBAAgB;MAChB;MACA;IACD;EACD;;;;AAKD;AAEO,IAAM,eAAN,cAGG,SAA6B;EACtC,QAA0B,UAAU,IAAY;AACjD;;;AC7CO,IAAM,iBAAiB,uBAAO,IAAI,wBAAwB;;;ACgB1D,IAAM,qBAAN,MAAyB;EAC/B,QAAiB,UAAU,IAAY;AACxC;AAkDO,SAAS,aAAa,OAAqC;AACjE,SAAO,UAAU,QAAQ,UAAU,UAAa,OAAQ,MAAc,WAAW;AAClF;AAEA,SAAS,aAAa,SAA+C;AACpE,QAAM,SAA2B,EAAE,KAAK,IAAI,QAAQ,CAAC,EAAE;AACvD,aAAW,SAAS,SAAS;AAC5B,WAAO,OAAO,MAAM;AACpB,WAAO,OAAO,KAAK,GAAG,MAAM,MAAM;AAClC,QAAI,MAAM,SAAS,QAAQ;AAC1B,UAAI,CAAC,OAAO,SAAS;AACpB,eAAO,UAAU,CAAC;MACnB;AACA,aAAO,QAAQ,KAAK,GAAG,MAAM,OAAO;IACrC;EACD;AACA,SAAO;AACR;AAEO,IAAM,cAAN,MAAwC;EAC9C,QAAiB,UAAU,IAAY;EAE9B;EAET,YAAY,OAA0B;AACrC,SAAK,QAAQ,MAAM,QAAQ,KAAK,IAAI,QAAQ,CAAC,KAAK;EACnD;EAEA,SAAuB;AACtB,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;EACtB;AACD;AAEO,IAAM,MAAN,MAAM,KAAuC;EAYnD,YAAqB,aAAyB;AAAzB,SAAA,cAAA;EAA0B;EAX/C,QAAiB,UAAU,IAAY;;EAQvC,UAAsC;EAC9B,qBAAqB;EAI7B,OAAO,OAAkB;AACxB,SAAK,YAAY,KAAK,GAAG,MAAM,WAAW;AAC1C,WAAO;EACR;EAEA,QAAQC,SAA4C;AACnD,WAAO,OAAO,gBAAgB,oBAAoB,CAAC,SAAS;AAC3D,YAAM,QAAQ,KAAK,2BAA2B,KAAK,aAAaA,OAAM;AACtE,YAAM,cAAc;QACnB,sBAAsB,MAAM;QAC5B,wBAAwB,KAAK,UAAU,MAAM,MAAM;MACpD,CAAC;AACD,aAAO;IACR,CAAC;EACF;EAEA,2BAA2B,QAAoB,SAAkC;AAChF,UAAMA,UAAS,OAAO,OAAO,CAAC,GAAG,SAAS;MACzC,cAAc,QAAQ,gBAAgB,KAAK;MAC3C,iBAAiB,QAAQ,mBAAmB,EAAE,OAAO,EAAE;IACxD,CAAC;AAED,UAAM;MACL;MACA;MACA;MACA;MACA;MACA;IACD,IAAIA;AAEJ,WAAO,aAAa,OAAO,IAAI,CAAC,UAA4B;AAC3D,UAAI,GAAG,OAAO,WAAW,GAAG;AAC3B,eAAO,EAAE,KAAK,MAAM,MAAM,KAAK,EAAE,GAAG,QAAQ,CAAC,EAAE;MAChD;AAEA,UAAI,GAAG,OAAO,IAAI,GAAG;AACpB,eAAO,EAAE,KAAK,WAAW,MAAM,KAAK,GAAG,QAAQ,CAAC,EAAE;MACnD;AAEA,UAAI,UAAU,QAAW;AACxB,eAAO,EAAE,KAAK,IAAI,QAAQ,CAAC,EAAE;MAC9B;AAEA,UAAI,MAAM,QAAQ,KAAK,GAAG;AACzB,cAAM,SAAqB,CAAC,IAAI,YAAY,GAAG,CAAC;AAChD,mBAAW,CAAC,GAAG,CAAC,KAAK,MAAM,QAAQ,GAAG;AACrC,iBAAO,KAAK,CAAC;AACb,cAAI,IAAI,MAAM,SAAS,GAAG;AACzB,mBAAO,KAAK,IAAI,YAAY,IAAI,CAAC;UAClC;QACD;AACA,eAAO,KAAK,IAAI,YAAY,GAAG,CAAC;AAChC,eAAO,KAAK,2BAA2B,QAAQA,OAAM;MACtD;AAEA,UAAI,GAAG,OAAO,IAAG,GAAG;AACnB,eAAO,KAAK,2BAA2B,MAAM,aAAa;UACzD,GAAGA;UACH,cAAc,gBAAgB,MAAM;QACrC,CAAC;MACF;AAEA,UAAI,GAAG,OAAO,KAAK,GAAG;AACrB,cAAM,aAAa,MAAM,MAAM,OAAO,MAAM;AAC5C,cAAM,YAAY,MAAM,MAAM,OAAO,IAAI;AACzC,eAAO;UACN,KAAK,eAAe,SACjB,WAAW,SAAS,IACpB,WAAW,UAAU,IAAI,MAAM,WAAW,SAAS;UACtD,QAAQ,CAAC;QACV;MACD;AAEA,UAAI,GAAG,OAAO,MAAM,GAAG;AACtB,cAAM,aAAa,OAAO,gBAAgB,KAAK;AAC/C,YAAI,QAAQ,iBAAiB,WAAW;AACvC,iBAAO,EAAE,KAAK,WAAW,UAAU,GAAG,QAAQ,CAAC,EAAE;QAClD;AAEA,cAAM,aAAa,MAAM,MAAM,MAAM,OAAO,MAAM;AAClD,eAAO;UACN,KAAK,MAAM,MAAM,OAAO,KAAK,eAAe,SACzC,WAAW,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,IAAI,MAAM,WAAW,UAAU,IACxE,WAAW,UAAU,IAAI,MAAM,WAAW,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,IAAI,MAC3E,WAAW,UAAU;UACzB,QAAQ,CAAC;QACV;MACD;AAEA,UAAI,GAAG,OAAO,IAAI,GAAG;AACpB,cAAM,aAAa,MAAM,cAAc,EAAE;AACzC,cAAM,WAAW,MAAM,cAAc,EAAE;AACvC,eAAO;UACN,KAAK,eAAe,SACjB,WAAW,QAAQ,IACnB,WAAW,UAAU,IAAI,MAAM,WAAW,QAAQ;UACrD,QAAQ,CAAC;QACV;MACD;AAEA,UAAI,GAAG,OAAO,KAAK,GAAG;AACrB,YAAI,GAAG,MAAM,OAAO,WAAW,GAAG;AACjC,iBAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAE;QAC/F;AAEA,cAAM,cAAc,MAAM,UAAU,OAAO,OAAO,MAAM,QAAQ,iBAAiB,MAAM,KAAK;AAE5F,YAAI,GAAG,aAAa,IAAG,GAAG;AACzB,iBAAO,KAAK,2BAA2B,CAAC,WAAW,GAAGA,OAAM;QAC7D;AAEA,YAAI,cAAc;AACjB,iBAAO,EAAE,KAAK,KAAK,eAAe,aAAaA,OAAM,GAAG,QAAQ,CAAC,EAAE;QACpE;AAEA,YAAI,UAA+B,CAAC,MAAM;AAC1C,YAAI,eAAe;AAClB,oBAAU,CAAC,cAAc,MAAM,OAAO,CAAC;QACxC;AAEA,eAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,WAAW,GAAG,QAAQ,CAAC,WAAW,GAAG,QAAQ;MACjG;AAEA,UAAI,GAAG,OAAO,WAAW,GAAG;AAC3B,eAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAE;MAC/F;AAEA,UAAI,GAAG,OAAO,KAAI,OAAO,KAAK,MAAM,eAAe,QAAW;AAC7D,eAAO,EAAE,KAAK,WAAW,MAAM,UAAU,GAAG,QAAQ,CAAC,EAAE;MACxD;AAEA,UAAI,GAAG,OAAO,QAAQ,GAAG;AACxB,YAAI,MAAM,EAAE,QAAQ;AACnB,iBAAO,EAAE,KAAK,WAAW,MAAM,EAAE,KAAK,GAAG,QAAQ,CAAC,EAAE;QACrD;AACA,eAAO,KAAK,2BAA2B;UACtC,IAAI,YAAY,GAAG;UACnB,MAAM,EAAE;UACR,IAAI,YAAY,IAAI;UACpB,IAAI,KAAK,MAAM,EAAE,KAAK;QACvB,GAAGA,OAAM;MACV;AAEA,UAAI,SAAS,KAAK,GAAG;AACpB,YAAI,MAAM,QAAQ;AACjB,iBAAO,EAAE,KAAK,WAAW,MAAM,MAAM,IAAI,MAAM,WAAW,MAAM,QAAQ,GAAG,QAAQ,CAAC,EAAE;QACvF;AACA,eAAO,EAAE,KAAK,WAAW,MAAM,QAAQ,GAAG,QAAQ,CAAC,EAAE;MACtD;AAEA,UAAI,aAAa,KAAK,GAAG;AACxB,YAAI,MAAM,sBAAsB,GAAG;AAClC,iBAAO,KAAK,2BAA2B,CAAC,MAAM,OAAO,CAAC,GAAGA,OAAM;QAChE;AACA,eAAO,KAAK,2BAA2B;UACtC,IAAI,YAAY,GAAG;UACnB,MAAM,OAAO;UACb,IAAI,YAAY,GAAG;QACpB,GAAGA,OAAM;MACV;AAEA,UAAI,cAAc;AACjB,eAAO,EAAE,KAAK,KAAK,eAAe,OAAOA,OAAM,GAAG,QAAQ,CAAC,EAAE;MAC9D;AAEA,aAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAE;IAC/F,CAAC,CAAC;EACH;EAEQ,eACP,OACA,EAAE,aAAa,GACN;AACT,QAAI,UAAU,MAAM;AACnB,aAAO;IACR;AACA,QAAI,OAAO,UAAU,YAAY,OAAO,UAAU,WAAW;AAC5D,aAAO,MAAM,SAAS;IACvB;AACA,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,aAAa,KAAK;IAC1B;AACA,QAAI,OAAO,UAAU,UAAU;AAC9B,YAAM,sBAAsB,MAAM,SAAS;AAC3C,UAAI,wBAAwB,mBAAmB;AAC9C,eAAO,aAAa,KAAK,UAAU,KAAK,CAAC;MAC1C;AACA,aAAO,aAAa,mBAAmB;IACxC;AACA,UAAM,IAAI,MAAM,6BAA6B,KAAK;EACnD;EAEA,SAAc;AACb,WAAO;EACR;EAaA,GAAG,OAAyC;AAE3C,QAAI,UAAU,QAAW;AACxB,aAAO;IACR;AAEA,WAAO,IAAI,KAAI,QAAQ,MAAM,KAAK;EACnC;EAEA,QAIE,SAAoD;AACrD,SAAK,UAAU,OAAO,YAAY,aAAa,EAAE,oBAAoB,QAAQ,IAAI;AACjF,WAAO;EACR;EAEA,eAAqB;AACpB,SAAK,qBAAqB;AAC1B,WAAO;EACR;;;;;;;EAQA,GAAG,WAA8C;AAChD,WAAO,YAAY,OAAO;EAC3B;AACD;AAUO,IAAM,OAAN,MAAiC;EAKvC,YAAqB,OAAe;AAAf,SAAA,QAAA;EAAgB;EAJrC,QAAiB,UAAU,IAAY;EAE7B;EAIV,SAAuB;AACtB,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;EACtB;AACD;AAkBO,SAAS,qBAAqB,OAAuD;AAC3F,SAAO,OAAO,UAAU,YAAY,UAAU,QAAQ,sBAAsB,SACxE,OAAQ,MAAc,qBAAqB;AAChD;AAEO,IAAM,cAA4C;EACxD,oBAAoB,CAAC,UAAU;AAChC;AAEO,IAAM,cAA4C;EACxD,kBAAkB,CAAC,UAAU;AAC9B;AAMO,IAAM,aAA0C;EACtD,GAAG;EACH,GAAG;AACJ;AAGO,IAAM,QAAN,MAAqF;;;;;EAS3F,YACU,OACA,UAA2D,aACnE;AAFQ,SAAA,QAAA;AACA,SAAA,UAAA;EACP;EAXH,QAAiB,UAAU,IAAY;EAE7B;EAWV,SAAuB;AACtB,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;EACtB;AACD;AAmCO,SAAS,IAAI,YAAkC,QAAyB;AAC9E,QAAM,cAA0B,CAAC;AACjC,MAAI,OAAO,SAAS,KAAM,QAAQ,SAAS,KAAK,QAAQ,CAAC,MAAM,IAAK;AACnE,gBAAY,KAAK,IAAI,YAAY,QAAQ,CAAC,CAAE,CAAC;EAC9C;AACA,aAAW,CAAC,YAAYC,MAAK,KAAK,OAAO,QAAQ,GAAG;AACnD,gBAAY,KAAKA,QAAO,IAAI,YAAY,QAAQ,aAAa,CAAC,CAAE,CAAC;EAClE;AAEA,SAAO,IAAI,IAAI,WAAW;AAC3B;CAEO,CAAUC,UAAV;AACC,WAAS,QAAa;AAC5B,WAAO,IAAI,IAAI,CAAC,CAAC;EAClB;AAFOA,EAAAA,MAAS,QAAA;AAKT,WAAS,SAAS,MAAuB;AAC/C,WAAO,IAAI,IAAI,IAAI;EACpB;AAFOA,EAAAA,MAAS,WAAA;AAQT,WAAS,IAAI,KAAkB;AACrC,WAAO,IAAI,IAAI,CAAC,IAAI,YAAY,GAAG,CAAC,CAAC;EACtC;AAFOA,EAAAA,MAAS,MAAA;AAiBT,WAAS,KAAK,QAAoB,WAA2B;AACnE,UAAM,SAAqB,CAAC;AAC5B,eAAW,CAAC,GAAG,KAAK,KAAK,OAAO,QAAQ,GAAG;AAC1C,UAAI,IAAI,KAAK,cAAc,QAAW;AACrC,eAAO,KAAK,SAAS;MACtB;AACA,aAAO,KAAK,KAAK;IAClB;AACA,WAAO,IAAI,IAAI,MAAM;EACtB;AATOA,EAAAA,MAAS,OAAA;AAuBT,WAAS,WAAW,OAAqB;AAC/C,WAAO,IAAI,KAAK,KAAK;EACtB;AAFOA,EAAAA,MAAS,aAAA;AAIT,WAASC,aAAkCC,OAAiC;AAClF,WAAO,IAAI,YAAYA,KAAI;EAC5B;AAFOF,EAAAA,MAAS,cAAAC;AAIT,WAASF,OACf,OACA,SACwB;AACxB,WAAO,IAAI,MAAM,OAAO,OAAO;EAChC;AALOC,EAAAA,MAAS,QAAAD;AAAA,GA9DA,QAAA,MAAA,CAAA,EAAA;CAsEV,CAAUI,SAAV;EACC,MAAM,QAA2C;IAWvD,YACUH,OACA,YACR;AAFQ,WAAA,MAAAA;AACA,WAAA,aAAA;IACP;IAbH,QAAiB,UAAU,IAAY;;IAQvC,mBAAmB;IAOnB,SAAc;AACb,aAAO,KAAK;IACb;;IAGA,QAAQ;AACP,aAAO,IAAI,QAAQ,KAAK,KAAK,KAAK,UAAU;IAC7C;EACD;AAxBOG,OAAM,UAAA;AAAA,GADG,QAAA,MAAA,CAAA,EAAA;AA4BV,IAAM,cAAN,MAAqF;EAK3F,YAAqBD,OAAa;AAAb,SAAA,OAAAA;EAAc;EAJnC,QAAiB,UAAU,IAAY;EAMvC,SAAc;AACb,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;EACtB;AACD;AAOO,SAAS,iBAAiB,QAAmB,QAA4C;AAC/F,SAAO,OAAO,IAAI,CAAC,MAAM;AACxB,QAAI,GAAG,GAAG,WAAW,GAAG;AACvB,UAAI,EAAE,EAAE,QAAQ,SAAS;AACxB,cAAM,IAAI,MAAM,6BAA6B,EAAE,IAAI,gBAAgB;MACpE;AAEA,aAAO,OAAO,EAAE,IAAI;IACrB;AAEA,QAAI,GAAG,GAAG,KAAK,KAAK,GAAG,EAAE,OAAO,WAAW,GAAG;AAC7C,UAAI,EAAE,EAAE,MAAM,QAAQ,SAAS;AAC9B,cAAM,IAAI,MAAM,6BAA6B,EAAE,MAAM,IAAI,gBAAgB;MAC1E;AAEA,aAAO,EAAE,QAAQ,iBAAiB,OAAO,EAAE,MAAM,IAAI,CAAC;IACvD;AAEA,WAAO;EACR,CAAC;AACF;AAIO,IAAe,OAAf,MAIiB;EACvB,QAAiB,UAAU,IAAY;;EAWvC,CAAC,cAAc;EAUf,YACC,EAAE,MAAAE,OAAM,QAAQ,gBAAgB,MAAM,GAMrC;AACD,SAAK,cAAc,IAAI;MACtB,MAAAA;MACA,cAAcA;MACd;MACA;MACA;MACA,YAAY,CAAC;MACb,SAAS;IACV;EACD;EAEA,SAAuB;AACtB,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;EACtB;AACD;AAGA,OAAO,UAAU,SAAS,WAAW;AACpC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACtB;AAGA,MAAM,UAAU,SAAS,WAAW;AACnC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACtB;AAGA,SAAS,UAAU,SAAS,WAAW;AACtC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACtB;;;AC7pBO,SAAS,aACf,SACA,KACA,qBACU;AAEV,QAAM,aAA6C,CAAC;AAEpD,QAAM,SAAS,QAAQ;IACtB,CAACC,SAAQ,EAAE,MAAAC,OAAM,MAAM,GAAG,gBAAgB;AACzC,UAAI;AACJ,UAAI,GAAG,OAAO,MAAM,GAAG;AACtB,kBAAU;MACX,WAAW,GAAG,OAAO,GAAG,GAAG;AAC1B,kBAAU,MAAM;MACjB,OAAO;AACN,kBAAU,MAAM,IAAI;MACrB;AACA,UAAI,OAAOD;AACX,iBAAW,CAAC,gBAAgB,SAAS,KAAKC,MAAK,QAAQ,GAAG;AACzD,YAAI,iBAAiBA,MAAK,SAAS,GAAG;AACrC,cAAI,EAAE,aAAa,OAAO;AACzB,iBAAK,SAAS,IAAI,CAAC;UACpB;AACA,iBAAO,KAAK,SAAS;QACtB,OAAO;AACN,gBAAM,WAAW,IAAI,WAAW;AAChC,gBAAM,QAAQ,KAAK,SAAS,IAAI,aAAa,OAAO,OAAO,QAAQ,mBAAmB,QAAQ;AAE9F,cAAI,uBAAuB,GAAG,OAAO,MAAM,KAAKA,MAAK,WAAW,GAAG;AAClE,kBAAM,aAAaA,MAAK,CAAC;AACzB,gBAAI,EAAE,cAAc,aAAa;AAChC,yBAAW,UAAU,IAAI,UAAU,OAAO,aAAa,MAAM,KAAK,IAAI;YACvE,WACC,OAAO,WAAW,UAAU,MAAM,YAAY,WAAW,UAAU,MAAM,aAAa,MAAM,KAAK,GAChG;AACD,yBAAW,UAAU,IAAI;YAC1B;UACD;QACD;MACD;AACA,aAAOD;IACR;IACA,CAAC;EACF;AAGA,MAAI,uBAAuB,OAAO,KAAK,UAAU,EAAE,SAAS,GAAG;AAC9D,eAAW,CAAC,YAAY,SAAS,KAAK,OAAO,QAAQ,UAAU,GAAG;AACjE,UAAI,OAAO,cAAc,YAAY,CAAC,oBAAoB,SAAS,GAAG;AACrE,eAAO,UAAU,IAAI;MACtB;IACD;EACD;AAEA,SAAO;AACR;AAGO,SAAS,oBACf,QACA,YACiC;AACjC,SAAO,OAAO,QAAQ,MAAM,EAAE,OAAyC,CAAC,QAAQ,CAAC,MAAM,KAAK,MAAM;AACjG,QAAI,OAAO,SAAS,UAAU;AAC7B,aAAO;IACR;AAEA,UAAM,UAAU,aAAa,CAAC,GAAG,YAAY,IAAI,IAAI,CAAC,IAAI;AAC1D,QAAI,GAAG,OAAO,MAAM,KAAK,GAAG,OAAO,GAAG,KAAK,GAAG,OAAO,IAAI,OAAO,GAAG;AAClE,aAAO,KAAK,EAAE,MAAM,SAAS,MAAM,CAAC;IACrC,WAAW,GAAG,OAAO,KAAK,GAAG;AAC5B,aAAO,KAAK,GAAG,oBAAoB,MAAM,MAAM,OAAO,OAAO,GAAG,OAAO,CAAC;IACzE,OAAO;AACN,aAAO,KAAK,GAAG,oBAAoB,OAAkC,OAAO,CAAC;IAC9E;AACA,WAAO;EACR,GAAG,CAAC,CAAC;AACN;AAEO,SAAS,aAAa,MAA+B,OAAgC;AAC3F,QAAM,WAAW,OAAO,KAAK,IAAI;AACjC,QAAM,YAAY,OAAO,KAAK,KAAK;AAEnC,MAAI,SAAS,WAAW,UAAU,QAAQ;AACzC,WAAO;EACR;AAEA,aAAW,CAACE,QAAO,GAAG,KAAK,SAAS,QAAQ,GAAG;AAC9C,QAAI,QAAQ,UAAUA,MAAK,GAAG;AAC7B,aAAO;IACR;EACD;AAEA,SAAO;AACR;AAGO,SAAS,aAAa,OAAc,QAA4C;AACtF,QAAM,UAAyC,OAAO,QAAQ,MAAM,EAClE,OAAO,CAAC,CAAC,EAAE,KAAK,MAAM,UAAU,MAAS,EACzC,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM;AAEtB,QAAI,GAAG,OAAO,GAAG,KAAK,GAAG,OAAO,MAAM,GAAG;AACxC,aAAO,CAAC,KAAK,KAAK;IACnB,OAAO;AACN,aAAO,CAAC,KAAK,IAAI,MAAM,OAAO,MAAM,MAAM,OAAO,OAAO,EAAE,GAAG,CAAC,CAAC;IAChE;EACD,CAAC;AAEF,MAAI,QAAQ,WAAW,GAAG;AACzB,UAAM,IAAI,MAAM,kBAAkB;EACnC;AAEA,SAAO,OAAO,YAAY,OAAO;AAClC;AAkCO,SAAS,YAAY,WAAgB,iBAAwB;AACnE,aAAW,iBAAiB,iBAAiB;AAC5C,eAAW,QAAQ,OAAO,oBAAoB,cAAc,SAAS,GAAG;AACvE,UAAI,SAAS;AAAe;AAE5B,aAAO;QACN,UAAU;QACV;QACA,OAAO,yBAAyB,cAAc,WAAW,IAAI,KAAK,uBAAO,OAAO,IAAI;MACrF;IACD;EACD;AACD;AAYO,SAAS,gBAAiC,OAA6B;AAC7E,SAAO,MAAM,MAAM,OAAO,OAAO;AAClC;AAGO,SAAS,iBAAiB,OAAsC;AACtE,SAAO,GAAG,OAAO,QAAQ,IACtB,MAAM,EAAE,QACR,GAAG,OAAO,IAAI,IACd,MAAM,cAAc,EAAE,OACtB,GAAG,OAAO,GAAG,IACb,SACA,MAAM,MAAM,OAAO,OAAO,IAC1B,MAAM,MAAM,OAAO,IAAI,IACvB,MAAM,MAAM,OAAO,QAAQ;AAC/B;AA6BO,SAAS,uBAEd,GAAiC,GAAwB;AAC1D,SAAO;IACN,MAAM,OAAO,MAAM,YAAY,EAAE,SAAS,IAAI,IAAI;IAClD,QAAQ,OAAO,MAAM,WAAW,IAAI;EACrC;AACD;AAuBO,SAAS,SAAS,MAAoB;AAC5C,MAAI,OAAO,SAAS,YAAY,SAAS;AAAM,WAAO;AAEtD,MAAI,KAAK,YAAY,SAAS;AAAU,WAAO;AAE/C,MAAI,YAAY,MAAM;AACrB,UAAM,OAAO,OAAO,KAAK,QAAQ;AACjC,QACC,SAAS,cAAc,SAAS,YAAY,OAAO,KAAK,QAAQ,EAAE,UAAU,MAAM,eAC/E,SAAS;AACX,aAAO;AAET,WAAO;EACR;AAEA,MAAI,YAAY,MAAM;AACrB,UAAM,OAAO,OAAO,KAAK,QAAQ;AACjC,QAAI,SAAS,YAAY,SAAS;AAAa,aAAO;AAEtD,WAAO;EACR;AAEA,MAAI,YAAY,MAAM;AACrB,UAAM,OAAO,OAAO,KAAK,QAAQ;AACjC,QAAI,SAAS,YAAY,SAAS;AAAa,aAAO;AAEtD,WAAO;EACR;AAEA,MAAI,UAAU,MAAM;AACnB,QAAI,KAAK,MAAM,MAAM,aAAa,KAAK,MAAM,MAAM,iBAAiB,KAAK,MAAM,MAAM;AAAW,aAAO;AAEvG,WAAO;EACR;AAEA,MAAI,gBAAgB,MAAM;AACzB,UAAM,OAAO,OAAO,KAAK,YAAY;AACrC,QAAI,SAAS,YAAY,SAAS,YAAY,SAAS;AAAa,aAAO;AAE3E,WAAO;EACR;AAEA,MAAI,YAAY,MAAM;AACrB,UAAM,OAAO,OAAO,KAAK,QAAQ;AACjC,QAAI,SAAS,YAAY,SAAS,cAAc,SAAS;AAAa,aAAO;AAE7E,WAAO;EACR;AAEA,MAAI,OAAO,KAAK,IAAI,EAAE,WAAW;AAAG,WAAO;AAE3C,SAAO;AACR;;;AClMO,IAAM,eAAN,cAOG,aAIV;EAKC,YACC,OACQ,SACA,SACR,UACC;AACD,UAAM;AAJE,SAAA,UAAA;AACA,SAAA,UAAA;AAIR,SAAK,SAAS,EAAE,OAAO,SAAS;EACjC;EAZA,QAA0B,UAAU,IAAY;EAExC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAyCR,MAAM,OAAkE;AACvE,SAAK,OAAO,QAAQ;AACpB,WAAO;EACR;EA0BA,UACC,SAA6B,KAAK,OAAO,MAAM,MAAM,OAAO,OAAO,GAC1B;AACzC,SAAK,OAAO,YAAY,oBAA8B,MAAM;AAC5D,WAAO;EACR;;EAGA,SAAc;AACb,WAAO,KAAK,QAAQ,iBAAiB,KAAK,MAAM;EACjD;EAEA,QAAe;AACd,UAAM,EAAE,SAAS,UAAU,GAAG,KAAK,IAAI,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC;AAC5E,WAAO;EACR;;EAGA,SAAS,MAAsC;AAC9C,WAAO,OAAO,gBAAgB,wBAAwB,MAAM;AAC3D,aAAO,KAAK,QAAQ,aAIlB,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC,GAAG,KAAK,OAAO,WAAW,MAAM,IAAI;IAC5E,CAAC;EACF;EAEA,QAAQ,MAAqC;AAC5C,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAES,UAAkD,CAAC,sBAAsB;AACjF,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,aAAO,KAAK,SAAS,EAAE,QAAQ,mBAAmB,KAAK,SAAS;IACjE,CAAC;EACF;EAEA,WAAkC;AACjC,WAAO;EACR;AACD;;;ACjPO,IAAM,0BAAN,MAAuF;EAG7F,YAAoB,OAAqB;AAArB,SAAA,QAAA;EAAsB;EAF1C,QAAiB,UAAU,IAAY;EAIvC,IAAI,WAAoB,MAA4B;AACnD,QAAI,SAAS,SAAS;AACrB,aAAO,KAAK;IACb;AAEA,WAAO,UAAU,IAAqB;EACvC;AACD;AAEO,IAAM,yBAAN,MAAgF;EAGtF,YAAoB,OAAuB,qBAA8B;AAArD,SAAA,QAAA;AAAuB,SAAA,sBAAA;EAA+B;EAF1E,QAAiB,UAAU,IAAY;EAIvC,IAAI,QAAW,MAA4B;AAC1C,QAAI,SAAS,MAAM,OAAO,SAAS;AAClC,aAAO;IACR;AAEA,QAAI,SAAS,MAAM,OAAO,MAAM;AAC/B,aAAO,KAAK;IACb;AAEA,QAAI,KAAK,uBAAuB,SAAS,MAAM,OAAO,cAAc;AACnE,aAAO,KAAK;IACb;AAEA,QAAI,SAAS,gBAAgB;AAC5B,aAAO;QACN,GAAG,OAAO,cAAqC;QAC/C,MAAM,KAAK;QACX,SAAS;MACV;IACD;AAEA,QAAI,SAAS,MAAM,OAAO,SAAS;AAClC,YAAM,UAAW,OAAiB,MAAM,OAAO,OAAO;AACtD,UAAI,CAAC,SAAS;AACb,eAAO;MACR;AAEA,YAAM,iBAAyC,CAAC;AAEhD,aAAO,KAAK,OAAO,EAAE,IAAI,CAAC,QAAQ;AACjC,uBAAe,GAAG,IAAI,IAAI;UACzB,QAAQ,GAAG;UACX,IAAI,wBAAwB,IAAI,MAAM,QAAQ,IAAI,CAAC;QACpD;MACD,CAAC;AAED,aAAO;IACR;AAEA,UAAM,QAAQ,OAAO,IAA2B;AAChD,QAAI,GAAG,OAAO,MAAM,GAAG;AACtB,aAAO,IAAI,MAAM,OAAoB,IAAI,wBAAwB,IAAI,MAAM,QAAQ,IAAI,CAAC,CAAC;IAC1F;AAEA,WAAO;EACR;AACD;AAEO,IAAM,iCAAN,MAAoF;EAG1F,YAAoB,OAAe;AAAf,SAAA,QAAA;EAAgB;EAFpC,QAAiB,UAAU,IAAY;EAIvC,IAAI,QAAW,MAA4B;AAC1C,QAAI,SAAS,eAAe;AAC3B,aAAO,aAAa,OAAO,aAAa,KAAK,KAAK;IACnD;AAEA,WAAO,OAAO,IAA2B;EAC1C;AACD;AAEO,SAAS,aAA8B,OAAU,YAAuB;AAC9E,SAAO,IAAI,MAAM,OAAO,IAAI,uBAAuB,YAAY,KAAK,CAAC;AACtE;AAMO,SAAS,mBAAwC,QAAW,YAAuB;AACzF,SAAO,IAAI;IACV;IACA,IAAI,wBAAwB,IAAI,MAAM,OAAO,OAAO,IAAI,uBAAuB,YAAY,KAAK,CAAC,CAAC;EACnG;AACD;AAEO,SAAS,8BAA8B,OAAoB,OAA4B;AAC7F,SAAO,IAAI,IAAI,QAAQ,uBAAuB,MAAM,KAAK,KAAK,GAAG,MAAM,UAAU;AAClF;AAEO,SAAS,uBAAuB,OAAY,OAAoB;AACtE,SAAO,IAAI,KAAK,MAAM,YAAY,IAAI,CAAC,MAAM;AAC5C,QAAI,GAAG,GAAG,MAAM,GAAG;AAClB,aAAO,mBAAmB,GAAG,KAAK;IACnC;AACA,QAAI,GAAG,GAAG,GAAG,GAAG;AACf,aAAO,uBAAuB,GAAG,KAAK;IACvC;AACA,QAAI,GAAG,GAAG,IAAI,OAAO,GAAG;AACvB,aAAO,8BAA8B,GAAG,KAAK;IAC9C;AACA,WAAO;EACR,CAAC,CAAC;AACH;;;ACrHO,SAAS,YAAY,OAAe;AAC1C,QAAM,QAAQ,MACZ,QAAQ,cAAc,EAAE,EACxB,MAAM,yCAAyC,KAAK,CAAC;AAEvD,SAAO,MAAM,IAAI,CAAC,SAAS,KAAK,YAAY,CAAC,EAAE,KAAK,GAAG;AACxD;AAEO,SAAS,YAAY,OAAe;AAC1C,QAAM,QAAQ,MACZ,QAAQ,cAAc,EAAE,EACxB,MAAM,yCAAyC,KAAK,CAAC;AAEvD,SAAO,MAAM,OAAO,CAAC,KAAK,MAAM,MAAM;AACrC,UAAM,gBAAgB,MAAM,IAAI,KAAK,YAAY,IAAI,GAAG,KAAK,CAAC,EAAG,YAAY,CAAC,GAAG,KAAK,MAAM,CAAC,CAAC;AAC9F,WAAO,MAAM;EACd,GAAG,EAAE;AACN;AAEA,SAAS,SAAS,OAAe;AAChC,SAAO;AACR;AAEO,IAAM,cAAN,MAAkB;EACxB,QAAiB,UAAU,IAAY;;EAGvC,QAAgC,CAAC;EACzB,eAAqC,CAAC;EACtC;EAER,YAAY,QAAiB;AAC5B,SAAK,UAAU,WAAW,eACvB,cACA,WAAW,cACX,cACA;EACJ;EAEA,gBAAgB,QAAwB;AACvC,QAAI,CAAC,OAAO;AAAW,aAAO,OAAO;AAErC,UAAM,SAAS,OAAO,MAAM,MAAM,OAAO,MAAM,KAAK;AACpD,UAAM,YAAY,OAAO,MAAM,MAAM,OAAO,YAAY;AACxD,UAAM,MAAM,GAAG,MAAM,IAAI,SAAS,IAAI,OAAO,IAAI;AAEjD,QAAI,CAAC,KAAK,MAAM,GAAG,GAAG;AACrB,WAAK,WAAW,OAAO,KAAK;IAC7B;AACA,WAAO,KAAK,MAAM,GAAG;EACtB;EAEQ,WAAW,OAAc;AAChC,UAAM,SAAS,MAAM,MAAM,OAAO,MAAM,KAAK;AAC7C,UAAM,YAAY,MAAM,MAAM,OAAO,YAAY;AACjD,UAAM,WAAW,GAAG,MAAM,IAAI,SAAS;AAEvC,QAAI,CAAC,KAAK,aAAa,QAAQ,GAAG;AACjC,iBAAW,UAAU,OAAO,OAAO,MAAM,MAAM,OAAO,OAAO,CAAC,GAAG;AAChE,cAAM,YAAY,GAAG,QAAQ,IAAI,OAAO,IAAI;AAC5C,aAAK,MAAM,SAAS,IAAI,KAAK,QAAQ,OAAO,IAAI;MACjD;AACA,WAAK,aAAa,QAAQ,IAAI;IAC/B;EACD;EAEA,aAAa;AACZ,SAAK,QAAQ,CAAC;AACd,SAAK,eAAe,CAAC;EACtB;AACD;;;ACzEO,IAAM,eAAN,cAA2B,MAAM;EACvC,QAAiB,UAAU,IAAY;EAEvC,YAAY,EAAE,SAAS,MAAM,GAA0C;AACtE,UAAM,OAAO;AACb,SAAK,OAAO;AACZ,SAAK,QAAQ;EACd;AACD;AAEO,IAAM,2BAAN,cAAuC,aAAa;EAC1D,QAA0B,UAAU,IAAY;EAEhD,cAAc;AACb,UAAM,EAAE,SAAS,WAAW,CAAC;EAC9B;AACD;;;ACbO,IAAe,yBAAf,cAEG,gBAGR;EACD,QAA0B,UAAU,IAAY;EAEhD,0BACC,UAC6B;AAC7B,QAAI,UAAU;AACb,YAAM,EAAE,MAAM,GAAG,QAAQ,IAAI;AAC7B,WAAK,OAAO,oBAAoB;QAC/B,MAAM;QACN,cAAc;QACd,iBAAiB;MAClB;IACD,OAAO;AACN,WAAK,OAAO,oBAAoB;QAC/B,MAAM;MACP;IACD;AAEA,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;AAEtB,WAAO;EACR;EAEA,6BACC,UACgC;AAChC,QAAI,UAAU;AACb,YAAM,EAAE,MAAM,GAAG,QAAQ,IAAI;AAC7B,WAAK,OAAO,oBAAoB;QAC/B,MAAM;QACN,cAAc;QACd,iBAAiB;MAClB;IACD,OAAO;AACN,WAAK,OAAO,oBAAoB;QAC/B,MAAM;MACP;IACD;AAEA,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;AAEtB,WAAO;EACR;AACD;;;ACtCO,IAAM,oBAAN,cACE,uBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,YAAY;EACnC;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI,WAA4C,OAAO,KAAK,MAA8C;EAClH;AACD;AAEO,IAAM,aAAN,cAA6E,SAAY;EAC/F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAgC;AAC3D,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO;IACR;AACA,WAAO,OAAO,KAAK;EACpB;AACD;AAWO,IAAM,oBAAN,cACE,uBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,YAAY;EACnC;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,aAAN,cAA6E,SAAY;EAC/F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;;EAGS,mBAAmB,OAAuB;AAClD,WAAO,OAAO,KAAK;EACpB;AACD;AAaO,SAAS,OAAO,GAA4B,GAAoB;AACtE,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAuC,GAAG,CAAC;AACpE,MAAIA,QAAO,SAAS,UAAU;AAC7B,WAAO,IAAI,kBAAkB,IAAI;EAClC;AACA,SAAO,IAAI,kBAAkB,IAAI;AAClC;;;ACnFO,IAAM,uBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAc;AACzB,UAAM,MAAM,UAAU,eAAe;AACrC,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;EACvB;;EAGS,MACR,OACiD;AACjD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,gBAAN,cAAmF,SAAY;EACrG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAuB;AAClD,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO;IACR;AACA,WAAO,OAAO,KAAK;EACpB;AACD;AAeO,IAAM,uBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAc;AACzB,UAAM,MAAM,UAAU,eAAe;AACrC,SAAK,OAAO,aAAa;EAC1B;;EAGS,MACR,OACiD;AACjD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,gBAAN,cAAmF,SAAY;EACrG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;;EAGS,mBAAmB,OAAuB;AAClD,WAAO,OAAO,KAAK;EACpB;AACD;AAaO,SAAS,UAAU,GAA+B,GAAuB;AAC/E,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAA0C,GAAG,CAAC;AACvE,MAAIA,QAAO,SAAS,UAAU;AAC7B,WAAO,IAAI,qBAAqB,IAAI;EACrC;AACA,SAAO,IAAI,qBAAqB,IAAI;AACrC;;;AChHO,IAAM,mBAAN,cAA0F,gBAAmB;EACnH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,WAAW,WAAW;EACnC;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI,UAA2C,OAAO,KAAK,MAA8C;EACjH;AACD;AAEO,IAAM,YAAN,cAA4E,SAAY;EAC9F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,QAAQ,MAAe;AACtC,SAAO,IAAI,iBAAiB,QAAQ,EAAE;AACvC;;;AC1BO,IAAM,gBAAN,cAAmF,gBAGxF;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiBC,SAAuC;AACnE,UAAM,MAAM,UAAU,QAAQ;AAC9B,SAAK,OAAO,SAASA,QAAO;AAC5B,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,SAAS,KAAK,OAAO;EACZ,aAAa,KAAK,OAAO;EAE3C,aAAqB;AACpB,WAAO,KAAK,WAAW,SAAY,SAAS,QAAQ,KAAK,MAAM;EAChE;AACD;AAiBO,SAAS,KAAK,GAA2B,IAAkB,CAAC,GAAQ;AAC1E,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAqC,GAAG,CAAC;AAClE,SAAO,IAAI,cAAc,MAAMA,OAAa;AAC7C;;;ACpDO,IAAM,gBAAN,cAAmF,gBAAmB;EAC5G,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,QAAQ;EAC/B;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,KAAK,MAAe;AACnC,SAAO,IAAI,cAAc,QAAQ,EAAE;AACpC;;;AClBO,IAAM,wBAAN,cACE,gBAUT;EACC,QAA0B,UAAU,IAAY;EAEhD,YACC,MACA,aACA,kBACC;AACD,UAAM,MAAM,UAAU,gBAAgB;AACtC,SAAK,OAAO,cAAc;AAC1B,SAAK,OAAO,mBAAmB;EAChC;;EAGA,MACC,OACkD;AAClD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,iBAAN,cAAqF,SAAY;EACvG,QAA0B,UAAU,IAAY;EAExC;EACA;EACA;EAER,YACC,OACAC,SACC;AACD,UAAM,OAAOA,OAAM;AACnB,SAAK,UAAUA,QAAO,iBAAiB,SAASA,QAAO,WAAW;AAClE,SAAK,QAAQA,QAAO,iBAAiB;AACrC,SAAK,UAAUA,QAAO,iBAAiB;EACxC;EAEA,aAAqB;AACpB,WAAO,KAAK;EACb;EAES,mBAAmB,OAAoC;AAC/D,WAAO,OAAO,KAAK,YAAY,aAAa,KAAK,QAAQ,KAAK,IAAI;EACnE;EAES,iBAAiB,OAAoC;AAC7D,WAAO,OAAO,KAAK,UAAU,aAAa,KAAK,MAAM,KAAK,IAAI;EAC/D;AACD;AAmHO,SAAS,WACf,kBAoBD;AACC,SAAO,CACN,GACA,MAC0D;AAC1D,UAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAoC,GAAG,CAAC;AACjE,WAAO,IAAI,sBAAsB,MAA+CA,SAAQ,gBAAgB;EACzG;AACD;;;AClOO,IAAe,0BAAf,cAGG,gBAAmC;EAC5C,QAA0B,UAAU,IAAY;EAEhD,aAAa;AACZ,WAAO,KAAK,QAAQ,UAAU;EAC/B;AACD;;;ACGO,IAAM,gBAAN,cAAiF,wBAA2B;EAClH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,QAAQ,QAAQ;EAC7B;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAmE,SAAY;EACrF,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAqB;AAChD,WAAO,IAAI,KAAK,KAAK;EACtB;EAES,iBAAiB,OAAqB;AAC9C,WAAO,MAAM,YAAY;EAC1B;AACD;AAWO,IAAM,sBAAN,cACE,wBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,cAAc;EACrC;;EAGS,MACR,OACgD;AAChD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,eAAN,cAAiF,SAAY;EACnG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAcO,SAAS,KAAK,GAA2B,GAAkB;AACjE,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAqC,GAAG,CAAC;AAClE,MAAIA,SAAQ,SAAS,QAAQ;AAC5B,WAAO,IAAI,cAAc,IAAI;EAC9B;AACA,SAAO,IAAI,oBAAoB,IAAI;AACpC;;;ACxFO,IAAM,2BAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,mBAAmB;EAC1C;;EAGS,MACR,OACqD;AACrD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,oBAAN,cAA2F,SAAY;EAC7G,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAgC;AAC3D,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,OAAO,WAAW,KAAK;IAC/B;AACA,WAAO;EACR;AACD;AAIO,SAAS,gBAAgB,MAAe;AAC9C,SAAO,IAAI,yBAAyB,QAAQ,EAAE;AAC/C;;;ACvCO,IAAM,gBAAN,cAAmF,gBAAmB;EAC5G,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,QAAQ;EAC/B;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,KAAK,MAAe;AACnC,SAAO,IAAI,cAAc,QAAQ,EAAE;AACpC;;;AC1BO,IAAM,mBAAN,cACE,uBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,WAAW;EAClC;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI,UAA2C,OAAO,KAAK,MAA8C;EACjH;AACD;AAEO,IAAM,YAAN,cAA2E,SAAY;EAC7F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAgC;AAC3D,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,OAAO,SAAS,KAAK;IAC7B;AACA,WAAO;EACR;AACD;AAIO,SAAS,QAAQ,MAAe;AACtC,SAAO,IAAI,iBAAiB,QAAQ,EAAE;AACvC;;;ACnCO,IAAM,oBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YACC,MACA,gBACC;AACD,UAAM,MAAM,UAAU,YAAY;AAClC,SAAK,OAAO,iBAAiB;EAC9B;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI,WAA4C,OAAO,KAAK,MAA8C;EAClH;AACD;AAEO,IAAM,aAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,SAAmC,KAAK,OAAO,eAAe;EAC9D,YAAyC,KAAK,OAAO,eAAe;EAE7E,aAAqB;AACpB,UAAM,SAAS,KAAK,SAAS,IAAI,KAAK,MAAM,KAAK;AACjD,UAAM,YAAY,KAAK,YAAY,IAAI,KAAK,SAAS,MAAM;AAC3D,WAAO,WAAW,MAAM,GAAG,SAAS;EACrC;AACD;AA4BO,SAAS,SAAS,GAA6B,IAAoB,CAAC,GAAG;AAC7E,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAuC,GAAG,CAAC;AACpE,SAAO,IAAI,kBAAkB,MAAMA,OAAM;AAC1C;;;ACnEO,IAAM,gBAAN,cAAiF,gBAEtF;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,QAAQ,QAAQ;EAC7B;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAmE,SAAY;EACrF,QAA0B,UAAU,IAAY;EAEhD,YAAY,OAA6CC,SAAoC;AAC5F,UAAM,OAAOA,OAAM;EACpB;EAEA,aAAqB;AACpB,WAAO;EACR;EAES,iBAAiB,OAA0B;AACnD,WAAO,KAAK,UAAU,KAAK;EAC5B;EAES,mBAAmB,OAAsC;AACjE,QAAI,OAAO,UAAU,UAAU;AAC9B,UAAI;AACH,eAAO,KAAK,MAAM,KAAK;MACxB,QAAQ;AACP,eAAO;MACR;IACD;AACA,WAAO;EACR;AACD;AAIO,SAAS,KAAK,MAAe;AACnC,SAAO,IAAI,cAAc,QAAQ,EAAE;AACpC;;;AChDO,IAAM,iBAAN,cAAmF,gBAAmB;EAC5G,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,QAAQ,SAAS;EAC9B;;EAGS,MACR,OAC2C;AAC3C,WAAO,IAAI,QAAyC,OAAO,KAAK,MAA8C;EAC/G;AACD;AAEO,IAAM,UAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEhD,YAAY,OAA6CC,SAAqC;AAC7F,UAAM,OAAOA,OAAM;EACpB;EAEA,aAAqB;AACpB,WAAO;EACR;EAES,iBAAiB,OAA0B;AACnD,WAAO,KAAK,UAAU,KAAK;EAC5B;EAES,mBAAmB,OAAsC;AACjE,QAAI,OAAO,UAAU,UAAU;AAC9B,UAAI;AACH,eAAO,KAAK,MAAM,KAAK;MACxB,QAAQ;AACP,eAAO;MACR;IACD;AACA,WAAO;EACR;AACD;AAIO,SAAS,MAAM,MAAe;AACpC,SAAO,IAAI,eAAe,QAAQ,EAAE;AACrC;;;AC5CO,IAAM,gBAAN,cAAkF,gBAAmB;EAC3G,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,SAAS,QAAQ;EAC9B;;EAGS,MACR,OAC+C;AAC/C,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,cAAN,cAAyE,SAAY;EAC3F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAyC;AACpE,UAAM,CAAC,GAAG,GAAG,CAAC,IAAI,MAAM,MAAM,GAAG,EAAE,EAAE,MAAM,GAAG;AAC9C,WAAO,CAAC,OAAO,WAAW,CAAE,GAAG,OAAO,WAAW,CAAE,GAAG,OAAO,WAAW,CAAE,CAAC;EAC5E;EAES,iBAAiB,OAAyC;AAClE,WAAO,IAAI,MAAM,CAAC,CAAC,IAAI,MAAM,CAAC,CAAC,IAAI,MAAM,CAAC,CAAC;EAC5C;AACD;AAWO,IAAM,mBAAN,cAAuF,gBAAmB;EAChH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,QAAQ,WAAW;EAChC;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,YAAN,cAAyE,SAAY;EAC3F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAoD;AAC/E,UAAM,CAAC,GAAG,GAAG,CAAC,IAAI,MAAM,MAAM,GAAG,EAAE,EAAE,MAAM,GAAG;AAC9C,WAAO,EAAE,GAAG,OAAO,WAAW,CAAE,GAAG,GAAG,OAAO,WAAW,CAAE,GAAG,GAAG,OAAO,WAAW,CAAE,EAAE;EACvF;EAES,iBAAiB,OAAoD;AAC7E,WAAO,IAAI,MAAM,CAAC,IAAI,MAAM,CAAC,IAAI,MAAM,CAAC;EACzC;AACD;AAgBO,SAAS,KAAK,GAA+B,GAAsB;AACzE,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAyC,GAAG,CAAC;AACtE,MAAI,CAACA,SAAQ,QAAQA,QAAO,SAAS,SAAS;AAC7C,WAAO,IAAI,cAAc,IAAI;EAC9B;AACA,SAAO,IAAI,iBAAiB,IAAI;AACjC;;;ACrGO,IAAM,mBAAN,cAAyF,gBAAmB;EAClH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,WAAW;EAClC;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI,UAA2C,OAAO,KAAK,MAA8C;EACjH;AACD;AAEO,IAAM,YAAN,cAA2E,SAAY;EAC7F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,QAAQ,MAAe;AACtC,SAAO,IAAI,iBAAiB,QAAQ,EAAE;AACvC;;;AC3BO,IAAM,oBAAN,cAA2F,gBAAmB;EACpH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,YAAY;EACnC;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI,WAA4C,OAAO,KAAK,MAA8C;EAClH;AACD;AAEO,IAAM,aAAN,cAA6E,SAAY;EAC/F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,SAAS,MAAe;AACvC,SAAO,IAAI,kBAAkB,QAAQ,EAAE;AACxC;;;AC1BO,IAAM,mBAAN,cAAyF,gBAM9F;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB,WAAoB,OAAgB;AAChE,UAAM,MAAM,UAAU,WAAW;AACjC,SAAK,OAAO,YAAY;AACxB,SAAK,OAAO,QAAQ;EACrB;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI,UAA2C,OAAO,KAAK,MAA8C;EACjH;AACD;AAEO,IAAM,YAAN,cAA2E,SAAY;EAC7F,QAA0B,UAAU,IAAY;EAEvC;EACA;EAET,YAAY,OAA6CC,SAAuC;AAC/F,UAAM,OAAOA,OAAM;AACnB,SAAK,YAAYA,QAAO;AACxB,SAAK,QAAQA,QAAO;EACrB;EAEA,aAAqB;AACpB,QAAI,KAAK,cAAc,UAAa,KAAK,UAAU,QAAW;AAC7D,aAAO,WAAW,KAAK,SAAS,KAAK,KAAK,KAAK;IAChD,WAAW,KAAK,cAAc,QAAW;AACxC,aAAO;IACR,OAAO;AACN,aAAO,WAAW,KAAK,SAAS;IACjC;EACD;AACD;AAeO,SAAS,QAAQ,GAA8B,GAAqB;AAC1E,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAwC,GAAG,CAAC;AACrE,SAAO,IAAI,iBAAiB,MAAMA,SAAQ,WAAWA,SAAQ,KAAK;AACnE;AAEO,IAAM,UAAU;;;AC/DhB,IAAM,sBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAc;AACzB,UAAM,MAAM,SAAS,cAAc;EACpC;;EAGS,MACR,OACgD;AAChD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,eAAN,cAAgF,SAAY;EAClG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAA4D;AACvF,QAAI,OAAO,UAAU,UAAU;AAC9B,YAAM,CAAC,GAAG,CAAC,IAAI,MAAM,MAAM,GAAG,EAAE,EAAE,MAAM,GAAG;AAC3C,aAAO,CAAC,OAAO,WAAW,CAAE,GAAG,OAAO,WAAW,CAAE,CAAC;IACrD;AACA,WAAO,CAAC,MAAM,GAAG,MAAM,CAAC;EACzB;EAES,iBAAiB,OAAiC;AAC1D,WAAO,IAAI,MAAM,CAAC,CAAC,IAAI,MAAM,CAAC,CAAC;EAChC;AACD;AAWO,IAAM,uBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAc;AACzB,UAAM,MAAM,QAAQ,eAAe;EACpC;;EAGS,MACR,OACiD;AACjD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,gBAAN,cAAiF,SAAY;EACnG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAoE;AAC/F,QAAI,OAAO,UAAU,UAAU;AAC9B,YAAM,CAAC,GAAG,CAAC,IAAI,MAAM,MAAM,GAAG,EAAE,EAAE,MAAM,GAAG;AAC3C,aAAO,EAAE,GAAG,OAAO,WAAW,CAAE,GAAG,GAAG,OAAO,WAAW,CAAE,EAAE;IAC7D;AACA,WAAO;EACR;EAES,iBAAiB,OAAyC;AAClE,WAAO,IAAI,MAAM,CAAC,IAAI,MAAM,CAAC;EAC9B;AACD;AAgBO,SAAS,MAAM,GAA4B,GAAmB;AACpE,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAsC,GAAG,CAAC;AACnE,MAAI,CAACA,SAAQ,QAAQA,QAAO,SAAS,SAAS;AAC7C,WAAO,IAAI,oBAAoB,IAAI;EACpC;AACA,SAAO,IAAI,qBAAqB,IAAI;AACrC;;;AC9HA,SAAS,WAAW,KAAyB;AAC5C,QAAM,QAAkB,CAAC;AACzB,WAAS,IAAI,GAAG,IAAI,IAAI,QAAQ,KAAK,GAAG;AACvC,UAAM,KAAK,OAAO,SAAS,IAAI,MAAM,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;EACpD;AACA,SAAO,IAAI,WAAW,KAAK;AAC5B;AAEA,SAAS,eAAe,OAAmB,QAAwB;AAClE,QAAM,SAAS,IAAI,YAAY,CAAC;AAChC,QAAM,OAAO,IAAI,SAAS,MAAM;AAChC,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC3B,SAAK,SAAS,GAAG,MAAM,SAAS,CAAC,CAAE;EACpC;AACA,SAAO,KAAK,WAAW,GAAG,IAAI;AAC/B;AAEO,SAAS,UAAU,KAA+B;AACxD,QAAM,QAAQ,WAAW,GAAG;AAE5B,MAAI,SAAS;AAGb,QAAM,YAAY,MAAM,MAAM;AAC9B,YAAU;AAEV,QAAM,OAAO,IAAI,SAAS,MAAM,MAAM;AACtC,QAAM,WAAW,KAAK,UAAU,QAAQ,cAAc,CAAC;AACvD,YAAU;AAEV,MAAI;AACJ,MAAI,WAAW,WAAY;AAC1B,YAAQ,KAAK,UAAU,QAAQ,cAAc,CAAC;AAC9C,cAAU;EACX;AAEA,OAAK,WAAW,WAAY,GAAG;AAC9B,UAAM,IAAI,eAAe,OAAO,MAAM;AACtC,cAAU;AACV,UAAM,IAAI,eAAe,OAAO,MAAM;AACtC,cAAU;AAEV,WAAO,CAAC,GAAG,CAAC;EACb;AAEA,QAAM,IAAI,MAAM,2BAA2B;AAC5C;;;AC5BO,IAAM,oBAAN,cAA0F,gBAAmB;EACnH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,SAAS,YAAY;EAClC;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,aAAN,cAA4E,SAAY;EAC9F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAiC;AAC5D,WAAO,UAAU,KAAK;EACvB;EAES,iBAAiB,OAAiC;AAC1D,WAAO,SAAS,MAAM,CAAC,CAAC,IAAI,MAAM,CAAC,CAAC;EACrC;AACD;AAWO,IAAM,0BAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,QAAQ,kBAAkB;EACvC;;EAGS,MACR,OACoD;AACpD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,mBAAN,cAAuF,SAAY;EACzG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,mBAAmB,OAAyC;AACpE,UAAM,SAAS,UAAU,KAAK;AAC9B,WAAO,EAAE,GAAG,OAAO,CAAC,GAAG,GAAG,OAAO,CAAC,EAAE;EACrC;EAES,iBAAiB,OAAyC;AAClE,WAAO,SAAS,MAAM,CAAC,IAAI,MAAM,CAAC;EACnC;AACD;AAgBO,SAAS,SAAS,GAA+B,GAAsB;AAC7E,QAAM,EAAE,MAAM,QAAAC,QAAO,IAAI,uBAAyC,GAAG,CAAC;AACtE,MAAI,CAACA,SAAQ,QAAQA,QAAO,SAAS,SAAS;AAC7C,WAAO,IAAI,kBAAkB,IAAI;EAClC;AACA,SAAO,IAAI,wBAAwB,IAAI;AACxC;;;ACvGO,IAAM,gBAAN,cAAmF,gBAGxF;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB,QAAiB;AAC7C,UAAM,MAAM,UAAU,QAAQ;AAC9B,SAAK,OAAO,SAAS;EACtB;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEhD,YAAY,OAA6CC,SAAoC;AAC5F,UAAM,OAAOA,OAAM;EACpB;EAEA,aAAqB;AACpB,WAAO;EACR;EAES,qBAAqB,CAAC,UAAmC;AACjE,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,OAAO,WAAW,KAAK;IAC/B;AACA,WAAO;EACR;AACD;AAIO,SAAS,KAAK,MAAe;AACnC,SAAO,IAAI,cAAc,QAAQ,EAAE;AACpC;;;AChCO,IAAM,kBAAN,cAAuF,gBAAmB;EAChH,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,UAAU;AAChC,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;EACvB;;EAGS,MACR,OAC4C;AAC5C,WAAO,IAAI,SAA0C,OAAO,KAAK,MAA8C;EAChH;AACD;AAEO,IAAM,WAAN,cAAyE,SAAY;EAC3F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,OAAO,MAAe;AACrC,SAAO,IAAI,gBAAgB,QAAQ,EAAE;AACtC;;;ACtCO,IAAM,oBAAN,cACE,uBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,YAAY;EACnC;;EAGS,MACR,OAC8C;AAC9C,WAAO,IAAI,WAA4C,OAAO,KAAK,MAA8C;EAClH;AACD;AAEO,IAAM,aAAN,cAA6E,SAAY;EAC/F,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;EAES,qBAAqB,CAAC,UAAmC;AACjE,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,OAAO,KAAK;IACpB;AACA,WAAO;EACR;AACD;AAIO,SAAS,SAAS,MAAe;AACvC,SAAO,IAAI,kBAAkB,QAAQ,EAAE;AACxC;;;AC3BO,IAAM,uBAAN,cACE,gBACT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,eAAe;AACrC,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;EACvB;;EAGS,MACR,OACiD;AACjD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,gBAAN,cAAmF,SAAY;EACrG,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,YAAY,MAAe;AAC1C,SAAO,IAAI,qBAAqB,QAAQ,EAAE;AAC3C;;;AC3CO,IAAM,gBAAN,cAEG,gBAAoD;EAC7D,QAA0B,UAAU,IAAY;EAEhD,YACC,MACAC,SACC;AACD,UAAM,MAAM,UAAU,QAAQ;AAC9B,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAE9B,aAAa,KAAK,OAAO;EAE3C,aAAqB;AACpB,WAAO;EACR;AACD;AAgBO,SAAS,KAAK,GAA2B,IAAkB,CAAC,GAAQ;AAC1E,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAqC,GAAG,CAAC;AAClE,SAAO,IAAI,cAAc,MAAMA,OAAa;AAC7C;;;AChDO,IAAM,gBAAN,cAAmF,wBAGxF;EAGD,YACC,MACS,cACA,WACR;AACD,UAAM,MAAM,UAAU,QAAQ;AAHrB,SAAA,eAAA;AACA,SAAA,YAAA;AAGT,SAAK,OAAO,eAAe;AAC3B,SAAK,OAAO,YAAY;EACzB;EAVA,QAA0B,UAAU,IAAY;;EAavC,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEvC;EACA;EAET,YAAY,OAA6CC,SAAoC;AAC5F,UAAM,OAAOA,OAAM;AACnB,SAAK,eAAeA,QAAO;AAC3B,SAAK,YAAYA,QAAO;EACzB;EAEA,aAAqB;AACpB,UAAM,YAAY,KAAK,cAAc,SAAY,KAAK,IAAI,KAAK,SAAS;AACxE,WAAO,OAAO,SAAS,GAAG,KAAK,eAAe,oBAAoB,EAAE;EACrE;AACD;AAUO,SAAS,KAAK,GAAyB,IAAgB,CAAC,GAAG;AACjE,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAmC,GAAG,CAAC;AAChE,SAAO,IAAI,cAAc,MAAMA,QAAO,gBAAgB,OAAOA,QAAO,SAAS;AAC9E;;;ACtDO,IAAM,qBAAN,cACE,wBAIT;EACC,QAA0B,UAAU,IAAY;EAEhD,YACC,MACA,cACA,WACC;AACD,UAAM,MAAM,QAAQ,aAAa;AACjC,SAAK,OAAO,eAAe;AAC3B,SAAK,OAAO,YAAY;EACzB;;EAGS,MACR,OAC+C;AAC/C,WAAO,IAAI,YAA6C,OAAO,KAAK,MAA8C;EACnH;AACD;AAEO,IAAM,cAAN,cAA6E,SAAY;EAC/F,QAA0B,UAAU,IAAY;EAEvC;EACA;EAET,YAAY,OAA6CC,SAAyC;AACjG,UAAM,OAAOA,OAAM;AACnB,SAAK,eAAeA,QAAO;AAC3B,SAAK,YAAYA,QAAO;EACzB;EAEA,aAAqB;AACpB,UAAM,YAAY,KAAK,cAAc,SAAY,KAAK,KAAK,KAAK,SAAS;AACzE,WAAO,YAAY,SAAS,GAAG,KAAK,eAAe,oBAAoB,EAAE;EAC1E;EAES,qBAAqB,CAAC,UAA+B;AAC7D,WAAO,IAAI,KAAK,KAAK,eAAe,QAAQ,QAAQ,OAAO;EAC5D;EAES,mBAAmB,CAAC,UAAwB;AACpD,WAAO,MAAM,YAAY;EAC1B;AACD;AAWO,IAAM,2BAAN,cACE,wBAIT;EACC,QAA0B,UAAU,IAAY;EAEhD,YACC,MACA,cACA,WACC;AACD,UAAM,MAAM,UAAU,mBAAmB;AACzC,SAAK,OAAO,eAAe;AAC3B,SAAK,OAAO,YAAY;EACzB;;EAGS,MACR,OACqD;AACrD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,oBAAN,cAA2F,SAAY;EAC7G,QAA0B,UAAU,IAAY;EAEvC;EACA;EAET,YAAY,OAA6CA,SAA+C;AACvG,UAAM,OAAOA,OAAM;AACnB,SAAK,eAAeA,QAAO;AAC3B,SAAK,YAAYA,QAAO;EACzB;EAEA,aAAqB;AACpB,UAAM,YAAY,KAAK,cAAc,SAAY,KAAK,IAAI,KAAK,SAAS;AACxE,WAAO,YAAY,SAAS,GAAG,KAAK,eAAe,oBAAoB,EAAE;EAC1E;AACD;AAkBO,SAAS,UAAU,GAAgC,IAAuB,CAAC,GAAG;AACpF,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAsD,GAAG,CAAC;AACnF,MAAIA,SAAQ,SAAS,UAAU;AAC9B,WAAO,IAAI,yBAAyB,MAAMA,QAAO,gBAAgB,OAAOA,QAAO,SAAS;EACzF;AACA,SAAO,IAAI,mBAAmB,MAAMA,SAAQ,gBAAgB,OAAOA,SAAQ,SAAS;AACrF;;;ACnIO,IAAM,gBAAN,cAAmF,gBAAmB;EAC5G,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiB;AAC5B,UAAM,MAAM,UAAU,QAAQ;EAC/B;;;;EAKA,gBAA6C;AAC5C,WAAO,KAAK,QAAQ,sBAAsB;EAC3C;;EAGS,MACR,OAC0C;AAC1C,WAAO,IAAI,OAAwC,OAAO,KAAK,MAA8C;EAC9G;AACD;AAEO,IAAM,SAAN,cAAqE,SAAY;EACvF,QAA0B,UAAU,IAAY;EAEhD,aAAqB;AACpB,WAAO;EACR;AACD;AAIO,SAAS,KAAK,MAAe;AACnC,SAAO,IAAI,cAAc,QAAQ,EAAE;AACpC;;;AClCO,IAAM,mBAAN,cAAyF,gBAG9F;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAiBC,SAA0C;AACtE,UAAM,MAAM,UAAU,WAAW;AACjC,SAAK,OAAO,SAASA,QAAO;AAC5B,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OAC6C;AAC7C,WAAO,IAAI,UAA2C,OAAO,KAAK,MAA8C;EACjH;AACD;AAEO,IAAM,YAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,SAAS,KAAK,OAAO;EACZ,aAAa,KAAK,OAAO;EAE3C,aAAqB;AACpB,WAAO,KAAK,WAAW,SAAY,YAAY,WAAW,KAAK,MAAM;EACtE;AACD;AAiBO,SAAS,QAAQ,GAA8B,IAAqB,CAAC,GAAQ;AACnF,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAwC,GAAG,CAAC;AACrE,SAAO,IAAI,iBAAiB,MAAMA,OAAa;AAChD;;;ACnDO,IAAM,wBAAN,cACE,gBAIT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAcC,SAA8B;AACvD,UAAM,MAAM,UAAU,gBAAgB;AACtC,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OACkD;AAClD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,iBAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,aAAa,KAAK,OAAO;EAElC,aAAqB;AACpB,WAAO,OAAO,KAAK,UAAU;EAC9B;AACD;AAaO,SAAS,IAAI,GAAkC,GAA0B;AAC/E,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAA6C,GAAG,CAAC;AAC1E,SAAO,IAAI,sBAAsB,MAAMA,OAAM;AAC9C;;;AClDO,IAAM,sBAAN,cAA8F,gBAGnG;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAcC,SAA4B;AACrD,UAAM,MAAM,SAAS,cAAc;AACnC,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OACgD;AAChD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,eAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,aAAa,KAAK,OAAO;EAElC,aAAqB;AACpB,WAAO,WAAW,KAAK,UAAU;EAClC;EAES,iBAAiB,OAAyB;AAClD,WAAO,KAAK,UAAU,KAAK;EAC5B;EAES,mBAAmB,OAAwB;AACnD,WAAO,MACL,MAAM,GAAG,EAAE,EACX,MAAM,GAAG,EACT,IAAI,CAAC,MAAM,OAAO,WAAW,CAAC,CAAC;EAClC;AACD;AAaO,SAAS,QAAQ,GAAgC,GAAwB;AAC/E,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAA2C,GAAG,CAAC;AACxE,SAAO,IAAI,oBAAoB,MAAMA,OAAM;AAC5C;;;AC3DO,IAAM,wBAAN,cACE,gBAIT;EACC,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAcC,SAA8B;AACvD,UAAM,MAAM,UAAU,gBAAgB;AACtC,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OACkD;AAClD,WAAO,IAAI;MACV;MACA,KAAK;IACN;EACD;AACD;AAEO,IAAM,iBAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,aAAa,KAAK,OAAO;EAElC,aAAqB;AACpB,WAAO,aAAa,KAAK,UAAU;EACpC;AACD;AAaO,SAAS,UAAU,GAAkC,GAA0B;AACrF,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAA6C,GAAG,CAAC;AAC1E,SAAO,IAAI,sBAAsB,MAAMA,OAAM;AAC9C;;;AClDO,IAAM,kBAAN,cAAsF,gBAG3F;EACD,QAA0B,UAAU,IAAY;EAEhD,YAAY,MAAcC,SAAwB;AACjD,UAAM,MAAM,SAAS,UAAU;AAC/B,SAAK,OAAO,aAAaA,QAAO;EACjC;;EAGS,MACR,OAC4C;AAC5C,WAAO,IAAI,SAA0C,OAAO,KAAK,MAA8C;EAChH;AACD;AAEO,IAAM,WAAN,cACE,SACT;EACC,QAA0B,UAAU,IAAY;EAEvC,aAAa,KAAK,OAAO;EAElC,aAAqB;AACpB,WAAO,UAAU,KAAK,UAAU;EACjC;EAES,iBAAiB,OAAyB;AAClD,WAAO,KAAK,UAAU,KAAK;EAC5B;EAES,mBAAmB,OAAwB;AACnD,WAAO,MACL,MAAM,GAAG,EAAE,EACX,MAAM,GAAG,EACT,IAAI,CAAC,MAAM,OAAO,WAAW,CAAC,CAAC;EAClC;AACD;AAaO,SAAS,OAAO,GAA4B,GAAoB;AACtE,QAAM,EAAE,MAAM,QAAAA,QAAO,IAAI,uBAAuC,GAAG,CAAC;AACpE,SAAO,IAAI,gBAAgB,MAAMA,OAAM;AACxC;;;ACvCO,SAAS,sBAAsB;AACrC,SAAO;IACN;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACD;AACD;;;ACxCO,IAAM,oBAAoB,uBAAO,IAAI,6BAA6B;AAElE,IAAM,YAAY,uBAAO,IAAI,mBAAmB;AAEhD,IAAM,UAAN,cAA2D,MAAS;EAC1E,QAA0B,UAAU,IAAY;;EAGhD,OAAyB,SAAS,OAAO,OAAO,CAAC,GAAG,MAAM,QAAQ;IACjE;IACA;EACD,CAAC;;EAGD,CAAC,iBAAiB,IAAkB,CAAC;;EAGrC,CAAC,SAAS,IAAa;;EAGvB,CAAU,MAAM,OAAO,kBAAkB,IACxC;AACF;AAiBO,SAAS,kBAKf,MACA,SACA,aAGA,QACA,WAAW,MAMT;AACF,QAAM,WAAW,IAAI,QAKlB,MAAM,QAAQ,QAAQ;AAEzB,QAAM,gBAA6B,OAAO,YAAY,aAAa,QAAQ,oBAAoB,CAAC,IAAI;AAEpG,QAAM,eAAe,OAAO;IAC3B,OAAO,QAAQ,aAAa,EAAE,IAAI,CAAC,CAACC,OAAM,cAAc,MAAM;AAC7D,YAAM,aAAa;AACnB,iBAAW,QAAQA,KAAI;AACvB,YAAM,SAAS,WAAW,MAAM,QAAQ;AACxC,eAAS,iBAAiB,EAAE,KAAK,GAAG,WAAW,iBAAiB,QAAQ,QAAQ,CAAC;AACjF,aAAO,CAACA,OAAM,MAAM;IACrB,CAAC;EACF;AAEA,QAAM,6BAA6B,OAAO;IACzC,OAAO,QAAQ,aAAa,EAAE,IAAI,CAAC,CAACA,OAAM,cAAc,MAAM;AAC7D,YAAM,aAAa;AACnB,iBAAW,QAAQA,KAAI;AACvB,YAAM,SAAS,WAAW,uBAAuB,QAAQ;AACzD,aAAO,CAACA,OAAM,MAAM;IACrB,CAAC;EACF;AAEA,QAAM,QAAQ,OAAO,OAAO,UAAU,YAAY;AAElD,QAAM,MAAM,OAAO,OAAO,IAAI;AAC9B,QAAM,MAAM,OAAO,kBAAkB,IAAI;AAEzC,MAAI,aAAa;AAChB,UAAM,QAAQ,OAAO,kBAAkB,IAAI;EAC5C;AAEA,SAAO,OAAO,OAAO,OAAO;IAC3B,WAAW,MAAM;AAChB,YAAM,QAAQ,OAAO,SAAS,IAAI;AAClC,aAAO;IAMR;EACD,CAAC;AACF;AAsEO,IAAM,UAAqB,CAAC,MAAM,SAAS,gBAAgB;AACjE,SAAO,kBAAkB,MAAM,SAAS,aAAa,MAAS;AAC/D;;;ACrLO,IAAM,oBAAN,MAAwB;EAC9B,QAAiB,UAAU,IAAY;;EAGvC;;EAGA;EAEA,YACC,SACA,MACC;AACD,SAAK,UAAU;AACf,SAAK,OAAO;EACb;;EAGA,MAAM,OAA4B;AACjC,WAAO,IAAI,WAAW,OAAO,KAAK,SAAS,KAAK,IAAI;EACrD;AACD;AAEO,IAAM,aAAN,MAAiB;EAMvB,YAAqB,OAAgB,SAA4B,MAAe;AAA3D,SAAA,QAAA;AACpB,SAAK,UAAU;AACf,SAAK,OAAO;EACb;EARA,QAAiB,UAAU,IAAY;EAE9B;EACA;EAOT,UAAkB;AACjB,WAAO,KAAK,QAAQ,GAAG,KAAK,MAAM,QAAQ,OAAO,IAAI,CAAC,IAAI,KAAK,QAAQ,IAAI,CAAC,WAAW,OAAO,IAAI,EAAE,KAAK,GAAG,CAAC;EAC9G;AACD;;;AC7CO,SAAS,YAAY,OAAgB,QAA8B;AACzE,MACC,qBAAqB,MAAM,KACxB,CAAC,aAAa,KAAK,KACnB,CAAC,GAAG,OAAO,KAAK,KAChB,CAAC,GAAG,OAAO,WAAW,KACtB,CAAC,GAAG,OAAO,MAAM,KACjB,CAAC,GAAG,OAAO,KAAK,KAChB,CAAC,GAAG,OAAO,IAAI,GACjB;AACD,WAAO,IAAI,MAAM,OAAO,MAAM;EAC/B;AACA,SAAO;AACR;AAgCO,IAAM,KAAqB,CAAC,MAAkB,UAAwB;AAC5E,SAAO,MAAM,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC;AAChD;AAoBO,IAAM,KAAqB,CAAC,MAAkB,UAAwB;AAC5E,SAAO,MAAM,IAAI,OAAO,YAAY,OAAO,IAAI,CAAC;AACjD;AAmBO,SAAS,OACZ,sBACe;AAClB,QAAM,aAAa,qBAAqB;IACvC,CAAC,MAAyC,MAAM;EACjD;AAEA,MAAI,WAAW,WAAW,GAAG;AAC5B,WAAO;EACR;AAEA,MAAI,WAAW,WAAW,GAAG;AAC5B,WAAO,IAAI,IAAI,UAAU;EAC1B;AAEA,SAAO,IAAI,IAAI;IACd,IAAI,YAAY,GAAG;IACnB,IAAI,KAAK,YAAY,IAAI,YAAY,OAAO,CAAC;IAC7C,IAAI,YAAY,GAAG;EACpB,CAAC;AACF;AAmBO,SAAS,MACZ,sBACe;AAClB,QAAM,aAAa,qBAAqB;IACvC,CAAC,MAAyC,MAAM;EACjD;AAEA,MAAI,WAAW,WAAW,GAAG;AAC5B,WAAO;EACR;AAEA,MAAI,WAAW,WAAW,GAAG;AAC5B,WAAO,IAAI,IAAI,UAAU;EAC1B;AAEA,SAAO,IAAI,IAAI;IACd,IAAI,YAAY,GAAG;IACnB,IAAI,KAAK,YAAY,IAAI,YAAY,MAAM,CAAC;IAC5C,IAAI,YAAY,GAAG;EACpB,CAAC;AACF;AAaO,SAAS,IAAI,WAA4B;AAC/C,SAAO,UAAU,SAAS;AAC3B;AAgBO,IAAM,KAAqB,CAAC,MAAkB,UAAwB;AAC5E,SAAO,MAAM,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC;AAChD;AAkBO,IAAM,MAAsB,CAAC,MAAkB,UAAwB;AAC7E,SAAO,MAAM,IAAI,OAAO,YAAY,OAAO,IAAI,CAAC;AACjD;AAgBO,IAAM,KAAqB,CAAC,MAAkB,UAAwB;AAC5E,SAAO,MAAM,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC;AAChD;AAgBO,IAAM,MAAsB,CAAC,MAAkB,UAAwB;AAC7E,SAAO,MAAM,IAAI,OAAO,YAAY,OAAO,IAAI,CAAC;AACjD;AA4BO,SAAS,QACf,QACA,QACM;AACN,MAAI,MAAM,QAAQ,MAAM,GAAG;AAC1B,QAAI,OAAO,WAAW,GAAG;AACxB,aAAO;IACR;AACA,WAAO,MAAM,MAAM,OAAO,OAAO,IAAI,CAAC,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC;EACpE;AAEA,SAAO,MAAM,MAAM,OAAO,YAAY,QAAQ,MAAM,CAAC;AACtD;AA6BO,SAAS,WACf,QACA,QACM;AACN,MAAI,MAAM,QAAQ,MAAM,GAAG;AAC1B,QAAI,OAAO,WAAW,GAAG;AACxB,aAAO;IACR;AACA,WAAO,MAAM,MAAM,WAAW,OAAO,IAAI,CAAC,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC;EACxE;AAEA,SAAO,MAAM,MAAM,WAAW,YAAY,QAAQ,MAAM,CAAC;AAC1D;AAkBO,SAAS,OAAO,OAAwB;AAC9C,SAAO,MAAM,KAAK;AACnB;AAkBO,SAAS,UAAU,OAAwB;AACjD,SAAO,MAAM,KAAK;AACnB;AAsBO,SAAS,OAAO,UAA2B;AACjD,SAAO,aAAa,QAAQ;AAC7B;AAuBO,SAAS,UAAU,UAA2B;AACpD,SAAO,iBAAiB,QAAQ;AACjC;AAoCO,SAAS,QAAQ,QAAoBC,MAAcC,MAAmB;AAC5E,SAAO,MAAM,MAAM,YAAY,YAAYD,MAAK,MAAM,CAAC,QACtD;IACCC;IACA;EACD,CACD;AACD;AAkCO,SAAS,WACf,QACAD,MACAC,MACM;AACN,SAAO,MAAM,MAAM,gBAClB;IACCD;IACA;EACD,CACD,QAAQ,YAAYC,MAAK,MAAM,CAAC;AACjC;AAkBO,SAAS,KAAK,QAAoC,OAAiC;AACzF,SAAO,MAAM,MAAM,SAAS,KAAK;AAClC;AAoBO,SAAS,QAAQ,QAAoC,OAAiC;AAC5F,SAAO,MAAM,MAAM,aAAa,KAAK;AACtC;AAqBO,SAAS,MAAM,QAAoC,OAAiC;AAC1F,SAAO,MAAM,MAAM,UAAU,KAAK;AACnC;AAoBO,SAAS,SAAS,QAAoC,OAAiC;AAC7F,SAAO,MAAM,MAAM,cAAc,KAAK;AACvC;;;AC/jBO,SAAS,IAAI,QAAqC;AACxD,SAAO,MAAM,MAAM;AACpB;AAkBO,SAAS,KAAK,QAAqC;AACzD,SAAO,MAAM,MAAM;AACpB;;;ACZO,IAAe,WAAf,MAA4D;EAOlE,YACU,aACA,iBACA,cACR;AAHQ,SAAA,cAAA;AACA,SAAA,kBAAA;AACA,SAAA,eAAA;AAET,SAAK,sBAAsB,gBAAgB,MAAM,OAAO,IAAI;EAC7D;EAZA,QAAiB,UAAU,IAAY;EAG9B;EACT;AAWD;AAEO,IAAM,YAAN,MAGL;EAKD,YACU,OACAC,SACR;AAFQ,SAAA,QAAA;AACA,SAAA,SAAAA;EACP;EAPH,QAAiB,UAAU,IAAY;AAQxC;AAEO,IAAM,MAAN,MAAM,aAGH,SAAqB;EAK9B,YACC,aACA,iBACSA,SAOA,YACR;AACD,UAAM,aAAa,iBAAiBA,SAAQ,YAAY;AAT/C,SAAA,SAAAA;AAOA,SAAA,aAAA;EAGV;EAjBA,QAA0B,UAAU,IAAY;EAmBhD,cAAc,WAAoC;AACjD,UAAM,WAAW,IAAI;MACpB,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;IACN;AACA,aAAS,YAAY;AACrB,WAAO;EACR;AACD;AAEO,IAAM,OAAN,MAAM,cAAwC,SAAqB;EAKzE,YACC,aACA,iBACSA,SACR;AACD,UAAM,aAAa,iBAAiBA,SAAQ,YAAY;AAF/C,SAAA,SAAAA;EAGV;EAVA,QAA0B,UAAU,IAAY;EAYhD,cAAc,WAAqC;AAClD,UAAM,WAAW,IAAI;MACpB,KAAK;MACL,KAAK;MACL,KAAK;IACN;AACA,aAAS,YAAY;AACrB,WAAO;EACR;AACD;AAqCO,SAAS,eAAe;AAC9B,SAAO;IACN;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACD;AACD;AAIO,SAAS,sBAAsB;AACrC,SAAO;IACN;IACA;IACA;EACD;AACD;AAuNO,SAAS,8BAGf,QACA,eAC6D;AAC7D,MACC,OAAO,KAAK,MAAM,EAAE,WAAW,KAC5B,aAAa,UACb,CAAC,GAAG,OAAO,SAAS,GAAG,KAAK,GAC9B;AACD,aAAS,OAAO,SAAS;EAC1B;AAGA,QAAM,gBAAwC,CAAC;AAE/C,QAAM,kBAGF,CAAC;AACL,QAAM,eAAuC,CAAC;AAC9C,aAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,MAAM,GAAG;AAClD,QAAI,GAAG,OAAO,KAAK,GAAG;AACrB,YAAM,SAAS,mBAAmB,KAAK;AACvC,YAAM,oBAAoB,gBAAgB,MAAM;AAChD,oBAAc,MAAM,IAAI;AACxB,mBAAa,GAAG,IAAI;QACnB,QAAQ;QACR,QAAQ,MAAM,MAAM,OAAO,IAAI;QAC/B,QAAQ,MAAM,MAAM,OAAO,MAAM;QACjC,SAAS,MAAM,MAAM,OAAO,OAAO;QACnC,WAAW,mBAAmB,aAAa,CAAC;QAC5C,YAAY,mBAAmB,cAAc,CAAC;MAC/C;AAGA,iBACO,UAAU,OAAO;QACrB,MAAgB,MAAM,OAAO,OAAO;MACtC,GACC;AACD,YAAI,OAAO,SAAS;AACnB,uBAAa,GAAG,EAAG,WAAW,KAAK,MAAM;QAC1C;MACD;AAEA,YAAM,cAAc,MAAM,MAAM,OAAO,kBAAkB,IAAK,MAAgB,MAAM,OAAO,kBAAkB,CAAC;AAC9G,UAAI,aAAa;AAChB,mBAAW,eAAe,OAAO,OAAO,WAAW,GAAG;AACrD,cAAI,GAAG,aAAa,iBAAiB,GAAG;AACvC,yBAAa,GAAG,EAAG,WAAW,KAAK,GAAG,YAAY,OAAO;UAC1D;QACD;MACD;IACD,WAAW,GAAG,OAAO,SAAS,GAAG;AAChC,YAAM,SAAS,mBAAmB,MAAM,KAAK;AAC7C,YAAM,YAAY,cAAc,MAAM;AACtC,YAAMC,aAAsC,MAAM;QACjD,cAAc,MAAM,KAAK;MAC1B;AACA,UAAI;AAEJ,iBAAW,CAAC,cAAc,QAAQ,KAAK,OAAO,QAAQA,UAAS,GAAG;AACjE,YAAI,WAAW;AACd,gBAAM,cAAc,aAAa,SAAS;AAC1C,sBAAY,UAAU,YAAY,IAAI;AACtC,cAAI,YAAY;AACf,wBAAY,WAAW,KAAK,GAAG,UAAU;UAC1C;QACD,OAAO;AACN,cAAI,EAAE,UAAU,kBAAkB;AACjC,4BAAgB,MAAM,IAAI;cACzB,WAAW,CAAC;cACZ;YACD;UACD;AACA,0BAAgB,MAAM,EAAG,UAAU,YAAY,IAAI;QACpD;MACD;IACD;EACD;AAEA,SAAO,EAAE,QAAQ,cAAyB,cAAc;AACzD;AAEO,SAAS,UAIf,OACAA,YACoC;AACpC,SAAO,IAAI;IACV;IACA,CAAC,YACA,OAAO;MACN,OAAO,QAAQA,WAAU,OAAO,CAAC,EAAE,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM;QACxD;QACA,MAAM,cAAc,GAAG;MACxB,CAAC;IACF;EACF;AACD;AAEO,SAAS,UAAqC,aAAoB;AACxE,SAAO,SAAS,IAOf,OACAD,SAIC;AACD,WAAO,IAAI;MACV;MACA;MACAA;MACCA,SAAQ,OAAO,OAAgB,CAAC,KAAK,MAAM,OAAO,EAAE,SAAS,IAAI,KAC9D;IACL;EACD;AACD;AAEO,SAAS,WAAW,aAAoB;AAC9C,SAAO,SAAS,KACf,iBACAA,SACmC;AACnC,WAAO,IAAI,KAAK,aAAa,iBAAiBA,OAAM;EACrD;AACD;AAOO,SAAS,kBACf,QACA,eACA,UACqB;AACrB,MAAI,GAAG,UAAU,GAAG,KAAK,SAAS,QAAQ;AACzC,WAAO;MACN,QAAQ,SAAS,OAAO;MACxB,YAAY,SAAS,OAAO;IAC7B;EACD;AAEA,QAAM,wBAAwB,cAAc,mBAAmB,SAAS,eAAe,CAAC;AACxF,MAAI,CAAC,uBAAuB;AAC3B,UAAM,IAAI;MACT,UAAU,SAAS,gBAAgB,MAAM,OAAO,IAAI,CAAC;IACtD;EACD;AAEA,QAAM,wBAAwB,OAAO,qBAAqB;AAC1D,MAAI,CAAC,uBAAuB;AAC3B,UAAM,IAAI,MAAM,UAAU,qBAAqB,uBAAuB;EACvE;AAEA,QAAM,cAAc,SAAS;AAC7B,QAAM,oBAAoB,cAAc,mBAAmB,WAAW,CAAC;AACvE,MAAI,CAAC,mBAAmB;AACvB,UAAM,IAAI;MACT,UAAU,YAAY,MAAM,OAAO,IAAI,CAAC;IACzC;EACD;AAEA,QAAM,mBAA+B,CAAC;AACtC,aACO,2BAA2B,OAAO;IACvC,sBAAsB;EACvB,GACC;AACD,QACE,SAAS,gBACN,aAAa,2BACb,wBAAwB,iBAAiB,SAAS,gBAClD,CAAC,SAAS,gBACV,wBAAwB,oBAAoB,SAAS,aACxD;AACD,uBAAiB,KAAK,uBAAuB;IAC9C;EACD;AAEA,MAAI,iBAAiB,SAAS,GAAG;AAChC,UAAM,SAAS,eACZ,IAAI;MACL,2CAA2C,SAAS,YAAY,eAAe,qBAAqB;IACrG,IACE,IAAI;MACL,yCAAyC,qBAAqB,UAC7D,SAAS,YAAY,MAAM,OAAO,IAAI,CACvC;IACD;EACF;AAEA,MACC,iBAAiB,CAAC,KACf,GAAG,iBAAiB,CAAC,GAAG,GAAG,KAC3B,iBAAiB,CAAC,EAAE,QACtB;AACD,WAAO;MACN,QAAQ,iBAAiB,CAAC,EAAE,OAAO;MACnC,YAAY,iBAAiB,CAAC,EAAE,OAAO;IACxC;EACD;AAEA,QAAM,IAAI;IACT,sDAAsD,iBAAiB,IAAI,SAAS,SAAS;EAC9F;AACD;AAEO,SAAS,4BACf,aACC;AACD,SAAO;IACN,KAAK,UAAsB,WAAW;IACtC,MAAM,WAAW,WAAW;EAC7B;AACD;AAuBO,SAAS,iBACf,cACA,aACA,KACA,2BACA,iBAA8C,CAAC,UAAU,OAC/B;AAC1B,QAAM,SAAkC,CAAC;AAEzC,aACO;IACL;IACA;EACD,KAAK,0BAA0B,QAAQ,GACtC;AACD,QAAI,cAAc,QAAQ;AACzB,YAAM,WAAW,YAAY,UAAU,cAAc,KAAK;AAC1D,YAAM,aAAa,IAAI,kBAAkB;AAKzC,YAAM,UAAU,OAAO,eAAe,WAClC,KAAK,MAAM,UAAU,IACtB;AACH,aAAO,cAAc,KAAK,IAAI,GAAG,UAAU,GAAG,IAC3C,WACE;QACF;QACA,aAAa,cAAc,kBAAmB;QAC9C;QACA,cAAc;QACd;MACD,IACE,QAAwB;QAAI,CAAC,WAC/B;UACC;UACA,aAAa,cAAc,kBAAmB;UAC9C;UACA,cAAc;UACd;QACD;MACD;IACF,OAAO;AACN,YAAM,QAAQ,eAAe,IAAI,kBAAkB,CAAC;AACpD,YAAM,QAAQ,cAAc;AAC5B,UAAI;AACJ,UAAI,GAAG,OAAO,MAAM,GAAG;AACtB,kBAAU;MACX,WAAW,GAAG,OAAO,GAAG,GAAG;AAC1B,kBAAU,MAAM;MACjB,OAAO;AACN,kBAAU,MAAM,IAAI;MACrB;AACA,aAAO,cAAc,KAAK,IAAI,UAAU,OAAO,OAAO,QAAQ,mBAAmB,KAAK;IACvF;EACD;AAEA,SAAO;AACR;;;AC1sBO,IAAe,aAAf,cAIG,KAAwC;EACjD,QAA0B,UAAU,IAAY;AAKjD;;;ACiDO,IAAM,YAAN,MAAgB;EACtB,QAAiB,UAAU,IAAY;;EAG9B;EAET,YAAYE,SAA0B;AACrC,SAAK,SAAS,IAAI,YAAYA,SAAQ,MAAM;EAC7C;EAEA,MAAM,QAAQ,YAA6B,SAAoBA,SAAiD;AAC/G,UAAM,kBAAkB,OAAOA,YAAW,WACvC,yBACAA,QAAO,mBAAmB;AAC7B,UAAM,mBAAmB,OAAOA,YAAW,WAAW,YAAYA,QAAO,oBAAoB;AAC7F,UAAM,uBAAuB;gCACC,IAAI,WAAW,gBAAgB,CAAC,IAAI,IAAI,WAAW,eAAe,CAAC;;;;;;AAMjG,UAAM,QAAQ,QAAQ,kCAAkC,IAAI,WAAW,gBAAgB,CAAC,EAAE;AAC1F,UAAM,QAAQ,QAAQ,oBAAoB;AAE1C,UAAM,eAAe,MAAM,QAAQ;MAClC,uCAAuC,IAAI,WAAW,gBAAgB,CAAC,IACtE,IAAI,WAAW,eAAe,CAC/B;IACD;AAEA,UAAM,kBAAkB,aAAa,CAAC;AACtC,UAAM,QAAQ,YAAY,OAAO,OAAO;AACvC,uBAAiB,aAAa,YAAY;AACzC,YACC,CAAC,mBACE,OAAO,gBAAgB,UAAU,IAAI,UAAU,cACjD;AACD,qBAAW,QAAQ,UAAU,KAAK;AACjC,kBAAM,GAAG,QAAQ,IAAI,IAAI,IAAI,CAAC;UAC/B;AACA,gBAAM,GAAG;YACR,kBAAkB,IAAI,WAAW,gBAAgB,CAAC,IACjD,IAAI,WAAW,eAAe,CAC/B,kCAAkC,UAAU,IAAI,KAAK,UAAU,YAAY;UAC5E;QACD;MACD;IACD,CAAC;EACF;EAEA,WAAW,MAAsB;AAChC,WAAO,IAAI,IAAI;EAChB;EAEA,YAAY,KAAqB;AAChC,WAAO,IAAI,MAAM,CAAC;EACnB;EAEA,aAAa,KAAqB;AACjC,WAAO,IAAI,IAAI,QAAQ,MAAM,IAAI,CAAC;EACnC;EAEQ,aAAa,SAAkD;AACtE,QAAI,CAAC,SAAS;AAAQ,aAAO;AAE7B,UAAM,gBAAgB,CAAC,UAAU;AACjC,eAAW,CAAC,GAAG,CAAC,KAAK,QAAQ,QAAQ,GAAG;AACvC,oBAAc,KAAK,MAAM,IAAI,WAAW,EAAE,EAAE,KAAK,CAAC,QAAQ,EAAE,EAAE,GAAG,GAAG;AACpE,UAAI,IAAI,QAAQ,SAAS,GAAG;AAC3B,sBAAc,KAAK,OAAO;MAC3B;IACD;AACA,kBAAc,KAAK,MAAM;AACzB,WAAO,IAAI,KAAK,aAAa;EAC9B;EAEA,iBAAiB,EAAE,OAAO,OAAO,WAAW,SAAS,GAAwB;AAC5E,UAAM,UAAU,KAAK,aAAa,QAAQ;AAE1C,UAAM,eAAe,YAClB,iBAAiB,KAAK,eAAe,WAAW,EAAE,eAAe,KAAK,CAAC,CAAC,KACxE;AAEH,UAAM,WAAW,QAAQ,aAAa,KAAK,KAAK;AAEhD,WAAO,MAAM,OAAO,eAAe,KAAK,GAAG,QAAQ,GAAG,YAAY;EACnE;EAEA,eAAe,OAAgB,KAAqB;AACnD,UAAM,eAAe,MAAM,MAAM,OAAO,OAAO;AAE/C,UAAM,cAAc,OAAO,KAAK,YAAY,EAAE;MAAO,CAAC,YACrD,IAAI,OAAO,MAAM,UAAa,aAAa,OAAO,GAAG,eAAe;IACrE;AAEA,UAAM,UAAU,YAAY;AAC5B,WAAO,IAAI,KAAK,YAAY,QAAQ,CAAC,SAAS,MAAM;AACnD,YAAM,MAAM,aAAa,OAAO;AAEhC,YAAM,QAAQ,IAAI,OAAO,KAAK,IAAI,MAAM,IAAI,WAAY,GAAG,GAAG;AAC9D,YAAM,MAAM,MAAM,IAAI,WAAW,KAAK,OAAO,gBAAgB,GAAG,CAAC,CAAC,MAAM,KAAK;AAE7E,UAAI,IAAI,UAAU,GAAG;AACpB,eAAO,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC;MAC3B;AACA,aAAO,CAAC,GAAG;IACZ,CAAC,CAAC;EACH;EAEA,iBAAiB,EAAE,OAAO,KAAK,OAAO,WAAW,UAAU,MAAM,MAAM,GAAwB;AAC9F,UAAM,UAAU,KAAK,aAAa,QAAQ;AAE1C,UAAM,YAAY,MAAM,QAAQ,OAAO,IAAI;AAC3C,UAAM,cAAc,MAAM,QAAQ,OAAO,MAAM;AAC/C,UAAM,gBAAgB,MAAM,QAAQ,OAAO,YAAY;AACvD,UAAM,QAAQ,cAAc,gBAAgB,SAAY;AACxD,UAAM,WAAW,MAAM,cAAc,MAAM,IAAI,WAAW,WAAW,CAAC,MAAM,MAAS,GACpF,IAAI,WAAW,aAAa,CAC7B,GAAG,SAAS,OAAO,IAAI,WAAW,KAAK,CAAC,EAAE;AAE1C,UAAM,SAAS,KAAK,eAAe,OAAO,GAAG;AAE7C,UAAM,UAAU,QAAQ,IAAI,KAAK,CAAC,IAAI,IAAI,QAAQ,GAAG,KAAK,eAAe,IAAI,CAAC,CAAC;AAE/E,UAAM,WAAW,KAAK,WAAW,KAAK;AAEtC,UAAM,eAAe,YAClB,iBAAiB,KAAK,eAAe,WAAW,EAAE,eAAe,CAAC,KAAK,CAAC,CAAC,KACzE;AAEH,UAAM,WAAW,QAAQ,aAAa,KAAK,KAAK;AAEhD,WAAO,MAAM,OAAO,UAAU,QAAQ,QAAQ,MAAM,GAAG,OAAO,GAAG,QAAQ,GAAG,QAAQ,GAAG,YAAY;EACpG;;;;;;;;;;;;EAaQ,eACP,QACA,EAAE,gBAAgB,MAAM,IAAiC,CAAC,GACpD;AACN,UAAM,aAAa,OAAO;AAE1B,UAAM,SAAS,OACb,QAAQ,CAAC,EAAE,MAAM,GAAG,MAAM;AAC1B,YAAM,QAAoB,CAAC;AAE3B,UAAI,GAAG,OAAO,IAAI,OAAO,KAAK,MAAM,kBAAkB;AACrD,cAAM,KAAK,IAAI,WAAW,MAAM,UAAU,CAAC;MAC5C,WAAW,GAAG,OAAO,IAAI,OAAO,KAAK,GAAG,OAAO,GAAG,GAAG;AACpD,cAAM,QAAQ,GAAG,OAAO,IAAI,OAAO,IAAI,MAAM,MAAM;AAEnD,YAAI,eAAe;AAClB,gBAAM;YACL,IAAI;cACH,MAAM,YAAY,IAAI,CAAC,MAAM;AAC5B,oBAAI,GAAG,GAAG,QAAQ,GAAG;AACpB,yBAAO,IAAI,WAAW,KAAK,OAAO,gBAAgB,CAAC,CAAC;gBACrD;AACA,uBAAO;cACR,CAAC;YACF;UACD;QACD,OAAO;AACN,gBAAM,KAAK,KAAK;QACjB;AAEA,YAAI,GAAG,OAAO,IAAI,OAAO,GAAG;AAC3B,gBAAM,KAAK,UAAU,IAAI,WAAW,MAAM,UAAU,CAAC,EAAE;QACxD;MACD,WAAW,GAAG,OAAO,MAAM,GAAG;AAC7B,YAAI,eAAe;AAClB,gBAAM,KAAK,IAAI,WAAW,KAAK,OAAO,gBAAgB,KAAK,CAAC,CAAC;QAC9D,OAAO;AACN,gBAAM,KAAK,KAAK;QACjB;MACD;AAEA,UAAI,IAAI,aAAa,GAAG;AACvB,cAAM,KAAK,OAAO;MACnB;AAEA,aAAO;IACR,CAAC;AAEF,WAAO,IAAI,KAAK,MAAM;EACvB;EAEQ,WAAW,OAA0D;AAC5E,QAAI,CAAC,SAAS,MAAM,WAAW,GAAG;AACjC,aAAO;IACR;AAEA,UAAM,aAAoB,CAAC;AAE3B,eAAW,CAACC,QAAO,QAAQ,KAAK,MAAM,QAAQ,GAAG;AAChD,UAAIA,WAAU,GAAG;AAChB,mBAAW,KAAK,MAAM;MACvB;AACA,YAAM,QAAQ,SAAS;AACvB,YAAM,aAAa,SAAS,UAAU,gBAAgB;AAEtD,UAAI,GAAG,OAAO,OAAO,GAAG;AACvB,cAAM,YAAY,MAAM,QAAQ,OAAO,IAAI;AAC3C,cAAM,cAAc,MAAM,QAAQ,OAAO,MAAM;AAC/C,cAAM,gBAAgB,MAAM,QAAQ,OAAO,YAAY;AACvD,cAAM,QAAQ,cAAc,gBAAgB,SAAY,SAAS;AACjE,mBAAW;UACV,MAAM,IAAI,IAAI,SAAS,QAAQ,CAAC,QAAQ,UAAU,IACjD,cAAc,MAAM,IAAI,WAAW,WAAW,CAAC,MAAM,MACtD,GAAG,IAAI,WAAW,aAAa,CAAC,GAAG,SAAS,OAAO,IAAI,WAAW,KAAK,CAAC,EAAE,OAAO,SAAS,EAAE;QAC7F;MACD,WAAW,GAAG,OAAO,IAAI,GAAG;AAC3B,cAAM,WAAW,MAAM,cAAc,EAAE;AACvC,cAAM,aAAa,MAAM,cAAc,EAAE;AACzC,cAAM,eAAe,MAAM,cAAc,EAAE;AAC3C,cAAM,QAAQ,aAAa,eAAe,SAAY,SAAS;AAC/D,mBAAW;UACV,MAAM,IAAI,IAAI,SAAS,QAAQ,CAAC,QAAQ,UAAU,IACjD,aAAa,MAAM,IAAI,WAAW,UAAU,CAAC,MAAM,MACpD,GAAG,IAAI,WAAW,YAAY,CAAC,GAAG,SAAS,OAAO,IAAI,WAAW,KAAK,CAAC,EAAE,OAAO,SAAS,EAAE;QAC5F;MACD,OAAO;AACN,mBAAW;UACV,MAAM,IAAI,IAAI,SAAS,QAAQ,CAAC,QAAQ,UAAU,IAAI,KAAK,OAAO,SAAS,EAAE;QAC9E;MACD;AACA,UAAIA,SAAQ,MAAM,SAAS,GAAG;AAC7B,mBAAW,KAAK,MAAM;MACvB;IACD;AAEA,WAAO,IAAI,KAAK,UAAU;EAC3B;EAEQ,eACP,OACoD;AACpD,QAAI,GAAG,OAAO,KAAK,KAAK,MAAM,MAAM,OAAO,YAAY,MAAM,MAAM,MAAM,OAAO,IAAI,GAAG;AACtF,UAAI,WAAW,MAAM,IAAI,WAAW,MAAM,MAAM,OAAO,YAAY,CAAC,CAAC;AACrE,UAAI,MAAM,MAAM,OAAO,MAAM,GAAG;AAC/B,mBAAW,MAAM,IAAI,WAAW,MAAM,MAAM,OAAO,MAAM,CAAE,CAAC,IAAI,QAAQ;MACzE;AACA,aAAO,MAAM,QAAQ,IAAI,IAAI,WAAW,MAAM,MAAM,OAAO,IAAI,CAAC,CAAC;IAClE;AAEA,WAAO;EACR;EAEA,iBACC;IACC;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACD,GACM;AACN,UAAM,aAAa,cAAc,oBAA8B,MAAM;AACrE,eAAW,KAAK,YAAY;AAC3B,UACC,GAAG,EAAE,OAAO,MAAM,KACf,aAAa,EAAE,MAAM,KAAK,OACvB,GAAG,OAAO,QAAQ,IACpB,MAAM,EAAE,QACR,GAAG,OAAO,UAAU,IACpB,MAAM,cAAc,EAAE,OACtB,GAAG,OAAO,GAAG,IACb,SACA,aAAa,KAAK,MACnB,EAAE,CAACC,WACL,OAAO;QAAK,CAAC,EAAE,MAAM,MACpB,WAAWA,OAAM,MAAM,OAAO,OAAO,IAAI,aAAaA,MAAK,IAAIA,OAAM,MAAM,OAAO,QAAQ;MAC3F,GAAG,EAAE,MAAM,KAAK,GAChB;AACD,cAAM,YAAY,aAAa,EAAE,MAAM,KAAK;AAC5C,cAAM,IAAI;UACT,SACC,EAAE,KAAK,KAAK,IAAI,CACjB,gCAAgC,SAAS,MAAM,EAAE,MAAM,IAAI,qBAAqB,SAAS;QAC1F;MACD;IACD;AAEA,UAAM,gBAAgB,CAAC,SAAS,MAAM,WAAW;AAEjD,UAAM,UAAU,KAAK,aAAa,QAAQ;AAE1C,QAAI;AACJ,QAAI,UAAU;AACb,oBAAc,aAAa,OAAO,iBAAiB,oBAAoB,IAAI,KAAK,SAAS,IAAI,OAAO,CAAC;IACtG;AAEA,UAAM,YAAY,KAAK,eAAe,YAAY,EAAE,cAAc,CAAC;AAEnE,UAAM,WAAW,KAAK,eAAe,KAAK;AAE1C,UAAM,WAAW,KAAK,WAAW,KAAK;AAEtC,UAAM,WAAW,QAAQ,aAAa,KAAK,KAAK;AAEhD,UAAM,YAAY,SAAS,cAAc,MAAM,KAAK;AAEpD,QAAI;AACJ,QAAI,WAAW,QAAQ,SAAS,GAAG;AAClC,mBAAa,gBAAgB,IAAI,KAAK,SAAS,OAAO,CAAC;IACxD;AAEA,QAAI;AACJ,QAAI,WAAW,QAAQ,SAAS,GAAG;AAClC,mBAAa,gBAAgB,IAAI,KAAK,SAAS,OAAO,CAAC;IACxD;AAEA,UAAM,WAAW,OAAO,UAAU,YAAa,OAAO,UAAU,YAAY,SAAS,IAClF,aAAa,KAAK,KAClB;AAEH,UAAM,YAAY,SAAS,cAAc,MAAM,KAAK;AAEpD,UAAM,mBAAmB,IAAI,MAAM;AACnC,QAAI,eAAe;AAClB,YAAM,YAAY,WAAW,IAAI,IAAI,cAAc,QAAQ,CAAC;AAC5D,UAAI,cAAc,OAAO,IAAI;AAC5B,kBAAU;UACT,UACC,IAAI;YACH,MAAM,QAAQ,cAAc,OAAO,EAAE,IAAI,cAAc,OAAO,KAAK,CAAC,cAAc,OAAO,EAAE;YAC3F;UACD,CACD;QACD;MACD;AACA,UAAI,cAAc,OAAO,QAAQ;AAChC,kBAAU,OAAO,aAAa;MAC/B,WAAW,cAAc,OAAO,YAAY;AAC3C,kBAAU,OAAO,iBAAiB;MACnC;AACA,uBAAiB,OAAO,SAAS;IAClC;AACA,UAAM,aACL,MAAM,OAAO,SAAS,WAAW,IAAI,SAAS,SAAS,QAAQ,GAAG,QAAQ,GAAG,QAAQ,GAAG,UAAU,GAAG,SAAS,GAAG,UAAU,GAAG,QAAQ,GAAG,SAAS,GAAG,gBAAgB;AAEtK,QAAI,aAAa,SAAS,GAAG;AAC5B,aAAO,KAAK,mBAAmB,YAAY,YAAY;IACxD;AAEA,WAAO;EACR;EAEA,mBAAmB,YAAiB,cAAmD;AACtF,UAAM,CAAC,aAAa,GAAG,IAAI,IAAI;AAE/B,QAAI,CAAC,aAAa;AACjB,YAAM,IAAI,MAAM,kDAAkD;IACnE;AAEA,QAAI,KAAK,WAAW,GAAG;AACtB,aAAO,KAAK,uBAAuB,EAAE,YAAY,YAAY,CAAC;IAC/D;AAGA,WAAO,KAAK;MACX,KAAK,uBAAuB,EAAE,YAAY,YAAY,CAAC;MACvD;IACD;EACD;EAEA,uBAAuB;IACtB;IACA,aAAa,EAAE,MAAM,OAAO,aAAa,OAAO,SAAS,OAAO;EACjE,GAAkF;AACjF,UAAM,YAAY,OAAO,WAAW,OAAO,CAAC;AAC5C,UAAM,aAAa,OAAO,YAAY,OAAO,CAAC;AAE9C,QAAI;AACJ,QAAI,WAAW,QAAQ,SAAS,GAAG;AAClC,YAAM,gBAAyC,CAAC;AAIhD,iBAAW,iBAAiB,SAAS;AACpC,YAAI,GAAG,eAAe,QAAQ,GAAG;AAChC,wBAAc,KAAK,IAAI,WAAW,cAAc,IAAI,CAAC;QACtD,WAAW,GAAG,eAAe,GAAG,GAAG;AAClC,mBAAS,IAAI,GAAG,IAAI,cAAc,YAAY,QAAQ,KAAK;AAC1D,kBAAM,QAAQ,cAAc,YAAY,CAAC;AAEzC,gBAAI,GAAG,OAAO,QAAQ,GAAG;AACxB,4BAAc,YAAY,CAAC,IAAI,IAAI,WAAW,MAAM,IAAI;YACzD;UACD;AAEA,wBAAc,KAAK,MAAM,aAAa,EAAE;QACzC,OAAO;AACN,wBAAc,KAAK,MAAM,aAAa,EAAE;QACzC;MACD;AAEA,mBAAa,gBAAgB,IAAI,KAAK,eAAe,OAAO,CAAC;IAC9D;AAEA,UAAM,WAAW,OAAO,UAAU,YAAa,OAAO,UAAU,YAAY,SAAS,IAClF,aAAa,KAAK,KAClB;AAEH,UAAM,gBAAgB,IAAI,IAAI,GAAG,IAAI,IAAI,QAAQ,SAAS,EAAE,EAAE;AAE9D,UAAM,YAAY,SAAS,cAAc,MAAM,KAAK;AAEpD,WAAO,MAAM,SAAS,GAAG,aAAa,GAAG,UAAU,GAAG,UAAU,GAAG,QAAQ,GAAG,SAAS;EACxF;EAEA,iBACC,EAAE,OAAO,QAAQ,gBAAgB,YAAY,WAAW,UAAU,QAAQ,uBAAuB,GAC3F;AACN,UAAM,gBAA8C,CAAC;AACrD,UAAM,UAAoC,MAAM,MAAM,OAAO,OAAO;AAEpE,UAAM,aAAmC,OAAO,QAAQ,OAAO,EAAE,OAAO,CAAC,CAAC,GAAG,GAAG,MAAM,CAAC,IAAI,oBAAoB,CAAC;AAEhH,UAAM,cAAc,WAAW;MAC9B,CAAC,CAAC,EAAE,MAAM,MAAM,IAAI,WAAW,KAAK,OAAO,gBAAgB,MAAM,CAAC;IACnE;AAEA,QAAI,QAAQ;AACX,YAAMC,UAAS;AAEf,UAAI,GAAGA,SAAQ,GAAG,GAAG;AACpB,sBAAc,KAAKA,OAAM;MAC1B,OAAO;AACN,sBAAc,KAAKA,QAAO,OAAO,CAAC;MACnC;IACD,OAAO;AACN,YAAM,SAAS;AACf,oBAAc,KAAK,IAAI,IAAI,SAAS,CAAC;AAErC,iBAAW,CAAC,YAAY,KAAK,KAAK,OAAO,QAAQ,GAAG;AACnD,cAAM,YAAgC,CAAC;AACvC,mBAAW,CAAC,WAAW,GAAG,KAAK,YAAY;AAC1C,gBAAM,WAAW,MAAM,SAAS;AAChC,cAAI,aAAa,UAAc,GAAG,UAAU,KAAK,KAAK,SAAS,UAAU,QAAY;AAEpF,gBAAI,IAAI,cAAc,QAAW;AAChC,oBAAM,kBAAkB,IAAI,UAAU;AACtC,oBAAM,eAAe,GAAG,iBAAiB,GAAG,IAAI,kBAAkB,IAAI,MAAM,iBAAiB,GAAG;AAChG,wBAAU,KAAK,YAAY;YAE5B,WAAW,CAAC,IAAI,WAAW,IAAI,eAAe,QAAW;AACxD,oBAAM,mBAAmB,IAAI,WAAW;AACxC,oBAAM,WAAW,GAAG,kBAAkB,GAAG,IAAI,mBAAmB,IAAI,MAAM,kBAAkB,GAAG;AAC/F,wBAAU,KAAK,QAAQ;YACxB,OAAO;AACN,wBAAU,KAAK,YAAY;YAC5B;UACD,OAAO;AACN,sBAAU,KAAK,QAAQ;UACxB;QACD;AAEA,sBAAc,KAAK,SAAS;AAC5B,YAAI,aAAa,OAAO,SAAS,GAAG;AACnC,wBAAc,KAAK,OAAO;QAC3B;MACD;IACD;AAEA,UAAM,UAAU,KAAK,aAAa,QAAQ;AAE1C,UAAM,YAAY,IAAI,KAAK,aAAa;AAExC,UAAM,eAAe,YAClB,iBAAiB,KAAK,eAAe,WAAW,EAAE,eAAe,KAAK,CAAC,CAAC,KACxE;AAEH,UAAM,gBAAgB,aAAa,mBAAmB,UAAU,KAAK;AAErE,UAAM,gBAAgB,2BAA2B,OAAO,gCAAgC;AAExF,WAAO,MAAM,OAAO,eAAe,KAAK,IAAI,WAAW,IAAI,aAAa,GAAG,SAAS,GAAG,aAAa,GAAG,YAAY;EACpH;EAEA,kCACC,EAAE,MAAM,cAAc,WAAW,GAC3B;AACN,UAAM,kBAAkB,eAAe,qBAAqB;AAC5D,UAAM,gBAAgB,aAAa,qBAAqB;AAExD,WAAO,+BAA+B,eAAe,IAAI,IAAI,GAAG,aAAa;EAC9E;EAEA,cAAc,SAAkE;AAC/E,QAAI,GAAG,SAAS,OAAO,KAAK,GAAG,SAAS,MAAM,GAAG;AAChD,aAAO;IACR,WAAW,GAAG,SAAS,SAAS,GAAG;AAClC,aAAO;IACR,WAAW,GAAG,SAAS,MAAM,GAAG;AAC/B,aAAO;IACR,WAAW,GAAG,SAAS,WAAW,KAAK,GAAG,SAAS,iBAAiB,GAAG;AACtE,aAAO;IACR,WAAW,GAAG,SAAS,MAAM,KAAK,GAAG,SAAS,YAAY,GAAG;AAC5D,aAAO;IACR,WAAW,GAAG,SAAS,MAAM,GAAG;AAC/B,aAAO;IACR,OAAO;AACN,aAAO;IACR;EACD;EAEA,WAAWC,OAAU,cAAwD;AAC5E,WAAOA,MAAI,QAAQ;MAClB,QAAQ,KAAK;MACb,YAAY,KAAK;MACjB,aAAa,KAAK;MAClB,cAAc,KAAK;MACnB,eAAe,KAAK;MACpB;IACD,CAAC;EACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAohBA,8BAA8B;IAC7B;IACA;IACA;IACA;IACA;IACA,aAAaJ;IACb;IACA;IACA;EACD,GAUkD;AACjD,QAAI,YAAwE,CAAC;AAC7E,QAAI,OAAO,QAAQ,UAAkD,CAAC,GAAG;AACzE,UAAM,QAA8B,CAAC;AAErC,QAAIA,YAAW,MAAM;AACpB,YAAM,mBAAmB,OAAO,QAAQ,YAAY,OAAO;AAC3D,kBAAY,iBAAiB,IAAI,CAChC,CAAC,KAAK,KAAK,OACN;QACL,OAAO,MAAM;QACb,OAAO;QACP,OAAO,mBAAmB,OAAmB,UAAU;QACvD,oBAAoB;QACpB,QAAQ;QACR,WAAW,CAAC;MACb,EAAE;IACH,OAAO;AACN,YAAM,iBAAiB,OAAO;QAC7B,OAAO,QAAQ,YAAY,OAAO,EAAE,IAAI,CACvC,CAAC,KAAK,KAAK,MACP,CAAC,KAAK,mBAAmB,OAAO,UAAU,CAAC,CAAC;MAClD;AAEA,UAAIA,QAAO,OAAO;AACjB,cAAM,WAAW,OAAOA,QAAO,UAAU,aACtCA,QAAO,MAAM,gBAAgB,aAAa,CAAC,IAC3CA,QAAO;AACV,gBAAQ,YAAY,uBAAuB,UAAU,UAAU;MAChE;AAEA,YAAM,kBAAsE,CAAC;AAC7E,UAAI,kBAA4B,CAAC;AAGjC,UAAIA,QAAO,SAAS;AACnB,YAAI,gBAAgB;AAEpB,mBAAW,CAAC,OAAO,KAAK,KAAK,OAAO,QAAQA,QAAO,OAAO,GAAG;AAC5D,cAAI,UAAU,QAAW;AACxB;UACD;AAEA,cAAI,SAAS,YAAY,SAAS;AACjC,gBAAI,CAAC,iBAAiB,UAAU,MAAM;AACrC,8BAAgB;YACjB;AACA,4BAAgB,KAAK,KAAK;UAC3B;QACD;AAEA,YAAI,gBAAgB,SAAS,GAAG;AAC/B,4BAAkB,gBACf,gBAAgB,OAAO,CAAC,MAAMA,QAAO,UAAU,CAAC,MAAM,IAAI,IAC1D,OAAO,KAAK,YAAY,OAAO,EAAE,OAAO,CAAC,QAAQ,CAAC,gBAAgB,SAAS,GAAG,CAAC;QACnF;MACD,OAAO;AAEN,0BAAkB,OAAO,KAAK,YAAY,OAAO;MAClD;AAEA,iBAAW,SAAS,iBAAiB;AACpC,cAAM,SAAS,YAAY,QAAQ,KAAK;AACxC,wBAAgB,KAAK,EAAE,OAAO,OAAO,OAAO,OAAO,CAAC;MACrD;AAEA,UAAI,oBAIE,CAAC;AAGP,UAAIA,QAAO,MAAM;AAChB,4BAAoB,OAAO,QAAQA,QAAO,IAAI,EAC5C,OAAO,CAAC,UAAoE,CAAC,CAAC,MAAM,CAAC,CAAC,EACtF,IAAI,CAAC,CAAC,OAAOK,YAAW,OAAO,EAAE,OAAO,aAAAA,cAAa,UAAU,YAAY,UAAU,KAAK,EAAG,EAAE;MAClG;AAEA,UAAI;AAGJ,UAAIL,QAAO,QAAQ;AAClB,iBAAS,OAAOA,QAAO,WAAW,aAC/BA,QAAO,OAAO,gBAAgB,EAAE,IAAI,CAAC,IACrCA,QAAO;AACV,mBAAW,CAAC,OAAO,KAAK,KAAK,OAAO,QAAQ,MAAM,GAAG;AACpD,0BAAgB,KAAK;YACpB;YACA,OAAO,8BAA8B,OAAO,UAAU;UACvD,CAAC;QACF;MACD;AAIA,iBAAW,EAAE,OAAO,MAAM,KAAK,iBAAiB;AAC/C,kBAAU,KAAK;UACd,OAAO,GAAG,OAAO,IAAI,OAAO,IAAI,MAAM,aAAa,YAAY,QAAQ,KAAK,EAAG;UAC/E;UACA,OAAO,GAAG,OAAO,MAAM,IAAI,mBAAmB,OAAO,UAAU,IAAI;UACnE,oBAAoB;UACpB,QAAQ;UACR,WAAW,CAAC;QACb,CAAC;MACF;AAEA,UAAI,cAAc,OAAOA,QAAO,YAAY,aACzCA,QAAO,QAAQ,gBAAgB,oBAAoB,CAAC,IACpDA,QAAO,WAAW,CAAC;AACtB,UAAI,CAAC,MAAM,QAAQ,WAAW,GAAG;AAChC,sBAAc,CAAC,WAAW;MAC3B;AACA,gBAAU,YAAY,IAAI,CAAC,iBAAiB;AAC3C,YAAI,GAAG,cAAc,MAAM,GAAG;AAC7B,iBAAO,mBAAmB,cAAc,UAAU;QACnD;AACA,eAAO,uBAAuB,cAAc,UAAU;MACvD,CAAC;AAED,cAAQA,QAAO;AACf,eAASA,QAAO;AAGhB,iBACO;QACL,OAAO;QACP,aAAa;QACb;MACD,KAAK,mBACJ;AACD,cAAM,qBAAqB,kBAAkB,QAAQ,eAAe,QAAQ;AAC5E,cAAM,oBAAoB,mBAAmB,SAAS,eAAe;AACrE,cAAM,sBAAsB,cAAc,iBAAiB;AAC3D,cAAM,qBAAqB,GAAG,UAAU,IAAI,qBAAqB;AACjE,cAAMM,UAAS;UACd,GAAG,mBAAmB,OAAO;YAAI,CAACC,QAAO,MACxC;cACC,mBAAmB,mBAAmB,WAAW,CAAC,GAAI,kBAAkB;cACxE,mBAAmBA,QAAO,UAAU;YACrC;UACD;QACD;AACA,cAAM,gBAAgB,KAAK,8BAA8B;UACxD;UACA;UACA;UACA,OAAO,WAAW,mBAAmB;UACrC,aAAa,OAAO,mBAAmB;UACvC,aAAa,GAAG,UAAU,GAAG,IACzB,gCAAgC,OAChC,EAAE,OAAO,EAAE,IACX,EAAE,GAAG,6BAA6B,OAAO,EAAE,IAC5C;UACH,YAAY;UACZ,QAAAD;UACA,qBAAqB;QACtB,CAAC;AACD,cAAM,QAAQ,MAAM,IAAI,WAAW,kBAAkB,CAAC,IAAI,IAAI,WAAW,MAAM,CAAC,GAAG,GAAG,qBAAqB;AAC3G,cAAM,KAAK;UACV,IAAI;UACJ,OAAO,IAAI,SAAS,cAAc,KAAY,CAAC,GAAG,kBAAkB;UACpE,OAAO;UACP,UAAU;UACV,SAAS;QACV,CAAC;AACD,kBAAU,KAAK;UACd,OAAO;UACP,OAAO;UACP;UACA,oBAAoB;UACpB,QAAQ;UACR,WAAW,cAAc;QAC1B,CAAC;MACF;IACD;AAEA,QAAI,UAAU,WAAW,GAAG;AAC3B,YAAM,IAAI,aAAa,EAAE,SAAS,iCAAiC,YAAY,MAAM,OAAO,UAAU,KAAK,CAAC;IAC7G;AAEA,QAAI;AAEJ,YAAQ,IAAI,QAAQ,KAAK;AAEzB,QAAI,qBAAqB;AACxB,UAAI,QAAQ,uBACX,IAAI;QACH,UAAU;UAAI,CAAC,EAAE,OAAAC,QAAO,OAAO,OAAO,MACrC,SACG,MAAM,IAAI,WAAW,GAAG,UAAU,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,WAAW,MAAM,CAAC,KACxE,GAAGA,QAAO,IAAI,OAAO,IACrBA,OAAM,MACNA;QACJ;QACA;MACD,CACD;AACA,UAAI,GAAG,qBAAqB,IAAI,GAAG;AAClC,gBAAQ,wBAAwB,KAAK,GACpC,QAAQ,SAAS,IAAI,gBAAgB,IAAI,KAAK,SAAS,OAAO,CAAC,KAAK,MACrE;MAED;AACA,YAAM,kBAAkB,CAAC;QACxB,OAAO;QACP,OAAO;QACP,OAAO,MAAM,GAAG,MAAM;QACtB,QAAQ;QACR,oBAAoB,YAAY;QAChC;MACD,CAAC;AAED,YAAM,gBAAgB,UAAU,UAAa,WAAW,UAAa,QAAQ,SAAS;AAEtF,UAAI,eAAe;AAClB,iBAAS,KAAK,iBAAiB;UAC9B,OAAO,aAAa,OAAO,UAAU;UACrC,QAAQ,CAAC;UACT,YAAY,CAAC;YACZ,MAAM,CAAC;YACP,OAAO,IAAI,IAAI,GAAG;UACnB,CAAC;UACD;UACA;UACA;UACA;UACA,cAAc,CAAC;QAChB,CAAC;AAED,gBAAQ;AACR,gBAAQ;AACR,iBAAS;AACT,kBAAU,CAAC;MACZ,OAAO;AACN,iBAAS,aAAa,OAAO,UAAU;MACxC;AAEA,eAAS,KAAK,iBAAiB;QAC9B,OAAO,GAAG,QAAQ,OAAO,IAAI,SAAS,IAAI,SAAS,QAAQ,CAAC,GAAG,UAAU;QACzE,QAAQ,CAAC;QACT,YAAY,gBAAgB,IAAI,CAAC,EAAE,OAAAA,OAAM,OAAO;UAC/C,MAAM,CAAC;UACP,OAAO,GAAGA,QAAO,MAAM,IAAI,mBAAmBA,QAAO,UAAU,IAAIA;QACpE,EAAE;QACF;QACA;QACA;QACA;QACA;QACA,cAAc,CAAC;MAChB,CAAC;IACF,OAAO;AACN,eAAS,KAAK,iBAAiB;QAC9B,OAAO,aAAa,OAAO,UAAU;QACrC,QAAQ,CAAC;QACT,YAAY,UAAU,IAAI,CAAC,EAAE,MAAM,OAAO;UACzC,MAAM,CAAC;UACP,OAAO,GAAG,OAAO,MAAM,IAAI,mBAAmB,OAAO,UAAU,IAAI;QACpE,EAAE;QACF;QACA;QACA;QACA;QACA;QACA,cAAc,CAAC;MAChB,CAAC;IACF;AAEA,WAAO;MACN,YAAY,YAAY;MACxB,KAAK;MACL;IACD;EACD;AACD;;;AC14CO,IAAM,wBAAN,MAAM,uBAEb;EACC,QAAiB,UAAU,IAAY;EAE/B;EA8BR,YAAYC,SAA4C;AACvD,SAAK,SAAS,EAAE,GAAGA,QAAO;EAC3B;EAEA,IAAI,UAAa,MAA4B;AAC5C,QAAI,SAAS,KAAK;AACjB,aAAO;QACN,GAAG,SAAS,GAA4B;QACxC,gBAAgB,IAAI;UAClB,SAAsB,EAAE;UACzB;QACD;MACD;IACD;AAEA,QAAI,SAAS,gBAAgB;AAC5B,aAAO;QACN,GAAG,SAAS,cAAuC;QACnD,gBAAgB,IAAI;UAClB,SAAkB,cAAc,EAAE;UACnC;QACD;MACD;IACD;AAEA,QAAI,OAAO,SAAS,UAAU;AAC7B,aAAO,SAAS,IAA6B;IAC9C;AAEA,UAAM,UAAU,GAAG,UAAU,QAAQ,IAClC,SAAS,EAAE,iBACX,GAAG,UAAU,IAAI,IACjB,SAAS,cAAc,EAAE,iBACzB;AACH,UAAM,QAAiB,QAAQ,IAA4B;AAE3D,QAAI,GAAG,OAAO,IAAI,OAAO,GAAG;AAE3B,UAAI,KAAK,OAAO,uBAAuB,SAAS,CAAC,MAAM,kBAAkB;AACxE,eAAO,MAAM;MACd;AAEA,YAAM,WAAW,MAAM,MAAM;AAC7B,eAAS,mBAAmB;AAC5B,aAAO;IACR;AAEA,QAAI,GAAG,OAAO,GAAG,GAAG;AACnB,UAAI,KAAK,OAAO,gBAAgB,OAAO;AACtC,eAAO;MACR;AAEA,YAAM,IAAI;QACT,2BAA2B,IAAI;MAChC;IACD;AAEA,QAAI,GAAG,OAAO,MAAM,GAAG;AACtB,UAAI,KAAK,OAAO,OAAO;AACtB,eAAO,IAAI;UACV;UACA,IAAI;YACH,IAAI;cACH,MAAM;cACN,IAAI,uBAAuB,KAAK,OAAO,OAAO,KAAK,OAAO,uBAAuB,KAAK;YACvF;UACD;QACD;MACD;AACA,aAAO;IACR;AAEA,QAAI,OAAO,UAAU,YAAY,UAAU,MAAM;AAChD,aAAO;IACR;AAEA,WAAO,IAAI,MAAM,OAAO,IAAI,uBAAsB,KAAK,MAAM,CAAC;EAC/D;AACD;;;ACrHO,IAAe,oBAAf,MAAsF;EAC5F,QAAiB,UAAU,IAAY;;EAQvC,oBAAgC;AAC/B,WAAO,KAAK,EAAE;EACf;AAGD;;;ACgCO,IAAM,kBAAN,MAGL;EACD,QAAiB,UAAU,IAAY;EAE/B;EACA;EACA;EACA,WAAuB,CAAC;EACxB;EAIR,YACCC,SASC;AACD,SAAK,SAASA,QAAO;AACrB,SAAK,UAAUA,QAAO;AACtB,SAAK,UAAUA,QAAO;AACtB,QAAIA,QAAO,UAAU;AACpB,WAAK,WAAWA,QAAO;IACxB;AACA,SAAK,WAAWA,QAAO;EACxB;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;;;;;;;EAQA,KACC,QAMC;AACD,UAAM,kBAAkB,CAAC,CAAC,KAAK;AAE/B,QAAI;AACJ,QAAI,KAAK,QAAQ;AAChB,eAAS,KAAK;IACf,WAAW,GAAG,QAAQ,QAAQ,GAAG;AAEhC,eAAS,OAAO;QACf,OAAO,KAAK,OAAO,EAAE,cAAc,EAAE,IAAI,CACxC,QACI,CAAC,KAAK,OAAO,GAAqC,CAAsC,CAAC;MAC/F;IACD,WAAW,GAAG,QAAQ,UAAU,GAAG;AAClC,eAAS,OAAO,cAAc,EAAE;IACjC,WAAW,GAAG,QAAQ,GAAG,GAAG;AAC3B,eAAS,CAAC;IACX,OAAO;AACN,eAAS,gBAAyB,MAAM;IACzC;AAEA,WAAQ,KAAK,cAAc,SACxB,IAAI,aAAa;MAClB,OAAO;MACP;MACA;MACA,SAAS,KAAK;MACd,SAAS,KAAK;MACd,UAAU,KAAK;MACf,UAAU,KAAK;IAChB,CAAC,IACC,IAAI,aAAa;MAClB,OAAO;MACP;MACA;MACA,SAAS,KAAK;MACd,SAAS,KAAK;MACd,UAAU,KAAK;MACf,UAAU,KAAK;IAChB,CAAC,EAAE,SAAS,KAAK,SAAS;EAC5B;AACD;AAEO,IAAe,2BAAf,cAWG,kBAA4C;EACrD,QAA0B,UAAU,IAAY;EAE9B;EAaR;EACA;EACF;EACA;EACE;EACA;EAEV,YACC,EAAE,OAAO,QAAQ,iBAAiB,SAAS,SAAS,UAAU,SAAS,GAWtE;AACD,UAAM;AACN,SAAK,SAAS;MACb;MACA;MACA,QAAQ,EAAE,GAAG,OAAO;MACpB;MACA,cAAc,CAAC;IAChB;AACA,SAAK,kBAAkB;AACvB,SAAK,UAAU;AACf,SAAK,UAAU;AACf,SAAK,IAAI;MACR,gBAAgB;IACjB;AACA,SAAK,YAAY,iBAAiB,KAAK;AACvC,SAAK,sBAAsB,OAAO,KAAK,cAAc,WAAW,EAAE,CAAC,KAAK,SAAS,GAAG,KAAK,IAAI,CAAC;EAC/F;EAEQ,WACP,UAC4C;AAC5C,WAAO,CACN,OACA,OACI;AACJ,YAAM,gBAAgB,KAAK;AAC3B,YAAM,YAAY,iBAAiB,KAAK;AAExC,UAAI,OAAO,cAAc,YAAY,KAAK,OAAO,OAAO,KAAK,CAAC,SAAS,KAAK,UAAU,SAAS,GAAG;AACjG,cAAM,IAAI,MAAM,UAAU,SAAS,iCAAiC;MACrE;AAEA,UAAI,CAAC,KAAK,iBAAiB;AAE1B,YAAI,OAAO,KAAK,KAAK,mBAAmB,EAAE,WAAW,KAAK,OAAO,kBAAkB,UAAU;AAC5F,eAAK,OAAO,SAAS;YACpB,CAAC,aAAa,GAAG,KAAK,OAAO;UAC9B;QACD;AACA,YAAI,OAAO,cAAc,YAAY,CAAC,GAAG,OAAO,GAAG,GAAG;AACrD,gBAAM,YAAY,GAAG,OAAO,QAAQ,IACjC,MAAM,EAAE,iBACR,GAAG,OAAO,IAAI,IACd,MAAM,cAAc,EAAE,iBACtB,MAAM,MAAM,OAAO,OAAO;AAC7B,eAAK,OAAO,OAAO,SAAS,IAAI;QACjC;MACD;AAEA,UAAI,OAAO,OAAO,YAAY;AAC7B,aAAK;UACJ,IAAI;YACH,KAAK,OAAO;YACZ,IAAI,sBAAsB,EAAE,oBAAoB,OAAO,aAAa,MAAM,CAAC;UAC5E;QACD;MACD;AAEA,UAAI,CAAC,KAAK,OAAO,OAAO;AACvB,aAAK,OAAO,QAAQ,CAAC;MACtB;AAEA,WAAK,OAAO,MAAM,KAAK,EAAE,IAAI,OAAO,UAAU,OAAO,UAAU,CAAC;AAEhE,UAAI,OAAO,cAAc,UAAU;AAClC,gBAAQ,UAAU;UACjB,KAAK,QAAQ;AACZ,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,SAAS;AACb,iBAAK,sBAAsB,OAAO;cACjC,OAAO,QAAQ,KAAK,mBAAmB,EAAE,IAAI,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,KAAK,CAAC;YACrE;AACA,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,SAAS;AACb,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,QAAQ;AACZ,iBAAK,sBAAsB,OAAO;cACjC,OAAO,QAAQ,KAAK,mBAAmB,EAAE,IAAI,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,KAAK,CAAC;YACrE;AACA,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;QACD;MACD;AAEA,aAAO;IACR;EACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6BA,WAAW,KAAK,WAAW,MAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6BjC,YAAY,KAAK,WAAW,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6BnC,YAAY,KAAK,WAAW,OAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6BnC,WAAW,KAAK,WAAW,MAAM;EAEzB,kBACP,MACA,OAUC;AACD,WAAO,CAAC,mBAAmB;AAC1B,YAAM,cAAe,OAAO,mBAAmB,aAC5C,eAAe,kBAAkB,CAAC,IAClC;AAKH,UAAI,CAAC,aAAa,KAAK,kBAAkB,GAAG,YAAY,kBAAkB,CAAC,GAAG;AAC7E,cAAM,IAAI;UACT;QACD;MACD;AAEA,WAAK,OAAO,aAAa,KAAK,EAAE,MAAM,OAAO,YAAY,CAAC;AAC1D,aAAO;IACR;EACD;;;;;;;;;;;;;;;;;;;;;;;;;;EA2BA,QAAQ,KAAK,kBAAkB,SAAS,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;EA2B7C,WAAW,KAAK,kBAAkB,SAAS,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;EA2B/C,YAAY,KAAK,kBAAkB,aAAa,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA0CrD,eAAe,KAAK,kBAAkB,aAAa,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;EA2BvD,SAAS,KAAK,kBAAkB,UAAU,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA0C/C,YAAY,KAAK,kBAAkB,UAAU,IAAI;;EAGjD,gBAAgB,cAKd;AACD,SAAK,OAAO,aAAa,KAAK,GAAG,YAAY;AAC7C,WAAO;EACR;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA+BA,MACC,OAC2C;AAC3C,QAAI,OAAO,UAAU,YAAY;AAChC,cAAQ;QACP,IAAI;UACH,KAAK,OAAO;UACZ,IAAI,sBAAsB,EAAE,oBAAoB,OAAO,aAAa,MAAM,CAAC;QAC5E;MACD;IACD;AACA,SAAK,OAAO,QAAQ;AACpB,WAAO;EACR;;;;;;;;;;;;;;;;;;;;;;;EAwBA,OACC,QAC4C;AAC5C,QAAI,OAAO,WAAW,YAAY;AACjC,eAAS;QACR,IAAI;UACH,KAAK,OAAO;UACZ,IAAI,sBAAsB,EAAE,oBAAoB,OAAO,aAAa,MAAM,CAAC;QAC5E;MACD;IACD;AACA,SAAK,OAAO,SAAS;AACrB,WAAO;EACR;EAyBA,WACI,SAG0C;AAC7C,QAAI,OAAO,QAAQ,CAAC,MAAM,YAAY;AACrC,YAAM,UAAU,QAAQ,CAAC;QACxB,IAAI;UACH,KAAK,OAAO;UACZ,IAAI,sBAAsB,EAAE,oBAAoB,SAAS,aAAa,MAAM,CAAC;QAC9E;MACD;AACA,WAAK,OAAO,UAAU,MAAM,QAAQ,OAAO,IAAI,UAAU,CAAC,OAAO;IAClE,OAAO;AACN,WAAK,OAAO,UAAU;IACvB;AACA,WAAO;EACR;EA8BA,WACI,SAG0C;AAC7C,QAAI,OAAO,QAAQ,CAAC,MAAM,YAAY;AACrC,YAAM,UAAU,QAAQ,CAAC;QACxB,IAAI;UACH,KAAK,OAAO;UACZ,IAAI,sBAAsB,EAAE,oBAAoB,SAAS,aAAa,MAAM,CAAC;QAC9E;MACD;AAEA,YAAM,eAAe,MAAM,QAAQ,OAAO,IAAI,UAAU,CAAC,OAAO;AAEhE,UAAI,KAAK,OAAO,aAAa,SAAS,GAAG;AACxC,aAAK,OAAO,aAAa,GAAG,EAAE,EAAG,UAAU;MAC5C,OAAO;AACN,aAAK,OAAO,UAAU;MACvB;IACD,OAAO;AACN,YAAM,eAAe;AAErB,UAAI,KAAK,OAAO,aAAa,SAAS,GAAG;AACxC,aAAK,OAAO,aAAa,GAAG,EAAE,EAAG,UAAU;MAC5C,OAAO;AACN,aAAK,OAAO,UAAU;MACvB;IACD;AACA,WAAO;EACR;;;;;;;;;;;;;;;;;EAkBA,MAAM,OAAuE;AAC5E,QAAI,KAAK,OAAO,aAAa,SAAS,GAAG;AACxC,WAAK,OAAO,aAAa,GAAG,EAAE,EAAG,QAAQ;IAC1C,OAAO;AACN,WAAK,OAAO,QAAQ;IACrB;AACA,WAAO;EACR;;;;;;;;;;;;;;;;;EAkBA,OAAO,QAAyE;AAC/E,QAAI,KAAK,OAAO,aAAa,SAAS,GAAG;AACxC,WAAK,OAAO,aAAa,GAAG,EAAE,EAAG,SAAS;IAC3C,OAAO;AACN,WAAK,OAAO,SAAS;IACtB;AACA,WAAO;EACR;;;;;;;;;;;EAYA,IAAI,UAAwBA,UAAqB,CAAC,GAA2C;AAC5F,SAAK,OAAO,gBAAgB,EAAE,UAAU,QAAAA,QAAO;AAC/C,WAAO;EACR;;EAGA,SAAc;AACb,WAAO,KAAK,QAAQ,iBAAiB,KAAK,MAAM;EACjD;EAEA,QAAe;AACd,UAAM,EAAE,SAAS,UAAU,GAAG,KAAK,IAAI,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC;AAC5E,WAAO;EACR;EAEA,GACC,OAC6D;AAC7D,WAAO,IAAI;MACV,IAAI,SAAS,KAAK,OAAO,GAAG,KAAK,OAAO,QAAQ,KAAK;MACrD,IAAI,sBAAsB,EAAE,OAAO,oBAAoB,SAAS,aAAa,QAAQ,CAAC;IACvF;EACD;;EAGS,oBAAiD;AACzD,WAAO,IAAI;MACV,KAAK,OAAO;MACZ,IAAI,sBAAsB,EAAE,OAAO,KAAK,WAAW,oBAAoB,SAAS,aAAa,QAAQ,CAAC;IACvG;EACD;EAEA,WAAkC;AACjC,WAAO;EACR;AACD;AA4BO,IAAM,eAAN,cAUG,yBAU4C;EACrD,QAA0B,UAAU,IAAY;;EAGhD,SAAS,MAAsC;AAC9C,UAAM,EAAE,SAAS,QAAAA,SAAQ,SAAS,qBAAqB,UAAU,IAAI;AACrE,QAAI,CAAC,SAAS;AACb,YAAM,IAAI,MAAM,oFAAoF;IACrG;AACA,WAAO,OAAO,gBAAgB,wBAAwB,MAAM;AAC3D,YAAM,aAAa,oBAA8BA,QAAO,MAAM;AAC9D,YAAM,QAAQ,QAAQ,aAEpB,QAAQ,WAAW,KAAK,OAAO,CAAC,GAAG,YAAY,MAAM,IAAI;AAC3D,YAAM,sBAAsB;AAE5B,aAAO,cAAc,SAAY,QAAQ,MAAM,SAAS,SAAS;IAClE,CAAC;EACF;;;;;;;;EASA,QAAQ,MAAqC;AAC5C,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAEA,UAAkD,CAAC,sBAAsB;AACxE,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,aAAO,KAAK,SAAS,EAAE,QAAQ,mBAAmB,KAAK,SAAS;IACjE,CAAC;EACF;AACD;AAEA,YAAY,cAAc,CAAC,YAAY,CAAC;AAExC,SAAS,kBAAkB,MAAmB,OAAuC;AACpF,SAAO,CAAC,YAAY,gBAAgB,gBAAgB;AACnD,UAAM,eAAe,CAAC,aAAa,GAAG,WAAW,EAAE,IAAI,CAAC,YAAY;MACnE;MACA;MACA,aAAa;IACd,EAAE;AAEF,eAAW,eAAe,cAAc;AACvC,UAAI,CAAC,aAAc,WAAmB,kBAAkB,GAAG,YAAY,YAAY,kBAAkB,CAAC,GAAG;AACxG,cAAM,IAAI;UACT;QACD;MACD;IACD;AAEA,WAAQ,WAA2B,gBAAgB,YAAY;EAChE;AACD;AAEA,IAAM,oBAAoB,OAAO;EAChC;EACA;EACA;EACA;EACA;EACA;AACD;AA2BO,IAAM,QAAQ,kBAAkB,SAAS,KAAK;AA2B9C,IAAM,WAAW,kBAAkB,SAAS,IAAI;AA2BhD,IAAM,YAAY,kBAAkB,aAAa,KAAK;AA0CtD,IAAM,eAAe,kBAAkB,aAAa,IAAI;AA2BxD,IAAM,SAAS,kBAAkB,UAAU,KAAK;AA0ChD,IAAM,YAAY,kBAAkB,UAAU,IAAI;;;ACnsClD,IAAM,eAAN,MAAmB;EACzB,QAAiB,UAAU,IAAY;EAE/B;EACA;EAER,YAAY,SAAuC;AAClD,SAAK,UAAU,GAAG,SAAS,SAAS,IAAI,UAAU;AAClD,SAAK,gBAAgB,GAAG,SAAS,SAAS,IAAI,SAAY;EAC3D;EAEA,MAA6B,OAAe;AAC3C,UAAM,eAAe;AAErB,WAAO;MACN,GACC,IACgD;AAChD,YAAI,OAAO,OAAO,YAAY;AAC7B,eAAK,GAAG,YAAY;QACrB;AAEA,eAAO,IAAI;UACV,IAAI,aAAa,GAAG,OAAO,GAAG,GAAG,kBAAkB,GAAqB,OAAO,IAAI;UACnF,IAAI,sBAAsB,EAAE,OAAO,oBAAoB,SAAS,aAAa,QAAQ,CAAC;QACvF;MACD;IACD;EACD;EAEA,QAAQ,SAAyB;AAChC,UAAM,OAAO;AAIb,aAAS,OACR,QACgD;AAChD,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS;QACT,SAAS,KAAK,WAAW;QACzB,UAAU;MACX,CAAC;IACF;AAIA,aAAS,eAAe,QAA4E;AACnG,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS;QACT,SAAS,KAAK,WAAW;QACzB,UAAU;MACX,CAAC;IACF;AAOA,aAAS,iBACR,IACA,QACoD;AACpD,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS;QACT,SAAS,KAAK,WAAW;QACzB,UAAU,EAAE,GAAG;MAChB,CAAC;IACF;AAEA,WAAO,EAAE,QAAQ,gBAAgB,iBAAiB;EACnD;EAIA,OAA0C,QAAoE;AAC7G,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS;MACT,SAAS,KAAK,WAAW;IAC1B,CAAC;EACF;EAIA,eAAe,QAAsE;AACpF,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS;MACT,SAAS,KAAK,WAAW;MACzB,UAAU;IACX,CAAC;EACF;EAOA,iBACC,IACA,QAC8C;AAC9C,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS;MACT,SAAS,KAAK,WAAW;MACzB,UAAU,EAAE,GAAG;IAChB,CAAC;EACF;;EAGQ,aAAa;AACpB,QAAI,CAAC,KAAK,SAAS;AAClB,WAAK,UAAU,IAAI,UAAU,KAAK,aAAa;IAChD;AAEA,WAAO,KAAK;EACb;AACD;;;ACrFO,IAAM,kBAAN,MAIL;EAGD,YACS,OACA,SACA,SACA,UACA,wBACP;AALO,SAAA,QAAA;AACA,SAAA,UAAA;AACA,SAAA,UAAA;AACA,SAAA,WAAA;AACA,SAAA,yBAAA;EACN;EARH,QAAiB,UAAU,IAAY;EAU/B;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAEA,wBAAoG;AACnG,SAAK,yBAAyB;AAC9B,WAAO;EACR;EAIA,OACC,QACqC;AACrC,aAAS,MAAM,QAAQ,MAAM,IAAI,SAAS,CAAC,MAAM;AACjD,QAAI,OAAO,WAAW,GAAG;AACxB,YAAM,IAAI,MAAM,iDAAiD;IAClE;AACA,UAAM,eAAe,OAAO,IAAI,CAAC,UAAU;AAC1C,YAAM,SAAsC,CAAC;AAC7C,YAAM,OAAO,KAAK,MAAM,MAAM,OAAO,OAAO;AAC5C,iBAAW,UAAU,OAAO,KAAK,KAAK,GAAG;AACxC,cAAM,WAAW,MAAM,MAA4B;AACnD,eAAO,MAAM,IAAI,GAAG,UAAU,GAAG,IAAI,WAAW,IAAI,MAAM,UAAU,KAAK,MAAM,CAAC;MACjF;AACA,aAAO;IACR,CAAC;AAED,WAAO,KAAK,cAAc,SACvB,IAAI;MACL,KAAK;MACL;MACA,KAAK;MACL,KAAK;MACL,KAAK;MACL;MACA,KAAK;IACN,IACE,IAAI;MACL,KAAK;MACL;MACA,KAAK;MACL,KAAK;MACL,KAAK;MACL;MACA,KAAK;IACN,EAAE,SAAS,KAAK,SAAS;EAC3B;EAMA,OACC,aAIqC;AACrC,UAAM,SAAS,OAAO,gBAAgB,aAAa,YAAY,IAAI,aAAa,CAAC,IAAI;AAErF,QACC,CAAC,GAAG,QAAQ,GAAG,KACZ,CAAC,aAAa,KAAK,MAAM,OAAO,GAAG,OAAO,EAAE,cAAc,GAC5D;AACD,YAAM,IAAI;QACT;MACD;IACD;AAEA,WAAO,IAAI,aAAa,KAAK,OAAO,QAAQ,KAAK,SAAS,KAAK,SAAS,KAAK,UAAU,IAAI;EAC5F;AACD;AAwFO,IAAM,eAAN,cAQG,aAIV;EAKC,YACC,OACA,QACQ,SACA,SACR,UACA,QACA,wBACC;AACD,UAAM;AANE,SAAA,UAAA;AACA,SAAA,UAAA;AAMR,SAAK,SAAS,EAAE,OAAO,QAAuB,UAAU,QAAQ,uBAAuB;EACxF;EAfA,QAA0B,UAAU,IAAY;EAExC;EAuCR,UACC,SAA6B,KAAK,OAAO,MAAM,MAAM,OAAO,OAAO,GACb;AACtD,SAAK,OAAO,YAAY,oBAA8B,MAAM;AAC5D,WAAO;EACR;;;;;;;;;;;;;;;;;;;;;;;EAwBA,oBACCC,UAAgE,CAAC,GACe;AAChF,QAAIA,QAAO,WAAW,QAAW;AAChC,WAAK,OAAO,aAAa;IAC1B,OAAO;AACN,UAAI,eAAe;AACnB,qBAAe,MAAM,QAAQA,QAAO,MAAM,IACvCA,QAAO,OAAO,IAAI,CAAC,OAAO,KAAK,QAAQ,WAAW,KAAK,QAAQ,OAAO,gBAAgB,EAAE,CAAC,CAAC,EAAE,KAAK,GAAG,IACpG,KAAK,QAAQ,WAAW,KAAK,QAAQ,OAAO,gBAAgBA,QAAO,MAAM,CAAC;AAE7E,YAAM,WAAWA,QAAO,QAAQ,aAAaA,QAAO,KAAK,KAAK;AAC9D,WAAK,OAAO,aAAa,OAAO,IAAI,IAAI,YAAY,CAAC,IAAI,QAAQ;IAClE;AACA,WAAO;EACR;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA+BA,mBACCA,SACgF;AAChF,QAAIA,QAAO,UAAUA,QAAO,eAAeA,QAAO,WAAW;AAC5D,YAAM,IAAI;QACT;MACD;IACD;AACA,UAAM,WAAWA,QAAO,QAAQ,aAAaA,QAAO,KAAK,KAAK;AAC9D,UAAM,iBAAiBA,QAAO,cAAc,aAAaA,QAAO,WAAW,KAAK;AAChF,UAAM,cAAcA,QAAO,WAAW,aAAaA,QAAO,QAAQ,KAAK;AACvE,UAAM,SAAS,KAAK,QAAQ,eAAe,KAAK,OAAO,OAAO,aAAa,KAAK,OAAO,OAAOA,QAAO,GAAG,CAAC;AACzG,QAAI,eAAe;AACnB,mBAAe,MAAM,QAAQA,QAAO,MAAM,IACvCA,QAAO,OAAO,IAAI,CAAC,OAAO,KAAK,QAAQ,WAAW,KAAK,QAAQ,OAAO,gBAAgB,EAAE,CAAC,CAAC,EAAE,KAAK,GAAG,IACpG,KAAK,QAAQ,WAAW,KAAK,QAAQ,OAAO,gBAAgBA,QAAO,MAAM,CAAC;AAC7E,SAAK,OAAO,aAAa,OACxB,IAAI,IAAI,YAAY,CACrB,IAAI,cAAc,kBAAkB,MAAM,GAAG,QAAQ,GAAG,WAAW;AACnE,WAAO;EACR;;EAGA,SAAc;AACb,WAAO,KAAK,QAAQ,iBAAiB,KAAK,MAAM;EACjD;EAEA,QAAe;AACd,UAAM,EAAE,SAAS,UAAU,GAAG,KAAK,IAAI,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC;AAC5E,WAAO;EACR;;EAGA,SAAS,MAAsC;AAC9C,WAAO,OAAO,gBAAgB,wBAAwB,MAAM;AAC3D,aAAO,KAAK,QAAQ,aAIlB,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC,GAAG,KAAK,OAAO,WAAW,MAAM,IAAI;IAC5E,CAAC;EACF;EAEA,QAAQ,MAAqC;AAC5C,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAES,UAAkD,CAAC,sBAAsB;AACjF,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,aAAO,KAAK,SAAS,EAAE,QAAQ,mBAAmB,KAAK,SAAS;IACjE,CAAC;EACF;EAEA,WAAkC;AACjC,WAAO;EACR;AACD;;;ACxYO,IAAM,4BAAN,cACE,aAET;EASC,YACC,MACQ,SACA,SACP;AACD,UAAM;AAHE,SAAA,UAAA;AACA,SAAA,UAAA;AAGR,SAAK,SAAS,EAAE,KAAK;EACtB;EAfA,QAA0B,UAAU,IAAY;EAExC;EAeR,eAAqB;AACpB,QAAI,KAAK,OAAO,eAAe,QAAW;AACzC,YAAM,IAAI,MAAM,iDAAiD;IAClE;AACA,SAAK,OAAO,eAAe;AAC3B,WAAO;EACR;EAEA,aAAmB;AAClB,QAAI,KAAK,OAAO,iBAAiB,QAAW;AAC3C,YAAM,IAAI,MAAM,iDAAiD;IAClE;AACA,SAAK,OAAO,aAAa;AACzB,WAAO;EACR;;EAGA,SAAc;AACb,WAAO,KAAK,QAAQ,kCAAkC,KAAK,MAAM;EAClE;EAEA,QAAe;AACd,UAAM,EAAE,SAAS,UAAU,GAAG,KAAK,IAAI,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC;AAC5E,WAAO;EACR;;EAGA,SAAS,MAIP;AACD,WAAO,OAAO,gBAAgB,wBAAwB,MAAM;AAC3D,aAAO,KAAK,QAAQ,aAAa,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC,GAAG,QAAW,MAAM,IAAI;IAC/F,CAAC;EACF;EAEA,QAAQ,MAIN;AACD,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAEA,UAAkD,CAAC,sBAAsB;AACxE,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,aAAO,KAAK,SAAS,EAAE,QAAQ,mBAAmB,KAAK,SAAS;IACjE,CAAC;EACF;AACD;;;ACtDO,IAAM,kBAAN,MAAqF;EAO3F,YACS,OACA,SACA,SACA,UACP;AAJO,SAAA,QAAA;AACA,SAAA,UAAA;AACA,SAAA,UAAA;AACA,SAAA,WAAA;EACN;EAXH,QAAiB,UAAU,IAAY;EAa/B;EACR,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAEA,IACC,QACkH;AAClH,WAAO,KAAK,cAAc,SACvB,IAAI;MACL,KAAK;MACL,aAAa,KAAK,OAAO,MAAM;MAC/B,KAAK;MACL,KAAK;MACL,KAAK;IACN,IACE,IAAI;MACL,KAAK;MACL,aAAa,KAAK,OAAO,MAAM;MAC/B,KAAK;MACL,KAAK;MACL,KAAK;IACN,EAAE,SAAS,KAAK,SAAS;EAC3B;AACD;AAwNO,IAAM,eAAN,cAaG,aAIV;EAOC,YACC,OACA,KACQ,SACA,SACR,UACC;AACD,UAAM;AAJE,SAAA,UAAA;AACA,SAAA,UAAA;AAIR,SAAK,SAAS,EAAE,KAAK,OAAO,UAAU,OAAO,CAAC,EAAE;AAChD,SAAK,YAAY,iBAAiB,KAAK;AACvC,SAAK,sBAAsB,OAAO,KAAK,cAAc,WAAW,EAAE,CAAC,KAAK,SAAS,GAAG,KAAK,IAAI,CAAC;EAC/F;EAjBA,QAA0B,UAAU,IAAY;EAExC;EACA;EACA;EAeR,KACC,QAC2C;AAC3C,UAAM,YAAY,iBAAiB,MAAM;AACzC,QAAI,OAAO,cAAc,UAAU;AAClC,WAAK,oBAAoB,SAAS,IAAI;IACvC;AACA,SAAK,OAAO,OAAO;AACnB,WAAO;EACR;EAEQ,mBAAmB,OAAiE;AAC3F,QAAI,GAAG,OAAO,OAAO,GAAG;AACvB,aAAO,MAAM,MAAM,OAAO,OAAO;IAClC,WAAW,GAAG,OAAO,QAAQ,GAAG;AAC/B,aAAO,MAAM,EAAE;IAChB;AACA,WAAO,MAAM,cAAc,EAAE;EAC9B;EAEQ,WACP,UAC4C;AAC5C,WAAQ,CACP,OACA,OACI;AACJ,YAAM,YAAY,iBAAiB,KAAK;AAExC,UAAI,OAAO,cAAc,YAAY,KAAK,OAAO,MAAM,KAAK,CAAC,SAAS,KAAK,UAAU,SAAS,GAAG;AAChG,cAAM,IAAI,MAAM,UAAU,SAAS,iCAAiC;MACrE;AAEA,UAAI,OAAO,OAAO,YAAY;AAC7B,cAAM,OAAO,KAAK,OAAO,QAAQ,CAAC,GAAG,KAAK,OAAO,MAAM,GAAG,IACvD,KAAK,mBAAmB,KAAK,OAAO,IAAI,IACxC;AACH,aAAK;UACJ,IAAI;YACH,KAAK,OAAO,MAAM,MAAM,OAAO,OAAO;YACtC,IAAI,sBAAsB,EAAE,oBAAoB,OAAO,aAAa,MAAM,CAAC;UAC5E;UACA,QAAQ,IAAI;YACX;YACA,IAAI,sBAAsB,EAAE,oBAAoB,OAAO,aAAa,MAAM,CAAC;UAC5E;QACD;MACD;AAEA,WAAK,OAAO,MAAM,KAAK,EAAE,IAAI,OAAO,UAAU,OAAO,UAAU,CAAC;AAEhE,UAAI,OAAO,cAAc,UAAU;AAClC,gBAAQ,UAAU;UACjB,KAAK,QAAQ;AACZ,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,SAAS;AACb,iBAAK,sBAAsB,OAAO;cACjC,OAAO,QAAQ,KAAK,mBAAmB,EAAE,IAAI,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,KAAK,CAAC;YACrE;AACA,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,SAAS;AACb,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;UACA,KAAK,QAAQ;AACZ,iBAAK,sBAAsB,OAAO;cACjC,OAAO,QAAQ,KAAK,mBAAmB,EAAE,IAAI,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,KAAK,CAAC;YACrE;AACA,iBAAK,oBAAoB,SAAS,IAAI;AACtC;UACD;QACD;MACD;AAEA,aAAO;IACR;EACD;EAEA,WAAW,KAAK,WAAW,MAAM;EAEjC,YAAY,KAAK,WAAW,OAAO;EAEnC,YAAY,KAAK,WAAW,OAAO;EAEnC,WAAW,KAAK,WAAW,MAAM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAmCjC,MAAM,OAAkE;AACvE,SAAK,OAAO,QAAQ;AACpB,WAAO;EACR;EA4BA,UACC,QACsD;AACtD,QAAI,CAAC,QAAQ;AACZ,eAAS,OAAO,OAAO,CAAC,GAAG,KAAK,OAAO,MAAM,MAAM,OAAO,OAAO,CAAC;AAElE,UAAI,KAAK,OAAO,MAAM;AACrB,cAAM,YAAY,iBAAiB,KAAK,OAAO,IAAI;AAEnD,YAAI,OAAO,cAAc,YAAY,KAAK,OAAO,QAAQ,CAAC,GAAG,KAAK,OAAO,MAAM,GAAG,GAAG;AACpF,gBAAM,aAAa,KAAK,mBAAmB,KAAK,OAAO,IAAI;AAC3D,iBAAO,SAAS,IAAI;QACrB;AAEA,mBAAW,QAAQ,KAAK,OAAO,OAAO;AACrC,gBAAMC,aAAY,iBAAiB,KAAK,KAAK;AAE7C,cAAI,OAAOA,eAAc,YAAY,CAAC,GAAG,KAAK,OAAO,GAAG,GAAG;AAC1D,kBAAM,aAAa,KAAK,mBAAmB,KAAK,KAAK;AACrD,mBAAOA,UAAS,IAAI;UACrB;QACD;MACD;IACD;AAEA,SAAK,OAAO,YAAY,oBAA8B,MAAM;AAC5D,WAAO;EACR;;EAGA,SAAc;AACb,WAAO,KAAK,QAAQ,iBAAiB,KAAK,MAAM;EACjD;EAEA,QAAe;AACd,UAAM,EAAE,SAAS,UAAU,GAAG,KAAK,IAAI,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC;AAC5E,WAAO;EACR;;EAGA,SAAS,MAAsC;AAC9C,UAAM,QAAQ,KAAK,QAAQ,aAEzB,KAAK,QAAQ,WAAW,KAAK,OAAO,CAAC,GAAG,KAAK,OAAO,WAAW,MAAM,IAAI;AAC3E,UAAM,sBAAsB,KAAK;AACjC,WAAO;EACR;EAEA,QAAQ,MAAqC;AAC5C,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAES,UAAkD,CAAC,sBAAsB;AACjF,WAAO,KAAK,SAAS,EAAE,QAAQ,mBAAmB,KAAK,SAAS;EACjE;EAEA,WAAkC;AACjC,WAAO;EACR;AACD;;;AC/iBO,IAAM,iBAAN,MAAM,wBAEH,IAAmD;EAuB5D,YACU,QAKR;AACD,UAAM,gBAAe,mBAAmB,OAAO,QAAQ,OAAO,OAAO,EAAE,WAAW;AANzE,SAAA,SAAA;AAQT,SAAK,QAAQ,MAAM;AAEnB,SAAK,UAAU,OAAO;AAEtB,SAAK,MAAM,gBAAe;MACzB,OAAO;MACP,OAAO;IACR;EACD;EAvCQ;EACA;EAER,QAA0B,UAAU,IAAI;EACxC,CAAC,OAAO,WAAW,IAAI;EAEf;EAER,OAAe,mBACd,QACA,SACc;AACd,WAAO,4BAAoC,MAAM,GAAG,IAAI,IAAI,SAAS,EAAE,GAAG,OAAO,CAAC,GAAG,OAAO;EAC7F;EAEA,OAAe,WACd,QACA,SACc;AACd,WAAO,oCAA4C,MAAM,GAAG,IAAI,IAAI,SAAS,EAAE,GAAG,OAAO,CAAC,GAAG,OAAO;EACrG;;EAsBA,SAAS,OAAe;AACvB,SAAK,QAAQ;EACd;EAEA,KACC,aACA,YAC+B;AAC/B,WAAO,QAAQ,QAAQ,KAAK,QAAQ,MAAM,KAAK,KAAK,KAAK,KAAK,CAAC,EAC7D;MACA;MACA;IACD;EACF;EAEA,MACC,YACkB;AAClB,WAAO,KAAK,KAAK,QAAW,UAAU;EACvC;EAEA,QAAQ,WAA8D;AACrE,WAAO,KAAK;MACX,CAAC,UAAU;AACV,oBAAY;AACZ,eAAO;MACR;MACA,CAAC,WAAW;AACX,oBAAY;AACZ,cAAM;MACP;IACD;EACD;AACD;;;ACjEO,IAAM,yBAAN,MAA4G;EAGlH,YACS,YACA,QACA,eACA,OACA,aACA,SACA,SACP;AAPO,SAAA,aAAA;AACA,SAAA,SAAA;AACA,SAAA,gBAAA;AACA,SAAA,QAAA;AACA,SAAA,cAAA;AACA,SAAA,UAAA;AACA,SAAA,UAAA;EACN;EAVH,QAAiB,UAAU,IAAY;EAYvC,SACCC,SACmE;AACnE,WAAO,IAAI;MACV,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACLA,UAAUA,UAAyC,CAAC;MACpD;IACD;EACD;EAEA,UACCA,SACgF;AAChF,WAAO,IAAI;MACV,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACL,KAAK;MACLA,UAAS,EAAE,GAAIA,SAAoD,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE;MAC3F;IACD;EACD;AACD;AAEO,IAAM,oBAAN,cAAyC,aAEhD;EAQC,YACS,YACA,QACA,eACA,OACA,aACA,SACA,SACAA,SACA,MACP;AACD,UAAM;AAVE,SAAA,aAAA;AACA,SAAA,SAAA;AACA,SAAA,gBAAA;AACA,SAAA,QAAA;AACA,SAAA,cAAA;AACA,SAAA,UAAA;AACA,SAAA,UAAA;AACA,SAAA,SAAAA;AACA,SAAA,OAAA;EAGT;EAnBA,QAA0B,UAAU,IAAY;;EAsBhD,SAAS,MAA4E;AACpF,WAAO,OAAO,gBAAgB,wBAAwB,MAAM;AAC3D,YAAM,EAAE,OAAO,WAAW,IAAI,KAAK,OAAO;AAE1C,aAAO,KAAK,QAAQ;QACnB;QACA;QACA;QACA;QACA,CAAC,SAAS,mBAAmB;AAC5B,gBAAM,OAAO,QAAQ;YAAI,CAAC,QACzB,iBAAiB,KAAK,QAAQ,KAAK,aAAa,KAAK,MAAM,WAAW,cAAc;UACrF;AACA,cAAI,KAAK,SAAS,SAAS;AAC1B,mBAAO,KAAK,CAAC;UACd;AACA,iBAAO;QACR;MACD;IACD,CAAC;EACF;EAEA,QAAQ,MAA2E;AAClF,WAAO,KAAK,SAAS,IAAI;EAC1B;EAEQ,YAAY;AACnB,WAAO,KAAK,QAAQ,8BAA8B;MACjD,YAAY,KAAK;MACjB,QAAQ,KAAK;MACb,eAAe,KAAK;MACpB,OAAO,KAAK;MACZ,aAAa,KAAK;MAClB,aAAa,KAAK;MAClB,YAAY,KAAK,YAAY;IAC9B,CAAC;EACF;;EAGA,SAAc;AACb,WAAO,KAAK,UAAU,EAAE;EACzB;EAEQ,SAA8E;AACrF,UAAM,QAAQ,KAAK,UAAU;AAE7B,UAAM,aAAa,KAAK,QAAQ,WAAW,MAAM,GAAU;AAE3D,WAAO,EAAE,OAAO,WAAW;EAC5B;EAEA,QAAe;AACd,WAAO,KAAK,OAAO,EAAE;EACtB;EAEQ;;EAER,SAAS,OAAe;AACvB,SAAK,YAAY;AACjB,WAAO;EACR;EAES,UAA4B;AACpC,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,aAAO,KAAK,SAAS,EAAE,QAAQ,QAAW,KAAK,SAAS;IACzD,CAAC;EACF;AACD;;;ACpJO,IAAM,QAAN,cAA6B,aAEpC;EAQC,YACQ,SACCC,MACA,OACA,gBACP;AACD,UAAM;AALC,SAAA,UAAA;AACC,SAAA,MAAAA;AACA,SAAA,QAAA;AACA,SAAA,iBAAA;EAGT;EAdA,QAA0B,UAAU,IAAY;;EAiBhD,SAAS;AACR,WAAO,KAAK;EACb;EAEA,WAAW;AACV,WAAO,KAAK;EACb;EAEA,UAAU,QAAiB,aAAuB;AACjD,WAAO,cAAc,KAAK,eAAe,MAAM,IAAI;EACpD;EAEA,WAA0B;AACzB,WAAO;EACR;;EAGA,wBAAwB;AACvB,WAAO;EACR;AACD;;;ACdO,IAAM,aAAN,MAIL;EAgBD,YAEU,SAEA,SACT,QACC;AAJQ,SAAA,UAAA;AAEA,SAAA,UAAA;AAGT,SAAK,IAAI,SACN;MACD,QAAQ,OAAO;MACf,YAAY,OAAO;MACnB,eAAe,OAAO;MACtB;IACD,IACE;MACD,QAAQ;MACR,YAAY,CAAC;MACb,eAAe,CAAC;MAChB;IACD;AACD,SAAK,QAAQ,CAAC;AACd,QAAI,KAAK,EAAE,QAAQ;AAClB,iBAAW,CAAC,WAAW,OAAO,KAAK,OAAO,QAAQ,KAAK,EAAE,MAAM,GAAG;AAChE,aAAK,MAAiE,SAAS,IAAI,IAAI;UACvF,OAAQ;UACR,KAAK,EAAE;UACP,KAAK,EAAE;UACP,OAAQ,WAAW,SAAS;UAC5B;UACA;UACA;QACD;MACD;IACD;EACD;EAjDA,QAAiB,UAAU,IAAY;EASvC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA0EA,MAA6B,OAAe;AAC3C,UAAM,OAAO;AACb,WAAO;MACN,GACC,IACgD;AAChD,YAAI,OAAO,OAAO,YAAY;AAC7B,eAAK,GAAG,IAAI,aAAa,KAAK,OAAO,CAAC;QACvC;AAEA,eAAO,IAAI;UACV,IAAI,aAAa,GAAG,OAAO,GAAG,GAAG,kBAAkB,GAAqB,OAAO,IAAI;UACnF,IAAI,sBAAsB,EAAE,OAAO,oBAAoB,SAAS,aAAa,QAAQ,CAAC;QACvF;MACD;IACD;EACD;EAEA,OACC,QACA,SACC;AACD,WAAO,IAAI,eAAe,EAAE,QAAQ,SAAS,SAAS,KAAK,QAAQ,CAAC;EACrE;;;;;;;;;;;;;;;;;;;;EAqBA,QAAQ,SAAyB;AAChC,UAAM,OAAO;AAwCb,aAAS,OAAO,QAAsE;AACrF,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS,KAAK;QACd,SAAS,KAAK;QACd,UAAU;MACX,CAAC;IACF;AA4BA,aAAS,eAAe,QAAsE;AAC7F,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS,KAAK;QACd,SAAS,KAAK;QACd,UAAU;QACV,UAAU;MACX,CAAC;IACF;AAgCA,aAAS,iBACR,IACA,QAC8C;AAC9C,aAAO,IAAI,gBAAgB;QAC1B,QAAQ,UAAU;QAClB,SAAS,KAAK;QACd,SAAS,KAAK;QACd,UAAU;QACV,UAAU,EAAE,GAAG;MAChB,CAAC;IACF;AA6BA,aAAS,OAA+B,OAAsD;AAC7F,aAAO,IAAI,gBAAgB,OAAO,KAAK,SAAS,KAAK,SAAS,OAAO;IACtE;AA0BA,aAAS,OAA+B,OAAsD;AAC7F,aAAO,IAAI,gBAAgB,OAAO,KAAK,SAAS,KAAK,SAAS,OAAO;IACtE;AA0BA,aAAS,QAAgC,OAAmD;AAC3F,aAAO,IAAI,aAAa,OAAO,KAAK,SAAS,KAAK,SAAS,OAAO;IACnE;AAEA,WAAO,EAAE,QAAQ,gBAAgB,kBAAkB,QAAQ,QAAQ,QAAQ,QAAQ;EACpF;EAwCA,OAAO,QAAsE;AAC5E,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS,KAAK;MACd,SAAS,KAAK;IACf,CAAC;EACF;EA4BA,eAAe,QAAsE;AACpF,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS,KAAK;MACd,SAAS,KAAK;MACd,UAAU;IACX,CAAC;EACF;EAgCA,iBACC,IACA,QAC8C;AAC9C,WAAO,IAAI,gBAAgB;MAC1B,QAAQ,UAAU;MAClB,SAAS,KAAK;MACd,SAAS,KAAK;MACd,UAAU,EAAE,GAAG;IAChB,CAAC;EACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6BA,OAA+B,OAAsD;AACpF,WAAO,IAAI,gBAAgB,OAAO,KAAK,SAAS,KAAK,OAAO;EAC7D;;;;;;;;;;;;;;;;;;;;;;;;;EA0BA,OAA+B,OAAsD;AACpF,WAAO,IAAI,gBAAgB,OAAO,KAAK,SAAS,KAAK,OAAO;EAC7D;;;;;;;;;;;;;;;;;;;;;;;;;EA0BA,OAA+B,OAAmD;AACjF,WAAO,IAAI,aAAa,OAAO,KAAK,SAAS,KAAK,OAAO;EAC1D;EAEA,wBAA0D,MAAsD;AAC/G,WAAO,IAAI,0BAA0B,MAAM,KAAK,SAAS,KAAK,OAAO;EACtE;EAEU;EAEV,QACC,OAC+C;AAC/C,UAAM,SAAS,OAAO,UAAU,WAAW,IAAI,IAAI,KAAK,IAAI,MAAM,OAAO;AACzE,UAAM,aAAa,KAAK,QAAQ,WAAW,MAAM;AACjD,UAAM,WAAW,KAAK,QAAQ;MAG7B;MACA;MACA;MACA;IACD;AACA,WAAO,IAAI;MACV,MAAM,SAAS,QAAQ,QAAW,KAAK,SAAS;MAChD;MACA;MACA,CAAC,WAAW,SAAS,UAAU,QAAQ,IAAI;IAC5C;EACD;EAEA,YACC,aACAC,SACa;AACb,WAAO,KAAK,QAAQ,YAAY,aAAaA,OAAM;EACpD;AACD;;;ACxgBO,IAAM,iBAAN,MAAqB;EAG3B,YAAoB,QAAyB,MAAe;AAAxC,SAAA,SAAA;AAAyB,SAAA,OAAA;EAAgB;EAF7D,QAAiB,UAAU,IAAY;EAIvC,MAAM,SAAkG;AACvG,WAAO,IAAI;MACV,QAAQ,IAAI,CAAC,OAAO;AACnB,YAAI,GAAG,IAAI,GAAG,GAAG;AAChB,iBAAO;QACR;AACA,aAAK;AACL,cAAM,sBAAsB,IAAI,cAAc,GAAG,MAAM,CAAC,CAAC,GAAG,WAAW,GAAG,YAAa,GAAG,WAAY;AACtG,WAAG,cAAc,KAAK,MAAM,KAAK,UAAU,GAAG,aAAa,CAAC;AAC5D,eAAO;MACR,CAAC;MACD,KAAK;MACL;MACA,KAAK;IACN;EACD;EAEA,UAAU,SAAkG;AAC3G,WAAO,IAAI;MACV,QAAQ,IAAI,CAAC,OAAO;AACnB,YAAI,GAAG,IAAI,GAAG,GAAG;AAChB,iBAAO;QACR;AACA,aAAK;AACL,cAAM,sBAAsB,IAAI,cAAc,GAAG,MAAM,CAAC,CAAC,GAAG,WAAW,GAAG,YAAa,GAAG,WAAY;AACtG,WAAG,cAAc,GAAG;AACpB,eAAO;MACR,CAAC;MACD,KAAK;MACL;MACA,KAAK;IACN;EACD;;;;;;;;;;;;EAaA,MACC,WACG,SACY;AACf,WAAO,IAAI;MACV,QAAQ,IAAI,CAAC,OAAO;AACnB,YAAI,GAAG,IAAI,GAAG,GAAG;AAChB,iBAAO;QACR;AACA,aAAK;AACL,cAAM,sBAAsB,IAAI,cAAc,GAAG,MAAM,CAAC,CAAC,GAAG,WAAW,GAAG,YAAa,GAAG,WAAY;AACtG,WAAG,cAAc,KAAK,MAAM,KAAK,UAAU,GAAG,aAAa,CAAC;AAC5D,eAAO;MACR,CAAC;MACD,KAAK;MACL;MACA,KAAK;MACL;IACD;EACD;AACD;AASO,IAAM,eAAN,MAA8C;EACpD,QAAiB,UAAU,IAAY;;EAGvC;EAEA,YACC,SACA,QACA,MACA,MACA,SAAiB,SAChB;AACD,SAAK,SAAS;MACb;MACA;MACA;MACA;MACA;IACD;EACD;EAEA,eAAqB;AACpB,SAAK,OAAO,eAAe;AAC3B,WAAO;EACR;EAEA,KAAK,KAAgC;AACpC,SAAK,OAAO,OAAO;AACnB,WAAO;EACR;EAEA,MAAM,WAAsB;AAC3B,SAAK,OAAO,QAAQ;AACpB,WAAO;EACR;;EAGA,MAAM,OAAuB;AAC5B,WAAO,IAAI,MAAM,KAAK,QAAQ,KAAK;EACpC;AACD;AAEO,IAAM,QAAN,MAAY;EAClB,QAAiB,UAAU,IAAY;EAE9B;EAET,YAAYC,SAAqB,OAAgB;AAChD,SAAK,SAAS,EAAE,GAAGA,SAAQ,MAAM;EAClC;AACD;AAMO,SAAS,MAAM,MAA+B;AACpD,SAAO,IAAI,eAAe,OAAO,IAAI;AACtC;AAEO,SAAS,YAAY,MAA+B;AAC1D,SAAO,IAAI,eAAe,MAAM,IAAI;AACrC;;;AC1OO,IAAe,kBAAf,MAAuF;EAC7F,YAAsB,OAAc;AAAd,SAAA,QAAA;EAAe;EAE3B;EAEV,WAAkB;AACjB,WAAO,KAAK;EACb;EAEA,UAAU,UAAmB,cAAiC;AAC7D,WAAO;EACR;;EAGA,SAAS,OAAgB;AACxB,SAAK,YAAY;AACjB,WAAO;EACR;EAEA,QAAiB,UAAU,IAAY;;EAGvC;AAaD;AAQO,IAAe,YAAf,MAIL;EAGD,YAAsB,SAAoB;AAApB,SAAA,UAAA;EAAqB;EAF3C,QAAiB,UAAU,IAAY;;EAgBvC,QAAW,OAAY,OAA4B;AAClD,WAAO,OAAO,gBAAgB,qBAAqB,MAAM;AACxD,YAAM,WAAW,OAAO,gBAAgB,wBAAwB,MAAM;AACrE,eAAO,KAAK;UACX,KAAK,QAAQ,WAAW,KAAK;UAC7B;UACA;UACA;QACD;MACD,CAAC;AAED,aAAO,SAAS,SAAS,KAAK,EAAE,QAAQ,QAAW,KAAK;IACzD,CAAC;EACF;EAEA,IAAiB,OAA0B;AAC1C,WAAO,KAAK;MACX,KAAK,QAAQ,WAAW,KAAK;MAC7B;MACA;MACA;IACD,EAAE,IAAI;EACP;;EAMA,MAAM,MAAMC,OAAU,OAAiC;AACtD,UAAM,MAAM,MAAM,KAAK,QAA6BA,OAAK,KAAK;AAE9D,WAAO;MACN,IAAI,CAAC,EAAE,OAAO;IACf;EACD;AAMD;AAEO,IAAe,gBAAf,cAIG,WAA+C;EAGxD,YACC,SACA,SACU,QAKS,cAAc,GAChC;AACD,UAAM,SAAS,SAAS,MAAM;AAPpB,SAAA,SAAA;AAKS,SAAA,cAAA;EAGpB;EAbA,QAA0B,UAAU,IAAY;EAehD,WAAkB;AACjB,UAAM,IAAI,yBAAyB;EACpC;;EAGA,wBAAwBC,SAAkC;AACzD,UAAM,SAAmB,CAAC;AAC1B,QAAIA,QAAO,gBAAgB;AAC1B,aAAO,KAAK,mBAAmBA,QAAO,cAAc,EAAE;IACvD;AACA,QAAIA,QAAO,YAAY;AACtB,aAAO,KAAKA,QAAO,UAAU;IAC9B;AACA,QAAI,OAAOA,QAAO,eAAe,WAAW;AAC3C,aAAO,KAAKA,QAAO,aAAa,eAAe,gBAAgB;IAChE;AACA,WAAO,IAAI,IAAI,OAAO,KAAK,GAAG,CAAC;EAChC;EAEA,eAAeA,SAA4C;AAC1D,WAAO,KAAK,QAAQ,QAAQ,sBAAsB,KAAK,wBAAwBA,OAAM,CAAC,EAAE;EACzF;AAKD;;;ACvJA,IAAM,iBAAiB;EACtB,WAAW;EACX,aAAa;AACd;AACA,IAAM,cAAc;EACnB,WAAW;EACX,aAAa;AACd;AAEO,IAAM,wBAAN,cAAmE,gBAAmB;EAG5F,YACS,QACR,OACQC,SACA,QACA,wBACA,oBACP;AACD,UAAM,KAAK;AAPH,SAAA,SAAA;AAEA,SAAA,SAAAA;AACA,SAAA,SAAA;AACA,SAAA,yBAAA;AACA,SAAA,qBAAA;EAGT;EAXA,QAA0B,UAAU,IAAY;;EAiBhD,MAAM,QACL,oBAAyD,CAAC,GAC1D,QAA4B,KAAK,WACT;AACxB,UAAM,SAAS,iBAAiB,KAAK,MAAM,QAAQ,iBAAiB;AAEpE,SAAK,OAAO,SAAS,KAAK,MAAM,KAAK,MAAM;AAE3C,UAAM,EAAE,QAAQ,QAAQ,OAAO,mBAAmB,IAAI;AAEtD,QAAI,CAAC,UAAU,CAAC,oBAAoB;AACnC,aAAO;QACN,MAAM;QACN;QACA,UAAU,SACP,iBACA;UACD,GAAG;UACH,WAAW;QACZ;MACF;IACD;AAEA,UAAM,SAAS,MAAM;MACpB,MAAM;MACN;MACA,UAAU,SACP,cACA;QACD,GAAG;QACH,WAAW;MACZ;IACF;AAEA,WAAO,KAAK,UAAU,MAAM;EAC7B;EAES,UAAU,QAA0B;AAC5C,QAAI,CAAC,KAAK,UAAU,CAAC,KAAK,oBAAoB;AAC7C,aAAO;IACR;AAEA,UAAM,OAAQ,OAAkC;AAEhD,QAAI,KAAK,oBAAoB;AAC5B,aAAO,KAAK,mBAAmB,IAAI;IACpC;AAEA,WAAO,KAAK,IAAI,CAAC,QAAQ,aAAa,KAAK,QAAS,KAAK,KAAK,mBAAmB,CAAC;EACnF;EAEA,IAAI,oBAAyD,CAAC,GAAsB;AACnF,UAAM,SAAS,iBAAiB,KAAK,MAAM,QAAQ,iBAAiB;AACpE,SAAK,OAAO,SAAS,KAAK,MAAM,KAAK,MAAM;AAC3C,WAAO,KAAK;MACX,KAAK,MAAM;MACX;MACA,KAAK,cAAc,SAAY,iBAAiB;QAC/C,GAAG;QACH,WAAW,KAAK;MACjB;IACD,EAAE,KAAK,CAAC,WAAW,OAAO,IAAI;EAC/B;;EAMA,OAAO,oBAAyD,CAAC,GAAG,OAAsC;AACzG,UAAM,SAAS,iBAAiB,KAAK,MAAM,QAAQ,iBAAiB;AACpE,SAAK,OAAO,SAAS,KAAK,MAAM,KAAK,MAAM;AAC3C,WAAO,KAAK,OAAO,KAAK,MAAM,KAAK,QAAQ,EAAE,WAAW,MAAM,aAAa,MAAM,WAAW,MAAM,CAAC,EAAE,KAAK,CACzG,WACI,OAAO,IAAI;EACjB;;EAGA,wBAAwB;AACvB,WAAO,KAAK;EACb;AACD;AAMO,IAAM,kBAAN,cAGG,UAAwD;EAKjE,YACS,QACR,SACQ,QACA,UAAkC,CAAC,GAC1C;AACD,UAAM,OAAO;AALL,SAAA,SAAA;AAEA,SAAA,SAAA;AACA,SAAA,UAAA;AAGR,SAAK,SAAS,QAAQ,UAAU,IAAI,WAAW;EAChD;EAZA,QAA0B,UAAU,IAAY;EAExC;EAYR,aACC,OACA,QACA,MACA,uBACA,oBACqB;AACrB,WAAO,IAAI;MACV,KAAK;MACL;MACA,KAAK;MACL;MACA;MACA;IACD;EACD;EAEA,MAAM,MACL,SACC;AACD,UAAM,kBAAmC,CAAC;AAC1C,UAAM,eAA8C,CAAC;AAErD,eAAW,SAAS,SAAS;AAC5B,YAAM,gBAAgB,MAAM,SAAS;AACrC,YAAM,aAAa,cAAc,SAAS;AAC1C,sBAAgB,KAAK,aAAa;AAClC,mBAAa;QACZ,KAAK,OAAO,WAAW,KAAK,WAAW,QAAQ;UAC9C,aAAa;UACb,WAAW,cAAc,sBAAsB;QAChD,CAAC;MACF;IACD;AAEA,UAAM,eAAe,MAAM,KAAK,OAAO,YAAY,cAAc,WAAW;AAE5E,WAAO,aAAa,IAAI,CAAC,QAAQ,MAAM,gBAAgB,CAAC,EAAG,UAAU,QAAQ,IAAI,CAAC;EACnF;;EAGA,MAAM,MAAM,OAAe,QAAoD;AAC9E,SAAK,OAAO,SAAS,OAAO,MAAM;AAClC,UAAM,SAAS,MAAM,KAAK,OAAO,OAAO,QAAQ,EAAE,WAAW,MAAM,aAAa,KAAK,CAAC;AACtF,WAAO;EACR;;EAGA,MAAM,aACL,OACA,QACmC;AACnC,WAAO,KAAK,OAAO,OAAO,QAAQ,EAAE,WAAW,OAAO,aAAa,KAAK,CAAC;EAC1E;;EAMA,MAAe,MAAMC,MAAU,OAAiC;AAC/D,UAAM,MAAM,MAAM,KAAK,QAAuCA,MAAK,KAAK;AAExE,WAAO;MACN,IAAI,MAAM,EAAE,CAAC,EAAE,OAAO;IACvB;EACD;EAEA,MAAe,YACd,cAEA,UAA+B,CAAC,GACnB;AACb,UAAM,IAAI,MAAM,6CAA6C;EAC9D;AACD;AAEO,IAAM,kBAAN,cAGG,cAA4D;EACrE,QAA0B,UAAU,IAAY;EAEhD,MAAe,YAAe,cAAqF;AAClH,UAAM,IAAI,MAAM,6CAA6C;EAY9D;AACD;;;AhFnOO,IAAM,iBAAN,MAAqB;EAG3B,YACS,QACA,SACA,UAA6B,CAAC,GACrC;AAHO,SAAA,SAAA;AACA,SAAA,UAAA;AACA,SAAA,UAAA;AAER,SAAK,YAAY;EAClB;EARA,QAAiB,UAAU,IAAY;EAUvC,cACC,QACmE;AACnE,WAAO,IAAI,gBAAgB,KAAK,QAAQ,KAAK,SAAS,QAAQ,EAAE,QAAQ,KAAK,QAAQ,OAAO,CAAC;EAC9F;EAEA,cAAc;AACb,4BAAM,cAAc,wBAAM,SAAS,aAAa,CAAC,QAAQ,GAAG;AAC5D,4BAAM,cAAc,wBAAM,SAAS,WAAW,CAAC,QAAQ,GAAG;AAC1D,4BAAM,cAAc,wBAAM,SAAS,MAAM,CAAC,QAAQ,GAAG;AACrD,4BAAM,cAAc,wBAAM,SAAS,UAAU,CAAC,QAAQ,GAAG;EAC1D;AACD;AAEA,SAAS,KACR,QACA,OACA,IACA,MACC;AACD,SAAO,IAAI,MAAM,QAAQ;IACxB,IAAIC,SAAQ,GAAG;AACd,YAAM,UAAUA,QAAO,CAAmB;AAC1C,UAAI,OAAO,YAAY,eAAe,OAAO,YAAY,YAAY,YAAY;AAAO,eAAO;AAE/F,UAAI;AAAM,eAAO,KAAK,SAAS,OAAO,EAAE;AACxC,UAAI,MAAM;AAAS,eAAO,KAAK,SAAS,OAAO,IAAI,IAAI;AAEvD,aAAO,IAAI,MAAM,SAAgB;QAChC,MAAMA,SAAQ,SAAS,UAAU;AAChC,gBAAM,MAAMA,QAAO,KAAK,SAAS,GAAG,QAAQ;AAC5C,cAAI,cAAc,OAAO,OAAO,IAAI,aAAa,YAAY;AAC5D,gBAAI,SAAS,KAAK;UACnB;AACA,iBAAO,GAAGA,SAAQ,GAAG,GAAG;QACzB;MACD,CAAC;IACF;EACD,CAAC;AACF;AAEO,IAAM,mBAAN,cAEG,WAA4C;EACrD,QAA0B,UAAU,IAAY;EAEhD,UACC,OAiBC;AACD,SAAK,YAAY;AAEjB,WAAO,KAAK,MAAM,OAAO,CAAC,QAAQ,GAAG,QAAQ;AAC5C,UAAI,MAAM,QAAQ;AACjB,eAAO,KAAK,KAAK,OAAO,CAAC,GAAG,IAAIC,SAAQA,IAAG;MAC5C;AACA,aAAO;IACR,CAAC;EACF;EAKA,MAAM,MACL,OAC4B;AAC5B,WAAO,KAAK,QAAQ,MAAM,KAAK;EAChC;AACD;AAEA,SAAS,UAIR,QACAC,UAAiC,CAAC,GAGjC;AACD,QAAM,UAAU,IAAI,UAAU,EAAE,QAAQA,QAAO,OAAO,CAAC;AACvD,MAAIC;AACJ,MAAID,QAAO,WAAW,MAAM;AAC3B,IAAAC,UAAS,IAAI,cAAc;EAC5B,WAAWD,QAAO,WAAW,OAAO;AACnC,IAAAC,UAASD,QAAO;EACjB;AAEA,MAAI;AACJ,MAAIA,QAAO,QAAQ;AAClB,UAAM,eAAe;MACpBA,QAAO;MACP;IACD;AACA,aAAS;MACR,YAAYA,QAAO;MACnB,QAAQ,aAAa;MACrB,eAAe,aAAa;IAC7B;EACD;AAEA,QAAM,SAAS,IAAI,eAAe,QAAQ,SAAS,EAAE,QAAAC,QAAO,CAAC;AAC7D,QAAM,UAAU,OAAO,cAAc,MAAM;AAE3C,QAAMC,MAAK,IAAI;IACd;IACA;IACA;EACD;AACO,EAAAA,IAAI,UAAU;AAErB,SAAOA;AACR;AAEO,SAAS,WAIZ,QAiBF;AACD,MAAI,OAAO,OAAO,CAAC,MAAM,UAAU;AAClC,UAAM,eAAW,wBAAK,OAAO,CAAC,CAAW;AACzC,WAAO,UAAU,UAAU,OAAO,CAAC,CAAC;EACrC;AAEA,MAAI,SAAS,OAAO,CAAC,CAAC,GAAG;AACxB,UAAM,EAAE,YAAY,QAAQ,GAAG,cAAc,IAAI,OAAO,CAAC;AAWzD,QAAI;AAAQ,aAAO,UAAU,QAAQ,aAAa;AAElD,QAAI,OAAO,eAAe,UAAU;AACnC,YAAM,EAAE,kBAAkB,GAAG,QAAQ,IAAI;AAEzC,YAAMC,gBAAW,wBAAK,kBAAkB,OAAO;AAE/C,aAAO,UAAUA,WAAU,aAAa;IACzC;AAEA,UAAM,eAAW,wBAAK,UAAW;AAEjC,WAAO,UAAU,UAAU,aAAa;EACzC;AAEA,SAAO,UAAU,OAAO,CAAC,GAAc,OAAO,CAAC,CAAuC;AACvF;CAEO,CAAUC,aAAV;AACC,WAAS,KACfJ,SAGC;AACD,WAAO,UAAU,CAAC,GAAUA,OAAM;EACnC;AANOI,WAAS,OAAA;AAAA,GADA,YAAA,UAAA,CAAA,EAAA;;;AiFrNjB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACGO,IAAM,aAAa,QAAQ,cAAc;AAAA,EAC9C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACxD,aAAa,KAAK,aAAa;AAAA,EAC/B,UAAU,QAAQ,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9C,UAAU,KAAK,WAAW,EAAE,WAAW,MAAmB,WAAW,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EACjG,UAAU,QAAQ,WAAW,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,EACrD,WAAW,QAAQ,YAAY,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACpD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAEM,IAAM,sBAAsB,UAAU,YAAY,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EAC3E,QAAQ,IAAI,YAAY;AAAA,IACtB,QAAQ,CAAC,WAAW,QAAQ;AAAA,IAC5B,YAAY,CAAC,WAAW,EAAE;AAAA,IAC1B,cAAc;AAAA,EAChB,CAAC;AAAA,EACD,UAAU,KAAK,YAAY,EAAE,cAAc,cAAc,CAAC;AAC5D,EAAE;;;AClBK,IAAM,oBAAoB,OAAO,kBAAkB,CAAC,SAAS,UAAU,UAAU,CAAC;AAGlF,IAAM,WAAW,QAAQ,YAAY;AAAA,EAC1C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,KAAK,QAAQ,OAAO,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACtD,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACxD,aAAa,KAAK,aAAa;AAAA,EAC/B,kBAAkB,QAAQ,qBAAqB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9D,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,WAAW,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EACxF,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAGvC,WAAW,QAAQ,cAAc,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EACtE,WAAW,QAAQ,cAAc,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EAC5D,gBAAgB,QAAQ,oBAAoB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA;AAAA,EAGvE,QAAQ,QAAQ,UAAU,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA;AAAA,EACrD,YAAY,MAAM,YAAY,EAAE,MAA2D;AAAA;AAAA,EAG3F,eAAe,QAAQ,gBAAgB,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EAC5D,mBAAmB,QAAQ,qBAAqB,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACrE,gBAAgB,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,EACjE,gBAAgB,QAAQ,iBAAiB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA;AAAA,EAGlE,QAAQ,MAAM,QAAQ,EAAE,QAAQ,CAAC,CAAC,EAAE,MAA6E;AAAA,EACjH,QAAQ,MAAM,QAAQ,EAAE,QAAQ,CAAC,CAAC,EAAE,MAA8C;AAAA,EAClF,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAGtD,MAAM,MAAM,MAAM,EAAE,QAAQ,CAAC,CAAC,EAAE,MAAgB;AAAA,EAChD,gBAAgB,MAAM,gBAAgB,EAAE,QAAQ,CAAC,CAAC,EAAE,MAA8B;AAAA,EAClF,UAAU,MAAM,UAAU,EAAE,QAAQ,CAAC,CAAC,EAAE,MAAgB;AAAA;AAAA,EAGxD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,EAChD,iBAAiB,QAAQ,oBAAoB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAG5D,QAAQ,kBAAkB,QAAQ,EAAE,QAAQ,OAAO,EAAE,QAAQ;AAAA,EAC7D,YAAY,QAAQ,aAAa,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EAC1D,WAAW,QAAQ,YAAY,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACxD,kBAAkB,QAAQ,mBAAmB,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA;AAAA,EAGrE,YAAY,QAAQ,eAAe,EAAE,QAAQ,IAAI,CAAC;AAAA,EAClD,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAGpD,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACtD,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAGpD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,kBAAkB,QAAQ,oBAAoB;AAAA,EACzD,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,SAAS,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EAC7F,KAAK,QAAQ,OAAO,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACtD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,SAAS,MAAM,SAAS,EAAE,QAAQ,EAAE,MAA8B;AAAA,EAClE,WAAW,QAAQ,cAAc,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EACtE,eAAe,QAAQ,gBAAgB,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EAC5D,UAAU,QAAQ,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9C,UAAU,QAAQ,WAAW,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,EACrD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,oBAAoB,UAAU,UAAU,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EACvE,UAAU,IAAI,YAAY;AAAA,IACxB,QAAQ,CAAC,SAAS,UAAU;AAAA,IAC5B,YAAY,CAAC,WAAW,EAAE;AAAA,EAC5B,CAAC;AAAA,EACD,UAAU,KAAK,eAAe;AAChC,EAAE;AAEK,IAAM,2BAA2B,UAAU,iBAAiB,CAAC,EAAE,IAAI,OAAO;AAAA,EAC/E,SAAS,IAAI,UAAU;AAAA,IACrB,QAAQ,CAAC,gBAAgB,SAAS;AAAA,IAClC,YAAY,CAAC,SAAS,EAAE;AAAA,EAC1B,CAAC;AACH,EAAE;;;AC5FK,IAAM,YAAY,QAAQ,aAAa;AAAA,EAC5C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,YAAY,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC,EAAE,OAAO;AAAA,EAC5D,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACjD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,EAChD,UAAU,QAAQ,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9C,OAAO,QAAQ,SAAS,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,EAGtC,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACtD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,UAAU,EAAE,QAAQ;AAAA;AAAA;AAAA,EAGlE,eAAe,QAAQ,gBAAgB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EAChE,iBAAiB,UAAU,mBAAmB;AAAA;AAAA,EAG9C,wBAAwB,MAAM,0BAA0B,EAAE,MAWvD;AAAA,EACH,uBAAuB,MAAM,yBAAyB,EAAE,MAWrD;AAAA;AAAA,EAGH,eAAe,QAAQ,gBAAgB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EAChE,iBAAiB,UAAU,mBAAmB;AAAA,EAC9C,qBAAqB,KAAK,uBAAuB;AAAA;AAAA,EAGjD,SAAS,QAAQ,UAAU,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACpD,UAAU,QAAQ,WAAW,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,EACrD,kBAAkB,QAAQ,mBAAmB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACtE,OAAO,KAAK,OAAO;AAAA,EACnB,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,MAAM;AAAA;AAAA,EAG7C,YAAY,QAAQ,aAAa,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EAEtD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,YAAY,QAAQ,aAAa;AAAA,EAC5C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EAChG,MAAM,QAAQ,QAAQ,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA;AAAA,EAC9C,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC1D,UAAU,QAAQ,aAAa,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACxD,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3C,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAChE,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACtD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC;AAAA,EACvC,YAAY,QAAQ,eAAe,EAAE,QAAQ,GAAG,CAAC;AAAA,EACjD,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACrD,OAAO,QAAQ,SAAS,EAAE,QAAQ,GAAG,CAAC;AAAA,EACtC,WAAW,QAAQ,YAAY,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,qBAAqB,UAAU,WAAW,CAAC,EAAE,KAAK,OAAO;AAAA,EACpE,WAAW,KAAK,SAAS;AAC3B,EAAE;AAEK,IAAM,qBAAqB,UAAU,WAAW,CAAC,EAAE,IAAI,OAAO;AAAA,EACnE,UAAU,IAAI,WAAW;AAAA,IACvB,QAAQ,CAAC,UAAU,UAAU;AAAA,IAC7B,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AACH,EAAE;;;AC5FK,IAAM,mBAAmB,OAAO,iBAAiB,CAAC,cAAc,cAAc,CAAC;AAG/E,IAAM,aAAa,QAAQ,eAAe;AAAA,EAC/C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACvD,aAAa,KAAK,aAAa;AAAA;AAAA,EAG/B,cAAc,iBAAiB,eAAe,EAAE,QAAQ;AAAA,EACxD,eAAe,QAAQ,kBAAkB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA;AAAA,EAG9E,oBAAoB,QAAQ,wBAAwB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EAC/E,uBAAuB,QAAQ,2BAA2B,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EACrF,YAAY,QAAQ,aAAa;AAAA,EACjC,YAAY,QAAQ,aAAa,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACtD,uBAAuB,QAAQ,0BAA0B,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA,EAG9E,UAAU,UAAU,WAAW;AAAA,EAC/B,WAAW,UAAU,YAAY;AAAA,EACjC,UAAU,QAAQ,WAAW,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA;AAAA,EAGrD,mBAAmB,KAAK,qBAAqB,EAAE,MAAM;AAAA,EACrD,qBAAqB,KAAK,uBAAuB,EAAE,MAAM;AAAA,EACzD,aAAa,KAAK,cAAc,EAAE,MAAM;AAAA,EAExC,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;;;AC3BM,IAAM,kBAAkB,OAAO,gBAAgB,CAAC,WAAW,aAAa,cAAc,WAAW,aAAa,WAAW,CAAC;AAC1H,IAAM,oBAAoB,OAAO,kBAAkB,CAAC,WAAW,QAAQ,YAAY,QAAQ,CAAC;AAC5F,IAAM,oBAAoB,OAAO,kBAAkB,CAAC,OAAO,UAAU,UAAU,iBAAiB,MAAM,CAAC;AAiBvG,IAAM,SAAS,QAAQ,UAAU;AAAA,EACtC,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACtE,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAGvF,QAAQ,gBAAgB,QAAQ,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA,EAC7D,eAAe,kBAAkB,gBAAgB,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA;AAAA,EAG9E,iBAAiB,MAAM,kBAAkB,EAAE,QAAQ,EAAE,MAAmB;AAAA,EACxE,gBAAgB,MAAM,iBAAiB,EAAE,QAAQ,EAAE,MAAmB;AAAA;AAAA;AAAA,EAItE,UAAU,QAAQ,YAAY,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACpE,kBAAkB,QAAQ,qBAAqB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EACpF,iBAAiB,QAAQ,qBAAqB,EAAE,WAAW,GAAG,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EAClF,mBAAmB,QAAQ,uBAAuB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EACvF,wBAAwB,QAAQ,4BAA4B,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ,GAAG,EAAE,QAAQ;AAAA,EAC9G,wBAAwB,QAAQ,4BAA4B,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ,GAAG,EAAE,QAAQ;AAAA,EAC9G,eAAe,QAAQ,kBAAkB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA;AAAA,EAG9E,aAAa,KAAK,eAAe,EAAE,WAAW,MAAM,WAAW,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EAC3F,mBAAmB,QAAQ,uBAAuB,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,EAGhE,eAAe,kBAAkB,gBAAgB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA;AAAA,EAG1E,gBAAgB,QAAQ,mBAAmB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC1D,gBAAgB,QAAQ,mBAAmB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC1D,aAAa,UAAU,cAAc;AAAA,EACrC,cAAc,UAAU,eAAe;AAAA,EACvC,WAAW,UAAU,YAAY;AAAA,EACjC,aAAa,UAAU,cAAc;AAAA;AAAA,EAGrC,eAAe,KAAK,gBAAgB;AAAA,EACpC,YAAY,KAAK,aAAa;AAAA,EAE9B,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,aAAa,QAAQ,eAAe;AAAA,EAC/C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,SAAS,KAAK,UAAU,EAAE,WAAW,MAAM,OAAO,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EACvF,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,SAAS,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EACpF,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,gBAAgB,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAG3F,qBAAqB,QAAQ,yBAAyB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/E,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC9D,wBAAwB,MAAM,0BAA0B,EAAE,MAA8B;AAAA,EAExF,UAAU,QAAQ,UAAU,EAAE,QAAQ;AAAA,EACtC,mBAAmB,QAAQ,uBAAuB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EAEvF,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,kBAAkB,UAAU,QAAQ,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EACnE,UAAU,IAAI,WAAW;AAAA,IACvB,QAAQ,CAAC,OAAO,UAAU;AAAA,IAC1B,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AAAA,EACD,WAAW,IAAI,YAAY;AAAA,IACzB,QAAQ,CAAC,OAAO,WAAW;AAAA,IAC3B,YAAY,CAAC,WAAW,EAAE;AAAA,EAC5B,CAAC;AAAA,EACD,OAAO,KAAK,UAAU;AACxB,EAAE;AAEK,IAAM,sBAAsB,UAAU,YAAY,CAAC,EAAE,IAAI,OAAO;AAAA,EACrE,OAAO,IAAI,QAAQ;AAAA,IACjB,QAAQ,CAAC,WAAW,OAAO;AAAA,IAC3B,YAAY,CAAC,OAAO,EAAE;AAAA,EACxB,CAAC;AAAA,EACD,SAAS,IAAI,UAAU;AAAA,IACrB,QAAQ,CAAC,WAAW,SAAS;AAAA,IAC7B,YAAY,CAAC,SAAS,EAAE;AAAA,EAC1B,CAAC;AAAA,EACD,SAAS,IAAI,iBAAiB;AAAA,IAC5B,QAAQ,CAAC,WAAW,SAAS;AAAA,IAC7B,YAAY,CAAC,gBAAgB,EAAE;AAAA,EACjC,CAAC;AACH,EAAE;;;AC9GK,IAAM,eAAe,QAAQ,iBAAiB;AAAA,EACnD,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,WAAW,QAAQ,YAAY,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA;AAAA,EAGxD,SAAS,QAAQ,YAAY,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC5C,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA,EACjF,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA;AAAA,EAG/E,iBAAiB,QAAQ,mBAAmB,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,EACpE,oBAAoB,QAAQ,uBAAuB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EAC5E,yBAAyB,QAAQ,4BAA4B,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACtF,SAAS,QAAQ,UAAU,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA;AAAA,EAGnD,YAAY,KAAK,aAAa;AAAA,EAC9B,YAAY,KAAK,aAAa;AAAA,EAC9B,iBAAiB,KAAK,mBAAmB;AAAA;AAAA,EAGzC,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;;;ACtBM,IAAM,sBAAsB,OAAO,oBAAoB,CAAC,SAAS,QAAQ,YAAY,YAAY,SAAS,CAAC;AAiB3G,IAAM,aAAa,QAAQ,cAAc;AAAA,EAC9C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,iBAAiB,QAAQ,oBAAoB,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EAC9E,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAGvF,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAChE,eAAe,QAAQ,kBAAkB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAClE,eAAe,QAAQ,kBAAkB,EAAE,QAAQ,GAAG,CAAC;AAAA,EACvD,iBAAiB,QAAQ,oBAAoB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC5D,iBAAiB,MAAM,kBAAkB,EAAE,MAAmB;AAAA;AAAA,EAG9D,QAAQ,oBAAoB,QAAQ,EAAE,QAAQ,OAAO,EAAE,QAAQ;AAAA;AAAA,EAG/D,YAAY,UAAU,aAAa;AAAA,EACnC,WAAW,QAAQ,YAAY,EAAE,QAAQ,EAAE;AAAA;AAAA,EAG3C,UAAU,QAAQ,YAAY,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACpE,UAAU,QAAQ,YAAY,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EACnE,SAAS,QAAQ,YAAY,EAAE,WAAW,GAAG,OAAO,EAAE,CAAC;AAAA,EACvD,WAAW,QAAQ,cAAc,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EAC5D,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,EACrD,eAAe,QAAQ,kBAAkB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EACpE,gBAAgB,QAAQ,mBAAmB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ,GAAG,EAAE,QAAQ;AAAA,EAC7F,OAAO,QAAQ,SAAS,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA;AAAA,EAG7D,OAAO,KAAK,OAAO;AAAA,EACnB,oBAAoB,KAAK,sBAAsB;AAAA;AAAA,EAG/C,QAAQ,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC1C,eAAe,KAAK,iBAAiB,EAAE,WAAW,MAAM,aAAa,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAGjG,oBAAoB,KAAK,uBAAuB,EAAE,WAAW,MAAM,OAAO,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAGtG,iBAAiB,QAAQ,oBAAoB,EAAE,QAAQ,GAAG,CAAC,EAAE,OAAO;AAAA,EACpE,gBAAgB,UAAU,kBAAkB;AAAA,EAC5C,UAAU,UAAU,WAAW;AAAA,EAE/B,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,iBAAiB,QAAQ,mBAAmB;AAAA,EACvD,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,aAAa,KAAK,cAAc,EAAE,WAAW,MAAM,WAAW,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EACnG,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,SAAS,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EACpF,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,gBAAgB,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAG3F,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,aAAa,KAAK,aAAa;AAAA,EAC/B,KAAK,QAAQ,OAAO,EAAE,QAAQ,IAAI,CAAC;AAAA,EACnC,UAAU,QAAQ,UAAU,EAAE,QAAQ;AAAA,EACtC,WAAW,QAAQ,cAAc,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC,EAAE,QAAQ;AAAA,EAEtE,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,sBAAsB,UAAU,YAAY,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EAC3E,UAAU,IAAI,WAAW;AAAA,IACvB,QAAQ,CAAC,WAAW,UAAU;AAAA,IAC9B,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AAAA,EACD,kBAAkB,IAAI,QAAQ;AAAA,IAC5B,QAAQ,CAAC,WAAW,kBAAkB;AAAA,IACtC,YAAY,CAAC,OAAO,EAAE;AAAA,EACxB,CAAC;AAAA,EACD,aAAa,IAAI,cAAc;AAAA,IAC7B,QAAQ,CAAC,WAAW,aAAa;AAAA,IACjC,YAAY,CAAC,aAAa,EAAE;AAAA,EAC9B,CAAC;AAAA,EACD,OAAO,KAAK,cAAc;AAC5B,EAAE;AAEK,IAAM,0BAA0B,UAAU,gBAAgB,CAAC,EAAE,IAAI,OAAO;AAAA,EAC7E,WAAW,IAAI,YAAY;AAAA,IACzB,QAAQ,CAAC,eAAe,WAAW;AAAA,IACnC,YAAY,CAAC,WAAW,EAAE;AAAA,EAC5B,CAAC;AAAA,EACD,SAAS,IAAI,UAAU;AAAA,IACrB,QAAQ,CAAC,eAAe,SAAS;AAAA,IACjC,YAAY,CAAC,SAAS,EAAE;AAAA,EAC1B,CAAC;AAAA,EACD,SAAS,IAAI,iBAAiB;AAAA,IAC5B,QAAQ,CAAC,eAAe,SAAS;AAAA,IACjC,YAAY,CAAC,gBAAgB,EAAE;AAAA,EACjC,CAAC;AACH,EAAE;AAGK,IAAM,4BAA4B,OAAO,2BAA2B;AAAA,EACzE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,CAAC;AAEM,IAAM,yBAAyB,OAAO,wBAAwB;AAAA,EACnE;AAAA,EACA;AAAA,EACA;AACF,CAAC;AAEM,IAAM,sBAAsB,QAAQ,wBAAwB;AAAA,EACjE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,aAAa,KAAK,cAAc,EAAE,WAAW,MAAM,WAAW,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGnG,cAAc,0BAA0B,eAAe,EAAE,QAAQ;AAAA,EACjE,aAAa,KAAK,aAAa,EAAE,QAAQ;AAAA;AAAA,EAGzC,WAAW,uBAAuB,YAAY,EAAE,QAAQ,QAAQ,EAAE,QAAQ;AAAA,EAC1E,SAAS,KAAK,UAAU;AAAA;AAAA,EACxB,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA;AAAA,EAGhD,UAAU,MAAM,UAAU,EAAE,MAA+B;AAAA,EAE3D,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAEM,IAAM,+BAA+B,UAAU,qBAAqB,CAAC,EAAE,IAAI,OAAO;AAAA,EACvF,WAAW,IAAI,YAAY;AAAA,IACzB,QAAQ,CAAC,oBAAoB,WAAW;AAAA,IACxC,YAAY,CAAC,WAAW,EAAE;AAAA,EAC5B,CAAC;AACH,EAAE;AAYK,IAAM,qBAAqB,QAAQ,uBAAuB;AAAA,EAC/D,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,aAAa,KAAK,aAAa;AAAA;AAAA,EAG/B,OAAO,MAAM,OAAO,EAAE,MAAsB,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;AAAA;AAAA,EAGlE,iBAAiB,QAAQ,oBAAoB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,EACxE,qBAAqB,QAAQ,yBAAyB,EAAE,QAAQ,GAAG,CAAC;AAAA,EACpE,gBAAgB,QAAQ,oBAAoB,EAAE,WAAW,GAAG,OAAO,EAAE,CAAC;AAAA,EACtE,kBAAkB,QAAQ,oBAAoB,EAAE,QAAQ,EAAE;AAAA;AAAA,EAG1D,cAAc,KAAK,eAAe;AAAA,EAElC,UAAU,QAAQ,WAAW,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EAClD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AA8BM,IAAM,qBAAqB,QAAQ,uBAAuB;AAAA,EAC/D,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,aAAa,KAAK,cAAc,EAAE,WAAW,MAAM,WAAW,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EACnG,eAAe,QAAQ,gBAAgB,EAAE,QAAQ;AAAA,EACjD,UAAU,MAAM,UAAU,EAAE,MAAwB,EAAE,QAAQ;AAAA,EAC9D,mBAAmB,KAAK,oBAAoB;AAAA,EAC5C,WAAW,KAAK,YAAY;AAAA;AAAA,EAC5B,eAAe,QAAQ,mBAAmB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACzD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAEM,IAAM,8BAA8B,UAAU,oBAAoB,CAAC,EAAE,IAAI,OAAO;AAAA,EACrF,WAAW,IAAI,YAAY;AAAA,IACzB,QAAQ,CAAC,mBAAmB,WAAW;AAAA,IACvC,YAAY,CAAC,WAAW,EAAE;AAAA,EAC5B,CAAC;AACH,EAAE;;;ACpPK,IAAM,iBAAiB,OAAO,eAAe,CAAC,SAAS,aAAa,UAAU,CAAC;AAG/E,IAAM,QAAQ,QAAQ,SAAS;AAAA,EACpC,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACjD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACxD,SAAS,KAAK,SAAS,EAAE,QAAQ;AAAA,EACjC,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3C,kBAAkB,QAAQ,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAE/D,UAAU,KAAK,WAAW;AAAA,EAC1B,YAAY,QAAQ,eAAe,EAAE,QAAQ,IAAI,CAAC;AAAA,EAElD,QAAQ,eAAe,QAAQ,EAAE,QAAQ,OAAO,EAAE,QAAQ;AAAA,EAC1D,aAAa,UAAU,cAAc;AAAA;AAAA,EAGrC,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,EAChD,iBAAiB,QAAQ,oBAAoB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC5D,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,MAAM;AAAA,EAE7C,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;;;ACxBM,IAAM,WAAW,QAAQ,YAAY;AAAA,EAC1C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,KAAK,QAAQ,OAAO,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EACtD,OAAO,MAAM,OAAO,EAAE,QAAQ;AAAA,EAC9B,aAAa,KAAK,aAAa;AAAA,EAC/B,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,oBAAoB,QAAQ,uBAAuB;AAAA,EAC9D,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,aAAa,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/D,QAAQ,QAAQ,UAAU,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACnD,YAAY,QAAQ,eAAe,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC5D,UAAU,KAAK,WAAW;AAAA,EAC1B,SAAS,MAAM,SAAS;AAAA,EACxB,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA,EAC/C,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;;;ACfM,IAAM,QAAQ,QAAQ,SAAS;AAAA,EACpC,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA,EACtF,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,EAChD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,YAAY,QAAQ,cAAc;AAAA,EAC7C,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,QAAQ,KAAK,SAAS,EAAE,WAAW,MAAM,MAAM,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EACpF,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,SAAS,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EAC7F,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,gBAAgB,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA,EAC1F,UAAU,QAAQ,UAAU,EAAE,QAAQ,EAAE,QAAQ,CAAC;AAAA,EACjD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,iBAAiB,QAAQ,oBAAoB;AAAA,EACxD,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,QAAQ,KAAK,SAAS,EAAE,WAAW,MAAM,MAAM,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA,EAC7F,aAAa,KAAK,eAAe,EAAE,QAAQ;AAAA,EAC3C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA,EAC9C,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAGM,IAAM,iBAAiB,UAAU,OAAO,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EACjE,UAAU,IAAI,WAAW;AAAA,IACvB,QAAQ,CAAC,MAAM,UAAU;AAAA,IACzB,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AAAA,EACD,OAAO,KAAK,SAAS;AAAA,EACrB,WAAW,IAAI,cAAc;AAC/B,EAAE;AAEK,IAAM,qBAAqB,UAAU,WAAW,CAAC,EAAE,IAAI,OAAO;AAAA,EACnE,MAAM,IAAI,OAAO;AAAA,IACf,QAAQ,CAAC,UAAU,MAAM;AAAA,IACzB,YAAY,CAAC,MAAM,EAAE;AAAA,EACvB,CAAC;AAAA,EACD,SAAS,IAAI,UAAU;AAAA,IACrB,QAAQ,CAAC,UAAU,SAAS;AAAA,IAC5B,YAAY,CAAC,SAAS,EAAE;AAAA,EAC1B,CAAC;AAAA,EACD,SAAS,IAAI,iBAAiB;AAAA,IAC5B,QAAQ,CAAC,UAAU,SAAS;AAAA,IAC5B,YAAY,CAAC,gBAAgB,EAAE;AAAA,EACjC,CAAC;AACH,EAAE;AAEK,IAAM,0BAA0B,UAAU,gBAAgB,CAAC,EAAE,IAAI,OAAO;AAAA,EAC7E,MAAM,IAAI,OAAO;AAAA,IACf,QAAQ,CAAC,eAAe,MAAM;AAAA,IAC9B,YAAY,CAAC,MAAM,EAAE;AAAA,EACvB,CAAC;AACH,EAAE;;;AC3DK,IAAM,mBAAmB,OAAO,iBAAiB,CAAC,UAAU,cAAc,MAAM,CAAC;AACjF,IAAM,mBAAmB,OAAO,iBAAiB,CAAC,WAAW,cAAc,aAAa,QAAQ,CAAC;AAGjG,IAAM,oBAAoB,QAAQ,uBAAuB;AAAA,EAC9D,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,QAAQ,iBAAiB,QAAQ,EAAE,QAAQ;AAAA,EAC3C,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC1D,QAAQ,iBAAiB,QAAQ,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA,EAC9D,mBAAmB,KAAK,qBAAqB,EAAE,WAAW,MAAM,SAAS,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EACrG,cAAc,KAAK,eAAe;AAAA,EAClC,SAAS,MAAM,UAAU;AAAA,EACzB,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,aAAa,UAAU,cAAc;AACvC,CAAC;AAGM,IAAM,6BAA6B,UAAU,mBAAmB,CAAC,EAAE,IAAI,OAAO;AAAA,EACnF,iBAAiB,IAAI,UAAU;AAAA,IAC7B,QAAQ,CAAC,kBAAkB,iBAAiB;AAAA,IAC5C,YAAY,CAAC,SAAS,EAAE;AAAA,EAC1B,CAAC;AACH,EAAE;;;ACzBK,IAAM,2BAA2B,OAAO,0BAA0B;AAAA,EACvE;AAAA,EACA;AAAA,EACA;AACF,CAAC;AAEM,IAAM,oBAAoB,QAAQ,sBAAsB;AAAA,EAC7D,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA;AAAA,EAG1C,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACjD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ;AAAA,EAC7C,MAAM,yBAAyB,MAAM,EAAE,QAAQ;AAAA;AAAA,EAG/C,UAAU,QAAQ,UAAU,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACjD,aAAa,QAAQ,cAAc,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGxD,WAAW,UAAU,YAAY,EAAE,QAAQ;AAAA;AAAA,EAG3C,QAAQ,QAAQ,SAAS,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EAClD,QAAQ,UAAU,SAAS;AAAA;AAAA,EAG3B,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,EAG/C,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,GAAG,CAAC,WAAW;AAAA,EACb,UAAU,MAAM,8BAA8B,EAAE,GAAG,MAAM,KAAK;AAAA,EAC9D,cAAc,MAAM,mCAAmC,EAAE,GAAG,MAAM,SAAS;AAC7E,EAAE;;;AChCK,IAAM,WAAW;AAAA,EACtB;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,YAAY,KAAK,aAAa,EAC3B,QAAQ,EACR,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA;AAAA,IAGzD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC,EAAE,OAAO,EAAE,QAAQ;AAAA;AAAA,IAGnE,YAAY,QAAQ,eAAe,EAAE,QAAQ,IAAI,CAAC;AAAA,IAClD,YAAY,QAAQ,eAAe,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,IACjD,eAAe,QAAQ,kBAAkB,EAAE,QAAQ,GAAG,CAAC;AAAA,IACvD,gBAAgB,QAAQ,mBAAmB,EAAE,QAAQ,GAAG,CAAC;AAAA,IACzD,QAAQ,QAAQ,WAAW,EAAE,QAAQ,GAAG,CAAC;AAAA,IACzC,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,IAG/C,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA,IACzD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,IAChD,QAAQ,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1C,YAAY,QAAQ,eAAe,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA,IAC9D,aAAa,QAAQ,gBAAgB,EAAE,WAAW,IAAI,OAAO,EAAE,CAAC;AAAA;AAAA,IAGhE,WAAW,KAAK,YAAY,EAAE,QAAQ;AAAA;AAAA,IAGtC,SAAS,UAAU,UAAU,EAAE,QAAQ,EAAE,WAAW;AAAA,IACpD,gBAAgB,UAAU,kBAAkB,EAAE,QAAQ,EAAE,WAAW;AAAA;AAAA,IAGnE,UAAU,QAAQ,WAAW,EAAE,QAAQ,IAAI,EAAE,QAAQ;AAAA,IACrD,WAAW,UAAU,YAAY;AAAA,IACjC,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA;AAAA,IAGtD,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,IACxD,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,EAC1D;AAAA,EACA,CAAC,WAAW;AAAA,IACV,aAAa,MAAM,uBAAuB,EAAE,GAAG,MAAM,UAAU;AAAA,IAC/D,WAAW,MAAM,qBAAqB,EAAE,GAAG,MAAM,QAAQ;AAAA,IACzD,aAAa,MAAM,uBAAuB,EAAE,GAAG,MAAM,cAAc;AAAA,IACnE,cAAc,MAAM,yBAAyB,EAAE,GAAG,MAAM,SAAS;AAAA,EACnE;AACF;;;AChDO,IAAM,kBAAkB;AAAA,EAC7B;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,YAAY,KAAK,aAAa,EAC3B,QAAQ,EACR,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA;AAAA,IAGzD,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA;AAAA,IAGhE,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,IACxD,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA,IAC/C,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,IAGhD,cAAc,QAAQ,iBAAiB,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,EACvD;AAAA,EACA,CAAC,WAAW;AAAA,IACV,aAAa,MAAM,+BAA+B,EAAE,GAAG,MAAM,UAAU;AAAA,IACvE,cAAc,MAAM,iCAAiC,EAAE,GAAG,MAAM,SAAS;AAAA,EAC3E;AACF;;;ACvBO,IAAM,gBAAgB;AAAA,EAC3B;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA;AAAA,IAGtF,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,IACjD,SAAS,QAAQ,SAAS,EAAE,QAAQ;AAAA,IACpC,eAAe,QAAQ,kBAAkB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA;AAAA,IAGxD,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA,IACzD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,IAChD,YAAY,QAAQ,eAAe,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,IACjD,eAAe,QAAQ,kBAAkB,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,IAGvD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC;AAAA,IAChD,QAAQ,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,IAG1C,kBAAkB,QAAQ,mBAAmB,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,IACtE,qBAAqB,QAAQ,sBAAsB,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA,IAGxE,aAAa,UAAU,cAAc,EAAE,QAAQ,EAAE,WAAW;AAAA,EAC9D;AAAA,EACA,CAAC,WAAW;AAAA,IACV,aAAa,MAAM,6BAA6B,EAAE,GAAG,MAAM,UAAU;AAAA,IACrE,UAAU,MAAM,0BAA0B,EAAE,GAAG,MAAM,KAAK;AAAA,IAC1D,gBAAgB,MAAM,iCAAiC,EAAE,GAAG,MAAM,WAAW;AAAA,IAC7E,YAAY,MAAM,4BAA4B,EAAE,GAAG,MAAM,OAAO;AAAA,EAClE;AACF;;;AClCO,IAAM,eAAe;AAAA,EAC1B;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,UAAU,CAAC;AAAA;AAAA,IAGtF,oBAAoB,QAAQ,wBAAwB,EAAE,QAAQ,EAAE,CAAC,EAAE,QAAQ;AAAA;AAAA,IAG3E,YAAY,QAAQ,aAAa,EAAE,QAAQ;AAAA,IAC3C,aAAa,QAAQ,cAAc,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA;AAAA,IAGxD,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,IACxD,WAAW,UAAU,YAAY,EAAE,QAAQ;AAAA;AAAA;AAAA,IAG3C,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,GAAG,CAAC;AAAA;AAAA,IACnD,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA,EACjD;AAAA,EACA,CAAC,WAAW;AAAA,IACV,aAAa,MAAM,4BAA4B,EAAE,GAAG,MAAM,UAAU;AAAA,IACpE,WAAW,MAAM,0BAA0B,EAAE,GAAG,MAAM,kBAAkB;AAAA,IACxE,cAAc,MAAM,8BAA8B,EAAE,GAAG,MAAM,SAAS;AAAA,EACxE;AACF;;;AClBO,IAAM,oBAAoB;AAAA,EAC/B;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,WAAW,UAAU,WAAW,EAAE,QAAQ,EAAE,WAAW;AAAA,IACvD,WAAW,QAAQ,cAAc,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA;AAAA,IAG1D,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA;AAAA,IACzD,SAAS,KAAK,UAAU;AAAA,IACxB,YAAY,QAAQ,eAAe,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,IAGlD,YAAY,QAAQ,eAAe,EAAE,QAAQ,GAAG,CAAC;AAAA,IACjD,UAAU,KAAK,WAAW;AAAA;AAAA,IAG1B,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA,IAClD,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA;AAAA;AAAA,IAGlD,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC;AAAA,IAC/C,WAAW,KAAK,YAAY;AAAA,IAC5B,WAAW,KAAK,YAAY;AAAA,IAC5B,WAAW,KAAK,YAAY;AAAA;AAAA,IAG5B,UAAU,MAAM,UAAU;AAAA;AAAA,IAG1B,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,EAC1D;AAAA,EACA,CAAC,WAAW;AAAA;AAAA,IAEV,cAAc,MAAM,0BAA0B,EAAE,GAAG,MAAM,SAAS;AAAA,IAClE,cAAc,MAAM,2BAA2B,EAAE,GAAG,MAAM,SAAS;AAAA,IACnE,UAAU,MAAM,sBAAsB,EAAE,GAAG,MAAM,OAAO;AAAA,IACxD,cAAc,MAAM,2BAA2B,EAAE,GAAG,MAAM,SAAS;AAAA,IACnE,YAAY,MAAM,wBAAwB,EAAE,GAAG,MAAM,SAAS;AAAA,EAChE;AACF;;;AC3CO,IAAM,eAAe;AAAA,EAC1B;AAAA,EACA;AAAA,IACE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,IAC1C,WAAW,QAAQ,cAAc,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,EAAE,OAAO;AAAA;AAAA,IAGlE,iBAAiB,QAAQ,kBAAkB,EAAE,QAAQ,EAAE,QAAQ,GAAG;AAAA;AAAA;AAAA,IAGlE,qBAAqB,QAAQ,uBAAuB,EAAE,QAAQ,EAAE,QAAQ,CAAC;AAAA,IACzE,kBAAkB,QAAQ,mBAAmB,EAAE,QAAQ,EAAE,QAAQ,CAAC;AAAA,IAClE,qBAAqB,QAAQ,uBAAuB,EAAE,QAAQ,EAAE,QAAQ,CAAC;AAAA,IACzE,cAAc,QAAQ,eAAe,EAAE,QAAQ,EAAE,QAAQ,CAAC;AAAA;AAAA,IAG1D,WAAW,QAAQ,YAAY,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,IACxD,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA,IACpD,WAAW,UAAU,YAAY;AAAA,IACjC,cAAc,UAAU,eAAe;AAAA;AAAA;AAAA,IAGvC,YAAY,UAAU,cAAc,EAAE,QAAQ,EAAE,WAAW;AAAA,IAC3D,aAAa,UAAU,eAAe,EAAE,QAAQ,EAAE,WAAW;AAAA,IAC7D,WAAW,KAAK,YAAY;AAAA,IAC5B,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC3C,OAAO,KAAK,OAAO;AAAA;AAAA,IAGnB,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,IACxD,WAAW,UAAU,YAAY,EAAE,QAAQ,EAAE,WAAW;AAAA,EAC1D;AAAA,EACA,CAAC,WAAW;AAAA,IACV,cAAc,MAAM,8BAA8B,EAAE,GAAG,MAAM,SAAS;AAAA,IACtE,cAAc,MAAM,8BAA8B,EAAE,GAAG,MAAM,SAAS;AAAA,IACtE,oBAAoB,MAAM,yBAAyB,EAAE,GAAG,MAAM,eAAe;AAAA,EAC/E;AACF;;;ACrCO,IAAM,wBAAwB,QAAQ,0BAA0B;AAAA,EACrE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAC1C,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACjD,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EAGrC,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA;AAAA,EAGvF,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,QAAQ,EAAE,QAAQ;AAAA;AAAA;AAAA,EAGpE,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,QAAQ,EAAE,QAAQ;AAAA;AAAA;AAAA,EAGpE,kBAAkB,QAAQ,qBAAqB,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGvE,cAAc,UAAU,eAAe,EAAE,WAAW,EAAE,QAAQ;AAAA,EAC9D,gBAAgB,UAAU,iBAAiB;AAAA,EAE3C,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,GAAG,CAAC,UAAU;AAAA,EACZ,YAAY,kCAAkC,EAAE,GAAG,MAAM,KAAK;AAChE,CAAC;AAMM,IAAM,sBAAsB,QAAQ,wBAAwB;AAAA,EACjE,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA;AAAA,EAG1C,MAAM,QAAQ,QAAQ,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC/C,SAAS,QAAQ,WAAW,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA,EACrD,aAAa,QAAQ,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA;AAAA,EACpD,SAAS,KAAK,SAAS,EAAE,QAAQ;AAAA;AAAA;AAAA,EAGjC,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,OAAO,EAAE,QAAQ;AAAA;AAAA,EAGnE,YAAY,QAAQ,aAAa,EAAE,QAAQ,GAAG,EAAE,QAAQ;AAAA;AAAA,EACxD,UAAU,QAAQ,aAAa,EAAE,QAAQ,EAAE,CAAC;AAAA;AAAA;AAAA,EAG5C,iBAAiB,QAAQ,kBAAkB,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EAChE,WAAW,QAAQ,YAAY,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACpD,aAAa,QAAQ,cAAc,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACxD,WAAW,QAAQ,YAAY,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA,EACpD,YAAY,QAAQ,aAAa,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGtD,aAAa,UAAU,cAAc;AAAA;AAAA,EACrC,WAAW,UAAU,YAAY;AAAA;AAAA,EACjC,aAAa,UAAU,cAAc;AAAA;AAAA,EACrC,YAAY,UAAU,cAAc;AAAA;AAAA;AAAA,EAGpC,WAAW,KAAK,YAAY,EAAE,WAAW,MAAM,UAAU,IAAI,EAAE,UAAU,WAAW,CAAC;AAAA,EAErF,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAAA,EACxD,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAMM,IAAM,kBAAkB,QAAQ,oBAAoB;AAAA,EACzD,IAAI,KAAK,IAAI,EAAE,WAAW,EAAE,cAAc;AAAA,EAE1C,YAAY,KAAK,aAAa,EAAE,WAAW,MAAM,oBAAoB,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA,EAC1G,cAAc,KAAK,eAAe,EAAE,WAAW,MAAM,sBAAsB,IAAI,EAAE,UAAU,UAAU,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGhH,OAAO,QAAQ,SAAS,EAAE,QAAQ,IAAI,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGjD,QAAQ,QAAQ,UAAU,EAAE,QAAQ,GAAG,CAAC,EAAE,QAAQ,SAAS,EAAE,QAAQ;AAAA;AAAA,EAGrE,cAAc,KAAK,eAAe;AAAA,EAClC,YAAY,QAAQ,aAAa,EAAE,QAAQ,CAAC,EAAE,QAAQ;AAAA;AAAA,EAGtD,UAAU,UAAU,WAAW;AAAA,EAC/B,WAAW,UAAU,YAAY;AAAA;AAAA,EAGjC,cAAc,UAAU,eAAe;AAAA;AAAA,EACvC,QAAQ,UAAU,SAAS;AAAA,EAE3B,WAAW,UAAU,YAAY,EAAE,WAAW,EAAE,QAAQ;AAC1D,CAAC;AAMM,IAAM,iCAAiC,UAAU,uBAAuB,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EACjG,UAAU,IAAI,WAAW;AAAA,IACvB,QAAQ,CAAC,sBAAsB,UAAU;AAAA,IACzC,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AAAA,EACD,OAAO,KAAK,eAAe;AAC7B,EAAE;AAEK,IAAM,+BAA+B,UAAU,qBAAqB,CAAC,EAAE,KAAK,KAAK,OAAO;AAAA,EAC7F,mBAAmB,IAAI,WAAW;AAAA,IAChC,QAAQ,CAAC,oBAAoB,SAAS;AAAA,IACtC,YAAY,CAAC,UAAU,EAAE;AAAA,EAC3B,CAAC;AAAA,EACD,OAAO,KAAK,eAAe;AAC7B,EAAE;AAEK,IAAM,2BAA2B,UAAU,iBAAiB,CAAC,EAAE,IAAI,OAAO;AAAA,EAC/E,UAAU,IAAI,qBAAqB;AAAA,IACjC,QAAQ,CAAC,gBAAgB,UAAU;AAAA,IACnC,YAAY,CAAC,oBAAoB,EAAE;AAAA,EACrC,CAAC;AAAA,EACD,YAAY,IAAI,uBAAuB;AAAA,IACrC,QAAQ,CAAC,gBAAgB,YAAY;AAAA,IACrC,YAAY,CAAC,sBAAsB,EAAE;AAAA,EACvC,CAAC;AACH,EAAE;;;ArG9HK,SAAS,SAAS,kBAA0B;AACjD,QAAMC,WAAM,yBAAK,gBAAgB;AACjC,SAAO,QAAQA,MAAK,EAAE,uBAAO,CAAC;AAChC;AAUA,IAAI,aAA8B;AAE3B,SAAS,QAAkB;AAChC,MAAI,CAAC,YAAY;AACf,UAAM,mBAAmB,QAAQ,IAAI,cAAc;AACnD,QAAI,CAAC,kBAAkB;AACrB,YAAM,IAAI,MAAM,8CAA8C;AAAA,IAChE;AACA,iBAAa,SAAS,gBAAgB;AAAA,EACxC;AACA,SAAO;AACT;AAKO,IAAM,KAAK,MAAM;;;AsGrCxB,sBAAmB;AACnB,0BAAyB;AA0BzB,IAAM,iBAAN,MAAqB;AAAA;AAAA;AAAA;AAAA,EAIX,eAAe,WAAmB;AACxC,UAAM,SAAS,IAAI,6BAAS,SAAS;AACrC,UAAM,SAAS,OAAO,UAAU;AAEhC,UAAM,UAAU,OAAO,QAAQ,QAAQ;AACvC,UAAM,iBAAiB,OAAO,QAAQ,WAAW;AACjD,UAAM,KAAK,OAAO,GAAG,QAAQ;AAC7B,UAAM,YAAY,OAAO,GAAG,WAAW;AACvC,UAAM,aAAa,OAAO,OAAO,QAAQ;AAEzC,UAAM,aAAa,GAAG,OAAO,OAAO,EAAE,GAAG,YAAY,IAAI,SAAS,KAAK,EAAE;AAEzE,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,eAAe;AAAA,MACf;AAAA,MACA,QAAQ;AAAA,MACR;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,cAAc,SAAgD;AAClE,UAAM,EAAE,YAAY,WAAW,UAAU,IAAI;AAG7C,UAAM,aAAa,KAAK,eAAe,SAAS;AAGhD,UAAM,CAAC,OAAO,IAAI,MAAM,GACrB,OAAO,QAAQ,EACf,OAAO;AAAA,MACN;AAAA,MACA;AAAA,MACA;AAAA,MACA,GAAG;AAAA,MACH,WAAW;AAAA;AAAA,MACX,SAAS,oBAAI,KAAK;AAAA,MAClB,gBAAgB,oBAAI,KAAK;AAAA,IAC3B,CAAC,EACA,UAAU;AAEb,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,MAAM,0BAA0B;AAAA,IAC5C;AAEA,WAAO,KAAK,mBAAmB;AAAA,MAC7B,WAAW,QAAQ;AAAA,MACnB;AAAA,MACA,YAAY,WAAW;AAAA,MACvB;AAAA,IACF,CAAC;AAED,WAAO,QAAQ;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,aAAa,WAAmB,OAA8B;AAClE,UAAM,YAAY,MAAM,gBAAAC,QAAO,KAAK,OAAO,EAAE;AAE7C,UAAM,GACH,OAAO,QAAQ,EACf,IAAI,EAAE,WAAW,WAAW,oBAAI,KAAK,EAAE,CAAC,EACxC,MAAM,GAAG,SAAS,IAAI,SAAS,CAAC;AAEnC,WAAO,MAAM,8BAA8B,EAAE,UAAU,CAAC;AAAA,EAC1D;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBAAgB,WAAgD;AACpE,UAAM,CAAC,OAAO,IAAI,MAAM,GACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,IAAI,GAAG,SAAS,IAAI,SAAS,GAAG,GAAG,SAAS,UAAU,IAAI,CAAC,CAAC,EAClE,MAAM,CAAC;AAEV,QAAI,CAAC,SAAS;AACZ,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,MACL,IAAI,QAAQ;AAAA,MACZ,YAAY,QAAQ;AAAA,MACpB,YAAY,QAAQ,cAAc;AAAA,MAClC,YAAY,QAAQ,cAAc;AAAA,MAClC,eAAe,QAAQ,iBAAiB;AAAA,MACxC,gBAAgB,QAAQ,kBAAkB;AAAA,MAC1C,QAAQ,QAAQ,UAAU;AAAA,MAC1B,WAAW,QAAQ,aAAa;AAAA,MAChC,WAAW,QAAQ;AAAA,MACnB,QAAQ,QAAQ;AAAA,MAChB,WAAW,QAAQ;AAAA,MACnB,SAAS,QAAQ;AAAA,MACjB,gBAAgB,QAAQ;AAAA,MACxB,UAAU,QAAQ;AAAA,IACpB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,eAAe,WAAkC;AACrD,UAAM,GACH,OAAO,QAAQ,EACf,IAAI,EAAE,gBAAgB,oBAAI,KAAK,GAAG,WAAW,oBAAI,KAAK,EAAE,CAAC,EACzD,MAAM,GAAG,SAAS,IAAI,SAAS,CAAC;AAAA,EACrC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAkB,YAA4C;AAClE,UAAM,cAAc,MAAM,GACvB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,IAAI,GAAG,SAAS,YAAY,UAAU,GAAG,GAAG,SAAS,UAAU,IAAI,CAAC,CAAC,EAC3E,QAAQ,KAAK,SAAS,cAAc,CAAC;AAExC,WAAO,YAAY,IAAI,CAAC,aAAa;AAAA,MACnC,IAAI,QAAQ;AAAA,MACZ,YAAY,QAAQ;AAAA,MACpB,YAAY,QAAQ,cAAc;AAAA,MAClC,YAAY,QAAQ,cAAc;AAAA,MAClC,eAAe,QAAQ,iBAAiB;AAAA,MACxC,gBAAgB,QAAQ,kBAAkB;AAAA,MAC1C,QAAQ,QAAQ,UAAU;AAAA,MAC1B,WAAW,QAAQ,aAAa;AAAA,MAChC,WAAW,QAAQ;AAAA,MACnB,QAAQ,QAAQ;AAAA,MAChB,WAAW,QAAQ;AAAA,MACnB,SAAS,QAAQ;AAAA,MACjB,gBAAgB,QAAQ;AAAA,MACxB,UAAU,QAAQ;AAAA,IACpB,EAAE;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cACJ,WACA,QACe;AACf,UAAM,GACH,OAAO,QAAQ,EACf,IAAI;AAAA,MACH,UAAU;AAAA,MACV,WAAW,oBAAI,KAAK;AAAA,MACpB,cAAc;AAAA,MACd,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,SAAS,IAAI,SAAS,CAAC;AAEnC,WAAO,KAAK,mBAAmB,EAAE,WAAW,OAAO,CAAC;AAAA,EACtD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,oBAAoB,YAAoB,kBAA2C;AACvF,UAAM,SAAS,MAAM,GAClB,OAAO,QAAQ,EACf,IAAI;AAAA,MACH,UAAU;AAAA,MACV,WAAW,oBAAI,KAAK;AAAA,MACpB,cAAc;AAAA,MACd,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA;AAAA,MACC;AAAA,QACE,GAAG,SAAS,YAAY,UAAU;AAAA,QAClC,GAAG,SAAS,UAAU,IAAI;AAAA,QAC1B,GAAG,SAAS,IAAI,gBAAgB;AAAA,MAClC;AAAA,IACF;AAEF,UAAMC,SAAQ,OAAO,YAAY;AACjC,WAAO,KAAK,0BAA0B,EAAE,YAAY,OAAAA,OAAM,CAAC;AAC3D,WAAOA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAkB,YAAqC;AAC3D,UAAM,SAAS,MAAM,GAClB,OAAO,QAAQ,EACf,IAAI;AAAA,MACH,UAAU;AAAA,MACV,WAAW,oBAAI,KAAK;AAAA,MACpB,cAAc;AAAA,MACd,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,IAAI,GAAG,SAAS,YAAY,UAAU,GAAG,GAAG,SAAS,UAAU,IAAI,CAAC,CAAC;AAE9E,UAAMA,SAAQ,OAAO,YAAY;AACjC,WAAO,KAAK,wBAAwB,EAAE,YAAY,OAAAA,OAAM,CAAC;AACzD,WAAOA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAmC;AACvC,UAAM,gBAAgB,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,KAAK,KAAK,GAAI;AACpE,UAAM,eAAe,IAAI,KAAK,KAAK,IAAI,IAAI,IAAI,KAAK,KAAK,KAAK,GAAI;AAClE,UAAM,gBAAgB,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,KAAK,KAAK,GAAI;AAEpE,UAAM,SAAS,MAAM,GAClB,OAAO,QAAQ,EACf;AAAA,MACC;AAAA;AAAA,QAEE,IAAI,GAAG,SAAS,UAAU,KAAK,GAAG,GAAG,SAAS,WAAW,aAAa,CAAC;AAAA;AAAA,QAEvE,IAAI,GAAG,SAAS,UAAU,KAAK,GAAG,GAAG,SAAS,gBAAgB,YAAY,CAAC;AAAA;AAAA,QAE3E,GAAG,SAAS,WAAW,aAAa;AAAA,MACtC;AAAA,IACF;AAEF,UAAMA,SAAQ,OAAO,YAAY;AACjC,WAAO,KAAK,uBAAuB,EAAE,OAAAA,OAAM,CAAC;AAC5C,WAAOA;AAAA,EACT;AACF;AAEO,IAAM,iBAAiB,IAAI,eAAe;;;AvG5OjD,SAAS,aAAa,KAA6B;AAEjD,QAAM,cAAc,IAAI,UAAU,YAAY;AAC9C,MAAI,aAAa;AACf,WAAO;AAAA,EACT;AAGA,QAAM,aAAa,IAAI,QAAQ;AAE/B,MAAI,CAAC,YAAY;AACf,WAAO;AAAA,EACT;AAEA,QAAM,QAAQ,WAAW,MAAM,GAAG;AAElC,MAAI,MAAM,WAAW,KAAK,MAAM,CAAC,MAAM,UAAU;AAC/C,WAAO;AAAA,EACT;AAEA,SAAO,MAAM,CAAC,KAAK;AACrB;AAKA,SAAS,YAAY,OAA2B;AAC9C,MAAI;AACF,WAAO,oBAAAC,QAAI,OAAO,OAAO,OAAO,SAAS;AAAA,EAC3C,QAAQ;AACN,UAAM,IAAI,kBAAkB,0BAA0B;AAAA,EACxD;AACF;AAMO,SAAS,aAAa,KAAc,MAAgB,MAA0B;AACnF,MAAI;AACF,UAAM,QAAQ,aAAa,GAAG;AAE9B,QAAI,OAAO;AACT,YAAM,UAAU,YAAY,KAAK;AAEjC,UAAI,OAAO;AAAA,QACT,IAAI,QAAQ;AAAA,QACZ,OAAO,QAAQ;AAAA,QACf,MAAM,QAAQ;AAAA,QACd,YAAY,QAAQ;AAAA,QACpB,WAAW,QAAQ;AAAA,MACrB;AAAA,IACF;AAGA,UAAM,YAAY,IAAI,QAAQ,cAAc;AAC5C,QAAI,iBAAa,aAAAC,UAAa,SAAS,GAAG;AACxC,UAAI,YAAY;AAAA,IAClB;AAEA,SAAK;AAAA,EACP,QAAQ;AAEN,SAAK;AAAA,EACP;AACF;AAMA,eAAsB,YAAY,KAAc,MAAgB,MAAmC;AACjG,MAAI;AACF,UAAM,QAAQ,aAAa,GAAG;AAE9B,QAAI,CAAC,OAAO;AACV,YAAM,IAAI,kBAAkB,yBAAyB;AAAA,IACvD;AAEA,UAAM,UAAU,YAAY,KAAK;AAGjC,QAAI,QAAQ,WAAW;AACrB,YAAM,UAAU,MAAM,eAAe,gBAAgB,QAAQ,SAAS;AAEtE,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,kBAAkB,8BAA8B;AAAA,MAC5D;AAEA,UAAI,CAAC,QAAQ,UAAU;AACrB,cAAM,IAAI,kBAAkB,0BAA0B;AAAA,MACxD;AAGA,qBAAe,eAAe,QAAQ,EAAE,EAAE;AAAA,QAAM,CAAC,QAC/C,OAAO,MAAM,qCAAqC,EAAE,WAAW,QAAQ,IAAI,OAAO,IAAI,CAAC;AAAA,MACzF;AAAA,IACF;AAEA,QAAI,OAAO;AAAA,MACT,IAAI,QAAQ;AAAA,MACZ,OAAO,QAAQ;AAAA,MACf,MAAM,QAAQ;AAAA,MACd,YAAY,QAAQ;AAAA,MACpB,WAAW,QAAQ;AAAA,IACrB;AAEA,SAAK;AAAA,EACP,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF;AAMO,SAAS,aAAa,KAAc,MAAgB,MAA0B;AACnF,MAAI;AACF,QAAI,CAAC,IAAI,MAAM;AACb,YAAM,IAAI,kBAAkB,yBAAyB;AAAA,IACvD;AAEA,QAAI,IAAI,KAAK,SAAS,SAAS;AAC7B,YAAM,IAAI,eAAe,uBAAuB;AAAA,IAClD;AAEA,SAAK;AAAA,EACP,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF;AAKO,SAAS,cAAc,SAA6B;AACzD,SAAO,oBAAAD,QAAI,KAAK,SAAS,OAAO,WAAW;AAAA,IACzC,WAAW,OAAO;AAAA,IAClB,WAAW;AAAA,EACb,CAAC;AACH;AAKO,SAAS,qBAA2B;AACzC,QAAM,YAAY,OAAO;AACzB,QAAM,KAAK,cAAc,SAAS;AAClC,SAAO,IAAI,KAAK,KAAK,IAAI,IAAI,EAAE;AACjC;AAKA,SAAS,cAAc,UAA0B;AAC/C,QAAM,QAAQ,SAAS,MAAM,iBAAiB;AAE9C,MAAI,CAAC,OAAO;AACV,WAAO,IAAI,KAAK,KAAK,KAAK;AAAA,EAC5B;AAEA,QAAM,QAAQ,SAAS,MAAM,CAAC,KAAK,KAAK,EAAE;AAC1C,QAAM,OAAO,MAAM,CAAC;AAEpB,UAAQ,MAAM;AAAA,IACZ,KAAK;AACH,aAAO,QAAQ;AAAA,IACjB,KAAK;AACH,aAAO,QAAQ,KAAK;AAAA,IACtB,KAAK;AACH,aAAO,QAAQ,KAAK,KAAK;AAAA,IAC3B,KAAK;AACH,aAAO,QAAQ,KAAK,KAAK,KAAK;AAAA,IAChC;AACE,aAAO,IAAI,KAAK,KAAK,KAAK;AAAA,EAC9B;AACF;;;AwG/MA,IAAAE,cAA8C;AAQvC,SAAS,SAAY,QAAyC,SAAsC,QAAQ;AACjH,SAAO,CAAC,KAAc,MAAgB,SAA6B;AACjE,QAAI;AACF,YAAM,OAAO,IAAI,MAAM;AACvB,YAAM,YAAY,OAAO,MAAM,IAAI;AAGnC,MAAC,IAA2C,MAAM,IAAI;AAEtD,WAAK;AAAA,IACP,SAAS,OAAO;AACd,UAAI,iBAAiB,sBAAU;AAC7B,cAAM,UAAU,MAAM,OAAO,IAAI,CAAC,OAAO;AAAA,UACvC,OAAO,EAAE,KAAK,KAAK,GAAG;AAAA,UACtB,SAAS,EAAE;AAAA,UACX,MAAM,EAAE;AAAA,QACV,EAAE;AAGF,eAAO,MAAM,qBAAqB;AAAA,UAChC,MAAM,IAAI;AAAA,UACV,QAAQ,IAAI;AAAA,UACZ,QAAQ;AAAA,UACR,cAAc,WAAW,SAAS,KAAK,UAAU,IAAI,IAAI,EAAE,UAAU,GAAG,GAAI,IAAI;AAAA,QAClF,CAAC;AAED,aAAK,IAAI,gBAAgB,qBAAqB,OAAO,CAAC;AAAA,MACxD,OAAO;AACL,aAAK,KAAK;AAAA,MACZ;AAAA,IACF;AAAA,EACF;AACF;AAKO,SAAS,aAAgB,QAAyC;AACvE,SAAO,SAAS,QAAQ,MAAM;AAChC;AAKO,SAAS,cAAiB,QAAyC;AACxE,SAAO,SAAS,QAAQ,OAAO;AACjC;;;ACvDA,gCAAsB;AAMf,IAAM,qBAAiB,0BAAAC,SAAU;AAAA,EACtC,UAAU,KAAK;AAAA;AAAA,EACf,KAAK;AAAA,EACL,iBAAiB;AAAA,EACjB,eAAe;AAAA,EACf,SAAS,CAAC,MAAM,QAAQ;AACtB,cAAU,KAAK,KAAK,qBAAqB,2CAA2C;AAAA,EACtF;AACF,CAAC;AAQM,IAAM,kBAAc,0BAAAA,SAAU;AAAA,EACnC,UAAU,KAAK,KAAK;AAAA;AAAA,EACpB,KAAK,QAAQ,IAAI,UAAU,MAAM,gBAAgB,KAAK;AAAA,EACtD,iBAAiB;AAAA,EACjB,eAAe;AAAA,EACf,SAAS,CAAC,MAAM,QAAQ;AACtB,cAAU,KAAK,KAAK,qBAAqB,0DAA0D;AAAA,EACrG;AACF,CAAC;AAMM,IAAM,iBAAa,0BAAAA,SAAU;AAAA,EAClC,UAAU,KAAK;AAAA;AAAA,EACf,KAAK;AAAA,EACL,iBAAiB;AAAA,EACjB,eAAe;AAAA,EACf,SAAS,CAAC,MAAM,QAAQ;AACtB,cAAU,KAAK,KAAK,qBAAqB,2CAA2C;AAAA,EACtF;AACF,CAAC;AAMM,IAAM,oBAAgB,0BAAAA,SAAU;AAAA,EACrC,UAAU,KAAK;AAAA;AAAA,EACf,KAAK;AAAA,EACL,iBAAiB;AAAA,EACjB,eAAe;AAAA,EACf,SAAS,CAAC,MAAM,QAAQ;AACtB,cAAU,KAAK,KAAK,qBAAqB,2CAA2C;AAAA,EACtF;AACF,CAAC;AAMM,IAAM,kBAAc,0BAAAA,SAAU;AAAA,EACnC,UAAU,KAAK,KAAK;AAAA;AAAA,EACpB,KAAK;AAAA,EACL,iBAAiB;AAAA,EACjB,eAAe;AAAA,EACf,SAAS,CAAC,MAAM,QAAQ;AACtB,cAAU,KAAK,KAAK,qBAAqB,gDAAgD;AAAA,EAC3F;AACF,CAAC;AAOM,IAAM,0BAAsB,0BAAAA,SAAU;AAAA,EAC3C,UAAU,KAAK,KAAK;AAAA;AAAA,EACpB,KAAK;AAAA;AAAA;AAAA,EAGL,cAAc,CAAC,QAAQ;AACrB,UAAM,QAAQ,IAAI,MAAM;AACxB,WAAO,QAAQ,MAAM,YAAY,IAAI,IAAI;AAAA,EAC3C;AAAA,EAEA,iBAAiB;AAAA,EACjB,eAAe;AAAA,EAEf,SAAS,CAAC,MAAM,QAAQ;AACtB;AAAA,MAAU;AAAA,MAAK;AAAA,MAAK;AAAA,MAClB;AAAA,IAAkE;AAAA,EACtE;AACF,CAAC;;;AChGD,uBAA2B;AAG3B,IAAM;AAAA,EACJ;AAAA,EACA;AACF,QAAI,6BAAW;AAAA,EACb,WAAW,MAAM,QAAQ,IAAI,aAAa,KAAK,QAAQ,IAAI,YAAY,KAAK;AAAA,EAC5E,YAAY;AAAA,EACZ,eAAe;AAAA,IACb,UAAU;AAAA,IACV,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,IAC9D,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,IACpC,MAAM;AAAA,EACR;AAAA,EACA,yBAAyB,CAAC,QAAiB,IAAI,QAAQ,cAAc;AAAA,EACrE,sBAAsB,CAAC,QAAiB;AAGtC,WAAO,IAAI,aAAa,GAAG,IAAI,QAAQ,YAAY,CAAC,IAAI,IAAI,EAAE;AAAA,EAChE;AACF,CAAC;;;ACrBD,iBAAwD;AAMxD,IAAM,gBAAmC;AAAA,EACvC,WAAW,CAAC;AAAA;AAAA,EACZ,gBAAgB;AAAA,EAChB,oBAAoB,CAAC,UAAU,OAAO;AACxC;AAKA,IAAM,qBAAwC;AAAA,EAC5C,WAAW;AAAA;AAAA,IAET,GAAG,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC;AAAA,IAAG,GAAG,CAAC;AAAA,IAAG,GAAG,CAAC;AAAA,IAAG,GAAG,CAAC;AAAA,IAAG,QAAQ,CAAC;AAAA,IAAG,IAAI,CAAC;AAAA,IAAG,MAAM,CAAC,SAAS,OAAO;AAAA;AAAA,IAE/F,GAAG,CAAC,QAAQ,SAAS,UAAU,SAAS,OAAO;AAAA;AAAA,IAE/C,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA;AAAA,IAErE,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA,IACrE,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,OAAO;AAAA;AAAA,IAErE,YAAY,CAAC,SAAS,OAAO;AAAA,IAAG,MAAM,CAAC,OAAO;AAAA,IAAG,KAAK,CAAC,SAAS,OAAO;AAAA,IACvE,KAAK,CAAC,SAAS,SAAS,IAAI;AAAA;AAAA,IAE5B,KAAK,CAAC,OAAO,OAAO,SAAS,SAAS,UAAU,SAAS,OAAO;AAAA;AAAA,IAEhE,IAAI,CAAC,OAAO;AAAA;AAAA,IAEZ,OAAO,CAAC,SAAS,SAAS,UAAU,eAAe,eAAe,SAAS,OAAO;AAAA,IAClF,OAAO,CAAC,OAAO;AAAA,IAAG,OAAO,CAAC,OAAO;AAAA,IAAG,OAAO,CAAC,OAAO;AAAA,IACnD,IAAI,CAAC,SAAS,OAAO;AAAA,IAAG,IAAI,CAAC,SAAS,SAAS,WAAW,WAAW,SAAS,QAAQ;AAAA,IACtF,IAAI,CAAC,SAAS,SAAS,WAAW,WAAW,SAAS,UAAU,SAAS,QAAQ;AAAA,IACjF,SAAS,CAAC,OAAO;AAAA,EACnB;AAAA,EACA,gBAAgB;AAAA,EAChB,oBAAoB,CAAC,QAAQ;AAAA,EAC7B,iBAAiB,SAAS,KAAK,MAAM,OAAO,aAAa;AACvD,QAAI,KAAK,WAAW,OAAO,GAAG;AAC5B,aAAO,GAAG,IAAI,SAAK,4BAAgB,KAAK,CAAC;AAAA,IAC3C;AAAA,EACF;AACF;AAMA,IAAM,gBAAgB,CAAC,SAAS;AAMhC,IAAM,WAAW,CAAC,KAAU,UAA6B,eAAe,cAA4B;AAClG,MAAI,OAAO,QAAQ,UAAU;AAG3B,QAAI,aAAa,cAAc,SAAS,SAAS,GAAG;AAClD,aAAO;AAAA,IACT;AACA,eAAO,WAAAC,SAAI,KAAK,OAAO;AAAA,EACzB;AACA,MAAI,MAAM,QAAQ,GAAG,GAAG;AACtB,WAAO,IAAI,IAAI,UAAQ,SAAS,MAAM,SAAS,SAAS,CAAC;AAAA,EAC3D;AACA,MAAI,OAAO,OAAO,QAAQ,UAAU;AAClC,UAAM,YAAiB,CAAC;AACxB,eAAW,OAAO,KAAK;AACrB,gBAAU,GAAG,IAAI,SAAS,IAAI,GAAG,GAAG,SAAS,GAAG;AAAA,IAClD;AACA,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAOO,IAAM,cAAc,CAAC,KAAc,KAAe,SAAuB;AAE9E,MAAI,IAAI,MAAM;AACZ,QAAI,OAAO,SAAS,IAAI,IAAI;AAAA,EAC9B;AAGA,MAAI,IAAI,OAAO;AACb,UAAM,iBAAiB,SAAS,IAAI,KAAK;AACzC,eAAW,OAAO,gBAAgB;AAChC,UAAI,MAAM,GAAG,IAAI,eAAe,GAAG;AAAA,IACrC;AAAA,EACF;AAGA,MAAI,IAAI,QAAQ;AACd,UAAM,kBAAkB,SAAS,IAAI,MAAM;AAC3C,eAAW,OAAO,iBAAiB;AACjC,UAAI,OAAO,GAAG,IAAI,gBAAgB,GAAG;AAAA,IACvC;AAAA,EACF;AAEA,OAAK;AACP;AAMO,IAAM,sBAAsB,CAAC,SAAyB;AAC3D,aAAO,WAAAA,SAAI,MAAM,kBAAkB;AACrC;;;ACpHA,IAAAC,eAA6B;AAkBtB,SAAS,oBAAoB,KAAc,KAAe,MAA0B;AAEzF,QAAM,aAAa,IAAI,IAAI,cAAc;AAGzC,QAAM,YAAY,kBAAc,aAAAC,IAAO;AAGvC,EAAC,IAAY,KAAK;AAGlB,MAAI,UAAU,gBAAgB,SAAS;AAEvC,OAAK;AACP;;;ACjCA,IAAAC,mBAAuB;;;ACAvB,qBAAuB;AACvB,IAAAC,cAAkB;AAClB,IAAAC,mBAAmB;;;ACFnB,qBAAoB;AACpB,IAAAC,eAA6B;AAKtB,SAAS,aAAaC,OAAsB;AACjD,aAAO,eAAAC,SAAQD,OAAM;AAAA,IACnB,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,EACR,CAAC;AACH;AAeO,SAAS,oBAAoB,UAA0B;AAC5D,QAAM,QAAO,oBAAI,KAAK,GAAE,YAAY;AACpC,QAAM,iBAAiB,OAAO,QAAQ,EAAE,SAAS,GAAG,GAAG;AACvD,SAAO,OAAO,IAAI,IAAI,cAAc;AACtC;AAgBO,SAAS,cAAsB;AACpC,QAAM,QAAQ;AACd,MAAI,MAAM;AACV,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,WAAO,MAAM,OAAO,KAAK,MAAM,KAAK,OAAO,IAAI,MAAM,MAAM,CAAC;AAAA,EAC9D;AACA,SAAO;AACT;AAKO,SAAS,MAAM,OAAe,WAAW,GAAW;AACzD,QAAM,SAAS,KAAK,IAAI,IAAI,QAAQ;AACpC,SAAO,KAAK,MAAM,QAAQ,MAAM,IAAI;AACtC;;;ACXO,IAAM,iBAAN,MAAqB;AAAA,EAClB,KAAK,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUnB,MAAM,cACJ,OACA,WAC0B;AAC1B,QAAI,MAAM,WAAW,GAAG;AACtB,aAAO,KAAK,qBAAqB;AAAA,IACnC;AAGA,UAAM,aAAa,MAAM,IAAI,CAAC,SAAS,KAAK,SAAS;AACrD,UAAM,cAAc,MAAM,KAAK,GAC5B,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,QAAQ,SAAS,IAAI,UAAU,CAAC;AAGzC,UAAM,aAAa,MAChB,OAAO,CAAC,SAAS,KAAK,SAAS,EAC/B,IAAI,CAAC,SAAS,KAAK,SAAmB;AAEzC,QAAI,cAA0D,CAAC;AAC/D,QAAI,WAAW,SAAS,GAAG;AACzB,oBAAc,MAAM,KAAK,GACtB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,QAAQ,gBAAgB,IAAI,UAAU,CAAC;AAAA,IAClD;AAGA,UAAM,kBAAkB,MAAM,IAAI,CAAC,SAAS;AAC1C,YAAM,UAAU,YAAY,KAAK,CAAC,MAAM,EAAE,OAAO,KAAK,SAAS;AAE/D,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,MAClE;AAEA,UAAI,QAAQ,WAAW,UAAU;AAC/B,cAAM,IAAI,gBAAgB,6BAA6B,QAAQ,IAAI,EAAE;AAAA,MACvE;AAEA,UAAI,YAAY,OAAO,QAAQ,SAAS;AACxC,UAAI;AAGJ,UAAI,KAAK,WAAW;AAClB,kBAAU,YAAY,KAAK,CAAC,MAAM,EAAE,OAAO,KAAK,SAAS;AAEzD,YAAI,CAAC,SAAS;AACZ,gBAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,QAClE;AAEA,YAAI,CAAC,QAAQ,UAAU;AACrB,gBAAM,IAAI,gBAAgB,6BAA6B,QAAQ,IAAI,EAAE;AAAA,QACvE;AAEA,oBAAY,OAAO,QAAQ,SAAS;AAAA,MACtC;AAGA,YAAM,gBAAgB,SAAS,iBAAiB,QAAQ;AACxD,YAAM,UAAU,gBAAgB,KAAK,QAAQ;AAE7C,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,gBAAgB,4BAA4B,QAAQ,IAAI,EAAE;AAAA,MACtE;AAEA,UAAI,KAAK,WAAW,iBAAiB,CAAC,QAAQ,gBAAgB;AAC5D,cAAM,IAAI;AAAA,UACR,wBAAwB,QAAQ,IAAI,gBAAgB,aAAa;AAAA,QACnE;AAAA,MACF;AAEA,YAAM,YAAY,MAAM,YAAY,KAAK,UAAU,CAAC;AAEpD,aAAO;AAAA,QACL,IAAI,KAAK,MAAM,KAAK,aAAa,KAAK;AAAA,QACtC,WAAW,KAAK;AAAA,QAChB,WAAW,KAAK;AAAA,QAChB,SAAS;AAAA,UACP,IAAI,QAAQ;AAAA,UACZ,MAAM,QAAQ;AAAA,UACd,MAAM,QAAQ;AAAA,UACd,KAAK,QAAQ;AAAA,UACb,cAAc,KAAK,gBAAgB,OAAO;AAAA,UAC1C,WAAW;AAAA,UACX;AAAA,UACA;AAAA,QACF;AAAA,QACA,SAAS,UACL;AAAA,UACE,IAAI,QAAQ;AAAA,UACZ,MAAM,QAAQ;AAAA,UACd,KAAK,QAAQ;AAAA,UACb,SAAS,QAAQ;AAAA,UACjB,WAAW,OAAO,QAAQ,SAAS;AAAA,QACrC,IACA;AAAA,QACJ,UAAU,KAAK;AAAA,QACf;AAAA,QACA;AAAA,MACF;AAAA,IACF,CAAC;AAGD,UAAM,WAAW;AAAA,MACf,gBAAgB,OAAO,CAACE,MAAK,SAASA,OAAM,KAAK,WAAW,CAAC;AAAA,MAC7D;AAAA,IACF;AAGA,UAAM,oBAA4C,gBAAgB,IAAI,CAAC,SAAS;AAC9E,YAAM,UAAU,YAAY,KAAK,CAAC,MAAM,EAAE,OAAO,KAAK,SAAS;AAC/D,aAAO;AAAA,QACL,WAAW,KAAK;AAAA,QAChB,YAAY,SAAS,cAAc;AAAA,QACnC,WAAW,KAAK;AAAA,MAClB;AAAA,IACF,CAAC;AAGD,QAAI,iBAAiB;AACrB,QAAI,kBAA4B,CAAC;AACjC,QAAI;AAEJ,QAAI,WAAW;AACb,wBAAkB,MAAM,KAAK,kBAAkB,WAAW,QAAQ;AAElE,UAAI,iBAAiB;AACnB,cAAM,iBAAiB,KAAK,kBAAkB,iBAAiB,iBAAiB;AAChF,yBAAiB,eAAe;AAChC,0BAAkB,eAAe;AAAA,MACnC;AAAA,IACF;AAGA,UAAM,UAAU,MAAM,KAAK,WAAW;AAKtC,UAAM,gBAAgB,WAAW;AACjC,UAAM,YAAY,MAAM,gBAAgB,SAAS,CAAC;AAGlD,UAAM,iBAAiB;AAKvB,UAAM,QAAQ,MAAM,gBAAgB,YAAY,gBAAgB,CAAC;AAGjE,UAAM,YAAY,gBAAgB,OAAO,CAACA,MAAK,SAASA,OAAM,KAAK,UAAU,CAAC;AAE9E,WAAO;AAAA,MACL,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,WAAW,iBAAiB;AAAA,MAC5B,aAAa,iBAAiB;AAAA,MAC9B,iBAAiB,gBAAgB,SAAS,IAAI,kBAAkB;AAAA,MAChE;AAAA,MACA,UAAU;AAAA,IACZ;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,qBACJ,OACA,WAUC;AACD,UAAM,WAAW,MAAM,KAAK,cAAc,OAAO,SAAS;AAE1D,WAAO;AAAA,MACL,UAAU,SAAS;AAAA,MACnB,SAAS,SAAS;AAAA,MAClB,WAAW,SAAS;AAAA,MACpB,gBAAgB,SAAS;AAAA,MACzB,gBAAgB,SAAS;AAAA,MACzB,OAAO,SAAS;AAAA,MAChB,aAAa,SAAS;AAAA,MACtB,mBAAmB,SAAS;AAAA,IAC9B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBACJ,MACA,UACsC;AACtC,UAAM,CAAC,aAAa,IAAI,MAAM,KAAK,GAChC,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,KAAK,YAAY,CAAC,CAAC;AAEhD,QAAI,CAAC,eAAe;AAClB,aAAO;AAAA,IACT;AAGA,QAAI,CAAC,cAAc,UAAU;AAC3B,aAAO;AAAA,IACT;AAGA,UAAM,MAAM,oBAAI,KAAK;AAErB,QAAI,cAAc,YAAY,IAAI,KAAK,cAAc,QAAQ,IAAI,KAAK;AACpE,aAAO;AAAA,IACT;AAEA,QAAI,cAAc,aAAa,IAAI,KAAK,cAAc,SAAS,IAAI,KAAK;AACtE,aAAO;AAAA,IACT;AAGA,QACE,cAAc,eAAe,QAC7B,cAAc,cAAc,cAAc,YAC1C;AACA,aAAO;AAAA,IACT;AAGA,QACE,cAAc,uBAAuB,QACrC,WAAW,OAAO,cAAc,kBAAkB,GAClD;AACA,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,MACL,IAAI,cAAc;AAAA,MAClB,MAAM,cAAc;AAAA,MACpB,cAAc,cAAc;AAAA,MAC5B,eAAe,OAAO,cAAc,aAAa;AAAA,MACjD,oBAAoB,cAAc,qBAC9B,OAAO,cAAc,kBAAkB,IACvC;AAAA,MACJ,uBAAuB,cAAc,wBACjC,OAAO,cAAc,qBAAqB,IAC1C;AAAA,MACJ,mBAAmB,cAAc,qBAAqB;AAAA,MACtD,qBAAqB,cAAc,uBAAuB;AAAA,IAC5D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,uBACN,WACA,YACA,WACS;AACT,UAAM,yBAAyB,UAAU,qBAAqB,UAAU,kBAAkB,SAAS;AACnG,UAAM,0BAA0B,UAAU,uBAAuB,UAAU,oBAAoB,SAAS;AAGxG,QAAI,CAAC,0BAA0B,CAAC,yBAAyB;AACvD,aAAO;AAAA,IACT;AAGA,QAAI,0BAA0B,UAAU,kBAAmB,SAAS,SAAS,GAAG;AAC9E,aAAO;AAAA,IACT;AAGA,QAAI,2BAA2B,cAAc,UAAU,oBAAqB,SAAS,UAAU,GAAG;AAChG,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAMQ,kBACN,WACA,OACuD;AAEvD,UAAM,gBAAgB,MAAM;AAAA,MAAO,CAAC,SAClC,KAAK,uBAAuB,KAAK,WAAW,KAAK,YAAY,SAAS;AAAA,IACxE;AAGA,QAAI,cAAc,WAAW,GAAG;AAC9B,aAAO,EAAE,gBAAgB,GAAG,iBAAiB,CAAC,EAAE;AAAA,IAClD;AAGA,UAAM,mBAAmB;AAAA,MACvB,cAAc,OAAO,CAACA,MAAK,SAASA,OAAM,KAAK,WAAW,CAAC;AAAA,MAC3D;AAAA,IACF;AAEA,QAAI,WAAW;AAEf,QAAI,UAAU,iBAAiB,cAAc;AAC3C,iBAAW,oBAAoB,UAAU,gBAAgB;AAAA,IAC3D,OAAO;AAEL,iBAAW,KAAK,IAAI,UAAU,eAAe,gBAAgB;AAAA,IAC/D;AAGA,QAAI,UAAU,uBAAuB;AACnC,iBAAW,KAAK,IAAI,UAAU,UAAU,qBAAqB;AAAA,IAC/D;AAGA,eAAW,KAAK,IAAI,UAAU,gBAAgB;AAE9C,WAAO;AAAA,MACL,gBAAgB,MAAM,UAAU,CAAC;AAAA,MACjC,iBAAiB,cAAc,IAAI,CAAC,SAAS,KAAK,SAAS;AAAA,IAC7D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoBA,MAAc,aAA8B;AAC1C,UAAM,CAAC,UAAU,IAAI,MAAM,KAAK,GAC7B,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAEhC,QAAI,cAAc,WAAW,SAAS,OAAO,WAAW,UAAU,UAAU;AAC1E,YAAM,WAAW,WAAW;AAG5B,UAAI,SAAS,eAAe,OAAO,SAAS,aAAa,UAAU;AAEjE,eAAO,SAAS,WAAW;AAAA,MAC7B;AAGA,UAAI,SAAS,gBAAgB,OAAO;AAClC,eAAO;AAAA,MACT;AAAA,IACF;AAIA,WAAO,KAAK,yDAAyD;AACrE,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKQ,uBAAwC;AAC9C,WAAO;AAAA,MACL,OAAO,CAAC;AAAA,MACR,WAAW;AAAA,MACX,UAAU;AAAA,MACV,SAAS;AAAA;AAAA,MACT,WAAW;AAAA,MACX,gBAAgB;AAAA,MAChB,gBAAgB;AAAA,MAChB,OAAO;AAAA,MACP,UAAU;AAAA,IACZ;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQQ,gBAAgB,SAA2D;AACjF,QAAI,QAAQ,cAAc;AACxB,aAAO,QAAQ;AAAA,IACjB;AAEA,QAAI,QAAQ,UAAU,MAAM,QAAQ,QAAQ,MAAM,KAAK,QAAQ,OAAO,SAAS,GAAG;AAChF,YAAM,aAAa,QAAQ,OAAO,CAAC;AACnC,UAAI,cAAc,OAAO,eAAe,YAAY,SAAS,YAAY;AACvE,eAAO,WAAW;AAAA,MACpB;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AACF;AAGO,IAAM,iBAAiB,IAAI,eAAe;;;AClejD,oBAAwB;AAyEjB,IAAM,aAAN,MAAiB;AAAA;AAAA,EAEd,eAAe;AAAA,EACf,cAAc;AAAA,EACL,YAAY;AAAA,EACZ,YAAY;AAAA;AAAA,EAGrB,WAA8B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,EAM/B,gBAAgB,MAAsB;AAC5C,QAAI,CAAC,MAAM;AAAC,aAAO;AAAA,IAAG;AAEtB,QAAIC,QAAO;AAGX,IAAAA,QAAOA,MAAK,QAAQ,gBAAgB,IAAI;AAGxC,IAAAA,QAAOA,MAAK,QAAQ,WAAW,MAAM;AAGrC,IAAAA,QAAOA,MAAK,QAAQ,cAAc,EAAE;AAGpC,IAAAA,QAAOA,MAAK,QAAQ,iBAAiB,EAAE;AACvC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,EAAE;AAGlC,IAAAA,QAAOA,MAAK,QAAQ,aAAa,EAAE;AACnC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,EAAE;AAGlC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,EAAE;AAGlC,IAAAA,QAAOA,MAAK,QAAQ,eAAe,SAAI;AACvC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,IAAI;AACpC,IAAAA,QAAOA,MAAK,QAAQ,qBAAqB,IAAI;AAG7C,IAAAA,QAAOA,MAAK,QAAQ,mBAAmB,IAAI;AAC3C,IAAAA,QAAOA,MAAK,QAAQ,gBAAgB,IAAI;AAGxC,IAAAA,QAAOA,MAAK,QAAQ,mBAAmB,IAAI;AAC3C,IAAAA,QAAOA,MAAK,QAAQ,oBAAoB,EAAE;AAG1C,IAAAA,QAAOA,MAAK,QAAQ,YAAY,EAAE;AAGlC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,GAAG;AACnC,IAAAA,QAAOA,MAAK,QAAQ,WAAW,GAAG;AAClC,IAAAA,QAAOA,MAAK,QAAQ,UAAU,GAAG;AACjC,IAAAA,QAAOA,MAAK,QAAQ,UAAU,GAAG;AACjC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,GAAG;AACnC,IAAAA,QAAOA,MAAK,QAAQ,WAAW,GAAG;AAClC,IAAAA,QAAOA,MAAK,QAAQ,YAAY,GAAG;AAGnC,IAAAA,QAAOA,MAAK,QAAQ,WAAW,MAAM;AAGrC,IAAAA,QAAOA,MAAK,MAAM,IAAI,EAAE,IAAI,CAAAC,UAAQA,MAAK,KAAK,CAAC,EAAE,KAAK,IAAI,EAAE,KAAK;AAEjE,WAAOD;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKQ,cAAc,UAAoC;AACxD,SAAK,WAAW,YAAY,CAAC;AAC7B,QAAI,UAAU,cAAc;AAC1B,WAAK,eAAe,SAAS;AAAA,IAC/B,OAAO;AACL,WAAK,eAAe;AAAA,IACtB;AACA,QAAI,UAAU,aAAa;AACzB,WAAK,cAAc,SAAS;AAAA,IAC9B,OAAO;AACL,WAAK,cAAc;AAAA,IACrB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,qBAAqB,MAAqB,UAA+C;AAC7F,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAI;AACF,aAAK,cAAc,QAAQ;AAE3B,cAAM,MAAM,IAAI,cAAAE,QAAY;AAAA,UAC1B,MAAM;AAAA,UACN,QAAQ;AAAA,UACR,aAAa;AAAA,QACf,CAAC;AAED,cAAM,SAAmB,CAAC;AAE1B,YAAI,GAAG,QAAQ,CAAC,UAAU,OAAO,KAAK,KAAK,CAAC;AAC5C,YAAI,GAAG,OAAO,MAAM,QAAQ,OAAO,OAAO,MAAM,CAAC,CAAC;AAClD,YAAI,GAAG,SAAS,MAAM;AAGtB,YAAI,KAAK,SAAS,YAAY;AAC5B,cAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,cAAI,KAAK,KAAK,SAAS,YAAY,IAAI,IAAI,EAAE,OAAO,UAAU,OAAO,IAAI,CAAC;AAC1E,cAAI,IAAI;AAAA,QACV;AAGA,aAAK,UAAU,KAAK,MAAM,WAAW;AAGrC,aAAK,gBAAgB,KAAK,IAAI;AAG9B,aAAK,cAAc,KAAK,KAAK,KAAK;AAGlC,aAAK,UAAU,KAAK,IAAI;AAGxB,YAAI,KAAK,SAAS,iBAAiB;AACjC,cAAI,SAAS;AACb,cAAI,SAAS,EAAE,EAAE,UAAU,KAAK,WAAW;AAC3C,cAAI,KAAK,KAAK,SAAS,iBAAiB,IAAI,IAAI,GAAG,EAAE,OAAO,UAAU,OAAO,IAAI,CAAC;AAAA,QACpF;AAGA,aAAK,iBAAiB,KAAK,IAAI;AAG/B,aAAK,UAAU,KAAK,IAAI;AAExB,YAAI,IAAI;AAAA,MACV,SAAS,OAAO;AACd,eAAO,KAAK;AAAA,MACd;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,mBAAmB,MAAmB,UAA+C;AACzF,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAI;AACF,aAAK,cAAc,QAAQ;AAE3B,cAAM,MAAM,IAAI,cAAAA,QAAY;AAAA,UAC1B,MAAM;AAAA,UACN,QAAQ;AAAA,UACR,aAAa;AAAA,QACf,CAAC;AAED,cAAM,SAAmB,CAAC;AAE1B,YAAI,GAAG,QAAQ,CAAC,UAAU,OAAO,KAAK,KAAK,CAAC;AAC5C,YAAI,GAAG,OAAO,MAAM,QAAQ,OAAO,OAAO,MAAM,CAAC,CAAC;AAClD,YAAI,GAAG,SAAS,MAAM;AAGtB,YAAI,KAAK,SAAS,YAAY;AAC5B,cAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,cAAI,KAAK,KAAK,SAAS,YAAY,IAAI,IAAI,EAAE,OAAO,UAAU,OAAO,IAAI,CAAC;AAC1E,cAAI,IAAI;AAAA,QACV;AAGA,aAAK,UAAU,KAAK,MAAM,SAAS;AAGnC,YAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,YAAI,KAAK,cAAc,KAAK,aAAa,IAAI,IAAI,IAAI,CAAC;AACtD,YAAI,KAAK,YAAY,KAAK,WAAW,EAAE;AACvC,YAAI,KAAK,mBAAmB,KAAK,cAAc,YAAY,CAAC,EAAE;AAC9D,YAAI,KAAK,QAAQ;AACf,cAAI,KAAK,YAAY,KAAK,OAAO,mBAAmB,CAAC,EAAE;AAAA,QACzD;AACA,YAAI,SAAS;AAGb,aAAK,gBAAgB,KAAK,IAAI;AAG9B,aAAK,cAAc,KAAK,KAAK,KAAK;AAGlC,aAAK,UAAU,KAAK,IAAI;AAGxB,YAAI,KAAK,eAAe;AACtB,cAAI,SAAS;AACb,cAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,cAAI,KAAK,mBAAmB,KAAK,cAAc,YAAY,CAAC,EAAE;AAAA,QAChE;AAGA,YAAI,KAAK,SAAS,iBAAiB;AACjC,cAAI,SAAS;AACb,cAAI,SAAS,EAAE,EAAE,UAAU,KAAK,WAAW;AAC3C,cAAI,KAAK,KAAK,SAAS,iBAAiB,IAAI,IAAI,GAAG,EAAE,OAAO,UAAU,OAAO,IAAI,CAAC;AAAA,QACpF;AAGA,aAAK,UAAU,KAAK,IAAI;AAExB,YAAI,IAAI;AAAA,MACV,SAAS,OAAO;AACd,eAAO,KAAK;AAAA,MACd;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEQ,UAAU,KAAyB,MAAqB,OAAqB;AAEnF,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,YAAY;AAC5C,QAAI,KAAK,KAAK,aAAa,IAAI,EAAE;AAGjC,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,WAAW;AAC3C,QAAI,KAAK,OAAO,KAAK,IAAI,EAAE,OAAO,QAAQ,CAAC;AAG3C,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,QAAI,KAAK,MAAM,KAAK,eAAe,IAAI,KAAK,IAAI,EAAE,OAAO,QAAQ,CAAC;AAClE,QAAI,KAAK,SAAS,KAAK,UAAU,mBAAmB,CAAC,IAAI,EAAE,OAAO,QAAQ,CAAC;AAC3E,QAAI,KAAK,YAAY;AACnB,UAAI,KAAK,gBAAgB,KAAK,WAAW,mBAAmB,CAAC,IAAI,EAAE,OAAO,QAAQ,CAAC;AAAA,IACrF;AAGA,QAAI,SAAS,CAAC,EAAE,UAAU,SAAS;AACnC,QAAI,KAAK,gBAAgB;AACvB,UAAI,KAAK,KAAK,gBAAgB,IAAI,EAAE;AAAA,IACtC;AACA,QAAI,KAAK,cAAc;AACrB,UAAI,KAAK,UAAU,KAAK,YAAY,EAAE;AAAA,IACxC;AACA,QAAI,KAAK,cAAc;AACrB,UAAI,KAAK,UAAU,KAAK,YAAY,EAAE;AAAA,IACxC;AACA,QAAI,KAAK,gBAAgB;AACvB,UAAI,KAAK,QAAQ,KAAK,cAAc,EAAE;AAAA,IACxC;AAGA,QAAI,OAAO,IAAI,GAAG,EAAE,OAAO,KAAK,GAAG,EAAE,OAAO,KAAK,SAAS;AAC1D,QAAI,IAAI;AAAA,EACV;AAAA,EAEQ,gBAAgB,KAAyB,MAA2B;AAC1E,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,YAAY;AAC5C,QAAI,KAAK,YAAY,IAAI,IAAI,CAAC;AAE9B,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AACzC,QAAI,KAAK,KAAK,YAAY;AAC1B,QAAI,KAAK,iBAAiB;AACxB,UAAI,KAAK,KAAK,eAAe;AAAA,IAC/B;AACA,QAAI,KAAK,KAAK,aAAa;AAC3B,QAAI,KAAK,eAAe;AACtB,UAAI,KAAK,KAAK,aAAa;AAAA,IAC7B;AAEA,QAAI,SAAS,CAAC;AAAA,EAChB;AAAA,EAEQ,cAAc,KAAyB,OAA8B;AAC3E,UAAM,WAAW,IAAI;AACrB,UAAM,YAAY;AAClB,UAAM,UAAU,KAAK,SAAS,YAAY;AAC1C,UAAM,kBAAkB,KAAK,SAAS,4BAA4B;AAGlE,QAAI,KAAK,WAAW,UAAU,KAAK,EAAE,EAAE,KAAK,KAAK,YAAY;AAC7D,QAAI,SAAS,EAAE,EAAE,UAAU,SAAS;AAEpC,QAAI,SAAS;AACX,UAAI,KAAK,WAAW,YAAY,IAAI,WAAW,CAAC;AAChD,UAAI,KAAK,OAAO,YAAY,KAAK,WAAW,CAAC;AAC7C,UAAI,KAAK,OAAO,YAAY,KAAK,WAAW,CAAC;AAC7C,UAAI,KAAK,SAAS,YAAY,KAAK,WAAW,CAAC;AAC/C,UAAI,KAAK,SAAS,YAAY,KAAK,WAAW,CAAC;AAAA,IACjD,OAAO;AACL,UAAI,KAAK,WAAW,YAAY,IAAI,WAAW,CAAC;AAChD,UAAI,KAAK,OAAO,YAAY,KAAK,WAAW,CAAC;AAC7C,UAAI,KAAK,SAAS,YAAY,KAAK,WAAW,CAAC;AAC/C,UAAI,KAAK,SAAS,YAAY,KAAK,WAAW,CAAC;AAAA,IACjD;AAGA,QAAI,IAAI,WAAW;AACnB,QAAI,UAAU,KAAK,SAAS;AAE5B,UAAM,QAAQ,CAAC,MAAMC,WAAU;AAC7B,YAAM,YAAY,mBAAmB,KAAK,cAAc,KAAK;AAG7D,UAAIA,SAAQ,MAAM,GAAG;AACnB,YAAI,KAAK,WAAW,IAAI,GAAG,KAAK,SAAS,EAAE,KAAK,KAAK,SAAS;AAC9D,YAAI,UAAU,KAAK,SAAS;AAAA,MAC9B;AAEA,UAAI,SAAS,CAAC;AAGd,UAAI,cAAc,KAAK;AACvB,UAAI,KAAK,gBAAgB;AACvB,cAAM,UAAU,OAAO,QAAQ,KAAK,cAAc,EAC/C,IAAI,CAAC,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,KAAK,CAAC,EAAE,EAC5B,KAAK,IAAI;AACZ,uBAAe,KAAK,OAAO;AAAA,MAC7B;AAGA,YAAM,gBAAgB,UAAU,KAAK;AACrC,UAAI,YAAY,SAAS,eAAe;AACtC,sBAAc,YAAY,UAAU,GAAG,gBAAgB,CAAC,IAAI;AAAA,MAC9D;AAGA,UAAI,KAAK,YAAY;AACnB,YAAI,UAAU,KAAK,WAAW;AAC9B,YAAI,KAAK,aAAa,YAAY,IAAI,GAAG;AAAA,UACvC,OAAO,UAAU,MAAM;AAAA,UACvB,MAAM,KAAK;AAAA,UACX,WAAW;AAAA,QACb,CAAC;AACD,YAAI,UAAU,KAAK,SAAS;AAAA,MAC9B,OAAO;AACL,YAAI,KAAK,aAAa,YAAY,IAAI,GAAG,EAAE,OAAO,UAAU,MAAM,IAAI,CAAC;AAAA,MACzE;AAEA,UAAI,SAAS;AACX,YAAI,KAAK,KAAK,OAAO,KAAK,YAAY,KAAK,GAAG,EAAE,OAAO,GAAG,CAAC;AAAA,MAC7D;AAEA,UAAI,KAAK,KAAK,SAAS,SAAS,GAAG,YAAY,KAAK,GAAG,EAAE,OAAO,GAAG,CAAC;AACpE,UAAI,KAAK,IAAI,KAAK,UAAU,QAAQ,CAAC,CAAC,IAAI,YAAY,KAAK,GAAG,EAAE,OAAO,GAAG,CAAC;AAC3E,UAAI,KAAK,IAAI,KAAK,UAAU,QAAQ,CAAC,CAAC,IAAI,YAAY,KAAK,GAAG,EAAE,OAAO,GAAG,CAAC;AAG3E,UAAI,mBAAmB,KAAK,aAAa;AACvC,YAAI,SAAS,CAAC,EAAE,UAAU,SAAS;AACnC,cAAMC,QAAO,KAAK,YAAY,SAAS,KACnC,KAAK,YAAY,UAAU,GAAG,EAAE,IAAI,QACpC,KAAK;AACT,YAAI,KAAKA,OAAM,YAAY,IAAI,IAAI,IAAI,EAAE,OAAO,IAAI,CAAC;AACrD,YAAI,UAAU,KAAK,SAAS;AAAA,MAC9B;AAEA,WAAK;AAGL,UAAI,IAAI,KAAK;AACX,YAAI,QAAQ;AACZ,YAAI;AAAA,MACN;AAAA,IACF,CAAC;AAGD,QAAI,KAAK,WAAW,UAAU,KAAK,IAAI,QAAQ,EAAE,OAAO,SAAS;AAEjE,QAAI,IAAI,IAAI;AAAA,EACd;AAAA,EAEQ,UAAU,KAAyB,MAA2B;AACpE,UAAM,UAAU;AAChB,QAAI,IAAI,IAAI,IAAI;AAEhB,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,SAAS;AAGzC,QAAI,KAAK,aAAa,SAAS,CAAC;AAChC,QAAI,KAAK,IAAI,KAAK,SAAS,QAAQ,CAAC,CAAC,IAAI,UAAU,KAAK,GAAG,EAAE,OAAO,SAAS,OAAO,GAAG,CAAC;AACxF,SAAK;AAGL,QAAI,KAAK,iBAAiB,GAAG;AAC3B,UAAI,KAAK,aAAa,SAAS,CAAC;AAChC,UAAI,UAAU,SAAS;AACvB,UAAI,KAAK,KAAK,KAAK,eAAe,QAAQ,CAAC,CAAC,IAAI,UAAU,KAAK,GAAG,EAAE,OAAO,SAAS,OAAO,GAAG,CAAC;AAC/F,UAAI,UAAU,KAAK,SAAS;AAC5B,WAAK;AAAA,IACP;AAGA,QAAI,KAAK,SAAS,KAAK,UAAU,KAAK,QAAQ,CAAC,CAAC,OAAO,SAAS,CAAC;AACjE,QAAI,KAAK,IAAI,KAAK,UAAU,QAAQ,CAAC,CAAC,IAAI,UAAU,KAAK,GAAG,EAAE,OAAO,SAAS,OAAO,GAAG,CAAC;AACzF,SAAK;AAGL,QAAI,KAAK,iBAAiB,GAAG;AAC3B,UAAI,KAAK,aAAa,SAAS,CAAC;AAChC,UAAI,KAAK,IAAI,KAAK,eAAe,QAAQ,CAAC,CAAC,IAAI,UAAU,KAAK,GAAG,EAAE,OAAO,SAAS,OAAO,GAAG,CAAC;AAC9F,WAAK;AAAA,IACP;AAGA,QAAI,OAAO,SAAS,CAAC,EAAE,OAAO,KAAK,CAAC,EAAE,OAAO,SAAS;AACtD,SAAK;AAGL,QAAI,SAAS,EAAE,EAAE,UAAU,KAAK,YAAY;AAC5C,QAAI,KAAK,UAAU,SAAS,CAAC;AAC7B,QAAI,KAAK,GAAG,KAAK,QAAQ,KAAK,KAAK,MAAM,QAAQ,CAAC,CAAC,IAAI,UAAU,KAAK,GAAG,EAAE,OAAO,SAAS,OAAO,GAAG,CAAC;AAEtG,QAAI,IAAI,IAAI;AAAA,EACd;AAAA,EAEQ,iBAAiB,KAAyB,MAA2B;AAC3E,QAAI,KAAK,SAAS,KAAK,OAAO;AAC5B,UAAI,SAAS;AAEb,UAAI,KAAK,OAAO;AACd,YAAI,SAAS,EAAE,EAAE,UAAU,KAAK,YAAY;AAC5C,YAAI,KAAK,UAAU,IAAI,IAAI,CAAC;AAC5B,YAAI,SAAS,CAAC,EAAE,UAAU,KAAK,SAAS;AACxC,YAAI,KAAK,KAAK,OAAO,EAAE,OAAO,IAAI,CAAC;AACnC,YAAI,SAAS;AAAA,MACf;AAEA,UAAI,KAAK,OAAO;AACd,YAAI,SAAS,EAAE,EAAE,UAAU,KAAK,YAAY;AAC5C,YAAI,KAAK,uBAAuB,IAAI,IAAI,CAAC;AACzC,YAAI,SAAS,CAAC,EAAE,UAAU,KAAK,SAAS;AAExC,cAAM,cAAc,KAAK,gBAAgB,KAAK,KAAK;AACnD,YAAI,KAAK,aAAa,EAAE,OAAO,IAAI,CAAC;AAAA,MACtC;AAAA,IACF;AAAA,EACF;AAAA,EAEQ,UAAU,KAAyB,MAA2B;AACpE,UAAM,YAAY,IAAI,kBAAkB,EAAE;AAE1C,aAAS,IAAI,GAAG,IAAI,WAAW,KAAK;AAClC,UAAI,aAAa,CAAC;AAGlB,UAAI,OAAO,IAAI,GAAG,EAAE,OAAO,KAAK,GAAG,EAAE,OAAO,KAAK,SAAS;AAG1D,YAAM,aAAa,KAAK,SAAS,cAC5B,gBAAgB,KAAK,WAAW,WAAW,IAAI,CAAC,OAAO,SAAS;AAErE,UAAI,SAAS,CAAC,EAAE,UAAU,SAAS;AACnC,UAAI;AAAA,QACF;AAAA,QACA;AAAA,QACA;AAAA,QACA,EAAE,OAAO,UAAU,OAAO,IAAI;AAAA,MAChC;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkB,MAAqB,OAAgC,aAAiC;AACtG,UAAM,MAAM,IAAI,cAAAF,QAAY;AAAA,MAC1B,MAAM;AAAA,MACN,QAAQ;AAAA,MACR,aAAa;AAAA,IACf,CAAC;AAGD,QAAI,SAAS,aAAa;AACxB,WAAK,UAAU,KAAK,MAAM,WAAW;AAAA,IACvC,OAAO;AACL,WAAK,UAAU,KAAK,MAAM,SAAS;AAAA,IACrC;AAEA,SAAK,gBAAgB,KAAK,IAAI;AAC9B,SAAK,cAAc,KAAK,KAAK,KAAK;AAClC,SAAK,UAAU,KAAK,IAAI;AACxB,SAAK,iBAAiB,KAAK,IAAI;AAC/B,SAAK,UAAU,KAAK,IAAI;AAExB,QAAI,IAAI;AAER,WAAO;AAAA,EACT;AACF;AAEO,IAAM,aAAa,IAAI,WAAW;;;ACljBlC,IAAM,gBAAN,MAAoB;AAAA;AAAA;AAAA;AAAA,EAIzB,MACE,MACA,SACQ;AACR,QAAI,KAAK,WAAW,GAAG;AACrB,aAAO,QAAQ,IAAI,OAAK,EAAE,MAAM,EAAE,KAAK,GAAG;AAAA,IAC5C;AAGA,UAAM,UAAU,QAAQ,IAAI,OAAK,KAAK,UAAU,EAAE,MAAM,CAAC;AAGzD,UAAM,OAAO,KAAK,IAAI,SAAO;AAC3B,aAAO,QAAQ,IAAI,SAAO;AACxB,cAAM,QAAQ,KAAK,eAAe,KAAK,IAAI,GAAa;AACxD,cAAM,YAAY,IAAI,YAAY,IAAI,UAAU,OAAO,GAAG,IAAI;AAC9D,eAAO,KAAK,UAAU,OAAO,aAAa,EAAE,CAAC;AAAA,MAC/C,CAAC;AAAA,IACH,CAAC;AAED,WAAO,CAAC,QAAQ,KAAK,GAAG,GAAG,GAAG,KAAK,IAAI,OAAK,EAAE,KAAK,GAAG,CAAC,CAAC,EAAE,KAAK,IAAI;AAAA,EACrE;AAAA;AAAA;AAAA;AAAA,EAKA,OAAU,MAAW,SAAS,MAAc;AAC1C,WAAO,SAAS,KAAK,UAAU,MAAM,MAAM,CAAC,IAAI,KAAK,UAAU,IAAI;AAAA,EACrE;AAAA;AAAA;AAAA;AAAA,EAKA,QAAW,MAAmB;AAC5B,WAAO,KAAK,IAAI,SAAO,KAAK,UAAU,GAAG,CAAC,EAAE,KAAK,IAAI;AAAA,EACvD;AAAA;AAAA;AAAA;AAAA,EAKA,eAAe,QAGb;AACA,YAAQ,QAAQ;AAAA,MACd,KAAK;AACH,eAAO,EAAE,aAAa,YAAY,WAAW,MAAM;AAAA,MACrD,KAAK;AACH,eAAO,EAAE,aAAa,oBAAoB,WAAW,OAAO;AAAA,MAC9D,KAAK;AACH,eAAO,EAAE,aAAa,wBAAwB,WAAW,QAAQ;AAAA,MACnE,KAAK;AACH,eAAO,EAAE,aAAa,qEAAqE,WAAW,OAAO;AAAA,MAC/G;AACE,eAAO,EAAE,aAAa,4BAA4B,WAAW,MAAM;AAAA,IACvE;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY,QAAgB,QAAwB;AAClD,UAAMG,SAAO,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAClD,WAAO,GAAG,MAAM,WAAWA,KAAI,IAAI,MAAM;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,oBAA6D;AAC3D,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,OAAO,QAAQ,MAAM;AAAA,MAC5B,EAAE,KAAK,WAAW,QAAQ,UAAU;AAAA,MACpC,EAAE,KAAK,QAAQ,QAAQ,OAAO;AAAA,MAC9B,EAAE,KAAK,QAAQ,QAAQ,OAAO;AAAA,MAC9B,EAAE,KAAK,eAAe,QAAQ,cAAc;AAAA,MAC5C,EAAE,KAAK,oBAAoB,QAAQ,oBAAoB;AAAA,MACvD,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,gBAAgB,QAAQ,WAAW;AAAA,MAC1C,EAAE,KAAK,SAAS,QAAQ,QAAQ;AAAA,MAChC,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAC1F,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAC1F,EAAE,KAAK,kBAAkB,QAAQ,oBAAoB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MACrG,EAAE,KAAK,UAAU,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MACvF,EAAE,KAAK,cAAc,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MACxF,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,qBAAqB,QAAQ,sBAAsB;AAAA,MAC1D,EAAE,KAAK,kBAAkB,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MACvF,EAAE,KAAK,kBAAkB,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MACvF,EAAE,KAAK,UAAU,QAAQ,UAAU,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MAChF,EAAE,KAAK,UAAU,QAAQ,UAAU,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MAChF,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,QAAQ,QAAQ,QAAQ,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MACtF,EAAE,KAAK,kBAAkB,QAAQ,kBAAkB,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MAChG,EAAE,KAAK,YAAY,QAAQ,YAAY,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MAC9F,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,mBAAmB,QAAQ,mBAAmB;AAAA,MACrD,EAAE,KAAK,UAAU,QAAQ,SAAS;AAAA,MAClC,EAAE,KAAK,cAAc,QAAQ,YAAY,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MAC5E,EAAE,KAAK,aAAa,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MAClF,EAAE,KAAK,oBAAoB,QAAQ,qBAAqB,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MAC3F,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,eAAe,QAAQ,eAAe;AAAA,MAC7C,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,eAAe,QAAQ,eAAe;AAAA,MAC7C,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,kBAA2D;AACzD,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,eAAe,QAAQ,eAAe;AAAA,MAC7C,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,UAAU,QAAQ,SAAS;AAAA,MAClC,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,mBAAmB,QAAQ,oBAAoB,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MACnG,EAAE,KAAK,kBAAkB,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MACjG,EAAE,KAAK,YAAY,QAAQ,WAAW;AAAA,MACtC,EAAE,KAAK,oBAAoB,QAAQ,YAAY,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACnG,EAAE,KAAK,mBAAmB,QAAQ,YAAY,WAAW,CAAC,MAAM,KAAK,OAAO,CAAC,IAAI,KAAK,QAAQ,CAAC,IAAI,MAAM,GAAG;AAAA,MAC5G,EAAE,KAAK,qBAAqB,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACtG,EAAE,KAAK,0BAA0B,QAAQ,YAAY,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACzG,EAAE,KAAK,0BAA0B,QAAQ,YAAY,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACzG,EAAE,KAAK,iBAAiB,QAAQ,SAAS,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MAC7F,EAAE,KAAK,eAAe,QAAQ,gBAAgB;AAAA,MAC9C,EAAE,KAAK,qBAAqB,QAAQ,kBAAkB;AAAA,MACtD,EAAE,KAAK,kBAAkB,QAAQ,kBAAkB;AAAA,MACnD,EAAE,KAAK,kBAAkB,QAAQ,kBAAkB;AAAA,MACnD,EAAE,KAAK,eAAe,QAAQ,gBAAgB,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC7G,EAAE,KAAK,gBAAgB,QAAQ,iBAAiB,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC/G,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,eAAe,QAAQ,gBAAgB,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC7G,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,qBAA8D;AAC5D,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,cAAc,QAAQ,eAAe;AAAA,MAC5C,EAAE,KAAK,SAAS,QAAQ,QAAQ;AAAA,MAChC,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,YAAY,QAAQ,YAAY;AAAA,MACvC,EAAE,KAAK,SAAS,QAAQ,QAAQ;AAAA,MAChC,EAAE,KAAK,0BAA0B,QAAQ,4BAA4B,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MAClH,EAAE,KAAK,yBAAyB,QAAQ,2BAA2B,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MAChH,EAAE,KAAK,WAAW,QAAQ,SAAS,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MACtE,EAAE,KAAK,YAAY,QAAQ,UAAU,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MACxE,EAAE,KAAK,oBAAoB,QAAQ,qBAAqB,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MAC3F,EAAE,KAAK,SAAS,QAAQ,QAAQ;AAAA,MAChC,EAAE,KAAK,QAAQ,QAAQ,QAAQ,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MACtF,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,aAAa,QAAQ,iBAAiB,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC5G,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,sBAA+D;AAC7D,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,QAAQ,QAAQ,OAAO;AAAA,MAC9B,EAAE,KAAK,eAAe,QAAQ,cAAc;AAAA,MAC5C,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,iBAAiB,QAAQ,kBAAkB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAClG,EAAE,KAAK,sBAAsB,QAAQ,oBAAoB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,yBAAyB,QAAQ,uBAAuB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAC/G,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,cAAc,QAAQ,aAAa;AAAA,MAC1C,EAAE,KAAK,yBAAyB,QAAQ,2BAA2B;AAAA,MACnE,EAAE,KAAK,YAAY,QAAQ,UAAU,WAAW,CAAC,MAAM,IAAI,QAAQ,KAAK;AAAA,MACxE,EAAE,KAAK,YAAY,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACxG,EAAE,KAAK,aAAa,QAAQ,eAAe,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC1G,EAAE,KAAK,qBAAqB,QAAQ,uBAAuB,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MAClH,EAAE,KAAK,uBAAuB,QAAQ,yBAAyB,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MACtH,EAAE,KAAK,eAAe,QAAQ,2BAA2B,WAAW,CAAC,MAAM,MAAM,QAAQ,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,GAAG;AAAA,MAChH,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,sBAA+D;AAC7D,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,mBAAmB,QAAQ,mBAAmB;AAAA,MACrD,EAAE,KAAK,cAAc,QAAQ,cAAc;AAAA,MAC3C,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,iBAAiB,QAAQ,iBAAiB;AAAA,MACjD,EAAE,KAAK,mBAAmB,QAAQ,mBAAmB;AAAA,MACrD,EAAE,KAAK,mBAAmB,QAAQ,oBAAoB,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MACnG,EAAE,KAAK,UAAU,QAAQ,SAAS;AAAA,MAClC,EAAE,KAAK,cAAc,QAAQ,eAAe,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MAC3G,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,YAAY,QAAQ,WAAW;AAAA,MACtC,EAAE,KAAK,YAAY,QAAQ,YAAY,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MAC3F,EAAE,KAAK,WAAW,QAAQ,YAAY,WAAW,CAAC,MAAM,KAAK,OAAO,CAAC,IAAI,KAAK,QAAQ,CAAC,IAAI,MAAM,GAAG;AAAA,MACpG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAC1F,EAAE,KAAK,gBAAgB,QAAQ,gBAAgB;AAAA,MAC/C,EAAE,KAAK,iBAAiB,QAAQ,kBAAkB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,GAAG;AAAA,MAClG,EAAE,KAAK,kBAAkB,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACxG,EAAE,KAAK,SAAS,QAAQ,SAAS,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACrF,EAAE,KAAK,SAAS,QAAQ,QAAQ;AAAA,MAChC,EAAE,KAAK,sBAAsB,QAAQ,qBAAqB;AAAA,MAC1D,EAAE,KAAK,UAAU,QAAQ,UAAU;AAAA,MACnC,EAAE,KAAK,iBAAiB,QAAQ,kBAAkB;AAAA,MAClD,EAAE,KAAK,sBAAsB,QAAQ,wBAAwB;AAAA,MAC7D,EAAE,KAAK,mBAAmB,QAAQ,mBAAmB;AAAA,MACrD,EAAE,KAAK,kBAAkB,QAAQ,oBAAoB,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACpH,EAAE,KAAK,YAAY,QAAQ,aAAa,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACvG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,sBAA+D;AAC7D,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,WAAW,QAAQ,WAAW;AAAA,MACrC,EAAE,KAAK,eAAe,QAAQ,eAAe;AAAA,MAC7C,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,uBAAuB,QAAQ,eAAe;AAAA,MACrD,EAAE,KAAK,eAAe,QAAQ,MAAM;AAAA,MACpC,EAAE,KAAK,0BAA0B,QAAQ,mBAAmB,WAAW,CAAC,MAAM,IAAI,KAAK,UAAU,CAAC,IAAI,GAAG;AAAA,MACzG,EAAE,KAAK,YAAY,QAAQ,WAAW;AAAA,MACtC,EAAE,KAAK,qBAAqB,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MACtG,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MAC9F,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,0BAAmE;AACjE,WAAO;AAAA,MACL,EAAE,KAAK,MAAM,QAAQ,KAAK;AAAA,MAC1B,EAAE,KAAK,eAAe,QAAQ,eAAe;AAAA,MAC7C,EAAE,KAAK,mBAAmB,QAAQ,mBAAmB;AAAA,MACrD,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,aAAa,QAAQ,aAAa;AAAA,MACzC,EAAE,KAAK,QAAQ,QAAQ,YAAY;AAAA,MACnC,EAAE,KAAK,eAAe,QAAQ,cAAc;AAAA,MAC5C,EAAE,KAAK,OAAO,QAAQ,MAAM;AAAA,MAC5B,EAAE,KAAK,YAAY,QAAQ,WAAW;AAAA,MACtC,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MAC9F,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE,QAAQ,CAAC,IAAI,OAAO;AAAA,MAC9F,EAAE,KAAK,aAAa,QAAQ,cAAc,WAAW,CAAC,MAAM,IAAI,IAAI,KAAK,CAAW,EAAE,YAAY,IAAI,GAAG;AAAA,IAC3G;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMQ,UAAU,OAAuB;AAEvC,QAAI,MAAM,SAAS,GAAG,KAAK,MAAM,SAAS,GAAG,KAAK,MAAM,SAAS,IAAI,GAAG;AACtE,aAAO,IAAI,MAAM,QAAQ,MAAM,IAAI,CAAC;AAAA,IACtC;AACA,WAAO;AAAA,EACT;AAAA,EAEQ,eAAe,KAA8BC,OAAuB;AAC1E,WAAOA,MAAK,MAAM,GAAG,EAAE,OAAgB,CAAC,GAAG,MAAO,IAAgC,CAAC,GAAG,GAAG;AAAA,EAC3F;AACF;AAEO,IAAM,gBAAgB,IAAI,cAAc;;;AClT/C,IAAAC,cAAkB;AAsBX,IAAM,gBAAN,MAAoB;AAAA;AAAA;AAAA;AAAA,EAIzB,SAAS,YAA8C;AACrD,UAAM,QAAQ,WAAW,KAAK,EAAE,MAAM,IAAI;AAC1C,QAAI,MAAM,SAAS,GAAG;AACpB,aAAO,CAAC;AAAA,IACV;AAEA,UAAM,aAAa,MAAM,CAAC;AAC1B,QAAI,CAAC,YAAY;AACf,aAAO,CAAC;AAAA,IACV;AAEA,UAAM,UAAU,KAAK,aAAa,UAAU;AAC5C,UAAM,OAAiC,CAAC;AAExC,aAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,YAAMC,QAAO,MAAM,CAAC;AACpB,UAAI,CAACA,OAAM;AAAC;AAAA,MAAS;AAErB,YAAM,SAAS,KAAK,aAAaA,KAAI;AACrC,YAAM,MAA8B,CAAC;AAErC,cAAQ,QAAQ,CAAC,QAAQC,WAAU;AACjC,YAAI,OAAO,KAAK,CAAC,IAAI,OAAOA,MAAK,GAAG,KAAK,KAAK;AAAA,MAChD,CAAC;AAED,WAAK,KAAK,GAAG;AAAA,IACf;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKQ,aAAaD,OAAwB;AAC3C,UAAM,SAAmB,CAAC;AAC1B,QAAI,UAAU;AACd,QAAI,WAAW;AAEf,aAAS,IAAI,GAAG,IAAIA,MAAK,QAAQ,KAAK;AACpC,YAAME,QAAOF,MAAK,CAAC;AAEnB,UAAIE,UAAS,KAAK;AAChB,YAAI,YAAYF,MAAK,IAAI,CAAC,MAAM,KAAK;AAEnC,qBAAW;AACX;AAAA,QACF,OAAO;AACL,qBAAW,CAAC;AAAA,QACd;AAAA,MACF,WAAWE,UAAS,OAAO,CAAC,UAAU;AACpC,eAAO,KAAK,OAAO;AACnB,kBAAU;AAAA,MACZ,OAAO;AACL,mBAAWA;AAAA,MACb;AAAA,IACF;AAEA,WAAO,KAAK,OAAO;AACnB,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,eACE,MACA,UACA,QACiB;AACjB,UAAM,SAA0B;AAAA,MAC9B,SAAS;AAAA,MACT,WAAW,KAAK;AAAA,MAChB,cAAc;AAAA,MACd,YAAY;AAAA,MACZ,QAAQ,CAAC;AAAA,MACT,MAAM,CAAC;AAAA,IACT;AAEA,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,YAAM,MAAM,KAAK,CAAC;AAClB,UAAI,CAAC,KAAK;AAAC;AAAA,MAAS;AAEpB,YAAM,YAAY,IAAI;AAEtB,UAAI;AAEF,cAAM,SAAkC,CAAC;AAEzC,mBAAW,WAAW,UAAU;AAC9B,gBAAM,QAAQ,IAAI,QAAQ,SAAS;AAEnC,cAAI,QAAQ,aAAa,CAAC,SAAS,MAAM,KAAK,MAAM,KAAK;AACvD,kBAAM,IAAI,MAAM,2BAA2B,QAAQ,SAAS,EAAE;AAAA,UAChE;AAEA,cAAI,SAAS,MAAM,KAAK,MAAM,IAAI;AAChC,mBAAO,QAAQ,KAAK,IAAI,QAAQ,YAC5B,QAAQ,UAAU,KAAK,IACvB;AAAA,UACN;AAAA,QACF;AAGA,cAAM,YAAY,OAAO,MAAM,MAAM;AACrC,eAAO,KAAK,KAAK,SAAS;AAC1B,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO;AACP,eAAO,UAAU;AAEjB,YAAI,iBAAiB,cAAE,UAAU;AAC/B,gBAAM,OAAO,QAAQ,OAAK;AACxB,mBAAO,OAAO,KAAK;AAAA,cACjB,KAAK;AAAA,cACL,OAAO,EAAE,KAAK,KAAK,GAAG;AAAA,cACtB,SAAS,EAAE;AAAA,YACb,CAAC;AAAA,UACH,CAAC;AAAA,QACH,WAAW,iBAAiB,OAAO;AACjC,iBAAO,OAAO,KAAK;AAAA,YACjB,KAAK;AAAA,YACL,SAAS,MAAM;AAAA,UACjB,CAAC;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,qBAAsC;AACpC,WAAO;AAAA;AAAA,MAEL,EAAE,WAAW,QAAQ,OAAO,QAAQ,UAAU,KAAK;AAAA,MACnD,EAAE,WAAW,OAAO,OAAO,OAAO,UAAU,KAAK;AAAA,MACjD;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,UAAU;AAAA,QACV,WAAW,CAAC,MAAM,WAAW,EAAE,QAAQ,YAAY,EAAE,CAAC;AAAA,MACxD;AAAA;AAAA,MAEA,EAAE,WAAW,WAAW,OAAO,UAAU;AAAA,MACzC,EAAE,WAAW,eAAe,OAAO,cAAc;AAAA,MACjD,EAAE,WAAW,qBAAqB,OAAO,mBAAmB;AAAA,MAC5D,EAAE,WAAW,YAAY,OAAO,eAAe;AAAA,MAC/C,EAAE,WAAW,SAAS,OAAO,QAAQ;AAAA;AAAA,MAErC;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,IAAI,WAAW,EAAE,QAAQ,YAAY,EAAE,CAAC,IAAI;AAAA,MAChE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,IAAI,WAAW,EAAE,QAAQ,YAAY,EAAE,CAAC,IAAI;AAAA,MAChE;AAAA;AAAA,MAEA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,SAAS,CAAC,KAAK;AAAA,MACnC;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,SAAS,CAAC,KAAK;AAAA,MACnC;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,SAAS,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACzE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACxE;AAAA;AAAA,MAEA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,IAAI,WAAW,CAAC,IAAI;AAAA,MACxC;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM;AAChB,cAAI,CAAC,GAAG;AAAC,mBAAO;AAAA,UAAU;AAC1B,cAAI;AAEF,gBAAI,EAAE,WAAW,GAAG,GAAG;AAAC,qBAAO,KAAK,MAAM,CAAC;AAAA,YAAE;AAE7C,kBAAM,QAAQ,EAAE,MAAM,GAAG,EAAE,IAAI,OAAK,WAAW,EAAE,KAAK,CAAC,CAAC;AACxD,gBAAI,MAAM,WAAW,GAAG;AACtB,qBAAO,EAAE,OAAO,MAAM,CAAC,GAAG,QAAQ,MAAM,CAAC,GAAG,OAAO,MAAM,CAAC,EAAE;AAAA,YAC9D;AACA,mBAAO;AAAA,UACT,QAAQ;AACN,mBAAO;AAAA,UACT;AAAA,QACF;AAAA,MACF;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACxE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,SAAS,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACzE;AAAA;AAAA,MAEA,EAAE,WAAW,aAAa,OAAO,eAAe;AAAA,MAChD;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM;AAChB,cAAI,CAAC,GAAG;AAAC,mBAAO,CAAC;AAAA,UAAE;AACnB,cAAI;AACF,gBAAI,EAAE,WAAW,GAAG,GAAG;AAAC,qBAAO,KAAK,MAAM,CAAC;AAAA,YAAE;AAE7C,mBAAO,EAAE,MAAM,GAAG,EAAE,IAAI,UAAQ,EAAE,KAAK,IAAI,KAAK,EAAE,EAAE,EAAE,OAAO,SAAO,IAAI,GAAG;AAAA,UAC7E,QAAQ;AACN,mBAAO,CAAC;AAAA,UACV;AAAA,QACF;AAAA,MACF;AAAA;AAAA,MAEA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM;AAChB,gBAAM,aAAa,EAAE,YAAY,EAAE,KAAK;AACxC,cAAI,CAAC,UAAU,SAAS,UAAU,EAAE,SAAS,UAAU,GAAG;AACxD,mBAAO;AAAA,UACT;AACA,iBAAO;AAAA,QACT;AAAA,MACF;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACxE;AAAA;AAAA,MAEA,EAAE,WAAW,cAAc,OAAO,YAAY;AAAA,MAC9C,EAAE,WAAW,oBAAoB,OAAO,kBAAkB;AAAA;AAAA,MAE1D;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,EAAE,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO;AAAA,MAClE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,EAAE,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO;AAAA,MAClE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM;AAChB,cAAI,CAAC,GAAG;AAAC,mBAAO,CAAC;AAAA,UAAE;AACnB,cAAI;AACF,gBAAI,EAAE,WAAW,GAAG,GAAG;AAAC,qBAAO,KAAK,MAAM,CAAC;AAAA,YAAE;AAE7C,kBAAM,QAAgC,CAAC;AACvC,cAAE,MAAM,GAAG,EAAE,QAAQ,UAAQ;AAC3B,oBAAM,CAAC,KAAK,KAAK,IAAI,KAAK,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC;AACtD,kBAAI,OAAO,OAAO;AAAC,sBAAM,GAAG,IAAI;AAAA,cAAM;AAAA,YACxC,CAAC;AACD,mBAAO;AAAA,UACT,QAAQ;AACN,mBAAO,CAAC;AAAA,UACV;AAAA,QACF;AAAA,MACF;AAAA;AAAA,MAEA,EAAE,WAAW,eAAe,OAAO,aAAa;AAAA,MAChD,EAAE,WAAW,gBAAgB,OAAO,cAAc;AAAA,IACpD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,mBAAmB;AACjB,WAAO,cAAE,OAAO;AAAA;AAAA,MAEd,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,MAC/B,KAAK,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,MAC9B,WAAW,cAAE,OAAO,EAAE,SAAS;AAAA;AAAA,MAE/B,SAAS,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MACtC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,MACjC,kBAAkB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MAC/C,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,MAClC,OAAO,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA;AAAA,MAEpC,WAAW,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,MAC1C,gBAAgB,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,MAE/C,eAAe,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC;AAAA,MAC3D,mBAAmB,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC;AAAA,MAC/D,gBAAgB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,MACnD,gBAAgB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA;AAAA,MAEpD,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,MAC5B,YAAY,cAAE,OAAO;AAAA,QACnB,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,QAC3B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,QAC5B,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,MAC7B,CAAC,EAAE,SAAS;AAAA,MACZ,WAAW,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,MAC/C,kBAAkB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA;AAAA,MAErD,cAAc,cAAE,OAAO,EAAE,IAAI,EAAE,SAAS;AAAA,MACxC,QAAQ,cAAE,MAAM,cAAE,OAAO;AAAA,QACvB,KAAK,cAAE,OAAO,EAAE,IAAI;AAAA,QACpB,KAAK,cAAE,OAAO,EAAE,SAAS;AAAA,MAC3B,CAAC,CAAC,EAAE,SAAS;AAAA;AAAA,MAEb,QAAQ,cAAE,KAAK,CAAC,UAAU,SAAS,UAAU,CAAC,EAAE,SAAS,EAAE,QAAQ,OAAO;AAAA,MAC1E,YAAY,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA;AAAA,MAEhD,WAAW,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MACxC,iBAAiB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA;AAAA,MAE9C,MAAM,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA,MACnC,UAAU,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA,MACvC,gBAAgB,cAAE,OAAO,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA;AAAA,MAE9C,YAAY,cAAE,OAAO,EAAE,SAAS;AAAA,MAChC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,IACnC,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,sBAAuC;AACrC,WAAO;AAAA;AAAA,MAEL,EAAE,WAAW,SAAS,OAAO,SAAS,UAAU,KAAK;AAAA;AAAA,MAErD,EAAE,WAAW,cAAc,OAAO,YAAY;AAAA,MAC9C,EAAE,WAAW,aAAa,OAAO,WAAW;AAAA,MAC5C,EAAE,WAAW,SAAS,OAAO,QAAQ;AAAA;AAAA,MAErC;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,SAAS,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACzE;AAAA,MACA;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,EAAE,SAAS,EAAE,YAAY,EAAE,KAAK,CAAC;AAAA,MACxE;AAAA;AAAA,MAEA,EAAE,WAAW,SAAS,OAAO,QAAQ;AAAA,MACrC;AAAA,QACE,WAAW;AAAA,QACX,OAAO;AAAA,QACP,WAAW,CAAC,MAAM,EAAE,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO;AAAA,MAClE;AAAA;AAAA,MAEA,EAAE,WAAW,uBAAuB,OAAO,oBAAoB;AAAA,MAC/D,EAAE,WAAW,sBAAsB,OAAO,mBAAmB;AAAA,MAC7D,EAAE,WAAW,oBAAoB,OAAO,kBAAkB;AAAA,MAC1D,EAAE,WAAW,0BAA0B,OAAO,uBAAuB;AAAA,MACrE,EAAE,WAAW,0BAA0B,OAAO,uBAAuB;AAAA,MACrE,EAAE,WAAW,iBAAiB,OAAO,eAAe;AAAA,MACpD,EAAE,WAAW,kBAAkB,OAAO,gBAAgB;AAAA,MACtD,EAAE,WAAW,wBAAwB,OAAO,qBAAqB;AAAA,MACjE,EAAE,WAAW,oBAAoB,OAAO,kBAAkB;AAAA,MAC1D,EAAE,WAAW,kBAAkB,OAAO,gBAAgB;AAAA;AAAA,MAEtD,EAAE,WAAW,sBAAsB,OAAO,mBAAmB;AAAA,MAC7D,EAAE,WAAW,qBAAqB,OAAO,kBAAkB;AAAA,MAC3D,EAAE,WAAW,mBAAmB,OAAO,iBAAiB;AAAA,MACxD,EAAE,WAAW,yBAAyB,OAAO,sBAAsB;AAAA,MACnE,EAAE,WAAW,yBAAyB,OAAO,sBAAsB;AAAA,MACnE,EAAE,WAAW,gBAAgB,OAAO,cAAc;AAAA,MAClD,EAAE,WAAW,iBAAiB,OAAO,eAAe;AAAA,MACpD,EAAE,WAAW,uBAAuB,OAAO,oBAAoB;AAAA,MAC/D,EAAE,WAAW,mBAAmB,OAAO,iBAAiB;AAAA,MACxD,EAAE,WAAW,iBAAiB,OAAO,eAAe;AAAA,IACtD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,oBAAoB;AAClB,WAAO,cAAE,OAAO;AAAA;AAAA,MAEd,OAAO,cAAE,OAAO,EAAE,MAAM;AAAA;AAAA,MAExB,WAAW,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MACxC,UAAU,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MACvC,OAAO,cAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA;AAAA,MAEnC,UAAU,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,MAC7C,kBAAkB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA;AAAA,MAEtD,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,MAC3B,MAAM,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA;AAAA,MAEnC,mBAAmB,cAAE,OAAO,EAAE,SAAS;AAAA,MACvC,kBAAkB,cAAE,OAAO,EAAE,SAAS;AAAA,MACtC,iBAAiB,cAAE,OAAO,EAAE,SAAS;AAAA,MACrC,sBAAsB,cAAE,OAAO,EAAE,SAAS;AAAA,MAC1C,sBAAsB,cAAE,OAAO,EAAE,SAAS;AAAA,MAC1C,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,MAClC,eAAe,cAAE,OAAO,EAAE,SAAS;AAAA,MACnC,oBAAoB,cAAE,OAAO,EAAE,SAAS;AAAA,MACxC,iBAAiB,cAAE,OAAO,EAAE,SAAS;AAAA,MACrC,eAAe,cAAE,OAAO,EAAE,SAAS;AAAA;AAAA,MAEnC,kBAAkB,cAAE,OAAO,EAAE,SAAS;AAAA,MACtC,iBAAiB,cAAE,OAAO,EAAE,SAAS;AAAA,MACrC,gBAAgB,cAAE,OAAO,EAAE,SAAS;AAAA,MACpC,qBAAqB,cAAE,OAAO,EAAE,SAAS;AAAA,MACzC,qBAAqB,cAAE,OAAO,EAAE,SAAS;AAAA,MACzC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,MACjC,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,MAClC,mBAAmB,cAAE,OAAO,EAAE,SAAS;AAAA,MACvC,gBAAgB,cAAE,OAAO,EAAE,SAAS;AAAA,MACpC,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,IACpC,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,qBAA6B;AAC3B,UAAM,UAAU;AAAA,MACd;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,UAAM,aAAa;AAAA,MACjB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,WAAO,GAAG,QAAQ,KAAK,GAAG,CAAC;AAAA,GAAM,WAAW,KAAK,KAAK,CAAC;AAAA,EACzD;AAAA;AAAA;AAAA;AAAA,EAKA,sBAA8B;AAC5B,UAAM,UAAU;AAAA,MACd;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,UAAM,aAAa;AAAA,MACjB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,WAAO,GAAG,QAAQ,KAAK,GAAG,CAAC;AAAA,GAAM,WAAW,KAAK,KAAK,CAAC;AAAA,EACzD;AAAA;AAAA;AAAA;AAAA,EAKA,2BAA2B,MAA+B,QAAgE;AACxH,UAAM,eAAe,KAAK,GAAG,MAAM,cAAc;AACjD,QAAI,CAAC,cAAc;AAAC,aAAO;AAAA,IAAK;AAEhC,WAAO;AAAA,MACL,WAAW,KAAK,GAAG,MAAM,WAAW,KAAK;AAAA,MACzC,UAAU,KAAK,GAAG,MAAM,UAAU,KAAK;AAAA,MACvC,SAAS,KAAK,GAAG,MAAM,SAAS,KAAK;AAAA,MACrC;AAAA,MACA,cAAc,KAAK,GAAG,MAAM,cAAc,KAAK;AAAA,MAC/C,MAAM,KAAK,GAAG,MAAM,MAAM,KAAK;AAAA,MAC/B,OAAO,KAAK,GAAG,MAAM,OAAO,KAAK;AAAA,MACjC,YAAY,KAAK,GAAG,MAAM,YAAY,KAAK;AAAA,MAC3C,SAAS,KAAK,GAAG,MAAM,SAAS,KAAK;AAAA,MACrC,OAAO,KAAK,GAAG,MAAM,OAAO,KAAK;AAAA,IACnC;AAAA,EACF;AACF;AAEO,IAAM,gBAAgB,IAAI,cAAc;;;AC7nB/C,yBAAiE;AAOjE,IAAM,mBAAmB,QAAQ,IAAI,kBAAkB,KAAK;AAC5D,IAAM,sBAAsB,QAAQ,IAAI,qBAAqB,KAAK;AAG3D,IAAM,iBAAiB;AA2C9B,IAAM,gBAAN,MAAoB;AAAA,EACR,SAA6B;AAAA,EAC7B,cAAc;AAAA;AAAA;AAAA;AAAA,EAKd,YAAyB;AAC7B,QAAI,CAAC,KAAK,QAAQ;AACd,WAAK,SAAS,IAAI,+BAAY;AAAA,QAC1B,MAAM;AAAA,QACN,QAAQ;AAAA,MACZ,CAAC;AAAA,IACL;AACA,WAAO,KAAK;AAAA,EAChB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAgC;AAClC,QAAI;AACA,YAAM,SAAS,KAAK,UAAU;AAC9B,YAAM,OAAO,OAAO;AACpB,aAAO;AAAA,IACX,SAAS,OAAO;AACZ,cAAQ,KAAK,iCAAiC,iBAAiB,QAAQ,MAAM,UAAU,eAAe;AACtG,aAAO;AAAA,IACX;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,aAA4B;AAC9B,QAAI,KAAK,aAAa;AAAC;AAAA,IAAO;AAE9B,QAAI;AACA,YAAM,SAAS,KAAK,UAAU;AAG9B,UAAI;AACA,cAAM,OAAO,SAAS,cAAc;AAAA,MACxC,QAAQ;AACJ,cAAM,OAAO,YAAY,gBAAgB,EAAE,YAAY,KAAK,CAAC;AAAA,MACjE;AAEA,YAAMC,SAAQ,OAAO,MAAM,cAAc;AAGzC,YAAMA,OAAM,2BAA2B;AAAA,QACnC;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACJ,CAAC;AAGD,YAAMA,OAAM,2BAA2B;AAAA,QACnC;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACJ,CAAC;AAGD,YAAMA,OAAM,yBAAyB;AAAA,QACjC;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACJ,CAAC;AAGD,YAAMA,OAAM,mBAAmB;AAAA,QAC3B;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACJ,CAAC;AAGD,YAAMA,OAAM,oBAAoB;AAAA,QAC5B,SAAS;AAAA,QACT,qBAAqB;AAAA,UACjB,SAAS;AAAA,UACT,UAAU;AAAA,QACd;AAAA,MACJ,CAAC;AAED,WAAK,cAAc;AACnB,cAAQ,IAAI,sCAAsC;AAAA,IACtD,SAAS,OAAO;AACZ,cAAQ,MAAM,qCAAqC,KAAK;AACxD,YAAM;AAAA,IACV;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,mBAA2C;AACvC,WAAO,KAAK,UAAU,EAAE,MAAM,cAAc;AAAA,EAChD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,aAAa,SAAyC;AACxD,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAMA,OAAM,aAAa,CAAC,OAAO,CAAC;AAAA,IACtC,SAAS,OAAO;AACZ,cAAQ,MAAM,4BAA4B,KAAK;AAAA,IACnD;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAc,aAA+C;AAC/D,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAMA,OAAM,aAAa,WAAW;AAAA,IACxC,SAAS,OAAO;AACZ,cAAQ,MAAM,6BAA6B,KAAK;AAAA,IACpD;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAc,SAAyC;AACzD,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAMA,OAAM,gBAAgB,CAAC,OAAO,CAAC;AAAA,IACzC,SAAS,OAAO;AACZ,cAAQ,MAAM,sCAAsC,KAAK;AAAA,IAC7D;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAc,WAAkC;AAClD,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAMA,OAAM,eAAe,SAAS;AAAA,IACxC,SAAS,OAAO;AACZ,cAAQ,MAAM,wCAAwC,KAAK;AAAA,IAC/D;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,eACF,OACA,UAMI,CAAC,GACgB;AACrB,UAAM,EAAE,QAAQ,IAAI,SAAS,GAAG,UAAU,CAAC,GAAG,OAAO,CAAC,GAAG,SAAS,CAAC,EAAE,IAAI;AAEzE,UAAM,eAA6B;AAAA,MAC/B;AAAA,MACA;AAAA,MACA,sBAAsB;AAAA,QAClB;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACJ;AAAA,IACJ;AAGA,QAAI,QAAQ,SAAS,GAAG;AACpB,mBAAa,SAAS;AAAA,IAC1B;AAGA,QAAI,KAAK,SAAS,GAAG;AACjB,mBAAa,OAAO;AAAA,IACxB;AAGA,QAAI,OAAO,SAAS,GAAG;AACnB,mBAAa,SAAS;AAAA,IAC1B;AAEA,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAM,WAAW,MAAMA,OAAM,OAAO,OAAO,YAAY;AAEvD,aAAO;AAAA,QACH,MAAM,SAAS;AAAA,QACf,OAAO,SAAS;AAAA,QAChB,kBAAkB,SAAS;AAAA,QAC3B,oBAAoB,SAAS,sBAAsB;AAAA,QACnD;AAAA,QACA;AAAA,QACA,mBAAmB,SAAS;AAAA,MAChC;AAAA,IACJ,SAAS,OAAO;AACZ,cAAQ,MAAM,kBAAkB,KAAK;AACrC,YAAM;AAAA,IACV;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAgE;AAClE,UAAMC,MAAK,MAAM;AACjB,QAAI,UAAU;AACd,QAAI,SAAS;AAEb,QAAI;AAEA,YAAM,cAAc,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,QAAQ,QAAQ,CAAC;AAGxC,YAAM,eAAe,MAAMA,IAAG,OAAO,EAAE,KAAK,UAAU;AACtD,YAAM,cAAc,IAAI,IAAI,aAAa,IAAI,OAAK,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC;AAG5D,YAAM,YAA+B,YAAY,IAAI,aAAW;AAC5D,cAAM,WAAW,QAAQ,aAAa,YAAY,IAAI,QAAQ,UAAU,IAAI;AAE5E,eAAO;AAAA,UACH,IAAI,QAAQ;AAAA,UACZ,KAAK,QAAQ;AAAA,UACb,MAAM,QAAQ;AAAA,UACd,MAAM,QAAQ;AAAA,UACd,aAAa,QAAQ;AAAA,UACrB,kBAAkB,QAAQ;AAAA,UAC1B,OAAO,QAAQ;AAAA,UACf,YAAY,QAAQ;AAAA,UACpB,cAAc,UAAU,QAAQ;AAAA,UAChC,cAAc,UAAU,QAAQ;AAAA,UAChC,WAAW,OAAO,QAAQ,SAAS;AAAA,UACnC,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,UAC1E,eAAe,QAAQ;AAAA,UACvB,SAAS,QAAQ,gBAAgB,KAAK,QAAQ;AAAA,UAC9C,YAAY,QAAQ;AAAA,UACpB,MAAM,QAAQ,QAAoB,CAAC;AAAA,UACnC,cAAc,QAAQ;AAAA,UACtB,QAAQ,QAAQ,UAAkD,CAAC;AAAA,UACnE,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,UAC/C,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,QACnD;AAAA,MACJ,CAAC;AAGD,UAAI,UAAU,SAAS,GAAG;AACtB,cAAMD,SAAQ,KAAK,iBAAiB;AAEpC,cAAMA,OAAM,mBAAmB;AAC/B,cAAMA,OAAM,aAAa,SAAS;AAClC,kBAAU,UAAU;AAAA,MACxB;AAEA,cAAQ,IAAI,UAAU,OAAO,0BAA0B;AAAA,IAC3D,SAAS,OAAO;AACZ,cAAQ,MAAM,4BAA4B,KAAK;AAC/C;AAAA,IACJ;AAEA,WAAO,EAAE,SAAS,OAAO;AAAA,EAC7B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBAGH;AACC,QAAI;AACA,YAAMA,SAAQ,KAAK,iBAAiB;AACpC,YAAM,QAAQ,MAAMA,OAAM,SAAS;AACnC,aAAO;AAAA,QACH,mBAAmB,MAAM;AAAA,QACzB,YAAY,MAAM;AAAA,MACtB;AAAA,IACJ,SAAS,OAAO;AACZ,cAAQ,MAAM,8BAA8B,KAAK;AACjD,aAAO,EAAE,mBAAmB,GAAG,YAAY,MAAM;AAAA,IACrD;AAAA,EACJ;AACJ;AAGO,IAAM,gBAAgB,IAAI,cAAc;;;ACvX/C,oBAAmB;AAMZ,SAAS,oBAAoB,SAAS,IAAY;AACvD,SAAO,cAAAE,QAAO,YAAY,MAAM,EAAE,SAAS,KAAK;AAClD;AA4BO,SAAS,2BAAmC;AAEjD,QAAM,OAAO,cAAAC,QAAO,UAAU,GAAG,GAAO;AAGxC,SAAO,KAAK,SAAS,EAAE,SAAS,GAAG,GAAG;AACxC;;;ACxBA,IAAM,0BAAN,MAA8B;AAAA,EACX,yBAAyB;AAAA,EACzB,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA,EAMhC,MAAM,WAAW,SAA6C;AAC5D,UAAM,EAAE,OAAO,MAAM,WAAW,gBAAgB,KAAK,uBAAuB,IAAI;AAChF,UAAMC,MAAK,MAAM;AAGjB,UAAM,KAAK,gBAAgB,OAAO,IAAI;AAGtC,UAAM,OAAO,yBAAyB;AAGtC,UAAM,YAAY,oBAAI,KAAK;AAC3B,cAAU,WAAW,UAAU,WAAW,IAAI,aAAa;AAG3D,UAAMA,IAAG,OAAO,iBAAiB,EAAE,OAAO;AAAA,MACxC,OAAO,MAAM,YAAY;AAAA,MACzB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,aAAa,KAAK;AAAA,IACpB,CAAC;AAED,WAAO,KAAK,6BAA6B,EAAE,OAAO,MAAM,UAAU,CAAC;AACnE,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,aAAa,SAAgD;AACjE,UAAM,EAAE,OAAO,MAAM,KAAK,IAAI;AAC9B,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAGrB,UAAM,CAAC,MAAM,IAAI,MAAMA,IACpB,OAAO,EACP,KAAK,iBAAiB,EACtB;AAAA,MACC;AAAA,QACE,GAAG,kBAAkB,OAAO,MAAM,YAAY,CAAC;AAAA,QAC/C,GAAG,kBAAkB,MAAM,IAAI;AAAA,QAC/B,GAAG,kBAAkB,QAAQ,KAAK;AAAA,QAClC,IAAI,kBAAkB,WAAW,GAAG;AAAA,MACtC;AAAA,IACF,EACC,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,CAAC;AAEV,QAAI,CAAC,QAAQ;AACX,aAAO,KAAK,0CAA0C,EAAE,OAAO,KAAK,CAAC;AACrE,YAAM,IAAI,gBAAgB,sCAAsC;AAAA,IAClE;AAGA,QAAI,OAAO,YAAY,OAAO,aAAa;AACzC,aAAO,KAAK,sCAAsC,EAAE,OAAO,MAAM,UAAU,OAAO,SAAS,CAAC;AAC5F,YAAM,IAAI,qBAAqB,oEAAoE;AAAA,IACrG;AAGA,UAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI,EAAE,UAAU,OAAO,WAAW,EAAE,CAAC,EACrC,MAAM,GAAG,kBAAkB,IAAI,OAAO,EAAE,CAAC;AAG5C,QAAI,OAAO,SAAS,MAAM;AACxB,aAAO,KAAK,qCAAqC,EAAE,OAAO,MAAM,UAAU,OAAO,WAAW,EAAE,CAAC;AAC/F,YAAM,IAAI,gBAAgB,2BAA2B;AAAA,IACvD;AAGA,UAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,QAAQ;AAAA,IACV,CAAC,EACA,MAAM,GAAG,kBAAkB,IAAI,OAAO,EAAE,CAAC;AAE5C,WAAO,KAAK,4CAA4C,EAAE,OAAO,KAAK,CAAC;AACvE,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,MAAM,2BAA2B,SAAgD;AAC/E,UAAM,EAAE,OAAO,MAAM,KAAK,IAAI;AAC9B,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAGrB,UAAM,CAAC,MAAM,IAAI,MAAMA,IACpB,OAAO,EACP,KAAK,iBAAiB,EACtB;AAAA,MACC;AAAA,QACE,GAAG,kBAAkB,OAAO,MAAM,YAAY,CAAC;AAAA,QAC/C,GAAG,kBAAkB,MAAM,IAAI;AAAA,QAC/B,GAAG,kBAAkB,QAAQ,KAAK;AAAA,QAClC,IAAI,kBAAkB,WAAW,GAAG;AAAA,MACtC;AAAA,IACF,EACC,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,CAAC;AAEV,QAAI,CAAC,QAAQ;AACX,aAAO,KAAK,0CAA0C,EAAE,OAAO,KAAK,CAAC;AACrE,YAAM,IAAI,gBAAgB,sCAAsC;AAAA,IAClE;AAGA,QAAI,OAAO,YAAY,OAAO,aAAa;AACzC,aAAO,KAAK,sCAAsC,EAAE,OAAO,MAAM,UAAU,OAAO,SAAS,CAAC;AAC5F,YAAM,IAAI,qBAAqB,oEAAoE;AAAA,IACrG;AAGA,UAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI,EAAE,UAAU,OAAO,WAAW,EAAE,CAAC,EACrC,MAAM,GAAG,kBAAkB,IAAI,OAAO,EAAE,CAAC;AAG5C,QAAI,OAAO,SAAS,MAAM;AACxB,aAAO,KAAK,qCAAqC,EAAE,OAAO,MAAM,UAAU,OAAO,WAAW,EAAE,CAAC;AAC/F,YAAM,IAAI,gBAAgB,2BAA2B;AAAA,IACvD;AAEA,WAAO,KAAK,wDAAwD,EAAE,OAAO,KAAK,CAAC;AACnF,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,eAAe,OAAe,MAA2C;AAC7E,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAGrB,UAAM,CAAC,MAAM,IAAI,MAAMA,IACpB,OAAO,EACP,KAAK,iBAAiB,EACtB;AAAA,MACC;AAAA,QACE,GAAG,kBAAkB,OAAO,MAAM,YAAY,CAAC;AAAA,QAC/C,GAAG,kBAAkB,MAAM,IAAI;AAAA,QAC/B,GAAG,kBAAkB,QAAQ,KAAK;AAAA,QAClC,IAAI,kBAAkB,WAAW,GAAG;AAAA,MACtC;AAAA,IACF,EACC,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,CAAC;AAEV,QAAI,QAAQ;AACV,YAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI;AAAA,QACH,QAAQ;AAAA,QACR,QAAQ;AAAA,MACV,CAAC,EACA,MAAM,GAAG,kBAAkB,IAAI,OAAO,EAAE,CAAC;AAE5C,aAAO,KAAK,oCAAoC,EAAE,OAAO,KAAK,CAAC;AAAA,IACjE;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBAAgB,OAAe,MAA2C;AAC9E,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAErB,UAAM,SAAS,MAAMA,IAClB,OAAO,iBAAiB,EACxB,IAAI,EAAE,QAAQ,MAAM,QAAQ,IAAI,CAAC,EACjC;AAAA,MACC;AAAA,QACE,GAAG,kBAAkB,OAAO,MAAM,YAAY,CAAC;AAAA,QAC/C,GAAG,kBAAkB,MAAM,IAAI;AAAA,QAC/B,GAAG,kBAAkB,QAAQ,KAAK;AAAA,MACpC;AAAA,IACF,EACC,UAAU,EAAE,IAAI,kBAAkB,GAAG,CAAC;AAEzC,QAAI,OAAO,SAAS,GAAG;AACrB,aAAO,KAAK,2CAA2C;AAAA,QACrD;AAAA,QACA;AAAA,QACA,OAAO,OAAO;AAAA,MAChB,CAAC;AAAA,IACH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,sBAAuC;AAC3C,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAKrB,UAAM,aAAa,IAAI,KAAK,IAAI,QAAQ,IAAI,KAAK,KAAK,KAAK,GAAI;AAE/D,UAAM,UAAU,MAAMA,IACnB,OAAO,iBAAiB,EACxB;AAAA,MACC;AAAA,QACE,IAAI,kBAAkB,WAAW,UAAU;AAAA,QAC3C;AAAA,UACE,GAAG,kBAAkB,QAAQ,IAAI;AAAA,UACjC,IAAI,kBAAkB,QAAQ,UAAU;AAAA,QAC1C;AAAA,MACF;AAAA,IACF,EACC,UAAU,EAAE,IAAI,kBAAkB,GAAG,CAAC;AAEzC,WAAO,KAAK,wCAAwC;AAAA,MAClD,cAAc,QAAQ;AAAA,IACxB,CAAC;AAED,WAAO,QAAQ;AAAA,EACjB;AACF;AAEO,IAAM,0BAA0B,IAAI,wBAAwB;;;ACrPnE,IAAM,sBAAN,MAA0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASxB,MAAM,QACJ,IACA,QACA,SACA,UAKe;AACf,QAAI;AAEF,YAAM,WAAW,MAAM,KAAK,cAAc,IAAI,QAAQ;AAGtD,YAAM,UAAiC;AAAA,QACrC,YAAY,oBAAI,KAAK;AAAA,QACrB,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,UAAI,WAAW,SAAS;AACtB,YAAI,SAAS;AACX,kBAAQ,oBAAoB,SAAS,oBAAoB,KAAK;AAAA,QAChE,OAAO;AACL,kBAAQ,uBAAuB,SAAS,uBAAuB,KAAK;AAAA,QACtE;AAAA,MACF,WAAW,WAAW,cAAc;AAClC,gBAAQ,uBAAuB,SAAS,uBAAuB,KAAK;AAAA,MACtE,WAAW,WAAW,gBAAgB;AACpC,gBAAQ,gBAAgB,SAAS,gBAAgB,KAAK;AAAA,MACxD;AAGA,UAAI,UAAU,WAAW;AACvB,gBAAQ,YAAY,SAAS;AAAA,MAC/B;AACA,UAAI,UAAU,SAAS;AACrB,gBAAQ,UAAU,SAAS;AAAA,MAC7B;AAGA,YAAM,WAAW,MAAM,KAAK,eAAe,EAAE;AAC7C,cAAQ,kBAAkB;AAG1B,UAAI,WAAW,MAAM,CAAC,SAAS,WAAW;AACxC,gBAAQ,YAAY;AACpB,gBAAQ,YAAY,oBAAI,KAAK;AAC7B,gBAAQ,cAAc;AACtB,gBAAQ,eAAe;AAEvB,eAAO,KAAK,kDAAkD;AAAA,UAC5D;AAAA,UACA,iBAAiB;AAAA,UACjB,cAAc,QAAQ;AAAA,UACtB,qBAAqB,QAAQ;AAAA,UAC7B,cAAc,QAAQ;AAAA,QACxB,CAAC;AAAA,MACH;AAGA,YAAM,GACH,OAAO,YAAY,EACnB,IAAI,OAAO,EACX,MAAM,GAAG,aAAa,WAAW,EAAE,CAAC;AAAA,IACzC,SAAS,OAAO;AACd,aAAO,MAAM,sBAAsB;AAAA,QACjC;AAAA,QACA;AAAA,QACA;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AAAA,IAEH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,cAAc,IAA0C;AAC5D,QAAI;AACF,YAAM,UAAU,MAAM,GACnB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,WAAW,EAAE,CAAC,EACpC,MAAM,CAAC;AAEV,aAAO,QAAQ,CAAC,KAAK;AAAA,IACvB,SAAS,OAAO;AACd,aAAO,MAAM,+BAA+B;AAAA,QAC1C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,UAAU,IAA8B;AAC5C,QAAI;AACF,YAAM,SAAS,MAAM,KAAK,cAAc,EAAE;AAE1C,UAAI,CAAC,UAAU,CAAC,OAAO,WAAW;AAChC,eAAO;AAAA,MACT;AAGA,UAAI,OAAO,gBAAgB,OAAO,eAAe,oBAAI,KAAK,GAAG;AAE3D,cAAM,KAAK,UAAU,EAAE;AACvB,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,oCAAoC;AAAA,QAC/C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AAED,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAM,QAAQ,IAAY,QAAgB,UAAkC;AAC1E,QAAI;AAEF,YAAM,KAAK,cAAc,EAAE;AAE3B,YAAM,eAAe,WACjB,IAAI,KAAK,KAAK,IAAI,IAAI,WAAW,KAAK,KAAK,GAAI,IAC/C;AAEJ,YAAM,GACH,OAAO,YAAY,EACnB,IAAI;AAAA,QACH,WAAW;AAAA,QACX,aAAa;AAAA,QACb,WAAW,oBAAI,KAAK;AAAA,QACpB;AAAA,QACA,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,aAAa,WAAW,EAAE,CAAC;AAEvC,aAAO,KAAK,cAAc;AAAA,QACxB;AAAA,QACA;AAAA,QACA,UAAU,WAAW,GAAG,QAAQ,WAAW;AAAA,QAC3C,cAAc,cAAc,YAAY;AAAA,MAC1C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,aAAO,MAAM,sBAAsB;AAAA,QACjC;AAAA,QACA;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,MAAM,UAAU,IAA2B;AACzC,QAAI;AACF,YAAM,GACH,OAAO,YAAY,EACnB,IAAI;AAAA,QACH,WAAW;AAAA,QACX,aAAa;AAAA,QACb,WAAW;AAAA,QACX,cAAc;AAAA,QACd,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,aAAa,WAAW,EAAE,CAAC;AAEvC,aAAO,KAAK,gBAAgB,EAAE,GAAG,CAAC;AAAA,IACpC,SAAS,OAAO;AACd,aAAO,MAAM,wBAAwB;AAAA,QACnC;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAeA,MAAM,eAAe,IAA6B;AAChD,QAAI;AACF,YAAM,SAAS,MAAM,KAAK,cAAc,EAAE;AAE1C,UAAI,CAAC,QAAQ;AACX,eAAO;AAAA,MACT;AAEA,UAAI,QAAQ;AAGZ,gBAAU,OAAO,uBAAuB,KAAK;AAC7C,gBAAU,OAAO,uBAAuB,KAAK;AAC7C,gBAAU,OAAO,gBAAgB,KAAK;AAGtC,gBAAU,OAAO,oBAAoB,KAAK;AAG1C,aAAO,KAAK,IAAI,GAAG,KAAK,IAAI,KAAK,KAAK,CAAC;AAAA,IACzC,SAAS,OAAO;AACd,aAAO,MAAM,gCAAgC;AAAA,QAC3C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAWA,MAAM,uBAGH;AACD,QAAI;AACF,YAAM,MAAM,oBAAI,KAAK;AAGrB,YAAM,gBAAgB,MAAM,GACzB,OAAO,EACP,KAAK,YAAY,EACjB;AAAA,QACC;AAAA,UACE,GAAG,aAAa,WAAW,IAAI;AAAA,UAC/B,GAAG,aAAa,cAAc,GAAG;AAAA,QACnC;AAAA,MACF;AAEF,UAAI,iBAAiB;AACrB,iBAAW,UAAU,eAAe;AAClC,YAAI,OAAO,iBAAiB,MAAM;AAChC,gBAAM,KAAK,UAAU,OAAO,SAAS;AACrC;AAAA,QACF;AAAA,MACF;AAGA,YAAM,eAAe,MAAM,GACxB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,iBAAiB,GAAG,CAAC;AAE9C,UAAI,gBAAgB;AACpB,iBAAW,UAAU,cAAc;AACjC,cAAM,WAAW,KAAK,IAAI,MAAM,OAAO,mBAAmB,KAAK,EAAE;AACjE,cAAM,GACH,OAAO,YAAY,EACnB,IAAI;AAAA,UACH,iBAAiB;AAAA,UACjB,WAAW,oBAAI,KAAK;AAAA,QACtB,CAAC,EACA,MAAM,GAAG,aAAa,WAAW,OAAO,SAAS,CAAC;AACrD;AAAA,MACF;AAEA,aAAO,KAAK,mCAAmC;AAAA,QAC7C;AAAA,QACA;AAAA,QACA,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MACpC,CAAC;AAED,aAAO,EAAE,gBAAgB,cAAc;AAAA,IACzC,SAAS,OAAO;AACd,aAAO,MAAM,mCAAmC;AAAA,QAC9C,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,MAAM,gBAMH;AACD,QAAI;AACF,YAAM,SAAS,MAAM,GAAG,OAAO,EAAE,KAAK,YAAY;AAElD,YAAM,QAAQ;AAAA,QACZ,UAAU,OAAO;AAAA,QACjB,YAAY,OAAO,OAAO,CAAC,OAAO,GAAG,SAAS,EAAE;AAAA,QAChD,eAAe,OAAO;AAAA,UACpB,CAAC,OAAO,CAAC,GAAG,cAAc,GAAG,mBAAmB,KAAK;AAAA,QACvD,EAAE;AAAA,QACF,SAAS,OAAO,OAAO,CAAC,QAAQ,GAAG,mBAAmB,MAAM,EAAE,EAAE;AAAA,QAChE,cACE,OAAO,SAAS,IACZ,OAAO,OAAO,CAACC,MAAK,OAAOA,QAAO,GAAG,mBAAmB,IAAI,CAAC,IAC7D,OAAO,SACP;AAAA,MACR;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,0CAA0C;AAAA,QACrD,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,MAAM,SAMgB;AAC1B,QAAI;AACF,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ,cAAc,QAAW;AACnC,mBAAW,KAAK,GAAG,aAAa,WAAW,QAAQ,SAAS,CAAC;AAAA,MAC/D;AAEA,UAAI,QAAQ,aAAa,QAAW;AAClC,mBAAW,KAAK,IAAI,aAAa,iBAAiB,QAAQ,QAAQ,CAAC;AAAA,MACrE;AAEA,UAAI,QAAQ,aAAa,QAAW;AAClC,mBAAW,KAAK,IAAI,aAAa,iBAAiB,QAAQ,QAAQ,CAAC;AAAA,MACrE;AAEA,YAAM,YAAY,GAAG,OAAO,EAAE,KAAK,YAAY;AAE/C,YAAM,UAAU,WAAW,SAAS,IAChC,MAAM,UACH,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,MAAM,QAAQ,SAAS,EAAE,EACzB,OAAO,QAAQ,UAAU,CAAC,IAC7B,MAAM,UACH,MAAM,QAAQ,SAAS,EAAE,EACzB,OAAO,QAAQ,UAAU,CAAC;AAEjC,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,kCAAkC;AAAA,QAC7C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAc,cACZ,IACA,UAIuB;AACvB,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,cAAc,EAAE;AAE5C,UAAI,UAAU;AACZ,eAAO;AAAA,MACT;AAGA,YAAM,YAA6B;AAAA,QACjC,WAAW;AAAA,QACX,iBAAiB;AAAA,QACjB,qBAAqB;AAAA,QACrB,kBAAkB;AAAA,QAClB,qBAAqB;AAAA,QACrB,cAAc;AAAA,QACd,WAAW;AAAA,QACX,YAAY,oBAAI,KAAK;AAAA,QACrB,aAAa,oBAAI,KAAK;AAAA,QACtB,WAAW,UAAU,aAAa;AAAA,QAClC,SAAS,UAAU,WAAW;AAAA,QAC9B,WAAW,oBAAI,KAAK;AAAA,QACpB,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,YAAM,CAAC,OAAO,IAAI,MAAM,GAAG,OAAO,YAAY,EAAE,OAAO,SAAS,EAAE,UAAU;AAE5E,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,MAAM,uCAAuC;AAAA,MACzD;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,8BAA8B;AAAA,QACzC;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,YAAY,KAAsB;AAChC,UAAM,eAAe,IAAI,IAAI,iBAAiB;AAC9C,QAAI,cAAc;AAChB,YAAM,UAAU,aAAa,MAAM,GAAG,EAAE,CAAC;AACzC,aAAO,SAAS,KAAK,KAAK;AAAA,IAC5B;AACA,WAAO,IAAI,MAAM,IAAI,OAAO,iBAAiB;AAAA,EAC/C;AACF;AAEO,IAAM,sBAAsB,IAAI,oBAAoB;;;AC9epD,IAAM,cAAN,MAAkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASvB,MAAM,iBAAiB,WAAmB,YAAqC;AAC7E,UAAMC,MAAK,MAAM;AAEjB,QAAI;AAEF,YAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,WAAW,SAAS,CAAC;AAEvC,UAAI,CAAC,aAAa;AAChB,eAAO,MAAM,4BAA4B,EAAE,WAAW,WAAW,CAAC;AAClE,eAAO;AAAA,MACT;AAGA,UAAI,CAAC,YAAY,IAAI,MAAMA,IACxB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,YAAY,UAAU,CAAC;AAEzC,UAAI,CAAC,cAAc;AAEjB,SAAC,YAAY,IAAI,MAAMA,IACpB,OAAO,KAAK,EACZ,OAAO,EAAE,WAAW,CAAC,EACrB,UAAU;AAEb,YAAI,CAAC,cAAc;AACjB,gBAAM,IAAI,MAAM,gCAAgC;AAAA,QAClD;AAAA,MACF;AAGA,YAAM,eAAe,MAAMA,IACxB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,QAAQ,YAAY,EAAE,CAAC;AAE7C,UAAI,aAAa,WAAW,GAAG;AAE7B,cAAMA,IAAG,OAAO,KAAK,EAAE,MAAM,GAAG,MAAM,IAAI,YAAY,EAAE,CAAC;AACzD,eAAO;AAAA,MACT;AAEA,UAAI,cAAc;AAGlB,iBAAW,QAAQ,cAAc;AAE/B,cAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EACP,KAAK,SAAS,EACd;AAAA,UACC;AAAA,YACE,GAAG,UAAU,QAAQ,aAAa,EAAE;AAAA,YACpC,GAAG,UAAU,WAAW,KAAK,SAAS;AAAA,YACtC,KAAK,YACD,GAAG,UAAU,WAAW,KAAK,SAAS,IACtC,OAAO,UAAU,SAAS;AAAA,UAChC;AAAA,QACF;AAEF,YAAI,cAAc;AAEhB,gBAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,YACH,UAAU,aAAa,WAAW,KAAK;AAAA,YACvC,WAAW,oBAAI,KAAK;AAAA,UACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,aAAa,EAAE,CAAC;AAE1C,iBAAO,MAAM,+BAA+B;AAAA,YAC1C,WAAW,KAAK;AAAA,YAChB,WAAW,KAAK;AAAA,YAChB,aAAa,aAAa;AAAA,YAC1B,eAAe,KAAK;AAAA,YACpB,aAAa,aAAa,WAAW,KAAK;AAAA,UAC5C,CAAC;AAAA,QACH,OAAO;AAEL,gBAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,YACH,QAAQ,aAAa;AAAA,YACrB,WAAW,oBAAI,KAAK;AAAA,UACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,KAAK,EAAE,CAAC;AAElC,iBAAO,MAAM,qCAAqC;AAAA,YAChD,YAAY,KAAK;AAAA,YACjB,WAAW,KAAK;AAAA,UAClB,CAAC;AAAA,QACH;AAEA;AAAA,MACF;AAGA,YAAMA,IAAG,OAAO,KAAK,EAAE,MAAM,GAAG,MAAM,IAAI,YAAY,EAAE,CAAC;AAEzD,aAAO,KAAK,wBAAwB;AAAA,QAClC;AAAA,QACA;AAAA,QACA,aAAa;AAAA,MACf,CAAC;AAED,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,qBAAqB,OAAO;AAAA,QACvC;AAAA,QACA;AAAA,MACF,CAAC;AAED,aAAO;AAAA,IACT;AAAA,EACF;AACF;AAGO,IAAM,cAAc,IAAI,YAAY;;;ACzI3C,wBAAwC;AA2BxC,IAAM,gBAAN,MAAoB;AAAA,EACV,cAAkC;AAAA,EAClC;AAAA,EACA;AAAA,EACA,eAAwB;AAAA,EAEhC,cAAc;AAGZ,SAAK,YAAY,QAAQ,IAAI,iBAAiB,KAAK,QAAQ,IAAI,WAAW,KAAK;AAC/E,SAAK,WAAW,QAAQ,IAAI,gBAAgB,KAAK;AACjD,SAAK,WAAW;AAAA,EAClB;AAAA,EAEQ,aAAa;AACnB,UAAM,OAAO,QAAQ,IAAI,WAAW;AACpC,UAAM,OAAO,SAAS,QAAQ,IAAI,WAAW,KAAK,OAAO,EAAE;AAC3D,UAAM,OAAO,QAAQ,IAAI,WAAW;AACpC,UAAM,OAAO,QAAQ,IAAI,WAAW;AAEpC,QAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM;AAC3B,aAAO,KAAK,4DAA4D;AACxE,WAAK,eAAe;AACpB;AAAA,IACF;AAEA,UAAMC,UAAqB;AAAA,MACzB;AAAA,MACA;AAAA,MACA,QAAQ,SAAS;AAAA,MACjB,MAAM,EAAE,MAAM,KAAK;AAAA,IACrB;AAEA,SAAK,cAAc,kBAAAC,QAAW,gBAAgBD,OAAM;AACpD,SAAK,eAAe;AACpB,WAAO,KAAK,2BAA2B,EAAE,MAAM,KAAK,CAAC;AAAA,EACvD;AAAA,EAEA,MAAM,UAAU,SAAyC;AACvD,QAAI,CAAC,KAAK,gBAAgB,CAAC,KAAK,aAAa;AAC3C,aAAO,KAAK,wCAAwC,EAAE,IAAI,QAAQ,IAAI,SAAS,QAAQ,QAAQ,CAAC;AAChG,aAAO;AAAA,IACT;AAEA,QAAI;AACF,YAAM,cAA0C;AAAA,QAC9C,MAAM,IAAI,KAAK,QAAQ,MAAM,KAAK,SAAS;AAAA,QAC3C,IAAI,MAAM,QAAQ,QAAQ,EAAE,IAAI,QAAQ,GAAG,KAAK,IAAI,IAAI,QAAQ;AAAA,QAChE,SAAS,QAAQ;AAAA,QACjB,MAAM,QAAQ;AAAA,QACd,MAAM,QAAQ,QAAQ,KAAK,UAAU,QAAQ,IAAI;AAAA,MACnD;AAGA,UAAI,QAAQ,eAAe,QAAQ,YAAY,SAAS,GAAG;AACzD,oBAAY,cAAc,QAAQ,YAAY,IAAI,UAAQ;AAAA,UACxD,UAAU,IAAI;AAAA,UACd,SAAS,IAAI;AAAA,UACb,aAAa,IAAI,eAAe;AAAA,QAClC,EAAE;AAAA,MACJ;AAEA,YAAM,OAAO,MAAM,KAAK,YAAY,SAAS,WAAW;AAExD,aAAO,KAAK,2BAA2B,EAAE,WAAW,KAAK,WAAW,IAAI,QAAQ,GAAG,CAAC;AACpF,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,wBAAwB,EAAE,OAAO,IAAI,QAAQ,IAAI,SAAS,QAAQ,QAAQ,CAAC;AACxF,aAAO;AAAA,IACT;AAAA,EACF;AAAA,EAEQ,UAAU,MAAsB;AACtC,WAAO,KAAK,QAAQ,YAAY,EAAE,EAAE,QAAQ,QAAQ,GAAG,EAAE,KAAK;AAAA,EAChE;AAAA;AAAA,EAGA,MAAM,mBAAqC;AACzC,QAAI,CAAC,KAAK,gBAAgB,CAAC,KAAK,aAAa;AAC3C,aAAO;AAAA,IACT;AAEA,QAAI;AACF,YAAM,KAAK,YAAY,OAAO;AAC9B,aAAO,KAAK,0BAA0B;AACtC,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,uCAAuC,EAAE,MAAM,CAAC;AAC7D,aAAO;AAAA,IACT;AAAA,EACF;AAAA,EAEA,UAAmB;AACjB,WAAO,KAAK;AAAA,EACd;AACF;AAEO,IAAM,gBAAgB,IAAI,cAAc;;;AClG/C,IAAM,kBAAwC;AAAA,EAC5C,SAAS;AAAA,EACT,aAAa,CAAC,QAAQ,IAAI,aAAa,KAAK,6BAA6B;AAAA,EACzE,eAAe;AAAA,IACb,WAAW;AAAA,IACX,qBAAqB;AAAA,IACrB,iBAAiB;AAAA,IACjB,cAAc;AAAA,IACd,qBAAqB;AAAA,IACrB,mBAAmB;AAAA,IACnB,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,EACpB;AACF;AAGA,SAAS,QAAQ,MAAwB,KAAqB;AAC5D,QAAM,QAAQ,KAAK,GAAG;AACtB,SAAO,UAAU,SAAY,OAAO,KAAK,IAAI;AAC/C;AAeA,IAAM,sBAAN,MAA0B;AAAA,EAChB,WAAiC;AAAA,EAEzC,eAAe,aAA4C;AACzD,SAAK,WAAW,EAAE,GAAG,KAAK,UAAU,GAAG,YAAY;AACnD,WAAO,KAAK,iCAAiC,EAAE,UAAU,KAAK,SAAS,CAAC;AAAA,EAC1E;AAAA,EAEA,cAAoC;AAClC,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,MAAM,OAAO,MAAwB,MAA0C;AAC7E,QAAI,CAAC,KAAK,SAAS,WAAW,CAAC,KAAK,SAAS,cAAc,IAAI,GAAG;AAChE,aAAO,MAAM,mCAAmC,EAAE,KAAK,CAAC;AACxD,aAAO;AAAA,IACT;AAEA,UAAM,WAAW,KAAK,YAAY,MAAM,IAAI;AAC5C,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,2CAA2C,EAAE,KAAK,CAAC;AAC/D,aAAO;AAAA,IACT;AAEA,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI,KAAK,SAAS;AAAA,MAClB,SAAS,SAAS;AAAA,MAClB,MAAM,SAAS;AAAA,IACjB,CAAC;AAAA,EACH;AAAA,EAEQ,cAAsB;AAC5B,WAAO,QAAQ,IAAI,WAAW,KAAK;AAAA,EACrC;AAAA,EAEQ,YAAY,MAAwB,MAAkE;AAC5G,UAAM,WAAW,KAAK,YAAY;AAElC,UAAM,YAA+E;AAAA,MACnF,WAAW,OAAO;AAAA,QAChB,SAAS,cAAc,QAAQ,MAAM,SAAS,CAAC;AAAA,QAC/C,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAMoC,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIzB,QAAQ,MAAM,cAAc,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI7B,QAAQ,MAAM,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA,oEAI7B,QAAQ,MAAM,OAAO,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIvB,QAAQ,MAAM,WAAW,CAAC;AAAA;AAAA;AAAA,wBAGrE,QAAQ,WAAW,QAAQ,MAAM,SAAS,CAAC;AAAA,SAC1D;AAAA,MACH;AAAA,MAEA,qBAAqB,OAAO;AAAA,QAC1B,SAAS,UAAU,QAAQ,MAAM,SAAS,CAAC,sBAAsB,QAAQ,MAAM,WAAW,CAAC;AAAA,QAC3F,MAAM,KAAK,aAAa;AAAA;AAAA,sBAEV,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA,oEAIsB,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIzB,QAAQ,MAAM,gBAAgB,CAAC;AAAA;AAAA;AAAA;AAAA,mGAIC,QAAQ,MAAM,WAAW,CAAC;AAAA;AAAA;AAAA,wBAGrG,QAAQ,WAAW,QAAQ,MAAM,SAAS,CAAC;AAAA,SAC1D;AAAA,MACH;AAAA,MAEA,iBAAiB,OAAO;AAAA,QACtB,SAAS,oBAAoB,QAAQ,MAAM,aAAa,CAAC;AAAA,QACzD,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mEAMmC,QAAQ,MAAM,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI5B,QAAQ,MAAM,KAAK,CAAC;AAAA;AAAA;AAAA;AAAA,2FAII,QAAQ,MAAM,cAAc,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIrD,QAAQ,MAAM,WAAW,CAAC;AAAA;AAAA;AAAA,wBAGrE,QAAQ,aAAa,QAAQ,MAAM,WAAW,CAAC;AAAA,SAC9D;AAAA,MACH;AAAA,MAEA,cAAc,OAAO;AAAA,QACnB,SAAS,+BAA+B,QAAQ,MAAM,cAAc,CAAC;AAAA,QACrE,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mEAMmC,QAAQ,MAAM,cAAc,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI7B,QAAQ,MAAM,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA,oEAI9B,oBAAI,KAAK,GAAE,eAAe,CAAC;AAAA;AAAA;AAAA,wBAGtE,QAAQ,cAAc,QAAQ,MAAM,YAAY,CAAC;AAAA,SAChE;AAAA,MACH;AAAA,MAEA,qBAAqB,OAAO;AAAA,QAC1B,SAAS,4BAA4B,QAAQ,MAAM,MAAM,CAAC;AAAA,QAC1D,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mEAMmC,QAAQ,MAAM,MAAM,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIrB,QAAQ,MAAM,OAAO,CAAC;AAAA;AAAA;AAAA;AAAA,mEAItB,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,2CAKhD,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA,SAE1D;AAAA,MACH;AAAA,MAEA,mBAAmB,OAAO;AAAA,QACxB,SAAS,0BAA0B,QAAQ,MAAM,aAAa,CAAC;AAAA,QAC/D,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAMoC,QAAQ,MAAM,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI7B,QAAQ,MAAM,cAAc,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI7B,QAAQ,MAAM,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI9B,QAAQ,MAAM,WAAW,CAAC;AAAA;AAAA;AAAA,wBAGrE,QAAQ,eAAe,QAAQ,MAAM,aAAa,CAAC;AAAA,SAClE;AAAA,MACH;AAAA,MAEA,kBAAkB,OAAO;AAAA,QACvB,SAAS,+BAA+B,QAAQ,MAAM,SAAS,CAAC;AAAA,QAChE,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAMoC,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA,4FAIA,QAAQ,MAAM,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIhD,QAAQ,MAAM,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA,mEAI9B,QAAQ,MAAM,eAAe,CAAC;AAAA;AAAA;AAAA,wBAGzE,QAAQ,WAAW,QAAQ,MAAM,SAAS,CAAC;AAAA,SAC1D;AAAA,MACH;AAAA,MAEA,kBAAkB,OAAO;AAAA,QACvB,SAAS,+BAA+B,QAAQ,MAAM,SAAS,CAAC;AAAA,QAChE,MAAM,KAAK,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEAMoC,QAAQ,MAAM,SAAS,CAAC;AAAA;AAAA;AAAA;AAAA,4FAIA,QAAQ,MAAM,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,mEAIhD,QAAQ,MAAM,QAAQ,CAAC;AAAA;AAAA;AAAA,wBAGlE,QAAQ,WAAW,QAAQ,MAAM,SAAS,CAAC;AAAA,SAC1D;AAAA,MACH;AAAA,IACF;AAEA,UAAM,aAAa,UAAU,IAAI;AACjC,WAAO,aAAa,WAAW,IAAI;AAAA,EACrC;AAAA,EAEQ,aAAa,SAAyB;AAC5C,WAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAaG,OAAO;AAAA;AAAA;AAAA;AAAA,yBAIG,oBAAI,KAAK,GAAE,YAAY,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,EAK9C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,wBACJ,MACA,WACkB;AAClB,UAAM,iBAAiB,CAAC,QAAgB,aAAqB;AAC3D,aAAO,IAAI,KAAK,aAAa,SAAS;AAAA,QACpC,OAAO;AAAA,QACP,UAAU,YAAY;AAAA,MACxB,CAAC,EAAE,OAAO,MAAM;AAAA,IAClB;AAEA,UAAM,aAAa,CAACE,UAAsB;AACxC,UAAI,CAACA,OAAM;AAAC,eAAO;AAAA,MAAgB;AACnC,aAAO,IAAI,KAAKA,KAAI,EAAE,mBAAmB,SAAS;AAAA,QAChD,MAAM;AAAA,QACN,OAAO;AAAA,QACP,KAAK;AAAA,MACP,CAAC;AAAA,IACH;AAEA,UAAM,OAAO,KAAK,qBAAqB;AAAA,sBACrB,KAAK,eAAe;AAAA,gBAC1B,KAAK,YAAY;AAAA,iFACgD,KAAK,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,+DAKlC,KAAK,eAAe;AAAA;AAAA;AAAA;AAAA,+DAIpB,KAAK,SAAS;AAAA;AAAA;AAAA;AAAA,+FAIkB,eAAe,KAAK,OAAO,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,+DAIzE,WAAW,KAAK,UAAU,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAQhF,KAAK,eAAe,sDAAsD,KAAK,YAAY,KAAK,KAAK,YAAY,cAAc,EAAE;AAAA,UACjI,KAAK,eAAe,sCAAsC,KAAK,YAAY,UAAU,EAAE;AAAA;AAAA;AAAA;AAAA,6BAIpE,KAAK,WAAW;AAAA,OACtC,KAAK,WAAW;AAEnB,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI,KAAK;AAAA,MACT,SAAS,aAAa,KAAK,eAAe,SAAS,KAAK,WAAW;AAAA,MACnE;AAAA,MACA,aAAa;AAAA,QACX;AAAA,UACE,UAAU,GAAG,KAAK,eAAe;AAAA,UACjC,SAAS;AAAA,UACT,aAAa;AAAA,QACf;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEQ,qBAAqB,SAAiB,aAA6B;AACzE,WAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oEASyD,WAAW;AAAA;AAAA;AAAA,cAGjE,OAAO;AAAA;AAAA;AAAA,yBAGG,oBAAI,KAAK,GAAE,YAAY,CAAC,IAAI,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,EAK7D;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,qBAAqB,MAKN;AACnB,UAAM,EAAE,OAAO,MAAM,MAAM,cAAc,IAAI;AAC7C,UAAM,cAAc,QAAQ,IAAI,cAAc,KAAK;AAGnD,UAAM,WAAW;AAAA,MACf,gBAAgB;AAAA,MAChB,oBAAoB;AAAA,MACpB,gBAAgB;AAAA,IAClB;AACA,UAAM,UAAU,SAAS,IAAI;AAG7B,UAAM,SAAS;AAAA,MACb,gBAAgB;AAAA,MAChB,oBAAoB;AAAA,MACpB,gBAAgB;AAAA,IAClB;AACA,UAAM,QAAQ,OAAO,IAAI;AAEzB,UAAM,OAAO,KAAK,qBAAqB;AAAA,yDACc,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAShD,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gDAMoB,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAM5C,WAAW;AAEd,WAAO,KAAK,mCAAmC,EAAE,OAAO,KAAK,CAAC;AAE9D,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI;AAAA,MACJ;AAAA,MACA;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,gCAAgC,MAKjB;AACnB,UAAM,EAAE,OAAO,WAAW,WAAAC,YAAW,UAAU,IAAI;AACnD,UAAM,cAAc,QAAQ,IAAI,cAAc,KAAK;AAGnD,UAAM,qBAAqBA,WAAU,eAAe,SAAS;AAAA,MAC3D,OAAO;AAAA,MACP,KAAK;AAAA,MACL,MAAM;AAAA,MACN,MAAM;AAAA,MACN,QAAQ;AAAA,MACR,cAAc;AAAA,IAChB,CAAC;AAED,UAAM,WAAW,YAAY,SAAS,SAAS,MAAM;AAErD,UAAM,OAAO,KAAK,qBAAqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAYjC,QAAQ;AAAA;AAAA;AAAA;AAAA,4DAI0C,kBAAkB;AAAA;AAAA;AAAA,QAGtE,YAAY;AAAA;AAAA;AAAA;AAAA,+IAI2H,SAAS;AAAA;AAAA;AAAA,UAG9I,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAqBL,WAAW;AAEd,WAAO,KAAK,+CAA+C,EAAE,MAAM,CAAC;AAEpE,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI;AAAA,MACJ,SAAS,+BAA+B,WAAW;AAAA,MACnD;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,sBAAsB,MAKP;AACnB,UAAM,EAAE,OAAO,WAAW,MAAM,cAAc,IAAI;AAClD,UAAM,cAAc,QAAQ,IAAI,cAAc,KAAK;AAEnD,UAAM,WAAW,YAAY,SAAS,SAAS,MAAM;AAErD,UAAM,OAAO,KAAK,qBAAqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAQtB,WAAW;AAAA;AAAA;AAAA;AAAA,UAItB,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAYN,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA,2CAK2B,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAajD,WAAW;AAEd,WAAO,KAAK,mCAAmC,EAAE,MAAM,CAAC;AAExD,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI;AAAA,MACJ,SAAS,+BAA+B,WAAW;AAAA,MACnD;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,4BACJ,eACA,cACA,iBACA,iBACA,YACA,iBACkB;AAClB,UAAM,cAAc,QAAQ,IAAI,cAAc,KAAK;AACnD,UAAM,aAAa,QAAQ,IAAI,aAAa,KAAK;AAEjD,UAAM,aAAa,CAACD,UAAe;AACjC,aAAO,IAAI,KAAKA,KAAI,EAAE,mBAAmB,SAAS;AAAA,QAChD,MAAM;AAAA,QACN,OAAO;AAAA,QACP,KAAK;AAAA,MACP,CAAC;AAAA,IACH;AAEA,UAAM,eAAe,mBAAmB,IAAI,YAAY,mBAAmB,IAAI,YAAY;AAC3F,UAAM,cAAc,mBAAmB,IAAI,sBAAsB,cAAc,eAAe;AAE9F,UAAM,WAAW,kBACb,GAAG,UAAU,oBAAoB,eAAe,KAChD;AAEJ,UAAM,OAAO,KAAK,qBAAqB;AAAA;AAAA,mCAER,YAAY;AAAA,YACnC,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,gBAKP,YAAY;AAAA,mEACuC,eAAe,kDAAkD,YAAY,MAAM,WAAW,UAAU,CAAC;AAAA;AAAA,gEAE5G,YAAY;AAAA;AAAA;AAAA;AAAA,QAIpE,WAAW;AAAA;AAAA,qBAEE,QAAQ;AAAA;AAAA;AAAA;AAAA,UAInB,EAAE;AAAA;AAAA;AAAA;AAAA,6BAIiB,WAAW;AAAA,OACjC,WAAW;AAEd,WAAO,cAAc,UAAU;AAAA,MAC7B,IAAI;AAAA,MACJ,SAAS,GAAG,WAAW,eAAe,eAAe,MAAM,WAAW;AAAA,MACtE;AAAA,IACF,CAAC;AAAA,EACH;AACF;AAEO,IAAM,sBAAsB,IAAI,oBAAoB;;;ACrsB3D,IAAAE,mBAAmB;AACnB,oBAAmB;;;ACDnB,IAAAC,iBAAmB;AAkBZ,IAAM,cAAN,MAAkB;AAAA,EACvB,OAAwB,eAAe;AAAA,EACvC,OAAwB,sBAAsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAU9C,aAAa,cACX,UACA,YAC4B;AAE5B,UAAM,OAAO,eAAAC,QAAO,WAAW,MAAM,EAAE,OAAO,QAAQ,EAAE,OAAO,KAAK,EAAE,YAAY;AAClF,UAAM,aAAa,KAAK,UAAU,GAAG,CAAC;AACtC,UAAM,aAAa,KAAK,UAAU,CAAC;AAGnC,QAAI,YAAY;AACd,YAAM,eAAe,MAAM,KAAK,gBAAgB,YAAY,UAAU;AACtE,UAAI,cAAc;AAChB,eAAO;AAAA,MACT;AAAA,IACF;AAGA,QAAI;AACF,YAAM,WAAW,MAAM,MAAM,GAAG,KAAK,YAAY,IAAI,UAAU,IAAI;AAAA,QACjE,SAAS;AAAA,UACP,cAAc;AAAA,QAChB;AAAA,MACF,CAAC;AAED,UAAI,CAAC,SAAS,IAAI;AAEhB,gBAAQ,KAAK,qBAAqB,SAAS,MAAM,gCAAgC;AACjF,eAAO,EAAE,YAAY,OAAO,aAAa,GAAG,QAAQ,MAAM;AAAA,MAC5D;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,YAAM,QAAQ,KAAK,MAAM,IAAI;AAG7B,UAAI,cAAc;AAClB,iBAAWC,SAAQ,OAAO;AACxB,cAAM,QAAQA,MAAK,MAAM,GAAG;AAC5B,cAAM,SAAS,MAAM,CAAC;AACtB,cAAMC,SAAQ,MAAM,CAAC;AACrB,YAAI,UAAU,OAAO,KAAK,MAAM,YAAY;AAC1C,wBAAc,SAASA,QAAO,KAAK,KAAK,KAAK,EAAE;AAC/C;AAAA,QACF;AAAA,MACF;AAEA,YAAM,SAA4B;AAAA,QAChC,YAAY,cAAc;AAAA,QAC1B;AAAA,QACA,QAAQ;AAAA,MACV;AAGA,UAAI,YAAY;AACd,cAAM,KAAK,gBAAgB,YAAY,YAAY,MAAM;AAAA,MAC3D;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AAEd,cAAQ,MAAM,0BAA0B,KAAK;AAC7C,aAAO,EAAE,YAAY,OAAO,aAAa,GAAG,QAAQ,MAAM;AAAA,IAC5D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAqB,gBACnB,YACA,YACmC;AACnC,QAAI;AACF,YAAMC,MAAK,MAAM;AAEjB,YAAM,SAAS,MAAMA,IAClB,OAAO,EACP,KAAK,YAAY,EACjB;AAAA,QACC;AAAA,UACE,GAAG,aAAa,YAAY,UAAU;AAAA,UACtC,GAAG,aAAa,oBAAoB,UAAU;AAAA,QAChD;AAAA,MACF,EACC,MAAM,CAAC;AAEV,YAAM,QAAQ,OAAO,CAAC;AACtB,UAAI,CAAC,OAAO;AACV,eAAO;AAAA,MACT;AAGA,UAAI,oBAAI,KAAK,IAAI,MAAM,WAAW;AAChC,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,QACL,YAAY,MAAM;AAAA,QAClB,aAAa,MAAM;AAAA,QACnB,QAAQ;AAAA,MACV;AAAA,IACF,SAAS,OAAO;AAEd,cAAQ,KAAK,6CAA6C,KAAK;AAC/D,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAqB,gBACnB,YACA,YACA,QACe;AACf,QAAI;AACF,YAAMA,MAAK,MAAM;AAEjB,YAAM,YAAY,oBAAI,KAAK;AAC3B,gBAAU,QAAQ,UAAU,QAAQ,IAAI,KAAK,mBAAmB;AAEhE,YAAMA,IAAG,OAAO,YAAY,EAAE,OAAO;AAAA,QACnC;AAAA,QACA,oBAAoB;AAAA,QACpB,YAAY,OAAO;AAAA,QACnB,aAAa,OAAO;AAAA,QACpB;AAAA,QACA,aAAa;AAAA,MACf,CAAC;AAAA,IACH,SAAS,OAAO;AAEd,cAAQ,KAAK,gCAAgC,KAAK;AAAA,IACpD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,aAAa,sBAAuC;AAClD,UAAMA,MAAK,MAAM;AAEjB,QAAI;AACF,YAAM,SAAS,MAAMA,IAClB,OAAO,YAAY,EACnB,MAAM,GAAG,aAAa,WAAW,oBAAI,KAAK,CAAC,CAAC;AAE/C,aAAO,OAAO,YAAY;AAAA,IAC5B,SAAS,OAAO;AACd,cAAQ,MAAM,4CAA4C,KAAK;AAC/D,aAAO;AAAA,IACT;AAAA,EACF;AACF;;;ADlKO,IAAM,0BAAN,MAA8B;AAAA,EACnC,OAAwB,gBAAgB;AAAA;AAAA,EACxC,OAAwB,qBAAqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAS7C,aAAa,kBACX,UACA,YACkF;AAClF,UAAM,aAAS,cAAAC,SAAO,UAAU,UAAU;AAE1C,WAAO;AAAA,MACL,OAAO,OAAO;AAAA,MACd,UAAU;AAAA,QACR,SAAS,OAAO,SAAS,WAAW;AAAA,QACpC,aAAa,OAAO,SAAS,eAAe,CAAC;AAAA,MAC/C;AAAA,MACA,WAAW,OAAO,OAAO,oBAAoB,mCAAmC;AAAA,IAClF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAa,qBACX,YACA,UACkB;AAClB,QAAI;AACF,YAAMC,MAAK,MAAM;AAGjB,YAAM,UAAU,MAAMA,IACnB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,YAAY,UAAU,CAAC,EAChD,QAAQ,KAAK,gBAAgB,SAAS,CAAC,EACvC,MAAM,KAAK,aAAa;AAG3B,iBAAW,SAAS,SAAS;AAC3B,cAAM,UAAU,MAAM,iBAAAC,QAAO,QAAQ,UAAU,MAAM,YAAY;AACjE,YAAI,SAAS;AACX,iBAAO;AAAA,QACT;AAAA,MACF;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AAEd,cAAQ,KAAK,2DAA2D,KAAK;AAC7E,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,aAAa,qBAAqB,MAAyC;AACzE,QAAI;AACF,YAAMD,MAAK,MAAM;AAEjB,YAAMA,IAAG,OAAO,eAAe,EAAE,OAAO,IAAI;AAG5C,YAAM,aAAa,MAAMA,IACtB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,YAAY,KAAK,UAAU,CAAC,EACrD,QAAQ,KAAK,gBAAgB,SAAS,CAAC;AAE1C,UAAI,WAAW,SAAS,KAAK,eAAe;AAC1C,cAAM,cAAc,WACjB,MAAM,KAAK,aAAa,EACxB,IAAI,CAAC,UAAU,MAAM,EAAE;AAE1B,YAAI,YAAY,SAAS,KAAK,YAAY,CAAC,GAAG;AAC5C,gBAAMA,IACH,OAAO,eAAe,EACtB,MAAM,GAAG,gBAAgB,IAAI,YAAY,CAAC,CAAC,CAAC;AAAA,QACjD;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AAGd,cAAQ,KAAK,2DAA2D,KAAK;AAAA,IAE/E;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,aAAa,iBACX,UACA,YACA,YACmC;AACnC,UAAM,SAAmB,CAAC;AAG1B,QAAI,SAAS,SAAS,GAAG;AACvB,aAAO,KAAK,iFAA4E,SAAS,MAAM;AAAA,IACzG;AAEA,QAAI,SAAS,SAAS,KAAK;AACzB,aAAO,KAAK,6EAAwE,SAAS,MAAM;AAAA,IACrG;AAGA,UAAM,WAAW,MAAM,KAAK,kBAAkB,UAAU,UAAU;AAElE,QAAI,SAAS,QAAQ,KAAK,oBAAoB;AAC5C,YAAM,cAAc,SAAS,SAAS,WAAW;AACjD,aAAO;AAAA,QACL,2DAAoD,SAAS,KAAK,QAAQ,WAAW;AAAA,MACvF;AACA,UAAI,SAAS,SAAS,YAAY,SAAS,GAAG;AAC5C,eAAO,KAAK,0BAAmB,SAAS,SAAS,YAAY,KAAK,GAAG,CAAC,EAAE;AAAA,MAC1E;AAAA,IACF;AAGA,UAAM,eAAe,MAAM,YAAY,cAAc,UAAU,UAAU;AAEzE,QAAI,aAAa,YAAY;AAC3B,YAAM,aAAa,aAAa,cAAc,MAC1C,IAAI,aAAa,cAAc,KAAM,QAAQ,CAAC,CAAC,OAC/C,aAAa,YAAY,SAAS;AAEtC,aAAO;AAAA,QACL,kEAAwD,UAAU;AAAA,MACpE;AAAA,IACF;AAGA,UAAM,WAAW,MAAM,KAAK,qBAAqB,YAAY,QAAQ;AAErE,QAAI,UAAU;AACZ,aAAO,KAAK,4IAAuI;AAAA,IACrJ;AAGA,UAAM,iBAAyC;AAAA,MAC7C,GAAG;AAAA,MACH,YAAY,aAAa;AAAA,MACzB,aAAa,aAAa;AAAA,MAC1B;AAAA,IACF;AAEA,WAAO;AAAA,MACL,SAAS,OAAO,WAAW;AAAA,MAC3B;AAAA,MACA;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAa,oBACX,UACA,YACmC;AACnC,UAAM,SAAmB,CAAC;AAG1B,QAAI,SAAS,SAAS,GAAG;AACvB,aAAO,KAAK,iFAA4E,SAAS,MAAM;AAAA,IACzG;AAEA,QAAI,SAAS,SAAS,KAAK;AACzB,aAAO,KAAK,6EAAwE,SAAS,MAAM;AAAA,IACrG;AAGA,UAAM,WAAW,MAAM,KAAK,kBAAkB,UAAU,UAAU;AAElE,QAAI,SAAS,QAAQ,KAAK,oBAAoB;AAC5C,YAAM,cAAc,SAAS,SAAS,WAAW;AACjD,aAAO;AAAA,QACL,2DAAoD,SAAS,KAAK,QAAQ,WAAW;AAAA,MACvF;AACA,UAAI,SAAS,SAAS,YAAY,SAAS,GAAG;AAC5C,eAAO,KAAK,0BAAmB,SAAS,SAAS,YAAY,KAAK,GAAG,CAAC,EAAE;AAAA,MAC1E;AAAA,IACF;AAGA,UAAM,eAAe,MAAM,YAAY,cAAc,QAAQ;AAE7D,QAAI,aAAa,YAAY;AAC3B,YAAM,aAAa,aAAa,cAAc,MAC1C,IAAI,aAAa,cAAc,KAAM,QAAQ,CAAC,CAAC,OAC/C,aAAa,YAAY,SAAS;AAEtC,aAAO;AAAA,QACL,kEAAwD,UAAU;AAAA,MACpE;AAAA,IACF;AAEA,UAAM,iBAAyC;AAAA,MAC7C,GAAG;AAAA,MACH,YAAY,aAAa;AAAA,MACzB,aAAa,aAAa;AAAA,MAC1B,UAAU;AAAA,IACZ;AAEA,WAAO;AAAA,MACL,SAAS,OAAO,WAAW;AAAA,MAC3B;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;;;AEnPA,IAAM,kBAAN,MAAsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOpB,MAAM,IAAI,OAAqC;AAC7C,QAAI;AACF,YAAME,MAAK,MAAM;AACjB,YAAM,WAAgC;AAAA,QACpC,WAAW,oBAAI,KAAK;AAAA,QACpB,WAAW,MAAM;AAAA,QACjB,WAAW,MAAM;AAAA,QACjB,SAAS,MAAM,WAAW;AAAA,QAC1B,YAAY,MAAM,cAAc;AAAA,QAChC,YAAY,MAAM,cAAc;AAAA,QAChC,UAAU,MAAM,YAAY;AAAA,QAC5B,QAAQ,MAAM;AAAA,QACd,QAAQ,MAAM;AAAA,QACd,WAAW,MAAM,aAAa;AAAA,QAC9B,WAAW,MAAM,aAAa;AAAA,QAC9B,WAAW,MAAM,aAAa;AAAA,QAC9B,WAAW,MAAM,aAAa;AAAA,QAC9B,UAAU,MAAM,YAAY;AAAA,QAC5B,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,YAAMA,IAAG,OAAO,iBAAiB,EAAE,OAAO,QAAQ;AAAA,IACpD,SAAS,OAAO;AAEd,aAAO,MAAM,6BAA6B;AAAA,QACxC;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AAAA,IACH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,MAAM,eACJ,KACA,OACe;AACf,UAAM,YAA2B;AAAA,MAC/B,GAAG;AAAA,MACH,WAAW,KAAK,YAAY,GAAG;AAAA,MAC/B,WAAW,IAAI,IAAI,YAAY,KAAK;AAAA,MACpC,WAAY,IAAY,MAAM,aAAa;AAAA,MAC3C,WAAY,IAAY,MAAM;AAAA,IAChC;AAEA,UAAM,KAAK,IAAI,SAAS;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,MAAM,SAUoB;AAC9B,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ,SAAS;AACnB,mBAAW,KAAK,GAAG,kBAAkB,SAAS,QAAQ,OAAO,CAAC;AAAA,MAChE;AAEA,UAAI,QAAQ,cAAc,QAAQ,WAAW,SAAS,GAAG;AACvD,mBAAW,KAAK,QAAQ,kBAAkB,WAAW,QAAQ,UAAU,CAAC;AAAA,MAC1E;AAEA,UAAI,QAAQ,QAAQ;AAClB,mBAAW,KAAK,GAAG,kBAAkB,QAAQ,QAAQ,MAAM,CAAC;AAAA,MAC9D;AAEA,UAAI,QAAQ,WAAW;AACrB,mBAAW,KAAK,GAAG,kBAAkB,WAAW,QAAQ,SAAS,CAAC;AAAA,MACpE;AAEA,UAAI,QAAQ,WAAW;AACrB,mBAAW,KAAK,GAAG,kBAAkB,WAAW,QAAQ,SAAS,CAAC;AAAA,MACpE;AAEA,UAAI,QAAQ,WAAW;AACrB,mBAAW,KAAK,IAAI,kBAAkB,WAAW,QAAQ,SAAS,CAAC;AAAA,MACrE;AAEA,UAAI,QAAQ,SAAS;AACnB,mBAAW,KAAK,IAAI,kBAAkB,WAAW,QAAQ,OAAO,CAAC;AAAA,MACnE;AAEA,YAAM,YAAYA,IACf,OAAO,EACP,KAAK,iBAAiB;AAEzB,YAAM,UAAU,WAAW,SAAS,IAChC,MAAM,UACH,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,QAAQ,SAAS,EAAE,EACzB,OAAO,QAAQ,UAAU,CAAC,IAC7B,MAAM,UACH,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,QAAQ,SAAS,EAAE,EACzB,OAAO,QAAQ,UAAU,CAAC;AAEjC,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,8BAA8B;AAAA,QACzC;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,QAAQ,IAA8C;AAC1D,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,UAAU,MAAMA,IACnB,OAAO,EACP,KAAK,iBAAiB,EACtB,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC,EAClC,MAAM,CAAC;AAEV,aAAO,QAAQ,CAAC,KAAK;AAAA,IACvB,SAAS,OAAO;AACd,aAAO,MAAM,iCAAiC;AAAA,QAC5C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,aAAa,SAA4D;AAC7E,UAAM,OAAO,MAAM,KAAK,MAAM,EAAE,GAAG,SAAS,OAAO,IAAM,CAAC;AAC1D,WAAO,KAAK,UAAU,MAAM,MAAM,CAAC;AAAA,EACrC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,YAAY,SAA4D;AAC5E,UAAM,OAAO,MAAM,KAAK,MAAM,EAAE,GAAG,SAAS,OAAO,IAAM,CAAC;AAE1D,QAAI,KAAK,WAAW,GAAG;AACrB,aAAO;AAAA,IACT;AAGA,UAAM,UAAU;AAAA,MACd;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EAAE,KAAK,GAAG;AAGV,UAAM,OAAO,KAAK,IAAI,CAAC,QAAQ;AAC7B,aAAO;AAAA,QACL,IAAI;AAAA,QACJ,IAAI,UAAU,YAAY;AAAA,QAC1B,IAAI;AAAA,QACJ,IAAI;AAAA,QACJ,IAAI,WAAW;AAAA,QACf,IAAI,cAAc;AAAA,QAClB,IAAI,cAAc;AAAA,QAClB,IAAI,YAAY;AAAA,QAChB,IAAI;AAAA,QACJ,IAAI;AAAA,QACJ,IAAI,aAAa;AAAA,QACjB,IAAI,YAAY,IAAI,IAAI,UAAU,QAAQ,MAAM,IAAI,CAAC,MAAM;AAAA,QAC3D,IAAI,aAAa;AAAA,QACjB,IAAI,aAAa;AAAA,QACjB,IAAI,WAAW,IAAI,KAAK,UAAU,IAAI,QAAQ,EAAE,QAAQ,MAAM,IAAI,CAAC,MAAM;AAAA,MAC3E,EAAE,KAAK,GAAG;AAAA,IACZ,CAAC;AAED,WAAO,GAAG,OAAO;AAAA,EAAK,KAAK,KAAK,IAAI,CAAC;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,MAAM,UAA2B;AAC/B,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,gBAAgB;AACtB,YAAM,aAAa,oBAAI,KAAK;AAC5B,iBAAW,QAAQ,WAAW,QAAQ,IAAI,aAAa;AAEvD,YAAM,cAAc,MAAMA,IACvB,OAAO,iBAAiB,EACxB,MAAM,IAAI,kBAAkB,WAAW,UAAU,CAAC,EAClD,UAAU,EAAE,IAAI,kBAAkB,GAAG,CAAC;AAEzC,aAAO,KAAK,+BAA+B;AAAA,QACzC,cAAc,YAAY;AAAA,QAC1B,YAAY,WAAW,YAAY;AAAA,MACrC,CAAC;AAED,aAAO,YAAY;AAAA,IACrB,SAAS,OAAO;AACd,aAAO,MAAM,gCAAgC;AAAA,QAC3C,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,cAAc,SAUjB;AACD,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,aAAa,CAAC;AAEpB,UAAI,SAAS,WAAW;AACtB,mBAAW,KAAK,IAAI,kBAAkB,WAAW,QAAQ,SAAS,CAAC;AAAA,MACrE;AAEA,UAAI,SAAS,SAAS;AACpB,mBAAW,KAAK,IAAI,kBAAkB,WAAW,QAAQ,OAAO,CAAC;AAAA,MACnE;AAEA,UAAI,SAAS,SAAS;AACpB,mBAAW,KAAK,GAAG,kBAAkB,SAAS,QAAQ,OAAO,CAAC;AAAA,MAChE;AAEA,YAAM,gBAAgBA,IAAG,OAAO,EAAE,KAAK,iBAAiB;AAExD,YAAM,OAAO,WAAW,SAAS,IAC7B,MAAM,cAAc,MAAM,IAAI,GAAG,UAAU,CAAC,IAC5C,MAAM;AAEV,YAAM,QAAQ;AAAA,QACZ,WAAW,KAAK;AAAA,QAChB,cAAc,KAAK,OAAO,CAAC,QAAQ,IAAI,WAAW,SAAS,EAAE;AAAA,QAC7D,cAAc,KAAK,OAAO,CAAC,QAAQ,IAAI,WAAW,SAAS,EAAE;AAAA,QAC7D,aAAa,KAAK,OAAO,CAAC,QAAQ,IAAI,WAAW,QAAQ,EAAE;AAAA,QAC3D,iBAAiB,KAAK;AAAA,UACpB,CAAC,KAAK,QAAQ;AACZ,gBAAI,IAAI,SAAS,KAAK,IAAI,IAAI,SAAS,KAAK,KAAK;AACjD,mBAAO;AAAA,UACT;AAAA,UACA,CAAC;AAAA,QACH;AAAA,MACF;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AACd,aAAO,MAAM,sCAAsC;AAAA,QACjD,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAClD,CAAC;AACD,YAAM;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUQ,YAAY,KAAsB;AACxC,UAAM,eAAe,IAAI,IAAI,iBAAiB;AAC9C,QAAI,cAAc;AAChB,YAAM,UAAU,aAAa,MAAM,GAAG,EAAE,CAAC;AACzC,aAAO,SAAS,KAAK,KAAK;AAAA,IAC5B;AACA,WAAO,IAAI,MAAM,IAAI,OAAO,iBAAiB;AAAA,EAC/C;AACF;AAEO,IAAM,kBAAkB,IAAI,gBAAgB;;;ACjW5C,IAAK,oBAAL,kBAAKC,uBAAL;AAEL,EAAAA,mBAAA,wBAAqB;AACrB,EAAAA,mBAAA,wBAAqB;AACrB,EAAAA,mBAAA,uBAAoB;AACpB,EAAAA,mBAAA,iBAAc;AACd,EAAAA,mBAAA,0BAAuB;AACvB,EAAAA,mBAAA,0BAAuB;AAGvB,EAAAA,mBAAA,sBAAmB;AACnB,EAAAA,mBAAA,8BAA2B;AAC3B,EAAAA,mBAAA,8BAA2B;AAC3B,EAAAA,mBAAA,8BAA2B;AAC3B,EAAAA,mBAAA,4BAAyB;AAGzB,EAAAA,mBAAA,qBAAkB;AAClB,EAAAA,mBAAA,sBAAmB;AACnB,EAAAA,mBAAA,oBAAiB;AACjB,EAAAA,mBAAA,sBAAmB;AACnB,EAAAA,mBAAA,sBAAmB;AACnB,EAAAA,mBAAA,mBAAgB;AAChB,EAAAA,mBAAA,6BAA0B;AAG1B,EAAAA,mBAAA,uBAAoB;AACpB,EAAAA,mBAAA,0BAAuB;AACvB,EAAAA,mBAAA,kBAAe;AAGf,EAAAA,mBAAA,yBAAsB;AACtB,EAAAA,mBAAA,yBAAsB;AAhCZ,SAAAA;AAAA,GAAA;AAyCL,IAAK,cAAL,kBAAKC,iBAAL;AACL,EAAAA,aAAA,aAAU;AACV,EAAAA,aAAA,aAAU;AACV,EAAAA,aAAA,YAAS;AAHC,SAAAA;AAAA,GAAA;;;ACrBL,IAAM,sBAAN,MAA0B;AAAA,EAC/B,OAAwB,eAAe;AAAA;AAAA,EACvC,OAAwB,sBAAsB,KAAK,KAAK;AAAA;AAAA,EACxD,OAAwB,oBAAoB,KAAK,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAWtD,aAAa,cACX,OACA,SACA,YACA,eACA,YACe;AACf,UAAMC,MAAK,MAAM;AAGjB,UAAM,iBAAiB,MAAM,KAAK,kBAAkB,KAAK;AACzD,UAAM,sBAAsB,UAAU,IAAI,iBAAiB;AAG3D,UAAM,mBAAmB,CAAC,WAAW,uBAAuB,KAAK;AAGjE,UAAM,cAA+B;AAAA,MACnC,YAAY,cAAc;AAAA,MAC1B;AAAA,MACA;AAAA,MACA,eAAe,iBAAiB;AAAA,MAChC,WAAW,WAAW;AAAA,MACtB,WAAW,WAAW;AAAA,MACtB,YAAY,WAAW;AAAA,MACvB,eAAe,WAAW;AAAA,MAC1B,WAAW,WAAW;AAAA,MACtB,QAAQ,WAAW;AAAA,MACnB;AAAA,MACA;AAAA,IACF;AAEA,UAAMA,IAAG,OAAO,aAAa,EAAE,OAAO,WAAW;AAGjD,QAAI,oBAAoB,YAAY;AAClC,YAAM,KAAK,YAAY,UAAU;AAAA,IACnC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,aAAa,mBAAmB,OAAuC;AACrE,UAAMA,MAAK,MAAM;AAGjB,UAAM,iBAAiB,MAAMA,IAC1B,OAAO,EACP,KAAK,aAAa,EAClB;AAAA,MACC;AAAA,QACE,GAAG,cAAc,OAAO,KAAK;AAAA,QAC7B,GAAG,cAAc,kBAAkB,IAAI;AAAA,MACzC;AAAA,IACF,EACC,QAAQ,KAAK,cAAc,WAAW,CAAC,EACvC,MAAM,CAAC;AAEV,UAAM,cAAc,eAAe,CAAC;AACpC,QAAI,CAAC,aAAa;AAChB,aAAO;AAAA,QACL,UAAU;AAAA,QACV,qBAAqB,MAAM,KAAK,kBAAkB,KAAK;AAAA,MACzD;AAAA,IACF;AAEA,UAAM,iBAAiB,IAAI;AAAA,MACzB,YAAY,YAAY,QAAQ,IAAI,KAAK;AAAA,IAC3C;AACA,UAAM,MAAM,oBAAI,KAAK;AAGrB,QAAI,OAAO,gBAAgB;AACzB,aAAO;AAAA,QACL,UAAU;AAAA,QACV,qBAAqB;AAAA;AAAA,MACvB;AAAA,IACF;AAEA,WAAO;AAAA,MACL,UAAU;AAAA,MACV;AAAA,MACA,qBAAqB,YAAY;AAAA,MACjC,eAAe,eAAe,QAAQ,IAAI,IAAI,QAAQ;AAAA,IACxD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,aAAqB,kBAAkB,OAAgC;AACrE,UAAMA,MAAK,MAAM;AACjB,UAAM,cAAc,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,iBAAiB;AAEhE,UAAM,iBAAiB,MAAMA,IAC1B,OAAO,EACP,KAAK,aAAa,EAClB;AAAA,MACC;AAAA,QACE,GAAG,cAAc,OAAO,KAAK;AAAA,QAC7B,IAAI,cAAc,aAAa,WAAW;AAAA,MAC5C;AAAA,IACF,EACC,QAAQ,KAAK,cAAc,WAAW,CAAC;AAG1C,QAAI,WAAW;AACf,eAAW,WAAW,gBAAgB;AACpC,UAAI,QAAQ,SAAS;AACnB;AAAA,MACF;AACA;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,aAAa,oBAAoB,OAA8B;AAM7D,UAAMA,MAAK,MAAM;AACjB,UAAM,WAAW,MAAMA,IACpB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,KAAK,CAAC,EAChC,MAAM,CAAC;AAEV,UAAM,gBAAgB,SAAS,CAAC;AAChC,QAAI,iBAAiB,cAAc,eAAe;AAChD,YAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,eAAe;AAAA,QACf,iBAAiB;AAAA,QACjB,qBAAqB;AAAA,QACrB,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,cAAc,EAAE,CAAC;AAAA,IAC7C;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,aAAqB,YAAY,YAAmC;AAClE,UAAMA,MAAK,MAAM;AAGjB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,OAAO,UAAU,MAAM,CAAC,EACjC,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC,EAClC,MAAM,CAAC;AAEV,UAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,MACH,eAAe;AAAA,MACf,iBAAiB,oBAAI,KAAK;AAAA,MAC1B,qBAAqB;AAAA,MACrB,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAGrC,QAAI,UAAU;AACZ,YAAM,gBAAgB,IAAI;AAAA,QACxB;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,QAAQ;AAAA,UACR,iBAAiB;AAAA,QACnB;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAa,kBACX,YACA,QAAgB,IAC8B;AAC9C,UAAMA,MAAK,MAAM;AAEjB,WAAO,MAAMA,IACV,OAAO,EACP,KAAK,aAAa,EAClB,MAAM,GAAG,cAAc,YAAY,UAAU,CAAC,EAC9C,QAAQ,KAAK,cAAc,WAAW,CAAC,EACvC,MAAM,KAAK;AAAA,EAChB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,aAAa,cAAc,YAAmC;AAC5D,UAAMA,MAAK,MAAM;AAGjB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,OAAO,UAAU,MAAM,CAAC,EACjC,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC,EAClC,MAAM,CAAC;AAEV,UAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,MACH,eAAe;AAAA,MACf,iBAAiB;AAAA,MACjB,qBAAqB;AAAA,MACrB,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAGrC,QAAI,UAAU;AACZ,YAAM,gBAAgB,IAAI;AAAA,QACxB;AAAA,QACA;AAAA,QACA,YAAY;AAAA,QACZ,UAAU;AAAA,QACV,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,QAAQ;AAAA,QACV;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,OAAO,oBAAoB,cAA8B;AACvD,UAAM,UAAU,KAAK,KAAK,eAAe,GAAK;AAC9C,QAAI,YAAY,GAAG;AACjB,aAAO;AAAA,IACT;AACA,WAAO,GAAG,OAAO;AAAA,EACnB;AACF;;;AjBvSO,IAAM,iBAAa,uBAAO;AAOjC,IAAM,iBAAiB;AAAA,EACrB;AAAA,EAAU;AAAA,EAAa;AAAA,EAAU;AAAA,EAAY;AAAA,EAC7C;AAAA,EAAU;AAAA,EAAc;AAAA,EAAW;AAAA,EAAa;AAAA,EAChD;AAAA,EAAU;AAAA,EAAa;AAAA,EAAY;AAAA,EAAS;AAAA,EAC5C;AAAA,EAAW;AAAA,EAAU;AAAA,EAAU;AAAA,EAAU;AAC3C;AAGA,IAAM,gBAAgB,CAAC,UAA0B;AAE/C,SAAO,MAAM,YAAY,EAAE,QAAQ,oBAAoB,EAAE,EAAE,KAAK;AAClE;AAGA,IAAM,mBAAmB,CAAC,aAA8B;AAEtD,MAAI,eAAe,SAAS,SAAS,YAAY,CAAC,GAAG;AACnD,WAAO;AAAA,EACT;AAEA,QAAM,eAAe,QAAQ,KAAK,QAAQ;AAC1C,QAAM,eAAe,QAAQ,KAAK,QAAQ;AAC1C,QAAM,YAAY,QAAQ,KAAK,QAAQ;AACvC,SAAO,gBAAgB,gBAAgB;AACzC;AAEA,IAAM,iBAAiB,cAAE,OAAO;AAAA,EAC9B,OAAO,cAAE,OAAO,EACb,MAAM,sBAAsB,EAC5B,IAAI,GAAG,EACP,UAAU,aAAa,EACvB;AAAA,IACC,CAAC,UAAU,CAAC,MAAM,SAAS,IAAI,KAAK,CAAC,MAAM,SAAS,IAAI,KAAK,CAAC,MAAM,SAAS,IAAI;AAAA,IACjF,EAAE,SAAS,uBAAuB;AAAA,EACpC;AAAA,EACF,UAAU,cAAE,OAAO,EAChB,IAAI,GAAG,wCAAwC,EAC/C,IAAI,GAAG,EACP;AAAA,IACC,CAAC,aAAa,CAAC,eAAe,SAAS,SAAS,YAAY,CAAC;AAAA,IAC7D,EAAE,SAAS,6DAA6D;AAAA,EAC1E,EACC;AAAA,IACC;AAAA,IACA,EAAE,SAAS,4FAA4F;AAAA,EACzG;AAAA,EACF,WAAW,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACxC,UAAU,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACvC,kBAAkB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AACxD,CAAC;AAED,IAAM,cAAc,cAAE,OAAO;AAAA,EAC3B,OAAO,cAAE,OAAO,EACb,MAAM,sBAAsB,EAC5B,UAAU,aAAa;AAAA,EAC1B,UAAU,cAAE,OAAO,EAAE,IAAI,GAAG,sBAAsB;AACpD,CAAC;AAED,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,OAAO,cAAE,OAAO,EACb,MAAM,sBAAsB,EAC5B,IAAI,GAAG,EACP,UAAU,aAAa;AAC5B,CAAC;AAED,IAAM,wBAAwB,cAAE,OAAO;AAAA,EACrC,OAAO,cAAE,OAAO,EACb,MAAM,sBAAsB,EAC5B,UAAU,aAAa;AAAA,EAC1B,MAAM,cAAE,OAAO,EACZ,OAAO,GAAG,uBAAuB,EACjC,MAAM,SAAS,+BAA+B;AACnD,CAAC;AAED,IAAM,oBAAoB,cAAE,OAAO;AAAA,EACjC,OAAO,cAAE,OAAO,EACb,MAAM,uBAAuB,EAC7B,IAAI,KAAK,gBAAgB,EACzB,UAAU,aAAa;AAAA,EAC1B,MAAM,cAAE,OAAO,EACZ,OAAO,GAAG,uBAAuB,EACjC,MAAM,SAAS,+BAA+B;AACnD,CAAC;AAED,IAAM,2BAA2B,cAAE,OAAO;AAAA,EACxC,OAAO,cAAE,OAAO,EACb,MAAM,uBAAuB,EAC7B,IAAI,KAAK,gBAAgB,EACzB,UAAU,aAAa;AAC5B,CAAC;AAED,IAAM,sBAAsB,cAAE,OAAO;AAAA,EACnC,OAAO,cAAE,OAAO,EACb,MAAM,sBAAsB,EAC5B,UAAU,aAAa;AAAA,EAC1B,MAAM,cAAE,OAAO,EACZ,OAAO,GAAG,uBAAuB,EACjC,MAAM,SAAS,+BAA+B;AAAA,EACjD,aAAa,cAAE,OAAO,EACnB,IAAI,GAAG,wCAAwC,EAC/C,IAAI,GAAG,EACP,OAAO,kBAAkB;AAAA,IACxB,SAAS;AAAA,EACX,CAAC,EACA;AAAA,IACC,CAAC,MAAM,CAAC,eAAe,SAAS,EAAE,YAAY,CAAC;AAAA,IAC/C,EAAE,SAAS,6DAA6D;AAAA,EAC1E;AACJ,CAAC;AAUD,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA,aAAa,cAAc;AAAA,EAC3B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,UAAU,WAAW,UAAU,iBAAiB,IAAI,IAAI;AACvE,YAAMC,MAAK,MAAM;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,MAAM,YAAY,CAAC,CAAC;AAEjD,UAAI,YAAY,CAAC,SAAS,SAAS;AACjC,cAAM,IAAI,cAAc,0BAA0B;AAAA,MACpD;AAGA,YAAM,eAAe,MAAM,iBAAAC,QAAO,KAAK,UAAU,EAAE;AAGnD,UAAI;AAEJ,UAAI,YAAY,SAAS,SAAS;AAEhC,cAAM,CAAC,OAAO,IAAI,MAAMD,IACrB,OAAO,SAAS,EAChB,IAAI;AAAA,UACH;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,UACA,YAAY,SAAS,SAAS,EAAE;AAAA;AAAA,UAChC,WAAW,oBAAI,KAAK;AAAA,QACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC,EACnC,UAAU;AACb,mBAAW;AAAA,MACb,OAAO;AAEL,cAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,SAAS,EAChB,OAAO;AAAA,UACN,OAAO,MAAM,YAAY;AAAA,UACzB;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,UACA,YAAY,SAAS,KAAK,IAAI,CAAC;AAAA;AAAA,QACjC,CAAC,EACA,UAAU;AACb,mBAAW;AAGX,YAAI,UAAU;AACZ,gBAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,YAAY,SAAS,SAAS,EAAE,GAAG,CAAC,EAC1C,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC;AAAA,QACxC;AAAA,MACF;AAEA,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,MAAM,qCAAqC;AAAA,MACvD;AAGA,YAAM,OAAO,MAAM,wBAAwB,WAAW;AAAA,QACpD,OAAO,SAAS;AAAA,QAChB,MAAM;AAAA,QACN,WAAW,IAAI;AAAA,QACf,eAAe;AAAA,MACjB,CAAC;AAGD,YAAM,YAAY,MAAM,oBAAoB,sBAAsB;AAAA,QAChE,OAAO,SAAS;AAAA,QAChB,WAAW,SAAS;AAAA,QACpB;AAAA,QACA,eAAe;AAAA,MACjB,CAAC;AAED,UAAI,CAAC,WAAW;AACd,eAAO,MAAM,qCAAqC;AAAA,UAChD,OAAO,SAAS;AAAA,UAChB,YAAY,SAAS;AAAA,QACvB,CAAC;AAAA,MACH;AAEA,aAAO,KAAK,gDAAgD;AAAA,QAC1D,YAAY,SAAS;AAAA,QACrB,OAAO,SAAS;AAAA,MAClB,CAAC;AAGD,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,SAAS,SAAS;AAAA,QAClB,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,kBAAkB,YAAY,SAAS,UAAU,qBAAqB;AAAA,UACtE,eAAe;AAAA,QACjB;AAAA,MACF,CAAC;AAGD,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,YAAY;AAAA,QACZ,UAAU,SAAS;AAAA,QACnB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,OAAO,SAAS;AAAA,UAChB,eAAe;AAAA,QACjB;AAAA,MACF,CAAC;AAGD,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,MAAM;AAAA,UACJ,IAAI,SAAS;AAAA,UACb,OAAO,SAAS;AAAA,UAChB,eAAe;AAAA,UACf,WAAW,SAAS;AAAA,UACpB,UAAU,SAAS;AAAA,QACrB;AAAA,MACF,GAAG,GAAG;AAAA,IACR,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA,aAAa,WAAW;AAAA,EACxB,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,SAAS,IAAI,IAAI;AAChC,YAAM,kBAAkB,MAAM,YAAY;AAC1C,YAAMA,MAAK,MAAM;AAGjB,YAAM,aAAa;AAAA,QACjB,WAAW,IAAI,MAAM,IAAI,OAAO,iBAAiB;AAAA,QACjD,WAAW,IAAI,QAAQ,YAAY;AAAA,MACrC;AAGA,YAAM,gBAAgB,MAAM,oBAAoB,mBAAmB,eAAe;AAClF,UAAI,cAAc,UAAU;AAC1B,cAAM,gBAAgB,oBAAoB;AAAA,UACxC,cAAc,iBAAiB;AAAA,QACjC;AAEA,eAAO,KAAK,iCAAiC;AAAA,UAC3C,OAAO;AAAA,UACP;AAAA,QACF,CAAC;AAGD,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU;AAAA,YACR,QAAQ;AAAA,YACR,eAAe,cAAc;AAAA,YAC7B,gBAAgB,cAAc,gBAAgB,YAAY;AAAA,UAC5D;AAAA,QACF,CAAC;AAED,eAAO;AAAA,UACL;AAAA,UACA;AAAA,UACA;AAAA,UACA,yFAAyF,aAAa;AAAA,QACxG;AAAA,MACF;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,eAAe,CAAC;AAE7C,UAAI,CAAC,YAAY,SAAS,SAAS;AAEjC,cAAM,oBAAoB;AAAA,UACxB;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAGA,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,QAAQ,sBAAsB;AAAA,QAC5C,CAAC;AAED,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAGA,UAAI,CAAC,SAAS,cAAc;AAC1B,cAAM,oBAAoB;AAAA,UACxB;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,QACF;AAGA,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS,SAAS;AAAA,UAClB,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,QAAQ,mBAAmB;AAAA,QACzC,CAAC;AAED,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAEA,YAAM,kBAAkB,MAAM,iBAAAC,QAAO,QAAQ,UAAU,SAAS,YAAY;AAC5E,UAAI,CAAC,iBAAiB;AACpB,cAAM,oBAAoB;AAAA,UACxB;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,QACF;AAGA,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS,SAAS;AAAA,UAClB,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,QAAQ,mBAAmB;AAAA,QACzC,CAAC;AAED,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAGA,UAAI,CAAC,SAAS,eAAe;AAC3B,cAAM,oBAAoB;AAAA,UACxB;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,QACF;AAEA,eAAO,KAAK,qCAAqC;AAAA,UAC/C,OAAO,SAAS;AAAA,UAChB,YAAY,SAAS;AAAA,QACvB,CAAC;AAGD,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS,SAAS;AAAA,UAClB,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,QAAQ,mBAAmB;AAAA,QACzC,CAAC;AAED,eAAO;AAAA,UACL;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAAA,MACF;AAGA,UAAI,CAAC,SAAS,UAAU;AACtB,cAAM,oBAAoB;AAAA,UACxB;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT;AAAA,UACA;AAAA,QACF;AAEA,eAAO,KAAK,mCAAmC;AAAA,UAC7C,OAAO,SAAS;AAAA,UAChB,YAAY,SAAS;AAAA,QACvB,CAAC;AAGD,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS,SAAS;AAAA,UAClB,YAAY;AAAA,UACZ,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,QAAQ,mBAAmB;AAAA,QACzC,CAAC;AAED,cAAM,IAAI,kBAAkB,8CAA8C;AAAA,MAC5E;AAGA,YAAM,oBAAoB;AAAA,QACxB;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT;AAAA,QACA;AAAA,MACF;AAGA,YAAM,oBAAoB,oBAAoB,eAAe;AAG7D,YAAM,iBAAiB,IAAI,aAAa,IAAI,QAAQ,cAAc;AAClE,UAAI,gBAAgB;AAClB,cAAM,cAAc,MAAM,YAAY,iBAAiB,gBAAgB,SAAS,EAAE;AAClF,eAAO,KAAK,gCAAgC;AAAA,UAC1C,YAAY,SAAS;AAAA,UACrB;AAAA,UACA,aAAa;AAAA,QACf,CAAC;AAAA,MACH;AAGA,YAAM,YAAY,MAAM,eAAe,cAAc;AAAA,QACnD,YAAY,SAAS;AAAA,QACrB,WAAW,IAAI,QAAQ,YAAY,KAAK;AAAA,QACxC,WAAW,IAAI,MAAM,IAAI,OAAO,iBAAiB;AAAA,MACnD,CAAC;AAGD,YAAM,QAAQ,cAAc;AAAA,QAC1B,QAAQ,SAAS;AAAA,QACjB,OAAO,SAAS;AAAA,QAChB,MAAO,SAAS,QAAQ;AAAA,QACxB,YAAY,SAAS;AAAA,QACrB;AAAA,MACF,CAAC;AAGD,YAAM,eAAe,aAAa,WAAW,KAAK;AAGlD,UAAI,OAAO,cAAc,OAAO;AAAA,QAC9B,UAAU;AAAA,QACV,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,QACpC,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,QAC9D,QAAQ,QAAQ,IAAI,UAAU,MAAM,eAAe,2BAA2B;AAAA,QAC9E,QAAQ,IAAI,KAAK,KAAK,KAAK;AAAA;AAAA,MAC7B,CAAC;AAGD,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,SAAS,SAAS;AAAA,QAClB,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR;AAAA,UACA,YAAY,WAAW;AAAA,QACzB;AAAA,MACF,CAAC;AAED,aAAO,KAAK,oBAAoB;AAAA,QAC9B,OAAO,SAAS;AAAA,QAChB,YAAY,SAAS;AAAA,QACrB;AAAA,MACF,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,MAAM;AAAA,UACJ,IAAI,SAAS;AAAA,UACb,OAAO,SAAS;AAAA,UAChB,MAAO,SAAS,QAAQ;AAAA,UACxB,YAAY,SAAS;AAAA,UACrB,WAAW,SAAS;AAAA,UACpB,UAAU,SAAS;AAAA,QACrB;AAAA,QACA;AAAA,QACA,WAAW,mBAAmB,EAAE,YAAY;AAAA,MAC9C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,WAAW,IAAI,OAAO,aAAa,OAAO,KAAK,KAAK,SAAS;AAC3D,MAAI;AAEF,QAAI,UAAU,iBAAiB,uDAAuD;AACtF,QAAI,UAAU,UAAU,UAAU;AAClC,QAAI,UAAU,WAAW,GAAG;AAE5B,UAAMD,MAAK,MAAM;AAGjB,QAAI,IAAI,MAAM,SAAS,SAAS;AAC9B,kBAAY,KAAK;AAAA,QACf,IAAI,IAAI,KAAK;AAAA,QACb,OAAO,IAAI,KAAK;AAAA,QAChB,MAAM;AAAA,QACN,SAAS;AAAA,MACX,CAAC;AACD;AAAA,IACF;AAGA,QAAI,CAAC,IAAI,MAAM,YAAY;AACzB,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,IAAI,KAAK,UAAU,CAAC;AAE9C,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,gBAAY,KAAK;AAAA,MACf,IAAI,SAAS;AAAA,MACb,OAAO,SAAS;AAAA,MAChB,MAAM,IAAI,KAAK;AAAA,MACf,YAAY,SAAS;AAAA,MACrB,WAAW,SAAS;AAAA,MACpB,UAAU,SAAS;AAAA,IACrB,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,KAAK,WAAW,aAAa,OAAO,KAAK,KAAK,SAAS;AAChE,MAAI;AACF,UAAM,YAAY,IAAI,MAAM;AAG5B,QAAI,WAAW;AACb,YAAM,eAAe,cAAc,WAAW,aAAa;AAC3D,aAAO,KAAK,6BAA6B;AAAA,QACvC;AAAA,QACA,YAAY,IAAI,MAAM;AAAA,MACxB,CAAC;AAAA,IACH;AAGA,UAAM,gBAAgB,eAAe,KAAK;AAAA,MACxC;AAAA,MACA;AAAA,MACA,SAAS,IAAI,MAAM;AAAA,MACnB,YAAY,IAAI,MAAM;AAAA,MACtB,QAAQ;AAAA,MACR;AAAA,MACA,UAAU;AAAA,QACR;AAAA,MACF;AAAA,IACF,CAAC;AAGD,QAAI,YAAY,cAAc;AAAA,MAC5B,UAAU;AAAA,MACV,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,MACpC,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,MAC9D,QAAQ,QAAQ,IAAI,UAAU,MAAM,eAAe,2BAA2B;AAAA,MAC9E,MAAM;AAAA,IACR,CAAC;AAED,gBAAY,KAAK,EAAE,SAAS,0BAA0B,CAAC;AAAA,EACzD,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA,aAAa,WAAW;AAAA,EACxB,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,SAAS,IAAI,IAAI;AAChC,YAAMA,MAAK,MAAM;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,MAAM,YAAY,CAAC,CAAC;AAEjD,UAAI,CAAC,YAAY,SAAS,SAAS;AACjC,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAGA,UAAI,CAAC,SAAS,cAAc;AAC1B,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAEA,YAAM,kBAAkB,MAAM,iBAAAC,QAAO,QAAQ,UAAU,SAAS,YAAY;AAC5E,UAAI,CAAC,iBAAiB;AACpB,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAGA,UAAI,SAAS,SAAS,SAAS;AAC7B,cAAM,IAAI,kBAAkB,2CAA2C;AAAA,MACzE;AAGA,UAAI,CAAC,SAAS,UAAU;AACtB,cAAM,IAAI,kBAAkB,8CAA8C;AAAA,MAC5E;AAGA,UAAI,CAAC,SAAS,eAAe;AAC3B,cAAM,IAAI,kBAAkB,uDAAuD;AAAA,MACrF;AAGA,YAAM,YAAY,MAAM,eAAe,cAAc;AAAA,QACnD,YAAY,SAAS;AAAA,QACrB,WAAW,IAAI,QAAQ,YAAY,KAAK;AAAA,QACxC,WAAW,IAAI,MAAM,IAAI,OAAO,iBAAiB;AAAA,MACnD,CAAC;AAGD,YAAM,QAAQ,cAAc;AAAA,QAC1B,QAAQ,SAAS;AAAA,QACjB,OAAO,SAAS;AAAA,QAChB,MAAM;AAAA,QACN,YAAY,SAAS;AAAA,QACrB;AAAA,MACF,CAAC;AAGD,YAAM,eAAe,aAAa,WAAW,KAAK;AAGlD,UAAI,OAAO,cAAc,OAAO;AAAA,QAC9B,UAAU;AAAA,QACV,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,QACpC,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,QAC9D,QAAQ,QAAQ,IAAI,UAAU,MAAM,eAAe,2BAA2B;AAAA,QAC9E,QAAQ,IAAI,KAAK,KAAK,KAAK;AAAA;AAAA,MAC7B,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,MAAM;AAAA,UACJ,IAAI,SAAS;AAAA,UACb,OAAO,SAAS;AAAA,UAChB,MAAM;AAAA,UACN,YAAY,SAAS;AAAA,UACrB,WAAW,SAAS;AAAA,UACpB,UAAU,SAAS;AAAA,QACrB;AAAA,QACA;AAAA,QACA,WAAW,mBAAmB,EAAE,YAAY;AAAA,MAC9C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAOA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,MAAM,IAAI,IAAI;AACtB,YAAMD,MAAK,MAAM;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,MAAM,YAAY,CAAC,CAAC,EAC9C,MAAM,CAAC;AAIV,UAAI,YAAY,SAAS,YAAY,CAAC,SAAS,WAAW,SAAS,cAAc;AAE/E,cAAM,OAAO,MAAM,wBAAwB,WAAW;AAAA,UACpD,OAAO,SAAS;AAAA,UAChB,MAAM;AAAA,UACN,WAAW,IAAI;AAAA,UACf,eAAe;AAAA,QACjB,CAAC;AAGD,cAAM,YAAY,MAAM,oBAAoB,qBAAqB;AAAA,UAC/D,OAAO,SAAS;AAAA,UAChB;AAAA,UACA,MAAM;AAAA,UACN,eAAe;AAAA,QACjB,CAAC;AAED,YAAI,CAAC,WAAW;AACd,iBAAO,MAAM,uCAAuC;AAAA,YAClD,OAAO,SAAS;AAAA,YAChB;AAAA,UACF,CAAC;AAAA,QACH;AAEA,eAAO,KAAK,4BAA4B;AAAA,UACtC,OAAO,SAAS;AAAA,UAChB,IAAI,IAAI;AAAA,QACV,CAAC;AAGD,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS,SAAS;AAAA,UAClB,YAAY,SAAS;AAAA,UACrB,QAAQ;AAAA,UACR;AAAA,UACA,UAAU;AAAA,YACR,QAAQ;AAAA,YACR,eAAe;AAAA,UACjB;AAAA,QACF,CAAC;AAAA,MACH,OAAO;AAEL,cAAM,SAAS,CAAC,WAAW,cACvB,CAAC,SAAS,WAAW,aACrB,SAAS,UAAU,UACnB,CAAC,SAAS,eAAe,gBACzB;AAEJ,eAAO,KAAK,8CAA8C;AAAA,UACxD;AAAA,UACA;AAAA,UACA,IAAI,IAAI;AAAA,QACV,CAAC;AAGD,cAAM,IAAI,QAAQ,aAAW,WAAW,SAAS,GAAG,CAAC;AAAA,MACvD;AAGA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,MACX,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAQA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,qBAAqB;AAAA,EAClC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,KAAK,IAAI,IAAI;AAC5B,YAAMA,MAAK,MAAM;AACjB,YAAM,MAAM,oBAAI,KAAK;AAGrB,YAAM,CAAC,MAAM,IAAI,MAAMA,IACpB,OAAO,EACP,KAAK,iBAAiB,EACtB;AAAA,QACC;AAAA,UACE,GAAG,kBAAkB,OAAO,MAAM,YAAY,CAAC;AAAA,UAC/C,GAAG,kBAAkB,MAAM,gBAAgB;AAAA,UAC3C,GAAG,kBAAkB,QAAQ,KAAK;AAAA,UAClC,IAAI,kBAAkB,WAAW,GAAG;AAAA,QACtC;AAAA,MACF,EACC,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,CAAC;AAEV,UAAI,CAAC,QAAQ;AACX,eAAO,KAAK,0CAA0C,EAAE,OAAO,MAAM,iBAAiB,CAAC;AACvF,cAAM,IAAI,gBAAgB,sCAAsC;AAAA,MAClE;AAGA,UAAI,OAAO,YAAY,OAAO,aAAa;AACzC,eAAO,KAAK,sCAAsC,EAAE,OAAO,MAAM,kBAAkB,UAAU,OAAO,SAAS,CAAC;AAC9G,cAAM,IAAI,gBAAgB,oEAAoE;AAAA,MAChG;AAGA,YAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI,EAAE,UAAU,OAAO,WAAW,EAAE,CAAC,EACrC,MAAM,GAAG,kBAAkB,IAAI,OAAO,EAAE,CAAC;AAG5C,UAAI,OAAO,SAAS,MAAM;AACxB,eAAO,KAAK,qCAAqC,EAAE,OAAO,MAAM,kBAAkB,UAAU,OAAO,WAAW,EAAE,CAAC;AACjH,cAAM,IAAI,gBAAgB,2BAA2B;AAAA,MACvD;AAGA,aAAO,KAAK,gCAAgC;AAAA,QAC1C,OAAO,MAAM,YAAY;AAAA,MAC3B,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,OAAO;AAAA,MACT,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAQA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,MAAM,YAAY,IAAI,IAAI;AACzC,YAAM,kBAAkB,MAAM,YAAY;AAC1C,YAAMA,MAAK,MAAM;AAIjB,YAAM,UAAU,MAAM,wBAAwB,2BAA2B;AAAA,QACvE,OAAO;AAAA,QACP;AAAA,QACA,MAAM;AAAA,MACR,CAAC;AAED,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,gBAAgB,sCAAsC;AAAA,MAClE;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,eAAe,CAAC,EAC1C,MAAM,CAAC;AAEV,UAAI,CAAC,UAAU;AACb,eAAO,MAAM,kDAAkD;AAAA,UAC7D,OAAO;AAAA,QACT,CAAC;AACD,cAAM,IAAI,gBAAgB,2BAA2B;AAAA,MACvD;AAGA,UAAI,CAAC,SAAS,UAAU;AACtB,eAAO,KAAK,+CAA+C;AAAA,UACzD,YAAY,SAAS;AAAA,QACvB,CAAC;AACD,cAAM,IAAI,gBAAgB,qBAAqB;AAAA,MACjD;AAEA,UAAI,SAAS,SAAS;AACpB,eAAO,KAAK,4CAA4C;AAAA,UACtD,YAAY,SAAS;AAAA,QACvB,CAAC;AACD,cAAM,IAAI,gBAAgB,sBAAsB;AAAA,MAClD;AAGA,YAAM,aAAa,CAAC,SAAS,OAAO,SAAS,WAAW,SAAS,QAAQ,EAAE,OAAO,OAAO;AACzF,YAAM,aAAa,MAAM,wBAAwB;AAAA,QAC/C;AAAA,QACA,SAAS;AAAA,QACT;AAAA,MACF;AAEA,UAAI,CAAC,WAAW,SAAS;AACvB,eAAO,KAAK,kDAAkD;AAAA,UAC5D,YAAY,SAAS;AAAA,UACrB,QAAQ,WAAW;AAAA,QACrB,CAAC;AAGD,cAAM,eAAe,WAAW,OAAO,KAAK,IAAI,IAAI;AACpD,cAAM,IAAI,gBAAgB,YAAY;AAAA,MACxC;AAGA,YAAM,eAAe,MAAM,iBAAAC,QAAO,KAAK,aAAa,EAAE;AAGtD,YAAMD,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,QACH;AAAA,QACA,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC;AAGtC,YAAM,wBAAwB,qBAAqB;AAAA,QACjD,YAAY,SAAS;AAAA,QACrB;AAAA,QACA,cAAc;AAAA,QACd,WAAW,IAAI,MAAM,IAAI,OAAO;AAAA,QAChC,WAAW,IAAI,QAAQ,YAAY;AAAA,MACrC,CAAC;AAGD,YAAM,wBAAwB,eAAe,iBAAiB,gBAAgB;AAG9E,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,SAAS,SAAS;AAAA,QAClB,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,QAAQ;AAAA,UACR,eAAe,WAAW,gBAAgB;AAAA,QAC5C;AAAA,MACF,CAAC;AAGD,YAAM,wBAAwB;AAAA,QAC5B;AAAA,QACA;AAAA,MACF;AAGA,YAAM,YAAY,MAAM,oBAAoB,gCAAgC;AAAA,QAC1E,OAAO,SAAS;AAAA,QAChB,WAAW,SAAS;AAAA,QACpB,WAAW,oBAAI,KAAK;AAAA,QACpB,WAAW,IAAI;AAAA,MACjB,CAAC;AAED,UAAI,CAAC,WAAW;AACd,eAAO,MAAM,yCAAyC;AAAA,UACpD,OAAO,SAAS;AAAA,UAChB,YAAY,SAAS;AAAA,QACvB,CAAC;AAAA,MAEH;AAGA,YAAM,QAAQ,cAAc;AAAA,QAC1B,QAAQ,SAAS;AAAA,QACjB,OAAO,SAAS;AAAA,QAChB,MAAM;AAAA,QACN,YAAY,SAAS;AAAA,MACvB,CAAC;AAGD,UAAI,OAAO,cAAc,OAAO;AAAA,QAC9B,UAAU;AAAA,QACV,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,QACpC,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,QAC9D,QAAQ,QAAQ,IAAI,UAAU,MAAM,eAAe,2BAA2B;AAAA,QAC9E,QAAQ,IAAI,KAAK,KAAK,KAAK;AAAA;AAAA,MAC7B,CAAC;AAED,aAAO,KAAK,6BAA6B;AAAA,QACvC,YAAY,SAAS;AAAA,QACrB,OAAO,SAAS;AAAA,MAClB,CAAC;AAGD,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,MAAM;AAAA,UACJ,IAAI,SAAS;AAAA,UACb,OAAO,SAAS;AAAA,UAChB,MAAM;AAAA,UACN,YAAY,SAAS;AAAA,UACrB,WAAW,SAAS;AAAA,UACpB,UAAU,SAAS;AAAA,QACrB;AAAA,QACA;AAAA,QACA,WAAW,mBAAmB,EAAE,YAAY;AAAA,MAC9C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAsBA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,iBAAiB;AAAA,EAC9B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,OAAO,KAAK,IAAI,IAAI;AAC5B,YAAM,kBAAkB,MAAM,YAAY,EAAE,KAAK;AACjD,YAAMA,MAAK,MAAM;AAGjB,YAAM,UAAU,MAAM,wBAAwB,aAAa;AAAA,QACzD,OAAO;AAAA,QACP;AAAA,QACA,MAAM;AAAA,MACR,CAAC;AAED,UAAI,CAAC,SAAS;AACZ,eAAO,UAAU,KAAK,KAAK,gBAAgB,uCAAuC;AAAA,MACpF;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,eAAe,CAAC,EAC1C,MAAM,CAAC;AAEV,UAAI,CAAC,YAAY,SAAS,SAAS;AACjC,eAAO,UAAU,KAAK,KAAK,gBAAgB,4BAA4B;AAAA,MACzE;AAGA,UAAI,SAAS,eAAe;AAC1B,eAAO,UAAU,KAAK,KAAK,oBAAoB,yBAAyB;AAAA,MAC1E;AAGA,YAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,eAAe;AAAA,QACf,iBAAiB,oBAAI,KAAK;AAAA,QAC1B,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC;AAGtC,YAAM,wBAAwB;AAAA,QAC5B;AAAA,QACA;AAAA,MACF;AAEA,aAAO,KAAK,+BAA+B;AAAA,QACzC,OAAO,SAAS;AAAA,QAChB,YAAY,SAAS;AAAA,MACvB,CAAC;AAGD,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,SAAS,SAAS;AAAA,QAClB,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,oBAAoB;AAAA,UACpB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,QACrC;AAAA,MACF,CAAC;AAGD,YAAM,QAAQ,cAAc;AAAA,QAC1B,QAAQ,SAAS;AAAA,QACjB,OAAO,SAAS;AAAA,QAChB,MAAM;AAAA,QACN,YAAY,SAAS;AAAA,MACvB,CAAC;AAGD,UAAI,OAAO,cAAc,OAAO;AAAA,QAC9B,UAAU;AAAA,QACV,QAAQ,QAAQ,IAAI,UAAU,MAAM;AAAA,QACpC,UAAU,QAAQ,IAAI,UAAU,MAAM,eAAe,SAAS;AAAA,QAC9D,QAAQ,IAAI,KAAK,KAAK,KAAK;AAAA;AAAA,MAC7B,CAAC;AAED,YAAM,OAAO;AAAA,QACX,IAAI,SAAS;AAAA,QACb,OAAO,SAAS;AAAA,QAChB,eAAe;AAAA,QACf,WAAW,SAAS;AAAA,QACpB,UAAU,SAAS;AAAA,QACnB,OAAO,SAAS;AAAA,QAChB,MAAM;AAAA,QACN,YAAY,SAAS;AAAA,MACvB;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT;AAAA,QACA;AAAA,QACA,WAAW,mBAAmB,EAAE,YAAY;AAAA,MAC9C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAmBA,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,wBAAwB;AAAA,EACrC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,MAAM,IAAI,IAAI;AACtB,YAAM,kBAAkB,MAAM,YAAY,EAAE,KAAK;AACjD,YAAMA,MAAK,MAAM;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,eAAe,CAAC,EAC1C,MAAM,CAAC;AAGV,UAAI,YAAY,CAAC,SAAS,WAAW,CAAC,SAAS,eAAe;AAE5D,cAAM,wBAAwB;AAAA,UAC5B;AAAA,UACA;AAAA,QACF;AAGA,cAAM,OAAO,MAAM,wBAAwB,WAAW;AAAA,UACpD,OAAO,SAAS;AAAA,UAChB,MAAM;AAAA,UACN,WAAW,IAAI;AAAA,UACf,eAAe;AAAA,QACjB,CAAC;AAGD,cAAM,YAAY,MAAM,oBAAoB,sBAAsB;AAAA,UAChE,OAAO,SAAS;AAAA,UAChB,WAAW,SAAS;AAAA,UACpB;AAAA,UACA,eAAe;AAAA,QACjB,CAAC;AAED,YAAI,CAAC,WAAW;AACd,iBAAO,MAAM,qCAAqC;AAAA,YAChD,OAAO,SAAS;AAAA,YAChB,YAAY,SAAS;AAAA,UACvB,CAAC;AAAA,QACH,OAAO;AACL,iBAAO,KAAK,6BAA6B;AAAA,YACvC,OAAO,SAAS;AAAA,YAChB,YAAY,SAAS;AAAA,UACvB,CAAC;AAAA,QACH;AAAA,MACF;AAGA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,MACX,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AA4BA,IAAM,sBAAsB,cAAE,OAAO;AAAA,EACnC,UAAU,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAC1B,OAAO,cAAE,OAAO,EAAE,MAAM,EAAE,SAAS;AAAA,EACnC,YAAY,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AACzC,CAAC;AAED,WAAW;AAAA,EACT;AAAA,EACA;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,UAAU,OAAO,WAAW,IAAI,IAAI;AAG5C,YAAM,aAAuB,CAAC;AAC9B,UAAI,OAAO;AACT,mBAAW,KAAK,KAAK;AACrB,cAAM,aAAa,MAAM,MAAM,GAAG;AAClC,mBAAW,KAAK,WAAW,CAAC,CAAC;AAAA,MAC/B;AAGA,UAAI;AACJ,UAAI,YAAY;AACd,cAAM,aAAa,MAAM,wBAAwB;AAAA,UAC/C;AAAA,UACA;AAAA,UACA;AAAA,QACF;AACA,iBAAS,WAAW;AAAA,MACtB,OAAO;AAEL,cAAM,aAAa,MAAM,wBAAwB;AAAA,UAC/C;AAAA,UACA;AAAA,QACF;AACA,iBAAS,WAAW;AAAA,MACtB;AAEA,kBAAY,KAAK,MAAM;AAAA,IACzB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;AkB32CA,IAAAE,kBAAwD;AAMxD,IAAM,qBAAiB,wBAAO;AAM9B,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,mBAAmB,IAAI,MAAM;AAEnC,UAAI,CAAC,YAAY;AACf,eAAO,UAAU,KAAK,KAAK,eAAe,uBAAuB;AAAA,MACnE;AAGA,YAAMC,YAAW,MAAM,eAAe,kBAAkB,UAAU;AAGlE,YAAM,sBAAsBA,UAAS,IAAI,CAAC,aAAa;AAAA,QACrD,GAAG;AAAA,QACH,WAAW,QAAQ,OAAO;AAAA,MAC5B,EAAE;AAEF,kBAAY,KAAK;AAAA,QACf,UAAU;AAAA,QACV;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,EAAE,UAAU,IAAI,IAAI;AAC1B,YAAM,aAAa,IAAI,MAAM;AAE7B,UAAI,CAAC,YAAY;AACf,eAAO,UAAU,KAAK,KAAK,eAAe,uBAAuB;AAAA,MACnE;AAGA,YAAMA,YAAW,MAAM,eAAe,kBAAkB,UAAU;AAClE,YAAM,UAAUA,UAAS,KAAK,CAAC,MAAM,EAAE,OAAO,SAAS;AAEvD,UAAI,CAAC,SAAS;AACZ,eAAO,UAAU,KAAK,KAAK,aAAa,sCAAsC;AAAA,MAChF;AAGA,YAAM,eAAe,cAAc,WAAqB,aAAa;AAErE,aAAO,KAAK,2BAA2B;AAAA,QACrC;AAAA,QACA;AAAA,QACA,YAAY,QAAQ;AAAA,MACtB,CAAC;AAED,kBAAY,KAAK,EAAE,SAAS,+BAA+B,CAAC;AAAA,IAC9D,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,mBAAmB,IAAI,MAAM;AAEnC,UAAI,CAAC,cAAc,CAAC,kBAAkB;AACpC,eAAO,UAAU,KAAK,KAAK,eAAe,+BAA+B;AAAA,MAC3E;AAEA,YAAMC,SAAQ,MAAM,eAAe,oBAAoB,YAAY,gBAAgB;AAEnF,aAAO,KAAK,0BAA0B,EAAE,YAAY,OAAAA,OAAM,CAAC;AAE3D,kBAAY,KAAK;AAAA,QACf,SAAS,GAAGA,MAAK;AAAA,QACjB,OAAAA;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,aAAa,IAAI,MAAM;AAE7B,UAAI,CAAC,YAAY;AACf,eAAO,UAAU,KAAK,KAAK,eAAe,uBAAuB;AAAA,MACnE;AAEA,YAAMA,SAAQ,MAAM,eAAe,kBAAkB,UAAU;AAG/D,UAAI,YAAY,YAAY;AAE5B,aAAO,KAAK,wBAAwB,EAAE,YAAY,OAAAA,OAAM,CAAC;AAEzD,kBAAY,KAAK;AAAA,QACf,SAAS,OAAOA,MAAK;AAAA,QACrB,OAAAA;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;AC/IA,IAAAC,kBAAuB;AACvB,IAAAC,cAAkB;AAUX,IAAM,qBAAiB,wBAAO;AAMrC,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,MAAM,cAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,YAAY,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACvC,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,EAClC,UAAU,cAAE,OAAO,EAAE,SAAS;AAAA;AAAA,EAC9B,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,cAAE,KAAK,CAAC,SAAS,UAAU,UAAU,CAAC,EAAE,SAAS;AAAA,EACzD,YAAY,cAAE,KAAK,CAAC,QAAQ,OAAO,CAAC,EAAE,SAAS;AAAA,EAC/C,UAAU,cAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,UAAU,cAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,SAAS,cAAE,KAAK,CAAC,QAAQ,OAAO,CAAC,EAAE,SAAS;AAAA,EAC5C,QAAQ,cAAE,KAAK,CAAC,QAAQ,aAAa,aAAa,eAAe,CAAC,EAAE,SAAS;AAAA,EAC7E,WAAW,cAAE,KAAK,CAAC,OAAO,MAAM,CAAC,EAAE,SAAS;AAC9C,CAAC;AAED,IAAM,sBAAsB,cAAE,OAAO;AAAA;AAAA,EAEnC,KAAK,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACzC,SAAS,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACtC,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,MAAM,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACnC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,EACjC,kBAAkB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC/C,YAAY,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,SAAS;AAAA,EAClD,OAAO,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA;AAAA,EAGpC,WAAW,cAAE,OAAO,EAAE,SAAS,EAAE,IAAI,SAAS;AAAA,EAC9C,WAAW,cAAE,OAAO,EAAE,SAAS,EAAE,IAAI,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA,EACpE,gBAAgB,cAAE,OAAO,EAAE,SAAS,EAAE,IAAI,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,EAGzE,QAAQ,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA,EAClD,YAAY,cAAE,OAAO;AAAA,IACnB,OAAO,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IACtC,QAAQ,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IACvC,OAAO,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EACxC,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,EAGvB,eAAe,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC;AAAA,EAC3D,mBAAmB,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC;AAAA,EAC/D,gBAAgB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EACnD,gBAAgB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA;AAAA,EAGpD,QAAQ,cAAE,MAAM,cAAE,OAAO;AAAA,IACvB,KAAK,cAAE,OAAO,EAAE,IAAI;AAAA,IACpB,KAAK,cAAE,OAAO,EAAE,SAAS;AAAA,IACzB,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,IAC3B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,CAAC,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA,EACzB,QAAQ,cAAE,MAAM,cAAE,OAAO;AAAA,IACvB,KAAK,cAAE,OAAO,EAAE,IAAI;AAAA,IACpB,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,CAAC,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA,EACzB,cAAc,cAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,EAGnD,MAAM,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,IAAI,EAAE,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA,EACvD,gBAAgB,cAAE,OAAO,cAAE,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA,EAC1D,UAAU,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,IAAI,EAAE,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA;AAAA,EAG3D,WAAW,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACxC,iBAAiB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA;AAAA,EAG9C,QAAQ,cAAE,KAAK,CAAC,SAAS,UAAU,UAAU,CAAC,EAAE,SAAS,EAAE,QAAQ,OAAO;AAAA,EAC1E,YAAY,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAChD,WAAW,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC/C,kBAAkB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA;AAAA,EAGrD,YAAY,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACzC,aAAa,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA;AAAA,EAG1C,cAAc,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC3C,aAAa,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,GAAG,EAAE,SAAS;AAClD,CAAC;AAED,IAAM,sBAAsB,oBAAoB,QAAQ;AAUxD,eAAe,IAAI,KAAK,cAAc,oBAAoB,GAAG,OAAO,KAAK,KAAK,SAAS;AACrF,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,UAAM,UAAU,IAAI;AAGpB,UAAM,aAAa,CAAC;AAGpB,eAAW,KAAK,GAAG,SAAS,QAAQ,QAAQ,CAAC;AAE7C,UAAM,SAAS,QAAQ,QAAQ;AAC/B,UAAM,aAAa,QAAQ,YAAY;AAEvC,UAAM,eAAgB,QAAQ,cAAc,KAAK,QAAQ,UAAU;AACnE,UAAM,QAAQ,QAAQ,OAAO;AAC7B,UAAM,WAAW,QAAQ,UAAU;AACnC,UAAM,WAAW,QAAQ,UAAU;AACnC,UAAM,UAAU,QAAQ,SAAS;AACjC,UAAM,aAAa,QAAQ,YAAY;AACvC,UAAM,SAAU,QAAQ,QAAQ,KAAgB;AAChD,UAAM,YAAa,QAAQ,WAAW,KAAgB;AAEtD,QAAI,QAAQ;AACV,iBAAW;AAAA,QACT;AAAA,UACE,MAAM,SAAS,MAAM,IAAI,MAAM,GAAG;AAAA,UAClC,MAAM,SAAS,KAAK,IAAI,MAAM,GAAG;AAAA,QACnC;AAAA,MACF;AAAA,IACF;AAEA,QAAI,YAAY;AACd,iBAAW,KAAK,GAAG,SAAS,YAAY,UAAU,CAAC;AAAA,IACrD;AAGA,QAAI,cAAc;AAChB,YAAM,CAAC,GAAG,IAAI,MAAMA,IAAG,OAAO,EAAE,IAAI,WAAW,GAAG,CAAC,EAChD,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,YAAY,CAAC;AAC1C,UAAI,KAAK;AACP,mBAAW,KAAK,GAAG,SAAS,YAAY,IAAI,EAAE,CAAC;AAAA,MACjD;AAAA,IACF;AAGA,QAAI,OAAO;AACT,iBAAW,KAAK,GAAG,SAAS,OAAO,KAAK,CAAC;AAAA,IAC3C;AAEA,QAAI,UAAU;AACZ,iBAAW,KAAK,IAAI,SAAS,WAAW,QAAQ,CAAC;AAAA,IACnD;AAEA,QAAI,UAAU;AACZ,iBAAW,KAAK,IAAI,SAAS,WAAW,QAAQ,CAAC;AAAA,IACnD;AAEA,QAAI,YAAY,QAAQ;AACtB,iBAAW;AAAA,QACT;AAAA,UACE,MAAM,SAAS,aAAa;AAAA,UAC5B,GAAG,SAAS,gBAAgB,IAAI;AAAA,QAClC;AAAA,MACF;AAAA,IACF;AAEA,QAAI,eAAe,QAAQ;AACzB,iBAAW,KAAK,GAAG,SAAS,YAAY,IAAI,CAAC;AAAA,IAC/C;AAGA,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,QAAQ,EACb,MAAM,IAAI,GAAG,UAAU,CAAC;AAC3B,UAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAGvC,UAAM,gBAA8I;AAAA,MAClJ,MAAM,SAAS;AAAA,MACf,WAAW,SAAS;AAAA,MACpB,WAAW,SAAS;AAAA,MACpB,eAAe,SAAS;AAAA,IAC1B;AACA,UAAM,aAAa,cAAc,MAAM,KAAK,SAAS;AAErD,UAAM,cAAc,MAAMD,IACvB,OAAO;AAAA,MACN,IAAI,SAAS;AAAA,MACb,KAAK,SAAS;AAAA,MACd,MAAM,SAAS;AAAA,MACf,MAAM,SAAS;AAAA,MACf,cAAc,SAAS;AAAA,MACvB,QAAQ,SAAS;AAAA,MACjB,WAAW,SAAS;AAAA,MACpB,gBAAgB,SAAS;AAAA,MACzB,eAAe,SAAS;AAAA,MACxB,mBAAmB,SAAS;AAAA,MAC5B,QAAQ,SAAS;AAAA,MACjB,YAAY,SAAS;AAAA,MACrB,YAAY,SAAS;AAAA,MACrB,cAAc,WAAW;AAAA,MACzB,cAAc,WAAW;AAAA,IAC3B,CAAC,EACA,KAAK,QAAQ,EACb,SAAS,YAAY,GAAG,SAAS,YAAY,WAAW,EAAE,CAAC,EAC3D,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,QAAQ,cAAc,SAAS,KAAK,UAAU,IAAI,IAAI,UAAU,CAAC,EACjE,MAAM,KAAK,EACX,OAAO,MAAM;AAGhB,UAAM,oBAAoB,YAAY,IAAI,QAAM;AAAA,MAC9C,GAAG;AAAA,MACH,WAAW,OAAO,EAAE,SAAS;AAAA,MAC7B,gBAAgB,EAAE,iBAAiB,OAAO,EAAE,cAAc,IAAI;AAAA,MAC9D,QAAQ,EAAE,UAAU,CAAC;AAAA,MACrB,SAAS,EAAE,gBAAgB;AAAA,MAC3B,UAAU,EAAE,cAAc,EAAE,eAAe;AAAA,QACzC,IAAI,EAAE;AAAA,QACN,MAAM,EAAE;AAAA,QACR,MAAM,EAAE;AAAA,MACV,IAAI;AAAA,IACN,EAAE;AAEF,gBAAY,KAAK,mBAAmB,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,EAC3F,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe,IAAI,aAAa,OAAO,KAAK,KAAK,SAAS;AACxD,MAAI;AACF,UAAMD,MAAK,MAAM;AACjB,UAAM,QAAQ,KAAK,IAAI,IAAI,SAAS,IAAI,MAAM,OAAO,KAAe,KAAK,EAAE,CAAC;AAE5E,UAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,MACN,IAAI,SAAS;AAAA,MACb,KAAK,SAAS;AAAA,MACd,MAAM,SAAS;AAAA,MACf,MAAM,SAAS;AAAA,MACf,cAAc,SAAS;AAAA,MACvB,WAAW,SAAS;AAAA,MACpB,gBAAgB,SAAS;AAAA,MACzB,eAAe,SAAS;AAAA,IAC1B,CAAC,EACA,KAAK,QAAQ,EACb,MAAM,IAAI,GAAG,SAAS,QAAQ,QAAQ,GAAG,GAAG,SAAS,YAAY,IAAI,CAAC,CAAC,EACvE,QAAQ,KAAK,SAAS,SAAS,CAAC,EAChC,MAAM,KAAK;AAEd,UAAM,oBAAoB,YAAY,IAAI,QAAM;AAAA,MAC9C,GAAG;AAAA,MACH,WAAW,OAAO,EAAE,SAAS;AAAA,MAC7B,gBAAgB,EAAE,iBAAiB,OAAO,EAAE,cAAc,IAAI;AAAA,MAC9D,SAAS,EAAE,gBAAgB;AAAA,IAC7B,EAAE;AAEF,gBAAY,KAAK,iBAAiB;AAAA,EACpC,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe,IAAI,wBAAwB,OAAO,KAAK,KAAK,SAAS;AACnE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,YAAY,IAAI,OAAO,WAAW;AAGxC,QAAI,CAAC,kEAAkE,KAAK,SAAS,GAAG;AAEtF,aAAO,KAAK;AAAA,IACd;AAGA,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EAAE,IAAI,SAAS,IAAI,MAAM,SAAS,KAAK,CAAC,EAC/C,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,SAAS,CAAC;AAEnC,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAGA,UAAM,WAAW,MAAMA,IACpB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM;AAAA,MACL,GAAG,gBAAgB,WAAW,SAAS;AAAA,MACvC,GAAG,gBAAgB,UAAU,IAAI;AAAA,IACnC,CAAC,EACA,QAAQ,IAAI,gBAAgB,IAAI,CAAC;AAEpC,gBAAY,KAAK,SAAS,IAAI,QAAM;AAAA,MAClC,GAAG;AAAA,MACH,WAAW,OAAO,EAAE,SAAS;AAAA,IAC/B,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe,IAAI,UAAU,OAAO,KAAK,KAAK,SAAS;AACrD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,OAAO,IAAI,OAAO,MAAM;AAE9B,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,MAAM,IAAI,CAAC;AAEhC,QAAI,CAAC,WAAW,QAAQ,WAAW,UAAU;AAC3C,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAGA,QAAI;AACJ,QAAI,QAAQ,YAAY;AACtB,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,EAAE,IAAI,WAAW,IAAI,MAAM,WAAW,MAAM,MAAM,WAAW,KAAK,CAAC,EAC1E,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,QAAQ,UAAU,CAAC;AAAA,IAChD;AAEA,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,WAAW,OAAO,QAAQ,SAAS;AAAA,MACnC,WAAW,QAAQ,YAAY,OAAO,QAAQ,SAAS,IAAI;AAAA,MAC3D,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,MAC1E,SAAS,QAAQ,gBAAgB,KAAK,QAAQ;AAAA,MAC9C;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,eAAe,IAAI,cAAc,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACpF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,EAAE,CAAC;AAE5B,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAGA,QAAI;AACJ,QAAI,QAAQ,YAAY;AACtB,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,EAAE,IAAI,WAAW,IAAI,MAAM,WAAW,MAAM,MAAM,WAAW,KAAK,CAAC,EAC1E,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,QAAQ,UAAU,CAAC;AAAA,IAChD;AAEA,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,WAAW,OAAO,QAAQ,SAAS;AAAA,MACnC,WAAW,QAAQ,YAAY,OAAO,QAAQ,SAAS,IAAI;AAAA,MAC3D,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,MAC1E,QAAQ,QAAQ,SAAS,OAAO,QAAQ,MAAM,IAAI;AAAA,MAClD,SAAS,QAAQ,gBAAgB,KAAK,QAAQ;AAAA,MAC9C;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,YAAM,MAAM,KAAK,OAAO,YAAY;AAGpC,YAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,IAAI,SAAS,GAAG,CAAC,EAC1B,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,GAAG,CAAC;AAE9B,UAAI,aAAa;AACf,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,UAAI,OAAO,KAAK,QAAQ,aAAa,KAAK,IAAI;AAG9C,YAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EAAE,IAAI,SAAS,GAAG,CAAC,EAC1B,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,MAAM,IAAI,CAAC;AAEhC,UAAI,cAAc;AAChB,eAAO,GAAG,IAAI,IAAI,KAAK,IAAI,CAAC;AAAA,MAC9B;AAGA,YAAM,eAAe,MAAMA,IACxB,OAAO,QAAQ,EACf,OAAO;AAAA,QACN,GAAG;AAAA,QACH;AAAA,QACA;AAAA,QACA,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,KAAK,YAAY,OAAO,KAAK,SAAS,IAAI;AAAA,QACrD,gBAAgB,KAAK,iBAAiB,OAAO,KAAK,cAAc,IAAI;AAAA,QACpE,QAAQ,KAAK,SAAS,OAAO,KAAK,MAAM,IAAI;AAAA,QAC5C,YAAY,KAAK,cAAc;AAAA,QAC/B,cAAc,KAAK,gBAAgB;AAAA,MACrC,CAAC,EACA,UAAU;AAEb,YAAM,UAAU,aAAa,CAAC;AAC9B,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,MAAM,0BAA0B;AAAA,MAC5C;AAGA,UAAI;AACF,YAAI,MAAM,cAAc,YAAY,GAAG;AAErC,cAAI,eAAe;AACnB,cAAI,oBAAoB;AACxB,cAAI,QAAQ,YAAY;AACtB,kBAAM,CAAC,GAAG,IAAI,MAAMA,IAAG,OAAO,EAAE,MAAM,WAAW,MAAM,MAAM,WAAW,KAAK,CAAC,EAC3E,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,QAAQ,UAAU,CAAC;AAC9C,gBAAI,KAAK;AACP,6BAAe,IAAI;AACnB,kCAAoB,IAAI;AAAA,YAC1B;AAAA,UACF;AAEA,gBAAM,cAAc,aAAa;AAAA,YAC/B,IAAI,QAAQ;AAAA,YACZ,KAAK,QAAQ;AAAA,YACb,MAAM,QAAQ;AAAA,YACd,MAAM,QAAQ;AAAA,YACd,aAAa,QAAQ;AAAA,YACrB,kBAAkB,QAAQ;AAAA,YAC1B,OAAO,QAAQ;AAAA,YACf,YAAY,QAAQ;AAAA,YACpB;AAAA,YACA,cAAc;AAAA,YACd,WAAW,OAAO,QAAQ,SAAS;AAAA,YACnC,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,YAC1E,eAAe,QAAQ;AAAA,YACvB,SAAS,QAAQ,gBAAgB,KAAK,QAAQ;AAAA,YAC9C,YAAY,QAAQ;AAAA,YACpB,MAAM,QAAQ,QAAoB,CAAC;AAAA,YACnC,cAAc,QAAQ;AAAA,YACtB,QAAQ,QAAQ,UAAkD,CAAC;AAAA,YACnE,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,YAC/C,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,UACjD,CAAC;AAAA,QACH;AAAA,MACF,SAAS,GAAG;AACV,eAAO,MAAM,qCAAqC,EAAE,OAAO,GAAG,WAAW,QAAQ,GAAG,CAAC;AAAA,MACvF;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,WAAW,OAAO,QAAQ,SAAS;AAAA,QACnC,WAAW,QAAQ,YAAY,OAAO,QAAQ,SAAS,IAAI;AAAA,QAC3D,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,QAC1E,QAAQ,QAAQ,SAAS,OAAO,QAAQ,MAAM,IAAI;AAAA,MACpD,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,EAAE,CAAC;AAE5B,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAGA,YAAM,aAAsC;AAAA,QAC1C,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB;AAGA,UAAI,KAAK,cAAc,QAAW;AAChC,mBAAW,WAAW,IAAI,OAAO,KAAK,SAAS;AAAA,MACjD;AACA,UAAI,KAAK,cAAc,QAAW;AAChC,mBAAW,WAAW,IAAI,KAAK,YAAY,OAAO,KAAK,SAAS,IAAI;AAAA,MACtE;AACA,UAAI,KAAK,mBAAmB,QAAW;AACrC,mBAAW,gBAAgB,IAAI,KAAK,iBAAiB,OAAO,KAAK,cAAc,IAAI;AAAA,MACrF;AACA,UAAI,KAAK,WAAW,QAAW;AAC7B,mBAAW,QAAQ,IAAI,KAAK,SAAS,OAAO,KAAK,MAAM,IAAI;AAAA,MAC7D;AAEA,UAAI,KAAK,eAAe,QAAW;AACjC,mBAAW,YAAY,IAAI,KAAK,cAAc;AAAA,MAChD;AACA,UAAI,KAAK,iBAAiB,QAAW;AACnC,mBAAW,cAAc,IAAI,KAAK,gBAAgB;AAAA,MACpD;AAEA,YAAM,eAAe,MAAMA,IACxB,OAAO,QAAQ,EACf,IAAI,UAAU,EACd,MAAM,GAAG,SAAS,IAAI,EAAE,CAAC,EACzB,UAAU;AAEb,YAAM,UAAU,aAAa,CAAC;AAC9B,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAGA,UAAI;AACF,YAAI,MAAM,cAAc,YAAY,GAAG;AAErC,cAAI,eAAe;AACnB,cAAI,oBAAoB;AACxB,cAAI,QAAQ,YAAY;AACtB,kBAAM,CAAC,GAAG,IAAI,MAAMA,IAAG,OAAO,EAAE,MAAM,WAAW,MAAM,MAAM,WAAW,KAAK,CAAC,EAC3E,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,QAAQ,UAAU,CAAC;AAC9C,gBAAI,KAAK;AACP,6BAAe,IAAI;AACnB,kCAAoB,IAAI;AAAA,YAC1B;AAAA,UACF;AAEA,gBAAM,cAAc,cAAc;AAAA,YAChC,IAAI,QAAQ;AAAA,YACZ,KAAK,QAAQ;AAAA,YACb,MAAM,QAAQ;AAAA,YACd,MAAM,QAAQ;AAAA,YACd,aAAa,QAAQ;AAAA,YACrB,kBAAkB,QAAQ;AAAA,YAC1B,OAAO,QAAQ;AAAA,YACf,YAAY,QAAQ;AAAA,YACpB;AAAA,YACA,cAAc;AAAA,YACd,WAAW,OAAO,QAAQ,SAAS;AAAA,YACnC,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,YAC1E,eAAe,QAAQ;AAAA,YACvB,SAAS,QAAQ,gBAAgB,KAAK,QAAQ;AAAA,YAC9C,YAAY,QAAQ;AAAA,YACpB,MAAM,QAAQ,QAAoB,CAAC;AAAA,YACnC,cAAc,QAAQ;AAAA,YACtB,QAAQ,QAAQ,UAAkD,CAAC;AAAA,YACnE,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,YAC/C,WAAW,IAAI,KAAK,QAAQ,SAAS,EAAE,QAAQ;AAAA,UACjD,CAAC;AAAA,QACH;AAAA,MACF,SAAS,GAAG;AACV,eAAO,MAAM,sCAAsC,EAAE,OAAO,GAAG,WAAW,QAAQ,GAAG,CAAC;AAAA,MACxF;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,WAAW,OAAO,QAAQ,SAAS;AAAA,QACnC,WAAW,QAAQ,YAAY,OAAO,QAAQ,SAAS,IAAI;AAAA,QAC3D,gBAAgB,QAAQ,iBAAiB,OAAO,QAAQ,cAAc,IAAI;AAAA,QAC1E,QAAQ,QAAQ,SAAS,OAAO,QAAQ,MAAM,IAAI;AAAA,MACpD,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACjF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,SAAS,GAAG,CAAC,EAC1B,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,EAAE,CAAC;AAE5B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAEA,UAAMA,IAAG,OAAO,QAAQ,EAAE,MAAM,GAAG,SAAS,IAAI,EAAE,CAAC;AAGnD,QAAI;AACF,UAAI,MAAM,cAAc,YAAY,GAAG;AACrC,cAAM,cAAc,cAAc,EAAE;AAAA,MACtC;AAAA,IACF,SAAS,GAAG;AACV,aAAO,MAAM,wCAAwC,EAAE,OAAO,GAAG,WAAW,GAAG,CAAC;AAAA,IAClF;AAEA,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACzqBD,IAAAE,kBAAuB;AACvB,IAAAC,cAAkB;AAQX,IAAM,uBAAmB,wBAAO;AAMvC,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,MAAM,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACnC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,EACjC,UAAU,cAAE,OAAO,EAAE,IAAI,EAAE,SAAS;AAAA,EACpC,UAAU,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACrC,UAAU,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EAC7C,WAAW,cAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC;AACzD,CAAC;AAED,IAAM,uBAAuB,qBAAqB,QAAQ;AAU1D,iBAAiB,IAAI,KAAK,OAAO,MAAM,KAAK,SAAS;AACnD,MAAI;AACF,UAAMC,MAAK,MAAM;AAGjB,UAAM,eAAe,MAAMA,IACxB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,UAAU,IAAI,CAAC,EACnC,QAAQ,WAAW,SAAS;AAG/B,UAAM,iBAAiB,aAAa,OAAO,OAAK,CAAC,EAAE,QAAQ;AAC3D,UAAM,cAAc,IAAI,IAAI,aAAa,IAAI,OAAK,CAAC,EAAE,IAAI,EAAE,GAAG,GAAG,UAAU,CAAC,EAAyB,CAAC,CAAC,CAAC;AAExG,eAAW,YAAY,cAAc;AACnC,UAAI,SAAS,UAAU;AACrB,cAAM,SAAS,YAAY,IAAI,SAAS,QAAQ;AAChD,YAAI,QAAQ;AACV,iBAAO,SAAS,KAAK,YAAY,IAAI,SAAS,EAAE,CAAE;AAAA,QACpD;AAAA,MACF;AAAA,IACF;AAEA,UAAM,yBAAyB,eAAe,IAAI,OAAK,YAAY,IAAI,EAAE,EAAE,CAAE;AAE7E,gBAAY,KAAK,sBAAsB;AAAA,EACzC,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,UAAU,OAAO,KAAK,KAAK,SAAS;AACvD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,OAAO,IAAI,OAAO,MAAM;AAE9B,UAAM,iBAAiB,MAAMA,IAC1B,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,IAAI,CAAC;AAElC,UAAM,WAAW,eAAe,CAAC;AAEjC,QAAI,CAAC,YAAY,CAAC,SAAS,UAAU;AACnC,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,YAAY,SAAS,EAAE,CAAC;AAE7C,UAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAGvC,UAAM,gBAAgB,MAAMD,IACzB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,UAAU,SAAS,EAAE,CAAC;AAE7C,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,cAAc,OAAOC,MAAK;AAAA,MAC1B,UAAU;AAAA,IACZ,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMD,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,UAAI,OAAO,KAAK,QAAQ,aAAa,KAAK,IAAI;AAG9C,YAAM,qBAAqB,MAAMA,IAC9B,OAAO,EAAE,IAAI,WAAW,GAAG,CAAC,EAC5B,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,IAAI,CAAC;AAElC,YAAM,eAAe,mBAAmB,CAAC;AAEzC,UAAI,cAAc;AAChB,eAAO,GAAG,IAAI,IAAI,KAAK,IAAI,CAAC;AAAA,MAC9B;AAGA,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,UAAU,EACjB,OAAO;AAAA,QACN,GAAG;AAAA,QACH;AAAA,MACF,CAAC,EACA,UAAU;AAEb,YAAM,WAAW,eAAe,CAAC;AAEjC,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,YAAM,WAAW,eAAe,CAAC;AAEjC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAEA,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,UAAU,EACjB,IAAI;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC,EAC3B,UAAU;AAEb,YAAM,WAAW,eAAe,CAAC;AAEjC,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACnF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,iBAAiB,MAAMA,IAC1B,OAAO,EAAE,IAAI,WAAW,GAAG,CAAC,EAC5B,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,UAAM,WAAW,eAAe,CAAC;AAEjC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAMA,IACH,OAAO,QAAQ,EACf,IAAI,EAAE,YAAY,KAAK,CAAC,EACxB,MAAM,GAAG,SAAS,YAAY,EAAE,CAAC;AAGpC,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI,EAAE,UAAU,KAAK,CAAC,EACtB,MAAM,GAAG,WAAW,UAAU,EAAE,CAAC;AAEpC,UAAMA,IAAG,OAAO,UAAU,EAAE,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAEvD,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACpPD,IAAAE,kBAAuB;AACvB,IAAAC,cAAkB;AAQlB,IAAAC,eAA6B;AAEtB,IAAM,iBAAa,wBAAO;AAGjC,WAAW,IAAI,YAAY;AAM3B,IAAM,kBAAkB,cAAE,OAAO;AAAA,EAC/B,WAAW,cAAE,OAAO,EAAE,KAAK;AAAA,EAC3B,WAAW,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACtC,UAAU,cAAE;AAAA,IACV,CAAC,QAAS,OAAO,QAAQ,WAAW,SAAS,KAAK,EAAE,IAAI;AAAA,IACxD,cAAE,OAAO,EACN,IAAI,iCAAiC,EACrC,SAAS,2BAA2B,EACpC,IAAI,GAAG,6BAA6B,EACpC,IAAI,MAAM,6BAA6B;AAAA,EAC5C;AACF,CAAC;AAED,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,UAAU,cAAE;AAAA,IACV,CAAC,QAAS,OAAO,QAAQ,WAAW,SAAS,KAAK,EAAE,IAAI;AAAA,IACxD,cAAE,OAAO,EACN,IAAI,iCAAiC,EACrC,SAAS,2BAA2B,EACpC,IAAI,GAAG,6BAA6B,EACpC,IAAI,MAAM,6BAA6B;AAAA,EAC5C;AACF,CAAC;AAED,IAAM,mBAAmB,cAAE,OAAO;AAAA,EAChC,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,EAAE;AAChC,CAAC;AAMD,eAAe,gBAAgB,QAAiB,WAAwD;AACtG,QAAMC,MAAK,MAAM;AAGjB,MAAI;AAEJ,MAAI,QAAQ;AACV,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,YAAY,MAAM,CAAC;AACrC,WAAO;AAAA,EACT,WAAW,WAAW;AACpB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,WAAW,SAAS,CAAC;AACvC,WAAO;AAAA,EACT;AAGA,MAAI,CAAC,MAAM;AACT,UAAM,eAAe,iBAAa,aAAAC,IAAO;AACzC,UAAM,CAAC,OAAO,IAAI,MAAMD,IACrB,OAAO,KAAK,EACZ,OAAO;AAAA,MACN,YAAY;AAAA,MACZ,WAAW,SAAS,SAAY;AAAA,IAClC,CAAC,EACA,UAAU;AACb,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,MAAM,uBAAuB;AAAA,IACzC;AACA,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAEA,eAAe,aAAa,QAAgB;AAC1C,QAAMA,MAAK,MAAM;AAEjB,SAAOA,IACJ,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,QAAQ,MAAM,CAAC;AACvC;AAUA,WAAW,IAAI,KAAK,OAAO,KAAK,KAAK,SAAS;AAC5C,MAAI;AACF,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AAEzB,aAAO,YAAY,KAAK;AAAA,QACtB,IAAI;AAAA,QACJ,OAAO,CAAC;AAAA,QACR,WAAW;AAAA,MACb,CAAC;AAAA,IACH;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AACpD,UAAM,QAAQ,MAAM,aAAa,KAAK,EAAE;AAExC,gBAAY,KAAK;AAAA,MACf,IAAI,KAAK;AAAA,MACT,WAAW,KAAK;AAAA,MAChB;AAAA,MACA,WAAW,MAAM,OAAO,CAACE,MAAK,SAASA,OAAM,KAAK,UAAU,CAAC;AAAA,IAC/D,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,IAAI,cAAc,OAAO,KAAK,KAAK,SAAS;AACrD,MAAI;AACF,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,aAAO,YAAY,KAAK;AAAA,QACtB,OAAO,CAAC;AAAA,QACR,WAAW;AAAA,QACX,UAAU;AAAA,QACV,SAAS;AAAA;AAAA,QACT,WAAW;AAAA,QACX,gBAAgB;AAAA,QAChB,gBAAgB;AAAA,QAChB,OAAO;AAAA,QACP,UAAU;AAAA,MACZ,CAAC;AAAA,IACH;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AACpD,UAAM,QAAQ,MAAM,aAAa,KAAK,EAAE;AAExC,QAAI,MAAM,WAAW,GAAG;AACtB,aAAO,YAAY,KAAK;AAAA,QACtB,OAAO,CAAC;AAAA,QACR,WAAW;AAAA,QACX,UAAU;AAAA,QACV,SAAS;AAAA;AAAA,QACT,WAAW;AAAA,QACX,gBAAgB;AAAA,QAChB,gBAAgB;AAAA,QAChB,OAAO;AAAA,QACP,UAAU;AAAA,MACZ,CAAC;AAAA,IACH;AAGA,UAAMF,MAAK,MAAM;AACjB,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAG3C,UAAM,YAAY,MAAM,IAAI,WAAS;AAAA,MACnC,IAAI,KAAK;AAAA;AAAA,MACT,WAAW,KAAK;AAAA,MAChB,WAAW,KAAK,aAAa;AAAA,MAC7B,UAAU,KAAK;AAAA,IACjB,EAAE;AAEF,UAAM,cAAc,MAAM,eAAe;AAAA,MACvC;AAAA,MACA,WAAW;AAAA,IACb;AAEA,gBAAY,KAAK,WAAW;AAAA,EAC9B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,KAAK,UAAU,aAAa,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AACjF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc,SAAe,aAAAC,IAAO;AACnF,UAAM,EAAE,WAAW,WAAW,SAAS,IAAI,IAAI;AAG/C,UAAM,CAAC,OAAO,IAAI,MAAMD,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,SAAS,CAAC;AAEnC,QAAI,CAAC,WAAW,QAAQ,WAAW,UAAU;AAC3C,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAGA,QAAI,WAAW;AACb,YAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,IAAI,SAAS,CAAC;AAE1C,UAAI,CAAC,WAAW,CAAC,QAAQ,UAAU;AACjC,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAAA,IACF;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AAGpD,UAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EACP,KAAK,SAAS,EACd;AAAA,MACC;AAAA,QACE,GAAG,UAAU,QAAQ,KAAK,EAAE;AAAA,QAC5B,GAAG,UAAU,WAAW,SAAS;AAAA,QACjC,YAAY,GAAG,UAAU,WAAW,SAAS,IAAI,OAAO,UAAU,SAAS;AAAA,MAC7E;AAAA,IACF;AAEF,QAAI;AAEJ,QAAI,cAAc;AAEhB,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,UAAU,aAAa,WAAW;AAAA,QAClC,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,aAAa,EAAE,CAAC,EACvC,UAAU;AAAA,IACf,OAAO;AAEL,YAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,SAAS,EAChB,OAAO;AAAA,QACN,QAAQ,KAAK;AAAA,QACb;AAAA,QACA;AAAA,QACA;AAAA,MACF,CAAC,EACA,UAAU;AACb,iBAAW;AAAA,IACb;AAEA,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,MAAM,4BAA4B;AAAA,IAC9C;AAEA,gBAAY,KAAK;AAAA,MACf,IAAI,SAAS;AAAA,MACb,QAAQ,KAAK;AAAA,MACb,WAAW,KAAK;AAAA,MAChB,WAAW,SAAS;AAAA,MACpB,WAAW,SAAS;AAAA,MACpB,UAAU,SAAS;AAAA,IACrB,GAAG,GAAG;AAAA,EACR,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,IAAI,cAAc,aAAa,oBAAoB,GAAG,OAAO,KAAK,KAAK,SAAS;AACzF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,EAAE,SAAS,IAAI,IAAI;AAGzB,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AAGpD,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM;AAAA,MACL,GAAG,UAAU,IAAI,EAAE;AAAA,MACnB,GAAG,UAAU,QAAQ,KAAK,EAAE;AAAA,IAC9B,CAAC;AAEH,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,kCAAkC;AAAA,QAC5C,aAAa;AAAA,QACb,QAAQ,KAAK;AAAA,QACb,QAAQ,IAAI,MAAM;AAAA,QAClB,WAAW,IAAI,aAAa,IAAI,QAAQ,cAAc;AAAA,QACtD,aAAa,IAAI;AAAA,MACnB,CAAC;AACD,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,SAAS,EAChB,IAAI;AAAA,MACH;AAAA,MACA,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC,EAC1B,UAAU;AAEb,gBAAY,KAAK,OAAO;AAAA,EAC1B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,OAAO,cAAc,OAAO,KAAK,KAAK,SAAS;AACxD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAG1B,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AAGpD,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM;AAAA,MACL,GAAG,UAAU,IAAI,EAAE;AAAA,MACnB,GAAG,UAAU,QAAQ,KAAK,EAAE;AAAA,IAC9B,CAAC;AAEH,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,oCAAoC;AAAA,QAC9C,aAAa;AAAA,QACb,QAAQ,KAAK;AAAA,QACb,QAAQ,IAAI,MAAM;AAAA,QAClB,WAAW,IAAI,aAAa,IAAI,QAAQ,cAAc;AAAA,MACxD,CAAC;AACD,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAMA,IAAG,OAAO,SAAS,EAAE,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAErD,WAAO,KAAK,qBAAqB;AAAA,MAC/B,YAAY;AAAA,MACZ,WAAW,SAAS;AAAA,MACpB,UAAU,SAAS;AAAA,MACnB,QAAQ,IAAI,MAAM;AAAA,IACpB,CAAC;AAED,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,KAAK,gBAAgB,aAAa,gBAAgB,GAAG,OAAO,KAAK,KAAK,SAAS;AACxF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAC7D,UAAM,EAAE,KAAK,IAAI,IAAI;AAErB,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,YAAM,IAAI,gBAAgB,gBAAgB;AAAA,IAC5C;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AACpD,UAAM,QAAQ,MAAM,aAAa,KAAK,EAAE;AAExC,QAAI,MAAM,WAAW,GAAG;AACtB,YAAM,IAAI,gBAAgB,eAAe;AAAA,IAC3C;AAGA,UAAM,YAAY,MAAM,IAAI,WAAS;AAAA,MACnC,WAAW,KAAK;AAAA,MAChB,WAAW,KAAK,aAAa;AAAA,MAC7B,UAAU,KAAK;AAAA,IACjB,EAAE;AAGF,UAAM,cAAc,MAAM,eAAe,cAAc,WAAW,IAAI;AAGtE,QAAI,CAAC,YAAY,aAAa;AAC5B,YAAM,IAAI,gBAAgB,+BAA+B;AAAA,IAC3D;AAIA,QAAI,YAAY,mBAAmB,KAAK,YAAY,WAAW;AAC7D,YAAM,IAAI;AAAA,QACR;AAAA,MAEF;AAAA,IACF;AAGA,UAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAGxE,UAAMA,IAAG,OAAO,cAAc,EAAE,OAAO;AAAA,MACrC,QAAQ,KAAK;AAAA,MACb,aAAa,YAAY;AAAA,MACzB,MAAM,YAAY;AAAA,IACpB,CAAC;AAED,gBAAY,KAAK,WAAW;AAAA,EAC9B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,OAAO,UAAU,OAAO,KAAK,KAAK,SAAS;AACpD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,YAAM,IAAI,gBAAgB,gBAAgB;AAAA,IAC5C;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AAEpD,UAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAExE,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,KAAK,UAAU,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,SAAS,IAAI,MAAM;AACzB,UAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAE7D,QAAI,CAAC,UAAU,CAAC,WAAW;AACzB,aAAO,YAAY,KAAK,EAAE,SAAS,MAAM,cAAc,EAAE,CAAC;AAAA,IAC5D;AAEA,UAAM,OAAO,MAAM,gBAAgB,QAAQ,SAAS;AAGpD,UAAM,UAAU,MAAMA,IAAG,OAAO,SAAS,EAAE,MAAM,GAAG,UAAU,QAAQ,KAAK,EAAE,CAAC,EAAE,UAAU;AAG1F,UAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAExE,WAAO,KAAK,gBAAgB;AAAA,MAC1B,QAAQ,KAAK;AAAA,MACb,cAAc,QAAQ;AAAA,MACtB,QAAQ,IAAI,MAAM;AAAA,IACpB,CAAC;AAED,gBAAY,KAAK,EAAE,SAAS,MAAM,cAAc,QAAQ,OAAO,CAAC;AAAA,EAClE,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACtgBD,IAAAG,kBAAuB;AACvB,IAAAC,cAAkB;;;AC4ClB,IAAM,wBAAN,MAA4B;AAAA;AAAA;AAAA;AAAA,EAI1B,+BAA+B,MAA8B;AAC3D,UAAM,YAAY,KAAK,MACpB;AAAA,MACC,CAAC,SAAS;AAAA;AAAA;AAAA,oBAGE,KAAK,WAAW,KAAK,WAAW,CAAC;AAAA,gEACW,KAAK,WAAW,KAAK,GAAG,CAAC;AAAA;AAAA;AAAA,YAG7E,KAAK,QAAQ;AAAA;AAAA;AAAA,YAGb,KAAK,eAAe,KAAK,WAAW,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,IAIxD,EACC,KAAK,EAAE;AAEV,UAAM,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yFAgBqE,KAAK,WAAW,KAAK,WAAW,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAkB1G,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gFAYuD,KAAK,eAAe,KAAK,UAAU,KAAK,QAAQ,CAAC;AAAA;AAAA,cAGnH,KAAK,iBAAiB,IAClB;AAAA;AAAA;AAAA,2BAGS,KAAK,YAAY,IAAI,KAAK,WAAW,KAAK,SAAS,CAAC,MAAM,EAAE;AAAA;AAAA,iFAEN,KAAK,eAAe,KAAK,gBAAgB,KAAK,QAAQ,CAAC;AAAA;AAAA,gBAGtH,EACN;AAAA;AAAA,mEAEuD,KAAK,UAAU,KAAK,QAAQ,CAAC,CAAC;AAAA,gFACjB,KAAK,eAAe,KAAK,WAAW,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,kBAKhH,KAAK,iBAAiB,IAAI,KAAK,eAAe,KAAK,gBAAgB,KAAK,QAAQ,IAAI,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAM1F,KAAK,eAAe,KAAK,OAAO,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAwBlD,KAAK,cAAc,KAAK,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,QAM9C,KAAK,gBACD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAME,KAAK,WAAW,KAAK,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,UAKrC,EACN;AAAA;AAGF,WAAO,KAAK,oBAAoB,SAAS,yBAAyB,KAAK,WAAW,EAAE;AAAA,EACtF;AAAA;AAAA;AAAA;AAAA,EAKA,kCAAkC,MAA8B;AAC9D,UAAM,YAAY,KAAK,MACpB;AAAA,MACC,CAAC,SAAS;AAAA;AAAA;AAAA,oBAGE,KAAK,WAAW,KAAK,WAAW,CAAC;AAAA,gEACW,KAAK,WAAW,KAAK,GAAG,CAAC;AAAA;AAAA;AAAA,YAG7E,KAAK,QAAQ;AAAA;AAAA;AAAA,YAGb,KAAK,eAAe,KAAK,WAAW,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,IAIxD,EACC,KAAK,EAAE;AAEV,UAAM,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gDAO4B,KAAK,WAAW,KAAK,WAAW,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAM3D,KAAK,WAAW,KAAK,YAAY,CAAC;AAAA,cAC1C,KAAK,WAAW,KAAK,aAAa,CAAC;AAAA,cACnC,KAAK,WAAW,KAAK,gBAAgB,KAAK,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAazC,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA,qBAKJ,KAAK,eAAe,KAAK,OAAO,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAWrD,KAAK,cAAc,KAAK,eAAe,CAAC;AAAA;AAAA;AAAA,YAI1C,KAAK,gBACD;AAAA;AAAA;AAAA,cAGF,KAAK,WAAW,KAAK,aAAa,CAAC;AAAA;AAAA,cAGjC,EACN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWN,WAAO,KAAK,oBAAoB,SAAS,eAAe,KAAK,WAAW,EAAE;AAAA,EAC5E;AAAA;AAAA;AAAA;AAAA,EAKQ,oBAAoB,SAAiB,OAAuB;AAClE,WAAO;AAAA;AAAA;AAAA;AAAA;AAAA,WAKA,KAAK,WAAW,KAAK,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAgBrB,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoBjB;AAAA;AAAA;AAAA;AAAA,EAKQ,eAAe,QAAgB,UAA0B;AAE/D,WAAO,IAAI,OAAO,QAAQ,CAAC,CAAC;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKQ,cAAc,SAA8B;AAClD,UAAM,QAAkB,CAAC;AAEzB,UAAM,KAAK,WAAW,KAAK,WAAW,QAAQ,SAAS,CAAC,IAAI,KAAK,WAAW,QAAQ,QAAQ,CAAC,WAAW;AACxG,UAAM,KAAK,KAAK,WAAW,QAAQ,YAAY,CAAC;AAEhD,QAAI,QAAQ,cAAc;AACxB,YAAM,KAAK,KAAK,WAAW,QAAQ,YAAY,CAAC;AAAA,IAClD;AAEA,UAAM,gBAA0B,CAAC;AACjC,kBAAc,KAAK,KAAK,WAAW,QAAQ,IAAI,CAAC;AAChD,QAAI,QAAQ,OAAO;AACjB,oBAAc,KAAK,KAAK,WAAW,QAAQ,KAAK,CAAC;AAAA,IACnD;AACA,QAAI,QAAQ,YAAY;AACtB,oBAAc,KAAK,KAAK,WAAW,QAAQ,UAAU,CAAC;AAAA,IACxD;AACA,UAAM,KAAK,cAAc,KAAK,IAAI,CAAC;AAEnC,UAAM,KAAK,KAAK,WAAW,QAAQ,OAAO,CAAC;AAC3C,UAAM,KAAK,KAAK,WAAW,QAAQ,KAAK,CAAC;AAEzC,WAAO,MAAM,KAAK,MAAM;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA,EAKQ,WAAWC,OAAsB;AACvC,UAAM,MAAiC;AAAA,MACrC,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AACA,WAAOA,MAAK,QAAQ,YAAY,CAACC,UAAS,IAAIA,KAAI,KAAKA,KAAI;AAAA,EAC7D;AACF;AAEO,IAAM,wBAAwB,IAAI,sBAAsB;;;ADhXxD,IAAM,mBAAe,wBAAO;AAMnC,IAAM,gBAAgB,cAAE,OAAO;AAAA,EAC7B,WAAW,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACpC,UAAU,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACnC,SAAS,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACtC,cAAc,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACvC,cAAc,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC3C,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,OAAO,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACpC,YAAY,cAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA,EACxC,SAAS,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAClC,OAAO,cAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AACrC,CAAC;AAED,IAAM,oBAAoB,cAAE,OAAO;AAAA,EACjC,iBAAiB;AAAA,EACjB,gBAAgB,cAAc,SAAS;AAAA,EACvC,gBAAgB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EACnD,eAAe,cAAE,OAAO,EAAE,MAAM;AAAA,EAChC,eAAe,cAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC7C,eAAe,cAAE,KAAK,CAAC,KAAK,CAAC,EAAE,QAAQ,KAAK;AAC9C,CAAC;AAED,IAAM,oBAAoB,cAAE,OAAO;AAAA,EACjC,QAAQ,cAAE,KAAK,CAAC,WAAW,aAAa,cAAc,WAAW,aAAa,WAAW,CAAC,EAAE,SAAS;AAAA,EACrG,eAAe,cAAE,KAAK,CAAC,WAAW,QAAQ,YAAY,QAAQ,CAAC,EAAE,SAAS;AAAA,EAC1E,gBAAgB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC7C,gBAAgB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC7C,YAAY,cAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC1C,iBAAiB,cAAc,SAAS;AAAA,EACxC,gBAAgB,cAAc,SAAS;AACzC,CAAC;AAED,IAAM,qBAAqB,cAAE,OAAO;AAAA,EAClC,MAAM,cAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,cAAE,KAAK,CAAC,WAAW,aAAa,cAAc,WAAW,aAAa,WAAW,CAAC,EAAE,SAAS;AAAA,EACrG,eAAe,cAAE,KAAK,CAAC,WAAW,QAAQ,YAAY,QAAQ,CAAC,EAAE,SAAS;AAAA,EAC1E,QAAQ,cAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAUD,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,iBAAiB;AAAA,EAC9B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,SAAS,IAAI,MAAM;AACzB,YAAM,YAAY,IAAI,aAAa,IAAI,QAAQ,cAAc;AAC7D,YAAM,OAAO,IAAI;AAEjB,UAAI,CAAC,UAAU,CAAC,WAAW;AACzB,cAAM,IAAI,gBAAgB,eAAe;AAAA,MAC3C;AAGA,UAAI;AACJ,UAAI,QAAQ;AACV,SAAC,IAAI,IAAI,MAAMA,IAAG,OAAO,EAAE,KAAK,KAAK,EAAE,MAAM,GAAG,MAAM,YAAY,MAAM,CAAC;AAAA,MAC3E,WAAW,WAAW;AACpB,SAAC,IAAI,IAAI,MAAMA,IAAG,OAAO,EAAE,KAAK,KAAK,EAAE,MAAM,GAAG,MAAM,WAAW,SAAS,CAAC;AAAA,MAC7E;AAEA,UAAI,CAAC,MAAM;AACT,cAAM,IAAI,gBAAgB,gBAAgB;AAAA,MAC5C;AAGA,YAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,QAAQ,KAAK,EAAE,CAAC;AAEtC,UAAI,MAAM,WAAW,GAAG;AACtB,cAAM,IAAI,gBAAgB,eAAe;AAAA,MAC3C;AAGA,YAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAG3C,YAAM,YAAY,MAAM,IAAI,WAAS;AAAA,QACnC,WAAW,KAAK;AAAA,QAChB,WAAW,KAAK,aAAa;AAAA,QAC7B,UAAU,KAAK;AAAA,MACjB,EAAE;AAEF,YAAM,SAAS,MAAM,eAAe;AAAA,QAClC;AAAA,QACA,WAAW;AAAA,MACb;AAGA,UAAI;AACJ,UAAI,QAAQ;AACV,SAAC,QAAQ,IAAI,MAAMA,IAAG,OAAO,EAAE,KAAK,SAAS,EAAE,MAAM,GAAG,UAAU,IAAI,MAAM,CAAC;AAAA,MAC/E,OAAO;AAEL,SAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,SAAS,EAChB,OAAO;AAAA,UACN,OAAO,KAAK,cAAc,YAAY;AAAA,UACtC,WAAW,KAAK,gBAAgB;AAAA,UAChC,UAAU,KAAK,gBAAgB;AAAA,UAC/B,OAAO,KAAK,gBAAgB;AAAA,UAC5B,SAAS;AAAA,QACX,CAAC,EACA,UAAU;AAAA,MACf;AAGA,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM;AACd,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AACvC,YAAM,cAAc,oBAAoB,OAAOA,MAAK,IAAI,CAAC;AAGzD,YAAM,iBAAiB,KAAK,iBACxB,KAAK,kBACL,KAAK,kBAAkB,KAAK;AAEhC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,gBAAgB,mCAAmC;AAAA,MAC/D;AAGA,YAAM,cAAc,MAAMD,IACvB,OAAO,MAAM,EACb,OAAO;AAAA,QACN;AAAA,QACA,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR,eAAe;AAAA,QACf,iBAAiB,KAAK;AAAA,QACtB;AAAA,QACA,UAAU;AAAA,QACV,kBAAkB,OAAO,OAAO,QAAQ;AAAA,QACxC,iBAAiB,OAAO,OAAO,OAAO;AAAA,QACtC,mBAAmB,OAAO,OAAO,SAAS;AAAA,QAC1C,wBAAwB,OAAO,OAAO,cAAc;AAAA,QACpD,wBAAwB,OAAO,OAAO,cAAc;AAAA,QACpD,eAAe,OAAO,OAAO,KAAK;AAAA,QAClC,aAAa,OAAO;AAAA,QACpB,mBAAmB,OAAO;AAAA,QAC1B,eAAe,KAAK;AAAA,QACpB,eAAe,KAAK;AAAA,MACtB,CAAC,EACA,UAAU;AACb,YAAM,QAAQ,YAAY,CAAC;AAE3B,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,gBAAgB,wBAAwB;AAAA,MACpD;AAGA,iBAAW,QAAQ,OAAO;AACxB,cAAM,gBAAgB,MAAMA,IACzB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AACxC,cAAM,UAAU,cAAc,CAAC;AAE/B,YAAI,CAAC,SAAS;AACZ,gBAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,QAClE;AAEA,YAAI;AACJ,YAAI,KAAK,WAAW;AAClB,gBAAM,gBAAgB,MAAMA,IACzB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAC/C,oBAAU,cAAc,CAAC;AAAA,QAC3B;AAEA,cAAM,YAAY,UAAU,OAAO,QAAQ,SAAS,IAAI,OAAO,QAAQ,SAAS;AAEhF,cAAMA,IAAG,OAAO,UAAU,EAAE,OAAO;AAAA,UACjC,SAAS,MAAM;AAAA,UACf,WAAW,KAAK;AAAA,UAChB,WAAW,KAAK;AAAA,UAChB,qBAAqB,QAAQ;AAAA,UAC7B,aAAa,SAAS,OAAO,QAAQ;AAAA,UACrC,wBAAwB,SAAS;AAAA,UACjC,UAAU,KAAK;AAAA,UACf,mBAAmB,OAAO,SAAS;AAAA,QACrC,CAAC;AAAA,MACH;AAGA,iBAAW,QAAQ,OAAO;AACxB,YAAI,KAAK,WAAW;AAElB,gBAAMA,IACH,OAAO,eAAe,EACtB,IAAI;AAAA,YACH,eAAe,MAAM,gBAAgB,aAAa,MAAM,KAAK,QAAQ;AAAA,YACrE,WAAW,oBAAI,KAAK;AAAA,UACtB,CAAC,EACA,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAAA,QACjD,OAAO;AAEL,gBAAM,CAAC,OAAO,IAAI,MAAMA,IAAG,OAAO,EAAE,gBAAgB,SAAS,eAAe,CAAC,EAC1E,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAExC,cAAI,SAAS,gBAAgB;AAC3B,kBAAMA,IACH,OAAO,QAAQ,EACf,IAAI;AAAA,cACH,eAAe,MAAM,SAAS,aAAa,MAAM,KAAK,QAAQ;AAAA,cAC9D,WAAW,oBAAI,KAAK;AAAA,YACtB,CAAC,EACA,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAAA,UAC1C;AAAA,QACF;AAAA,MACF;AAGA,UAAI,OAAO,aAAa;AACtB,cAAMA,IACH,OAAO,UAAU,EACjB,IAAI,EAAE,YAAY,MAAM,WAAW,UAAU,OAAO,CAAC,EACrD,MAAM,GAAG,WAAW,IAAI,OAAO,WAAW,CAAC;AAAA,MAChD;AAGA,YAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,YAAY,MAAM,UAAU,UAAU,OAAO,CAAC,EACpD,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC;AAGtC,YAAMA,IAAG,OAAO,SAAS,EAAE,MAAM,GAAG,UAAU,QAAQ,KAAK,EAAE,CAAC;AAC9D,YAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,KAAK,EAAE,CAAC;AAExE,kBAAY,KAAK;AAAA,QACf,SAAS,MAAM;AAAA,QACf,aAAa,MAAM;AAAA,QACnB,OAAO,OAAO;AAAA,QACd,QAAQ,MAAM;AAAA,QACd,eAAe,MAAM;AAAA,MACvB,CAAC;AAID,UAAI;AAEF,cAAM,iBAAiB,MAAMA,IAAG,MAAM,OAAO,UAAU;AAAA,UACrD,OAAO,GAAG,OAAO,IAAI,MAAM,EAAE;AAAA,UAC7B,MAAM;AAAA,YACJ,OAAO;AAAA,UACT;AAAA,QACF,CAAC;AAED,YAAI,CAAC,gBAAgB;AACnB,iBAAO,KAAK,0CAA0C,EAAE,SAAS,MAAM,GAAG,CAAC;AAC3E;AAAA,QACF;AAGA,cAAM,CAAC,aAAa,IAAI,MAAMA,IAC3B,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,OAAO,CAAC;AAElC,cAAM,cAAe,eAAe,SAI9B,CAAC;AAGP,cAAM,gBAAgB,KAAK,eAAe;AAC1C,cAAM,YAAY;AAAA,UAChB,aAAa,MAAM;AAAA,UACnB,cAAc,GAAG,MAAM,gBAAgB,SAAS,IAAI,MAAM,gBAAgB,QAAQ;AAAA,UAClF;AAAA,UACA,iBAAiB,EAAE,GAAG,MAAM,iBAAiB,OAAO,eAAe,OAAO,MAAM,gBAAgB,SAAS,GAAG;AAAA,UAC5G,OAAO,eAAe,MAAM,IAAI,CAAC,UAAU;AAAA,YACzC,aAAa,KAAK;AAAA,YAClB,KAAK,KAAK;AAAA,YACV,UAAU,KAAK;AAAA,YACf,WAAW,OAAO,KAAK,iBAAiB;AAAA,YACxC,WAAW,OAAO,KAAK,iBAAiB,IAAI,KAAK;AAAA,UACnD,EAAE;AAAA,UACF,UAAU,OAAO,MAAM,gBAAgB;AAAA,UACvC,SAAS,OAAO,MAAM,eAAe;AAAA,UACrC,WAAW,OAAO,MAAM,iBAAiB;AAAA,UACzC,gBAAgB,OAAO,MAAM,sBAAsB;AAAA,UACnD,gBAAgB,OAAO,MAAM,sBAAsB;AAAA,UACnD,OAAO,OAAO,MAAM,aAAa;AAAA,UACjC,UAAU,MAAM;AAAA,UAChB,WAAW,MAAM,qBAAqB;AAAA,UACtC,eAAe,MAAM,iBAAiB;AAAA,UACtC,WAAW,MAAM,UAAU,YAAY;AAAA,UACvC,eAAe,MAAM;AAAA,QACvB;AAGA,cAAM,oBAAoB,sBAAsB,+BAA+B,SAAS;AACxF,sBACG,UAAU;AAAA,UACT,IAAI,UAAU;AAAA,UACd,SAAS,wBAAwB,MAAM,WAAW;AAAA,UAClD,MAAM;AAAA,QACR,CAAC,EACA,KAAK,CAAC,YAAY;AACjB,cAAI,SAAS;AACX,mBAAO,KAAK,iCAAiC;AAAA,cAC3C,SAAS,MAAM;AAAA,cACf,aAAa,MAAM;AAAA,cACnB,eAAe,UAAU;AAAA,YAC3B,CAAC;AAAA,UACH;AAAA,QACF,CAAC,EACA,MAAM,CAAC,UAAU;AAChB,iBAAO,MAAM,oDAAoD;AAAA,YAC/D;AAAA,YACA,SAAS,MAAM;AAAA,YACf,aAAa,MAAM;AAAA,YACnB,eAAe,UAAU;AAAA,UAC3B,CAAC;AAAA,QACH,CAAC;AAGH,YAAI,YAAY,wBAAwB;AACtC,gBAAM,iBAAiB,sBAAsB,kCAAkC,SAAS;AACxF,wBACG,UAAU;AAAA,YACT,IAAI,YAAY;AAAA,YAChB,SAAS,cAAc,MAAM,WAAW;AAAA,YACxC,MAAM;AAAA,UACR,CAAC,EACA,KAAK,CAAC,YAAY;AACjB,gBAAI,SAAS;AACX,qBAAO,KAAK,uCAAuC;AAAA,gBACjD,SAAS,MAAM;AAAA,gBACf,aAAa,MAAM;AAAA,gBACnB,YAAY,YAAY;AAAA,cAC1B,CAAC;AAAA,YACH;AAAA,UACF,CAAC,EACA,MAAM,CAAC,UAAU;AAChB,mBAAO,MAAM,iDAAiD;AAAA,cAC5D;AAAA,cACA,SAAS,MAAM;AAAA,cACf,aAAa,MAAM;AAAA,cACnB,YAAY,YAAY;AAAA,YAC1B,CAAC;AAAA,UACH,CAAC;AAAA,QACL;AAAA,MACF,SAAS,YAAY;AAEnB,eAAO,MAAM,uCAAuC;AAAA,UAClD,OAAO;AAAA,UACP,SAAS,MAAM;AAAA,UACf,aAAa,MAAM;AAAA,QACrB,CAAC;AAAA,MACH;AAAA,IACF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa,IAAI,uBAAuB,OAAO,KAAK,KAAK,SAAS;AAChE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,cAAc,IAAI,OAAO,aAAa;AAE5C,UAAM,CAAC,KAAK,IAAI,MAAMA,IACnB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,aAAa,WAAW,CAAC;AAE5C,QAAI,CAAC,OAAO;AACV,YAAM,IAAI,cAAc,iBAAiB;AAAA,IAC3C;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,SAAS,MAAM,EAAE,CAAC;AAGzC,UAAM,WAAW;AAAA,MACf,EAAE,QAAQ,WAAW,WAAW,MAAM,UAAU,YAAY,GAAG,aAAa,eAAe;AAAA,IAC7F;AAEA,QAAI,MAAM,WAAW,aAAa,MAAM,WAAW,eAAe,MAAM,aAAa;AACnF,eAAS,KAAK,EAAE,QAAQ,aAAa,WAAW,MAAM,YAAY,YAAY,GAAG,aAAa,kBAAkB,CAAC;AAAA,IACnH;AAEA,QAAI,CAAC,cAAc,WAAW,WAAW,EAAE,SAAS,MAAM,MAAM,KAAK,MAAM,cAAc;AACvF,eAAS,KAAK,EAAE,QAAQ,cAAc,WAAW,MAAM,aAAa,YAAY,GAAG,aAAa,2BAA2B,CAAC;AAAA,IAC9H;AAEA,QAAI,CAAC,WAAW,WAAW,EAAE,SAAS,MAAM,MAAM,KAAK,MAAM,WAAW;AACtE,eAAS,KAAK,EAAE,QAAQ,WAAW,WAAW,MAAM,UAAU,YAAY,GAAG,aAAa,gBAAgB,CAAC;AAAA,IAC7G;AAEA,QAAI,MAAM,WAAW,eAAe,MAAM,aAAa;AACrD,eAAS,KAAK,EAAE,QAAQ,aAAa,WAAW,MAAM,YAAY,YAAY,GAAG,aAAa,kBAAkB,CAAC;AAAA,IACnH;AAGA,UAAM,kBAAkB,MAAM;AAE9B,gBAAY,KAAK;AAAA,MACf,aAAa,MAAM;AAAA,MACnB,QAAQ,MAAM;AAAA,MACd,eAAe,MAAM;AAAA,MACrB,gBAAgB,MAAM;AAAA,MACtB,gBAAgB,MAAM;AAAA,MACtB,WAAW,MAAM,UAAU,YAAY;AAAA,MACvC,OAAO,OAAO,MAAM,aAAa;AAAA,MACjC,WAAW,MAAM;AAAA,MACjB,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,aAAa,KAAK;AAAA,QAClB,UAAU,KAAK;AAAA,QACf,OAAO,OAAO,KAAK,iBAAiB;AAAA,MACtC,EAAE;AAAA,MACF,kBAAkB,kBAAkB;AAAA,QAClC,MAAM,gBAAgB;AAAA,QACtB,SAAS,gBAAgB;AAAA,MAC3B,IAAI;AAAA,MACJ;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa,IAAI,KAAK,aAAa,OAAO,KAAK,KAAK,SAAS;AAC3D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,MAAM;AAE7B,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,eAAe,oBAAoB;AAAA,IAC/C;AAEA,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AAEzF,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,UAAU,CAAC;AAC1C,UAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,UAAM,YAAY,MAAMD,IACrB,OAAO;AAAA,MACN,IAAI,OAAO;AAAA,MACX,aAAa,OAAO;AAAA,MACpB,QAAQ,OAAO;AAAA,MACf,eAAe,OAAO;AAAA,MACtB,eAAe,OAAO;AAAA,MACtB,WAAW,OAAO;AAAA,IACpB,CAAC,EACA,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,UAAU,CAAC,EACvC,QAAQ,KAAK,OAAO,SAAS,CAAC,EAC9B,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,UAAM,mBAAmB,UAAU,IAAI,QAAM;AAAA,MAC3C,GAAG;AAAA,MACH,eAAe,OAAO,EAAE,aAAa;AAAA,IACvC,EAAE;AAEF,gBAAY,KAAK,kBAAkB,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,EAC1F,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,QAAQ,aAAa,OAAO,KAAK,KAAK,SAAS;AAC9D,MAAI;AACF,UAAMD,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,aAAa,IAAI,MAAM;AAC7B,UAAM,UAAU,IAAI,MAAM,SAAS;AAEnC,UAAM,CAAC,KAAK,IAAI,MAAMA,IACnB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAE1B,QAAI,CAAC,OAAO;AACV,YAAM,IAAI,cAAc,iBAAiB;AAAA,IAC3C;AAGA,QAAI,CAAC,WAAW,MAAM,eAAe,YAAY;AAC/C,YAAM,IAAI,eAAe,eAAe;AAAA,IAC1C;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,SAAS,MAAM,EAAE,CAAC;AAGzC,QAAI,WAAW;AACf,QAAI,MAAM,YAAY;AACpB,YAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO;AAAA,QACN,IAAI,UAAU;AAAA,QACd,OAAO,UAAU;AAAA,QACjB,WAAW,UAAU;AAAA,QACrB,UAAU,UAAU;AAAA,MACtB,CAAC,EACA,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,MAAM,UAAU,CAAC;AAC3C,iBAAW,gBAAgB;AAAA,IAC7B;AAEA,gBAAY,KAAK;AAAA,MACf,IAAI,MAAM;AAAA,MACV,aAAa,MAAM;AAAA,MACnB,YAAY,MAAM;AAAA,MAClB;AAAA;AAAA,MAGA,QAAQ,MAAM;AAAA,MACd,eAAe,MAAM;AAAA;AAAA,MAGrB,UAAU,MAAM;AAAA,MAChB,UAAU,OAAO,MAAM,gBAAgB;AAAA,MACvC,SAAS,OAAO,MAAM,eAAe;AAAA,MACrC,KAAK,OAAO,MAAM,iBAAiB;AAAA,MACnC,UAAU,OAAO,MAAM,sBAAsB;AAAA,MAC7C,UAAU,OAAO,MAAM,sBAAsB;AAAA,MAC7C,OAAO,OAAO,MAAM,aAAa;AAAA;AAAA,MAGjC,aAAa,MAAM;AAAA,MACnB,mBAAmB,MAAM;AAAA;AAAA,MAGzB,eAAe,MAAM;AAAA,MACrB,gBAAgB,MAAM;AAAA,MACtB,gBAAgB,MAAM;AAAA;AAAA,MAGtB,iBAAiB,MAAM;AAAA,MACvB,gBAAgB,MAAM;AAAA;AAAA,MAGtB,eAAe,MAAM;AAAA,MACrB,YAAY,MAAM;AAAA;AAAA,MAGlB,aAAa,MAAM,aAAa,YAAY;AAAA,MAC5C,cAAc,MAAM,cAAc,YAAY;AAAA,MAC9C,WAAW,MAAM,WAAW,YAAY;AAAA,MACxC,aAAa,MAAM,aAAa,YAAY;AAAA,MAC5C,WAAW,MAAM,UAAU,YAAY;AAAA,MACvC,WAAW,MAAM,UAAU,YAAY;AAAA;AAAA,MAGvC,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,IAAI,KAAK;AAAA,QACT,WAAW,KAAK;AAAA,QAChB,aAAa,KAAK;AAAA,QAClB,cAAc;AAAA,QACd,KAAK,KAAK;AAAA,QACV,gBAAgB,KAAK;AAAA,QACrB,UAAU,KAAK;AAAA,QACf,OAAO,OAAO,KAAK,iBAAiB;AAAA,QACpC,OAAO,OAAO,KAAK,iBAAiB,IAAI,KAAK;AAAA,MAC/C,EAAE;AAAA,IACJ,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,kBAAkB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,UAAU,IAAI;AAEpB,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ,QAAQ,GAAG;AACrB,mBAAW,KAAK,GAAG,OAAO,QAAQ,QAAQ,QAAQ,CAAmF,CAAC;AAAA,MACxI;AAEA,UAAI,QAAQ,eAAe,GAAG;AAC5B,mBAAW,KAAK,GAAG,OAAO,eAAe,QAAQ,eAAe,CAA+C,CAAC;AAAA,MAClH;AAGA,UAAI,QAAQ,QAAQ,GAAG;AACrB,cAAM,aAAa,IAAI,QAAQ,QAAQ,CAAC;AACxC,mBAAW;AAAA,UACT;AAAA,YACE,MAAM,OAAO,aAAa,UAAU;AAAA,YACpC,MAAM,UAAU,OAAO,UAAU;AAAA,YACjC,MAAM,UAAU,WAAW,UAAU;AAAA,YACrC,MAAM,UAAU,UAAU,UAAU;AAAA,YACpC,aAAa,UAAU,SAAS,UAAU,UAAU,QAAQ,WAAW,UAAU;AAAA,UACnF;AAAA,QACF;AAAA,MACF;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAGjE,YAAM,aAAa,QAAQ,QAAQ,IAC/BA,IAAG,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM,EACX,SAAS,WAAW,GAAG,OAAO,YAAY,UAAU,EAAE,CAAC,EACvD,MAAM,WAAW,IACpBA,IAAG,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM,EACX,MAAM,WAAW;AACxB,YAAM,cAAc,MAAM;AAC1B,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,YAAY,MAAMD,IACrB,OAAO;AAAA,QACN,IAAI,OAAO;AAAA,QACX,aAAa,OAAO;AAAA,QACpB,YAAY,OAAO;AAAA,QACnB,QAAQ,OAAO;AAAA,QACf,eAAe,OAAO;AAAA,QACtB,eAAe,OAAO;AAAA,QACtB,iBAAiB,OAAO;AAAA,QACxB,YAAY,OAAO;AAAA,QACnB,WAAW,OAAO;AAAA,QAClB,WAAW,OAAO;AAAA,QAClB,UAAU;AAAA,UACR,IAAI,UAAU;AAAA,UACd,OAAO,UAAU;AAAA,UACjB,WAAW,UAAU;AAAA,UACrB,UAAU,UAAU;AAAA,QACtB;AAAA,MACF,CAAC,EACA,KAAK,MAAM,EACX,SAAS,WAAW,GAAG,OAAO,YAAY,UAAU,EAAE,CAAC,EACvD,MAAM,WAAW,EACjB,QAAQ,KAAK,OAAO,SAAS,CAAC,EAC9B,MAAM,KAAK,EACX,OAAO,MAAM;AAGhB,YAAM,kBAAkB,UAAU,IAAI,QAAM;AAAA,QAC1C,GAAG;AAAA,QACH,OAAO,OAAO,EAAE,aAAa;AAAA,QAC7B,UAAU,EAAE,UAAU,KAAK,EAAE,WAAW;AAAA,MAC1C,EAAE;AAEF,kBAAY,KAAK,iBAAiB,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,IACzF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,iBAAiB;AAAA,EAC9B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMD,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAE1B,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,iBAAiB;AAAA,MAC3C;AAGA,YAAM,mBAA6C;AAAA,QACjD,SAAS,CAAC,aAAa,WAAW;AAAA,QAClC,WAAW,CAAC,cAAc,WAAW;AAAA,QACrC,YAAY,CAAC,WAAW,WAAW;AAAA,QACnC,SAAS,CAAC,WAAW;AAAA,QACrB,WAAW,CAAC;AAAA,QACZ,WAAW,CAAC;AAAA,MACd;AAEA,UAAI,KAAK,UAAU,KAAK,WAAW,SAAS,QAAQ;AAClD,cAAM,oBAAoB,iBAAiB,SAAS,MAAM,KAAK,CAAC;AAChE,YAAI,CAAC,kBAAkB,SAAS,KAAK,MAAM,GAAG;AAC5C,gBAAM,IAAI;AAAA,YACR,2BAA2B,SAAS,MAAM,SAAS,KAAK,MAAM;AAAA,UAChE;AAAA,QACF;AAAA,MACF;AAGA,UAAI,KAAK,WAAW,eAAe,SAAS,WAAW,aAAa;AAElE,cAAM,iBAAiB,MAAMA,IAAG,OAAO,EAAE,KAAK,UAAU,EACrD,MAAM,GAAG,WAAW,SAAS,EAAE,CAAC;AAGnC,mBAAW,QAAQ,gBAAgB;AACjC,cAAI,KAAK,WAAW;AAClB,kBAAMA,IAAG,OAAO,eAAe,EAC5B,IAAI;AAAA,cACH,eAAe,MAAM,gBAAgB,aAAa,MAAM,KAAK,QAAQ;AAAA,YACvE,CAAC,EACA,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAAA,UACjD,WAAW,KAAK,WAAW;AACzB,kBAAMA,IAAG,OAAO,QAAQ,EACrB,IAAI;AAAA,cACH,eAAe,MAAM,SAAS,aAAa,MAAM,KAAK,QAAQ;AAAA,YAChE,CAAC,EACA,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAAA,UAC1C;AAAA,QACF;AAAA,MACF;AAEA,YAAM,aAAsC;AAAA,QAC1C,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB;AAGA,UAAI,KAAK,WAAW,eAAe,SAAS,WAAW,aAAa;AAClE,mBAAW,aAAa,IAAI,oBAAI,KAAK;AAAA,MACvC;AAGA,UAAI,KAAK,WAAW,gBAAgB,SAAS,WAAW,cAAc;AACpE,mBAAW,cAAc,IAAI,oBAAI,KAAK;AAAA,MACxC;AAGA,UAAI,KAAK,WAAW,aAAa,SAAS,WAAW,WAAW;AAC9D,mBAAW,WAAW,IAAI,oBAAI,KAAK;AAAA,MACrC;AAGA,UAAI,KAAK,WAAW,eAAe,SAAS,WAAW,aAAa;AAClE,mBAAW,aAAa,IAAI,oBAAI,KAAK;AAAA,MACvC;AAEA,YAAM,cAAc,MAAMA,IACvB,OAAO,MAAM,EACb,IAAI,UAAU,EACd,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC,EACvB,UAAU;AACb,YAAM,QAAQ,YAAY,CAAC;AAE3B,kBAAY,KAAK,KAAK;AAAA,IACxB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,YAAM,CAAC,KAAK,IAAI,MAAMA,IACnB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAE1B,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,cAAc,iBAAiB;AAAA,MAC3C;AAGA,YAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,SAAS,MAAM,EAAE,CAAC;AAGzC,UAAI,WAAW;AACf,UAAI,MAAM,YAAY;AACpB,cAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,MAAM,UAAU,CAAC;AAC3C,mBAAW,gBAAgB;AAAA,MAC7B;AAGA,YAAM,kBAAkB,MAAM;AAQ9B,YAAM,cAAc;AAAA,QAClB,eAAe,OAAO,MAAM,WAAW;AAAA,QACvC,aAAa,MAAM;AAAA,QACnB,iBAAiB,MAAM;AAAA,QACvB,WAAW,MAAM;AAAA,QACjB,YAAY,IAAI,KAAK,MAAM,UAAU,QAAQ,IAAI,KAAK,KAAK,KAAK,KAAK,GAAI;AAAA;AAAA,QACzE,QAAQ,MAAM;AAAA,QACd,eAAe,MAAM;AAAA,QACrB,eAAe,MAAM,iBAAiB;AAAA,QACtC,QAAQ,MAAM,kBAAkB,SAAS,MAAM,YAAY;AAAA;AAAA,QAG3D,cAAc,WACV,GAAG,SAAS,SAAS,IAAI,SAAS,QAAQ,KAC1C,kBACE,GAAG,gBAAgB,SAAS,IAAI,gBAAgB,QAAQ,KACxD;AAAA,QACN,eAAe,UAAU,SAAS;AAAA,QAClC,eAAe,UAAU,SAAS,iBAAiB;AAAA,QACnD,iBAAiB,iBAAiB;AAAA;AAAA,QAGlC,OAAO,MAAM,IAAI,WAAS;AAAA,UACxB,aAAa,KAAK,uBAAuB;AAAA,UACzC,KAAK,KAAK,eAAe;AAAA,UACzB,UAAU,KAAK;AAAA,UACf,WAAW,OAAO,KAAK,iBAAiB;AAAA,UACxC,WAAW,OAAO,KAAK,iBAAiB,IAAI,KAAK;AAAA,UACjD,gBAAgB,KAAK;AAAA,QACvB,EAAE;AAAA;AAAA,QAGF,UAAU,OAAO,MAAM,gBAAgB;AAAA,QACvC,SAAS,OAAO,MAAM,eAAe;AAAA,QACrC,WAAW,OAAO,MAAM,iBAAiB;AAAA,QACzC,gBAAgB,OAAO,MAAM,sBAAsB;AAAA,QACnD,gBAAgB,OAAO,MAAM,sBAAsB;AAAA,QACnD,OAAO,OAAO,MAAM,aAAa;AAAA,QACjC,UAAU,MAAM,YAAY;AAAA;AAAA,QAG5B,aAAa,QAAQ,IAAI,cAAc,KAAK;AAAA,QAC5C,gBAAgB,QAAQ,IAAI,iBAAiB,KAAK;AAAA,QAClD,cAAc,QAAQ,IAAI,eAAe,KAAK;AAAA,QAC9C,cAAc,QAAQ,IAAI,eAAe,KAAK;AAAA,QAC9C,gBAAgB,QAAQ,IAAI,iBAAiB,KAAK;AAAA,MACpD;AAGA,YAAM,YAAY,MAAM,WAAW,mBAAmB,WAAW;AAGjE,UAAI,UAAU,gBAAgB,iBAAiB;AAC/C,UAAI;AAAA,QACF;AAAA,QACA,iCAAiC,MAAM,WAAW;AAAA,MACpD;AACA,UAAI,UAAU,kBAAkB,UAAU,MAAM;AAGhD,UAAI,KAAK,SAAS;AAAA,IACpB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,IAAM,yBAAyB,cAAE,OAAO;AAAA;AAAA,EAEtC,YAAY,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACvC,eAAe,cAAE,OAAO,EAAE,MAAM,EAAE,SAAS;AAAA,EAC3C,mBAAmB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAChD,kBAAkB,cAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC/C,eAAe,cAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA;AAAA,EAG3C,OAAO,cAAE,MAAM,cAAE,OAAO;AAAA,IACtB,WAAW,cAAE,OAAO,EAAE,KAAK;AAAA,IAC3B,WAAW,cAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,IACtC,UAAU,cAAE,OAAO,EAAE,IAAI,EAAE,SAAS;AAAA,EACtC,CAAC,CAAC,EAAE,IAAI,GAAG,+BAA+B;AAAA;AAAA,EAG1C,iBAAiB;AAAA,EACjB,gBAAgB,cAAc,SAAS;AAAA,EACvC,gBAAgB,cAAE,QAAQ,EAAE,QAAQ,IAAI;AAAA;AAAA,EAGxC,eAAe,cAAE,KAAK,CAAC,OAAO,iBAAiB,MAAM,CAAC;AAAA,EACtD,eAAe,cAAE,KAAK,CAAC,WAAW,MAAM,CAAC,EAAE,QAAQ,SAAS;AAAA;AAAA,EAG5D,WAAW,cAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,gBAAgB,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA;AAAA,EAG3C,YAAY,cAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC1C,eAAe,cAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAC/C,CAAC;AAMD,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,sBAAsB;AAAA,EACnC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,UAAI;AACJ,UAAI,KAAK,YAAY;AAEnB,cAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,KAAK,UAAU,CAAC;AAE1C,YAAI,CAAC,kBAAkB;AACrB,gBAAM,IAAI,gBAAgB,oBAAoB;AAAA,QAChD;AACA,mBAAW;AAAA,MACb,WAAW,KAAK,eAAe;AAE7B,cAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,KAAK,cAAc,YAAY,CAAC,CAAC;AAE9D,YAAI,kBAAkB;AACpB,qBAAW;AAAA,QACb,OAAO;AAEL,gBAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,SAAS,EAChB,OAAO;AAAA,YACN,OAAO,KAAK,cAAc,YAAY;AAAA,YACtC,WAAW,KAAK,qBAAqB,KAAK,gBAAgB;AAAA,YAC1D,UAAU,KAAK,oBAAoB,KAAK,gBAAgB;AAAA,YACxD,OAAO,KAAK,iBAAiB,KAAK,gBAAgB;AAAA,YAClD,SAAS;AAAA,UACX,CAAC,EACA,UAAU;AACb,qBAAW;AAAA,QACb;AAAA,MACF,OAAO;AACL,cAAM,IAAI,gBAAgB,gDAAgD;AAAA,MAC5E;AAEA,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,gBAAgB,4BAA4B;AAAA,MACxD;AAGA,YAAM,YAAY,KAAK,MAAM,IAAI,CAAC,UAAuE;AAAA,QACvG,WAAW,KAAK;AAAA,QAChB,WAAW,KAAK;AAAA,QAChB,UAAU,KAAK;AAAA,MACjB,EAAE;AAEF,YAAM,SAAS,MAAM,eAAe;AAAA,QAClC;AAAA,QACA,KAAK;AAAA,MACP;AAGA,UAAI,gBAAgB,OAAO;AAC3B,UAAI,aAAa,OAAO;AAExB,UAAI,KAAK,kBAAkB,KAAK,iBAAiB,GAAG;AAElD,cAAM,oBAAoB,OAAO,WAAW,OAAO;AACnD,cAAM,wBAAwB,KAAK,IAAI,KAAK,gBAAgB,iBAAiB;AAC7E,yBAAiB;AACjB,qBAAa,OAAO,WAAW,gBAAgB,OAAO,YAAY,OAAO;AAGzE,cAAM,qBAAqB,OAAO,WAAW;AAC7C,cAAM,SAAS,qBAAqB,OAAO;AAC3C,qBAAa,qBAAqB,SAAS,OAAO;AAAA,MACpD;AAGA,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM;AACd,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AACvC,YAAM,cAAc,oBAAoB,OAAOA,MAAK,IAAI,CAAC;AAGzD,YAAM,iBAAiB,KAAK,iBACxB,KAAK,kBACL,KAAK,kBAAkB,KAAK;AAGhC,YAAM,CAAC,KAAK,IAAI,MAAMD,IACnB,OAAO,MAAM,EACb,OAAO;AAAA,QACN;AAAA,QACA,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR,eAAe,KAAK;AAAA,QACpB,iBAAiB,KAAK;AAAA,QACtB;AAAA,QACA,UAAU;AAAA,QACV,kBAAkB,OAAO,OAAO,QAAQ;AAAA,QACxC,iBAAiB,OAAO,OAAO,OAAO;AAAA,QACtC,mBAAmB,OAAO,KAAK,kBAAkB,OAAO,WAAW,iBAAiB,OAAO,UAAU,OAAO,SAAS;AAAA,QACrH,wBAAwB,OAAO,OAAO,cAAc;AAAA,QACpD,wBAAwB,OAAO,aAAa;AAAA,QAC5C,eAAe,OAAO,UAAU;AAAA,QAChC,aAAa,OAAO;AAAA,QACpB,mBAAmB,OAAO;AAAA,QAC1B,eAAe,KAAK;AAAA,QACpB,eAAe,KAAK;AAAA,QACpB,YAAY,KAAK;AAAA,MACnB,CAAC,EACA,UAAU;AAEb,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,gBAAgB,wBAAwB;AAAA,MACpD;AAGA,iBAAW,QAAQ,KAAK,OAAO;AAC7B,cAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAExC,YAAI,CAAC,SAAS;AACZ,gBAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,QAClE;AAEA,YAAI;AACJ,YAAI,KAAK,WAAW;AAClB,gBAAM,CAAC,aAAa,IAAI,MAAMA,IAC3B,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAC/C,oBAAU;AAAA,QACZ;AAEA,cAAM,YAAY,UAAU,OAAO,QAAQ,SAAS,IAAI,OAAO,QAAQ,SAAS;AAEhF,cAAMA,IAAG,OAAO,UAAU,EAAE,OAAO;AAAA,UACjC,SAAS,MAAM;AAAA,UACf,WAAW,KAAK;AAAA,UAChB,WAAW,KAAK;AAAA,UAChB,qBAAqB,QAAQ;AAAA,UAC7B,aAAa,SAAS,OAAO,QAAQ;AAAA,UACrC,wBAAwB,SAAS;AAAA,UACjC,UAAU,KAAK;AAAA,UACf,mBAAmB,OAAO,SAAS;AAAA,QACrC,CAAC;AAAA,MACH;AAGA,UAAI,OAAO,aAAa;AACtB,cAAMA,IACH,OAAO,UAAU,EACjB,IAAI,EAAE,YAAY,MAAM,WAAW,UAAU,OAAO,CAAC,EACrD,MAAM,GAAG,WAAW,IAAI,OAAO,WAAW,CAAC;AAAA,MAChD;AAGA,YAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,YAAY,MAAM,UAAU,UAAU,OAAO,CAAC,EACpD,MAAM,GAAG,UAAU,IAAI,SAAS,EAAE,CAAC;AAEtC,kBAAY,KAAK;AAAA,QACf,IAAI,MAAM;AAAA,QACV,aAAa,MAAM;AAAA,QACnB,OAAO;AAAA,QACP,QAAQ,MAAM;AAAA,QACd,eAAe,MAAM;AAAA,QACrB,eAAe,MAAM;AAAA,MACvB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa;AAAA,EACX;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,YAAM,CAAC,KAAK,IAAI,MAAMA,IACnB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAE1B,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,cAAc,iBAAiB;AAAA,MAC3C;AAGA,UAAI,MAAM,WAAW,aAAa;AAChC,cAAM,IAAI,gBAAgB,sCAAsC;AAAA,MAClE;AAGA,YAAMA,IAAG,OAAO,UAAU,EAAE,MAAM,GAAG,WAAW,SAAS,EAAE,CAAC;AAG5D,YAAMA,IAAG,OAAO,MAAM,EAAE,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAE/C,kBAAY,KAAK,EAAE,SAAS,6BAA6B,CAAC;AAAA,IAC5D,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;AE9rCA,IAAAE,kBAAuB;AACvB,IAAAC,cAAkB;AAClB,IAAAC,mBAAmB;AAYZ,IAAM,sBAAkB,wBAAO;AAOtC,IAAMC,kBAAiB;AAAA,EACrB;AAAA,EAAU;AAAA,EAAa;AAAA,EAAU;AAAA,EAAY;AAAA,EAC7C;AAAA,EAAU;AAAA,EAAc;AAAA,EAAW;AAAA,EAAa;AAAA,EAChD;AAAA,EAAU;AAAA,EAAa;AAAA,EAAY;AAAA,EAAS;AAAA,EAC5C;AAAA,EAAW;AAAA,EAAU;AAAA,EAAU;AAAA,EAAU;AAC3C;AAEA,IAAM,sBAAsB,cAAE,OAAO;AAAA,EACnC,WAAW,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC/C,UAAU,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC9C,OAAO,cAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AACrC,CAAC;AAED,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,iBAAiB,cAAE,OAAO,EAAE,IAAI,GAAG,8BAA8B;AAAA,EACjE,aAAa,cAAE,OAAO,EACnB,IAAI,GAAG,wCAAwC,EAC/C,IAAI,IAAI,0CAA0C,EAClD;AAAA,IACC,CAAC,aAAa;AACZ,YAAM,eAAe,QAAQ,KAAK,QAAQ;AAC1C,YAAM,eAAe,QAAQ,KAAK,QAAQ;AAC1C,YAAM,YAAY,QAAQ,KAAK,QAAQ;AACvC,aAAO,gBAAgB,gBAAgB;AAAA,IACzC;AAAA,IACA,EAAE,SAAS,yDAAyD;AAAA,EACtE,EACC;AAAA,IACC,CAAC,aAAa,CAACA,gBAAe,SAAS,SAAS,YAAY,CAAC;AAAA,IAC7D,EAAE,SAAS,6DAA6D;AAAA,EAC1E;AAAA,EACF,iBAAiB,cAAE,OAAO,EAAE,IAAI,GAAG,8BAA8B;AACnE,CAAC,EAAE,OAAO,CAAC,SAAS,KAAK,gBAAgB,KAAK,iBAAiB;AAAA,EAC7D,SAAS;AAAA,EACT,MAAM,CAAC,iBAAiB;AAC1B,CAAC;AAED,IAAMC,iBAAgB,cAAE,OAAO;AAAA,EAC7B,MAAM,cAAE,KAAK,CAAC,YAAY,SAAS,GAAG;AAAA,IACpC,UAAU,OAAO,EAAE,SAAS,2CAA2C;AAAA,EACzE,CAAC;AAAA,EACD,WAAW,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC/C,WAAW,cAAE,OAAO,EACjB,IAAI,GAAG,wBAAwB,EAC/B,IAAI,KAAK,6CAA6C;AAAA,EACzD,UAAU,cAAE,OAAO,EAChB,IAAI,GAAG,uBAAuB,EAC9B,IAAI,KAAK,4CAA4C;AAAA,EACxD,SAAS,cAAE,OAAO,EACf,IAAI,KAAK,0CAA0C,EACnD,SAAS;AAAA,EACZ,cAAc,cAAE,OAAO,EACpB,IAAI,GAAG,qBAAqB,EAC5B,IAAI,KAAK,0CAA0C;AAAA,EACtD,cAAc,cAAE,OAAO,EACpB,IAAI,KAAK,iDAAiD,EAC1D,SAAS;AAAA,EACZ,MAAM,cAAE,OAAO,EACZ,IAAI,GAAG,kBAAkB,EACzB,IAAI,KAAK,uCAAuC;AAAA,EACnD,OAAO,cAAE,OAAO,EACb,IAAI,KAAK,wCAAwC,EACjD,SAAS;AAAA,EACZ,YAAY,cAAE,OAAO,EAClB,IAAI,IAAI,6CAA6C,EACrD,SAAS;AAAA,EACZ,SAAS,cAAE,OAAO,EACf,IAAI,GAAG,qBAAqB,EAC5B,IAAI,KAAK,0CAA0C;AAAA,EACtD,OAAO,cAAE,OAAO,EACb,IAAI,IAAI,uCAAuC,EAC/C,MAAM,sBAAsB,mCAAmC,EAC/D,SAAS,EACT,GAAG,cAAE,QAAQ,EAAE,CAAC;AACrB,CAAC;AAED,IAAM,wBAAwB,cAAE,OAAO;AAAA,EACrC,MAAM,cAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,SAAS,cAAE,KAAK,CAAC,QAAQ,OAAO,CAAC,EAAE,SAAS;AAC9C,CAAC;AAED,IAAM,wBAAwB,cAAE,OAAO;AAAA,EACrC,WAAW,cAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,cAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,WAAW,cAAE,WAAW,iBAAiB,EAAE,SAAS;AAAA,EACpD,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAED,IAAM,4BAA4B,cAAE,OAAO;AAAA,EACzC,OAAO,cAAE,OAAO,EACb,MAAM,oCAAoC,EAC1C,IAAI,KAAK,wCAAwC,EACjD,SAAS;AAAA,EACZ,WAAW,cAAE,OAAO,EACjB,IAAI,GAAG,4BAA4B,EACnC,IAAI,KAAK,6CAA6C,EACtD,SAAS;AAAA,EACZ,UAAU,cAAE,OAAO,EAChB,IAAI,GAAG,2BAA2B,EAClC,IAAI,KAAK,4CAA4C,EACrD,SAAS;AAAA,EACZ,OAAO,cAAE,OAAO,EACb,IAAI,IAAI,8CAA8C,EACtD,MAAM,sBAAsB,mCAAmC,EAC/D,SAAS,EACT,GAAG,cAAE,QAAQ,EAAE,CAAC;AAAA,EACnB,SAAS,cAAE,QAAQ,EAAE,SAAS;AAAA,EAC9B,UAAU,cAAE,QAAQ,EAAE,SAAS;AAAA,EAC/B,kBAAkB,cAAE,QAAQ,EAAE,SAAS;AAAA,EACvC,OAAO,cAAE,OAAO,EACb,IAAI,KAAM,yCAAyC,EACnD,SAAS;AAAA,EACZ,MAAM,cAAE;AAAA,IACN,cAAE,OAAO,EAAE,IAAI,IAAI,0CAA0C;AAAA,EAC/D,EAAE,SAAS;AACb,CAAC;AAED,IAAM,uBAAuB,cAAE,OAAO;AAAA,EACpC,OAAO,cAAE,OAAO,EACb,IAAI,GAAG,mBAAmB,EAC1B,MAAM,oCAAoC,EAC1C,IAAI,KAAK,wCAAwC;AAAA,EACpD,WAAW,cAAE,OAAO,EACjB,IAAI,GAAG,4BAA4B,EACnC,IAAI,KAAK,6CAA6C,EACtD,SAAS;AAAA,EACZ,UAAU,cAAE,OAAO,EAChB,IAAI,GAAG,2BAA2B,EAClC,IAAI,KAAK,4CAA4C,EACrD,SAAS;AAAA,EACZ,OAAO,cAAE,OAAO,EACb,IAAI,IAAI,8CAA8C,EACtD,MAAM,sBAAsB,mCAAmC,EAC/D,SAAS,EACT,GAAG,cAAE,QAAQ,EAAE,CAAC;AAAA,EACnB,SAAS,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC7C,UAAU,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EAC7C,kBAAkB,cAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EACtD,OAAO,cAAE,OAAO,EACb,IAAI,KAAM,yCAAyC,EACnD,SAAS;AAAA,EACZ,MAAM,cAAE;AAAA,IACN,cAAE,OAAO,EAAE,IAAI,IAAI,0CAA0C;AAAA,EAC/D,EAAE,SAAS;AACb,CAAC;AAUD,gBAAgB,IAAI,OAAO,aAAa,OAAO,KAAK,KAAK,SAAS;AAChE,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,MAAM;AAE7B,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,eAAe,oBAAoB;AAAA,IAC/C;AAEA,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO;AAAA,MACN,IAAI,UAAU;AAAA,MACd,OAAO,UAAU;AAAA,MACjB,WAAW,UAAU;AAAA,MACrB,UAAU,UAAU;AAAA,MACpB,OAAO,UAAU;AAAA,MACjB,YAAY,UAAU;AAAA,MACtB,WAAW,UAAU;AAAA,IACvB,CAAC,EACA,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAErC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,YAAY,UAAU,CAAC;AAE7C,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,WAAW;AAAA,IACb,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,OAAO,IAAI;AAEjB,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,eAAe,oBAAoB;AAAA,MAC/C;AAEA,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC,EAClC,UAAU;AAAA,QACT,IAAI,UAAU;AAAA,QACd,OAAO,UAAU;AAAA,QACjB,WAAW,UAAU;AAAA,QACrB,UAAU,UAAU;AAAA,QACpB,OAAO,UAAU;AAAA,MACnB,CAAC;AACH,YAAM,WAAW,eAAe,CAAC;AAEjC,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,EAAE,iBAAiB,YAAY,IAAI,IAAI;AAE7C,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,eAAe,oBAAoB;AAAA,MAC/C;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAErC,UAAI,CAAC,YAAY,CAAC,SAAS,cAAc;AACvC,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,YAAM,kBAAkB,MAAM,iBAAAC,QAAO,QAAQ,iBAAiB,SAAS,YAAY;AACnF,UAAI,CAAC,iBAAiB;AACpB,cAAM,IAAI,gBAAgB,+BAA+B;AAAA,MAC3D;AAGA,YAAM,aAAa,CAAC,SAAS,OAAO,SAAS,WAAW,SAAS,QAAQ,EAAE,OAAO,OAAO;AACzF,YAAM,aAAa,MAAM,wBAAwB;AAAA,QAC/C;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAEA,UAAI,CAAC,WAAW,SAAS;AACvB,cAAM,IAAI,gBAAgB,WAAW,OAAO,KAAK,IAAI,CAAC;AAAA,MACxD;AAGA,YAAM,kBAAkB,MAAM,iBAAAA,QAAO,KAAK,aAAa,EAAE;AAGzD,YAAMD,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,cAAc;AAAA,QACd,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAGrC,YAAM,wBAAwB,qBAAqB;AAAA,QACjD;AAAA,QACA,cAAc;AAAA,QACd,cAAc;AAAA,QACd,WAAW,IAAI,MAAM,IAAI,OAAO;AAAA,QAChC,WAAW,IAAI,QAAQ,YAAY;AAAA,MACrC,CAAC;AAGD,YAAM,gBAAgB,eAAe,KAAK;AAAA,QACxC;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT,YAAY,SAAS;AAAA,QACrB,QAAQ;AAAA,QACR;AAAA,QACA,UAAU;AAAA,UACR,cAAc;AAAA,UACd,eAAe,WAAW,gBAAgB;AAAA,QAC5C;AAAA,MACF,CAAC;AAGD,UAAI,WAAW,gBAAgB,YAAY;AACzC,cAAM,gBAAgB,eAAe,KAAK;AAAA,UACxC;AAAA,UACA;AAAA,UACA,SAAS;AAAA,UACT,YAAY,SAAS;AAAA,UACrB,QAAQ;AAAA,UACR;AAAA,UACA,UAAU,EAAE,aAAa,WAAW,gBAAgB,eAAe,EAAE;AAAA,QACvE,CAAC;AAAA,MACH;AAGA,0BAAoB,gCAAgC;AAAA,QAClD,OAAO,SAAS;AAAA,QAChB,WAAW,SAAS;AAAA,QACpB,WAAW,oBAAI,KAAK;AAAA,QACpB,WAAW,IAAI,MAAM,IAAI,OAAO;AAAA,MAClC,CAAC,EAAE,MAAM,CAAC,UAAU;AAClB,gBAAQ,MAAM,gDAAgD,KAAK;AAAA,MACrE,CAAC;AAED,kBAAY,KAAK,EAAE,SAAS,gCAAgC,CAAC;AAAA,IAC/D,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAUA,gBAAgB,IAAI,iBAAiB,aAAa,OAAO,KAAK,KAAK,SAAS;AAC1E,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,MAAM;AAE7B,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,eAAe,oBAAoB;AAAA,IAC/C;AAEA,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,YAAY,UAAU,CAAC;AAE7C,gBAAY,KAAK,iBAAiB;AAAA,EACpC,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA,aAAaD,cAAa;AAAA,EAC1B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,OAAO,IAAI;AAEjB,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,eAAe,oBAAoB;AAAA,MAC/C;AAGA,UAAI,KAAK,WAAW;AAClB,cAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,WAAW,MAAM,CAAC,EACxB;AAAA,UACC;AAAA,YACE,GAAG,UAAU,YAAY,UAAU;AAAA,YACnC,GAAG,UAAU,MAAM,KAAK,IAAI;AAAA,UAC9B;AAAA,QACF;AAAA,MACJ;AAEA,YAAM,gBAAgB,MAAMA,IACzB,OAAO,SAAS,EAChB,OAAO;AAAA,QACN;AAAA,QACA,GAAG;AAAA,MACL,CAAC,EACA,UAAU;AACb,YAAM,UAAU,cAAc,CAAC;AAE/B,kBAAY,KAAK,OAAO;AAAA,IAC1B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA,aAAaD,eAAc,QAAQ,CAAC;AAAA,EACpC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,MAAM;AAC7B,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,eAAe,oBAAoB;AAAA,MAC/C;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd;AAAA,QACC;AAAA,UACE,GAAG,UAAU,IAAI,EAAE;AAAA,UACnB,GAAG,UAAU,YAAY,UAAU;AAAA,QACrC;AAAA,MACF;AAEF,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAGA,UAAI,KAAK,WAAW;AAClB,cAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,WAAW,MAAM,CAAC,EACxB;AAAA,UACC;AAAA,YACE,GAAG,UAAU,YAAY,UAAU;AAAA,YACnC,GAAG,UAAU,MAAM,KAAK,QAAQ,SAAS,IAAI;AAAA,UAC/C;AAAA,QACF;AAAA,MACJ;AAEA,YAAM,gBAAgB,MAAMA,IACzB,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC,EAC1B,UAAU;AACb,YAAM,UAAU,cAAc,CAAC;AAE/B,kBAAY,KAAK,OAAO;AAAA,IAC1B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB,OAAO,qBAAqB,aAAa,OAAO,KAAK,KAAK,SAAS;AACjF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,MAAM;AAC7B,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,eAAe,oBAAoB;AAAA,IAC/C;AAGA,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd;AAAA,MACC;AAAA,QACE,GAAG,UAAU,IAAI,EAAE;AAAA,QACnB,GAAG,UAAU,YAAY,UAAU;AAAA,MACrC;AAAA,IACF;AAEF,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAEA,UAAMA,IAAG,OAAO,SAAS,EAAE,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAErD,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,qBAAqB;AAAA,EACnC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,SAAS,IAAI,MAAM,QAAQ;AACjC,YAAM,UAAU,IAAI,MAAM,SAAS;AAEnC,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ;AACV,mBAAW;AAAA,UACT;AAAA,YACE,KAAK,UAAU,OAAO,IAAI,MAAM,GAAG;AAAA,YACnC,KAAK,UAAU,WAAW,IAAI,MAAM,GAAG;AAAA,YACvC,KAAK,UAAU,UAAU,IAAI,MAAM,GAAG;AAAA,UACxC;AAAA,QACF;AAAA,MACF;AAEA,UAAI,YAAY,QAAW;AACzB,mBAAW,KAAK,GAAG,UAAU,SAAS,YAAY,MAAM,CAAC;AAAA,MAC3D;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd,MAAM,WAAW;AACpB,YAAME,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,eAAe,MAAMF,IACxB,OAAO;AAAA,QACN,IAAI,UAAU;AAAA,QACd,OAAO,UAAU;AAAA,QACjB,WAAW,UAAU;AAAA,QACrB,UAAU,UAAU;AAAA,QACpB,OAAO,UAAU;AAAA,QACjB,SAAS,UAAU;AAAA,QACnB,UAAU,UAAU;AAAA,QACpB,YAAY,YAAoB,OAAO,EAAE,IAAI,GAAG,aAAa;AAAA,QAC7D,YAAY,sBAA8B,OAAO,aAAa,wBAAwB,GAAG,aAAa;AAAA,QACtG,cAAc,sBAA8B,OAAO,aAAa,kBAAkB,OAAO,EAAE,2BAA2B,GAAG,eAAe;AAAA,QACxI,YAAY,6BAAqC,OAAO,aAAa,kBAAkB,OAAO,aAAa,mBAAmB,GAAG,aAAa;AAAA,QAC9I,MAAM,6BAAqC,OAAO,aAAa,mBAAmB,OAAO,aAAa,mBAAmB,GAAG,MAAM;AAAA,QAClI,WAAW,UAAU;AAAA,MACvB,CAAC,EACA,KAAK,SAAS,EACd,SAAS,QAAQ,GAAG,OAAO,YAAY,UAAU,EAAE,CAAC,EACpD,MAAM,WAAW,EACjB;AAAA,QACC,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,QACV,UAAU;AAAA,MACZ,EACC,QAAQ,KAAK,UAAU,SAAS,CAAC,EACjC,MAAM,KAAK,EACX,OAAO,MAAM;AAGhB,YAAM,gBAAgB,aAAa,IAAI,QAAM;AAAA,QAC3C,GAAG;AAAA,QACH,aAAa,EAAE;AAAA,QACf,YAAY,OAAO,EAAE,UAAU;AAAA,QAC/B,cAAc,OAAO,EAAE,YAAY;AAAA,QACnC,YAAY,OAAO,EAAE,UAAU;AAAA,QAC/B,MAAM,OAAO,EAAE,IAAI;AAAA,QACnB,YAAY;AAAA,MACd,EAAE;AAEF,kBAAY,KAAK,eAAe,KAAK,qBAAqB,MAAM,OAAO,OAAOE,MAAK,CAAC,CAAC;AAAA,IACvF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMF,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,KAAK,KAAK,CAAC;AAExC,UAAI,kBAAkB;AACpB,cAAM,IAAI,gBAAgB,2CAA2C;AAAA,MACvE;AAGA,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,SAAS,EAChB,OAAO;AAAA,QACN,OAAO,KAAK;AAAA,QACZ,WAAW,KAAK,aAAa;AAAA,QAC7B,UAAU,KAAK,YAAY;AAAA,QAC3B,OAAO,KAAK,SAAS;AAAA,QACrB,SAAS,KAAK,WAAW;AAAA,QACzB,UAAU,KAAK,YAAY;AAAA,QAC3B,kBAAkB,KAAK,oBAAoB;AAAA,QAC3C,OAAO,KAAK,SAAS;AAAA,QACrB,MAAM,KAAK,QAAQ;AAAA,MACrB,CAAC,EACA,UAAU;AACb,YAAM,WAAW,eAAe,CAAC;AAEjC,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB,IAAI,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/E,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAE7B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,YAAY,EAAE,CAAC;AAGrC,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,IAAI,OAAO;AAAA,MACX,aAAa,OAAO;AAAA,MACpB,QAAQ,OAAO;AAAA,MACf,eAAe,OAAO;AAAA,MACtB,eAAe,OAAO;AAAA,MACtB,WAAW,OAAO;AAAA,IACpB,CAAC,EACA,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,EAAE,CAAC,EAC/B,QAAQ,KAAK,OAAO,SAAS,CAAC,EAC9B,MAAM,EAAE;AAGX,UAAM,mBAAmB,MAAMA,IAC5B,OAAO;AAAA,MACN,YAAY,wBAAgC,OAAO,aAAa;AAAA,IAClE,CAAC,EACA,KAAK,MAAM,EACX;AAAA,MACC;AAAA,QACE,GAAG,OAAO,YAAY,EAAE;AAAA,QACxB,GAAG,OAAO,eAAe,MAAM;AAAA,MACjC;AAAA,IACF;AACF,UAAM,aAAa,OAAO,iBAAiB,CAAC,GAAG,cAAc,CAAC;AAG9D,UAAM,aAAa,MAAMA,IACtB,OAAO;AAAA,MACN,MAAM,wBAAgC,OAAO,aAAa;AAAA,IAC5D,CAAC,EACA,KAAK,MAAM,EACX;AAAA,MACC;AAAA,QACE,GAAG,OAAO,YAAY,EAAE;AAAA,QACxB,MAAM,OAAO,aAAa;AAAA,MAC5B;AAAA,IACF;AACF,UAAM,OAAO,OAAO,WAAW,CAAC,GAAG,QAAQ,CAAC;AAG5C,UAAM,oBAAoB,MAAMA,IAC7B,OAAO;AAAA,MACN,aAAa;AAAA,MACb,YAAY,sBAA8B,OAAO,aAAa;AAAA,MAC9D,cAAc,sBAA8B,OAAO,aAAa;AAAA,IAClE,CAAC,EACA,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,EAAE,CAAC;AAClC,UAAM,cAAc,OAAO,kBAAkB,CAAC,GAAG,eAAe,CAAC;AACjE,UAAM,aAAa,OAAO,kBAAkB,CAAC,GAAG,cAAc,CAAC;AAC/D,UAAM,eAAe,OAAO,kBAAkB,CAAC,GAAG,gBAAgB,CAAC;AAEnE,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,cAAc;AAAA;AAAA,MACd;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,WAAW;AAAA,MACX,cAAc,aAAa,IAAI,QAAM;AAAA,QACnC,GAAG;AAAA,QACH,eAAe,OAAO,EAAE,aAAa;AAAA,MACvC,EAAE;AAAA,IACJ,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,yBAAyB;AAAA,EACtC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAE7B,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,UAAI,KAAK,OAAO;AACd,cAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd;AAAA,UACC;AAAA,YACE,GAAG,UAAU,OAAO,KAAK,KAAK;AAAA,YAC9B,MAAM,UAAU,EAAE,OAAO,EAAE;AAAA,UAC7B;AAAA,QACF;AAEF,YAAI,aAAa;AACf,gBAAM,IAAI,gBAAgB,2CAA2C;AAAA,QACvE;AAAA,MACF;AAEA,YAAM,iBAAiB,MAAMA,IAC1B,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC,EAC1B,UAAU;AACb,YAAM,WAAW,eAAe,CAAC;AAEjC,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,cAAc;AAAA;AAAA,MAChB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAClF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAE7B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAMA,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,MACH,UAAU;AAAA,MACV,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAE7B,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACzF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,OAAO,IAAI;AAGlC,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAErC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EACP,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,YAAY,UAAU,CAAC;AAE7C,gBAAY,KAAK,iBAAiB;AAAA,EACpC,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAaD,cAAa;AAAA,EAC1B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,OAAO,IAAI;AAClC,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAErC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,UAAI,KAAK,WAAW;AAClB,cAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,WAAW,MAAM,CAAC,EACxB;AAAA,UACC;AAAA,YACE,GAAG,UAAU,YAAY,UAAU;AAAA,YACnC,GAAG,UAAU,MAAM,KAAK,IAAI;AAAA,UAC9B;AAAA,QACF;AAAA,MACJ;AAEA,YAAM,gBAAgB,MAAMA,IACzB,OAAO,SAAS,EAChB,OAAO;AAAA,QACN;AAAA,QACA,GAAG;AAAA,MACL,CAAC,EACA,UAAU;AACb,YAAM,UAAU,cAAc,CAAC;AAE/B,kBAAY,KAAK,OAAO;AAAA,IAC1B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAaD,eAAc,QAAQ,CAAC;AAAA,EACpC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,OAAO,IAAI;AAClC,YAAM,YAAY,IAAI,OAAO,WAAW;AACxC,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,UAAU,CAAC;AAErC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,SAAS,EACd;AAAA,QACC;AAAA,UACE,GAAG,UAAU,IAAI,SAAS;AAAA,UAC1B,GAAG,UAAU,YAAY,UAAU;AAAA,QACrC;AAAA,MACF;AAEF,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAGA,UAAI,KAAK,WAAW;AAClB,cAAMA,IACH,OAAO,SAAS,EAChB,IAAI,EAAE,WAAW,MAAM,CAAC,EACxB;AAAA,UACC;AAAA,YACE,GAAG,UAAU,YAAY,UAAU;AAAA,YACnC,GAAG,UAAU,MAAM,KAAK,QAAQ,SAAS,IAAI;AAAA,UAC/C;AAAA,QACF;AAAA,MACJ;AAEA,YAAM,gBAAgB,MAAMA,IACzB,OAAO,SAAS,EAChB,IAAI;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,SAAS,CAAC,EACjC,UAAU;AACb,YAAM,UAAU,cAAc,CAAC;AAE/B,kBAAY,KAAK,OAAO;AAAA,IAC1B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,aAAa,IAAI,OAAO,IAAI;AAClC,YAAM,YAAY,IAAI,OAAO,WAAW;AAGxC,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd;AAAA,QACC;AAAA,UACE,GAAG,UAAU,IAAI,SAAS;AAAA,UAC1B,GAAG,UAAU,YAAY,UAAU;AAAA,QACrC;AAAA,MACF;AAEF,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,mBAAmB;AAAA,MAC7C;AAEA,YAAMA,IAAG,OAAO,SAAS,EAAE,MAAM,GAAG,UAAU,IAAI,SAAS,CAAC;AAE5D,oBAAc,GAAG;AAAA,IACnB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB,IAAI,eAAe,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AAEzF,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,EAAE,CAAC;AAClC,UAAME,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,UAAM,YAAY,MAAMF,IACrB,OAAO,EACP,KAAK,MAAM,EACX,MAAM,GAAG,OAAO,YAAY,EAAE,CAAC,EAC/B,QAAQ,KAAK,OAAO,SAAS,CAAC,EAC9B,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB;AAAA,MACE;AAAA,MACA,UAAU,IAAI,QAAM;AAAA,QAClB,IAAI,EAAE;AAAA,QACN,aAAa,EAAE;AAAA,QACf,QAAQ,EAAE;AAAA,QACV,eAAe,EAAE;AAAA,QACjB,OAAO,OAAO,EAAE,aAAa;AAAA,QAC7B,WAAW,EAAE;AAAA,MACf,EAAE;AAAA,MACF;AAAA,MACA,qBAAqB,MAAM,OAAO,OAAOE,MAAK,CAAC;AAAA,IACjD;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,+BAA+B,aAAa,OAAO,KAAK,KAAK,SAAS;AACxF,MAAI;AACF,UAAM,aAAa,IAAI,MAAM;AAE7B,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,eAAe,oBAAoB;AAAA,IAC/C;AAEA,UAAM,WAAW,MAAM,oBAAoB,kBAAkB,YAAY,EAAE;AAE3E,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB;AAAA,EACd;AAAA,EACA;AAAA,EACA,cAAc,qBAAqB;AAAA,EACnC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,aAAa,IAAI,MAAM;AAE7B,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,eAAe,oBAAoB;AAAA,MAC/C;AAEA,YAAM;AAAA,QACJ;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF,IAAI,IAAI;AAGR,YAAM,UAAuD;AAAA,QAC3D,SAAS;AAAA;AAAA,QACT,WAAW,YAAY,IAAI,KAAK,SAAmB,IAAI;AAAA,QACvD,SAAS,UAAU,IAAI,KAAK,OAAiB,IAAI;AAAA,QACjD,YAAY,YAAY,CAAC,SAA8B,IAAI;AAAA,QAC3D,OAAO,QAAQ,SAAS,OAAiB,EAAE,IAAI;AAAA,QAC/C,QAAQ,SAAS,SAAS,QAAkB,EAAE,IAAI;AAAA,MACpD;AAEA,YAAM,OAAO,MAAM,gBAAgB,MAAM,OAAO;AAEhD,kBAAY,KAAK,IAAI;AAAA,IACvB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,gBAAgB,KAAK,+BAA+B,cAAc,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAMF,MAAK,MAAM;AAGjB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,UAAU,IAAI,OAAO,UAAU,MAAM,CAAC,EACnD,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,IAAI,EAAE,CAAC;AAE7B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAGA,UAAM,oBAAoB,cAAc,EAAE;AAE1C,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,OAAO,SAAS;AAAA,IAClB,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACnsCD,IAAAG,kBAAuB;AACvB,IAAAC,eAAkB;AAOX,IAAM,uBAAmB,wBAAO;AAMvC,IAAM,wBAAwB,eAAE,OAAO;AAAA,EACrC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,EAAE,EAAE,UAAU,OAAK,EAAE,YAAY,CAAC;AAAA,EAC9D,aAAa,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,cAAc,eAAE,KAAK,CAAC,cAAc,cAAc,CAAC;AAAA,EACnD,eAAe,eAAE,OAAO,EAAE,SAAS;AAAA,EACnC,oBAAoB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC/C,uBAAuB,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EACtD,YAAY,eAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EACjD,uBAAuB,eAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EAC5D,UAAU,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EACzC,WAAW,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EAC1C,UAAU,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAC/C,CAAC;AAED,IAAM,wBAAwB,sBAAsB,QAAQ,EAAE,KAAK,EAAE,MAAM,KAAK,CAAC;AAEjF,IAAM,yBAAyB,eAAE,OAAO;AAAA,EACtC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,UAAU,eAAE,KAAK,CAAC,QAAQ,OAAO,CAAC,EAAE,SAAS;AAAA,EAC7C,QAAQ,eAAE,KAAK,CAAC,UAAU,WAAW,UAAU,CAAC,EAAE,SAAS;AAC7D,CAAC;AAUD,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,eAAE,OAAO,EAAE,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,GAAG,aAAa,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;AAAA,EAClF,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,YAAY,IAAI,IAAI;AAElC,YAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,KAAK,YAAY,CAAC,CAAC;AAEhD,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,gBAAgB,oBAAoB;AAAA,MAChD;AAGA,UAAI,CAAC,UAAU,UAAU;AACvB,cAAM,IAAI,gBAAgB,0BAA0B;AAAA,MACtD;AAGA,YAAM,MAAM,oBAAI,KAAK;AACrB,UAAI,UAAU,YAAY,IAAI,KAAK,UAAU,QAAQ,IAAI,KAAK;AAC5D,cAAM,IAAI,gBAAgB,6BAA6B;AAAA,MACzD;AACA,UAAI,UAAU,aAAa,IAAI,KAAK,UAAU,SAAS,IAAI,KAAK;AAC9D,cAAM,IAAI,gBAAgB,wBAAwB;AAAA,MACpD;AAGA,UAAI,UAAU,cAAc,UAAU,cAAc,UAAU,YAAY;AACxE,cAAM,IAAI,gBAAgB,gCAAgC;AAAA,MAC5D;AAGA,UAAI,UAAU,sBAAsB,cAAc,OAAO,UAAU,kBAAkB,GAAG;AACtF,cAAM,IAAI;AAAA,UACR,4BAA4B,UAAU,kBAAkB;AAAA,QAC1D;AAAA,MACF;AAGA,UAAI;AACJ,UAAI,UAAU,iBAAiB,cAAc;AAC3C,yBAAkB,cAAc,OAAO,UAAU,aAAa,IAAK;AAEnE,YAAI,UAAU,uBAAuB;AACnC,2BAAiB,KAAK,IAAI,gBAAgB,OAAO,UAAU,qBAAqB,CAAC;AAAA,QACnF;AAAA,MACF,OAAO;AACL,yBAAiB,KAAK,IAAI,OAAO,UAAU,aAAa,GAAG,WAAW;AAAA,MACxE;AAEA,kBAAY,KAAK;AAAA,QACf,OAAO;AAAA,QACP,MAAM,UAAU;AAAA,QAChB,cAAc,UAAU;AAAA,QACxB,eAAe,OAAO,UAAU,aAAa;AAAA,QAC7C,gBAAgB,KAAK,MAAM,iBAAiB,GAAG,IAAI;AAAA,QACnD,aAAa,UAAU;AAAA,MACzB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAUA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,sBAAsB;AAAA,EACpC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,QAAQ,UAAU,OAAO,IAAI,IAAI;AAEzC,YAAM,aAAa,CAAC;AACpB,YAAM,MAAM,oBAAI,KAAK;AAErB,UAAI,QAAQ;AACV,mBAAW;AAAA,UACT;AAAA,YACE,KAAK,WAAW,MAAM,IAAK,OAAkB,YAAY,CAAC,GAAG;AAAA,YAC7D,KAAK,WAAW,aAAa,IAAI,MAAM,GAAG;AAAA,UAC5C;AAAA,QACF;AAAA,MACF;AAEA,UAAI,aAAa,QAAW;AAC1B,mBAAW,KAAK,GAAG,WAAW,UAAU,aAAa,MAAM,CAAC;AAAA,MAC9D;AAEA,UAAI,WAAW,UAAU;AACvB,mBAAW,KAAK,GAAG,WAAW,UAAU,IAAI,CAAC;AAC7C,mBAAW;AAAA,UACT;AAAA,YACE,MAAM,WAAW,QAAQ;AAAA,YACzB,IAAI,WAAW,UAAU,GAAG;AAAA,UAC9B;AAAA,QACF;AACA,mBAAW;AAAA,UACT;AAAA,YACE,MAAM,WAAW,SAAS;AAAA,YAC1B,IAAI,WAAW,WAAW,GAAG;AAAA,UAC/B;AAAA,QACF;AAAA,MACF,WAAW,WAAW,WAAW;AAC/B,mBAAW,KAAK,IAAI,WAAW,WAAW,GAAG,CAAC;AAAA,MAChD,WAAW,WAAW,YAAY;AAChC,mBAAW,KAAK,IAAI,WAAW,UAAU,GAAG,CAAC;AAAA,MAC/C;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU,EACf,MAAM,WAAW;AACpB,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,gBAAgB,MAAMD,IACzB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,WAAW,EACjB,QAAQ,KAAK,WAAW,SAAS,CAAC,EAClC,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,YAAM,gBAAgB,cAAc,IAAI,SAAO;AAAA,QAC7C,GAAG;AAAA,QACH,eAAe,OAAO,GAAG,aAAa;AAAA,QACtC,oBAAoB,GAAG,qBAAqB,OAAO,GAAG,kBAAkB,IAAI;AAAA,QAC5E,uBAAuB,GAAG,wBAAwB,OAAO,GAAG,qBAAqB,IAAI;AAAA,QACrF,WAAW,GAAG,YAAY,IAAI,KAAK,GAAG,SAAS,IAAI,MAAM;AAAA,QACzD,YAAY,GAAG,WAAW,IAAI,KAAK,GAAG,QAAQ,IAAI,MAAM;AAAA,MAC1D,EAAE;AAEF,kBAAY,KAAK,eAAe,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,IACvF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,IAAI,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAChF,MAAI;AACF,UAAMD,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,eAAe,OAAO,UAAU,aAAa;AAAA,MAC7C,oBAAoB,UAAU,qBAAqB,OAAO,UAAU,kBAAkB,IAAI;AAAA,MAC1F,uBAAuB,UAAU,wBAAwB,OAAO,UAAU,qBAAqB,IAAI;AAAA,IACrG,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,qBAAqB;AAAA,EAClC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,WAAW,GAAG,CAAC,EAC5B,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,KAAK,IAAI,CAAC;AAEvC,UAAI,UAAU;AACZ,cAAM,IAAI,cAAc,2BAA2B;AAAA,MACrD;AAGA,UAAI,KAAK,iBAAiB,gBAAgB,KAAK,gBAAgB,KAAK;AAClE,cAAM,IAAI,gBAAgB,wCAAwC;AAAA,MACpE;AAGA,UAAI,KAAK,YAAY,KAAK,WAAW;AACnC,YAAI,IAAI,KAAK,KAAK,QAAQ,KAAK,IAAI,KAAK,KAAK,SAAS,GAAG;AACvD,gBAAM,IAAI,gBAAgB,uCAAuC;AAAA,QACnE;AAAA,MACF;AAEA,YAAM,kBAAkB,MAAMA,IAC3B,OAAO,UAAU,EACjB,OAAO;AAAA,QACN,GAAG;AAAA,QACH,UAAU,KAAK,WAAW,IAAI,KAAK,KAAK,QAAQ,IAAI;AAAA,QACpD,WAAW,KAAK,YAAY,IAAI,KAAK,KAAK,SAAS,IAAI;AAAA,MACzD,CAAC,EACA,UAAU;AACb,YAAM,YAAY,gBAAgB,CAAC;AAEnC,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,gBAAgB,6BAA6B;AAAA,MACzD;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,eAAe,OAAO,UAAU,aAAa;AAAA,QAC7C,oBAAoB,UAAU,qBAAqB,OAAO,UAAU,kBAAkB,IAAI;AAAA,QAC1F,uBAAuB,UAAU,wBAAwB,OAAO,UAAU,qBAAqB,IAAI;AAAA,MACrG,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,qBAAqB;AAAA,EAClC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,sBAAsB;AAAA,MAChD;AAGA,UAAI,KAAK,iBAAiB,gBAAgB,KAAK,iBAAiB,KAAK,gBAAgB,KAAK;AACxF,cAAM,IAAI,gBAAgB,wCAAwC;AAAA,MACpE;AAGA,YAAM,WAAW,KAAK,WAAW,IAAI,KAAK,KAAK,QAAQ,IAAI,SAAS;AACpE,YAAM,YAAY,KAAK,YAAY,IAAI,KAAK,KAAK,SAAS,IAAI,SAAS;AACvE,UAAI,YAAY,aAAa,YAAY,WAAW;AAClD,cAAM,IAAI,gBAAgB,uCAAuC;AAAA,MACnE;AAEA,YAAM,aAAsC;AAAA,QAC1C,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,UAAI,KAAK,UAAU,GAAG;AACpB,mBAAW,UAAU,IAAI,IAAI,KAAK,KAAK,UAAU,CAAW;AAAA,MAC9D;AACA,UAAI,KAAK,WAAW,GAAG;AACrB,mBAAW,WAAW,IAAI,IAAI,KAAK,KAAK,WAAW,CAAW;AAAA,MAChE;AAEA,YAAM,kBAAkB,MAAMA,IAC3B,OAAO,UAAU,EACjB,IAAI,UAAU,EACd,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC,EAC3B,UAAU;AACb,YAAM,YAAY,gBAAgB,CAAC;AAEnC,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,cAAc,sBAAsB;AAAA,MAChD;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,eAAe,OAAO,UAAU,aAAa;AAAA,QAC7C,oBAAoB,UAAU,qBAAqB,OAAO,UAAU,kBAAkB,IAAI;AAAA,QAC1F,uBAAuB,UAAU,wBAAwB,OAAO,UAAU,qBAAqB,IAAI;AAAA,MACrG,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACnF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,WAAW,IAAI,YAAY,WAAW,WAAW,CAAC,EAC/D,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAGA,QAAI,SAAS,aAAa,GAAG;AAC3B,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AAEA,UAAMA,IAAG,OAAO,UAAU,EAAE,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAEvD,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,eAAe,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACxF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,UAAM,kBAAkB,MAAMA,IAC3B,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,UAAU,CAAC,SAAS;AAAA,MACpB,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC,EAC3B,UAAU;AACb,UAAM,YAAY,gBAAgB,CAAC;AAEnC,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,eAAe,OAAO,UAAU,aAAa;AAAA,MAC7C,oBAAoB,UAAU,qBAAqB,OAAO,UAAU,kBAAkB,IAAI;AAAA,MAC1F,uBAAuB,UAAU,wBAAwB,OAAO,UAAU,qBAAqB,IAAI;AAAA,IACrG,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAGrB,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU;AAClB,UAAM,QAAQ,YAAY,CAAC,GAAG,SAAS;AAGvC,UAAM,eAAe,MAAMA,IACxB,OAAO,EAAE,QAAQ,cAAsB,CAAC,EACxC,KAAK,UAAU,EACf;AAAA,MACC;AAAA,QACE,GAAG,WAAW,UAAU,IAAI;AAAA,QAC5B;AAAA,UACE,MAAM,WAAW,QAAQ;AAAA,UACzB,IAAI,WAAW,UAAU,GAAG;AAAA,QAC9B;AAAA,QACA;AAAA,UACE,MAAM,WAAW,SAAS;AAAA,UAC1B,IAAI,WAAW,WAAW,GAAG;AAAA,QAC/B;AAAA,MACF;AAAA,IACF;AACF,UAAM,SAAS,aAAa,CAAC,GAAG,UAAU;AAG1C,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,YAAY,mBAA2B,WAAW,UAAU,QAAQ,CAAC,EAC9E,KAAK,UAAU;AAClB,UAAM,aAAa,YAAY,CAAC,GAAG,cAAc;AAGjD,UAAM,WAAW,MAAMA,IACpB,OAAO;AAAA,MACN,MAAM,WAAW;AAAA,MACjB,YAAY,WAAW;AAAA,MACvB,cAAc,WAAW;AAAA,MACzB,eAAe,WAAW;AAAA,IAC5B,CAAC,EACA,KAAK,UAAU,EACf,MAAM,MAAM,WAAW,UAAU,MAAM,EACvC,QAAQ,KAAK,WAAW,UAAU,CAAC,EACnC,MAAM,CAAC;AAEV,gBAAY,KAAK;AAAA,MACf,OAAO,OAAO,KAAK;AAAA,MACnB,QAAQ,OAAO,MAAM;AAAA,MACrB,SAAS,OAAO,KAAK,IAAI,OAAO,MAAM;AAAA,MACtC,YAAY,OAAO,UAAU;AAAA,MAC7B,UAAU,SAAS,IAAI,QAAM;AAAA,QAC3B,GAAG;AAAA,QACH,eAAe,OAAO,EAAE,aAAa;AAAA,MACvC,EAAE;AAAA,IACJ,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AC1fD,IAAAE,kBAAuB;AACvB,IAAAC,eAAkB;;;ACwClB,IAAM,2BAAN,MAA+B;AAAA;AAAA;AAAA;AAAA,EAI7B,MAAM,YAAY,QAA0C;AAC1D,QAAI;AACF,YAAMC,MAAK,MAAM;AAEjB,YAAMA,IAAG,OAAO,mBAAmB,EAAE,OAAO;AAAA,QAC1C,aAAa,OAAO;AAAA,QACpB,cAAc,OAAO;AAAA,QACrB,aAAa,OAAO;AAAA,QACpB,WAAW,OAAO,aAAa;AAAA,QAC/B,SAAS,OAAO;AAAA,QAChB,WAAW,OAAO;AAAA,QAClB,UAAU,OAAO;AAAA,MACnB,CAAC;AAED,aAAO,MAAM,mBAAmB;AAAA,QAC9B,aAAa,OAAO;AAAA,QACpB,cAAc,OAAO;AAAA,MACvB,CAAC;AAAA,IACH,SAAS,OAAO;AAEd,aAAO,MAAM,0BAA0B,EAAE,OAAO,OAAO,CAAC;AAAA,IAC1D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAc,aAAqB,QAAQ,IAAyB;AACxE,UAAMA,MAAK,MAAM;AAEjB,UAAM,aAAa,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,aAAa,WAAW,CAAC,EACtD,QAAQ,KAAK,oBAAoB,SAAS,CAAC,EAC3C,MAAM,KAAK;AAEd,WAAO;AAAA,EACT;AAAA;AAAA,EAIA,MAAM,WAAW,aAAqB,iBAAyB,WAAmC;AAChG,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,aAAa,eAAe;AAAA,MACzC,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,gBAAgB;AAAA,IAC9B,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,WAAW,aAAqB,iBAAyB,SAAoB,WAAmC;AACpH,UAAM,cAAc,SAAS,SACzB,sBAAsB,QAAQ,KAAK,IAAI,CAAC,KACxC,aAAa,eAAe;AAEhC,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd;AAAA,MACA,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,QAAQ;AAAA,IACtB,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,QAAQ,aAAqB,gBAAwB,WAAmC;AAC5F,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,qBAAqB,cAAc;AAAA,MAChD,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,eAAe;AAAA,IAC7B,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,UAAU,aAAqB,YAAoC;AACvE,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,aAAa,uBAAuB,UAAU,KAAK;AAAA,MAChE,WAAW;AAAA,MACX,UAAU,EAAE,WAAW;AAAA,IACzB,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,YAAY,aAAqB,cAAsC;AAC3E,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,eACT,yBAAyB,YAAY,KACrC;AAAA,MACJ,WAAW;AAAA,MACX,WAAW;AAAA,IACb,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,YAAY,aAAqB,QAAiB,cAAsC;AAC5F,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,SACT,uBAAuB,MAAM,KAC7B;AAAA,MACJ,WAAW;AAAA,MACX,WAAW;AAAA,MACX,UAAU,EAAE,OAAO;AAAA,IACrB,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,WAAW,aAAoC;AACnD,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa;AAAA,MACb,WAAW;AAAA,IACb,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,aAAa,aAAqB,SAAiB,aAAqB,WAAmC;AAC/G,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,gCAAgC,WAAW;AAAA,MACxD,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,SAAS,YAAY;AAAA,IACnC,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,cAAc,aAAqB,gBAAwB,oBAA4B,WAAmC;AAC9H,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,2BAA2B,kBAAkB;AAAA,MAC1D,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,gBAAgB,mBAAmB;AAAA,IACjD,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,gBAAgB,aAAoC;AACxD,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa;AAAA,MACb,WAAW;AAAA,IACb,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,iBAAiB,aAAqB,WAAmB,WAAmB,WAAmC;AACnH,UAAM,KAAK,YAAY;AAAA,MACrB;AAAA,MACA,cAAc;AAAA,MACd,aAAa,uBAAuB,SAAS,OAAO,SAAS;AAAA,MAC7D,WAAW,YAAY,UAAU;AAAA,MACjC;AAAA,MACA,UAAU,EAAE,WAAW,UAAU;AAAA,IACnC,CAAC;AAAA,EACH;AACF;AAEO,IAAM,2BAA2B,IAAI,yBAAyB;;;AC1KrE,IAAM,2BAAN,MAA+B;AAAA;AAAA;AAAA;AAAA,EAI7B,MAAM,eACJ,aACA,mBACA,WACA,eACe;AACf,QAAI;AACF,YAAMC,MAAK,MAAM;AAGjB,YAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,WAAW,CAAC;AAEvC,UAAI,CAAC,WAAW;AACd,eAAO,KAAK,+CAA+C,EAAE,YAAY,CAAC;AAC1E;AAAA,MACF;AAGA,YAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,WAAW,CAAC;AAGpD,YAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EAAE,YAAY,mBAA2B,mBAAmB,aAAa,QAAQ,CAAC,EACzF,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,aAAa,WAAW,CAAC;AAExD,YAAM,eAAe,cAAc,cAAc,KAAK;AAGtD,YAAM,WAA6B;AAAA,QACjC,cAAc,UAAU;AAAA,QACxB,eAAe,UAAU;AAAA,QACzB,eAAe,UAAU;AAAA,QACzB,iBAAiB,UAAU;AAAA,QAC3B,QAAQ,UAAU;AAAA,QAClB,UAAU,OAAO,UAAU,QAAQ;AAAA,QACnC,SAAS,UAAU,UAAU,OAAO,UAAU,OAAO,IAAI;AAAA,QACzD,WAAW,UAAU,YAAY,OAAO,UAAU,SAAS,IAAI;AAAA,QAC/D,cAAc,UAAU;AAAA,QACxB,eAAe,UAAU,gBAAgB,OAAO,UAAU,aAAa,IAAI;AAAA,QAC3E,gBAAgB,OAAO,UAAU,cAAc;AAAA,QAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,QAC7B,YAAY,UAAU;AAAA,QACtB,OAAO,UAAU;AAAA,QACjB,oBAAoB,UAAU;AAAA,QAC9B,OAAO,MAAM,IAAI,CAAC,UAAU;AAAA,UAC1B,WAAW,KAAK;AAAA,UAChB,WAAW,KAAK;AAAA,UAChB,MAAM,KAAK;AAAA,UACX,aAAa,KAAK;AAAA,UAClB,KAAK,KAAK;AAAA,UACV,UAAU,KAAK;AAAA,UACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAClC,EAAE;AAAA,MACJ;AAGA,YAAMA,IAAG,OAAO,kBAAkB,EAAE,OAAO;AAAA,QACzC;AAAA,QACA,eAAe;AAAA,QACf;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF,CAAC;AAED,aAAO,MAAM,oBAAoB;AAAA,QAC/B;AAAA,QACA,eAAe;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AAEd,aAAO,MAAM,6BAA6B,EAAE,OAAO,YAAY,CAAC;AAAA,IAClE;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,aAAa,aAA0C;AAC3D,UAAMA,MAAK,MAAM;AAEjB,UAAM,YAAY,MAAMA,IACrB,OAAO,EACP,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,aAAa,WAAW,CAAC,EACrD,QAAQ,KAAK,mBAAmB,aAAa,CAAC;AAEjD,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,YAAY,YAA8C;AAC9D,UAAMA,MAAK,MAAM;AAEjB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,IAAI,UAAU,CAAC;AAE9C,WAAQ,YAAyB;AAAA,EACnC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,iBACJ,aACA,aACA,aAWQ;AACR,UAAMA,MAAK,MAAM;AAGjB,UAAM,YAAY,MAAM,KAAK,YAAY,WAAW;AACpD,QAAI,CAAC,WAAW;AAAC,aAAO;AAAA,IAAK;AAE7B,QAAI;AACJ,QAAI;AAEJ,QAAI,aAAa;AAEf,YAAM,YAAY,MAAM,KAAK,YAAY,WAAW;AACpD,UAAI,CAAC,WAAW;AAAC,eAAO;AAAA,MAAK;AAC7B,kBAAY,UAAU;AACtB,iBAAW,UAAU;AAAA,IACvB,OAAO;AAEL,YAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,WAAW,CAAC;AAEvC,UAAI,CAAC,WAAW;AAAC,eAAO;AAAA,MAAK;AAE7B,YAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,WAAW,CAAC;AAEpD,kBAAY;AAAA,QACV,cAAc,UAAU;AAAA,QACxB,eAAe,UAAU;AAAA,QACzB,eAAe,UAAU;AAAA,QACzB,iBAAiB,UAAU;AAAA,QAC3B,QAAQ,UAAU;AAAA,QAClB,UAAU,OAAO,UAAU,QAAQ;AAAA,QACnC,SAAS,UAAU,UAAU,OAAO,UAAU,OAAO,IAAI;AAAA,QACzD,WAAW,UAAU,YAAY,OAAO,UAAU,SAAS,IAAI;AAAA,QAC/D,cAAc,UAAU;AAAA,QACxB,eAAe,UAAU,gBAAgB,OAAO,UAAU,aAAa,IAAI;AAAA,QAC3E,gBAAgB,OAAO,UAAU,cAAc;AAAA,QAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,QAC7B,YAAY,UAAU;AAAA,QACtB,OAAO,UAAU;AAAA,QACjB,oBAAoB,UAAU;AAAA,QAC9B,OAAO,MAAM,IAAI,CAAC,UAAU;AAAA,UAC1B,WAAW,KAAK;AAAA,UAChB,WAAW,KAAK;AAAA,UAChB,MAAM,KAAK;AAAA,UACX,aAAa,KAAK;AAAA,UAClB,KAAK,KAAK;AAAA,UACV,UAAU,KAAK;AAAA,UACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAClC,EAAE;AAAA,MACJ;AACA,iBAAW;AAAA,IACb;AAGA,UAAM,UAA0E,CAAC;AAEjF,UAAM,kBAAkB;AAAA,MACtB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,eAAW,SAAS,iBAAiB;AACnC,YAAM,WAAY,UAAU,SAAgD,KAAK;AACjF,YAAM,WAAY,UAAiD,KAAK;AACxE,UAAI,KAAK,UAAU,QAAQ,MAAM,KAAK,UAAU,QAAQ,GAAG;AACzD,gBAAQ,KAAK,EAAE,OAAO,UAAU,SAAS,CAAC;AAAA,MAC5C;AAAA,IACF;AAGA,QAAI,KAAK,UAAU,UAAU,SAAS,KAAK,MAAM,KAAK,UAAU,UAAU,KAAK,GAAG;AAChF,cAAQ,KAAK;AAAA,QACX,OAAO;AAAA,QACP,UAAU,GAAG,UAAU,SAAS,MAAM,MAAM;AAAA,QAC5C,UAAU,GAAG,UAAU,MAAM,MAAM;AAAA,MACrC,CAAC;AAAA,IACH;AAEA,WAAO;AAAA,MACL,UAAU,UAAU;AAAA,MACpB;AAAA,MACA,WAAW,UAAU;AAAA,MACrB;AAAA,MACA;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBACJ,aACA,YACA,YACA,gBACkB;AAClB,UAAMA,MAAK,MAAM;AAEjB,UAAM,WAAW,MAAM,KAAK,YAAY,UAAU;AAClD,QAAI,CAAC,YAAY,SAAS,gBAAgB,aAAa;AACrD,aAAO;AAAA,IACT;AAGA,UAAM,KAAK;AAAA,MACT;AAAA,MACA,yBAAyB,SAAS,aAAa;AAAA,MAC/C;AAAA,MACA;AAAA,IACF;AAGA,UAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,aAAa,WAAW,CAAC;AAGjF,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,cAAc,SAAS,SAAS;AAAA,MAChC,eAAe,SAAS,SAAS;AAAA,MACjC,eAAe,SAAS,SAAS;AAAA,MACjC,iBAAiB,SAAS,SAAS;AAAA,MACnC,QAAQ,SAAS,SAAS;AAAA,MAC1B,UAAU,OAAO,SAAS,SAAS,QAAQ;AAAA,MAC3C,SAAS,SAAS,SAAS,UAAU,OAAO,SAAS,SAAS,OAAO,IAAI;AAAA,MACzE,WAAW,SAAS,SAAS,YAAY,OAAO,SAAS,SAAS,SAAS,IAAI;AAAA,MAC/E,cAAc,SAAS,SAAS;AAAA,MAChC,eAAe,SAAS,SAAS,gBAAgB,OAAO,SAAS,SAAS,aAAa,IAAI;AAAA,MAC3F,gBAAgB,OAAO,SAAS,SAAS,cAAc;AAAA,MACvD,OAAO,OAAO,SAAS,SAAS,KAAK;AAAA,MACrC,OAAO,SAAS,SAAS;AAAA,MACzB,oBAAoB,SAAS,SAAS;AAAA,MACtC,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,WAAW,CAAC;AAGvC,eAAW,QAAQ,SAAS,SAAS,OAAO;AAC1C,YAAMA,IAAG,OAAO,cAAc,EAAE,OAAO;AAAA,QACrC;AAAA,QACA,WAAW,KAAK;AAAA,QAChB,WAAW,KAAK;AAAA,QAChB,MAAM,KAAK;AAAA,QACX,aAAa,KAAK;AAAA,QAClB,KAAK,KAAK;AAAA,QACV,UAAU,KAAK;AAAA,QACf,WAAW,OAAO,KAAK,SAAS;AAAA,MAClC,CAAC;AAAA,IACH;AAEA,WAAO,KAAK,oCAAoC;AAAA,MAC9C;AAAA,MACA;AAAA,MACA,eAAe,SAAS;AAAA,IAC1B,CAAC;AAED,WAAO;AAAA,EACT;AACF;AAEO,IAAM,2BAA2B,IAAI,yBAAyB;;;AFhV9D,IAAM,uBAAmB,wBAAO;AAOvC,IAAM,sBAAsB,eAAE,OAAO;AAAA;AAAA,EAEnC,WAAW,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACtC,WAAW,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA;AAAA,EAGtC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,aAAa,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC3C,KAAK,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAClC,WAAW,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,EAG1C,UAAU,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC;AAAA,EAChC,aAAa,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA;AAC9C,CAAC,EAAE;AAAA,EACD,CAAC,SAAS;AAER,QAAI,KAAK,WAAW;AAClB,aAAO;AAAA,IACT;AACA,WAAO,KAAK,QAAQ,KAAK;AAAA,EAC3B;AAAA,EACA,EAAE,SAAS,uDAAuD;AACpE;AAEA,IAAM,wBAAwB,eAAE,OAAO;AAAA,EACrC,YAAY,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACvC,cAAc,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACvC,eAAe,eAAE,OAAO,EAAE,MAAM;AAAA,EAChC,eAAe,eAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA,EAC3C,iBAAiB,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC9C,OAAO,eAAE,MAAM,mBAAmB,EAAE,IAAI,CAAC;AAAA,EACzC,OAAO,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EACrC,OAAO,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EACrC,WAAW,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,QAAQ,EAAE;AAAA,EACjE,cAAc,eAAE,KAAK,CAAC,cAAc,OAAO,CAAC,EAAE,SAAS;AAAA,EACvD,eAAe,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAC5C,CAAC;AAGD,IAAM,4BAA4B,eAAE,OAAO;AAAA;AAAA,EAEzC,WAAW,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACtC,WAAW,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA;AAAA,EAGtC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,aAAa,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC3C,KAAK,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAClC,WAAW,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA;AAAA,EAG1C,UAAU,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC;AAAA,EAChC,aAAa,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAC9C,CAAC,EAAE;AAAA,EACD,CAAC,SAAS;AACR,QAAI,KAAK,WAAW;AAClB,aAAO;AAAA,IACT;AACA,WAAO,KAAK,QAAQ,KAAK;AAAA,EAC3B;AAAA,EACA,EAAE,SAAS,uDAAuD;AACpE;AAEA,IAAM,wBAAwB,eAAE,OAAO;AAAA,EACrC,cAAc,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAClD,eAAe,eAAE,OAAO,EAAE,MAAM,EAAE,SAAS;AAAA,EAC3C,eAAe,eAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS,EAAE,SAAS;AAAA,EACtD,iBAAiB,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACzD,QAAQ,eAAE,KAAK,CAAC,SAAS,QAAQ,YAAY,YAAY,SAAS,CAAC,EAAE,SAAS;AAAA,EAC9E,OAAO,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EAChD,OAAO,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EAChD,WAAW,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACrD,cAAc,eAAE,KAAK,CAAC,cAAc,OAAO,CAAC,EAAE,SAAS;AAAA,EACvD,eAAe,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA;AAAA,EAC3C,OAAO,eAAE,MAAM,yBAAyB,EAAE,IAAI,CAAC,EAAE,SAAS;AAC5D,CAAC;AAED,IAAM,yBAAyB,eAAE,OAAO;AAAA,EACtC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,QAAQ,eAAE,KAAK,CAAC,SAAS,QAAQ,YAAY,YAAY,SAAS,CAAC,EAAE,SAAS;AAAA,EAC9E,YAAY,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AACzC,CAAC;AAGD,SAAS,wBAAwBC,QAAuB;AACtD,QAAM,QAAO,oBAAI,KAAK,GAAE,YAAY;AACpC,QAAM,WAAW,OAAOA,MAAK,EAAE,SAAS,GAAG,GAAG;AAC9C,SAAO,MAAM,IAAI,IAAI,QAAQ;AAC/B;AAUA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,sBAAsB;AAAA,EACpC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,QAAQ,QAAQ,WAAW,IAAI,IAAI;AAE3C,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ;AACV,mBAAW;AAAA,UACT;AAAA,YACE,KAAK,WAAW,iBAAiB,IAAI,MAAM,GAAG;AAAA,YAC9C,KAAK,WAAW,cAAc,IAAI,MAAM,GAAG;AAAA,YAC3C,KAAK,WAAW,eAAe,IAAI,MAAM,GAAG;AAAA,UAC9C;AAAA,QACF;AAAA,MACF;AAEA,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,WAAW,QAAQ,MAAgE,CAAC;AAAA,MACzG;AAEA,UAAI,YAAY;AACd,mBAAW,KAAK,GAAG,WAAW,YAAY,UAAoB,CAAC;AAAA,MACjE;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU,EACf,MAAM,WAAW;AACpB,YAAMD,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,gBAAgB,MAAMC,IACzB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,WAAW,EACjB,QAAQ,KAAK,WAAW,SAAS,CAAC,EAClC,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,YAAM,gBAAgB,cAAc,IAAI,QAAM;AAAA,QAC5C,GAAG;AAAA,QACH,UAAU,OAAO,EAAE,QAAQ;AAAA,QAC3B,WAAW,OAAO,EAAE,aAAa,CAAC;AAAA,QAClC,gBAAgB,OAAO,EAAE,cAAc;AAAA,QACvC,OAAO,OAAO,EAAE,KAAK;AAAA,QACrB,WAAW,EAAE,aAAa,IAAI,KAAK,EAAE,UAAU,IAAI,oBAAI,KAAK,IAAI;AAAA,MAClE,EAAE;AAEF,kBAAY,KAAK,eAAe,KAAK,qBAAqB,MAAM,OAAO,OAAOD,MAAK,CAAC,CAAC;AAAA,IACvF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,IAAI,UAAU,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAClF,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,eAAe,IAAI,KAAK,IAAI,YAAY,GAAG,IAAI,SAAS,GAAG,CAAC;AAClE,UAAM,mBAAmB,IAAI,KAAK,IAAI,QAAQ,IAAI,IAAI,KAAK,KAAK,KAAK,GAAI;AAGzE,UAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU;AAGlB,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,QAAQ,WAAW;AAAA,MACnB,OAAO;AAAA,IACT,CAAC,EACA,KAAK,UAAU,EACf,QAAQ,WAAW,MAAM;AAG5B,UAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EAAE,OAAO,6BAAqC,CAAC,EACtD,KAAK,UAAU;AAGlB,UAAM,CAAC,mBAAmB,IAAI,MAAMA,IACjC,OAAO,EAAE,OAAO,6BAAqC,CAAC,EACtD,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,QAAQ,UAAU,CAAC;AAG1C,UAAM,CAAC,kBAAkB,IAAI,MAAMA,IAChC,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU,EACf;AAAA,MACC;AAAA,QACE,GAAG,WAAW,QAAQ,MAAM;AAAA,QAC5B,IAAI,WAAW,YAAY,GAAG;AAAA,QAC9B,IAAI,WAAW,YAAY,gBAAgB;AAAA,MAC7C;AAAA,IACF;AAGF,UAAM,CAAC,eAAe,IAAI,MAAMA,IAC7B,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU,EACf,MAAM,IAAI,WAAW,WAAW,YAAY,CAAC;AAGhD,UAAM,YAAY,aAAa,OAAO,CAAC,KAAK,SAAS;AACnD,UAAI,KAAK,MAAM,IAAI,OAAO,KAAK,KAAK;AACpC,aAAO;AAAA,IACT,GAAG,CAAC,CAA2B;AAE/B,UAAM,gBAAgB,UAAU,UAAU,KAAK;AAC/C,UAAM,gBAAgB,UAAU,UAAU,KAAK;AAC/C,UAAM,iBAAiB,UAAU,WAAW,KAAK;AACjD,UAAM,eAAe,gBAAgB,gBAAgB;AACrD,UAAM,iBAAiB,eAAe,KAAM,gBAAgB,kBAAkB,eAAgB,MAAM;AAEpG,gBAAY,KAAK;AAAA,MACf,OAAO,OAAO,aAAa,SAAS,CAAC;AAAA,MACrC,UAAU;AAAA,QACR,OAAO,UAAU,OAAO,KAAK;AAAA,QAC7B,MAAM,UAAU,MAAM,KAAK;AAAA,QAC3B,UAAU,UAAU,UAAU,KAAK;AAAA,QACnC,UAAU,UAAU,UAAU,KAAK;AAAA,QACnC,SAAS,UAAU,SAAS,KAAK;AAAA,QACjC,WAAW,UAAU,WAAW,KAAK;AAAA,MACvC;AAAA,MACA,YAAY,OAAO,kBAAkB,SAAS,CAAC;AAAA,MAC/C,eAAe,OAAO,qBAAqB,SAAS,CAAC;AAAA,MACrD,gBAAgB,KAAK,MAAM,iBAAiB,GAAG,IAAI;AAAA,MACnD,cAAc,OAAO,oBAAoB,SAAS,CAAC;AAAA,MACnD,WAAW,OAAO,iBAAiB,SAAS,CAAC;AAAA,IAC/C,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AAKrB,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EAAE,IAAI,WAAW,IAAI,iBAAiB,WAAW,gBAAgB,CAAC,EACzE,KAAK,UAAU,EACf;AAAA,MACC;AAAA,QACE,GAAG,WAAW,QAAQ,MAAM;AAAA,QAC5B,IAAI,WAAW,YAAY,GAAG;AAAA,MAChC;AAAA,IACF;AAEF,QAAI,kBAAkB,WAAW,GAAG;AAClC,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,SAAS;AAAA,MACX,CAAC;AACD;AAAA,IACF;AAGA,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW;AAAA,IACb,CAAC,EACA;AAAA,MACC;AAAA,QACE,GAAG,WAAW,QAAQ,MAAM;AAAA,QAC5B,IAAI,WAAW,YAAY,GAAG;AAAA,MAChC;AAAA,IACF;AAGF,eAAW,KAAK,mBAAmB;AACjC,YAAM,yBAAyB,YAAY;AAAA,QACzC,aAAa,EAAE;AAAA,QACf,cAAc;AAAA,QACd,aAAa;AAAA,QACb,WAAW;AAAA,QACX,WAAW;AAAA,QACX,UAAU;AAAA,UACR,gBAAgB;AAAA,UAChB,WAAW;AAAA,UACX,WAAW;AAAA,QACb;AAAA,MACF,CAAC;AAAA,IACH;AAEA,WAAO,KAAK,2BAA2B;AAAA,MACrC,OAAO,kBAAkB;AAAA,MACzB,kBAAkB,kBAAkB,IAAI,OAAK,EAAE,eAAe;AAAA,IAChE,CAAC;AAED,gBAAY,KAAK;AAAA,MACf,SAAS,kBAAkB;AAAA,MAC3B,YAAY,kBAAkB,IAAI,OAAK,EAAE,eAAe;AAAA,MACxD,SAAS,GAAG,kBAAkB,MAAM;AAAA,IACtC,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,IAAM,oBAAoB,eAAE,OAAO;AAAA,EACjC,QAAQ,eAAE,KAAK,CAAC,UAAU,QAAQ,cAAc,CAAC;AAAA,EACjD,KAAK,eAAE,MAAM,eAAE,OAAO,EAAE,KAAK,CAAC,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC9C,QAAQ,eAAE,KAAK,CAAC,SAAS,QAAQ,YAAY,YAAY,SAAS,CAAC,EAAE,SAAS;AAChF,CAAC,EAAE;AAAA,EACD,CAAC,SAAS;AACR,QAAI,KAAK,WAAW,kBAAkB,CAAC,KAAK,QAAQ;AAClD,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AAAA,EACA,EAAE,SAAS,6CAA6C;AAC1D;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,iBAAiB;AAAA,EAC9B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,QAAQ,KAAK,OAAO,IAAI,IAAI;AACpC,YAAM,UAAmD,EAAE,SAAS,CAAC,GAAG,QAAQ,CAAC,EAAE;AAEnF,iBAAW,MAAM,KAAK;AACpB,YAAI;AACF,gBAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,cAAI,CAAC,WAAW;AACd,oBAAQ,OAAO,KAAK,EAAE;AACtB;AAAA,UACF;AAEA,kBAAQ,QAAQ;AAAA,YACd,KAAK;AAEH,oBAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AACxE,oBAAMA,IAAG,OAAO,UAAU,EAAE,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AACvD,sBAAQ,QAAQ,KAAK,EAAE;AACvB;AAAA,YAEF,KAAK;AAEH,kBAAI,UAAU,WAAW,SAAS;AAChC,wBAAQ,OAAO,KAAK,EAAE;AACtB;AAAA,cACF;AAGA,oBAAM,kBAAkB,oBAAoB,EAAE;AAC9C,oBAAM,iBAAiB,oBAAI,KAAK;AAChC,6BAAe,QAAQ,eAAe,QAAQ,IAAI,EAAE;AAEpD,oBAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,gBACH,QAAQ;AAAA,gBACR;AAAA,gBACA;AAAA,gBACA,WAAW,oBAAI,KAAK;AAAA,cACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAG9B,oBAAM,yBAAyB;AAAA,gBAC7B;AAAA,gBACA,UAAU;AAAA,gBACT,IAAqC,MAAM;AAAA,cAC9C,EAAE,MAAM,MAAM;AAAA,cAAC,CAAC;AAEhB,sBAAQ,QAAQ,KAAK,EAAE;AACvB;AAAA,YAEF,KAAK;AACH,kBAAI,CAAC,QAAQ;AACX,wBAAQ,OAAO,KAAK,EAAE;AACtB;AAAA,cACF;AAEA,oBAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,gBACH;AAAA,gBACA,WAAW,oBAAI,KAAK;AAAA,cACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAG9B,oBAAM,yBAAyB;AAAA,gBAC7B;AAAA,gBACA,UAAU;AAAA,gBACV;AAAA,gBACC,IAAqC,MAAM;AAAA,cAC9C,EAAE,MAAM,MAAM;AAAA,cAAC,CAAC;AAEhB,sBAAQ,QAAQ,KAAK,EAAE;AACvB;AAAA,UACJ;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,MAAM,eAAe,MAAM,eAAe,EAAE,KAAK,KAAK;AAC7D,kBAAQ,OAAO,KAAK,EAAE;AAAA,QACxB;AAAA,MACF;AAEA,kBAAY,KAAK;AAAA,QACf;AAAA,QACA;AAAA,QACA,SAAS,QAAQ,MAAM,eAAe,QAAQ,QAAQ,MAAM,gBAAgB,QAAQ,OAAO,MAAM;AAAA,MACnG,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,IAAI,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAChF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAE3C,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,UAAU,OAAO,UAAU,QAAQ;AAAA,MACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,MACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,MAC1C,gBAAgB,OAAO,UAAU,cAAc;AAAA,MAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,MAC7B,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,GAAG;AAAA,QACH,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,MAC3C,EAAE;AAAA,IACJ,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,qBAAqB;AAAA,EAClC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU;AAClB,YAAM,SAAS,YAAY,CAAC,GAAG,SAAS;AACxC,YAAM,kBAAkB,wBAAwB,OAAO,MAAM,IAAI,CAAC;AAGlE,YAAM,aAAa,oBAAI,KAAK;AAC5B,iBAAW,QAAQ,WAAW,QAAQ,KAAK,KAAK,aAAa,GAAG;AAGhE,YAAM,iBASD,CAAC;AAEN,UAAI,WAAW;AAEf,iBAAW,QAAQ,KAAK,OAAO;AAE7B,YAAI,KAAK,WAAW;AAElB,gBAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAExC,cAAI,CAAC,SAAS;AACZ,kBAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,UAClE;AAEA,cAAI,YAAY,OAAO,QAAQ,SAAS;AACxC,cAAI,MAAM,QAAQ;AAClB,cAAI,YAA2B;AAE/B,cAAI,KAAK,WAAW;AAClB,kBAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAE/C,gBAAI,SAAS;AACX,0BAAY,OAAO,QAAQ,SAAS;AACpC,oBAAM,QAAQ;AACd,0BAAY,QAAQ;AAAA,YACtB;AAAA,UACF;AAGA,cAAI,KAAK,aAAa;AACpB,wBAAY,KAAK;AAAA,UACnB;AAEA,gBAAM,YAAY,YAAY,KAAK;AACnC,sBAAY;AAEZ,yBAAe,KAAK;AAAA,YAClB,WAAW,KAAK;AAAA,YAChB;AAAA,YACA,MAAM,QAAQ;AAAA,YACd,aAAa,QAAQ,eAAe;AAAA,YACpC;AAAA,YACA,UAAU,KAAK;AAAA,YACf;AAAA,YACA,cAAc;AAAA,UAChB,CAAC;AAAA,QACH,OAAO;AAEL,gBAAM,YAAY,KAAK;AACvB,gBAAM,YAAY,YAAY,KAAK;AACnC,sBAAY;AAEZ,yBAAe,KAAK;AAAA,YAClB,WAAW;AAAA,YACX,WAAW;AAAA,YACX,MAAM,KAAK;AAAA;AAAA,YACX,aAAa,KAAK;AAAA,YAClB,KAAK,KAAK,OAAO;AAAA,YACjB,UAAU,KAAK;AAAA,YACf;AAAA,YACA,cAAc;AAAA,UAChB,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,iBAAiB;AACrB,UAAI,KAAK,iBAAiB,KAAK,gBAAgB,GAAG;AAChD,YAAI,KAAK,iBAAiB,cAAc;AACtC,2BAAkB,WAAW,KAAK,gBAAiB;AAAA,QACrD,OAAO;AACL,2BAAiB,KAAK,IAAI,KAAK,eAAe,QAAQ;AAAA,QACxD;AAAA,MACF;AAGA,YAAM,CAAC,UAAU,IAAI,MAAMA,IACxB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAGhC,UAAI,UAAU;AACd,UAAI,cAAc,WAAW,SAAS,OAAO,WAAW,UAAU,UAAU;AAC1E,cAAM,WAAW,WAAW;AAC5B,YAAI,SAAS,eAAe,OAAO,SAAS,aAAa,UAAU;AACjE,oBAAU,SAAS,WAAW;AAAA,QAChC;AAAA,MACF;AAGA,YAAM,gBAAgB,WAAW;AACjC,YAAM,YAAY,gBAAgB;AAGlC,YAAM,QAAQ,gBAAgB;AAG9B,YAAM,kBAAkB,MAAMA,IAC3B,OAAO,UAAU,EACjB,OAAO;AAAA,QACN;AAAA,QACA,YAAY,KAAK;AAAA,QACjB,cAAc,KAAK;AAAA,QACnB,eAAe,KAAK,cAAc,YAAY;AAAA,QAC9C,eAAe,KAAK;AAAA,QACpB,iBAAiB,KAAK;AAAA,QACtB,QAAQ;AAAA,QACR,UAAU;AAAA,QACV,UAAU,OAAO,QAAQ;AAAA,QACzB,SAAS,OAAO,OAAO;AAAA,QACvB,WAAW,OAAO,SAAS;AAAA,QAC3B,cAAc,KAAK;AAAA,QACnB,eAAe,KAAK,gBAAgB,OAAO,KAAK,aAAa,IAAI;AAAA,QACjE,gBAAgB,OAAO,cAAc;AAAA,QACrC,OAAO,OAAO,KAAK;AAAA,QACnB;AAAA,QACA,WAAW,KAAK,aAAa;AAAA,QAC7B,OAAO,KAAK;AAAA,QACZ,oBAAoB,KAAK;AAAA,MAC3B,CAAC,EACA,UAAU;AACb,YAAM,YAAY,gBAAgB,CAAC;AAEnC,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,gBAAgB,4BAA4B;AAAA,MACxD;AAGA,iBAAW,QAAQ,gBAAgB;AACjC,cAAMA,IAAG,OAAO,cAAc,EAAE,OAAO;AAAA,UACrC,aAAa,UAAU;AAAA,UACvB,WAAW,KAAK;AAAA,UAChB,WAAW,KAAK;AAAA,UAChB,MAAM,KAAK;AAAA,UACX,aAAa,KAAK;AAAA,UAClB,KAAK,KAAK;AAAA,UACV,UAAU,KAAK;AAAA,UACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAClC,CAAC;AAAA,MACH;AAGA,YAAM,yBAAyB;AAAA,QAC7B,UAAU;AAAA,QACV,UAAU;AAAA,MACZ;AAEA,kBAAY,KAAK;AAAA,QACf,IAAI,UAAU;AAAA,QACd,iBAAiB,UAAU;AAAA,QAC3B,QAAQ,UAAU;AAAA,QAClB,OAAO,OAAO,UAAU,KAAK;AAAA,QAC7B,YAAY,UAAU;AAAA,MACxB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,qBAAqB;AAAA,EAClC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,qBAAqB;AAAA,MAC/C;AAGA,YAAM,qBAAqB,OAAO,KAAK,IAAI,EAAE,WAAW,KAAK,KAAK,QAAQ,MAAM;AAGhF,UAAI,SAAS,WAAW,WAAW,CAAC,oBAAoB;AACtD,cAAM,IAAI,gBAAgB,+FAA+F;AAAA,MAC3H;AAGA,YAAM,yBAAyB;AAAA,QAC7B;AAAA,QACA;AAAA,QACC,IAAmC,MAAM;AAAA,QACzC,IAAqC,MAAM;AAAA,MAC9C,EAAE,MAAM,MAAM;AAAA,MAAC,CAAC;AAGhB,YAAM,aAAsC;AAAA,QAC1C,WAAW,oBAAI,KAAK;AAAA,MACtB;AAGA,UAAI,KAAK,cAAc,MAAM,QAAW;AAAC,mBAAW,cAAc,IAAI,KAAK,cAAc;AAAA,MAAE;AAC3F,UAAI,KAAK,eAAe,MAAM,QAAW;AAAC,mBAAW,eAAe,IAAK,KAAK,eAAe,EAAa,YAAY;AAAA,MAAE;AACxH,UAAI,KAAK,eAAe,MAAM,QAAW;AAAC,mBAAW,eAAe,IAAI,KAAK,eAAe,KAAK;AAAA,MAAK;AACtG,UAAI,KAAK,iBAAiB,MAAM,QAAW;AAAC,mBAAW,iBAAiB,IAAI,KAAK,iBAAiB,KAAK;AAAA,MAAK;AAG5G,UAAI,KAAK,QAAQ,MAAM,QAAW;AAAC,mBAAW,QAAQ,IAAI,KAAK,QAAQ;AAAA,MAAE;AAGzE,UAAI,KAAK,OAAO,MAAM,QAAW;AAAC,mBAAW,OAAO,IAAI,KAAK,OAAO,KAAK;AAAA,MAAK;AAC9E,UAAI,KAAK,OAAO,MAAM,QAAW;AAAC,mBAAW,oBAAoB,IAAI,KAAK,OAAO,KAAK;AAAA,MAAK;AAG3F,UAAI,KAAK,cAAc,MAAM,QAAW;AAAC,mBAAW,cAAc,IAAI,KAAK,cAAc;AAAA,MAAE;AAC3F,UAAI,KAAK,eAAe,MAAM,QAAW;AAAC,mBAAW,eAAe,IAAI,OAAO,KAAK,eAAe,CAAC;AAAA,MAAE;AACtG,UAAI,KAAK,SAAS,MAAM,QAAW;AAAC,mBAAW,SAAS,IAAI,OAAO,KAAK,SAAS,CAAC;AAAA,MAAE;AAGpF,UAAI,KAAK,WAAW,MAAM,QAAW;AACnC,cAAM,aAAa,oBAAI,KAAK;AAC5B,mBAAW,QAAQ,WAAW,QAAQ,IAAK,KAAK,WAAW,CAAY;AACvE,mBAAW,YAAY,IAAI;AAAA,MAC7B;AAGA,YAAM,YAAY,KAAK,OAAO;AAC9B,YAAM,oBAAoB,KAAK,cAAc,MAAM,UACxB,KAAK,eAAe,MAAM,UAC1B,KAAK,SAAS,MAAM,UACnB,aAAa,UAAU,SAAS;AAG5D,UAAI,aAAa,UAAU,SAAS,GAAG;AAErC,cAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAGxE,YAAI,WAAW;AACf,cAAM,iBAQD,CAAC;AAEN,mBAAW,QAAQ,WAAW;AAE5B,cAAI,KAAK,WAAW;AAElB,kBAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,IAAI,KAAK,SAAS,CAAC;AAExC,gBAAI,CAAC,SAAS;AACZ,oBAAM,IAAI,gBAAgB,sBAAsB,KAAK,SAAS,EAAE;AAAA,YAClE;AAEA,gBAAI,YAAY,OAAO,QAAQ,SAAS;AACxC,gBAAI,MAAM,QAAQ;AAElB,gBAAI,YAA2B;AAC/B,gBAAI,KAAK,WAAW;AAClB,oBAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,IAAI,KAAK,SAAS,CAAC;AAE/C,kBAAI,SAAS;AACX,4BAAY,OAAO,QAAQ,SAAS;AACpC,sBAAM,QAAQ;AACd,4BAAY,QAAQ;AAAA,cACtB;AAAA,YACF;AAGA,gBAAI,KAAK,aAAa;AACpB,0BAAY,KAAK;AAAA,YACnB;AAEA,kBAAM,YAAY,YAAY,KAAK;AACnC,wBAAY;AAEZ,2BAAe,KAAK;AAAA,cAClB,WAAW,KAAK;AAAA,cAChB;AAAA,cACA,MAAM,QAAQ;AAAA,cACd,aAAa,QAAQ,eAAe;AAAA,cACpC;AAAA,cACA,UAAU,KAAK;AAAA,cACf;AAAA,YACF,CAAC;AAAA,UACH,OAAO;AAEL,kBAAM,YAAY,KAAK;AACvB,kBAAM,YAAY,YAAY,KAAK;AACnC,wBAAY;AAEZ,2BAAe,KAAK;AAAA,cAClB,WAAW;AAAA,cACX,WAAW;AAAA,cACX,MAAM,KAAK;AAAA;AAAA,cACX,aAAa,KAAK;AAAA,cAClB,KAAK,KAAK,OAAO;AAAA,cACjB,UAAU,KAAK;AAAA,cACf;AAAA,YACF,CAAC;AAAA,UACH;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,gBAAgB,SAAS,gBAAgB;AACnE,cAAM,gBAAgB,KAAK,iBAAiB,OAAO,SAAS,iBAAiB,CAAC;AAC9E,cAAM,UAAU,KAAK,WAAW,OAAO,SAAS,WAAW,CAAC;AAG5D,YAAI,iBAAiB;AACrB,YAAI,iBAAiB,cAAc;AACjC,2BAAkB,WAAW,gBAAiB;AAAA,QAChD,OAAO;AACL,2BAAiB,KAAK,IAAI,eAAe,QAAQ;AAAA,QACnD;AAGA,cAAM,gBAAgB,WAAW;AACjC,cAAM,YAAY,gBAAgB;AAClC,cAAM,QAAQ,gBAAgB;AAG9B,mBAAW,UAAU,IAAI,OAAO,QAAQ;AACxC,mBAAW,gBAAgB,IAAI,OAAO,cAAc;AACpD,mBAAW,WAAW,IAAI,OAAO,SAAS;AAC1C,mBAAW,OAAO,IAAI,OAAO,KAAK;AAGlC,mBAAW,QAAQ,gBAAgB;AACjC,gBAAMA,IAAG,OAAO,cAAc,EAAE,OAAO;AAAA,YACrC,aAAa;AAAA,YACb,WAAW,KAAK;AAAA,YAChB,WAAW,KAAK;AAAA,YAChB,MAAM,KAAK;AAAA,YACX,aAAa,KAAK;AAAA,YAClB,KAAK,KAAK;AAAA,YACV,UAAU,KAAK;AAAA,YACf,WAAW,OAAO,KAAK,SAAS;AAAA,UAClC,CAAC;AAAA,QACH;AAAA,MACF,WAAW,mBAAmB;AAE5B,cAAM,gBAAgB,MAAMA,IACzB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAE3C,cAAM,WAAW,cAAc,OAAO,CAACC,MAAK,SAAS;AACnD,iBAAOA,OAAM,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,QAC7C,GAAG,CAAC;AAGJ,cAAM,eAAgB,KAAK,cAAc,KAAK,SAAS,gBAAgB;AACvE,cAAM,gBAAiB,KAAK,eAAe,KAAK,OAAO,SAAS,iBAAiB,CAAC;AAClF,cAAM,UAAW,KAAK,SAAS,KAAK,OAAO,SAAS,WAAW,CAAC;AAGhE,YAAI,iBAAiB;AACrB,YAAI,iBAAiB,cAAc;AACjC,2BAAkB,WAAW,gBAAiB;AAAA,QAChD,OAAO;AACL,2BAAiB,KAAK,IAAI,eAAe,QAAQ;AAAA,QACnD;AAGA,cAAM,gBAAgB,WAAW;AACjC,cAAM,YAAY,gBAAgB;AAClC,cAAM,QAAQ,gBAAgB;AAG9B,mBAAW,UAAU,IAAI,OAAO,QAAQ;AACxC,mBAAW,gBAAgB,IAAI,OAAO,cAAc;AACpD,mBAAW,WAAW,IAAI,OAAO,SAAS;AAC1C,mBAAW,OAAO,IAAI,OAAO,KAAK;AAAA,MACpC;AAEA,YAAM,kBAAkB,MAAMD,IAC3B,OAAO,UAAU,EACjB,IAAI,UAAU,EACd,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC,EAC3B,UAAU;AACb,YAAM,YAAY,gBAAgB,CAAC;AAEnC,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,cAAc,qBAAqB;AAAA,MAC/C;AAGA,YAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAE3C,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,UAAU,OAAO,UAAU,QAAQ;AAAA,QACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,QACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,QAC1C,gBAAgB,OAAO,UAAU,cAAc;AAAA,QAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,QAC7B,OAAO,MAAM,IAAI,WAAS;AAAA,UACxB,GAAG;AAAA,UACH,WAAW,OAAO,KAAK,SAAS;AAAA,UAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,QAC3C,EAAE;AAAA,MACJ,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACnF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,WAAW,IAAI,QAAQ,WAAW,OAAO,CAAC,EACvD,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAIA,UAAM,oBAAoB,CAAC,SAAS,YAAY,SAAS;AACzD,QAAI,CAAC,kBAAkB,SAAS,SAAS,MAAM,GAAG;AAChD,YAAM,IAAI,gBAAgB,6GAA6G;AAAA,IACzI;AAGA,UAAMA,IAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAGxE,UAAMA,IAAG,OAAO,UAAU,EAAE,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAEvD,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,mBAAmB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,aAAa,MAAM,yBAAyB,cAAc,EAAE;AAElE,gBAAY,KAAK,UAAU;AAAA,EAC7B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,YAAY,MAAM,yBAAyB,aAAa,EAAE;AAChE,gBAAY,KAAK,SAAS;AAAA,EAC5B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,8BAA8B,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACtG,MAAI;AACF,UAAM,aAAa,IAAI,OAAO,YAAY;AAC1C,UAAM,WAAW,MAAM,yBAAyB,YAAY,UAAU;AAEtE,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,sCAAsC,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/G,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,aAAa,IAAI,OAAO,YAAY;AAE1C,UAAM,UAAU,MAAM,yBAAyB;AAAA,MAC7C;AAAA,MACA;AAAA,MACC,IAAmC,MAAM;AAAA,MACzC,IAAqC,MAAM;AAAA,IAC9C;AAEA,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,cAAc,yDAAyD;AAAA,IACnF;AAGA,UAAM,yBAAyB,WAAW,IAAI,IAAI,CAAC,gCAAgC,CAAC,EAAE,MAAM,MAAM;AAAA,IAAC,CAAC;AAEpG,gBAAY,KAAK,EAAE,SAAS,gDAAgD,CAAC;AAAA,EAC/E,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAOD,iBAAiB,IAAI,sCAAsC,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC9G,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,aAAa,IAAI,OAAO,YAAY;AAC1C,UAAM,cAAc,IAAI,MAAM,aAAa;AAE3C,UAAM,aAAa,MAAM,yBAAyB,iBAAiB,IAAI,YAAY,WAAW;AAE9F,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,gBAAY,KAAK,UAAU;AAAA,EAC7B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAOD,iBAAiB,IAAI,YAAY,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACpF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,aAAa,IAAI,MAAM,YAAY;AAEzC,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,eAAe;AAAA,MACnB,aAAa,eAAe;AAAA,MAC5B,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,MAAM,eAAe;AAAA,MACrB,aAAa,eAAe;AAAA,MAC5B,KAAK,eAAe;AAAA,MACpB,UAAU,eAAe;AAAA,MACzB,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,aAAa,SAAS;AAAA,IACxB,CAAC,EACA,KAAK,cAAc,EACnB,SAAS,UAAU,GAAG,eAAe,WAAW,SAAS,EAAE,CAAC,EAC5D,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAG3C,UAAM,aAAa,QAAQ,IAAI,SAAS,KAAK;AAG7C,UAAM,kBAAkB,MAAMA,IAC3B,OAAO,EACP,KAAK,QAAQ,EACb;AAAA,MACC;AAAA,QACE,GAAG,SAAS,KAAK,cAAc;AAAA,QAC/B,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,MACpC;AAAA,IACF;AAEF,UAAM,cAAc,IAAI,IAAoB,gBAAgB,IAAI,OAAK,CAAC,EAAE,KAAK,EAAE,KAAe,CAAC,CAAC;AAGhG,QAAI,WAAW;AAEf,QAAI,YAAY;AACd,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,UAAU,CAAC;AAAA,IAC1C,WAAW,UAAU,eAAe;AAClC,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,UAAU,aAAa,CAAC;AAAA,IACvD,OAAO;AAEL,OAAC,QAAQ,IAAI,MAAMA,IAChB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,WAAW,IAAI,CAAC,EACtC,MAAM,CAAC;AAAA,IACZ;AAGA,UAAM,iBAAiB,WAAW;AAAA,MAChC,cAAc,SAAS;AAAA,MACvB,aAAa,SAAS;AAAA,MACtB,SAAS,SAAS,WAAW;AAAA,MAC7B,iBAAiB,SAAS;AAAA,MAC1B,oBAAoB,SAAS;AAAA,MAC7B,yBAAyB,SAAS;AAAA,MAClC,SAAS,SAAS;AAAA,MAClB,YAAY,SAAS,cAAc;AAAA,MACnC,YAAY,SAAS,cAAc;AAAA,MACnC,iBAAiB,SAAS,mBAAmB;AAAA,IAC/C,IAAI;AAGJ,UAAM,YAAY,MAAM,WAAW,qBAAqB;AAAA,MACtD,iBAAiB,UAAU;AAAA,MAC3B,WAAW,UAAU;AAAA,MACrB,YAAY,UAAU;AAAA,MACtB,QAAQ,UAAU;AAAA,MAElB,cAAc,UAAU;AAAA,MACxB,eAAe,UAAU;AAAA,MACzB,eAAe,UAAU,iBAAiB;AAAA,MAC1C,iBAAiB,UAAU,mBAAmB;AAAA,MAE9C,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,aAAa,KAAK;AAAA,QAClB,KAAK,KAAK,OAAO;AAAA,QACjB,aAAa,KAAK,eAAe;AAAA,QACjC,UAAU,KAAK;AAAA,QACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,QACzC,gBAAgB;AAAA,QAChB,YAAY,KAAK,cAAc,GAAG,UAAU,aAAa,KAAK,WAAW,KAAK;AAAA,MAChF,EAAE;AAAA,MAEF,UAAU,OAAO,UAAU,QAAQ;AAAA,MACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,MACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,MAC1C,gBAAgB;AAAA;AAAA,MAChB,gBAAgB,OAAO,UAAU,cAAc;AAAA,MAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,MAC7B,UAAU,UAAU;AAAA,MAEpB,OAAO,UAAU,SAAS;AAAA,MAC1B,OAAO,UAAU,sBAAsB,YAAY,IAAI,iBAAiB,KAAK;AAAA,MAE7E,aAAa,YAAY,IAAI,cAAc,KAAK;AAAA,MAChD,gBAAgB,YAAY,IAAI,iBAAiB,KAAK;AAAA,MACtD,cAAc,YAAY,IAAI,eAAe,KAAK;AAAA,MAClD,cAAc,YAAY,IAAI,eAAe,KAAK;AAAA,MAClD,gBAAgB,YAAY,IAAI,iBAAiB,KAAK;AAAA,IACxD,GAAG,cAAc;AAGjB,QAAI,UAAU,gBAAgB,iBAAiB;AAC/C,QAAI;AAAA,MACF;AAAA,MACA,yBAAyB,UAAU,eAAe;AAAA,IACpD;AACA,QAAI,UAAU,kBAAkB,UAAU,MAAM;AAEhD,QAAI,KAAK,SAAS;AAAA,EACpB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,aAAa,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,QAAI,UAAU,WAAW,SAAS;AAChC,YAAM,IAAI,gBAAgB,mCAAmC;AAAA,IAC/D;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,eAAe;AAAA,MACnB,aAAa,eAAe;AAAA,MAC5B,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,MAAM,eAAe;AAAA,MACrB,aAAa,eAAe;AAAA,MAC5B,KAAK,eAAe;AAAA,MACpB,UAAU,eAAe;AAAA,MACzB,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,aAAa,SAAS;AAAA,IACxB,CAAC,EACA,KAAK,cAAc,EACnB,SAAS,UAAU,GAAG,eAAe,WAAW,SAAS,EAAE,CAAC,EAC5D,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAG3C,UAAM,aAAa,QAAQ,IAAI,SAAS,KAAK;AAG7C,UAAM,eAAe,MAAMA,IACxB,OAAO,EACP,KAAK,QAAQ,EACb;AAAA,MACC;AAAA,QACE,GAAG,SAAS,KAAK,cAAc;AAAA,QAC/B,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,MACpC;AAAA,IACF;AAEF,UAAM,cAAc,IAAI,IAAI,aAAa,IAAI,OAAK,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;AAGnE,QAAI,iBAAiB,CAAC;AACtB,QAAI,UAAU,eAAe;AAC3B,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,UAAU,aAAa,CAAC;AACrD,UAAI,UAAU;AACZ,yBAAiB;AAAA,UACf,cAAc,SAAS,gBAAgB;AAAA,UACvC,aAAa,SAAS,eAAe;AAAA,UACrC,SAAS,SAAS,WAAW;AAAA,UAC7B,iBAAiB,SAAS,mBAAmB;AAAA,UAC7C,oBAAoB,SAAS,sBAAsB;AAAA,UACnD,YAAY,SAAS,cAAc;AAAA,UACnC,YAAY,SAAS,cAAc;AAAA,QACrC;AAAA,MACF;AAAA,IACF;AAEA,UAAM,cAAe,YAAY,IAAI,cAAc,KAAgB;AACnE,UAAM,eAAgB,YAAY,IAAI,eAAe,KAAgB;AACrE,UAAM,eAAgB,YAAY,IAAI,eAAe,KAAgB;AAGrE,UAAM,YAAY,MAAM,WAAW,qBAAqB;AAAA,MACtD,iBAAiB,UAAU;AAAA,MAC3B,cAAc,UAAU;AAAA,MACxB,eAAe,UAAU;AAAA,MACzB,eAAe,UAAU,iBAAiB;AAAA,MAC1C,iBAAiB,UAAU,mBAAmB;AAAA,MAC9C,iBAAiB,UAAU;AAAA,MAE3B,QAAQ,UAAU;AAAA,MAClB,YAAY,UAAU,cAAc;AAAA,MACpC,WAAW,UAAU;AAAA,MAErB,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,aAAa,KAAK;AAAA,QAClB,aAAa,KAAK,eAAe;AAAA,QACjC,KAAK,KAAK,OAAO;AAAA,QACjB,UAAU,KAAK;AAAA,QACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,QACzC,YAAY,KAAK,cAAc,GAAG,UAAU,aAAa,KAAK,WAAW,KAAK;AAAA,MAChF,EAAE;AAAA,MAEF,UAAU,OAAO,UAAU,QAAQ;AAAA,MACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,MACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,MAC1C,gBAAgB;AAAA,MAChB,gBAAgB,OAAO,UAAU,cAAc;AAAA,MAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,MAC7B,UAAU,UAAU;AAAA,MAEpB,OAAO,UAAU,SAAS;AAAA,MAC1B,OAAO,UAAU,sBAAuB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,MAEzF;AAAA,MACA,gBAAiB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,MAClE,cAAc,gBAAgB;AAAA,MAC9B,cAAc,gBAAgB;AAAA,MAC9B,gBAAiB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,IACpE,GAAG,cAAc;AAGjB,UAAM,YAAY,MAAM,oBAAoB;AAAA,MAC1C;AAAA,QACE,iBAAiB,UAAU;AAAA,QAC3B,cAAc,UAAU;AAAA,QACxB,eAAe,UAAU;AAAA,QACzB,OAAO,OAAO,UAAU,KAAK;AAAA,QAC7B,YAAY,UAAU,cAAc;AAAA,QACpC,UAAU,UAAU;AAAA,QACpB,WAAW,MAAM;AAAA,QACjB;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAAA,MACA;AAAA,IACF;AAEA,QAAI,CAAC,WAAW;AACd,aAAO,KAAK,+CAA+C;AAAA,QACzD,aAAa;AAAA,QACb,eAAe,UAAU;AAAA,MAC3B,CAAC;AAAA,IACH;AAGA,UAAM,kBAAkB,oBAAoB,EAAE;AAC9C,UAAM,iBAAiB,oBAAI,KAAK;AAChC,mBAAe,QAAQ,eAAe,QAAQ,IAAI,EAAE;AAIpD,UAAM,YAAY,UAAU,aAAa;AACzC,UAAM,gBAAgB,oBAAI,KAAK;AAC/B,kBAAc,QAAQ,cAAc,QAAQ,IAAI,SAAS;AAGzD,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ;AAAA,MACA;AAAA,MACA,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAG9B,UAAM,yBAAyB,QAAQ,IAAI,UAAU,aAAa;AAGlE,UAAM,UAAU,QAAQ,IAAI,aAAa,KAAK;AAC9C,UAAM,iBAAiB,GAAG,OAAO,oBAAoB,eAAe;AAEpE,gBAAY,KAAK;AAAA,MACf,SAAS,YAAY,gCAAgC;AAAA,MACrD;AAAA,MACA,iBAAiB,UAAU;AAAA,MAC3B,QAAQ,UAAU;AAAA,MAClB;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,yBAAyB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAClG,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,QAAI,UAAU,WAAW,YAAY;AACnC,YAAM,IAAI,gBAAgB,qDAAqD;AAAA,IACjF;AAEA,QAAI,UAAU,oBAAoB;AAChC,YAAM,IAAI,gBAAgB,kDAAkD;AAAA,IAC9E;AAKA,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT,aAAa,UAAU;AAAA,IACzB,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,IAAI,EAAE,CAAC;AAE9B,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,EAAE,CAAC;AAG3C,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,UAAU;AAClB,UAAMD,SAAQ,YAAY,CAAC,GAAG,SAAS;AACvC,UAAM,kBAAkB,wBAAwB,OAAOA,MAAK,IAAI,CAAC;AAGjE,UAAM,aAAa,oBAAI,KAAK;AAC5B,eAAW,QAAQ,WAAW,QAAQ,IAAI,EAAE;AAG5C,UAAM,CAAC,YAAY,IAAI,MAAMC,IAC1B,OAAO,UAAU,EACjB,OAAO;AAAA,MACN;AAAA,MACA,YAAY,SAAS;AAAA,MACrB,cAAc,SAAS;AAAA,MACvB,eAAe,SAAS;AAAA,MACxB,eAAe,SAAS;AAAA,MACxB,iBAAiB,SAAS;AAAA,MAC1B,QAAQ;AAAA,MACR,UAAU,SAAS;AAAA,MACnB,UAAU,SAAS;AAAA,MACnB,SAAS,SAAS;AAAA,MAClB,WAAW,SAAS;AAAA,MACpB,gBAAgB,SAAS;AAAA,MACzB,OAAO,SAAS;AAAA,MAChB;AAAA,MACA,OAAO,SAAS;AAAA,MAChB,oBAAoB,SAAS;AAAA,IAC/B,CAAC,EACA,UAAU;AAEb,QAAI,CAAC,cAAc;AACjB,YAAM,IAAI,gBAAgB,4BAA4B;AAAA,IACxD;AAGA,eAAW,QAAQ,OAAO;AACxB,YAAMA,IAAG,OAAO,cAAc,EAAE,OAAO;AAAA,QACrC,aAAa,aAAa;AAAA,QAC1B,WAAW,KAAK;AAAA,QAChB,MAAM,KAAK;AAAA,QACX,KAAK,KAAK;AAAA,QACV,aAAa,KAAK;AAAA,QAClB,UAAU,KAAK;AAAA,QACf,WAAW,KAAK;AAAA,MAClB,CAAC;AAAA,IACH;AAGA,UAAM,yBAAyB;AAAA,MAC7B,SAAS;AAAA,MACT,aAAa;AAAA,MACb,aAAa;AAAA,IACf;AACA,UAAM,yBAAyB;AAAA,MAC7B,aAAa;AAAA,MACb,aAAa;AAAA,IACf;AAEA,gBAAY,KAAK;AAAA,MACf,IAAI,aAAa;AAAA,MACjB,iBAAiB,aAAa;AAAA,MAC9B,QAAQ,aAAa;AAAA,MACrB,OAAO,OAAO,aAAa,KAAK;AAAA,MAChC,YAAY,aAAa;AAAA,MACzB,gBAAgB,SAAS;AAAA,IAC3B,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,iBAAiB,IAAI,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC/D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,QAAQ,IAAI,OAAO,OAAO;AAEhC,QAAI,CAAC,SAAS,MAAM,WAAW,IAAI;AACjC,YAAM,IAAI,gBAAgB,eAAe;AAAA,IAC3C;AAEA,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,iBAAiB,KAAK,CAAC;AAE9C,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,yCAAyC;AAAA,IACnE;AAGA,QAAI,UAAU,kBAAkB,IAAI,KAAK,UAAU,cAAc,IAAI,oBAAI,KAAK,GAAG;AAC/E,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,cAAc,EACnB,MAAM,GAAG,eAAe,aAAa,UAAU,EAAE,CAAC;AAGrD,QAAI,CAAC,UAAU,UAAU;AACvB,YAAMA,IACH,OAAO,UAAU,EACjB,IAAI,EAAE,UAAU,oBAAI,KAAK,EAAE,CAAC,EAC5B,MAAM,GAAG,WAAW,IAAI,UAAU,EAAE,CAAC;AAGxC,YAAM,yBAAyB,UAAU,UAAU,IAAI,UAAU,YAAY;AAAA,IAC/E;AAGA,UAAM,eAAe,MAAMA,IACxB,OAAO,EACP,KAAK,QAAQ,EACb;AAAA,MACC;AAAA,QACE,GAAG,SAAS,KAAK,cAAc;AAAA,QAC/B,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,MACpC;AAAA,IACF;AAEF,UAAM,cAAc,IAAI,IAAI,aAAa,IAAI,OAAK,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;AAEnE,gBAAY,KAAK;AAAA,MACf,IAAI,UAAU;AAAA,MACd,iBAAiB,UAAU;AAAA,MAC3B,QAAQ,UAAU;AAAA,MAClB,cAAc,UAAU;AAAA,MACxB,eAAe,UAAU;AAAA,MACzB,iBAAiB,UAAU;AAAA,MAE3B,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,MAAM,KAAK;AAAA,QACX,aAAa,KAAK;AAAA,QAClB,KAAK,KAAK;AAAA,QACV,UAAU,KAAK;AAAA,QACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,MAC3C,EAAE;AAAA,MAEF,UAAU,OAAO,UAAU,QAAQ;AAAA,MACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,MACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,MAC1C,gBAAgB,OAAO,UAAU,cAAc;AAAA,MAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,MAC7B,UAAU,UAAU;AAAA,MAEpB,OAAO,UAAU;AAAA,MACjB,oBAAoB,UAAU;AAAA,MAC9B,YAAY,UAAU;AAAA,MACtB,WAAW,UAAU;AAAA,MAErB,SAAS;AAAA,QACP,MAAM,YAAY,IAAI,cAAc,KAAK;AAAA,QACzC,OAAO,YAAY,IAAI,eAAe;AAAA,QACtC,OAAO,YAAY,IAAI,eAAe;AAAA,QACtC,SAAS,YAAY,IAAI,iBAAiB;AAAA,QAC1C,SAAS,YAAY,IAAI,iBAAiB;AAAA,MAC5C;AAAA,MAEA,WAAW,UAAU,WAAW;AAAA,MAChC,WAAW,UAAU,WAAW;AAAA,IAClC,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,yBAAyB,OAAO,KAAK,KAAK,SAAS;AACvE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,QAAQ,IAAI,OAAO,OAAO;AAEhC,QAAI,CAAC,SAAS,MAAM,WAAW,IAAI;AACjC,YAAM,IAAI,gBAAgB,eAAe;AAAA,IAC3C;AAEA,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,iBAAiB,KAAK,CAAC;AAE9C,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,yCAAyC;AAAA,IACnE;AAGA,QAAI,UAAU,kBAAkB,IAAI,KAAK,UAAU,cAAc,IAAI,oBAAI,KAAK,GAAG;AAC/E,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAEA,QAAI,UAAU,WAAW,QAAQ;AAC/B,YAAM,IAAI,gBAAgB,iDAAiD,UAAU,MAAM,GAAG;AAAA,IAChG;AAGA,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,UAAU,EAAE,CAAC;AAGxC,UAAM,yBAAyB,YAAY,UAAU,IAAI,UAAU,YAAY;AAE/E,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT,iBAAiB,UAAU;AAAA,MAC3B,QAAQ;AAAA,IACV,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAED,IAAM,wBAAwB,eAAE,OAAO;AAAA,EACrC,QAAQ,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AACxC,CAAC;AAMD,iBAAiB,KAAK,yBAAyB,aAAa,qBAAqB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC5G,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,QAAQ,IAAI,OAAO,OAAO;AAChC,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,QAAI,CAAC,SAAS,MAAM,WAAW,IAAI;AACjC,YAAM,IAAI,gBAAgB,eAAe;AAAA,IAC3C;AAEA,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,iBAAiB,KAAK,CAAC;AAE9C,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,yCAAyC;AAAA,IACnE;AAGA,QAAI,UAAU,kBAAkB,IAAI,KAAK,UAAU,cAAc,IAAI,oBAAI,KAAK,GAAG;AAC/E,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAEA,QAAI,UAAU,WAAW,QAAQ;AAC/B,YAAM,IAAI,gBAAgB,iDAAiD,UAAU,MAAM,GAAG;AAAA,IAChG;AAGA,UAAMA,IACH,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,OAAO,SAAS,GAAG,UAAU,SAAS,EAAE;AAAA;AAAA,oBAAyB,MAAM,GAAG,KAAK,IAAI,UAAU;AAAA,MAC7F,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,WAAW,IAAI,UAAU,EAAE,CAAC;AAGxC,UAAM,yBAAyB,YAAY,UAAU,IAAI,QAAQ,UAAU,YAAY;AAEvF,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT,iBAAiB,UAAU;AAAA,MAC3B,QAAQ;AAAA,IACV,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,sBAAsB,OAAO,KAAK,KAAK,SAAS;AACnE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,QAAQ,IAAI,OAAO,OAAO;AAEhC,QAAI,CAAC,SAAS,MAAM,WAAW,IAAI;AACjC,YAAM,IAAI,gBAAgB,eAAe;AAAA,IAC3C;AAEA,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,iBAAiB,KAAK,CAAC;AAE9C,QAAI,CAAC,WAAW;AACd,YAAM,IAAI,cAAc,yCAAyC;AAAA,IACnE;AAGA,QAAI,UAAU,kBAAkB,IAAI,KAAK,UAAU,cAAc,IAAI,oBAAI,KAAK,GAAG;AAC/E,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAGA,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,eAAe;AAAA,MACnB,aAAa,eAAe;AAAA,MAC5B,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,MAAM,eAAe;AAAA,MACrB,aAAa,eAAe;AAAA,MAC5B,KAAK,eAAe;AAAA,MACpB,UAAU,eAAe;AAAA,MACzB,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,aAAa,SAAS;AAAA,IACxB,CAAC,EACA,KAAK,cAAc,EACnB,SAAS,UAAU,GAAG,eAAe,WAAW,SAAS,EAAE,CAAC,EAC5D,MAAM,GAAG,eAAe,aAAa,UAAU,EAAE,CAAC;AAGrD,UAAM,aAAa,QAAQ,IAAI,SAAS,KAAK;AAG7C,UAAM,eAAe,MAAMA,IACxB,OAAO,EACP,KAAK,QAAQ,EACb;AAAA,MACC;AAAA,QACE,GAAG,SAAS,KAAK,cAAc;AAAA,QAC/B,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,eAAe;AAAA,QAChC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,QAClC,GAAG,SAAS,KAAK,iBAAiB;AAAA,MACpC;AAAA,IACF;AAEF,UAAM,cAAc,IAAI,IAAI,aAAa,IAAI,OAAK,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;AAGnE,UAAM,YAAY,MAAM,WAAW,qBAAqB;AAAA,MACtD,iBAAiB,UAAU;AAAA,MAC3B,cAAc,UAAU;AAAA,MACxB,eAAe,UAAU;AAAA,MACzB,eAAe,UAAU,iBAAiB;AAAA,MAC1C,iBAAiB,UAAU,mBAAmB;AAAA,MAC9C,iBAAiB,UAAU;AAAA,MAE3B,QAAQ,UAAU;AAAA,MAClB,YAAY,UAAU,cAAc;AAAA,MACpC,WAAW,UAAU;AAAA,MAErB,OAAO,MAAM,IAAI,WAAS;AAAA,QACxB,aAAa,KAAK;AAAA,QAClB,aAAa,KAAK,eAAe;AAAA,QACjC,KAAK,KAAK,OAAO;AAAA,QACjB,UAAU,KAAK;AAAA,QACf,WAAW,OAAO,KAAK,SAAS;AAAA,QAChC,WAAW,OAAO,KAAK,SAAS,IAAI,KAAK;AAAA,QACzC,YAAY,KAAK,cAAc,GAAG,UAAU,aAAa,KAAK,WAAW,KAAK;AAAA,MAChF,EAAE;AAAA,MAEF,UAAU,OAAO,UAAU,QAAQ;AAAA,MACnC,SAAS,OAAO,UAAU,WAAW,CAAC;AAAA,MACtC,WAAW,OAAO,UAAU,aAAa,CAAC;AAAA,MAC1C,gBAAgB;AAAA,MAChB,gBAAgB,OAAO,UAAU,cAAc;AAAA,MAC/C,OAAO,OAAO,UAAU,KAAK;AAAA,MAC7B,UAAU,UAAU;AAAA,MAEpB,OAAO,UAAU,SAAS;AAAA,MAC1B,OAAO,UAAU,sBAAuB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,MAEzF,aAAc,YAAY,IAAI,cAAc,KAAgB;AAAA,MAC5D,gBAAiB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,MAClE,cAAe,YAAY,IAAI,eAAe,KAAgB;AAAA,MAC9D,cAAe,YAAY,IAAI,eAAe,KAAgB;AAAA,MAC9D,gBAAiB,YAAY,IAAI,iBAAiB,KAAgB;AAAA,IACpE,CAAC;AAED,QAAI,UAAU,gBAAgB,iBAAiB;AAC/C,QAAI,UAAU,uBAAuB,yBAAyB,UAAU,eAAe,OAAO;AAC9F,QAAI,KAAK,SAAS;AAAA,EACpB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AGn5DD,IAAAE,mBAAuB;AACvB,IAAAC,eAAkB;AAOX,IAAM,+BAA2B,yBAAO;AAM/C,IAAM,qBAAqB,eAAE,OAAO;AAAA,EAClC,WAAW,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACtC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,aAAa,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC3C,KAAK,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAClC,UAAU,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC;AAAA,EAChC,WAAW,eAAE,OAAO,EAAE,IAAI,CAAC;AAC7B,CAAC;AAED,IAAM,uBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,aAAa,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EAC3C,OAAO,eAAE,MAAM,kBAAkB,EAAE,IAAI,CAAC;AAAA,EACxC,iBAAiB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC5C,qBAAqB,eAAE,KAAK,CAAC,cAAc,OAAO,CAAC,EAAE,SAAS;AAAA,EAC9D,gBAAgB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAClD,kBAAkB,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC5D,cAAc,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAC9C,CAAC;AAED,IAAM,uBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,aAAa,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EACtD,OAAO,eAAE,MAAM,kBAAkB,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACnD,iBAAiB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA,EACvD,qBAAqB,eAAE,KAAK,CAAC,cAAc,OAAO,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA,EACzE,gBAAgB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA,EAC7D,kBAAkB,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC5D,cAAc,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS,EAAE,SAAS;AAAA,EACvD,UAAU,eAAE,QAAQ,EAAE,SAAS;AACjC,CAAC;AAUD,yBAAyB,IAAI,KAAK,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACrF,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,aAAa,IAAI,MAAM,YAAY,MAAM;AAE/C,UAAM,YAAYA,IAAG,OAAO,EAAE,KAAK,kBAAkB;AAErD,UAAM,YAAY,aACd,MAAM,UAAU,MAAM,GAAG,mBAAmB,UAAU,CAAC,CAAC,EAAE,QAAQ,KAAK,mBAAmB,SAAS,CAAC,IACpG,MAAM,UAAU,QAAQ,KAAK,mBAAmB,SAAS,CAAC;AAE9D,gBAAY,KAAK,UAAU,IAAI,QAAM;AAAA,MACnC,GAAG;AAAA,MACH,iBAAiB,EAAE,kBAAkB,OAAO,EAAE,eAAe,IAAI;AAAA,MACjE,gBAAgB,EAAE,iBAAiB,OAAO,EAAE,cAAc,IAAI;AAAA,MAC9D,UAAU,QAAQ,EAAE,QAAQ;AAAA,IAC9B,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,yBAAyB,IAAI,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACxF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,IAAI,EAAE,CAAC;AAEtC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,gBAAY,KAAK;AAAA,MACf,GAAG;AAAA,MACH,iBAAiB,SAAS,kBAAkB,OAAO,SAAS,eAAe,IAAI;AAAA,MAC/E,gBAAgB,SAAS,iBAAiB,OAAO,SAAS,cAAc,IAAI;AAAA,MAC5E,UAAU,QAAQ,SAAS,QAAQ;AAAA,IACrC,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,yBAAyB;AAAA,EACvB;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,kBAAkB,EACzB,OAAO;AAAA,QACN,MAAM,KAAK,MAAM;AAAA,QACjB,aAAa,KAAK,aAAa;AAAA,QAC/B,OAAO,KAAK,OAAO;AAAA,QACnB,iBAAiB,KAAK,iBAAiB,IAAI,OAAO,KAAK,iBAAiB,CAAC,IAAI;AAAA,QAC7E,qBAAqB,KAAK,qBAAqB;AAAA,QAC/C,gBAAgB,KAAK,gBAAgB,IAAI,OAAO,KAAK,gBAAgB,CAAC,IAAI;AAAA,QAC1E,kBAAkB,KAAK,kBAAkB;AAAA,QACzC,cAAc,KAAK,cAAc;AAAA,MACnC,CAAC,EACA,UAAU;AAEb,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,2BAA2B;AAAA,MACrD;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,iBAAiB,SAAS,kBAAkB,OAAO,SAAS,eAAe,IAAI;AAAA,QAC/E,gBAAgB,SAAS,iBAAiB,OAAO,SAAS,cAAc,IAAI;AAAA,QAC5E,UAAU,QAAQ,SAAS,QAAQ;AAAA,MACrC,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,yBAAyB;AAAA,EACvB;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,IAAI,EAAE,CAAC;AAEtC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAEA,YAAM,aAAsC;AAAA,QAC1C,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,UAAI,KAAK,MAAM,MAAM,QAAW;AAAC,mBAAW,MAAM,IAAI,KAAK,MAAM;AAAA,MAAE;AACnE,UAAI,KAAK,aAAa,MAAM,QAAW;AAAC,mBAAW,aAAa,IAAI,KAAK,aAAa;AAAA,MAAE;AACxF,UAAI,KAAK,OAAO,MAAM,QAAW;AAAC,mBAAW,OAAO,IAAI,KAAK,OAAO;AAAA,MAAE;AACtE,UAAI,KAAK,iBAAiB,MAAM,QAAW;AACzC,mBAAW,iBAAiB,IAAI,KAAK,iBAAiB,MAAM,OAAO,OAAO,KAAK,iBAAiB,CAAC,IAAI;AAAA,MACvG;AACA,UAAI,KAAK,qBAAqB,MAAM,QAAW;AAAC,mBAAW,qBAAqB,IAAI,KAAK,qBAAqB;AAAA,MAAE;AAChH,UAAI,KAAK,gBAAgB,MAAM,QAAW;AACxC,mBAAW,gBAAgB,IAAI,KAAK,gBAAgB,MAAM,OAAO,OAAO,KAAK,gBAAgB,CAAC,IAAI;AAAA,MACpG;AACA,UAAI,KAAK,kBAAkB,MAAM,QAAW;AAAC,mBAAW,kBAAkB,IAAI,KAAK,kBAAkB;AAAA,MAAE;AACvG,UAAI,KAAK,cAAc,MAAM,QAAW;AAAC,mBAAW,cAAc,IAAI,KAAK,cAAc;AAAA,MAAE;AAC3F,UAAI,KAAK,UAAU,MAAM,QAAW;AAAC,mBAAW,UAAU,IAAI,KAAK,UAAU,IAAI,IAAI;AAAA,MAAE;AAEvF,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,kBAAkB,EACzB,IAAI,UAAU,EACd,MAAM,GAAG,mBAAmB,IAAI,EAAE,CAAC,EACnC,UAAU;AAEb,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAEA,kBAAY,KAAK;AAAA,QACf,GAAG;AAAA,QACH,iBAAiB,SAAS,kBAAkB,OAAO,SAAS,eAAe,IAAI;AAAA,QAC/E,gBAAgB,SAAS,iBAAiB,OAAO,SAAS,cAAc,IAAI;AAAA,QAC5E,UAAU,QAAQ,SAAS,QAAQ;AAAA,MACrC,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,yBAAyB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,kBAAkB,EACvB,MAAM,GAAG,mBAAmB,IAAI,EAAE,CAAC;AAEtC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,UAAMA,IAAG,OAAO,kBAAkB,EAAE,MAAM,GAAG,mBAAmB,IAAI,EAAE,CAAC;AAEvE,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AC7OD,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AASX,IAAM,kBAAc,yBAAO;AAMlC,IAAM,mBAAmB,eAAE,OAAO;AAAA,EAChC,OAAO,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAChC,MAAM,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACnC,SAAS,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACtC,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACzB,kBAAkB,eAAE,OAAO,EAAE,IAAI,EAAE,SAAS;AAAA,EAC5C,MAAM,eAAE,MAAM,eAAE,OAAO,CAAC,EAAE,SAAS;AAAA,EACnC,QAAQ,eAAE,KAAK,CAAC,SAAS,WAAW,CAAC,EAAE,SAAS,EAAE,QAAQ,OAAO;AAAA,EACjE,aAAa,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EAC5C,WAAW,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACxC,iBAAiB,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAChD,CAAC;AAED,IAAM,mBAAmB,iBAAiB,QAAQ;AAElD,IAAM,oBAAoB,eAAE,OAAO;AAAA,EACjC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,QAAQ,eAAE,KAAK,CAAC,SAAS,WAAW,CAAC,EAAE,SAAS;AAAA,EAChD,KAAK,eAAE,OAAO,EAAE,SAAS;AAC3B,CAAC;AAUD,YAAY,IAAI,KAAK,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC/E,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,UAAM,EAAE,QAAQ,IAAI,IAAI,IAAI;AAC5B,UAAM,UAAU,IAAI,MAAM,SAAS;AAEnC,UAAM,aAAa,CAAC;AAGpB,QAAI,CAAC,SAAS;AACZ,iBAAW,KAAK,GAAG,MAAM,QAAQ,WAAW,CAAC;AAC7C,iBAAW,KAAK,IAAI,MAAM,aAAa,oBAAI,KAAK,CAAC,CAAC;AAAA,IACpD;AAEA,QAAI,QAAQ;AACV,iBAAW;AAAA,QACT;AAAA,UACE,KAAK,MAAM,OAAO,IAAI,MAAM,GAAG;AAAA,UAC/B,KAAK,MAAM,SAAS,IAAI,MAAM,GAAG;AAAA,QACnC;AAAA,MACF;AAAA,IACF;AAEA,QAAI,KAAK;AACP,iBAAW,KAAK,MAAM,GAAG,UAAU,MAAM,IAAI,GAAG;AAAA,IAClD;AAEA,UAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,KAAK,EACV,MAAM,WAAW;AACpB,UAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,UAAM,WAAW,MAAMD,IACpB,OAAO;AAAA,MACN,IAAI,MAAM;AAAA,MACV,OAAO,MAAM;AAAA,MACb,MAAM,MAAM;AAAA,MACZ,SAAS,MAAM;AAAA,MACf,kBAAkB,MAAM;AAAA,MACxB,MAAM,MAAM;AAAA,MACZ,QAAQ,MAAM;AAAA,MACd,aAAa,MAAM;AAAA,MACnB,WAAW,MAAM;AAAA,IACnB,CAAC,EACA,KAAK,KAAK,EACV,MAAM,WAAW,EACjB,QAAQ,KAAK,MAAM,WAAW,CAAC,EAC/B,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,gBAAY,KAAK,UAAU,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,EAClF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,SAAS,OAAO,MAAM,KAAK,SAAS;AAClD,MAAI;AACF,UAAMD,MAAK,MAAM;AAGjB,UAAM,SAAS,MAAMA,IAClB,OAAO,EAAE,MAAM,MAAM,KAAK,CAAC,EAC3B,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,QAAQ,WAAW,CAAC;AAGtC,UAAM,UAAU,OACb,QAAQ,OAAK,EAAE,QAAQ,CAAC,CAAC,EACzB,OAAO,CAAC,KAAKE,QAAO,SAAS,KAAK,QAAQ,GAAG,MAAMA,MAAK,EACxD,KAAK;AAER,gBAAY,KAAK,OAAO;AAAA,EAC1B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,UAAU,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACF,UAAMF,MAAK,MAAM;AACjB,UAAM,EAAE,KAAK,IAAI,IAAI;AACrB,UAAM,UAAU,IAAI,MAAM,SAAS;AAEnC,UAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,MAAM,IAAI,CAAC;AAE7B,QAAI,CAAC,MAAM;AACT,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,QAAI,CAAC,WAAW,KAAK,WAAW,aAAa;AAC3C,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAIA,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC1D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,KAAK,IAAI,IAAI;AACrB,UAAM,aAAa,SAAS,IAAI,MAAM,OAAO,CAAW,KAAK;AAG7D,UAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,IAAI,MAAM,IAAI,MAAM,MAAM,KAAK,CAAC,EACzC,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,MAAM,IAAI,CAAC;AAE7B,QAAI,CAAC,aAAa;AAChB,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,QAAI,eAOC,CAAC;AAEN,QAAI,YAAY,QAAQ,YAAY,KAAK,SAAS,GAAG;AAEnD,qBAAe,MAAMA,IAClB,OAAO;AAAA,QACN,IAAI,MAAM;AAAA,QACV,OAAO,MAAM;AAAA,QACb,MAAM,MAAM;AAAA,QACZ,SAAS,MAAM;AAAA,QACf,kBAAkB,MAAM;AAAA,QACxB,aAAa,MAAM;AAAA,MACrB,CAAC,EACA,KAAK,KAAK,EACV;AAAA,QACC;AAAA,UACE,GAAG,MAAM,QAAQ,WAAW;AAAA,UAC5B,MAAM,MAAM,EAAE,OAAO,YAAY,EAAE;AAAA,UACnC,MAAM,MAAM,IAAI,OAAO,YAAY,IAAI;AAAA;AAAA,QACzC;AAAA,MACF,EACC,QAAQ,KAAK,MAAM,WAAW,CAAC,EAC/B,MAAM,UAAU;AAAA,IACrB;AAGA,QAAI,aAAa,SAAS,YAAY;AACpC,YAAM,WAAW,aAAa,IAAI,OAAK,EAAE,EAAE;AAC3C,YAAM,SAAS,aAAa,aAAa;AAEzC,YAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,QACN,IAAI,MAAM;AAAA,QACV,OAAO,MAAM;AAAA,QACb,MAAM,MAAM;AAAA,QACZ,SAAS,MAAM;AAAA,QACf,kBAAkB,MAAM;AAAA,QACxB,aAAa,MAAM;AAAA,MACrB,CAAC,EACA,KAAK,KAAK,EACV;AAAA,QACC;AAAA,UACE,GAAG,MAAM,QAAQ,WAAW;AAAA,UAC5B,MAAM,MAAM,EAAE,OAAO,YAAY,EAAE;AAAA,UACnC,SAAS,SAAS,IAAI,MAAM,MAAM,EAAE,WAAW,QAAQ,MAAM;AAAA,QAC/D;AAAA,MACF,EACC,QAAQ,KAAK,MAAM,WAAW,CAAC,EAC/B,MAAM,MAAM;AAEf,qBAAe,CAAC,GAAG,cAAc,GAAG,WAAW;AAAA,IACjD;AAEA,gBAAY,KAAK,YAAY;AAAA,EAC/B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,YAAY;AAAA,EACV;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,iBAAiB;AAAA,EAC/B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,QAAQ,QAAQ,IAAI,IAAI,IAAI;AAEpC,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ;AACV,mBAAW;AAAA,UACT;AAAA,YACE,KAAK,MAAM,OAAO,IAAI,MAAM,GAAG;AAAA,YAC/B,KAAK,MAAM,SAAS,IAAI,MAAM,GAAG;AAAA,UACnC;AAAA,QACF;AAAA,MACF;AAEA,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,MAAM,QAAQ,MAA4C,CAAC;AAAA,MAChF;AAEA,UAAI,KAAK;AACP,mBAAW,KAAK,MAAM,GAAG,UAAU,MAAM,IAAI,GAAG;AAAA,MAClD;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,KAAK,EACV,MAAM,WAAW;AACpB,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,WAAW,MAAMD,IACpB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,WAAW,EACjB,QAAQ,KAAK,MAAM,SAAS,CAAC,EAC7B,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,kBAAY,KAAK,UAAU,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,IAClF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,YAAY;AAAA,EACV;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMD,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,YAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,UAAI,CAAC,MAAM;AACT,cAAM,IAAI,cAAc,qBAAqB;AAAA,MAC/C;AAEA,kBAAY,KAAK,IAAI;AAAA,IACvB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,YAAY;AAAA,EACV;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,gBAAgB;AAAA,EAC7B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,UAAI,OAAO,KAAK,QAAQ,aAAa,KAAK,KAAK;AAG/C,YAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EAAE,IAAI,MAAM,GAAG,CAAC,EACvB,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,MAAM,IAAI,CAAC;AAE7B,UAAI,cAAc;AAChB,eAAO,GAAG,IAAI,IAAI,KAAK,IAAI,CAAC;AAAA,MAC9B;AAGA,UAAI,cAAc,KAAK,cAAc,IAAI,KAAK,KAAK,WAAW,IAAI;AAClE,UAAI,KAAK,WAAW,eAAe,CAAC,aAAa;AAC/C,sBAAc,oBAAI,KAAK;AAAA,MACzB;AAGA,UAAI,UAAU,KAAK;AACnB,UAAI,CAAC,WAAW,KAAK,SAAS;AAE5B,cAAM,YAAY,KAAK,QAAQ,QAAQ,YAAY,EAAE;AACrD,kBAAU,UAAU,UAAU,GAAG,GAAG,KAAK,UAAU,SAAS,MAAM,QAAQ;AAAA,MAC5E;AAGA,YAAM,mBAAmB,oBAAoB,KAAK,OAAO;AAGzD,YAAM,cAAc,kEAAkE,KAAK,IAAI,MAAM,MAAM,EAAE;AAE7G,YAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,KAAK,EACZ,OAAO;AAAA,QACN,OAAO,KAAK;AAAA,QACZ;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT,kBAAkB,KAAK;AAAA,QACvB,MAAM,KAAK,QAAQ,CAAC;AAAA,QACpB,QAAQ,KAAK,UAAU;AAAA,QACvB;AAAA,QACA,WAAW,KAAK,aAAa,KAAK;AAAA,QAClC,iBAAiB,KAAK,mBAAmB;AAAA,QACzC,UAAU,cAAc,IAAI,MAAM,KAAK;AAAA,QACvC,YAAY,IAAI,MAAM,OAAO,MAAM,GAAG,EAAE,CAAC,KAAK;AAAA,MAChD,CAAC,EACA,UAAU;AAEb,kBAAY,KAAK,IAAI;AAAA,IACvB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,YAAY;AAAA,EACV;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,gBAAgB;AAAA,EAC7B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAEjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,qBAAqB;AAAA,MAC/C;AAGA,YAAM,aAAsC;AAAA,QAC1C,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,UAAI,KAAK,SAAS,GAAG;AACnB,mBAAW,SAAS,IAAI,oBAAoB,KAAK,SAAS,CAAC;AAAA,MAC7D;AAGA,UAAI,KAAK,QAAQ,KAAK,SAAS,SAAS,MAAM;AAC5C,cAAM,CAAC,YAAY,IAAI,MAAMA,IAC1B,OAAO,EAAE,IAAI,MAAM,GAAG,CAAC,EACvB,KAAK,KAAK,EACV,MAAM,IAAI,GAAG,MAAM,MAAM,KAAK,IAAI,GAAG,MAAM,MAAM,EAAE,OAAO,EAAE,EAAE,CAAC;AAElE,YAAI,cAAc;AAChB,gBAAM,IAAI,cAAc,qBAAqB;AAAA,QAC/C;AAAA,MACF;AAGA,UAAI,KAAK,aAAa,GAAG;AACvB,mBAAW,aAAa,IAAI,IAAI,KAAK,KAAK,aAAa,CAAC;AAAA,MAC1D,WAAW,KAAK,WAAW,eAAe,CAAC,SAAS,aAAa;AAC/D,mBAAW,aAAa,IAAI,oBAAI,KAAK;AAAA,MACvC;AAEA,YAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,KAAK,EACZ,IAAI,UAAU,EACd,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EACtB,UAAU;AAEb,kBAAY,KAAK,IAAI;AAAA,IACvB,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,YAAY,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC9E,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,MAAM,GAAG,CAAC,EACvB,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAMA,IAAG,OAAO,KAAK,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAE7C,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,KAAK,gBAAgB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACpF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,KAAK,EACZ,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,aAAa,SAAS,eAAe,oBAAI,KAAK;AAAA,MAC9C,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EACtB,UAAU;AAEb,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,KAAK,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,MAAM,GAAG,CAAC,EACvB,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,UAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,KAAK,EACZ,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EACtB,UAAU;AAEb,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,KAAK,kBAAkB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,KAAK,EACV,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC;AAEzB,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAGA,UAAM,OAAO,GAAG,SAAS,IAAI,SAAS,KAAK,IAAI,CAAC;AAEhD,UAAM,CAAC,IAAI,IAAI,MAAMA,IAClB,OAAO,KAAK,EACZ,OAAO;AAAA,MACN,OAAO,GAAG,SAAS,KAAK;AAAA,MACxB;AAAA,MACA,SAAS,SAAS;AAAA,MAClB,SAAS,SAAS;AAAA,MAClB,kBAAkB,SAAS;AAAA,MAC3B,MAAM,SAAS;AAAA,MACf,QAAQ;AAAA,MACR,WAAW,SAAS;AAAA,MACpB,iBAAiB,SAAS;AAAA,MAC1B,UAAU,IAAI,MAAM;AAAA,IACtB,CAAC,EACA,UAAU;AAEb,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACtmBD,IAAAG,mBAAuB;AACvB,IAAAC,eAAkB;AAOX,IAAM,qBAAiB,yBAAO;AA+CrC,IAAM,mBAAqC;AAAA,EACzC,eAAe;AAAA,EACf,gBAAgB;AAAA,EAChB,gBAAgB;AAAA,EAChB,kBAAkB;AAAA,EAClB,UAAU;AAAA,EACV,iBAAiB;AACnB;AAKA,IAAM,cAA2B;AAAA,EAC/B,UAAU;AAAA,EACV,WAAW;AAAA,EACX,aAAa;AACf;AAEA,IAAM,mBAAqC;AAAA,EACzC,cAAc;AAAA,EACd,kBAAkB;AAAA,EAClB,yBAAyB;AAAA,EACzB,mBAAmB;AAAA,EACnB,mBAAmB;AACrB;AAEA,IAAM,wBAA8C;AAAA,EAClD,qBAAqB;AAAA,EACrB,qBAAqB;AAAA,EACrB,yBAAyB;AAAA,EACzB,yBAAyB;AAC3B;AAEA,IAAM,iBAAiC;AAAA,EACrC,YAAY;AAAA,EACZ,kBAAkB;AAAA,EAClB,kBAAkB;AAAA,EAClB,sBAAsB;AAAA,EACtB,gBAAgB;AAClB;AAMA,IAAM,2BAA2B,eAAE,OAAO;AAAA,EACxC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,SAAS,eAAE,OAAO,EAAE,KAAK,EAAE,SAAS;AAAA,EACpC,QAAQ,eAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,YAAY,eAAE,OAAO,EAAE,SAAS;AAAA,EAChC,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,SAAS;AAC/B,CAAC;AAGD,IAAM,4BAA4B,eAAE,OAAO;AAAA;AAAA,EAEzC,eAAe,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,gBAAgB,eAAE,OAAO,EAAE,MAAM,EAAE,SAAS;AAAA,EAC5C,gBAAgB,eAAE,OAAO,EAAE,SAAS;AAAA,EACpC,kBAAkB,eAAE,OAAO,EAAE,SAAS;AAAA,EACtC,UAAU,eAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,iBAAiB,eAAE,OAAO,EAAE,SAAS;AAAA;AAAA,EAErC,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC9C,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,aAAa,eAAE,QAAQ,EAAE,SAAS;AAAA;AAAA,EAElC,cAAc,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACzC,kBAAkB,eAAE,QAAQ,EAAE,SAAS;AAAA,EACvC,yBAAyB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA;AAAA,EAEpD,YAAY,eAAE,OAAO,EAAE,SAAS;AAAA,EAChC,kBAAkB,eAAE,OAAO,EAAE,SAAS;AAAA,EACtC,qBAAqB,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA;AAAA,EAEhD,qBAAqB,eAAE,QAAQ,EAAE,SAAS;AAAA,EAC1C,yBAAyB,eAAE,QAAQ,EAAE,SAAS;AAAA,EAC9C,yBAAyB,eAAE,QAAQ,EAAE,SAAS;AAChD,CAAC;AAkBD,eAAe,qBACbC,KACA,KACA,SACA,aACY;AAEZ,QAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,GAAG,CAAC;AAE9B,MAAI;AACJ,MAAI,YAAY,SAAS,OAAO;AAC9B,mBAAe,SAAS;AAAA,EAC1B,OAAO;AAEL,YAAQ,KAAK;AAAA,MACX,KAAK;AAAY,uBAAe;AAAuB;AAAA,MACvD,KAAK;AAAO,uBAAe;AAAkB;AAAA,MAC7C,KAAK;AAAY,uBAAe;AAAuB;AAAA,MACvD,KAAK;AAAiB,uBAAe;AAA4B;AAAA,MACjE,KAAK;AAAU,uBAAe;AAAqB;AAAA,MACnD;AAAS,uBAAe,CAAC;AAAA,IAC3B;AAAA,EACF;AAGA,QAAM,WAAW,EAAE,GAAG,cAAc,GAAG,QAAQ;AAE/C,MAAI,UAAU;AACZ,UAAMA,IACH,OAAO,QAAQ,EACf,IAAI,EAAE,OAAO,UAAU,WAAW,oBAAI,KAAK,EAAE,CAAC,EAC9C,MAAM,GAAG,SAAS,KAAK,GAAG,CAAC;AAAA,EAChC,OAAO;AACL,UAAMA,IAAG,OAAO,QAAQ,EAAE,OAAO;AAAA,MAC/B;AAAA,MACA,OAAO;AAAA,MACP;AAAA,IACF,CAAC;AAAA,EACH;AAEA,SAAO;AACT;AAUA,eAAe,IAAI,WAAW,OAAO,MAAM,KAAK,SAAS;AACvD,MAAI;AACF,UAAMA,MAAK,MAAM;AAGjB,UAAM,CAAC,aAAa,QAAQ,aAAa,SAAS,IAAI,MAAM,QAAQ,IAAI;AAAA,MACtEA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,UAAU,CAAC;AAAA,MAC7DA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAAA,MACxDA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,UAAU,CAAC;AAAA,MAC7DA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,QAAQ,CAAC;AAAA,IAC7D,CAAC;AAED,UAAM,WAAW,YAAY,CAAC,GAAG,SAA6B;AAC9D,UAAM,MAAM,OAAO,CAAC,GAAG,SAAwB;AAC/C,UAAM,WAAW,YAAY,CAAC,GAAG,SAA6B;AAC9D,UAAM,SAAS,UAAU,CAAC,GAAG,SAA2B;AAGxD,gBAAY,KAAK;AAAA;AAAA,MAEf,cAAc,SAAS;AAAA,MACvB,eAAe,SAAS;AAAA,MACxB,eAAe,SAAS;AAAA,MACxB,iBAAiB,SAAS;AAAA,MAC1B,UAAU,SAAS;AAAA,MACnB,iBAAiB,SAAS;AAAA;AAAA,MAE1B,UAAU,IAAI;AAAA,MACd,WAAW,IAAI;AAAA,MACf,aAAa,IAAI;AAAA;AAAA,MAEjB,cAAc,SAAS;AAAA,MACvB,kBAAkB,SAAS;AAAA,MAC3B,yBAAyB,SAAS;AAAA;AAAA,MAElC,YAAY,OAAO;AAAA,MACnB,kBAAkB,OAAO;AAAA,IAC3B,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,eAAe,IAAI,KAAK,aAAa,cAAc,OAAO,MAAM,KAAK,SAAS;AAC5E,MAAI;AACF,UAAMA,MAAK,MAAM;AAGjB,UAAM,CAAC,aAAa,QAAQ,aAAa,kBAAkB,SAAS,IAAI,MAAM,QAAQ,IAAI;AAAA,MACxFA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,UAAU,CAAC;AAAA,MAC7DA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAAA,MACxDA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,UAAU,CAAC;AAAA,MAC7DA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,eAAe,CAAC;AAAA,MAClEA,IAAG,OAAO,EAAE,KAAK,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,QAAQ,CAAC;AAAA,IAC7D,CAAC;AAED,UAAM,WAAW,EAAE,GAAG,kBAAkB,GAAI,YAAY,CAAC,GAAG,SAA6B,CAAC,EAAG;AAC7F,UAAM,MAAM,EAAE,GAAG,aAAa,GAAI,OAAO,CAAC,GAAG,SAAwB,CAAC,EAAG;AACzE,UAAM,WAAW,EAAE,GAAG,kBAAkB,GAAI,YAAY,CAAC,GAAG,SAA6B,CAAC,EAAG;AAC7F,UAAM,gBAAgB,EAAE,GAAG,uBAAuB,GAAI,iBAAiB,CAAC,GAAG,SAAiC,CAAC,EAAG;AAChH,UAAM,SAAS,EAAE,GAAG,gBAAgB,GAAI,UAAU,CAAC,GAAG,SAA2B,CAAC,EAAG;AAGrF,gBAAY,KAAK;AAAA;AAAA,MAEf,eAAe,SAAS;AAAA,MACxB,gBAAgB,SAAS;AAAA,MACzB,gBAAgB,SAAS;AAAA,MACzB,kBAAkB,SAAS;AAAA;AAAA,MAG3B,UAAU,SAAS;AAAA,MACnB,iBAAiB,SAAS;AAAA;AAAA,MAG1B,UAAU,IAAI;AAAA,MACd,WAAW,IAAI;AAAA,MACf,aAAa,IAAI;AAAA;AAAA,MAGjB,cAAc,SAAS;AAAA,MACvB,kBAAkB,SAAS;AAAA,MAC3B,yBAAyB,SAAS;AAAA,MAClC,mBAAmB,SAAS;AAAA,MAC5B,mBAAmB,SAAS;AAAA;AAAA,MAG5B,qBAAqB,cAAc;AAAA,MACnC,qBAAqB,cAAc;AAAA,MACnC,yBAAyB,cAAc;AAAA,MACvC,yBAAyB,cAAc;AAAA;AAAA,MAGvC,YAAY,OAAO;AAAA,MACnB,kBAAkB,OAAO;AAAA,MACzB,kBAAkB,OAAO;AAAA,MACzB,sBAAsB,OAAO;AAAA,MAC7B,gBAAgB,OAAO;AAAA,IACzB,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,yBAAyB;AAAA,EACtC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,UAAU,IAAI;AACpB,YAAM,gBAA0B,CAAC;AAGjC,YAAM,kBAA6C,CAAC;AACpD,YAAM,aAAmC,CAAC;AAC1C,YAAM,kBAA6C,CAAC;AACpD,YAAM,sBAAqD,CAAC;AAC5D,YAAM,gBAAyC,CAAC;AAGhD,UAAI,QAAQ,kBAAkB,QAAW;AAAC,wBAAgB,gBAAgB,QAAQ;AAAA,MAAc;AAChG,UAAI,QAAQ,mBAAmB,QAAW;AAAC,wBAAgB,iBAAiB,QAAQ;AAAA,MAAe;AACnG,UAAI,QAAQ,mBAAmB,QAAW;AAAC,wBAAgB,iBAAiB,QAAQ;AAAA,MAAe;AACnG,UAAI,QAAQ,qBAAqB,QAAW;AAAC,wBAAgB,mBAAmB,QAAQ;AAAA,MAAiB;AACzG,UAAI,QAAQ,aAAa,QAAW;AAAC,wBAAgB,WAAW,QAAQ;AAAA,MAAS;AACjF,UAAI,QAAQ,oBAAoB,QAAW;AAAC,wBAAgB,kBAAkB,QAAQ;AAAA,MAAgB;AAEtG,UAAI,QAAQ,aAAa,QAAW;AAAC,mBAAW,WAAW,QAAQ;AAAA,MAAS;AAC5E,UAAI,QAAQ,cAAc,QAAW;AAAC,mBAAW,YAAY,QAAQ;AAAA,MAAU;AAC/E,UAAI,QAAQ,gBAAgB,QAAW;AAAC,mBAAW,cAAc,QAAQ;AAAA,MAAY;AAErF,UAAI,QAAQ,iBAAiB,QAAW;AAAC,wBAAgB,eAAe,QAAQ;AAAA,MAAa;AAC7F,UAAI,QAAQ,qBAAqB,QAAW;AAAC,wBAAgB,mBAAmB,QAAQ;AAAA,MAAiB;AACzG,UAAI,QAAQ,4BAA4B,QAAW;AAAC,wBAAgB,0BAA0B,QAAQ;AAAA,MAAwB;AAE9H,UAAI,QAAQ,wBAAwB,QAAW;AAAC,4BAAoB,sBAAsB,QAAQ;AAAA,MAAoB;AACtH,UAAI,QAAQ,4BAA4B,QAAW;AAAC,4BAAoB,0BAA0B,QAAQ;AAAA,MAAwB;AAClI,UAAI,QAAQ,4BAA4B,QAAW;AAAC,4BAAoB,0BAA0B,QAAQ;AAAA,MAAwB;AAElI,UAAI,QAAQ,eAAe,QAAW;AAAC,sBAAc,aAAa,QAAQ;AAAA,MAAW;AACrF,UAAI,QAAQ,qBAAqB,QAAW;AAAC,sBAAc,mBAAmB,QAAQ;AAAA,MAAiB;AAGvG,UAAI,OAAO,KAAK,eAAe,EAAE,SAAS,GAAG;AAC3C,cAAM,qBAAqBA,KAAI,YAAY,iBAAiB,mBAAmB;AAC/E,sBAAc,KAAK,UAAU;AAAA,MAC/B;AAEA,UAAI,OAAO,KAAK,UAAU,EAAE,SAAS,GAAG;AACtC,cAAM,qBAAqBA,KAAI,OAAO,YAAY,cAAc;AAChE,sBAAc,KAAK,KAAK;AAAA,MAC1B;AAEA,UAAI,OAAO,KAAK,eAAe,EAAE,SAAS,GAAG;AAC3C,cAAM,qBAAqBA,KAAI,YAAY,iBAAiB,mBAAmB;AAC/E,sBAAc,KAAK,UAAU;AAAA,MAC/B;AAEA,UAAI,OAAO,KAAK,mBAAmB,EAAE,SAAS,GAAG;AAC/C,cAAM,qBAAqBA,KAAI,iBAAiB,qBAAqB,uBAAuB;AAC5F,sBAAc,KAAK,eAAe;AAAA,MACpC;AAEA,UAAI,OAAO,KAAK,aAAa,EAAE,SAAS,GAAG;AACzC,cAAM,qBAAqBA,KAAI,UAAU,eAAe,iBAAiB;AACzE,sBAAc,KAAK,QAAQ;AAAA,MAC7B;AAGA,UAAI,cAAc,SAAS,GAAG;AAC5B,cAAMA,IAAG,OAAO,iBAAiB,EAAE,OAAO;AAAA,UACxC,aAAa,IAAI,KAAM;AAAA,UACvB,QAAQ;AAAA,UACR,YAAY;AAAA,UACZ,SAAS,EAAE,eAAe,eAAe,OAAO,KAAK,OAAO,EAAE;AAAA,QAChE,CAAC;AAAA,MACH;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT;AAAA,QACA,eAAe,OAAO,KAAK,OAAO;AAAA,MACpC,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,eAAe,IAAI,SAAS,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/E,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,IAAI,OAAO,KAAK;AAE5B,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,EACP,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,GAAG,CAAC;AAE9B,QAAI,CAAC,SAAS;AAEZ,YAAM,WAAoC;AAAA,QACxC,UAAU;AAAA,QACV,KAAK;AAAA,QACL,UAAU;AAAA,QACV,eAAe;AAAA,QACf,QAAQ;AAAA,MACV;AAEA,UAAI,SAAS,GAAG,GAAG;AACjB,eAAO,YAAY,KAAK;AAAA,UACtB;AAAA,UACA,OAAO,SAAS,GAAG;AAAA,UACnB,WAAW;AAAA,QACb,CAAC;AAAA,MACH;AACA,YAAM,IAAI,cAAc,mBAAmB;AAAA,IAC7C;AAEA,gBAAY,KAAK,OAAO;AAAA,EAC1B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,eAAe,KAAK,UAAU,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACjF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,cAAc,CAAC,YAAY,OAAO,YAAY,iBAAiB,QAAQ;AAE7E,QAAI,UAAU,OAAO,SAAS,GAAG;AAE/B,iBAAW,SAAS,QAAQ;AAC1B,YAAI,YAAY,SAAS,KAAK,GAAG;AAC/B,gBAAMA,IAAG,OAAO,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAAA,QACzD;AAAA,MACF;AAAA,IACF,OAAO;AAEL,iBAAW,SAAS,aAAa;AAC/B,cAAMA,IAAG,OAAO,QAAQ,EAAE,MAAM,GAAG,SAAS,KAAK,KAAK,CAAC;AAAA,MACzD;AAAA,IACF;AAGA,UAAMA,IAAG,OAAO,iBAAiB,EAAE,OAAO;AAAA,MACxC,aAAa,IAAI,KAAM;AAAA,MACvB,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ,SAAS,EAAE,aAAa,UAAU,MAAM;AAAA,IAC1C,CAAC;AAED,gBAAY,KAAK,EAAE,SAAS,6BAA6B,CAAC;AAAA,EAC5D,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,eAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAc,wBAAwB;AAAA,EACtC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,SAAS,QAAQ,YAAY,WAAW,QAAQ,IAAI,IAAI;AAEhE,YAAM,aAAa,CAAC;AAEpB,UAAI,SAAS;AACX,mBAAW,KAAK,GAAG,kBAAkB,aAAa,OAAiB,CAAC;AAAA,MACtE;AAEA,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,kBAAkB,QAAQ,MAAgB,CAAC;AAAA,MAChE;AAEA,UAAI,YAAY;AACd,mBAAW,KAAK,GAAG,kBAAkB,YAAY,UAAoB,CAAC;AAAA,MACxE;AAEA,UAAI,WAAW;AACb,mBAAW,KAAK,IAAI,kBAAkB,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,MACjF;AAEA,UAAI,SAAS;AACX,cAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,YAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,mBAAW,KAAK,MAAM,kBAAkB,SAAS,OAAO,GAAG,EAAE;AAAA,MAC/D;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,iBAAiB,EACtB,MAAM,WAAW;AACpB,YAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,YAAM,OAAO,MAAMD,IAChB,OAAO;AAAA,QACN,IAAI,kBAAkB;AAAA,QACtB,aAAa,kBAAkB;AAAA,QAC/B,QAAQ,kBAAkB;AAAA,QAC1B,YAAY,kBAAkB;AAAA,QAC9B,UAAU,kBAAkB;AAAA,QAC5B,SAAS,kBAAkB;AAAA,QAC3B,WAAW,kBAAkB;AAAA,QAC7B,WAAW,kBAAkB;AAAA,MAC/B,CAAC,EACA,KAAK,iBAAiB,EACtB,MAAM,WAAW,EACjB,QAAQ,KAAK,kBAAkB,SAAS,CAAC,EACzC,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,kBAAY,KAAK,MAAM,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,IAC9E,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;ACnjBA,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAMX,IAAM,sBAAkB,yBAAO;AAGtC,gBAAgB,IAAI,aAAa,YAAY;AAM7C,IAAM,kBAAkB,eAAE,OAAO;AAAA,EAC/B,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,QAAQ,eAAE,KAAK,CAAC,SAAS,aAAa,QAAQ,SAAS,WAAW,QAAQ,KAAK,CAAC,EAAE,SAAS;AAC7F,CAAC;AAGD,SAAS,aAAa,OAAkE;AACtF,QAAM,MAAM,oBAAI,KAAK;AACrB,MAAI;AACJ,MAAI,UAA4B,IAAI,KAAK,GAAG;AAC5C,UAAQ,SAAS,IAAI,IAAI,IAAI,GAAG;AAEhC,MAAI,MAAM,QAAQ;AAChB,YAAQ,MAAM,QAAQ;AAAA,MACpB,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B;AAAA,MACF,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,QAAQ,UAAU,QAAQ,IAAI,CAAC;AACzC,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B,kBAAU,IAAI,KAAK,SAAS;AAC5B,gBAAQ,SAAS,IAAI,IAAI,IAAI,GAAG;AAChC;AAAA,MACF,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,QAAQ,UAAU,QAAQ,IAAI,CAAC;AACzC,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B;AAAA,MACF,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,SAAS,UAAU,SAAS,IAAI,CAAC;AAC3C,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B;AAAA,MACF,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,SAAS,UAAU,SAAS,IAAI,CAAC;AAC3C,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B;AAAA,MACF,KAAK;AACH,oBAAY,IAAI,KAAK,GAAG;AACxB,kBAAU,YAAY,UAAU,YAAY,IAAI,CAAC;AACjD,kBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAC7B;AAAA,MACF,KAAK;AACH,oBAAY;AACZ,kBAAU;AACV;AAAA,IACJ;AAAA,EACF,OAAO;AACL,QAAI,MAAM,WAAW;AACnB,kBAAY,IAAI,KAAK,MAAM,SAAS;AACpC,gBAAU,SAAS,GAAG,GAAG,GAAG,CAAC;AAAA,IAC/B;AACA,QAAI,MAAM,SAAS;AACjB,gBAAU,IAAI,KAAK,MAAM,OAAO;AAChC,cAAQ,SAAS,IAAI,IAAI,IAAI,GAAG;AAAA,IAClC;AAAA,EACF;AAEA,SAAO,EAAE,WAAW,QAAQ;AAC9B;AAUA,gBAAgB,IAAI,cAAc,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAGrD,UAAM,kBAAkB,CAAC;AACzB,QAAI,WAAW;AAAC,sBAAgB,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AACvE,QAAI,SAAS;AAAC,sBAAgB,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AACnE,UAAM,aAAa,gBAAgB,SAAS,IAAI,IAAI,GAAG,eAAe,IAAI;AAG1E,UAAM,CAAC,aAAa,IAAI,MAAMA,IAC3B,OAAO;AAAA,MACN,cAAc,wBAAgC,OAAO,aAAa;AAAA,MAClE,YAAY;AAAA,IACd,CAAC,EACA,KAAK,MAAM,EACX;AAAA,MACC;AAAA,QACE;AAAA,QACA,GAAG,OAAO,eAAe,MAAM;AAAA,MACjC;AAAA,IACF;AAGF,UAAM,CAAC,aAAa,IAAI,MAAMA,IAC3B,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,MAAM,EACX;AAAA,MACC;AAAA,QACE;AAAA,QACA,GAAG,OAAO,QAAQ,SAAS;AAAA,MAC7B;AAAA,IACF;AAGF,UAAM,qBAAqB,CAAC;AAC5B,QAAI,WAAW;AAAC,yBAAmB,KAAK,IAAI,UAAU,WAAW,SAAS,CAAC;AAAA,IAAE;AAC7E,QAAI,SAAS;AAAC,yBAAmB,KAAK,IAAI,UAAU,WAAW,OAAO,CAAC;AAAA,IAAE;AACzE,UAAM,gBAAgB,mBAAmB,SAAS,IAAI,IAAI,GAAG,kBAAkB,IAAI;AAEnF,UAAM,CAAC,cAAc,IAAI,MAAMA,IAC5B,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd,MAAM,aAAa;AAGtB,UAAM,oBAAoB,eAAe,cAAc,cAAc,aAAa,IAC9E,OAAO,cAAc,YAAY,IAAI,OAAO,cAAc,UAAU,IACpE;AAGJ,QAAI,qBAAqB;AACzB,QAAI,aAAa,SAAS;AACxB,YAAM,eAAe,QAAQ,QAAQ,IAAI,UAAU,QAAQ;AAC3D,YAAM,YAAY,IAAI,KAAK,UAAU,QAAQ,IAAI,YAAY;AAC7D,YAAM,UAAU,IAAI,KAAK,UAAU,QAAQ,IAAI,CAAC;AAEhD,YAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO;AAAA,QACN,cAAc,wBAAgC,OAAO,aAAa;AAAA,QAClE,YAAY;AAAA,MACd,CAAC,EACA,KAAK,MAAM,EACX;AAAA,QACC;AAAA,UACE,IAAI,OAAO,WAAW,SAAS;AAAA,UAC/B,IAAI,OAAO,WAAW,OAAO;AAAA,UAC7B,GAAG,OAAO,eAAe,MAAM;AAAA,QACjC;AAAA,MACF;AAEF,YAAM,CAAC,aAAa,IAAI,MAAMA,IAC3B,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd;AAAA,QACC;AAAA,UACE,IAAI,UAAU,WAAW,SAAS;AAAA,UAClC,IAAI,UAAU,WAAW,OAAO;AAAA,QAClC;AAAA,MACF;AAEF,YAAM,iBAAiB,OAAO,eAAe,gBAAgB,CAAC;AAC9D,YAAM,iBAAiB,OAAO,aAAa,gBAAgB,CAAC;AAE5D,2BAAqB;AAAA,QACnB,eAAe,iBAAiB,KAC1B,iBAAiB,kBAAkB,iBAAkB,MACvD,iBAAiB,IAAI,MAAM;AAAA,QAC/B,kBAAkB,OAAO,aAAa,cAAc,CAAC,IAAI,KACnD,OAAO,eAAe,cAAc,CAAC,IAAI,OAAO,aAAa,cAAc,CAAC,KAAK,OAAO,aAAa,cAAc,CAAC,IAAK,MAC3H,OAAO,eAAe,cAAc,CAAC,IAAI,IAAI,MAAM;AAAA,QACvD,qBAAqB,OAAO,eAAe,SAAS,CAAC,IAAI,KACnD,OAAO,gBAAgB,SAAS,CAAC,IAAI,OAAO,eAAe,SAAS,CAAC,KAAK,OAAO,eAAe,SAAS,CAAC,IAAK,MACjH,OAAO,gBAAgB,SAAS,CAAC,IAAI,IAAI,MAAM;AAAA,MACrD;AAAA,IACF;AAEA,gBAAY,KAAK;AAAA,MACf,cAAc,OAAO,eAAe,gBAAgB,CAAC;AAAA,MACrD,YAAY,OAAO,eAAe,cAAc,CAAC;AAAA,MACjD,eAAe,OAAO,eAAe,SAAS,CAAC;AAAA,MAC/C,eAAe,OAAO,gBAAgB,SAAS,CAAC;AAAA,MAChD,mBAAmB,KAAK,MAAM,oBAAoB,GAAG,IAAI;AAAA,MACzD,0BAA0B;AAAA,IAC5B,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,UAAU,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AACrD,UAAM,UAAW,IAAI,MAAM,SAAS,KAAgB;AAEpD,QAAI;AACJ,YAAQ,SAAS;AAAA,MACf,KAAK;AACH,qBAAa;AACb;AAAA,MACF,KAAK;AACH,qBAAa;AACb;AAAA,MACF,KAAK;AACH,qBAAa;AACb;AAAA,MACF,KAAK;AACH,qBAAa;AACb;AAAA,MACF;AACE,qBAAa;AAAA,IACjB;AAEA,UAAM,aAAa,CAAC,GAAG,OAAO,eAAe,MAAM,CAAC;AACpD,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAG9D,UAAM,aAAa,cAAc,OAAO,SAAS,KAAK,IAAI,IAAI,IAAI,UAAU,GAAG,CAAC;AAEhF,UAAM,YAAY,MAAMA,IACrB,OAAO;AAAA,MACN,QAAQ,MAAc,UAAU;AAAA,MAChC,SAAS,eAAuB,OAAO,aAAa;AAAA,MACpD,YAAY;AAAA,MACZ,mBAAmB,eAAuB,OAAO,aAAa;AAAA,IAChE,CAAC,EACA,KAAK,MAAM,EACX,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,QAAQ,UAAU,EAClB,QAAQ,UAAU;AAErB,gBAAY,KAAK,UAAU,IAAI,UAAQ;AAAA,MACrC,QAAQ,IAAI;AAAA,MACZ,SAAS,OAAO,IAAI,OAAO;AAAA,MAC3B,YAAY,OAAO,IAAI,UAAU;AAAA,MACjC,mBAAmB,KAAK,MAAM,OAAO,IAAI,iBAAiB,IAAI,GAAG,IAAI;AAAA,IACvE,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB,IAAI,oBAAoB,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AAChG,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAErD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAC9D,UAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,UAAM,aAAa,MAAMA,IACtB,OAAO;AAAA,MACN,QAAQ,OAAO;AAAA,MACf,OAAO;AAAA,MACP,YAAY,eAAuB,OAAO,aAAa;AAAA,IACzD,CAAC,EACA,KAAK,MAAM,EACX,MAAM,WAAW,EACjB,QAAQ,OAAO,MAAM;AAExB,gBAAY,KAAK,WAAW,IAAI,UAAQ;AAAA,MACtC,QAAQ,IAAI;AAAA,MACZ,OAAO,OAAO,IAAI,KAAK;AAAA,MACvB,YAAY,OAAO,IAAI,UAAU,KAAK;AAAA,IACxC,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,yBAAyB,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AACrG,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AACrD,UAAM,QAAQ,SAAS,IAAI,MAAM,OAAO,CAAW,KAAK;AAExD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAG9D,eAAW,KAAK,GAAG,OAAO,eAAe,MAAM,CAAC;AAEhD,UAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,MACN,WAAW,WAAW;AAAA,MACtB,aAAa,WAAW;AAAA,MACxB,eAAe,UAAkB,WAAW,QAAQ;AAAA,MACpD,cAAc,eAAuB,WAAW,iBAAiB,kBAAkB,WAAW,QAAQ;AAAA,MACtG,YAAY,qBAA6B,WAAW,OAAO;AAAA,IAC7D,CAAC,EACA,KAAK,UAAU,EACf,UAAU,QAAQ,GAAG,WAAW,SAAS,OAAO,EAAE,CAAC,EACnD,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,QAAQ,WAAW,WAAW,WAAW,mBAAmB,EAC5D,QAAQ,KAAK,UAAU,WAAW,QAAQ,GAAG,CAAC,EAC9C,MAAM,KAAK;AAEd,gBAAY,KAAK,YAAY,IAAI,UAAQ;AAAA,MACvC,WAAW,IAAI;AAAA,MACf,aAAa,IAAI;AAAA,MACjB,eAAe,OAAO,IAAI,aAAa;AAAA,MACvC,cAAc,OAAO,IAAI,YAAY;AAAA,MACrC,YAAY,OAAO,IAAI,UAAU;AAAA,IACnC,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB,IAAI,uBAAuB,OAAO,KAAK,KAAK,SAAS;AACnE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,YAAY,SAAS,IAAI,MAAM,WAAW,CAAW,KAAK;AAGhE,UAAM,mBAAmB,MAAMA,IAC5B,OAAO;AAAA,MACN,IAAI,SAAS;AAAA,MACb,MAAM,SAAS;AAAA,MACf,KAAK,SAAS;AAAA,MACd,eAAe,SAAS;AAAA,MACxB,QAAQ,SAAS;AAAA,IACnB,CAAC,EACA,KAAK,QAAQ,EACb;AAAA,MACC;AAAA,QACE,GAAG,SAAS,QAAQ,QAAQ;AAAA,QAC5B,IAAI,SAAS,eAAe,SAAS;AAAA,MACvC;AAAA,IACF,EACC,QAAQ,SAAS,aAAa,EAC9B,MAAM,EAAE;AAGX,UAAM,mBAAmB,MAAMA,IAC5B,OAAO;AAAA,MACN,IAAI,gBAAgB;AAAA,MACpB,WAAW,gBAAgB;AAAA,MAC3B,aAAa,SAAS;AAAA,MACtB,KAAK,gBAAgB;AAAA,MACrB,SAAS,gBAAgB;AAAA,MACzB,eAAe,gBAAgB;AAAA,IACjC,CAAC,EACA,KAAK,eAAe,EACpB,UAAU,UAAU,GAAG,gBAAgB,WAAW,SAAS,EAAE,CAAC,EAC9D;AAAA,MACC;AAAA,QACE,GAAG,gBAAgB,UAAU,IAAI;AAAA,QACjC,IAAI,gBAAgB,eAAe,SAAS;AAAA,MAC9C;AAAA,IACF,EACC,QAAQ,gBAAgB,aAAa,EACrC,MAAM,EAAE;AAEX,gBAAY,KAAK;AAAA,MACf,UAAU;AAAA,MACV,UAAU;AAAA,MACV;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,uBAAuB,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AACnG,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAErD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,UAAU,WAAW,SAAS,CAAC;AAAA,IAAE;AACrE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,UAAU,WAAW,OAAO,CAAC;AAAA,IAAE;AACjE,UAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAGjE,UAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd,MAAM,WAAW;AAGpB,UAAM,CAAC,WAAW,IAAI,MAAMA,IACzB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd;AAAA,MACC;AAAA,QACE;AAAA,QACA,GAAG,UAAU,SAAS,IAAI;AAAA,MAC5B;AAAA,IACF;AAGF,UAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,SAAS,EACd;AAAA,MACC;AAAA,QACE;AAAA,QACA,MAAM,UAAU,UAAU;AAAA,MAC5B;AAAA,IACF;AAGF,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,IAAI,UAAU;AAAA,MACd,OAAO,UAAU;AAAA,MACjB,WAAW,UAAU;AAAA,MACrB,UAAU,UAAU;AAAA,MACpB,YAAY,UAAU;AAAA,IACxB,CAAC,EACA,KAAK,SAAS,EACd,MAAM,MAAM,UAAU,UAAU,MAAM,EACtC,QAAQ,KAAK,UAAU,UAAU,CAAC,EAClC,MAAM,EAAE;AAEX,gBAAY,KAAK;AAAA,MACf,gBAAgB,OAAO,aAAa,SAAS,CAAC;AAAA,MAC9C,gBAAgB,OAAO,aAAa,SAAS,CAAC;AAAA,MAC9C,qBAAqB,OAAO,aAAa,SAAS,CAAC,IAAI,OAAO,aAAa,SAAS,CAAC;AAAA,MACrF,qBAAqB,OAAO,kBAAkB,SAAS,CAAC;AAAA,MACxD;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB,IAAI,kBAAkB,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AAC9F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AACrD,UAAM,UAAW,IAAI,MAAM,SAAS,KAAgB;AAEpD,QAAI;AACJ,YAAQ,SAAS;AAAA,MACf,KAAK;AACH,qBAAa;AACb;AAAA,MACF,KAAK;AACH,qBAAa;AACb;AAAA,MACF,KAAK;AACH,qBAAa;AACb;AAAA,MACF;AACE,qBAAa;AAAA,IACjB;AAEA,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,UAAU,WAAW,SAAS,CAAC;AAAA,IAAE;AACrE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,UAAU,WAAW,OAAO,CAAC;AAAA,IAAE;AACjE,UAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,QAAQ,cAAsB,UAAU,SAAS,KAAK,UAAU;AAAA,MAChE,OAAO;AAAA,MACP,QAAQ,6BAAqC,UAAU,OAAO;AAAA,MAC9D,YAAY,6BAAqC,UAAU,OAAO;AAAA,IACpE,CAAC,EACA,KAAK,SAAS,EACd,MAAM,WAAW,EACjB,QAAQ,cAAc,UAAU,SAAS,KAAK,UAAU,GAAG,EAC3D,QAAQ,cAAc,UAAU,SAAS,KAAK,UAAU,GAAG;AAE9D,gBAAY,KAAK,aAAa,IAAI,UAAQ;AAAA,MACxC,QAAQ,IAAI;AAAA,MACZ,OAAO,OAAO,IAAI,KAAK;AAAA,MACvB,QAAQ,OAAO,IAAI,MAAM;AAAA,MACzB,YAAY,OAAO,IAAI,UAAU;AAAA,IACnC,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,sBAAsB,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AAClG,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAErD,UAAM,aAAa,CAAC,GAAG,OAAO,eAAe,MAAM,CAAC;AACpD,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAE9D,UAAM,CAAC,SAAS,IAAI,MAAMA,IACvB,OAAO;AAAA,MACN,UAAU,eAAuB,OAAO,gBAAgB;AAAA,MACxD,WAAW,eAAuB,OAAO,iBAAiB;AAAA,MAC1D,gBAAgB,eAAuB,OAAO,sBAAsB;AAAA,MACpE,gBAAgB,eAAuB,OAAO,sBAAsB;AAAA,MACpE,OAAO,eAAuB,OAAO,aAAa;AAAA,MAClD,YAAY;AAAA,IACd,CAAC,EACA,KAAK,MAAM,EACX,MAAM,IAAI,GAAG,UAAU,CAAC;AAE3B,gBAAY,KAAK;AAAA,MACf,UAAU,OAAO,WAAW,QAAQ,KAAK;AAAA,MACzC,WAAW,OAAO,WAAW,SAAS,KAAK;AAAA,MAC3C,gBAAgB,OAAO,WAAW,cAAc,KAAK;AAAA,MACrD,gBAAgB,OAAO,WAAW,cAAc,KAAK;AAAA,MACrD,OAAO,OAAO,WAAW,KAAK,KAAK;AAAA,MACnC,YAAY,OAAO,WAAW,UAAU,KAAK;AAAA,IAC/C,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,gBAAgB,IAAI,8BAA8B,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AAC1G,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAErD,UAAM,aAAa,CAAC,GAAG,OAAO,eAAe,MAAM,CAAC;AACpD,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAE9D,UAAM,kBAAkB,MAAMA,IAC3B,OAAO;AAAA,MACN,eAAe,OAAO;AAAA,MACtB,SAAS,eAAuB,OAAO,aAAa;AAAA,MACpD,YAAY;AAAA,IACd,CAAC,EACA,KAAK,MAAM,EACX,MAAM,IAAI,GAAG,UAAU,CAAC,EACxB,QAAQ,OAAO,aAAa;AAE/B,gBAAY,KAAK,gBAAgB,IAAI,UAAQ;AAAA,MAC3C,eAAe,IAAI,iBAAiB;AAAA,MACpC,SAAS,OAAO,IAAI,OAAO;AAAA,MAC3B,YAAY,OAAO,IAAI,UAAU;AAAA,IACnC,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC9D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,QAAQ,SAAS,IAAI,MAAM,OAAO,CAAW,KAAK;AAExD,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,IAAI,OAAO;AAAA,MACX,aAAa,OAAO;AAAA,MACpB,YAAY,OAAO;AAAA,MACnB,eAAe,UAAU;AAAA,MACzB,mBAAmB,UAAU;AAAA,MAC7B,kBAAkB,UAAU;AAAA,MAC5B,OAAO,OAAO;AAAA,MACd,QAAQ,OAAO;AAAA,MACf,WAAW,OAAO;AAAA,IACpB,CAAC,EACA,KAAK,MAAM,EACX,SAAS,WAAW,GAAG,OAAO,YAAY,UAAU,EAAE,CAAC,EACvD,QAAQ,KAAK,OAAO,SAAS,CAAC,EAC9B,MAAM,KAAK;AAEd,gBAAY,KAAK,aAAa,IAAI,YAAU;AAAA,MAC1C,IAAI,MAAM;AAAA,MACV,aAAa,MAAM;AAAA,MACnB,UAAU,MAAM,qBAAqB,MAAM,mBACvC,GAAG,MAAM,iBAAiB,IAAI,MAAM,gBAAgB,KACpD,MAAM,iBAAiB;AAAA,MAC3B,OAAO,OAAO,MAAM,KAAK;AAAA,MACzB,QAAQ,MAAM;AAAA,MACd,WAAW,MAAM,WAAW,YAAY,MAAK,oBAAI,KAAK,GAAE,YAAY;AAAA,IACtE,EAAE,CAAC;AAAA,EACL,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,gBAAgB,IAAI,WAAW,cAAc,eAAe,GAAG,OAAO,KAAK,KAAK,SAAS;AACvF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,WAAW,QAAQ,IAAI,aAAa,IAAI,KAAK;AAGrD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,SAAS,CAAC;AAAA,IAAE;AAClE,QAAI,SAAS;AAAC,iBAAW,KAAK,IAAI,OAAO,WAAW,OAAO,CAAC;AAAA,IAAE;AAG9D,UAAM,YAAY,MAAMA,IACrB,OAAO;AAAA,MACN,IAAI,OAAO;AAAA,MACX,aAAa,OAAO;AAAA,MACpB,QAAQ,OAAO;AAAA,MACf,eAAe,OAAO;AAAA,MACtB,OAAO,OAAO;AAAA,MACd,WAAW,OAAO;AAAA,IACpB,CAAC,EACA,KAAK,MAAM,EACX,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,OAAO,SAAS,CAAC;AAGjC,UAAM,qBAAqB,CAAC;AAC5B,QAAI,WAAW;AAAC,yBAAmB,KAAK,IAAI,UAAU,WAAW,SAAS,CAAC;AAAA,IAAE;AAC7E,QAAI,SAAS;AAAC,yBAAmB,KAAK,IAAI,UAAU,WAAW,OAAO,CAAC;AAAA,IAAE;AAEzE,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,IAAI,UAAU;AAAA,MACd,OAAO,UAAU;AAAA,MACjB,SAAS,UAAU;AAAA,MACnB,YAAY,UAAU;AAAA,MACtB,WAAW,UAAU;AAAA,IACvB,CAAC,EACA,KAAK,SAAS,EACd,MAAM,mBAAmB,SAAS,IAAI,IAAI,GAAG,kBAAkB,IAAI,MAAS;AAE/E,UAAM,aAAa;AAAA,MACjB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,MACnC,WAAW,EAAE,WAAW,QAAQ;AAAA,MAChC,SAAS;AAAA,QACP,aAAa,UAAU;AAAA,QACvB,gBAAgB,aAAa;AAAA,QAC7B,cAAc,UACX,OAAO,OAAK,EAAE,kBAAkB,MAAM,EACtC,OAAO,CAACC,MAAK,MAAMA,OAAM,OAAO,EAAE,KAAK,GAAG,CAAC;AAAA,MAChD;AAAA,MACA,QAAQ,UAAU,IAAI,QAAM;AAAA,QAC1B,GAAG;AAAA,QACH,OAAO,OAAO,EAAE,KAAK;AAAA,MACvB,EAAE;AAAA,MACF,WAAW;AAAA,IACb;AAEA,QAAI,UAAU,gBAAgB,kBAAkB;AAChD,QAAI;AAAA,MACF;AAAA,MACA,2CAA0C,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,CAAC;AAAA,IAClF;AAEA,QAAI,KAAK,UAAU;AAAA,EACrB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACptBD,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAMX,IAAM,mBAAe,yBAAO;AAGnC,aAAa,IAAI,aAAa,YAAY;AAM1C,IAAM,oBAAoB,eAAE,OAAO;AAAA,EACjC,QAAQ,eAAE,KAAK,CAAC,OAAO,QAAQ,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EACjE,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAGD,SAAS,iBAAiB,KAAU,UAAkB,aAAqB;AACzE,MAAI,UAAU,gBAAgB,WAAW;AACzC,MAAI,UAAU,uBAAuB,yBAAyB,QAAQ,GAAG;AAC3E;AAUA,aAAa,IAAI,aAAa,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AACxF,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,OAAO,IAAI,IAAI;AAE/B,UAAM,aAAa,CAAC;AACpB,QAAI,QAAQ;AACV,iBAAW,KAAK,GAAG,SAAS,QAAQ,MAAyC,CAAC;AAAA,IAChF;AAEA,UAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,MACN,IAAI,SAAS;AAAA,MACb,KAAK,SAAS;AAAA,MACd,SAAS,SAAS;AAAA,MAClB,MAAM,SAAS;AAAA,MACf,MAAM,SAAS;AAAA,MACf,aAAa,SAAS;AAAA,MACtB,kBAAkB,SAAS;AAAA,MAC3B,YAAY,SAAS;AAAA,MACrB,cAAc,WAAW;AAAA,MACzB,OAAO,SAAS;AAAA,MAChB,WAAW,SAAS;AAAA,MACpB,WAAW,SAAS;AAAA,MACpB,gBAAgB,SAAS;AAAA,MACzB,QAAQ,SAAS;AAAA,MACjB,YAAY,SAAS;AAAA,MACrB,eAAe,SAAS;AAAA,MACxB,mBAAmB,SAAS;AAAA,MAC5B,gBAAgB,SAAS;AAAA,MACzB,gBAAgB,SAAS;AAAA,MACzB,QAAQ,SAAS;AAAA,MACjB,QAAQ,SAAS;AAAA,MACjB,cAAc,SAAS;AAAA,MACvB,MAAM,SAAS;AAAA,MACf,gBAAgB,SAAS;AAAA,MACzB,UAAU,SAAS;AAAA,MACnB,WAAW,SAAS;AAAA,MACpB,iBAAiB,SAAS;AAAA,MAC1B,QAAQ,SAAS;AAAA,MACjB,YAAY,SAAS;AAAA,MACrB,WAAW,SAAS;AAAA,MACpB,kBAAkB,SAAS;AAAA,MAC3B,YAAY,SAAS;AAAA,MACrB,aAAa,SAAS;AAAA,MACtB,cAAc,SAAS;AAAA,MACvB,aAAa,SAAS;AAAA,MACtB,WAAW,SAAS;AAAA,MACpB,WAAW,SAAS;AAAA,IACtB,CAAC,EACA,KAAK,QAAQ,EACb,SAAS,YAAY,GAAG,SAAS,YAAY,WAAW,EAAE,CAAC,EAC3D,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,SAAS,SAAS,CAAC;AAEnC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,YAAY,SAAS;AAEhE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,aAAsB,cAAc,kBAAkB,CAAC;AACvF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,WAAW,CAAC;AAAA,IAC7C,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,WAAW,CAAC;AAAA,IAC5C;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa,IAAI,WAAW,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AACtF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,WAAW,SAAS,OAAO,IAAI,IAAI;AAEnD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AACb,iBAAW,KAAK,IAAI,OAAO,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,IACtE;AACA,QAAI,SAAS;AACX,YAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,UAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,iBAAW,KAAK,IAAI,OAAO,WAAW,GAAG,CAAC;AAAA,IAC5C;AACA,QAAI,QAAQ;AACV,iBAAW,KAAK,GAAG,OAAO,QAAQ,MAAwF,CAAC;AAAA,IAC7H;AAEA,UAAM,YAAY,MAAMA,IACrB,OAAO;AAAA,MACN,IAAI,OAAO;AAAA,MACX,aAAa,OAAO;AAAA,MACpB,YAAY,OAAO;AAAA,MACnB,eAAe,UAAU;AAAA,MACzB,cAAc,aAAqB,UAAU,SAAS,UAAU,UAAU,QAAQ;AAAA,MAClF,QAAQ,OAAO;AAAA,MACf,eAAe,OAAO;AAAA,MACtB,eAAe,OAAO;AAAA,MACtB,iBAAiB,OAAO;AAAA,MACxB,gBAAgB,OAAO;AAAA,MACvB,UAAU,OAAO;AAAA,MACjB,kBAAkB,OAAO;AAAA,MACzB,iBAAiB,OAAO;AAAA,MACxB,mBAAmB,OAAO;AAAA,MAC1B,wBAAwB,OAAO;AAAA,MAC/B,wBAAwB,OAAO;AAAA,MAC/B,eAAe,OAAO;AAAA,MACtB,aAAa,OAAO;AAAA,MACpB,mBAAmB,OAAO;AAAA,MAC1B,gBAAgB,OAAO;AAAA,MACvB,gBAAgB,OAAO;AAAA,MACvB,aAAa,OAAO;AAAA,MACpB,cAAc,OAAO;AAAA,MACrB,WAAW,OAAO;AAAA,MAClB,aAAa,OAAO;AAAA,MACpB,eAAe,OAAO;AAAA,MACtB,YAAY,OAAO;AAAA,MACnB,WAAW,OAAO;AAAA,MAClB,WAAW,OAAO;AAAA,IACpB,CAAC,EACA,KAAK,MAAM,EACX,SAAS,WAAW,GAAG,OAAO,YAAY,UAAU,EAAE,CAAC,EACvD,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,OAAO,SAAS,CAAC;AAEjC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,UAAU,SAAS;AAE9D,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,WAAoB,cAAc,gBAAgB,CAAC;AACnF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,SAAS,CAAC;AAAA,IAC3C,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,SAAS,CAAC;AAAA,IAC1C;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,qBAAqB,OAAO,KAAK,KAAK,SAAS;AAC9D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,SAAU,IAAI,MAAM,QAAQ,KAAgB;AAGlD,UAAM,CAAC,KAAK,IAAI,MAAMA,IAAG,OAAO,EAAE,aAAa,OAAO,YAAY,CAAC,EAAE,KAAK,MAAM,EAAE,MAAM,GAAG,OAAO,IAAI,EAAE,CAAC;AAEzG,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,WAAW;AAAA,MACf,SAAS,WAAW;AAAA,MACpB,aAAa,MAAc,OAAO,eAAe,EAAE;AAAA,MACnD,WAAW,WAAW;AAAA,MACtB,WAAW,WAAW;AAAA,MACtB,qBAAqB,WAAW;AAAA,MAChC,aAAa,WAAW;AAAA,MACxB,wBAAwB,WAAW;AAAA,MACnC,UAAU,WAAW;AAAA,MACrB,mBAAmB,WAAW;AAAA,MAC9B,WAAW,WAAmB,WAAW,iBAAiB,kBAAkB,WAAW,QAAQ;AAAA,MAC/F,WAAW,WAAW;AAAA,IACxB,CAAC,EACA,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,SAAS,EAAE,CAAC;AAEnC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,SAAS,OAAO,eAAe,EAAE,UAAU,SAAS;AAE/F,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,OAAgB,cAAc,oBAAoB,CAAC;AACnF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,KAAK,CAAC;AAAA,IACvC,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,KAAK,CAAC;AAAA,IACtC;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,gBAAgB,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,WAAW,QAAQ,IAAI,IAAI;AAE3C,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AACb,iBAAW,KAAK,IAAI,OAAO,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,IACtE;AACA,QAAI,SAAS;AACX,YAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,UAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,iBAAW,KAAK,IAAI,OAAO,WAAW,GAAG,CAAC;AAAA,IAC5C;AAEA,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,WAAW;AAAA,MACf,SAAS,WAAW;AAAA,MACpB,aAAa,OAAO;AAAA,MACpB,WAAW,WAAW;AAAA,MACtB,WAAW,WAAW;AAAA,MACtB,qBAAqB,WAAW;AAAA,MAChC,aAAa,WAAW;AAAA,MACxB,wBAAwB,WAAW;AAAA,MACnC,UAAU,WAAW;AAAA,MACrB,mBAAmB,WAAW;AAAA,MAC9B,WAAW,WAAmB,WAAW,iBAAiB,kBAAkB,WAAW,QAAQ;AAAA,MAC/F,WAAW,WAAW;AAAA,IACxB,CAAC,EACA,KAAK,UAAU,EACf,UAAU,QAAQ,GAAG,WAAW,SAAS,OAAO,EAAE,CAAC,EACnD,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,OAAO,SAAS,CAAC;AAEjC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,eAAe,SAAS;AAEnE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,OAAgB,cAAc,oBAAoB,CAAC;AACnF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,KAAK,CAAC;AAAA,IACvC,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,KAAK,CAAC;AAAA,IACtC;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa,IAAI,cAAc,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AACzF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,WAAW,QAAQ,IAAI,IAAI;AAE3C,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AACb,iBAAW,KAAK,IAAI,UAAU,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,IACzE;AACA,QAAI,SAAS;AACX,YAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,UAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,iBAAW,KAAK,IAAI,UAAU,WAAW,GAAG,CAAC;AAAA,IAC/C;AAEA,UAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,MACN,IAAI,UAAU;AAAA,MACd,YAAY,UAAU;AAAA,MACtB,OAAO,UAAU;AAAA,MACjB,WAAW,UAAU;AAAA,MACrB,UAAU,UAAU;AAAA,MACpB,OAAO,UAAU;AAAA,MACjB,wBAAwB,UAAU;AAAA,MAClC,uBAAuB,UAAU;AAAA,MACjC,SAAS,UAAU;AAAA,MACnB,UAAU,UAAU;AAAA,MACpB,kBAAkB,UAAU;AAAA,MAC5B,OAAO,UAAU;AAAA,MACjB,MAAM,UAAU;AAAA,MAChB,YAAY,UAAU;AAAA,MACtB,WAAW,UAAU;AAAA,MACrB,WAAW,UAAU;AAAA,IACvB,CAAC,EACA,KAAK,SAAS,EACd,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,UAAU,SAAS,CAAC;AAEpC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,aAAa,SAAS;AAEjE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,cAAuB,cAAc,mBAAmB,CAAC;AACzF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,YAAY,CAAC;AAAA,IAC9C,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,YAAY,CAAC;AAAA,IAC7C;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa,IAAI,gBAAgB,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,gBAAgB,MAAMA,IACzB,OAAO,EACP,KAAK,UAAU,EACf,QAAQ,KAAK,WAAW,SAAS,CAAC;AAErC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,eAAe,SAAS;AAEnE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,eAAwB,cAAc,oBAAoB,CAAC;AAC3F,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,aAAa,CAAC;AAAA,IAC/C,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,aAAa,CAAC;AAAA,IAC9C;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,aAAa,IAAI,eAAe,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,WAAW,SAAS,OAAO,IAAI,IAAI;AAEnD,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AACb,iBAAW,KAAK,IAAI,WAAW,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,IAC1E;AACA,QAAI,SAAS;AACX,YAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,UAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,iBAAW,KAAK,IAAI,WAAW,WAAW,GAAG,CAAC;AAAA,IAChD;AACA,QAAI,QAAQ;AACV,iBAAW,KAAK,GAAG,WAAW,QAAQ,MAAgE,CAAC;AAAA,IACzG;AAEA,UAAM,gBAAgB,MAAMA,IACzB,OAAO,EACP,KAAK,UAAU,EACf,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,WAAW,SAAS,CAAC;AAErC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,cAAc,SAAS;AAElE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,eAAwB,cAAc,oBAAoB,CAAC;AAC3F,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,aAAa,CAAC;AAAA,IAC/C,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,aAAa,CAAC;AAAA,IAC9C;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,oBAAoB,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC/F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,QAAQ,WAAW,QAAQ,IAAI,IAAI;AAE3C,UAAM,aAAa,CAAC;AACpB,QAAI,WAAW;AACb,iBAAW,KAAK,IAAI,WAAW,WAAW,IAAI,KAAK,SAAmB,CAAC,CAAC;AAAA,IAC1E;AACA,QAAI,SAAS;AACX,YAAM,MAAM,IAAI,KAAK,OAAiB;AACtC,UAAI,SAAS,IAAI,IAAI,IAAI,GAAG;AAC5B,iBAAW,KAAK,IAAI,WAAW,WAAW,GAAG,CAAC;AAAA,IAChD;AAEA,UAAM,QAAQ,MAAMA,IACjB,OAAO;AAAA,MACN,IAAI,eAAe;AAAA,MACnB,aAAa,eAAe;AAAA,MAC5B,iBAAiB,WAAW;AAAA,MAC5B,WAAW,eAAe;AAAA,MAC1B,WAAW,eAAe;AAAA,MAC1B,MAAM,eAAe;AAAA,MACrB,aAAa,eAAe;AAAA,MAC5B,KAAK,eAAe;AAAA,MACpB,UAAU,eAAe;AAAA,MACzB,WAAW,eAAe;AAAA,MAC1B,WAAW,WAAmB,eAAe,SAAS,kBAAkB,eAAe,QAAQ;AAAA,MAC/F,WAAW,eAAe;AAAA,IAC5B,CAAC,EACA,KAAK,cAAc,EACnB,UAAU,YAAY,GAAG,eAAe,aAAa,WAAW,EAAE,CAAC,EACnE,MAAM,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI,MAAS,EAC5D,QAAQ,KAAK,WAAW,SAAS,CAAC;AAErC,UAAM,EAAE,aAAa,UAAU,IAAI,cAAc,eAAe,MAAkC;AAClG,UAAM,WAAW,cAAc,YAAY,mBAAmB,SAAS;AAEvE,qBAAiB,KAAK,UAAU,WAAW;AAE3C,QAAI,WAAW,OAAO;AACpB,YAAM,MAAM,cAAc,MAAM,OAAgB,cAAc,wBAAwB,CAAC;AACvF,UAAI,KAAK,GAAG;AAAA,IACd,WAAW,WAAW,SAAS;AAC7B,UAAI,KAAK,cAAc,QAAQ,KAAK,CAAC;AAAA,IACvC,OAAO;AACL,UAAI,KAAK,cAAc,OAAO,KAAK,CAAC;AAAA,IACtC;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACtfD,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAuBX,IAAM,mBAAe,yBAAO;AAGnC,aAAa,IAAI,aAAa,YAAY;AAM1C,IAAM,kBAAkB,eAAE,OAAO;AAAA,EAC/B,YAAY,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAC5B,QAAQ,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC5C,gBAAgB,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AACtD,CAAC;AAED,IAAM,kBAAkB,eAAE,OAAO;AAAA,EAC/B,KAAK,eAAE,OAAO,EAAE,IAAI;AAAA,EACpB,QAAQ,eAAE,KAAK,CAAC,UAAU,cAAc,QAAQ,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,OAAO;AACtF,CAAC;AAUD,aAAa,IAAI,uBAAuB,CAAC,MAAM,QAAQ;AACrD,MAAI,UAAU,gBAAgB,UAAU;AACxC,MAAI,UAAU,uBAAuB,oDAAoD;AACzF,MAAI,KAAK,cAAc,mBAAmB,CAAC;AAC7C,CAAC;AAMD,aAAa,IAAI,wBAAwB,CAAC,MAAM,QAAQ;AACtD,MAAI,UAAU,gBAAgB,UAAU;AACxC,MAAI,UAAU,uBAAuB,qDAAqD;AAC1F,MAAI,KAAK,cAAc,oBAAoB,CAAC;AAC9C,CAAC;AAUD,aAAa;AAAA,EACX;AAAA,EACA,aAAa,eAAe;AAAA,EAC5B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,EAAE,YAAY,QAAQ,eAAe,IAAI,IAAI;AAGnD,YAAM,UAAU,cAAc,SAAS,UAAU;AAEjD,UAAI,QAAQ,WAAW,GAAG;AACxB,cAAM,IAAI,gBAAgB,8BAA8B;AAAA,MAC1D;AAGA,YAAM,SAAS,cAAc;AAAA,QAC3B;AAAA,QACA,cAAc,mBAAmB;AAAA,QACjC,cAAc,iBAAiB;AAAA,MACjC;AAGA,UAAI,QAAQ;AACV,eAAO,YAAY,KAAK;AAAA,UACtB,QAAQ;AAAA,UACR,GAAG;AAAA,UACH,MAAM,OAAO,KAAK,MAAM,GAAG,CAAC;AAAA;AAAA,QAC9B,CAAC;AAAA,MACH;AAGA,UAAI,gBAAgB;AACpB,UAAI,eAAe;AACnB,UAAI,eAAe;AAEnB,iBAAW,eAAe,OAAO,MAAM;AACrC,cAAM,OAAO;AAGb,cAAM,CAAC,eAAe,IAAI,MAAMA,IAC7B,OAAO,EAAE,IAAI,SAAS,GAAG,CAAC,EAC1B,KAAK,QAAQ,EACb,MAAM,GAAG,SAAS,KAAK,KAAK,GAAG,CAAC;AAEnC,YAAI,iBAAiB;AACnB,cAAI,gBAAgB;AAElB,kBAAMA,IACH,OAAO,QAAQ,EACf,IAAI;AAAA,cACH,MAAM,KAAK;AAAA,cACX,SAAS,KAAK;AAAA,cACd,aAAa,KAAK;AAAA,cAClB,kBAAkB,KAAK;AAAA,cACvB,WAAW,OAAO,KAAK,SAAS;AAAA,cAChC,WAAW,KAAK,YAAY,OAAO,KAAK,SAAS,IAAI;AAAA,cACrD,gBAAgB,KAAK,iBAAiB,OAAO,KAAK,cAAc,IAAI;AAAA,cACpE,eAAe,KAAK;AAAA,cACpB,mBAAmB,KAAK;AAAA,cACxB,gBAAgB,KAAK;AAAA,cACrB,gBAAgB,KAAK;AAAA,cACrB,QAAQ,KAAK,SAAS,OAAO,KAAK,MAAM,IAAI;AAAA,cAC5C,YAAY,KAAK;AAAA,cACjB,OAAO,KAAK;AAAA,cACZ,QAAQ,KAAK;AAAA,cACb,YAAY,KAAK;AAAA,cACjB,WAAW,KAAK;AAAA,cAChB,kBAAkB,KAAK;AAAA,cACvB,cAAc,KAAK;AAAA,cACnB,QAAQ,KAAK;AAAA,cACb,WAAW,KAAK;AAAA,cAChB,iBAAiB,KAAK;AAAA,cACtB,MAAM,KAAK;AAAA,cACX,UAAU,KAAK;AAAA,cACf,gBAAgB,KAAK;AAAA,cACrB,YAAY,KAAK;AAAA,cACjB,aAAa,KAAK;AAAA,cAClB,WAAW,oBAAI,KAAK;AAAA,YACtB,CAAC,EACA,MAAM,GAAG,SAAS,IAAI,gBAAgB,EAAE,CAAC;AAC5C;AAAA,UACF,OAAO;AACL;AAAA,UACF;AACA;AAAA,QACF;AAGA,YAAI;AACJ,YAAI,KAAK,cAAc;AACrB,gBAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,WAAW,GAAG,CAAC,EAC5B,KAAK,UAAU,EACf,MAAM,GAAG,WAAW,MAAM,KAAK,YAAY,CAAC;AAE/C,cAAI,UAAU;AACZ,yBAAa,SAAS;AAAA,UACxB;AAAA,QACF;AAGA,cAAM,OAAO,aAAa,KAAK,IAAI;AAGnC,cAAMA,IAAG,OAAO,QAAQ,EAAE,OAAO;AAAA,UAC/B,MAAM,KAAK;AAAA,UACX,MAAM,GAAG,IAAI,IAAI,KAAK,IAAI,CAAC;AAAA;AAAA,UAC3B,KAAK,KAAK;AAAA,UACV,SAAS,KAAK;AAAA,UACd,aAAa,KAAK;AAAA,UAClB,kBAAkB,KAAK;AAAA,UACvB,WAAW,OAAO,KAAK,SAAS;AAAA,UAChC,WAAW,KAAK,YAAY,OAAO,KAAK,SAAS,IAAI;AAAA,UACrD,gBAAgB,KAAK,iBAAiB,OAAO,KAAK,cAAc,IAAI;AAAA,UACpE,eAAe,KAAK,iBAAiB;AAAA,UACrC,mBAAmB,KAAK,qBAAqB;AAAA,UAC7C,gBAAgB,KAAK,kBAAkB;AAAA,UACvC,gBAAgB,KAAK,kBAAkB;AAAA,UACvC,QAAQ,KAAK,SAAS,OAAO,KAAK,MAAM,IAAI;AAAA,UAC5C,YAAY,KAAK;AAAA,UACjB;AAAA,UACA,OAAO,KAAK;AAAA,UACZ,QAAQ,KAAK,UAAU;AAAA,UACvB,YAAY,KAAK,cAAc;AAAA,UAC/B,WAAW,KAAK,aAAa;AAAA,UAC7B,kBAAkB,KAAK,oBAAoB;AAAA,UAC3C,cAAc,KAAK;AAAA,UACnB,QAAQ,KAAK,UAAU,CAAC;AAAA,UACxB,WAAW,KAAK;AAAA,UAChB,iBAAiB,KAAK;AAAA,UACtB,MAAM,KAAK,QAAQ,CAAC;AAAA,UACpB,UAAU,KAAK,YAAY,CAAC;AAAA,UAC5B,gBAAgB,KAAK,kBAAkB,CAAC;AAAA,UACxC,YAAY,KAAK;AAAA,UACjB,aAAa,KAAK;AAAA,QACpB,CAAC;AAED;AAAA,MACF;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,WAAW,OAAO;AAAA,QAClB,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,QACT,QAAQ,OAAO;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAUA,aAAa;AAAA,EACX;AAAA,EACA,aAAa,eAAe;AAAA,EAC5B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,YAAY,QAAQ,eAAe,IAAI,IAAI;AAGnD,YAAM,UAAU,cAAc,SAAS,UAAU;AAEjD,UAAI,QAAQ,WAAW,GAAG;AACxB,cAAM,IAAI,gBAAgB,8BAA8B;AAAA,MAC1D;AAGA,YAAM,SAAS,cAAc;AAAA,QAC3B;AAAA,QACA,cAAc,oBAAoB;AAAA,QAClC,cAAc,kBAAkB;AAAA,MAClC;AAGA,UAAI,QAAQ;AACV,eAAO,YAAY,KAAK;AAAA,UACtB,QAAQ;AAAA,UACR,GAAG;AAAA,UACH,MAAM,OAAO,KAAK,MAAM,GAAG,CAAC;AAAA,QAC9B,CAAC;AAAA,MACH;AAGA,UAAI,gBAAgB;AACpB,UAAI,eAAe;AACnB,UAAI,eAAe;AAEnB,iBAAW,gBAAgB,OAAO,MAAM;AACtC,cAAM,OAAO;AAGb,cAAM,CAAC,gBAAgB,IAAI,MAAMA,IAC9B,OAAO,EAAE,IAAI,UAAU,GAAG,CAAC,EAC3B,KAAK,SAAS,EACd,MAAM,GAAG,UAAU,OAAO,KAAK,MAAM,YAAY,CAAC,CAAC;AAEtD,YAAI,kBAAkB;AACpB,cAAI,gBAAgB;AAElB,kBAAMC,mBAAkB,cAAc,2BAA2B,MAAiC,UAAU;AAC5G,kBAAMC,kBAAiB,cAAc,2BAA2B,MAAiC,SAAS;AAE1G,kBAAMF,IACH,OAAO,SAAS,EAChB,IAAI;AAAA,cACH,WAAW,KAAK;AAAA,cAChB,UAAU,KAAK;AAAA,cACf,OAAO,KAAK;AAAA,cACZ,UAAU,KAAK;AAAA,cACf,kBAAkB,KAAK;AAAA,cACvB,OAAO,KAAK;AAAA,cACZ,MAAM,KAAK;AAAA,cACX,wBAAwBC;AAAA,cACxB,uBAAuBC;AAAA,cACvB,WAAW,oBAAI,KAAK;AAAA,YACtB,CAAC,EACA,MAAM,GAAG,UAAU,IAAI,iBAAiB,EAAE,CAAC;AAC9C;AAAA,UACF,OAAO;AACL;AAAA,UACF;AACA;AAAA,QACF;AAGA,cAAM,kBAAkB,cAAc,2BAA2B,MAAiC,UAAU;AAC5G,cAAM,iBAAiB,cAAc,2BAA2B,MAAiC,SAAS;AAG1G,cAAMF,IAAG,OAAO,SAAS,EAAE,OAAO;AAAA,UAChC,OAAO,KAAK,MAAM,YAAY;AAAA,UAC9B,WAAW,KAAK;AAAA,UAChB,UAAU,KAAK;AAAA,UACf,OAAO,KAAK;AAAA,UACZ,UAAU,KAAK,YAAY;AAAA,UAC3B,SAAS;AAAA,UACT,kBAAkB,KAAK,oBAAoB;AAAA,UAC3C,OAAO,KAAK;AAAA,UACZ,MAAM,KAAK,QAAQ,CAAC;AAAA,UACpB,wBAAwB;AAAA,UACxB,uBAAuB;AAAA,QACzB,CAAC;AAED;AAAA,MACF;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,WAAW,OAAO;AAAA,QAClB,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,QACT,QAAQ,OAAO;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAUA,aAAa;AAAA,EACX;AAAA,EACA,aAAa,eAAe;AAAA,EAC5B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,KAAK,OAAO,IAAI,IAAI;AAG5B,YAAM,SAAS,IAAI,IAAI,GAAG;AAC1B,YAAM,WAAW,OAAO,SAAS,YAAY;AAE7C,UAAI,iBAAiB;AACrB,UAAI,SAAS,SAAS,QAAQ,GAAG;AAC/B,yBAAiB;AAAA,MACnB,WAAW,SAAS,SAAS,YAAY,GAAG;AAC1C,yBAAiB;AAAA,MACnB,WAAW,SAAS,SAAS,MAAM,GAAG;AACpC,yBAAiB;AAAA,MACnB;AAGA,YAAM,YAAY,MAAMA,IACrB,OAAO,iBAAiB,EACxB,OAAO;AAAA,QACN,QAAQ;AAAA,QACR,WAAW;AAAA,QACX,QAAQ;AAAA,MACV,CAAC,EACA,UAAU;AACb,YAAM,MAAM,UAAU,CAAC;AAEvB,UAAI,CAAC,KAAK;AACR,cAAM,IAAI,gBAAgB,6BAA6B;AAAA,MACzD;AAKA,kBAAY,KAAK;AAAA,QACf,OAAO,IAAI;AAAA,QACX,QAAQ,IAAI;AAAA,QACZ,QAAQ;AAAA,QACR;AAAA,QACA,SAAS;AAAA,MACX,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa,IAAI,SAAS,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACF,UAAMA,MAAK,MAAM;AAEjB,UAAM,OAAO,MAAMA,IAChB,OAAO,EACP,KAAK,iBAAiB,EACtB,QAAQ,kBAAkB,SAAS;AAEtC,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,aAAa,OAAO,KAAK,KAAK,SAAS;AACtD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,GAAG,IAAI,IAAI;AAEnB,UAAM,CAAC,GAAG,IAAI,MAAMA,IACjB,OAAO,EACP,KAAK,iBAAiB,EACtB,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC;AAErC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,gBAAY,KAAK,GAAG;AAAA,EACtB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,KAAK,mBAAmB,OAAO,KAAK,KAAK,SAAS;AAC7D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,GAAG,IAAI,IAAI;AAEnB,UAAM,CAAC,GAAG,IAAI,MAAMA,IACjB,OAAO,EACP,KAAK,iBAAiB,EACtB,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC;AAErC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,QAAI,IAAI,WAAW,UAAU;AAC3B,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAGA,UAAMA,IACH,OAAO,iBAAiB,EACxB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,cAAc;AAAA,IAChB,CAAC,EACA,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC;AAIrC,gBAAY,KAAK,EAAE,SAAS,uBAAuB,CAAC;AAAA,EACtD,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,OAAO,aAAa,OAAO,KAAK,KAAK,SAAS;AACzD,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,GAAG,IAAI,IAAI;AAEnB,UAAM,CAAC,GAAG,IAAI,MAAMA,IACjB,OAAO,EAAE,IAAI,kBAAkB,GAAG,CAAC,EACnC,KAAK,iBAAiB,EACtB,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC;AAErC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,UAAMA,IAAG,OAAO,iBAAiB,EAAE,MAAM,GAAG,kBAAkB,IAAI,EAAE,CAAC;AAErE,gBAAY,KAAK,EAAE,SAAS,qBAAqB,CAAC;AAAA,EACpD,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AClgBD,IAAAG,mBAAuB;AACvB,IAAAC,eAAkB;AAClB,IAAAC,iBAAmB;AAOZ,IAAM,oBAAgB,yBAAO;AAMpC,IAAM,oBAAoB,eAAE,OAAO;AAAA,EACjC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,EACxB,OAAO,eAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA,EACnC,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAClC,SAAS,eAAE,OAAO,EAAE,IAAI,EAAE,EAAE,IAAI,GAAI;AAAA,EACpC,gBAAgB,eAAE,OAAO,EAAE,SAAS;AAAA;AACtC,CAAC;AAED,IAAM,mBAAmB,eAAE,OAAO;AAAA,EAChC,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,EACxB,MAAM,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACnC,QAAQ,eAAE,KAAK,CAAC,UAAU,YAAY,SAAS,UAAU,OAAO,CAAC,EAAE,SAAS;AAC9E,CAAC;AAUD,cAAc;AAAA,EACZ;AAAA,EACA;AAAA,EACA,aAAa,iBAAiB;AAAA,EAC9B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,MAAM,OAAO,OAAO,SAAS,QAAQ,IAAI,IAAI;AAUrD,cAAQ,IAAI,4BAA4B;AAAA,QACtC;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,eAAe,QAAQ;AAAA,QACvB,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MACpC,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,UAAU;AAAA,MACZ,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,cAAc;AAAA,EACZ;AAAA,EACA;AAAA,EACA,aAAa,gBAAgB;AAAA,EAC7B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,EAAE,OAAO,MAAM,SAAS,SAAS,IAAI,IAAI;AAG/C,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,OAAO,MAAM,YAAY,CAAC,CAAC;AAE7D,UAAI,UAAU;AAEZ,YAAI,SAAS,WAAW,gBAAgB;AACtC,gBAAMA,IACH,OAAO,qBAAqB,EAC5B,IAAI;AAAA,YACH,QAAQ;AAAA,YACR,MAAM,QAAQ,SAAS;AAAA,YACvB,gBAAgB;AAAA,YAChB,WAAW,oBAAI,KAAK;AAAA,UACtB,CAAC,EACA,MAAM,GAAG,sBAAsB,IAAI,SAAS,EAAE,CAAC;AAElD,iBAAO,YAAY,KAAK;AAAA,YACtB,SAAS;AAAA,YACT,YAAY;AAAA,UACd,CAAC;AAAA,QACH;AAGA,eAAO,YAAY,KAAK;AAAA,UACtB,SAAS;AAAA,UACT,YAAY;AAAA,QACd,CAAC;AAAA,MACH;AAGA,YAAM,mBAAmB,eAAAC,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AAG9D,YAAMD,IAAG,OAAO,qBAAqB,EAAE,OAAO;AAAA,QAC5C,OAAO,MAAM,YAAY;AAAA,QACzB,MAAM,QAAQ;AAAA,QACd;AAAA,QACA;AAAA,QACA,QAAQ;AAAA,MACV,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,YAAY;AAAA,MACd,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,cAAc;AAAA,EACZ;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,IAAI,IAAI;AAEtB,YAAM,CAAC,UAAU,IAAI,MAAMA,IACxB,OAAO,EAAE,OAAO,sBAAsB,OAAO,QAAQ,sBAAsB,OAAO,CAAC,EACnF,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,kBAAkB,KAAK,CAAC;AAE1D,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,cAAc,0BAA0B;AAAA,MACpD;AAEA,kBAAY,KAAK;AAAA,QACf,OAAO,WAAW;AAAA,QAClB,QAAQ,WAAW;AAAA,MACrB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,cAAc;AAAA,EACZ;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,IAAI,IAAI;AAEtB,YAAM,CAAC,UAAU,IAAI,MAAMA,IACxB,OAAO,EACP,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,kBAAkB,KAAK,CAAC;AAE1D,UAAI,CAAC,YAAY;AACf,cAAM,IAAI,cAAc,0BAA0B;AAAA,MACpD;AAEA,UAAI,WAAW,WAAW,gBAAgB;AACxC,eAAO,YAAY,KAAK;AAAA,UACtB,SAAS;AAAA,UACT,cAAc;AAAA,QAChB,CAAC;AAAA,MACH;AAEA,YAAMA,IACH,OAAO,qBAAqB,EAC5B,IAAI;AAAA,QACH,QAAQ;AAAA,QACR,gBAAgB,oBAAI,KAAK;AAAA,QACzB,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,sBAAsB,IAAI,WAAW,EAAE,CAAC;AAEpD,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,cAAc;AAAA,MAChB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,cAAc;AAAA,EACZ;AAAA,EACA;AAAA,EACA;AAAA,IACE,eAAE,OAAO;AAAA,MACP,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,MAC/B,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,MACxB,OAAO,eAAE,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS;AAAA,MACnC,SAAS,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,MACtC,UAAU,eACP;AAAA,QACC,eAAE,OAAO;AAAA,UACP,WAAW,eAAE,OAAO,EAAE,KAAK;AAAA,UAC3B,UAAU,eAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC;AAAA,QAClC,CAAC;AAAA,MACH,EACC,IAAI,CAAC;AAAA,MACR,SAAS,eAAE,OAAO,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,IACzC,CAAC;AAAA,EACH;AAAA,EACA,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,MAAM,OAAO,OAAO,SAAS,UAAAE,WAAU,QAAQ,IAAI,IAAI;AAM/D,cAAQ,IAAI,kBAAkB;AAAA,QAC5B;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,cAAcA,UAAS;AAAA,QACvB,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MACpC,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,UAAU;AAAA,MACZ,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;ACzQA,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAClB,sBAAqB;AAOd,IAAM,mBAAe,yBAAO;AAGnC,IAAI,WAA4B;AAEhC,SAAS,cAAwB;AAC/B,MAAI,CAAC,UAAU;AACb,QACE,CAAC,OAAO,SAAS,aACjB,CAAC,OAAO,SAAS,cACjB,CAAC,OAAO,SAAS,aACjB;AACA,YAAM,IAAI,gBAAgB,4BAA4B;AAAA,IACxD;AAEA,eAAW,IAAI,gBAAAC,QAAS;AAAA,MACtB,WAAW,OAAO,SAAS;AAAA,MAC3B,YAAY,OAAO,SAAS;AAAA,MAC5B,aAAa,OAAO,SAAS;AAAA,IAC/B,CAAC;AAAA,EACH;AACA,SAAO;AACT;AAMA,IAAM,eAAe,eAAE,OAAO;AAAA,EAC5B,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA;AAAA,EACtB,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACnC,QAAQ,eAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,UAAU;AAClD,CAAC;AAED,IAAM,kBAAkB,eAAE,OAAO;AAAA,EAC/B,KAAK,eAAE,OAAO,EAAE,IAAI;AAAA,EACpB,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EACnC,QAAQ,eAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,UAAU;AAClD,CAAC;AAED,IAAM,eAAe,eAAE,OAAO;AAAA,EAC5B,QAAQ,eAAE,OAAO,EAAE,IAAI,CAAC;AAC1B,CAAC;AAMD,aAAa,IAAI,aAAa,YAAY;AAU1C,aAAa,IAAI,SAAS,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACF,UAAM,KAAK,YAAY;AACvB,UAAM,aAAa,GAAG,4BAA4B;AAElD,gBAAY,KAAK,UAAU;AAAA,EAC7B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa;AAAA,EACX;AAAA,EACA,aAAa,YAAY;AAAA,EACzB,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,KAAK,YAAY;AACvB,YAAM,EAAE,MAAM,UAAU,OAAO,IAAI,IAAI;AAEvC,YAAM,SAAS,MAAM,GAAG,OAAO;AAAA,QAC7B;AAAA,QACA;AAAA,QACA;AAAA,QACA,mBAAmB;AAAA,MACrB,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,QAAQ,OAAO;AAAA,QACf,MAAM,OAAO;AAAA,QACb,KAAK,OAAO;AAAA,QACZ,cAAc,OAAO;AAAA,QACrB,UAAU,OAAO;AAAA,QACjB,UAAU,OAAO;AAAA,QACjB,MAAM,OAAO;AAAA,QACb,OAAO,OAAO;AAAA,QACd,QAAQ,OAAO;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa;AAAA,EACX;AAAA,EACA,aAAa,eAAe;AAAA,EAC5B,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,KAAK,YAAY;AACvB,YAAM,EAAE,KAAK,UAAU,OAAO,IAAI,IAAI;AAEtC,YAAM,SAAS,MAAM,GAAG,OAAO;AAAA,QAC7B,MAAM;AAAA,QACN;AAAA,QACA;AAAA,QACA,mBAAmB;AAAA,MACrB,CAAC;AAED,kBAAY,KAAK;AAAA,QACf,QAAQ,OAAO;AAAA,QACf,MAAM,OAAO;AAAA,QACb,KAAK,OAAO;AAAA,QACZ,cAAc,OAAO;AAAA,QACrB,UAAU,OAAO;AAAA,QACjB,UAAU,OAAO;AAAA,QACjB,MAAM,OAAO;AAAA,QACb,OAAO,OAAO;AAAA,QACd,QAAQ,OAAO;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa,OAAO,YAAY,OAAO,KAAK,KAAK,SAAS;AACxD,MAAI;AACF,UAAM,KAAK,YAAY;AACvB,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,GAAG,WAAW,MAAM;AAE1B,gBAAY,KAAK,EAAE,SAAS,4BAA4B,CAAC;AAAA,EAC3D,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,SAAS,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACF,UAAM,KAAK,YAAY;AACvB,UAAM,EAAE,QAAQ,OAAO,KAAK,IAAI,IAAI;AAEpC,UAAM,QAAQ,MAAM,GAAG,UAAU;AAAA,MAC/B,MAAO,UAAqB;AAAA,MAC5B,OAAO,QAAQ,SAAS,KAAe,IAAI;AAAA,MAC3C,MAAM,OAAO,SAAS,IAAc,IAAI;AAAA,IAC1C,CAAC;AAED,gBAAY,KAAK,KAAK;AAAA,EACxB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,YAAY,OAAO,KAAK,KAAK,SAAS;AACrD,MAAI;AACF,UAAM,KAAK,YAAY;AACvB,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,OAAO,MAAM,GAAG,eAAe,MAAM;AAE3C,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa;AAAA,EACX;AAAA,EACA,aAAa,eAAE,OAAO,EAAE,SAAS,eAAE,MAAM,eAAE,OAAO,CAAC,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,CAAC,CAAC;AAAA,EACvE,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,KAAK,YAAY;AACvB,YAAM,EAAE,QAAQ,IAAI,IAAI;AAExB,YAAM,GAAG,gBAAgB,OAAO;AAEhC,kBAAY,KAAK;AAAA,QACf,SAAS,GAAG,QAAQ,MAAM;AAAA,QAC1B,cAAc,QAAQ;AAAA,MACxB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,aAAa,IAAI,2BAA2B,OAAO,KAAK,KAAK,SAAS;AACpE,MAAI;AACF,UAAM,KAAK,YAAY;AACvB,UAAM,EAAE,SAAS,IAAI,IAAI;AACzB,UAAM,EAAE,OAAO,QAAQ,SAAS,QAAQ,KAAK,IAAI,IAAI;AAErD,UAAM,kBAAoH,CAAC;AAE3H,QAAI,SAAS,UAAU,WAAW,UAAU,MAAM;AAChD,YAAM,YAAuC,CAAC;AAC9C,UAAI,OAAO;AAAC,kBAAU,QAAQ,SAAS,KAAe;AAAA,MAAE;AACxD,UAAI,QAAQ;AAAC,kBAAU,SAAS,SAAS,MAAgB;AAAA,MAAE;AAC3D,UAAI,SAAS;AAAC,kBAAU,UAAU,SAAS,OAAiB;AAAA,MAAE;AAC9D,UAAI,QAAQ;AAAC,kBAAU,SAAS;AAAA,MAAiB;AACjD,UAAI,MAAM;AAAC,kBAAU,WAAW;AAAA,MAAe;AAC/C,sBAAgB,KAAK,SAAS;AAAA,IAChC;AAEA,UAAM,MAAM,GAAG,IAAI;AAAA,MACjB,MAAM,IAAI,QAAQ;AAAA,MAClB,gBAAgB,gBAAgB,SAAS,IAAI,kBAAkB;AAAA,IACjE,CAAC;AAED,gBAAY,KAAK,EAAE,IAAI,CAAC;AAAA,EAC1B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACpQD,IAAAC,mBAAuB;;;ACkBvB,eAAsB,gBAAyC;AAC7D,QAAM,YAAY,KAAK,IAAI;AAE3B,MAAI;AACF,UAAMC,MAAK,MAAM;AAGjB,UAAM,gBAAgB,MAAMA,IAAG,QAAQ,qBAAqB;AAC5D,UAAM,OAAO,cAAc;AAC3B,UAAMC,WAAU,KAAK,CAAC,GAAG,WAAW;AAEpC,UAAM,UAAU,KAAK,IAAI,IAAI;AAG7B,UAAM,eAAe,MAAMD,IAAG,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,KAKrC;AAED,UAAM,YAAY,aAAa;AAC/B,UAAM,SAAS,UAAU,IAAI,OAAK,EAAE,UAAU;AAE9C,WAAO;AAAA,MACL,WAAW;AAAA,MACX;AAAA,MACA,SAAAC;AAAA,MACA;AAAA,IACF;AAAA,EACF,SAAS,OAAO;AACd,WAAO;AAAA,MACL,WAAW;AAAA,MACX,SAAS,KAAK,IAAI,IAAI;AAAA,MACtB,SAAS;AAAA,MACT,QAAQ,CAAC;AAAA,MACT,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAClD;AAAA,EACF;AACF;AAKA,eAAsB,eAInB;AACD,QAAM,iBAAiB;AAAA,IACrB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAEA,MAAI;AACF,UAAM,SAAS,MAAM,cAAc;AAEnC,QAAI,CAAC,OAAO,WAAW;AACrB,aAAO;AAAA,QACL,OAAO;AAAA,QACP,eAAe;AAAA,QACf,aAAa,CAAC;AAAA,MAChB;AAAA,IACF;AAEA,UAAM,iBAAiB,IAAI,IAAI,OAAO,MAAM;AAC5C,UAAM,gBAAgB,eAAe,OAAO,OAAK,CAAC,eAAe,IAAI,CAAC,CAAC;AACvE,UAAM,cAAc,OAAO,OAAO,OAAO,OAAK,CAAC,eAAe,SAAS,CAAC,CAAC;AAEzE,WAAO;AAAA,MACL,OAAO,cAAc,WAAW;AAAA,MAChC;AAAA,MACA;AAAA,IACF;AAAA,EACF,SAAS,OAAO;AACd,WAAO;AAAA,MACL,OAAO;AAAA,MACP,eAAe;AAAA,MACf,aAAa,CAAC;AAAA,IAChB;AAAA,EACF;AACF;AAKA,eAAsB,iBAAmC;AACvD,MAAI;AACF,UAAMD,MAAK,MAAM;AACjB,UAAMA,IAAG,QAAQ,aAAa;AAC9B,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;;;AD1HO,IAAM,mBAAe,yBAAO;AAMnC,aAAa,IAAI,KAAK,OAAO,MAAM,QAAQ;AACzC,QAAM,cAAc,MAAM,eAAe;AAEzC,MAAI,KAAK;AAAA,IACP,QAAQ,cAAc,OAAO;AAAA,IAC7B,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,IAClC,QAAQ,QAAQ,OAAO;AAAA,IACvB,UAAU,cAAc,cAAc;AAAA,EACxC,CAAC;AACH,CAAC;AAMD,aAAa,IAAI,aAAa,aAAa,cAAc,OAAO,MAAM,KAAK,SAAS;AAClF,MAAI;AACF,UAAM,WAAW,MAAM,cAAc;AACrC,UAAM,eAAe,MAAM,aAAa;AAExC,gBAAY,KAAK;AAAA,MACf,QAAQ,SAAS,aAAa,aAAa,QAAQ,YAAY;AAAA,MAC/D,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MAClC,QAAQ,QAAQ,OAAO;AAAA,MACvB,QAAQ;AAAA,QACN,UAAU,KAAK,MAAM,QAAQ,YAAY,EAAE,WAAW,OAAO,IAAI;AAAA,QACjE,WAAW,KAAK,MAAM,QAAQ,YAAY,EAAE,YAAY,OAAO,IAAI;AAAA,QACnE,KAAK,KAAK,MAAM,QAAQ,YAAY,EAAE,MAAM,OAAO,IAAI;AAAA,MACzD;AAAA,MACA,UAAU;AAAA,QACR,WAAW,SAAS;AAAA,QACpB,SAAS,SAAS;AAAA,QAClB,SAAS,SAAS;AAAA,QAClB,OAAO,SAAS;AAAA,MAClB;AAAA,MACA,QAAQ;AAAA,QACN,OAAO,aAAa;AAAA,QACpB,aAAa,SAAS,OAAO;AAAA,QAC7B,eAAe,aAAa;AAAA,MAC9B;AAAA,MACA,aAAa,QAAQ,IAAI,UAAU,KAAK;AAAA,IAC1C,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,aAAa,IAAI,UAAU,OAAO,MAAM,QAAQ;AAC9C,QAAM,cAAc,MAAM,eAAe;AAEzC,MAAI,aAAa;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,KAAK,CAAC;AAAA,EACtC,OAAO;AACL,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,QAAQ,yBAAyB,CAAC;AAAA,EACzE;AACF,CAAC;AAMD,aAAa,IAAI,SAAS,CAAC,MAAM,QAAQ;AACvC,MAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,KAAK,CAAC;AACtC,CAAC;;;AE9ED,IAAAE,mBAAuB;AACvB,IAAAC,eAAkB;AAOlB,IAAM,aAAS,yBAAO;AAGtB,IAAM,uBAAuB,eAAE,OAAO;AAAA,EACpC,SAAS,eAAE,QAAQ,EAAE,SAAS;AAAA,EAC9B,aAAa,eAAE,MAAM,eAAE,OAAO,EAAE,MAAM,CAAC,EAAE,SAAS;AAAA,EAClD,eAAe,eAAE,OAAO;AAAA,IACtB,WAAW,eAAE,QAAQ,EAAE,SAAS;AAAA,IAChC,qBAAqB,eAAE,QAAQ,EAAE,SAAS;AAAA,IAC1C,iBAAiB,eAAE,QAAQ,EAAE,SAAS;AAAA,IACtC,cAAc,eAAE,QAAQ,EAAE,SAAS;AAAA,IACnC,qBAAqB,eAAE,QAAQ,EAAE,SAAS;AAAA,IAC1C,mBAAmB,eAAE,QAAQ,EAAE,SAAS;AAAA,IACxC,kBAAkB,eAAE,QAAQ,EAAE,SAAS;AAAA,IACvC,kBAAkB,eAAE,QAAQ,EAAE,SAAS;AAAA,EACzC,CAAC,EAAE,SAAS;AACd,CAAC;AAGD,IAAM,yBAAyB,eAAE,OAAO;AAAA,EACtC,MAAM,eAAE,KAAK;AAAA,IACX;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,CAAC;AAAA,EACD,OAAO,eAAE,OAAO,EAAE,MAAM,EAAE,SAAS;AACrC,CAAC;AAOD,OAAO,IAAI,aAAa,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC3E,MAAI;AACF,UAAMC,YAAW,oBAAoB,YAAY;AACjD,UAAM,iBAAiB,cAAc,QAAQ;AAE7C,gBAAY,KAAK;AAAA,MACf,GAAGA;AAAA,MACH;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAOD,OAAO;AAAA,EACL;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,UAAU,IAAI;AACpB,0BAAoB,eAAe,OAAO;AAE1C,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,UAAU,oBAAoB,YAAY;AAAA,MAC5C,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAOA,OAAO;AAAA,EACL;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,sBAAsB;AAAA,EACnC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAM,EAAE,MAAM,MAAM,IAAI,IAAI;AAE5B,UAAI,CAAC,cAAc,QAAQ,GAAG;AAC5B,eAAO,UAAU,KAAK,KAAK,uBAAuB,4DAA4D;AAAA,MAChH;AAGA,YAAM,WAAsE;AAAA,QAC1E,WAAW;AAAA,UACT,SAAS;AAAA,UACT,cAAc;AAAA,UACd,eAAe;AAAA,UACf,OAAO;AAAA,UACP,WAAW;AAAA,QACb;AAAA,QACA,qBAAqB;AAAA,UACnB,SAAS;AAAA,UACT,gBAAgB;AAAA,UAChB,WAAW;AAAA,QACb;AAAA,QACA,iBAAiB;AAAA,UACf,WAAW;AAAA,UACX,aAAa;AAAA,UACb,KAAK;AAAA,UACL,cAAc;AAAA,UACd,WAAW;AAAA,QACb;AAAA,QACA,cAAc;AAAA,UACZ,YAAY;AAAA,UACZ,cAAc;AAAA,UACd,eAAe;AAAA,QACjB;AAAA,QACA,qBAAqB;AAAA,UACnB,MAAM;AAAA,UACN,OAAO;AAAA,UACP,SAAS;AAAA,UACT,SAAS;AAAA,QACX;AAAA,QACA,mBAAmB;AAAA,UACjB,aAAa;AAAA,UACb,cAAc;AAAA,UACd,eAAe;AAAA,UACf,WAAW;AAAA,QACb;AAAA,QACA,kBAAkB;AAAA,UAChB,SAAS;AAAA,UACT,QAAQ;AAAA,UACR,eAAe;AAAA,UACf,eAAe;AAAA,QACjB;AAAA,QACA,kBAAkB;AAAA,UAChB,SAAS;AAAA,UACT,QAAQ;AAAA,UACR,QAAQ;AAAA,QACV;AAAA,MACF;AAGA,YAAM,mBAAmB,oBAAoB,YAAY;AACzD,UAAI,OAAO;AACT,4BAAoB,eAAe,EAAE,aAAa,CAAC,KAAK,EAAE,CAAC;AAAA,MAC7D;AAEA,YAAM,UAAU,MAAM,oBAAoB,OAAO,MAA0B,SAAS,IAAwB,CAAC;AAG7G,UAAI,OAAO;AACT,4BAAoB,eAAe,EAAE,aAAa,iBAAiB,YAAY,CAAC;AAAA,MAClF;AAEA,UAAI,SAAS;AACX,oBAAY,KAAK;AAAA,UACf,SAAS,QAAQ,IAAI;AAAA,UACrB,QAAQ,SAAS,iBAAiB;AAAA,QACpC,CAAC;AAAA,MACH,OAAO;AACL,kBAAU,KAAK,KAAK,uBAAuB,kCAAkC;AAAA,MAC/E;AAAA,IACF,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAOA,OAAO,KAAK,gBAAgB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/E,MAAI;AACF,UAAM,cAAc,MAAM,cAAc,iBAAiB;AAEzD,QAAI,aAAa;AACf,kBAAY,KAAK;AAAA,QACf,SAAS;AAAA,QACT,WAAW;AAAA,MACb,CAAC;AAAA,IACH,OAAO;AACL,gBAAU,KAAK,KAAK,0BAA0B,qDAAqD;AAAA,IACrG;AAAA,EACF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAED,IAAO,+BAAQ;;;AC3Mf,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAMX,IAAM,mBAAe,yBAAO;AAMnC,IAAM,oBAAoB,eAAE,OAAO;AAAA,EAC/B,GAAG,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC5B,OAAO,eAAE,OAAO,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAClD,QAAQ,eAAE,OAAO,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,UAAU,eAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,UAAU,eAAE,OAAO,OAAO,EAAE,SAAS;AAAA,EACrC,UAAU,eAAE,OAAO,OAAO,EAAE,SAAS;AAAA,EACrC,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,MAAM,eAAE,KAAK,CAAC,YAAY,aAAa,iBAAiB,kBAAkB,gBAAgB,CAAC,EAAE,SAAS;AAAA,EACtG,QAAQ,eAAE,OAAO,EAAE,SAAS;AAAA;AAChC,CAAC;AAED,IAAM,qBAAqB,eAAE,OAAO;AAAA,EAChC,GAAG,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC5B,OAAO,eAAE,OAAO,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,EAAE,EAAE,SAAS;AACrD,CAAC;AAUD,aAAa,IAAI,KAAK,cAAc,iBAAiB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC9E,MAAI;AACA,UAAM,EAAE,GAAG,QAAQ,IAAI,SAAS,GAAG,UAAU,UAAU,UAAU,SAAS,OAAO,MAAM,OAAO,IAAI,IAAI;AAGtG,UAAM,cAAc,MAAM,cAAc,YAAY;AACpD,QAAI,CAAC,aAAa;AACd,aAAO,YAAY,KAAK;AAAA,QACpB,MAAM,CAAC;AAAA,QACP,OAAO;AAAA,QACP,kBAAkB;AAAA,QAClB,oBAAoB;AAAA,QACpB,OAAO,OAAO,KAAK;AAAA,QACnB,QAAQ,OAAO,MAAM;AAAA,QACrB,OAAO;AAAA,MACX,CAAC;AAAA,IACL;AAGA,UAAM,UAAoB,CAAC;AAE3B,QAAI,UAAU;AACV,cAAQ,KAAK,mBAAmB,QAAQ,GAAG;AAAA,IAC/C;AAEA,QAAI,aAAa,QAAW;AACxB,cAAQ,KAAK,gBAAgB,QAAQ,EAAE;AAAA,IAC3C;AAEA,QAAI,aAAa,QAAW;AACxB,cAAQ,KAAK,gBAAgB,QAAQ,EAAE;AAAA,IAC3C;AAEA,QAAI,YAAY,QAAQ;AACpB,cAAQ,KAAK,gBAAgB;AAAA,IACjC;AAEA,QAAI,OAAO;AACP,cAAQ,KAAK,YAAY,KAAK,GAAG;AAAA,IACrC;AAGA,UAAM,YAAsB,CAAC;AAC7B,QAAI,MAAM;AACN,gBAAU,KAAK,IAAc;AAAA,IACjC;AAGA,UAAM,cAAc,SAAU,OAAkB,MAAM,GAAG,IAAI,CAAC,gBAAgB,SAAS,SAAS;AAGhG,UAAM,SAAS,MAAM,cAAc,eAAe,GAAa;AAAA,MAC3D,OAAO,OAAO,KAAK;AAAA,MACnB,QAAQ,OAAO,MAAM;AAAA,MACrB;AAAA,MACA,MAAM;AAAA,MACN,QAAQ;AAAA,IACZ,CAAC;AAED,gBAAY,KAAK,MAAM;AAAA,EAC3B,SAAS,OAAO;AACZ,SAAK,KAAK;AAAA,EACd;AACJ,CAAC;AAMD,aAAa,IAAI,iBAAiB,cAAc,kBAAkB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC3F,MAAI;AACA,UAAM,EAAE,GAAG,QAAQ,EAAE,IAAI,IAAI;AAG7B,UAAM,cAAc,MAAM,cAAc,YAAY;AACpD,QAAI,CAAC,aAAa;AACd,aAAO,YAAY,KAAK,EAAE,aAAa,CAAC,EAAE,CAAC;AAAA,IAC/C;AAEA,UAAM,SAAS,MAAM,cAAc,eAAe,GAAa;AAAA,MAC3D,OAAO,OAAO,KAAK;AAAA,MACnB,QAAQ;AAAA,IACZ,CAAC;AAGD,UAAM,cAAc,OAAO,KAAK,IAAI,UAAQ;AAAA,MACxC,IAAI,IAAI;AAAA,MACR,MAAM,IAAI;AAAA,MACV,MAAM,IAAI;AAAA,MACV,cAAc,IAAI;AAAA,MAClB,WAAW,IAAI;AAAA,MACf,cAAc,IAAI;AAAA,IACtB,EAAE;AAEF,gBAAY,KAAK,EAAE,aAAa,OAAO,EAAE,CAAC;AAAA,EAC9C,SAAS,OAAO;AACZ,SAAK,KAAK;AAAA,EACd;AACJ,CAAC;AAMD,aAAa,IAAI,WAAW,OAAO,KAAK,KAAK,SAAS;AAClD,MAAI;AACA,UAAM,cAAc,MAAM,cAAc,YAAY;AACpD,UAAM,QAAQ,cAAc,MAAM,cAAc,cAAc,IAAI;AAElE,gBAAY,KAAK;AAAA,MACb,WAAW;AAAA,MACX;AAAA,IACJ,CAAC;AAAA,EACL,SAAS,OAAO;AACZ,SAAK,KAAK;AAAA,EACd;AACJ,CAAC;AAUD,aAAa,KAAK,SAAS,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC5E,MAAI;AAEA,UAAM,cAAc,WAAW;AAG/B,UAAM,SAAS,MAAM,cAAc,gBAAgB;AAEnD,gBAAY,KAAK;AAAA,MACb,SAAS;AAAA,MACT,GAAG;AAAA,IACP,CAAC;AAAA,EACL,SAAS,OAAO;AACZ,SAAK,KAAK;AAAA,EACd;AACJ,CAAC;AAMD,aAAa,KAAK,eAAe,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAClF,MAAI;AACA,UAAM,cAAc,WAAW;AAE/B,gBAAY,KAAK;AAAA,MACb,SAAS;AAAA,IACb,CAAC;AAAA,EACL,SAAS,OAAO;AACZ,SAAK,KAAK;AAAA,EACd;AACJ,CAAC;;;ACpMD,IAAAC,mBAAwD;AACxD,IAAAC,eAAkB;AAClB,wBAAuB;AACvB,IAAAC,mBAAqB;AAOd,IAAM,yBAAqB,yBAAO;AAMzC,IAAIC,YAA4B;AAEhC,SAASC,eAAwB;AAC/B,MAAI,CAACD,WAAU;AACb,QACE,CAAC,OAAO,SAAS,aACjB,CAAC,OAAO,SAAS,cACjB,CAAC,OAAO,SAAS,aACjB;AACA,YAAM,IAAI,gBAAgB,4BAA4B;AAAA,IACxD;AAEA,IAAAA,YAAW,IAAI,iBAAAE,QAAS;AAAA,MACtB,WAAW,OAAO,SAAS;AAAA,MAC3B,YAAY,OAAO,SAAS;AAAA,MAC5B,aAAa,OAAO,SAAS;AAAA,IAC/B,CAAC;AAAA,EACH;AACA,SAAOF;AACT;AAMA,IAAMG,qBAAoB,eAAE,OAAO;AAAA,EACjC,OAAO,eAAE,OAAO,EAAE,IAAI,GAAG,0BAA0B,EAAE,IAAI,KAAK,gBAAgB;AAAA,EAC9E,OAAO,eAAE,OAAO,EAAE,SAAS,EAAE,UAAU,SAAO,KAAK,IAAI,SAAS,OAAO,MAAM,EAAE,GAAG,EAAE,CAAC;AAAA,EACrF,OAAO,eAAE,OAAO,EAAE,SAAS,EAAE,UAAU,SAAO,KAAK,IAAI,SAAS,OAAO,KAAK,EAAE,GAAG,CAAC,CAAC;AAAA,EACnF,YAAY,eAAE,KAAK,CAAC,OAAO,UAAU,MAAM,CAAC,EAAE,SAAS,EAAE,QAAQ,QAAQ;AAAA,EACzE,WAAW,eAAE,KAAK,CAAC,QAAQ,QAAQ,SAAS,UAAU,SAAS,UAAU,SAAS,CAAC,EAAE,SAAS;AAAA,EAC9F,WAAW,eAAE,KAAK,CAAC,WAAW,QAAQ,WAAW,SAAS,SAAS,UAAU,CAAC,EAAE,SAAS;AAAA,EACzF,UAAU,eAAE,KAAK,CAAC,OAAO,OAAO,OAAO,OAAO,OAAO,QAAQ,KAAK,CAAC,EAAE,SAAS;AAChF,CAAC;AAED,IAAM,iBAAiB,eAAE,OAAO;AAAA,EAC9B,UAAU,eAAE,OAAO,EAAE,IAAI,mBAAmB,EAAE,SAAS;AAAA,EACvD,WAAW,eAAE,MAAM,eAAE,OAAO,EAAE,IAAI,mBAAmB,CAAC,EAAE,IAAI,IAAI,6BAA6B,EAAE,SAAS;AAAA,EACxG,QAAQ,eAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,WAAW;AACnD,CAAC;AAQD,IAAM,YAAY,IAAI,KAAK;AAC3B,IAAM,cAAc,oBAAI,IAAwB;AAGhD,IAAI,eAAoB;AAExB,SAAS,wBAAwB;AAC/B,MAAI,CAAC,cAAc;AACjB,mBAAe,yBAAO,aAAa,IAAI;AAAA,EACzC;AACA,SAAO;AACT;AAGA,SAAS,iBAAiB,SAAsB;AAC9C,SAAO,KAAK,UAAU;AAAA,IACpB,GAAG,QAAQ;AAAA,IACX,OAAO,QAAQ,SAAS;AAAA,IACxB,KAAK,QAAQ,SAAS;AAAA,IACtB,MAAM,QAAQ,cAAc;AAAA,IAC5B,SAAS,QAAQ;AAAA,IACjB,SAAS,QAAQ;AAAA,IACjB,UAAU,QAAQ;AAAA,EACpB,CAAC;AACH;AAUA,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,cAAcA,kBAAiB;AAAA,EAC/B,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,EAAE,OAAO,OAAO,OAAO,YAAY,WAAW,WAAW,SAAS,IAAI,IAAI;AAGhF,UAAI,CAAC,OAAO,OAAO,UAAU,CAAC,OAAO,OAAO,gBAAgB;AAC1D,cAAM,IAAI,gBAAgB,4GAA4G;AAAA,MACxI;AAGA,YAAM,WAAW,iBAAiB,EAAE,OAAO,OAAO,OAAO,YAAY,WAAW,WAAW,SAAS,CAAC;AAGrG,YAAM,SAAS,YAAY,IAAI,QAAQ;AACvC,UAAI,UAAU,KAAK,IAAI,IAAI,OAAO,YAAY,WAAW;AACvD,eAAO,YAAY,KAAK,OAAO,IAAI;AAAA,MACrC;AAGA,YAAM,SAAS,sBAAsB;AAGrC,YAAM,eAAoB;AAAA,QACxB,MAAM,OAAO,OAAO;AAAA,QACpB,IAAI,OAAO,OAAO;AAAA,QAClB,GAAG;AAAA,QACH,YAAY;AAAA,QACZ,KAAK,SAAS;AAAA,QACd,OAAO,SAAS;AAAA,QAChB,MAAM,cAAc;AAAA,MACtB;AAEA,UAAI,WAAW;AAAC,qBAAa,UAAU;AAAA,MAAU;AACjD,UAAI,WAAW;AAAC,qBAAa,UAAU;AAAA,MAAU;AACjD,UAAI,UAAU;AAAC,qBAAa,WAAW;AAAA,MAAS;AAGhD,YAAM,WAAW,MAAM,OAAO,IAAI,KAAK,YAAY;AAEnD,UAAI,CAAC,YAAY,CAAC,SAAS,MAAM;AAC/B,cAAM,IAAI,gBAAgB,kCAAkC;AAAA,MAC9D;AAEA,YAAM,SAAS;AAAA,QACb;AAAA,QACA,UAAU,SAAS,KAAK,SAAS,CAAC,GAAG,IAAI,CAAC,UAAe;AAAA,UACvD,OAAO,KAAK;AAAA,UACZ,MAAM,KAAK;AAAA,UACX,WAAW,KAAK,OAAO;AAAA,UACvB,aAAa,KAAK;AAAA,UAClB,SAAS,KAAK;AAAA,UACd,MAAM,KAAK;AAAA,UACX,OAAO;AAAA,YACL,aAAa,KAAK,OAAO;AAAA,YACzB,QAAQ,KAAK,OAAO;AAAA,YACpB,OAAO,KAAK,OAAO;AAAA,YACnB,UAAU,KAAK,OAAO;AAAA,YACtB,eAAe,KAAK,OAAO;AAAA,YAC3B,iBAAiB,KAAK,OAAO;AAAA,YAC7B,gBAAgB,KAAK,OAAO;AAAA,UAC9B;AAAA,QACF,EAAE;AAAA,QACF,cAAc,SAAS,KAAK,mBAAmB,gBAAgB;AAAA,QAC/D,YAAY,SAAS,KAAK,mBAAmB,cAAc;AAAA,QAC3D,YAAY;AAAA,UACV,OAAO,SAAS;AAAA,UAChB,OAAO,SAAS;AAAA,UAChB,aAAa,CAAC,CAAC,SAAS,KAAK,SAAS;AAAA,UACtC,WAAW,SAAS,KAAK,SAAS,WAAW,CAAC,GAAG;AAAA,QACnD;AAAA,MACF;AAGA,kBAAY,IAAI,UAAU,EAAE,MAAM,QAAQ,WAAW,KAAK,IAAI,EAAE,CAAC;AAGjE,UAAI,YAAY,OAAO,KAAK;AAC1B,cAAM,UAAU,MAAM,KAAK,YAAY,QAAQ,CAAC,EAC7C,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,YAAY,EAAE,CAAC,EAAE,SAAS;AACjD,cAAM,cAAc,QAAQ,CAAC;AAC7B,YAAI,aAAa;AACf,sBAAY,OAAO,YAAY,CAAC,CAAC;AAAA,QACnC;AAAA,MACF;AAEA,kBAAY,KAAK,MAAM;AAAA,IACzB,SAAS,OAAY;AAEnB,UAAI,MAAM,SAAS,KAAK;AACtB,eAAO,KAAK,IAAI,gBAAgB,sDAAsD,CAAC;AAAA,MACzF;AACA,UAAI,MAAM,SAAS,KAAK;AACtB,eAAO,KAAK,IAAI,gBAAgB,sEAAsE,CAAC;AAAA,MACzG;AACA,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAOA,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,cAAc;AAAA,EAC3B,OAAO,KAAc,KAAe,SAAuB;AACzD,QAAI;AACF,YAAM,EAAE,UAAU,WAAW,OAAO,IAAI,IAAI;AAG5C,YAAM,OAAiB,cAAc,WAAW,CAAC,QAAQ,IAAI,CAAC;AAE9D,UAAI,KAAK,WAAW,GAAG;AACrB,cAAM,IAAI,gBAAgB,oCAAoC;AAAA,MAChE;AAEA,YAAM,KAAKF,aAAY;AAEvB,YAAM,UAAU,MAAM,QAAQ;AAAA,QAC5B,KAAK,IAAI,OAAO,KAAaG,WAAkB;AAC7C,cAAI;AAEF,kBAAMC,aAAY,KAAK,IAAI;AAC3B,kBAAM,SAAS,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,GAAG,CAAC;AACxD,kBAAM,UAAU,IAAI,IAAI,GAAG,EAAE;AAC7B,kBAAM,YAAY,QAAQ,MAAM,GAAG,EAAE,IAAI,GAAG,YAAY,KAAK;AAC7D,kBAAM,WAAW,gBAAgBA,UAAS,IAAID,MAAK,IAAI,MAAM,IAAI,SAAS;AAG1E,kBAAM,eAAe,MAAM,GAAG,OAAO;AAAA,cACnC,MAAM;AAAA;AAAA,cACN;AAAA,cACA,QAAQ,UAAU;AAAA,cAClB,mBAAmB;AAAA,cACnB,MAAM,CAAC,iBAAiB,eAAe;AAAA,YACzC,CAAC;AAED,mBAAO;AAAA,cACL,SAAS;AAAA,cACT,aAAa;AAAA,cACb,aAAa,aAAa;AAAA,cAC1B,gBAAgB,aAAa;AAAA,cAC7B,cAAc,aAAa;AAAA,cAC3B,UAAU;AAAA,gBACR,OAAO,aAAa;AAAA,gBACpB,QAAQ,aAAa;AAAA,gBACrB,MAAM,aAAa;AAAA,gBACnB,UAAU,aAAa;AAAA,gBACvB,UAAU,aAAa;AAAA,cACzB;AAAA,YACF;AAAA,UACF,SAAS,OAAY;AACnB,oBAAQ,MAAM,2BAA2B,GAAG,IAAI,MAAM,OAAO;AAC7D,mBAAO;AAAA,cACL,SAAS;AAAA,cACT,aAAa;AAAA,cACb,OAAO,MAAM,WAAW;AAAA,YAC1B;AAAA,UACF;AAAA,QACF,CAAC;AAAA,MACH;AAEA,YAAM,eAAe,QAAQ,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE;AACtD,YAAM,eAAe,QAAQ,SAAS;AAGtC,YAAM,eAAe,QAClB,OAAO,CAAC,MAAM,EAAE,OAAO,EACvB,IAAI,CAAC,MAAM,EAAE,WAAW;AAE3B,kBAAY,KAAK;AAAA,QACf;AAAA,QACA;AAAA;AAAA,QACA,SAAS;AAAA,UACP,OAAO,QAAQ;AAAA,UACf,SAAS;AAAA,UACT,QAAQ;AAAA,QACV;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,MAAe,QAAkB;AACtC,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,UAAU,MAAM,KAAK,YAAY,QAAQ,CAAC,EAAE,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM;AACtE,YAAM,SAAS,KAAK,MAAM,GAAG;AAC7B,aAAO;AAAA,QACL,OAAO,OAAO;AAAA,QACd,KAAK,KAAK,OAAO,MAAM,MAAM,aAAa,GAAI;AAAA,MAChD;AAAA,IACF,CAAC;AAED,gBAAY,KAAK;AAAA,MACf,MAAM,YAAY;AAAA,MAClB,KAAK,KAAK,MAAM,YAAY,GAAI;AAAA,MAChC;AAAA,IACF,CAAC;AAAA,EACH;AACF;AAMA,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO,MAAe,QAAkB;AACtC,UAAM,OAAO,YAAY;AACzB,gBAAY,MAAM;AAClB,gBAAY,KAAK,EAAE,SAAS,KAAK,CAAC;AAAA,EACpC;AACF;;;AC1UA,IAAAE,mBAAuB;AACvB,IAAAC,eAAkB;AAOX,IAAM,yBAAqB,yBAAO;AAMzC,IAAMC,wBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,WAAW,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC/C,SAAS,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACjD,cAAc,eAAE,OAAO,EAAE,MAAM,mBAAmB,EAAE,SAAS,EAAE,QAAQ,SAAS;AAAA,EAChF,aAAa,eAAE,OAAO,EAAE,MAAM,mBAAmB,EAAE,SAAS,EAAE,QAAQ,SAAS;AAAA,EAC/E,iBAAiB,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EACpD,oBAAoB,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EACxD,yBAAyB,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,KAAK;AAAA,EAC7D,SAAS,eAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EAC5C,YAAY,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACpD,YAAY,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACpD,iBAAiB,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAC3D,CAAC;AAED,IAAMC,wBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,WAAW,eAAE,QAAQ,EAAE,SAAS;AAAA,EAChC,SAAS,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACjD,cAAc,eAAE,OAAO,EAAE,MAAM,mBAAmB,EAAE,SAAS;AAAA,EAC7D,aAAa,eAAE,OAAO,EAAE,MAAM,mBAAmB,EAAE,SAAS;AAAA,EAC5D,iBAAiB,eAAE,QAAQ,EAAE,SAAS;AAAA,EACtC,oBAAoB,eAAE,QAAQ,EAAE,SAAS;AAAA,EACzC,yBAAyB,eAAE,QAAQ,EAAE,SAAS;AAAA,EAC9C,SAAS,eAAE,QAAQ,EAAE,SAAS;AAAA,EAC9B,YAAY,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACpD,YAAY,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAAA,EACpD,iBAAiB,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS;AAC3D,CAAC;AAUD,mBAAmB,IAAI,KAAK,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/E,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AAEzF,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,YAAY;AACpB,UAAMC,SAAQ,YAAY,CAAC,GAAG,SAAS;AAEvC,UAAM,YAAY,MAAMD,IACrB,OAAO,EACP,KAAK,YAAY,EACjB,QAAQ,KAAK,aAAa,SAAS,GAAG,KAAK,aAAa,SAAS,CAAC,EAClE,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,gBAAY,KAAK,WAAW,KAAK,qBAAqB,MAAM,OAAO,OAAOC,MAAK,CAAC,CAAC;AAAA,EACnF,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,mBAAmB,IAAI,YAAY,aAAa,cAAc,OAAO,MAAM,KAAK,SAAS;AACvF,MAAI;AACF,UAAMD,MAAK,MAAM;AAEjB,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,WAAW,IAAI,CAAC,EACtC,MAAM,CAAC;AAEV,QAAI,CAAC,UAAU;AAEb,aAAO,YAAY,KAAK;AAAA,QACtB,IAAI;AAAA,QACJ,MAAM;AAAA,QACN,WAAW;AAAA,QACX,cAAc;AAAA,QACd,aAAa;AAAA,QACb,iBAAiB;AAAA,QACjB,oBAAoB;AAAA,QACpB,yBAAyB;AAAA,QACzB,SAAS;AAAA,QACT,YAAY;AAAA,QACZ,YAAY;AAAA,QACZ,iBAAiB;AAAA,MACnB,CAAC;AAAA,IACH;AAEA,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,mBAAmB,IAAI,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAClF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC;AAEhC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,wBAAwB;AAAA,IAClD;AAEA,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAaF,qBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAME,MAAK,MAAM;AACjB,YAAM,OAAO,IAAI;AAGjB,UAAI,KAAK,WAAW;AAClB,cAAMA,IACH,OAAO,YAAY,EACnB,IAAI,EAAE,WAAW,OAAO,WAAW,oBAAI,KAAK,EAAE,CAAC,EAC/C,MAAM,GAAG,aAAa,WAAW,IAAI,CAAC;AAAA,MAC3C;AAEA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,YAAY,EACnB,OAAO;AAAA,QACN,MAAM,KAAK;AAAA,QACX,WAAW,KAAK,aAAa;AAAA,QAC7B,SAAS,KAAK;AAAA,QACd,cAAc,KAAK,gBAAgB;AAAA,QACnC,aAAa,KAAK,eAAe;AAAA,QACjC,iBAAiB,KAAK,mBAAmB;AAAA,QACzC,oBAAoB,KAAK,sBAAsB;AAAA,QAC/C,yBAAyB,KAAK,2BAA2B;AAAA,QACzD,SAAS,KAAK,WAAW;AAAA,QACzB,YAAY,KAAK;AAAA,QACjB,YAAY,KAAK;AAAA,QACjB,iBAAiB,KAAK;AAAA,MACxB,CAAC,EACA,UAAU;AAEb,kBAAY,KAAK,UAAU,GAAG;AAAA,IAChC,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,mBAAmB;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAaD,qBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,OAAO,IAAI;AAGjB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,aAAa,GAAG,CAAC,EAC9B,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC;AAEhC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,wBAAwB;AAAA,MAClD;AAGA,UAAI,KAAK,WAAW,GAAG;AACrB,cAAMA,IACH,OAAO,YAAY,EACnB,IAAI,EAAE,WAAW,OAAO,WAAW,oBAAI,KAAK,EAAE,CAAC,EAC/C,MAAM,GAAG,aAAa,WAAW,IAAI,CAAC;AAAA,MAC3C;AAEA,YAAM,aAAsC;AAAA,QAC1C,WAAW,oBAAI,KAAK;AAAA,MACtB;AAEA,UAAI,KAAK,MAAM,MAAM,QAAW;AAAC,mBAAW,MAAM,IAAI,KAAK,MAAM;AAAA,MAAE;AACnE,UAAI,KAAK,WAAW,MAAM,QAAW;AAAC,mBAAW,WAAW,IAAI,KAAK,WAAW;AAAA,MAAE;AAClF,UAAI,KAAK,SAAS,MAAM,QAAW;AAAC,mBAAW,SAAS,IAAI,KAAK,SAAS;AAAA,MAAE;AAC5E,UAAI,KAAK,cAAc,MAAM,QAAW;AAAC,mBAAW,cAAc,IAAI,KAAK,cAAc;AAAA,MAAE;AAC3F,UAAI,KAAK,aAAa,MAAM,QAAW;AAAC,mBAAW,aAAa,IAAI,KAAK,aAAa;AAAA,MAAE;AACxF,UAAI,KAAK,iBAAiB,MAAM,QAAW;AAAC,mBAAW,iBAAiB,IAAI,KAAK,iBAAiB;AAAA,MAAE;AACpG,UAAI,KAAK,oBAAoB,MAAM,QAAW;AAAC,mBAAW,oBAAoB,IAAI,KAAK,oBAAoB;AAAA,MAAE;AAC7G,UAAI,KAAK,yBAAyB,MAAM,QAAW;AAAC,mBAAW,yBAAyB,IAAI,KAAK,yBAAyB;AAAA,MAAE;AAC5H,UAAI,KAAK,SAAS,MAAM,QAAW;AAAC,mBAAW,SAAS,IAAI,KAAK,SAAS;AAAA,MAAE;AAC5E,UAAI,KAAK,YAAY,MAAM,QAAW;AAAC,mBAAW,YAAY,IAAI,KAAK,YAAY;AAAA,MAAE;AACrF,UAAI,KAAK,YAAY,MAAM,QAAW;AAAC,mBAAW,YAAY,IAAI,KAAK,YAAY;AAAA,MAAE;AACrF,UAAI,KAAK,iBAAiB,MAAM,QAAW;AAAC,mBAAW,iBAAiB,IAAI,KAAK,iBAAiB;AAAA,MAAE;AAEpG,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,YAAY,EACnB,IAAI,UAAU,EACd,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC,EAC7B,UAAU;AAEb,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,mBAAmB,OAAO,QAAQ,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AACrF,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAG1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,aAAa,IAAI,WAAW,aAAa,UAAU,CAAC,EACjE,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC;AAEhC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,wBAAwB;AAAA,IAClD;AAEA,QAAI,SAAS,WAAW;AACtB,YAAM,IAAI,gBAAgB,4EAA4E;AAAA,IACxG;AAEA,UAAMA,IAAG,OAAO,YAAY,EAAE,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC;AAE3D,kBAAc,GAAG;AAAA,EACnB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,mBAAmB,KAAK,oBAAoB,aAAa,cAAc,OAAO,KAAK,KAAK,SAAS;AAC/F,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAG1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EAAE,IAAI,aAAa,GAAG,CAAC,EAC9B,KAAK,YAAY,EACjB,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC;AAEhC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,wBAAwB;AAAA,IAClD;AAGA,UAAMA,IACH,OAAO,YAAY,EACnB,IAAI,EAAE,WAAW,OAAO,WAAW,oBAAI,KAAK,EAAE,CAAC,EAC/C,MAAM,GAAG,aAAa,WAAW,IAAI,CAAC;AAGzC,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,YAAY,EACnB,IAAI,EAAE,WAAW,MAAM,WAAW,oBAAI,KAAK,EAAE,CAAC,EAC9C,MAAM,GAAG,aAAa,IAAI,EAAE,CAAC,EAC7B,UAAU;AAEb,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AC1TD,IAAAE,mBAAwD;AASxD,mBAAkB;AAEX,IAAM,iBAAa,yBAAO;AAGjC,WAAW,IAAI,WAAW;AAI1B,IAAM,mBAAmB,CAAC,KAAc,KAAe,SAAuB;AAC5E,QAAM,iBAAiB,QAAQ,IAAI,aAAa;AAGhD,MAAI,CAAC,gBAAgB;AACnB,WAAO,MAAM,4BAA4B;AACzC,WAAO,UAAU,KAAK,KAAK,uBAAuB,0BAA0B;AAAA,EAC9E;AAMA,QAAM,aAAa,IAAI,QAAQ,eAAe,KAAK,IAAI,MAAM,QAAQ;AACrE,QAAM,aAAa,IAAI,QAAQ,eAAe;AAC9C,QAAM,mBAAmB,YAAY,WAAW,SAAS,IAAI,WAAW,MAAM,CAAC,IAAI;AAEnF,MAAI,eAAe,kBAAkB,qBAAqB,gBAAgB;AACxE,WAAO,KAAK,+BAA+B,EAAE,IAAI,IAAI,GAAG,CAAC;AACzD,WAAO,UAAU,KAAK,KAAK,aAAa,WAAW;AAAA,EACrD;AAEA,OAAK;AACP;AAiBA,WAAW,KAAK,2BAA2B,kBAAkB,OAAO,KAAK,KAAK,SAAS;AACrF,MAAI;AACF,UAAMC,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,UAAsC,CAAC;AAG7C,UAAM,gBAAgB,CAAC,GAAG,GAAG,CAAC;AAE9B,eAAW,QAAQ,eAAe;AAEhC,YAAM,kBAAkB,IAAI,KAAK,GAAG;AACpC,sBAAgB,QAAQ,gBAAgB,QAAQ,IAAI,IAAI;AACxD,sBAAgB,SAAS,GAAG,GAAG,GAAG,CAAC;AAEnC,YAAM,gBAAgB,IAAI,KAAK,eAAe;AAC9C,oBAAc,SAAS,IAAI,IAAI,IAAI,GAAG;AAItC,YAAM,qBAAqB,MAAMA,IAC9B,OAAO,EACP,KAAK,UAAU,EACf;AAAA,QACC;AAAA,UACE,GAAG,WAAW,QAAQ,MAAM;AAAA,UAC5B,IAAI,WAAW,YAAY,eAAe;AAAA,UAC1C,IAAI,WAAW,YAAY,aAAa;AAAA,QAC1C;AAAA,MACF;AAEF,aAAO,KAAK,SAAS,mBAAmB,MAAM,2BAA2B,IAAI,SAAS;AAEtF,iBAAW,aAAa,oBAAoB;AAC1C,YAAI;AAEF,gBAAM,oBAAoB;AAAA,YACxB,UAAU;AAAA,YACV,UAAU;AAAA,YACV,UAAU;AAAA,YACV;AAAA,YACA,UAAU;AAAA,YACV,UAAU,mBAAmB;AAAA,UAC/B;AAGA,gBAAM,yBAAyB,YAAY;AAAA,YACzC,aAAa,UAAU;AAAA,YACvB,cAAc;AAAA,YACd,aAAa,yBAAyB,IAAI,OAAO,SAAS,IAAI,KAAK,GAAG;AAAA,YACtE,WAAW;AAAA,UACb,CAAC,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAEjB,kBAAQ,KAAK;AAAA,YACX,aAAa,UAAU;AAAA,YACvB,iBAAiB,UAAU;AAAA,YAC3B,eAAe,UAAU;AAAA,YACzB,iBAAiB;AAAA,YACjB,QAAQ;AAAA,UACV,CAAC;AAAA,QACH,SAAS,OAAO;AACd,iBAAO,MAAM,0CAA0C,UAAU,eAAe,KAAK,KAAK;AAC1F,kBAAQ,KAAK;AAAA,YACX,aAAa,UAAU;AAAA,YACvB,iBAAiB,UAAU;AAAA,YAC3B,eAAe,UAAU;AAAA,YACzB,iBAAiB;AAAA,YACjB,QAAQ;AAAA,YACR,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,UAClD,CAAC;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,UAAM,gBAAgB,MAAMA,IACzB,OAAO,UAAU,EACjB,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW;AAAA,IACb,CAAC,EACA;AAAA,MACC;AAAA,QACE,GAAG,WAAW,QAAQ,MAAM;AAAA,QAC5B,IAAI,WAAW,YAAY,GAAG;AAAA,MAChC;AAAA,IACF,EACC,UAAU,EAAE,IAAI,WAAW,IAAI,iBAAiB,WAAW,gBAAgB,CAAC;AAG/E,eAAW,WAAW,eAAe;AACnC,YAAM,yBAAyB,WAAW,QAAQ,EAAE,EAAE,MAAM,MAAM;AAAA,MAAC,CAAC;AAAA,IACtE;AAEA,UAAM,UAAU;AAAA,MACd,aAAa,IAAI,YAAY;AAAA,MAC7B,mBAAmB,QAAQ,OAAO,OAAK,EAAE,WAAW,MAAM,EAAE;AAAA,MAC5D,qBAAqB,QAAQ,OAAO,OAAK,EAAE,WAAW,QAAQ,EAAE;AAAA,MAChE,aAAa,cAAc;AAAA,MAC3B,SAAS;AAAA,MACT,mBAAmB,cAAc,IAAI,OAAK,EAAE,eAAe;AAAA,IAC7D;AAEA,WAAO,KAAK,qCAAqC,OAAO;AACxD,gBAAY,KAAK,OAAO;AAAA,EAC1B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAQD,WAAW,KAAK,+BAA+B,kBAAkB,OAAO,KAAK,KAAK,SAAS;AACzF,MAAI;AACF,UAAM,YAAY,KAAK,IAAI;AAE3B,UAAM,eAAe,MAAM,wBAAwB,oBAAoB;AAEvE,UAAM,WAAW,KAAK,IAAI,IAAI;AAE9B,WAAO,KAAK,6CAA6C;AAAA,MACvD;AAAA,MACA,YAAY;AAAA,IACd,CAAC;AAED,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT;AAAA,MACA,YAAY;AAAA,MACZ,cAAa,oBAAI,KAAK,GAAE,YAAY;AAAA,IACtC,CAAC;AAAA,EACH,SAAS,OAAO;AACd,WAAO,MAAM,0CAA0C,EAAE,MAAM,CAAC;AAChE,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,WAAW,IAAI,WAAW,CAAC,KAAK,QAAQ;AACtC,cAAY,KAAK,EAAE,QAAQ,MAAM,YAAW,oBAAI,KAAK,GAAE,YAAY,EAAE,CAAC;AACxE,CAAC;AASD,WAAW,KAAK,oBAAoB,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC9E,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,aAAa,IAAI,KAAK,GAAG;AAC/B,eAAW,SAAS,GAAG,GAAG,GAAG,CAAC;AAE9B,UAAM,UAMA,CAAC;AAGP,UAAM,kBAAkB,MAAMA,IAC3B,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,QAAQ,SAAS,CAAC;AAElD,WAAO,KAAK,cAAc,gBAAgB,MAAM,8BAA8B;AAE9E,eAAW,YAAY,iBAAiB;AAEtC,YAAM,CAAC,UAAU,IAAI,MAAMA,IACxB,OAAO;AAAA,QACN,WAAW,6BAAqC,gBAAgB,MAAM,OAAO,UAAU;AAAA,MACzF,CAAC,EACA,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,YAAY,SAAS,EAAE,CAAC;AAEpD,YAAM,YAAY,OAAO,YAAY,aAAa,CAAC;AACnD,YAAM,iBAAiB,KAAK,IAAI,GAAG,SAAS,aAAa,SAAS;AAElE,UAAI,mBAAmB,GAAG;AACxB,eAAO,KAAK,YAAY,SAAS,IAAI,0BAA0B,SAAS,UAAU,GAAG;AACrF;AAAA,MACF;AAGA,YAAM,eAAe,MAAMA,IACxB,OAAO;AAAA,QACN,IAAI,gBAAgB;AAAA,QACpB,OAAO,gBAAgB;AAAA,QACvB,cAAc,gBAAgB;AAAA,MAChC,CAAC,EACA,KAAK,eAAe,EACpB;AAAA,QACC;AAAA,UACE,GAAG,gBAAgB,YAAY,SAAS,EAAE;AAAA,UAC1C,GAAG,gBAAgB,QAAQ,SAAS;AAAA,QACtC;AAAA,MACF,EACC,QAAQ,IAAI,gBAAgB,SAAS,CAAC,EACtC,MAAM,cAAc;AAEvB,UAAI,aAAa,WAAW,GAAG;AAE7B,cAAMA,IACH,OAAO,mBAAmB,EAC1B,IAAI;AAAA,UACH,QAAQ;AAAA,UACR,aAAa;AAAA,UACb,WAAW;AAAA,QACb,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,SAAS,EAAE,CAAC;AAEhD,gBAAQ,KAAK;AAAA,UACX,YAAY,SAAS;AAAA,UACrB,cAAc,SAAS;AAAA,UACvB,YAAY;AAAA,UACZ,cAAc;AAAA,UACd,WAAW;AAAA,QACb,CAAC;AAED,eAAO,KAAK,YAAY,SAAS,IAAI,+BAA+B;AACpE;AAAA,MACF;AAEA,UAAI,aAAa;AACjB,UAAI,eAAe;AAGnB,iBAAW,QAAQ,cAAc;AAC/B,YAAI;AAEF,gBAAM,CAAC,UAAU,IAAI,MAAMA,IACxB,OAAO,EAAE,kBAAkB,sBAAsB,iBAAiB,CAAC,EACnE,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,IAAI,KAAK,YAAY,CAAC;AAGxD,gBAAM,UAAU,QAAQ,IAAI,aAAa,KAAK;AAC9C,gBAAM,iBAAiB,GAAG,OAAO,gBAAgB,YAAY,oBAAoB,EAAE;AAGnF,gBAAM,yBAAyB,SAAS,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA,yBAKnC,cAAc;AAAA;AAAA;AAK7B,gBAAM,kBAAc,aAAAC,SAAM,wBAAwB;AAAA,YAChD,iBAAiB;AAAA,YACjB,sBAAsB;AAAA,YACtB,mBAAmB;AAAA,UACrB,CAAC;AAGD,gBAAM,UAAU,MAAM,cAAc,UAAU;AAAA,YAC5C,IAAI,KAAK;AAAA,YACT,SAAS,SAAS;AAAA,YAClB,MAAM;AAAA,UACR,CAAC;AAED,cAAI,SAAS;AACX,kBAAMD,IACH,OAAO,eAAe,EACtB,IAAI;AAAA,cACH,QAAQ;AAAA,cACR,QAAQ;AAAA,YACV,CAAC,EACA,MAAM,GAAG,gBAAgB,IAAI,KAAK,EAAE,CAAC;AAExC;AAAA,UACF,OAAO;AACL,kBAAMA,IACH,OAAO,eAAe,EACtB,IAAI;AAAA,cACH,QAAQ;AAAA,cACR,cAAc;AAAA,cACd,YAAY,MAAM,gBAAgB,UAAU;AAAA,YAC9C,CAAC,EACA,MAAM,GAAG,gBAAgB,IAAI,KAAK,EAAE,CAAC;AAExC;AAAA,UACF;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,MAAM,gCAAgC,KAAK,KAAK,KAAK,KAAK;AAEjE,gBAAMA,IACH,OAAO,eAAe,EACtB,IAAI;AAAA,YACH,QAAQ;AAAA,YACR,cAAc,iBAAiB,QAAQ,MAAM,UAAU;AAAA,YACvD,YAAY,MAAM,gBAAgB,UAAU;AAAA,UAC9C,CAAC,EACA,MAAM,GAAG,gBAAgB,IAAI,KAAK,EAAE,CAAC;AAExC;AAAA,QACF;AAAA,MACF;AAGA,YAAMA,IACH,OAAO,mBAAmB,EAC1B,IAAI;AAAA,QACH,WAAW,MAAM,oBAAoB,SAAS,MAAM,UAAU;AAAA,QAC9D,aAAa,MAAM,oBAAoB,WAAW,MAAM,YAAY;AAAA,QACpE,YAAY,aAAa,IAAI,MAAM,SAAS;AAAA,QAC5C,WAAW;AAAA,MACb,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,SAAS,EAAE,CAAC;AAEhD,cAAQ,KAAK;AAAA,QACX,YAAY,SAAS;AAAA,QACrB,cAAc,SAAS;AAAA,QACvB;AAAA,QACA;AAAA,QACA,WAAW;AAAA,MACb,CAAC;AAED,aAAO,KAAK,YAAY,SAAS,IAAI,UAAU,UAAU,YAAY,YAAY,EAAE;AAAA,IACrF;AAEA,UAAM,UAAU;AAAA,MACd,aAAa,IAAI,YAAY;AAAA,MAC7B,oBAAoB,QAAQ;AAAA,MAC5B,iBAAiB,QAAQ,OAAO,CAACE,MAAK,MAAMA,OAAM,EAAE,YAAY,CAAC;AAAA,MACjE,mBAAmB,QAAQ,OAAO,CAACA,MAAK,MAAMA,OAAM,EAAE,cAAc,CAAC;AAAA,MACrE,oBAAoB,QAAQ,OAAO,OAAK,EAAE,SAAS,EAAE;AAAA,MACrD,SAAS;AAAA,IACX;AAEA,WAAO,KAAK,mCAAmC,OAAO;AACtD,gBAAY,KAAK,OAAO;AAAA,EAC1B,SAAS,OAAO;AACd,WAAO,MAAM,gCAAgC,KAAK;AAClD,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;ACzZD,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AASX,IAAM,kBAAc,yBAAO;AAGlC,YAAY,IAAI,aAAa,YAAY;AAMzC,IAAMC,yBAAwB,eAAE,OAAO;AAAA,EACrC,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,WAAW,eAAE,WAAW,iBAAiB,EAAE,SAAS;AAAA,EACpD,QAAQ,eAAE,WAAW,WAAW,EAAE,SAAS;AAAA,EAC3C,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAED,IAAM,sBAAsB,eAAE,OAAO;AAAA,EACnC,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,WAAW,eAAE,WAAW,iBAAiB,EAAE,SAAS;AAAA,EACpD,QAAQ,eAAE,WAAW,WAAW,EAAE,SAAS;AAAA,EAC3C,SAAS,eAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,QAAQ,eAAE,KAAK,CAAC,OAAO,MAAM,CAAC,EAAE,SAAS,EAAE,QAAQ,MAAM;AAC3D,CAAC;AAED,IAAM,sBAAsB,eAAE,OAAO;AAAA,EACnC,WAAW,eAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,UAAU,eAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,UAAU,eAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAED,IAAM,gBAAgB,eAAE,OAAO;AAAA,EAC7B,QAAQ,eAAE,OAAO,EAAE,IAAI,GAAG,0BAA0B;AAAA,EACpD,UAAU,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAC3C,CAAC;AAUD,YAAY,IAAI,eAAe,cAAcA,sBAAqB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC7F,MAAI;AACF,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,IAAI,IAAI;AAGR,UAAM,UAAuD;AAAA,MAC3D,WAAW,YAAY,IAAI,KAAK,SAAmB,IAAI;AAAA,MACvD,SAAS,UAAU,IAAI,KAAK,OAAiB,IAAI;AAAA,MACjD,YAAY,YAAY,CAAC,SAA8B,IAAI;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,MACA,OAAO,QAAQ,SAAS,OAAiB,EAAE,IAAI;AAAA,MAC/C,QAAQ,SAAS,SAAS,QAAkB,EAAE,IAAI;AAAA,IACpD;AAEA,UAAM,OAAO,MAAM,gBAAgB,MAAM,OAAO;AAEhD,gBAAY,KAAK,IAAI;AAAA,EACvB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,mBAAmB,OAAO,KAAK,KAAK,SAAS;AAC3D,MAAI;AACF,UAAM,KAAK,IAAI,OAAO;AAEtB,UAAM,MAAM,MAAM,gBAAgB,QAAQ,EAAE;AAE5C,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,cAAc,qBAAqB;AAAA,IAC/C;AAEA,gBAAY,KAAK,GAAG;AAAA,EACtB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,sBAAsB,cAAc,mBAAmB,GAAG,OAAO,KAAK,KAAK,SAAS;AAClG,MAAI;AACF,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,IAAI,IAAI;AAGR,UAAM,UAAuD;AAAA,MAC3D,WAAW,YAAY,IAAI,KAAK,SAAmB,IAAI;AAAA,MACvD,SAAS,UAAU,IAAI,KAAK,OAAiB,IAAI;AAAA,MACjD,YAAY,YAAY,CAAC,SAA8B,IAAI;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,QAAI;AACJ,QAAI;AACJ,QAAI;AAEJ,QAAI,WAAW,OAAO;AACpB,mBAAa,MAAM,gBAAgB,YAAY,OAAO;AACtD,oBAAc;AACd,iBAAW,eAAc,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,CAAC;AAAA,IACjE,OAAO;AACL,mBAAa,MAAM,gBAAgB,aAAa,OAAO;AACvD,oBAAc;AACd,iBAAW,eAAc,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,CAAC;AAAA,IACjE;AAEA,QAAI,UAAU,gBAAgB,WAAW;AACzC,QAAI,UAAU,uBAAuB,yBAAyB,QAAQ,GAAG;AACzE,QAAI,KAAK,UAAU;AAAA,EACrB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAUD,YAAY,IAAI,cAAc,cAAc,mBAAmB,GAAG,OAAO,KAAK,KAAK,SAAS;AAC1F,MAAI;AACF,UAAM,EAAE,WAAW,UAAU,UAAU,OAAO,OAAO,IAAI,IAAI;AAG7D,UAAM,UAA2D;AAAA,MAC/D,WAAW,YAAY,cAAc,SAAS;AAAA,MAC9C,UAAU,WAAW,SAAS,UAAoB,EAAE,IAAI;AAAA,MACxD,UAAU,WAAW,SAAS,UAAoB,EAAE,IAAI;AAAA,MACxD,OAAO,QAAQ,SAAS,OAAiB,EAAE,IAAI;AAAA,MAC/C,QAAQ,SAAS,SAAS,QAAkB,EAAE,IAAI;AAAA,IACpD;AAEA,UAAM,MAAM,MAAM,oBAAoB,MAAM,OAAO;AAEnD,gBAAY,KAAK,GAAG;AAAA,EACtB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC1D,MAAI;AACF,UAAM,KAAK,IAAI,OAAO;AAEtB,UAAM,aAAa,MAAM,oBAAoB,cAAc,EAAE;AAE7D,QAAI,CAAC,YAAY;AACf,YAAM,IAAI,cAAc,yBAAyB;AAAA,IACnD;AAEA,gBAAY,KAAK,UAAU;AAAA,EAC7B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,KAAK,wBAAwB,aAAa,aAAa,GAAG,OAAO,KAAK,KAAK,SAAS;AAC9F,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,EAAE,QAAQ,SAAS,IAAI,IAAI;AAGjC,UAAM,oBAAoB,QAAQ,IAAI,QAAQ,QAAQ;AAGtD,UAAM,gBAAgB,eAAe,KAAK;AAAA,MACxC;AAAA,MACA;AAAA,MACA,SAAU,IAAY,MAAM;AAAA,MAC5B,YAAa,IAAY,MAAM;AAAA,MAC/B,QAAQ;AAAA,MACR;AAAA,MACA,UAAU;AAAA,QACR,UAAU;AAAA,QACV;AAAA,QACA,UAAU,YAAY;AAAA,MACxB;AAAA,IACF,CAAC;AAED,gBAAY,KAAK,EAAE,SAAS,2BAA2B,IAAI,QAAQ,SAAS,CAAC;AAAA,EAC/E,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,OAAO,0BAA0B,OAAO,KAAK,KAAK,SAAS;AACrE,MAAI;AACF,UAAM,KAAK,IAAI,OAAO,IAAI;AAG1B,UAAM,oBAAoB,UAAU,EAAE;AAGtC,UAAM,gBAAgB,eAAe,KAAK;AAAA,MACxC;AAAA,MACA;AAAA,MACA,SAAU,IAAY,MAAM;AAAA,MAC5B,YAAa,IAAY,MAAM;AAAA,MAC/B,QAAQ;AAAA,MACR;AAAA,MACA,UAAU;AAAA,QACR,UAAU;AAAA,MACZ;AAAA,IACF,CAAC;AAED,gBAAY,KAAK,EAAE,SAAS,6BAA6B,GAAG,CAAC;AAAA,EAC/D,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,YAAY,IAAI,gBAAgB,OAAO,KAAK,KAAK,SAAS;AACxD,MAAI;AACF,UAAM,QAAQ,MAAM,oBAAoB,cAAc;AAEtD,gBAAY,KAAK,KAAK;AAAA,EACxB,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;;;AC9RD,IAAAC,mBAAuB;AACvB,IAAAC,eAAkB;AAClB,IAAAC,iBAAmB;AACnB,IAAAC,gBAAkB;AAmBX,IAAM,uBAAmB,yBAAO;AAGvC,iBAAiB,IAAI,aAAa,YAAY;AAM9C,IAAM,0BAA0B,eAAE,OAAO;AAAA,EACvC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,KAAK,CAAC,UAAU,gBAAgB,SAAS,CAAC,EAAE,SAAS;AAAA,EAC/D,QAAQ,eAAE,KAAK,CAAC,UAAU,YAAY,SAAS,UAAU,OAAO,CAAC,EAAE,SAAS;AAAA,EAC5E,QAAQ,eAAE,OAAO,EAAE,SAAS;AAC9B,CAAC;AAED,IAAM,sBAAsB,eAAE,OAAO;AAAA,EACnC,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,EACxB,MAAM,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACnC,QAAQ,eAAE,KAAK,CAAC,UAAU,YAAY,SAAS,UAAU,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,OAAO;AAC/F,CAAC;AAED,IAAM,0BAA0B,eAAE,OAAO;AAAA,EACvC,aAAa,eAAE;AAAA,IACb,eAAE,OAAO;AAAA,MACP,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,MACxB,MAAM,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,IACrC,CAAC;AAAA,EACH,EAAE,IAAI,CAAC,EAAE,IAAI,GAAK;AACpB,CAAC;AAED,IAAM,wBAAwB,eAAE,OAAO;AAAA,EACrC,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC1B,OAAO,eAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,QAAQ,eAAE,KAAK,CAAC,SAAS,aAAa,WAAW,UAAU,aAAa,WAAW,CAAC,EAAE,SAAS;AACjG,CAAC;AAED,IAAM,uBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAClC,aAAa,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAAA,EAC5D,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACzB,YAAY,eAAE,OAAO,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAK,EAAE,SAAS,EAAE,QAAQ,GAAG;AAAA,EAC5E,UAAU,eAAE,OAAO,EAAE,MAAM,6BAA6B,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAAA;AAAA,EACrF,aAAa,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAChE,CAAC;AAED,IAAM,uBAAuB,eAAE,OAAO;AAAA,EACpC,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC1C,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EAC7C,aAAa,eAAE,OAAO,EAAE,IAAI,GAAG,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAAA,EAC5D,SAAS,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACpC,YAAY,eAAE,OAAO,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAK,EAAE,SAAS;AAAA,EAC/D,UAAU,eAAE,OAAO,EAAE,MAAM,6BAA6B,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAAA,EACrF,aAAa,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG,eAAE,QAAQ,EAAE,CAAC;AAChE,CAAC;AAUD,iBAAiB;AAAA,EACf;AAAA,EACA,cAAc,uBAAuB;AAAA,EACrC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMC,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,QAAQ,QAAQ,OAAO,IAAI,IAAI;AAEvC,YAAM,aAAa,CAAC;AAEpB,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,sBAAsB,QAAQ,MAAgB,CAAC;AAAA,MACpE;AAEA,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,sBAAsB,QAAQ,MAAgB,CAAC;AAAA,MACpE;AAEA,UAAI,QAAQ;AACV,mBAAW;AAAA,UACT,OAAO,sBAAsB,KAAK,UAAU,IAAI,MAAM,GAAG,OAAO,sBAAsB,IAAI,UAAU,IAAI,MAAM,GAAG;AAAA,QACnH;AAAA,MACF;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAGjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,qBAAqB,EAC1B,MAAM,WAAW;AACpB,YAAM,QAAQ,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAG/C,YAAM,cAAc,MAAMA,IACvB,OAAO,EACP,KAAK,qBAAqB,EAC1B,MAAM,WAAW,EACjB,QAAQ,KAAK,sBAAsB,YAAY,CAAC,EAChD,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,kBAAY,KAAK,aAAa,KAAK,qBAAqB,MAAM,OAAO,KAAK,CAAC;AAAA,IAC7E,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,IAAI,sBAAsB,OAAO,MAAM,KAAK,SAAS;AACpE,MAAI;AACF,UAAMA,MAAK,MAAM;AAEjB,UAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,MACN,OAAO;AAAA,MACP,QAAQ,6BAAqC,sBAAsB,MAAM;AAAA,MACzE,cAAc,6BAAqC,sBAAsB,MAAM;AAAA,MAC/E,SAAS,6BAAqC,sBAAsB,MAAM;AAAA,MAC1E,WAAW,6BAAqC,sBAAsB,YAAY;AAAA,MAClF,UAAU,6BAAqC,sBAAsB,YAAY;AAAA,IACnF,CAAC,EACA,KAAK,qBAAqB;AAE7B,UAAM,QAAQ,YAAY,CAAC;AAG3B,UAAM,WAAW,MAAMA,IACpB,OAAO;AAAA,MACN,QAAQ,sBAAsB;AAAA,MAC9B,OAAO;AAAA,IACT,CAAC,EACA,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,QAAQ,QAAQ,CAAC,EAChD,QAAQ,sBAAsB,MAAM;AAEvC,gBAAY,KAAK;AAAA,MACf,OAAO,OAAO,OAAO,SAAS,CAAC;AAAA,MAC/B,QAAQ,OAAO,OAAO,UAAU,CAAC;AAAA,MACjC,cAAc,OAAO,OAAO,gBAAgB,CAAC;AAAA,MAC7C,SAAS,OAAO,OAAO,WAAW,CAAC;AAAA,MACnC,WAAW,OAAO,OAAO,aAAa,CAAC;AAAA,MACvC,UAAU,OAAO,OAAO,YAAY,CAAC;AAAA,MACrC,UAAU,SAAS,OAAO,CAAC,KAAK,SAAS;AACvC,YAAI,KAAK,MAAM,IAAI,OAAO,KAAK,KAAK;AACpC,eAAO;AAAA,MACT,GAAG,CAAC,CAA2B;AAAA,IACjC,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,uBAAuB,OAAO,KAAK,KAAK,SAAS;AACpE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,aAAa,CAAC;AACpB,QAAI,QAAQ;AACV,iBAAW,KAAK,GAAG,sBAAsB,QAAQ,MAAgB,CAAC;AAAA,IACpE;AAEA,UAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAEjE,UAAM,cAAc,MAAMA,IACvB,OAAO;AAAA,MACN,OAAO,sBAAsB;AAAA,MAC7B,MAAM,sBAAsB;AAAA,MAC5B,QAAQ,sBAAsB;AAAA,MAC9B,QAAQ,sBAAsB;AAAA,MAC9B,cAAc,sBAAsB;AAAA,MACpC,gBAAgB,sBAAsB;AAAA,IACxC,CAAC,EACA,KAAK,qBAAqB,EAC1B,MAAM,WAAW,EACjB,QAAQ,KAAK,sBAAsB,YAAY,CAAC;AAGnD,UAAM,UAAU,CAAC,SAAS,QAAQ,UAAU,UAAU,iBAAiB,iBAAiB;AACxF,UAAM,OAAO,YAAY,IAAI,CAAC,MAAM;AAAA,MAClC,EAAE;AAAA,MACF,EAAE,QAAQ;AAAA,MACV,EAAE;AAAA,MACF,EAAE;AAAA,MACF,EAAE,aAAa,YAAY;AAAA,MAC3B,EAAE,gBAAgB,YAAY,KAAK;AAAA,IACrC,CAAC;AAED,UAAM,MAAM;AAAA,MACV,QAAQ,KAAK,GAAG;AAAA,MAChB,GAAG,KAAK,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,SAAS,IAAI,KAAK,QAAQ,MAAM,IAAI,CAAC,GAAG,EAAE,KAAK,GAAG,CAAC;AAAA,IACnF,EAAE,KAAK,IAAI;AAEX,QAAI,UAAU,gBAAgB,UAAU;AACxC,QAAI,UAAU,uBAAuB,sCAAqC,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,CAAC,OAAO;AACvH,QAAI,KAAK,GAAG;AAAA,EACd,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,mBAAmB;AAAA,EAChC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,OAAO,MAAM,OAAO,IAAI,IAAI;AAGpC,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,OAAO,MAAM,YAAY,CAAC,CAAC;AAE7D,UAAI,UAAU;AACZ,cAAM,IAAI,gBAAgB,0BAA0B;AAAA,MACtD;AAEA,YAAM,mBAAmB,eAAAC,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AAE9D,YAAM,CAAC,UAAU,IAAI,MAAMD,IACxB,OAAO,qBAAqB,EAC5B,OAAO;AAAA,QACN,OAAO,MAAM,YAAY;AAAA,QACzB;AAAA,QACA;AAAA,QACA;AAAA,QACA,QAAQ;AAAA,MACV,CAAC,EACA,UAAU;AAEb,kBAAY,KAAK,YAAY,GAAG;AAAA,IAClC,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,uBAAuB;AAAA,EACpC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,aAAa,iBAAiB,IAAI,IAAI;AAE9C,YAAM,UAAU;AAAA,QACd,UAAU;AAAA,QACV,SAAS;AAAA,QACT,QAAQ,CAAC;AAAA,MACX;AAGA,YAAM,iBAAiB,IAAI;AAAA,SACxB,MAAMA,IAAG,OAAO,EAAE,OAAO,sBAAsB,MAAM,CAAC,EAAE,KAAK,qBAAqB,GAChF,IAAI,CAAC,MAAM,EAAE,MAAM,YAAY,CAAC;AAAA,MACrC;AAGA,YAAM,iBAAiB,iBAAiB,OAAO,CAAC,MAAyB;AACvE,YAAI,eAAe,IAAI,EAAE,MAAM,YAAY,CAAC,GAAG;AAC7C,kBAAQ;AACR,iBAAO;AAAA,QACT;AACA,eAAO;AAAA,MACT,CAAC;AAGD,YAAM,YAAY;AAClB,eAAS,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK,WAAW;AACzD,cAAM,QAAQ,eAAe,MAAM,GAAG,IAAI,SAAS;AACnD,cAAM,SAAS,MAAM,IAAI,CAAC,OAAyC;AAAA,UACjE,OAAO,EAAE,MAAM,YAAY;AAAA,UAC3B,MAAM,EAAE,QAAQ;AAAA,UAChB,QAAQ;AAAA,UACR,kBAAkB,eAAAC,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AAAA,UACvD,QAAQ;AAAA,QACV,EAAE;AAEF,cAAMD,IAAG,OAAO,qBAAqB,EAAE,OAAO,MAAM;AACpD,gBAAQ,YAAY,MAAM;AAAA,MAC5B;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS,qBAAqB,QAAQ,QAAQ,cAAc,QAAQ,OAAO;AAAA,QAC3E,GAAG;AAAA,MACL,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,OAAO,oBAAoB,OAAO,KAAK,KAAK,SAAS;AACpE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,qBAAqB,EAC5B,MAAM,GAAG,sBAAsB,IAAI,EAAE,CAAC,EACtC,UAAU;AAEb,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,cAAc,sBAAsB;AAAA,IAChD;AAEA,gBAAY,KAAK,EAAE,SAAS,kCAAkC,CAAC;AAAA,EACjE,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,eAAE,OAAO,EAAE,KAAK,eAAE,MAAM,eAAE,OAAO,EAAE,KAAK,CAAC,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;AAAA,EACjE,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,IAAI,IAAI,IAAI;AAEpB,YAAM,UAAU,MAAMA,IACnB,OAAO,qBAAqB,EAC5B,MAAM,QAAQ,sBAAsB,IAAI,GAAG,CAAC,EAC5C,UAAU;AAEb,kBAAY,KAAK,EAAE,SAAS,GAAG,QAAQ,MAAM,uBAAuB,CAAC;AAAA,IACvE,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAUA,iBAAiB;AAAA,EACf;AAAA,EACA,cAAc,qBAAqB;AAAA,EACnC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,YAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,YAAM,aAAa,CAAC;AACpB,UAAI,QAAQ;AACV,mBAAW,KAAK,GAAG,oBAAoB,QAAQ,MAAgB,CAAC;AAAA,MAClE;AAEA,YAAM,cAAc,WAAW,SAAS,IAAI,IAAI,GAAG,UAAU,IAAI;AAGjE,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,mBAAmB,EACxB,MAAM,WAAW;AACpB,YAAM,QAAQ,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAG/C,YAAM,YAAY,MAAMA,IACrB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,WAAW,EACjB,QAAQ,KAAK,oBAAoB,SAAS,CAAC,EAC3C,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,kBAAY,KAAK,WAAW,KAAK,qBAAqB,MAAM,OAAO,KAAK,CAAC;AAAA,IAC3E,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,IAAI,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAC/D,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,gBAAY,KAAK,QAAQ;AAAA,EAC3B,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,EAAE,MAAM,SAAS,aAAa,SAAS,YAAY,UAAU,YAAY,IAAI,IAAI;AAGvF,YAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,QAAQ,QAAQ,CAAC;AACnD,YAAM,kBAAkB,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAGzD,YAAM,SAAU,IAAY,MAAM;AAClC,YAAM,YAAY;AAClB,YAAM,YAAY,UAAU,UAAU,KAAK,MAAM,IAAI,SAAS;AAE9D,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,mBAAmB,EAC1B,OAAO;AAAA,QACN;AAAA,QACA;AAAA,QACA,aAAa,eAAe;AAAA,QAC5B;AAAA;AAAA,QACA;AAAA,QACA,UAAU,YAAY;AAAA,QACtB,aAAa,cAAc,IAAI,KAAK,WAAW,IAAI;AAAA,QACnD,iBAAiB;AAAA,QACjB,QAAQ,cAAc,cAAc;AAAA,QACpC;AAAA,MACF,CAAC,EACA,UAAU;AAEb,kBAAY,KAAK,UAAU,GAAG;AAAA,IAChC,SAAS,OAAO;AACd,cAAQ,MAAM,4BAA4B,KAAK;AAC/C,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,oBAAoB;AAAA,EACjC,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,UAAU,IAAI;AAEpB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAEA,UAAI,CAAC,CAAC,SAAS,UAAU,WAAW,EAAE,SAAS,SAAS,MAAM,GAAG;AAC/D,cAAM,IAAI,gBAAgB,qDAAqD;AAAA,MACjF;AAGA,YAAM,oBAA6C,CAAC;AACpD,UAAI,QAAQ,aAAa,GAAG;AAC1B,0BAAkB,aAAa,IAAI,IAAI,KAAK,QAAQ,aAAa,CAAW;AAC5E,YAAI,SAAS,WAAW,SAAS;AAC/B,4BAAkB,QAAQ,IAAI;AAAA,QAChC;AAAA,MACF;AAGA,UAAI,QAAQ,SAAS,GAAG;AAEtB,cAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,QAAQ,QAAQ,CAAC;AACnD,0BAAkB,iBAAiB,IAAI,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAAA,MAC1E;AAEA,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,mBAAmB,EAC1B,IAAI;AAAA,QACH,GAAG;AAAA,QACH,GAAG;AAAA,QACH,WAAW,oBAAI,KAAK;AAAA,MACtB,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC,EACpC,UAAU;AAEb,kBAAY,KAAK,QAAQ;AAAA,IAC3B,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;AAMA,iBAAiB,OAAO,kBAAkB,OAAO,KAAK,KAAK,SAAS;AAClE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,QAAI,SAAS,WAAW,SAAS;AAC/B,YAAM,IAAI,gBAAgB,iCAAiC;AAAA,IAC7D;AAEA,UAAMA,IAAG,OAAO,mBAAmB,EAAE,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEzE,gBAAY,KAAK,EAAE,SAAS,gCAAgC,CAAC;AAAA,EAC/D,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,wBAAwB,OAAO,KAAK,KAAK,SAAS;AACtE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,QAAI,CAAC,CAAC,SAAS,aAAa,QAAQ,EAAE,SAAS,SAAS,MAAM,GAAG;AAC/D,YAAM,IAAI,gBAAgB,iDAAiD;AAAA,IAC7E;AAGA,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,QAAQ,QAAQ,CAAC;AAEnD,UAAM,kBAAkB,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAEzD,QAAI,oBAAoB,GAAG;AACzB,YAAM,IAAI,gBAAgB,kCAAkC;AAAA,IAC9D;AAGA,UAAM,oBAAoB,MAAMA,IAC7B,OAAO,EAAE,IAAI,sBAAsB,IAAI,OAAO,sBAAsB,MAAM,CAAC,EAC3E,KAAK,qBAAqB,EAC1B,MAAM,GAAG,sBAAsB,QAAQ,QAAQ,CAAC;AAGnD,UAAM,gBAAgB,MAAMA,IACzB,OAAO,EAAE,cAAc,gBAAgB,aAAa,CAAC,EACrD,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,YAAY,EAAE,CAAC;AAE3C,UAAM,wBAAwB,IAAI,IAAI,cAAc,IAAI,CAAC,MAAM,EAAE,YAAY,CAAC;AAG9E,UAAM,iBAAiB,kBAAkB,OAAO,CAAC,MAAM,CAAC,sBAAsB,IAAI,EAAE,EAAE,CAAC;AAEvF,QAAI,eAAe,SAAS,GAAG;AAE7B,YAAM,YAAY;AAClB,eAAS,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK,WAAW;AACzD,cAAM,QAAQ,eAAe,MAAM,GAAG,IAAI,SAAS;AACnD,cAAMA,IAAG,OAAO,eAAe,EAAE;AAAA,UAC/B,MAAM,IAAI,CAAC,OAAO;AAAA,YAChB,YAAY;AAAA,YACZ,cAAc,EAAE;AAAA,YAChB,OAAO,EAAE;AAAA,YACT,QAAQ;AAAA,UACV,EAAE;AAAA,QACJ;AAAA,MACF;AAAA,IACF;AAGA,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,mBAAmB,EAC1B,IAAI;AAAA,MACH,QAAQ;AAAA,MACR;AAAA,MACA,WAAW,SAAS,aAAa,oBAAI,KAAK;AAAA,MAC1C,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC,EACpC,UAAU;AAEb,gBAAY,KAAK;AAAA,MACf,SAAS;AAAA,MACT,UAAU;AAAA,MACV,cAAc,eAAe;AAAA,IAC/B,CAAC;AAAA,EACH,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,wBAAwB,OAAO,KAAK,KAAK,SAAS;AACtE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,QAAI,SAAS,WAAW,WAAW;AACjC,YAAM,IAAI,gBAAgB,2CAA2C;AAAA,IACvE;AAEA,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,mBAAmB,EAC1B,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC,EACpC,UAAU;AAEb,gBAAY,KAAK,EAAE,SAAS,mBAAmB,UAAU,QAAQ,CAAC;AAAA,EACpE,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,KAAK,yBAAyB,OAAO,KAAK,KAAK,SAAS;AACvE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAE1B,UAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,cAAc,oBAAoB;AAAA,IAC9C;AAEA,QAAI,CAAC,aAAa,WAAW,EAAE,SAAS,SAAS,MAAM,GAAG;AACxD,YAAM,IAAI,gBAAgB,mDAAmD;AAAA,IAC/E;AAGA,UAAMA,IACH,OAAO,eAAe,EACtB;AAAA,MACC;AAAA,QACE,GAAG,gBAAgB,YAAY,EAAE;AAAA,QACjC,GAAG,gBAAgB,QAAQ,SAAS;AAAA,MACtC;AAAA,IACF;AAEF,UAAM,CAAC,OAAO,IAAI,MAAMA,IACrB,OAAO,mBAAmB,EAC1B,IAAI;AAAA,MACH,QAAQ;AAAA,MACR,WAAW,oBAAI,KAAK;AAAA,IACtB,CAAC,EACA,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC,EACpC,UAAU;AAEb,gBAAY,KAAK,EAAE,SAAS,sBAAsB,UAAU,QAAQ,CAAC;AAAA,EACvE,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB,IAAI,wBAAwB,OAAO,KAAK,KAAK,SAAS;AACrE,MAAI;AACF,UAAMA,MAAK,MAAM;AACjB,UAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,UAAM,EAAE,MAAM,OAAO,OAAO,IAAI,sBAAsB,IAAI,KAA+B;AACzF,UAAM,EAAE,OAAO,IAAI,IAAI;AAEvB,UAAM,aAAa,CAAC,GAAG,gBAAgB,YAAY,EAAE,CAAC;AACtD,QAAI,QAAQ;AACV,iBAAW,KAAK,GAAG,gBAAgB,QAAQ,MAAgB,CAAC;AAAA,IAC9D;AAEA,UAAM,cAAc,IAAI,GAAG,UAAU;AAGrC,UAAM,cAAc,MAAMA,IACvB,OAAO,EAAE,OAAO,cAAsB,CAAC,EACvC,KAAK,eAAe,EACpB,MAAM,WAAW;AACpB,UAAM,QAAQ,OAAO,YAAY,CAAC,GAAG,SAAS,CAAC;AAG/C,UAAM,QAAQ,MAAMA,IACjB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,WAAW,EACjB,QAAQ,IAAI,gBAAgB,SAAS,CAAC,EACtC,MAAM,KAAK,EACX,OAAO,MAAM;AAEhB,gBAAY,KAAK,OAAO,KAAK,qBAAqB,MAAM,OAAO,KAAK,CAAC;AAAA,EACvE,SAAS,OAAO;AACd,SAAK,KAAK;AAAA,EACZ;AACF,CAAC;AAMD,iBAAiB;AAAA,EACf;AAAA,EACA,aAAa,eAAE,OAAO,EAAE,OAAO,eAAE,OAAO,EAAE,MAAM,EAAE,CAAC,CAAC;AAAA,EACpD,OAAO,KAAK,KAAK,SAAS;AACxB,QAAI;AACF,YAAMA,MAAK,MAAM;AACjB,YAAM,KAAK,IAAI,OAAO,IAAI;AAC1B,YAAM,EAAE,MAAM,IAAI,IAAI;AAEtB,YAAM,CAAC,QAAQ,IAAI,MAAMA,IACtB,OAAO,EACP,KAAK,mBAAmB,EACxB,MAAM,GAAG,oBAAoB,IAAI,EAAE,CAAC;AAEvC,UAAI,CAAC,UAAU;AACb,cAAM,IAAI,cAAc,oBAAoB;AAAA,MAC9C;AAGA,YAAM,aAAa,QAAQ,IAAI,aAAa,KAAK;AACjD,YAAM,iBAAiB,GAAG,UAAU;AACpC,YAAM,oBAAoB;AAAA;AAAA;AAAA;AAAA,qBAIX,cAAc;AAAA;AAAA;AAG7B,YAAM,oBAAoB,SAAS,UAAU;AAI7C,YAAM,kBAAc,cAAAE,SAAM,mBAAmB;AAAA,QAC3C,iBAAiB;AAAA,QACjB,sBAAsB;AAAA,QACtB,mBAAmB;AAAA,MACrB,CAAC;AAGD,YAAM,UAAU,MAAM,cAAc,UAAU;AAAA,QAC5C,IAAI;AAAA,QACJ,SAAS,UAAU,SAAS,OAAO;AAAA,QACnC,MAAM;AAAA,MACR,CAAC;AAED,UAAI,CAAC,SAAS;AACZ,cAAM,IAAI,gBAAgB,sDAAsD;AAAA,MAClF;AAEA,kBAAY,KAAK;AAAA,QACf,SAAS,sBAAsB,KAAK;AAAA,QACpC,UAAU;AAAA,UACR,IAAI,SAAS;AAAA,UACb,SAAS,SAAS;AAAA,QACpB;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,WAAK,KAAK;AAAA,IACZ;AAAA,EACF;AACF;;;A9C/0BO,IAAMC,cAAS,yBAAO;AAG7BA,QAAO,IAAI,WAAW,YAAY;AAOlCA,QAAO,IAAI,SAAS,UAAU;AAG9BA,QAAO,IAAI,kBAAkB,cAAc;AAG3CA,QAAO,IAAI,aAAa,cAAc;AAGtCA,QAAO,IAAI,WAAW,YAAY;AAGlCA,QAAO,IAAI,eAAe,gBAAgB;AAG1CA,QAAO,IAAI,SAAS,UAAU;AAG9BA,QAAO,IAAI,WAAW,YAAY;AAGlCA,QAAO,IAAI,UAAU,WAAW;AAGhCA,QAAO,IAAI,aAAa,cAAc;AAGtCA,QAAO,IAAI,gBAAgB,gBAAgB;AAG3CA,QAAO,IAAI,YAAY,aAAa;AAOpCA,QAAO,IAAI,cAAc,eAAe;AAOxCA,QAAO,IAAI,eAAe,gBAAgB;AAG1CA,QAAO,IAAI,wBAAwB,wBAAwB;AAG3DA,QAAO,IAAI,cAAc,eAAe;AAGxCA,QAAO,IAAI,WAAW,YAAY;AAGlCA,QAAO,IAAI,WAAW,YAAY;AAGlCA,QAAO,IAAI,WAAW,YAAY;AAGlCA,QAAO,IAAI,kBAAkB,4BAAmB;AAGhDA,QAAO,IAAI,kBAAkB,kBAAkB;AAG/CA,QAAO,IAAI,kBAAkB,kBAAkB;AAG/CA,QAAO,IAAI,UAAU,WAAW;AAGhCA,QAAO,IAAI,eAAe,gBAAgB;AAG1CA,QAAO,IAAI,SAAS,UAAU;AAM9BA,QAAO,IAAI,KAAK,CAAC,MAAM,QAAQ;AAC7B,MAAI,KAAK;AAAA,IACP,MAAM;AAAA,IACN,SAAS;AAAA,IACT,eAAe;AAAA,IACf,WAAW;AAAA;AAAA,MAET,MAAM;AAAA,MACN,UAAU;AAAA,MACV,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ,MAAM;AAAA,MACN,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,SAAS;AAAA,MACT,QAAQ;AAAA;AAAA,MAER,WAAW;AAAA;AAAA,MAEX,YAAY;AAAA,MACZ,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,WAAW;AAAA,MACX,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,eAAe;AAAA,MACf,cAAc;AAAA,MACd,YAAY;AAAA,IACd;AAAA,EACF,CAAC;AACH,CAAC;;;AnHrIM,SAAS,YAAY;AAC1B,QAAMC,WAAM,iBAAAC,SAAQ;AAGpB,EAAAD,KAAI,IAAI,eAAe,CAAC;AAOxB,EAAAA,KAAI,IAAI,mBAAmB;AAO3B,EAAAA,KAAI,QAAI,cAAAE,SAAO,CAAC;AAGhB,EAAAF,KAAI;AAAA,QACF,YAAAG,SAAK;AAAA,MACH,QAAQ,CAAC,QAAQ,aAAa;AAE5B,YAAI,CAAC,QAAQ;AACX,iBAAO,SAAS,MAAM,IAAI;AAAA,QAC5B;AAGA,YAAI,OAAO,YAAY,SAAS,MAAM,GAAG;AACvC,mBAAS,MAAM,MAAM;AAAA,QACvB,OAAO;AACL,mBAAS,IAAI,MAAM,qBAAqB,CAAC;AAAA,QAC3C;AAAA,MACF;AAAA,MACA,aAAa;AAAA,MACb,SAAS,CAAC,OAAO,QAAQ,OAAO,SAAS,UAAU,SAAS;AAAA,MAC5D,gBAAgB,CAAC,gBAAgB,iBAAiB,gBAAgB,cAAc;AAAA,IAClF,CAAC;AAAA,EACH;AAGA,EAAAH,KAAI,IAAI,cAAc;AAOtB,EAAAA,KAAI,QAAI,mBAAAI,SAAY,CAAC;AAGrB,EAAAJ,KAAI,QAAI,qBAAAK,SAAa,CAAC;AAGtB,EAAAL,KAAI,IAAI,iBAAAC,QAAQ,KAAK,EAAE,OAAO,OAAO,CAAC,CAAC;AACvC,EAAAD,KAAI,IAAI,iBAAAC,QAAQ,WAAW,EAAE,UAAU,MAAM,OAAO,OAAO,CAAC,CAAC;AAG7D,EAAAD,KAAI,IAAI,WAAW;AAGnB,EAAAA,KAAI,IAAI,CAAC,KAAK,KAAK,SAAS;AAE1B,UAAM,kBAAkB;AAAA,MACtB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,QACE,CAAC,OAAO,QAAQ,SAAS,EAAE,SAAS,IAAI,MAAM,KAC9C,IAAI,SAAS,aACb,IAAI,SAAS,iBACb,gBAAgB,SAAS,IAAI,IAAI,GACjC;AACA,aAAO,KAAK;AAAA,IACd;AACA,yBAAqB,KAAK,KAAK,IAAI;AAAA,EACrC,CAAC;AAGD,MAAI,OAAO,OAAO;AAChB,IAAAA,KAAI,QAAI,cAAAM,SAAO,KAAK,CAAC;AAAA,EACvB,OAAO;AACL,IAAAN,KAAI;AAAA,UACF,cAAAM,SAAO,YAAY;AAAA,QACjB,QAAQ,EAAE,OAAO,CAAC,YAAoB,OAAO,KAAK,QAAQ,KAAK,CAAC,EAAE;AAAA,MACpE,CAAC;AAAA,IACH;AAAA,EACF;AAMA,EAAAN,KAAI,IAAI,WAAW,CAAC,MAAM,QAAQ;AAChC,QAAI,KAAK;AAAA,MACP,QAAQ;AAAA,MACR,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MAClC,aAAa,OAAO;AAAA,IACtB,CAAC;AAAA,EACH,CAAC;AAGD,EAAAA,KAAI,IAAI,mBAAmB,CAAC,KAAK,QAAQ;AACvC,UAAM,QAAQ,kBAAkB,KAAK,GAAG;AACxC,QAAI,KAAK,EAAE,WAAW,MAAM,CAAC;AAAA,EAC/B,CAAC;AAMD,EAAAA,KAAI,IAAI,QAAQO,OAAM;AAOtB,EAAAP,KAAI,IAAI,eAAe;AAGvB,EAAAA,KAAI,IAAI,YAAY;AAEpB,SAAOA;AACT;;;ADrJA,IAAM,MAAM,UAAU;AAGtB,IAAO,gBAAQ;","names":["import_express","dotenv","path","timestamp","import_uuid","import_serverless","config","otel","rawTracer","config","config","char","value","startFrom","config","ref","actions","config","sql","config","param","sql","placeholder","name","SQL","name","result","path","index","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","config","name","min","max","config","relations","config","index","table","select","sql","queryConfig","joinOn","field","config","config","config","tableName","config","sql","config","config","sql","config","logger","sql","target","res","config","logger","db","instance","drizzle","sql","bcrypt","count","jwt","uuidValidate","import_zod","rateLimit","xss","import_uuid","uuidv4","import_express","import_zod","import_bcryptjs","import_uuid","text","slugify","sum","text","line","PDFDocument","index","desc","date","path","import_zod","line","index","char","index","db","crypto","crypto","db","sum","db","config","nodemailer","date","timestamp","import_bcryptjs","import_crypto","crypto","line","count","db","zxcvbn","db","bcrypt","db","SecurityEventType","EventStatus","db","db","bcrypt","import_express","sessions","count","import_express","import_zod","db","count","import_express","import_zod","db","count","import_express","import_zod","import_uuid","db","uuidv4","sum","import_express","import_zod","text","char","db","count","import_express","import_zod","import_bcryptjs","WEAK_PASSWORDS","addressSchema","db","bcrypt","count","import_express","import_zod","db","count","import_express","import_zod","db","db","count","db","sum","import_express","import_zod","db","import_express","import_zod","db","count","index","import_express","import_zod","db","count","import_express","import_zod","db","sum","import_express","import_zod","db","import_express","import_zod","db","shippingAddress","billingAddress","import_express","import_zod","import_crypto","db","crypto","products","import_express","import_zod","ImageKit","import_express","db","version","import_express","import_zod","settings","import_express","import_zod","import_express","import_zod","import_imagekit","imagekit","getImageKit","ImageKit","searchQuerySchema","index","timestamp","import_express","import_zod","createTemplateSchema","updateTemplateSchema","db","count","import_express","db","juice","sum","import_express","import_zod","auditLogFiltersSchema","import_express","import_zod","import_crypto","import_juice","db","crypto","juice","router","app","express","helmet","cors","compression","cookieParser","morgan","router"]}