{"version":3,"sources":["../api/index.ts","../src/app.ts","../src/config/index.ts","../src/middleware/errorHandler.ts","../src/utils/errors.ts","../src/utils/response.ts","../src/utils/logger.ts","../src/middleware/auth.ts","../../../packages/database/src/client.ts","../../../packages/database/src/schema/index.ts","../../../packages/database/src/schema/categories.ts","../../../packages/database/src/schema/products.ts","../../../packages/database/src/schema/customers.ts","../../../packages/database/src/schema/orders.ts","../../../packages/database/src/schema/promoCodes.ts","../../../packages/database/src/schema/quotations.ts","../../../packages/database/src/schema/pdfTemplates.ts","../../../packages/database/src/schema/blogs.ts","../../../packages/database/src/schema/settings.ts","../../../packages/database/src/schema/carts.ts","../../../packages/database/src/schema/imports.ts","../../../packages/database/src/schema/verificationCodes.ts","../../../packages/database/src/schema/sessions.ts","../../../packages/database/src/schema/passwordHistory.ts","../../../packages/database/src/schema/loginAttempts.ts","../../../packages/database/src/schema/breachChecks.ts","../../../packages/database/src/schema/securityAuditLogs.ts","../../../packages/database/src/schema/ipReputation.ts","../../../packages/database/src/schema/newsletter.ts","../../../packages/database/src/index.ts","../src/services/session.service.ts","../src/middleware/validator.ts","../src/middleware/rateLimiter.ts","../src/middleware/csrf.ts","../src/middleware/xss.ts","../src/middleware/request-id.ts","../src/routes/index.ts","../src/routes/auth.routes.ts","../src/utils/helpers.ts","../src/services/pricing.service.ts","../src/services/pdf.service.ts","../src/services/export.service.ts","../src/services/import.service.ts","../src/services/search.service.ts","../src/services/verification-code.service.ts","../src/utils/crypto.ts","../src/services/ip-reputation.service.ts","../src/services/cart.service.ts","../src/services/mailer.service.ts","../src/services/notification.service.ts","../src/services/password-security.service.ts","../src/services/hibp.service.ts","../src/services/audit-log.service.ts","../src/types/audit-events.ts","../src/services/login-attempt.service.ts","../src/routes/sessions.routes.ts","../src/routes/products.routes.ts","../src/routes/categories.routes.ts","../src/routes/cart.routes.ts","../src/routes/orders.routes.ts","../src/services/email-templates.service.ts","../src/routes/customers.routes.ts","../src/routes/promoCodes.routes.ts","../src/routes/quotations.routes.ts","../src/services/quotation-activity.service.ts","../src/services/quotation-revision.service.ts","../src/routes/quotation-templates.routes.ts","../src/routes/blogs.routes.ts","../src/routes/settings.routes.ts","../src/routes/analytics.routes.ts","../src/routes/export.routes.ts","../src/routes/import.routes.ts","../src/routes/contact.routes.ts","../src/routes/upload.routes.ts","../src/routes/health.routes.ts","../src/utils/db-health.ts","../src/routes/notifications.routes.ts","../src/routes/search.routes.ts","../src/routes/google-images.routes.ts","../src/routes/pdfTemplates.routes.ts","../src/routes/cron.routes.ts","../src/routes/admin.routes.ts","../src/routes/newsletter.routes.ts"],"sourcesContent":["import { createApp } from '../src/app';\n\n// Create Express app\nconst app = createApp();\n\n// Export for Vercel serverless\nexport default app;\n","import express from 'express';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport morgan from 'morgan';\nimport compression from 'compression';\nimport cookieParser from 'cookie-parser';\n\nimport { config } from './config';\nimport { errorHandler, notFoundHandler, defaultLimiter } from './middleware';\nimport { logger } from './utils/logger';\nimport { generateCsrfToken, doubleCsrfProtection } from './middleware/csrf';\nimport { xssSanitize } from './middleware/xss';\nimport { requestIdMiddleware } from './middleware/request-id';\n\n// Import routes\nimport { router } from './routes';\n\n/**\n * Create Express application\n */\nexport function createApp() {\n  const app = express();\n\n  // Trust proxy for Vercel/cloud deployments\n  app.set('trust proxy', 1);\n\n  // ===========================================\n  // Request Identification\n  // ===========================================\n\n  // Generate unique ID for each request (for audit logging & correlation)\n  app.use(requestIdMiddleware);\n\n  // ===========================================\n  // Security Middleware\n  // ===========================================\n\n  // Helmet - Security headers\n  app.use(helmet());\n\n  // CORS - Use function to dynamically return the correct origin\n  app.use(\n    cors({\n      origin: (origin, callback) => {\n        // Allow requests with no origin (like mobile apps or curl)\n        if (!origin) {\n          return callback(null, true);\n        }\n\n        // Check if the origin is in the allowed list\n        if (config.corsOrigins.includes(origin)) {\n          callback(null, origin); // Return the specific origin\n        } else {\n          callback(new Error('Not allowed by CORS'));\n        }\n      },\n      credentials: true,\n      methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n      allowedHeaders: ['Content-Type', 'Authorization', 'X-Session-ID', 'X-CSRF-Token'],\n    })\n  );\n\n  // Rate limiting\n  app.use(defaultLimiter);\n\n  // ===========================================\n  // Request Processing Middleware\n  // ===========================================\n\n  // Compression\n  app.use(compression());\n\n  // Cookie parsing\n  app.use(cookieParser());\n\n  // Body parsing\n  app.use(express.json({ limit: '10mb' }));\n  app.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n  // XSS Sanitization - Apply after body parsing, before routes\n  app.use(xssSanitize);\n\n  // CSRF Protection - Apply after cookie parser, skip for safe methods and health checks\n  app.use((req, res, next) => {\n    // Skip CSRF for safe methods, health checks, and public auth endpoints\n    const publicAuthPaths = [\n      '/api/auth/login',\n      '/api/auth/admin/login',\n      '/api/auth/register',\n      '/api/auth/forgot-password',\n      '/api/auth/verify-reset-code',\n      '/api/auth/reset-password',\n      '/api/auth/verify-email',\n    ];\n\n    if (\n      ['GET', 'HEAD', 'OPTIONS'].includes(req.method) ||\n      req.path === '/health' ||\n      req.path === '/api/health' ||\n      publicAuthPaths.includes(req.path)\n    ) {\n      return next();\n    }\n    doubleCsrfProtection(req, res, next);\n  });\n\n  // Logging\n  if (config.isDev) {\n    app.use(morgan('dev'));\n  } else {\n    app.use(\n      morgan('combined', {\n        stream: { write: (message: string) => logger.http(message.trim()) },\n      })\n    );\n  }\n\n  // ===========================================\n  // Health Check & CSRF Token\n  // ===========================================\n\n  app.get('/health', (_req, res) => {\n    res.json({\n      status: 'ok',\n      timestamp: new Date().toISOString(),\n      environment: config.env,\n    });\n  });\n\n  // CSRF token endpoint\n  app.get('/api/csrf-token', (req, res) => {\n    const token = generateCsrfToken(req, res);\n    res.json({ csrfToken: token });\n  });\n\n  // ===========================================\n  // API Routes\n  // ===========================================\n\n  app.use('/api', router);\n\n  // ===========================================\n  // Error Handling\n  // ===========================================\n\n  // 404 handler\n  app.use(notFoundHandler);\n\n  // Global error handler\n  app.use(errorHandler);\n\n  return app;\n}\n","import dotenv from 'dotenv';\nimport path from 'path';\n\n// Load environment variables from root .env file\ndotenv.config({ path: path.resolve(__dirname, '../../../../.env') });\n\nexport const config = {\n  // Environment\n  env: process.env['NODE_ENV'] || 'development',\n  isDev: process.env['NODE_ENV'] === 'development',\n  isProd: process.env['NODE_ENV'] === 'production',\n\n  // Server\n  port: parseInt(process.env['API_PORT'] || '4000', 10),\n  apiUrl: process.env['API_URL'] || 'http://localhost:4000',\n\n  // Database\n  databaseUrl: process.env['DATABASE_URL'] || '',\n\n  // JWT\n  jwtSecret: process.env['JWT_SECRET'] as string,\n  jwtExpiresIn: process.env['JWT_EXPIRES_IN'] || '7d',\n\n  // CORS\n  corsOrigins: (process.env['CORS_ORIGINS'] || 'http://localhost:3000,http://localhost:3001')\n    .split(',')\n    .map(origin => origin.trim())\n    .filter(origin => origin.length > 0),\n\n  // ImageKit\n  imagekit: {\n    publicKey: process.env['IMAGEKIT_PUBLIC_KEY'] || '',\n    privateKey: process.env['IMAGEKIT_PRIVATE_KEY'] || '',\n    urlEndpoint: process.env['IMAGEKIT_URL_ENDPOINT'] || '',\n  },\n\n  // SMTP\n  smtp: {\n    host: process.env['SMTP_HOST'] || '',\n    port: parseInt(process.env['SMTP_PORT'] || '587', 10),\n    secure: process.env['SMTP_SECURE'] === 'true',\n    user: process.env['SMTP_USER'] || '',\n    pass: process.env['SMTP_PASS'] || '',\n    from: process.env['EMAIL_FROM'] || 'noreply@lab404electronics.com',\n  },\n\n  // Stripe (Future)\n  stripe: {\n    secretKey: process.env['STRIPE_SECRET_KEY'] || '',\n    webhookSecret: process.env['STRIPE_WEBHOOK_SECRET'] || '',\n  },\n\n  // Google APIs\n  google: {\n    apiKey: process.env['GOOGLE_API_KEY'] || '',\n    searchEngineId: process.env['GOOGLE_SEARCH_ENGINE_ID'] || '',\n  },\n\n  // Store defaults\n  store: {\n    name: process.env['STORE_NAME'] || 'Lab404Electronics',\n    currency: process.env['STORE_CURRENCY'] || 'USD',\n  },\n\n  // URLs\n  urls: {\n    admin: process.env['ADMIN_URL'] || 'http://localhost:3001',\n    web: process.env['WEB_URL'] || 'http://localhost:3000',\n  },\n} as const;\n\n// Validate required config\nexport function validateConfig(): void {\n  const required = [\n    ['DATABASE_URL', config.databaseUrl],\n    ['JWT_SECRET', config.jwtSecret],\n  ];\n\n  const missing = required.filter(([, value]) => !value).map(([name]) => name);\n\n  if (missing.length > 0) {\n    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);\n  }\n\n  // Validate JWT_SECRET length (minimum 32 characters for security)\n  if (config.jwtSecret.length < 32) {\n    throw new Error('JWT_SECRET must be at least 32 characters long. Generate a secure secret with: openssl rand -base64 32');\n  }\n}\n","import { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { ApiError } from '../utils/errors';\nimport { sendError } from '../utils/response';\nimport { logger } from '../utils/logger';\nimport { config } from '../config';\n\n/**\n * Global error handler middleware\n * Catches all errors and sends appropriate responses\n */\nexport function errorHandler(\n  err: Error,\n  req: Request,\n  res: Response,\n  _next: NextFunction\n): Response {\n  // Log error\n  logger.error('Request error', err, {\n    method: req.method,\n    path: req.path,\n    ip: req.ip,\n  });\n\n  // Handle known API errors\n  if (err instanceof ApiError) {\n    return sendError(res, err.statusCode, err.code, err.message, err.details);\n  }\n\n  // Handle Zod validation errors\n  if (err instanceof ZodError) {\n    const details = err.errors.map((e) => ({\n      field: e.path.join('.'),\n      message: e.message,\n    }));\n\n    return sendError(res, 422, 'VALIDATION_ERROR', 'Validation failed', details);\n  }\n\n  // Handle unexpected errors\n  const message = config.isDev ? err.message : 'Internal server error';\n\n  return sendError(res, 500, 'INTERNAL_SERVER_ERROR', message);\n}\n\n/**\n * 404 Not Found handler\n */\nexport function notFoundHandler(req: Request, res: Response): Response {\n  return sendError(res, 404, 'NOT_FOUND', `Route ${req.method} ${req.path} not found`);\n}\n","/**\n * Base API Error class\n * All custom errors should extend this class\n */\nexport class ApiError extends Error {\n  public readonly statusCode: number;\n  public readonly code: string;\n  public readonly details?: Array<{ field: string; message: string }>;\n\n  constructor(\n    statusCode: number,\n    code: string,\n    message: string,\n    details?: Array<{ field: string; message: string }>\n  ) {\n    super(message);\n    this.statusCode = statusCode;\n    this.code = code;\n    this.details = details;\n    this.name = 'ApiError';\n\n    // Maintains proper stack trace for where our error was thrown\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * 400 Bad Request\n */\nexport class BadRequestError extends ApiError {\n  constructor(message = 'Bad request', details?: Array<{ field: string; message: string }>) {\n    super(400, 'BAD_REQUEST', message, details);\n    this.name = 'BadRequestError';\n  }\n}\n\n/**\n * 401 Unauthorized\n */\nexport class UnauthorizedError extends ApiError {\n  constructor(message = 'Unauthorized') {\n    super(401, 'UNAUTHORIZED', message);\n    this.name = 'UnauthorizedError';\n  }\n}\n\n/**\n * 403 Forbidden\n */\nexport class ForbiddenError extends ApiError {\n  constructor(message = 'Forbidden') {\n    super(403, 'FORBIDDEN', message);\n    this.name = 'ForbiddenError';\n  }\n}\n\n/**\n * 404 Not Found\n */\nexport class NotFoundError extends ApiError {\n  constructor(message = 'Resource not found') {\n    super(404, 'NOT_FOUND', message);\n    this.name = 'NotFoundError';\n  }\n}\n\n/**\n * 409 Conflict\n */\nexport class ConflictError extends ApiError {\n  constructor(message = 'Resource already exists') {\n    super(409, 'CONFLICT', message);\n    this.name = 'ConflictError';\n  }\n}\n\n/**\n * 422 Validation Error\n */\nexport class ValidationError extends ApiError {\n  constructor(message = 'Validation failed', details?: Array<{ field: string; message: string }>) {\n    super(422, 'VALIDATION_ERROR', message, details);\n    this.name = 'ValidationError';\n  }\n}\n\n/**\n * 429 Too Many Requests\n */\nexport class TooManyRequestsError extends ApiError {\n  constructor(message = 'Too many requests') {\n    super(429, 'TOO_MANY_REQUESTS', message);\n    this.name = 'TooManyRequestsError';\n  }\n}\n\n/**\n * 500 Internal Server Error\n */\nexport class InternalServerError extends ApiError {\n  constructor(message = 'Internal server error') {\n    super(500, 'INTERNAL_SERVER_ERROR', message);\n    this.name = 'InternalServerError';\n  }\n}\n","import { Response } from 'express';\nimport type { ApiResponse, PaginationMeta } from '@lab404/shared-types';\n\n/**\n * Send a success response\n */\nexport function sendSuccess<T>(\n  res: Response,\n  data: T,\n  statusCode = 200,\n  meta?: PaginationMeta\n): Response {\n  const response: ApiResponse<T> = {\n    success: true,\n    data,\n    ...(meta && { meta }),\n  };\n\n  return res.status(statusCode).json(response);\n}\n\n/**\n * Send a created response (201)\n */\nexport function sendCreated<T>(res: Response, data: T): Response {\n  return sendSuccess(res, data, 201);\n}\n\n/**\n * Send a no content response (204)\n */\nexport function sendNoContent(res: Response): Response {\n  return res.status(204).send();\n}\n\n/**\n * Send an error response\n */\nexport function sendError(\n  res: Response,\n  statusCode: number,\n  code: string,\n  message: string,\n  details?: Array<{ field: string; message: string }>\n): Response {\n  const response: ApiResponse<never> = {\n    success: false,\n    error: {\n      code,\n      message,\n      ...(details && { details }),\n    },\n  };\n\n  return res.status(statusCode).json(response);\n}\n\n/**\n * Create pagination meta from query params\n */\nexport function createPaginationMeta(\n  page: number,\n  limit: number,\n  total: number\n): PaginationMeta {\n  return {\n    page,\n    limit,\n    total,\n    totalPages: Math.ceil(total / limit),\n  };\n}\n\n/**\n * Parse pagination params from query\n * Handles integer overflow by capping values to safe maximums\n */\nexport function parsePaginationParams(query: {\n  page?: string;\n  limit?: string;\n}): { page: number; limit: number; offset: number } {\n  // Parse with safe integer handling\n  let parsedPage = parseInt(query.page || '1', 10);\n  let parsedLimit = parseInt(query.limit || '20', 10);\n\n  // Handle NaN, Infinity, and negative numbers\n  if (!Number.isFinite(parsedPage) || parsedPage < 1) {\n    parsedPage = 1;\n  }\n  if (!Number.isFinite(parsedLimit) || parsedLimit < 1) {\n    parsedLimit = 20;\n  }\n\n  // Cap to reasonable maximums to prevent integer overflow\n  const MAX_PAGE = 1000000; // 1 million pages max\n  const MAX_LIMIT = 100;\n\n  const page = Math.min(MAX_PAGE, Math.max(1, parsedPage));\n  const limit = Math.min(MAX_LIMIT, Math.max(1, parsedLimit));\n  const offset = (page - 1) * limit;\n\n  return { page, limit, offset };\n}\n","import { config } from '../config';\n\ntype LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\ninterface LogContext {\n  [key: string]: unknown;\n}\n\n/**\n * Simple logger utility\n * In production, replace with a proper logging service (Winston, Pino, etc.)\n */\nclass Logger {\n  private formatMessage(level: LogLevel, message: string, context?: LogContext): string {\n    const timestamp = new Date().toISOString();\n    const contextStr = context ? ` ${JSON.stringify(context)}` : '';\n    return `[${timestamp}] [${level.toUpperCase()}] ${message}${contextStr}`;\n  }\n\n  debug(message: string, context?: LogContext): void {\n    if (config.isDev) {\n      console.debug(this.formatMessage('debug', message, context));\n    }\n  }\n\n  info(message: string, context?: LogContext): void {\n    console.info(this.formatMessage('info', message, context));\n  }\n\n  warn(message: string, context?: LogContext): void {\n    console.warn(this.formatMessage('warn', message, context));\n  }\n\n  error(message: string, error?: Error | unknown, context?: LogContext): void {\n    const errorContext: LogContext = { ...context };\n\n    if (error instanceof Error) {\n      errorContext['errorName'] = error.name;\n      errorContext['errorMessage'] = error.message;\n\n      // Only include stack trace in development\n      if (config.isDev) {\n        errorContext['stack'] = error.stack;\n      }\n    } else if (error) {\n      errorContext['error'] = error;\n    }\n\n    console.error(this.formatMessage('error', message, errorContext));\n  }\n\n  /**\n   * Log HTTP request (for morgan custom format)\n   */\n  http(message: string): void {\n    console.log(`[${new Date().toISOString()}] [HTTP] ${message}`);\n  }\n}\n\nexport const logger = new Logger();\n","import { Request, Response, NextFunction } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { validate as uuidValidate } from 'uuid';\nimport { config } from '../config';\nimport { UnauthorizedError, ForbiddenError } from '../utils/errors';\nimport type { AuthUser, UserRole } from '@lab404/shared-types';\nimport { sessionService } from '../services/session.service';\nimport { logger } from '../utils/logger';\n\n// Extend Express Request type to include user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: AuthUser;\n      sessionId?: string;\n    }\n  }\n}\n\ninterface JwtPayload {\n  userId: string;\n  email: string;\n  role: UserRole;\n  customerId?: string;\n  sessionId?: string;\n}\n\n/**\n * Extract JWT token from cookies or Authorization header\n * Prioritizes httpOnly cookie over Bearer token (for migration)\n */\nfunction extractToken(req: Request): string | null {\n  // Try cookie first (secure, httpOnly)\n  const cookieToken = req.cookies?.['auth_token'];\n  if (cookieToken) {\n    return cookieToken;\n  }\n\n  // Fallback to Bearer header (temporary, for backward compatibility)\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader) {\n    return null;\n  }\n\n  const parts = authHeader.split(' ');\n\n  if (parts.length !== 2 || parts[0] !== 'Bearer') {\n    return null;\n  }\n\n  return parts[1] || null;\n}\n\n/**\n * Verify JWT token and return payload\n */\nfunction verifyToken(token: string): JwtPayload {\n  try {\n    return jwt.verify(token, config.jwtSecret) as JwtPayload;\n  } catch {\n    throw new UnauthorizedError('Invalid or expired token');\n  }\n}\n\n/**\n * Optional authentication middleware\n * Sets req.user if valid token is present, but doesn't require it\n */\nexport function optionalAuth(req: Request, _res: Response, next: NextFunction): void {\n  try {\n    const token = extractToken(req);\n\n    if (token) {\n      const payload = verifyToken(token);\n\n      req.user = {\n        id: payload.userId,\n        email: payload.email,\n        role: payload.role,\n        customerId: payload.customerId,\n        sessionId: payload.sessionId,\n      };\n    }\n\n    // Also check for session ID (for guest carts) - validate UUID format\n    const sessionId = req.headers['x-session-id'] as string | undefined;\n    if (sessionId && uuidValidate(sessionId)) {\n      req.sessionId = sessionId;\n    }\n\n    next();\n  } catch {\n    // Ignore errors for optional auth\n    next();\n  }\n}\n\n/**\n * Required authentication middleware\n * Throws UnauthorizedError if no valid token is present\n */\nexport async function requireAuth(req: Request, _res: Response, next: NextFunction): Promise<void> {\n  try {\n    const token = extractToken(req);\n\n    if (!token) {\n      throw new UnauthorizedError('Authentication required');\n    }\n\n    const payload = verifyToken(token);\n\n    // Validate session if sessionId present\n    if (payload.sessionId) {\n      const session = await sessionService.validateSession(payload.sessionId);\n\n      if (!session) {\n        throw new UnauthorizedError('Session not found or expired');\n      }\n\n      if (!session.isActive) {\n        throw new UnauthorizedError('Session has been revoked');\n      }\n\n      // Update activity (async, non-blocking)\n      sessionService.updateActivity(session.id).catch((err) =>\n        logger.error('Failed to update session activity', { sessionId: session.id, error: err })\n      );\n    }\n\n    req.user = {\n      id: payload.userId,\n      email: payload.email,\n      role: payload.role,\n      customerId: payload.customerId,\n      sessionId: payload.sessionId,\n    };\n\n    next();\n  } catch (error) {\n    next(error);\n  }\n}\n\n/**\n * Admin authorization middleware\n * Must be used after requireAuth\n */\nexport function requireAdmin(req: Request, _res: Response, next: NextFunction): void {\n  try {\n    if (!req.user) {\n      throw new UnauthorizedError('Authentication required');\n    }\n\n    if (req.user.role !== 'admin') {\n      throw new ForbiddenError('Admin access required');\n    }\n\n    next();\n  } catch (error) {\n    next(error);\n  }\n}\n\n/**\n * Generate JWT token for user\n */\nexport function generateToken(payload: JwtPayload): string {\n  return jwt.sign(payload, config.jwtSecret, {\n    expiresIn: config.jwtExpiresIn as jwt.SignOptions['expiresIn'],\n    algorithm: 'HS256',\n  });\n}\n\n/**\n * Get token expiration date\n */\nexport function getTokenExpiration(): Date {\n  const expiresIn = config.jwtExpiresIn;\n  const ms = parseDuration(expiresIn);\n  return new Date(Date.now() + ms);\n}\n\n/**\n * Parse duration string to milliseconds\n */\nfunction parseDuration(duration: string): number {\n  const match = duration.match(/^(\\d+)([smhd])$/);\n\n  if (!match) {\n    return 7 * 24 * 60 * 60 * 1000; // Default 7 days\n  }\n\n  const value = parseInt(match[1] || '0', 10);\n  const unit = match[2];\n\n  switch (unit) {\n    case 's':\n      return value * 1000;\n    case 'm':\n      return value * 60 * 1000;\n    case 'h':\n      return value * 60 * 60 * 1000;\n    case 'd':\n      return value * 24 * 60 * 60 * 1000;\n    default:\n      return 7 * 24 * 60 * 60 * 1000;\n  }\n}\n","import { neon } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport * as schema from './schema';\n\n/**\n * Creates a database client instance\n * @param connectionString - The NeonDB connection string\n * @returns Drizzle database instance\n */\nexport function createDb(connectionString: string) {\n  const sql = neon(connectionString);\n  return drizzle(sql, { schema });\n}\n\n/**\n * Type for the database instance\n */\nexport type Database = ReturnType<typeof createDb>;\n\n/**\n * Get database instance (singleton pattern for serverless)\n */\nlet dbInstance: Database | null = null;\n\nexport function getDb(): Database {\n  if (!dbInstance) {\n    const connectionString = process.env['DATABASE_URL'];\n    if (!connectionString) {\n      throw new Error('DATABASE_URL environment variable is not set');\n    }\n    dbInstance = createDb(connectionString);\n  }\n  return dbInstance;\n}\n\n/**\n * Default database instance for easy importing\n */\nexport const db = getDb();\n","// ===========================================\n// Lab404Electronics Database Schema\n// ===========================================\n\n// Categories\nexport * from './categories';\n\n// Products\nexport * from './products';\n\n// Customers\nexport * from './customers';\n\n// Orders\nexport * from './orders';\n\n// Promo Codes\nexport * from './promoCodes';\n\n// Quotations\nexport * from './quotations';\n\n// Blogs\nexport * from './blogs';\n\n// Settings\nexport * from './settings';\n\n// Carts\nexport * from './carts';\n\n// Imports\nexport * from './imports';\n\n// PDF Templates\nexport * from './pdfTemplates';\n\n// Verification Codes\nexport * from './verificationCodes';\n\n// Sessions\nexport * from './sessions';\n\n// Password History\nexport * from './passwordHistory';\n\n// Login Attempts\nexport * from './loginAttempts';\n\n// Breach Checks\nexport * from './breachChecks';\n\n// Security Audit Logs\nexport * from './securityAuditLogs';\n\n// IP Reputation\nexport * from './ipReputation';\n\n// Newsletter\nexport * from './newsletter';\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, type AnyPgColumn } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\n\nexport const categories = pgTable('categories', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  description: text('description'),\n  imageUrl: varchar('image_url', { length: 500 }),\n  parentId: uuid('parent_id').references((): AnyPgColumn => categories.id, { onDelete: 'set null' }),\n  isActive: boolean('is_active').default(true).notNull(),\n  sortOrder: integer('sort_order').default(0).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const categoriesRelations = relations(categories, ({ one, many }) => ({\n  parent: one(categories, {\n    fields: [categories.parentId],\n    references: [categories.id],\n    relationName: 'parentChild',\n  }),\n  children: many(categories, { relationName: 'parentChild' }),\n}));\n\nexport type Category = typeof categories.$inferSelect;\nexport type NewCategory = typeof categories.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, decimal, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { categories } from './categories';\n\n// Enums\nexport const productStatusEnum = pgEnum('product_status', ['draft', 'active', 'archived']);\n\n// Products table\nexport const products = pgTable('products', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  sku: varchar('sku', { length: 100 }).notNull().unique(),\n  barcode: varchar('barcode', { length: 100 }),\n  name: varchar('name', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  description: text('description'),\n  shortDescription: varchar('short_description', { length: 500 }),\n  categoryId: uuid('category_id').references(() => categories.id, { onDelete: 'set null' }),\n  brand: varchar('brand', { length: 255 }),\n\n  // Pricing - base price only, calculations done in backend\n  basePrice: decimal('base_price', { precision: 10, scale: 2 }).notNull(),\n  costPrice: decimal('cost_price', { precision: 10, scale: 2 }),\n  compareAtPrice: decimal('compare_at_price', { precision: 10, scale: 2 }),\n\n  // Physical attributes\n  weight: decimal('weight', { precision: 10, scale: 2 }), // in grams\n  dimensions: jsonb('dimensions').$type<{ width?: number; height?: number; depth?: number }>(),\n\n  // Inventory\n  stockQuantity: integer('stock_quantity').default(0).notNull(),\n  lowStockThreshold: integer('low_stock_threshold').default(5).notNull(),\n  trackInventory: boolean('track_inventory').default(true).notNull(),\n  allowBackorder: boolean('allow_backorder').default(false).notNull(),\n\n  // Media - stored as JSON arrays\n  images: jsonb('images').default([]).$type<Array<{ url: string; alt?: string; width?: number; height?: number }>>(),\n  videos: jsonb('videos').default([]).$type<Array<{ url: string; title?: string }>>(),\n  thumbnailUrl: varchar('thumbnail_url', { length: 500 }),\n\n  // Organization & categorization\n  tags: jsonb('tags').default([]).$type<string[]>(),\n  specifications: jsonb('specifications').default({}).$type<Record<string, string>>(),\n  features: jsonb('features').default([]).$type<string[]>(),\n\n  // SEO\n  metaTitle: varchar('meta_title', { length: 255 }),\n  metaDescription: varchar('meta_description', { length: 500 }),\n\n  // Status & flags\n  status: productStatusEnum('status').default('draft').notNull(),\n  isFeatured: boolean('is_featured').default(false).notNull(),\n  isDigital: boolean('is_digital').default(false).notNull(),\n  requiresShipping: boolean('requires_shipping').default(true).notNull(),\n\n  // Supplier information\n  supplierId: varchar('supplier_id', { length: 255 }),\n  supplierSku: varchar('supplier_sku', { length: 255 }),\n\n  // Import tracking\n  importedFrom: varchar('imported_from', { length: 255 }),\n  externalUrl: varchar('external_url', { length: 500 }),\n\n  // Timestamps\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Product variants table\nexport const productVariants = pgTable('product_variants', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'cascade' }).notNull(),\n  sku: varchar('sku', { length: 100 }).notNull().unique(),\n  name: varchar('name', { length: 255 }).notNull(),\n  options: jsonb('options').notNull().$type<Record<string, string>>(),\n  basePrice: decimal('base_price', { precision: 10, scale: 2 }).notNull(),\n  stockQuantity: integer('stock_quantity').default(0).notNull(),\n  imageUrl: varchar('image_url', { length: 500 }),\n  isActive: boolean('is_active').default(true).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  category: one(categories, {\n    fields: [products.categoryId],\n    references: [categories.id],\n  }),\n  variants: many(productVariants),\n}));\n\nexport const productVariantsRelations = relations(productVariants, ({ one }) => ({\n  product: one(products, {\n    fields: [productVariants.productId],\n    references: [products.id],\n  }),\n}));\n\n// Types\nexport type Product = typeof products.$inferSelect;\nexport type NewProduct = typeof products.$inferInsert;\nexport type ProductVariant = typeof productVariants.$inferSelect;\nexport type NewProductVariant = typeof productVariants.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, jsonb } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\n\n// Customers table\nexport const customers = pgTable('customers', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  authUserId: varchar('auth_user_id', { length: 255 }).unique(),\n  email: varchar('email', { length: 255 }).notNull(),\n  firstName: varchar('first_name', { length: 100 }),\n  lastName: varchar('last_name', { length: 100 }),\n  phone: varchar('phone', { length: 50 }),\n\n  // Authentication\n  passwordHash: varchar('password_hash', { length: 255 }),\n  role: varchar('role', { length: 20 }).default('customer').notNull(), // 'customer' | 'admin'\n\n  // Email verification\n  emailVerified: boolean('email_verified').default(false).notNull(),\n  emailVerifiedAt: timestamp('email_verified_at'),\n\n  // Default addresses stored as JSON\n  defaultShippingAddress: jsonb('default_shipping_address').$type<{\n    firstName: string;\n    lastName: string;\n    company?: string;\n    addressLine1: string;\n    addressLine2?: string;\n    city: string;\n    state?: string;\n    postalCode?: string;\n    country: string;\n    phone?: string;\n  }>(),\n  defaultBillingAddress: jsonb('default_billing_address').$type<{\n    firstName: string;\n    lastName: string;\n    company?: string;\n    addressLine1: string;\n    addressLine2?: string;\n    city: string;\n    state?: string;\n    postalCode?: string;\n    country: string;\n    phone?: string;\n  }>(),\n\n  // Customer data\n  isGuest: boolean('is_guest').default(false).notNull(),\n  isActive: boolean('is_active').default(true).notNull(),\n  acceptsMarketing: boolean('accepts_marketing').default(false).notNull(),\n  notes: text('notes'),\n  tags: varchar('tags', { length: 255 }).array(),\n\n  // Stats (count only, totals calculated)\n  orderCount: integer('order_count').default(0).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Customer addresses table\nexport const addresses = pgTable('addresses', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }).notNull(),\n  type: varchar('type', { length: 50 }).notNull(), // 'shipping' | 'billing'\n  firstName: varchar('first_name', { length: 100 }).notNull(),\n  lastName: varchar('last_name', { length: 100 }).notNull(),\n  company: varchar('company', { length: 255 }),\n  addressLine1: varchar('address_line1', { length: 255 }).notNull(),\n  addressLine2: varchar('address_line2', { length: 255 }),\n  city: varchar('city', { length: 100 }).notNull(),\n  state: varchar('state', { length: 100 }),\n  postalCode: varchar('postal_code', { length: 20 }),\n  country: varchar('country', { length: 100 }).notNull(),\n  phone: varchar('phone', { length: 50 }),\n  isDefault: boolean('is_default').default(false).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const customersRelations = relations(customers, ({ many }) => ({\n  addresses: many(addresses),\n}));\n\nexport const addressesRelations = relations(addresses, ({ one }) => ({\n  customer: one(customers, {\n    fields: [addresses.customerId],\n    references: [customers.id],\n  }),\n}));\n\n// Types\nexport type Customer = typeof customers.$inferSelect;\nexport type NewCustomer = typeof customers.$inferInsert;\nexport type Address = typeof addresses.$inferSelect;\nexport type NewAddress = typeof addresses.$inferInsert;\n","import { pgTable, uuid, varchar, text, integer, timestamp, decimal, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\nimport { promoCodes } from './promoCodes';\n\n// Enums\nexport const orderStatusEnum = pgEnum('order_status', ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']);\nexport const paymentStatusEnum = pgEnum('payment_status', ['pending', 'paid', 'refunded', 'failed']);\nexport const paymentMethodEnum = pgEnum('payment_method', ['cod', 'stripe', 'paypal', 'bank_transfer', 'cash']);\n\n// Address type for JSON columns\ntype AddressJson = {\n  firstName: string;\n  lastName: string;\n  company?: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone?: string;\n};\n\n// Orders table\nexport const orders = pgTable('orders', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  orderNumber: varchar('order_number', { length: 50 }).notNull().unique(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Status tracking\n  status: orderStatusEnum('status').default('pending').notNull(),\n  paymentStatus: paymentStatusEnum('payment_status').default('pending').notNull(),\n\n  // Addresses (snapshot at time of order)\n  shippingAddress: jsonb('shipping_address').notNull().$type<AddressJson>(),\n  billingAddress: jsonb('billing_address').notNull().$type<AddressJson>(),\n\n  // Pricing stored as snapshot (calculated at checkout time)\n  // CRITICAL: These are snapshots, not live calculated values\n  currency: varchar('currency', { length: 3 }).default('USD').notNull(),\n  subtotalSnapshot: decimal('subtotal_snapshot', { precision: 10, scale: 2 }).notNull(),\n  taxRateSnapshot: decimal('tax_rate_snapshot', { precision: 5, scale: 4 }).notNull(),\n  taxAmountSnapshot: decimal('tax_amount_snapshot', { precision: 10, scale: 2 }).notNull(),\n  shippingAmountSnapshot: decimal('shipping_amount_snapshot', { precision: 10, scale: 2 }).default('0').notNull(),\n  discountAmountSnapshot: decimal('discount_amount_snapshot', { precision: 10, scale: 2 }).default('0').notNull(),\n  totalSnapshot: decimal('total_snapshot', { precision: 10, scale: 2 }).notNull(),\n\n  // Promo code used\n  promoCodeId: uuid('promo_code_id').references(() => promoCodes.id, { onDelete: 'set null' }),\n  promoCodeSnapshot: varchar('promo_code_snapshot', { length: 50 }),\n\n  // Payment\n  paymentMethod: paymentMethodEnum('payment_method').default('cod').notNull(),\n\n  // Shipping\n  shippingMethod: varchar('shipping_method', { length: 100 }),\n  trackingNumber: varchar('tracking_number', { length: 255 }),\n  confirmedAt: timestamp('confirmed_at'),\n  processingAt: timestamp('processing_at'),\n  shippedAt: timestamp('shipped_at'),\n  deliveredAt: timestamp('delivered_at'),\n\n  // Notes\n  customerNotes: text('customer_notes'),\n  adminNotes: text('admin_notes'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Order items table\nexport const orderItems = pgTable('order_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  orderId: uuid('order_id').references(() => orders.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'set null' }),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'set null' }),\n\n  // Snapshot data (in case product changes later)\n  productNameSnapshot: varchar('product_name_snapshot', { length: 255 }).notNull(),\n  skuSnapshot: varchar('sku_snapshot', { length: 100 }).notNull(),\n  variantOptionsSnapshot: jsonb('variant_options_snapshot').$type<Record<string, string>>(),\n\n  quantity: integer('quantity').notNull(),\n  unitPriceSnapshot: decimal('unit_price_snapshot', { precision: 10, scale: 2 }).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const ordersRelations = relations(orders, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [orders.customerId],\n    references: [customers.id],\n  }),\n  promoCode: one(promoCodes, {\n    fields: [orders.promoCodeId],\n    references: [promoCodes.id],\n  }),\n  items: many(orderItems),\n}));\n\nexport const orderItemsRelations = relations(orderItems, ({ one }) => ({\n  order: one(orders, {\n    fields: [orderItems.orderId],\n    references: [orders.id],\n  }),\n  product: one(products, {\n    fields: [orderItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [orderItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\n// Types\nexport type Order = typeof orders.$inferSelect;\nexport type NewOrder = typeof orders.$inferInsert;\nexport type OrderItem = typeof orderItems.$inferSelect;\nexport type NewOrderItem = typeof orderItems.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, decimal, pgEnum } from 'drizzle-orm/pg-core';\n\n// Enums\nexport const discountTypeEnum = pgEnum('discount_type', ['percentage', 'fixed_amount']);\n\n// Promo codes table\nexport const promoCodes = pgTable('promo_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  code: varchar('code', { length: 50 }).notNull().unique(),\n  description: text('description'),\n\n  // Discount type\n  discountType: discountTypeEnum('discount_type').notNull(),\n  discountValue: decimal('discount_value', { precision: 10, scale: 2 }).notNull(),\n\n  // Constraints\n  minimumOrderAmount: decimal('minimum_order_amount', { precision: 10, scale: 2 }),\n  maximumDiscountAmount: decimal('maximum_discount_amount', { precision: 10, scale: 2 }),\n  usageLimit: integer('usage_limit'),\n  usageCount: integer('usage_count').default(0).notNull(),\n  usageLimitPerCustomer: integer('usage_limit_per_customer').default(1).notNull(),\n\n  // Validity\n  startsAt: timestamp('starts_at'),\n  expiresAt: timestamp('expires_at'),\n  isActive: boolean('is_active').default(true).notNull(),\n\n  // Restrictions (stored as UUID arrays)\n  appliesToProducts: uuid('applies_to_products').array(),\n  appliesToCategories: uuid('applies_to_categories').array(),\n  customerIds: uuid('customer_ids').array(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type PromoCode = typeof promoCodes.$inferSelect;\nexport type NewPromoCode = typeof promoCodes.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, decimal, jsonb, pgEnum, integer } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\nimport { orders } from './orders';\nimport { pdfTemplates } from './pdfTemplates';\n\n// Enums\nexport const quotationStatusEnum = pgEnum('quotation_status', ['draft', 'sent', 'accepted', 'rejected', 'expired']);\n\n// Address type for JSON column\ntype AddressJson = {\n  firstName: string;\n  lastName: string;\n  company?: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone?: string;\n};\n\n// Quotations table\nexport const quotations = pgTable('quotations', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationNumber: varchar('quotation_number', { length: 50 }).notNull().unique(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Customer info (for non-registered customers)\n  customerName: varchar('customer_name', { length: 255 }).notNull(),\n  customerEmail: varchar('customer_email', { length: 255 }).notNull(),\n  customerPhone: varchar('customer_phone', { length: 50 }),\n  customerCompany: varchar('customer_company', { length: 255 }),\n  customerAddress: jsonb('customer_address').$type<AddressJson>(),\n\n  // Status\n  status: quotationStatusEnum('status').default('draft').notNull(),\n\n  // Validity\n  validUntil: timestamp('valid_until'),\n  validDays: integer('valid_days').default(30),\n\n  // Pricing (calculated at generation time)\n  currency: varchar('currency', { length: 3 }).default('USD').notNull(),\n  subtotal: decimal('subtotal', { precision: 10, scale: 2 }).notNull(),\n  taxRate: decimal('tax_rate', { precision: 5, scale: 4 }),\n  taxAmount: decimal('tax_amount', { precision: 10, scale: 2 }),\n  discountType: varchar('discount_type', { length: 20 }), // 'percentage' or 'fixed'\n  discountValue: decimal('discount_value', { precision: 10, scale: 2 }),\n  discountAmount: decimal('discount_amount', { precision: 10, scale: 2 }).default('0').notNull(),\n  total: decimal('total', { precision: 10, scale: 2 }).notNull(),\n\n  // Notes\n  notes: text('notes'),\n  termsAndConditions: text('terms_and_conditions'),\n\n  // PDF\n  pdfUrl: varchar('pdf_url', { length: 500 }),\n  pdfTemplateId: uuid('pdf_template_id').references(() => pdfTemplates.id, { onDelete: 'set null' }),\n\n  // Converted to order\n  convertedToOrderId: uuid('converted_to_order_id').references(() => orders.id, { onDelete: 'set null' }),\n\n  // Customer acceptance link\n  acceptanceToken: varchar('acceptance_token', { length: 64 }).unique(),\n  tokenExpiresAt: timestamp('token_expires_at'),\n  viewedAt: timestamp('viewed_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Quotation items table\nexport const quotationItems = pgTable('quotation_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'set null' }),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'set null' }),\n\n  // Item details (can be custom items not in catalog)\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  sku: varchar('sku', { length: 100 }),\n  quantity: integer('quantity').notNull(),\n  unitPrice: decimal('unit_price', { precision: 10, scale: 2 }).notNull(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const quotationsRelations = relations(quotations, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [quotations.customerId],\n    references: [customers.id],\n  }),\n  convertedToOrder: one(orders, {\n    fields: [quotations.convertedToOrderId],\n    references: [orders.id],\n  }),\n  pdfTemplate: one(pdfTemplates, {\n    fields: [quotations.pdfTemplateId],\n    references: [pdfTemplates.id],\n  }),\n  items: many(quotationItems),\n}));\n\nexport const quotationItemsRelations = relations(quotationItems, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationItems.quotationId],\n    references: [quotations.id],\n  }),\n  product: one(products, {\n    fields: [quotationItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [quotationItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\n// Quotation activities table (for timeline tracking)\nexport const quotationActivityTypeEnum = pgEnum('quotation_activity_type', [\n  'created',\n  'updated',\n  'sent',\n  'viewed',\n  'accepted',\n  'rejected',\n  'expired',\n  'converted',\n  'duplicated',\n  'pdf_generated',\n  'note_added',\n  'status_changed',\n]);\n\nexport const quotationActorTypeEnum = pgEnum('quotation_actor_type', [\n  'system',\n  'admin',\n  'customer',\n]);\n\nexport const quotationActivities = pgTable('quotation_activities', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n\n  // Activity type\n  activityType: quotationActivityTypeEnum('activity_type').notNull(),\n  description: text('description').notNull(),\n\n  // Who performed the action\n  actorType: quotationActorTypeEnum('actor_type').default('system').notNull(),\n  actorId: uuid('actor_id'), // admin user id or customer id (optional)\n  actorName: varchar('actor_name', { length: 255 }), // Display name\n\n  // Additional metadata (JSON for flexibility)\n  metadata: jsonb('metadata').$type<Record<string, unknown>>(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const quotationActivitiesRelations = relations(quotationActivities, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationActivities.quotationId],\n    references: [quotations.id],\n  }),\n}));\n\n// Quotation templates table\ninterface TemplateItem {\n  productId?: string;\n  name: string;\n  description?: string;\n  sku?: string;\n  quantity: number;\n  unitPrice: number;\n}\n\nexport const quotationTemplates = pgTable('quotation_templates', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n\n  // Template items (stored as JSON)\n  items: jsonb('items').$type<TemplateItem[]>().notNull().default([]),\n\n  // Default pricing settings\n  defaultDiscount: decimal('default_discount', { precision: 10, scale: 2 }),\n  defaultDiscountType: varchar('default_discount_type', { length: 20 }),\n  defaultTaxRate: decimal('default_tax_rate', { precision: 5, scale: 4 }),\n  defaultValidDays: integer('default_valid_days').default(30),\n\n  // Default terms\n  defaultTerms: text('default_terms'),\n\n  isActive: integer('is_active').default(1).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Quotation revisions table (for revision history)\ninterface RevisionSnapshot {\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string | null;\n  customerCompany?: string | null;\n  status: string;\n  subtotal: number;\n  taxRate?: number;\n  taxAmount?: number;\n  discountType?: string | null;\n  discountValue?: number;\n  discountAmount: number;\n  total: number;\n  validUntil?: Date | null;\n  notes?: string | null;\n  termsAndConditions?: string | null;\n  items: Array<{\n    productId?: string | null;\n    variantId?: string | null;\n    name: string;\n    description?: string | null;\n    sku?: string | null;\n    quantity: number;\n    unitPrice: number;\n  }>;\n}\n\nexport const quotationRevisions = pgTable('quotation_revisions', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  quotationId: uuid('quotation_id').references(() => quotations.id, { onDelete: 'cascade' }).notNull(),\n  versionNumber: integer('version_number').notNull(),\n  snapshot: jsonb('snapshot').$type<RevisionSnapshot>().notNull(),\n  changeDescription: text('change_description'),\n  createdBy: uuid('created_by'), // Admin user ID\n  createdByName: varchar('created_by_name', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const quotationRevisionsRelations = relations(quotationRevisions, ({ one }) => ({\n  quotation: one(quotations, {\n    fields: [quotationRevisions.quotationId],\n    references: [quotations.id],\n  }),\n}));\n\n// Types\nexport type Quotation = typeof quotations.$inferSelect;\nexport type NewQuotation = typeof quotations.$inferInsert;\nexport type QuotationItem = typeof quotationItems.$inferSelect;\nexport type NewQuotationItem = typeof quotationItems.$inferInsert;\nexport type QuotationActivity = typeof quotationActivities.$inferSelect;\nexport type NewQuotationActivity = typeof quotationActivities.$inferInsert;\nexport type QuotationTemplate = typeof quotationTemplates.$inferSelect;\nexport type NewQuotationTemplate = typeof quotationTemplates.$inferInsert;\nexport type QuotationRevision = typeof quotationRevisions.$inferSelect;\nexport type NewQuotationRevision = typeof quotationRevisions.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, boolean } from 'drizzle-orm/pg-core';\n\n/**\n * PDF Templates table\n * Stores customizable templates for quotation and invoice PDFs\n */\nexport const pdfTemplates = pgTable('pdf_templates', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: varchar('name', { length: 100 }).notNull(),\n  isDefault: boolean('is_default').default(false).notNull(),\n\n  // Branding\n  logoUrl: varchar('logo_url', { length: 500 }),\n  primaryColor: varchar('primary_color', { length: 7 }).default('#1a1a2e').notNull(),\n  accentColor: varchar('accent_color', { length: 7 }).default('#0066cc').notNull(),\n\n  // Display options\n  showCompanyLogo: boolean('show_company_logo').default(true).notNull(),\n  showLineItemImages: boolean('show_line_item_images').default(false).notNull(),\n  showLineItemDescription: boolean('show_line_item_description').default(false).notNull(),\n  showSku: boolean('show_sku').default(true).notNull(),\n\n  // Custom text\n  headerText: text('header_text'),\n  footerText: text('footer_text'),\n  thankYouMessage: text('thank_you_message'),\n\n  // Metadata\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type PdfTemplate = typeof pdfTemplates.$inferSelect;\nexport type NewPdfTemplate = typeof pdfTemplates.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, pgEnum } from 'drizzle-orm/pg-core';\n\n// Enums\nexport const blogStatusEnum = pgEnum('blog_status', ['draft', 'published', 'archived']);\n\n// Blogs table\nexport const blogs = pgTable('blogs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  title: varchar('title', { length: 255 }).notNull(),\n  slug: varchar('slug', { length: 255 }).notNull().unique(),\n  content: text('content').notNull(),\n  excerpt: varchar('excerpt', { length: 500 }),\n  featuredImageUrl: varchar('featured_image_url', { length: 500 }),\n\n  authorId: uuid('author_id'),\n  authorName: varchar('author_name', { length: 255 }),\n\n  status: blogStatusEnum('status').default('draft').notNull(),\n  publishedAt: timestamp('published_at'),\n\n  // SEO\n  metaTitle: varchar('meta_title', { length: 255 }),\n  metaDescription: varchar('meta_description', { length: 500 }),\n  tags: varchar('tags', { length: 100 }).array(),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Types\nexport type Blog = typeof blogs.$inferSelect;\nexport type NewBlog = typeof blogs.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, jsonb } from 'drizzle-orm/pg-core';\n\n// Settings table\nexport const settings = pgTable('settings', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  key: varchar('key', { length: 100 }).notNull().unique(),\n  value: jsonb('value').notNull(),\n  description: text('description'),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Admin activity log table\nexport const adminActivityLogs = pgTable('admin_activity_logs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  adminUserId: varchar('admin_user_id', { length: 255 }).notNull(),\n  action: varchar('action', { length: 100 }).notNull(),\n  entityType: varchar('entity_type', { length: 100 }).notNull(),\n  entityId: uuid('entity_id'),\n  details: jsonb('details'),\n  ipAddress: varchar('ip_address', { length: 50 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Types\nexport type Setting = typeof settings.$inferSelect;\nexport type NewSetting = typeof settings.$inferInsert;\nexport type AdminActivityLog = typeof adminActivityLogs.$inferSelect;\nexport type NewAdminActivityLog = typeof adminActivityLogs.$inferInsert;\n","import { pgTable, uuid, varchar, integer, timestamp } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\nimport { products, productVariants } from './products';\n\n// Carts table\nexport const carts = pgTable('carts', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n  sessionId: varchar('session_id', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Cart items table\nexport const cartItems = pgTable('cart_items', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  cartId: uuid('cart_id').references(() => carts.id, { onDelete: 'cascade' }).notNull(),\n  productId: uuid('product_id').references(() => products.id, { onDelete: 'cascade' }).notNull(),\n  variantId: uuid('variant_id').references(() => productVariants.id, { onDelete: 'cascade' }),\n  quantity: integer('quantity').notNull().default(1),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// Cart promo codes table (for applied promo codes)\nexport const cartPromoCodes = pgTable('cart_promo_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  cartId: uuid('cart_id').references(() => carts.id, { onDelete: 'cascade' }).notNull().unique(),\n  promoCodeId: uuid('promo_code_id').notNull(),\n  code: varchar('code', { length: 50 }).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// Relations\nexport const cartsRelations = relations(carts, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [carts.customerId],\n    references: [customers.id],\n  }),\n  items: many(cartItems),\n  promoCode: one(cartPromoCodes),\n}));\n\nexport const cartItemsRelations = relations(cartItems, ({ one }) => ({\n  cart: one(carts, {\n    fields: [cartItems.cartId],\n    references: [carts.id],\n  }),\n  product: one(products, {\n    fields: [cartItems.productId],\n    references: [products.id],\n  }),\n  variant: one(productVariants, {\n    fields: [cartItems.variantId],\n    references: [productVariants.id],\n  }),\n}));\n\nexport const cartPromoCodesRelations = relations(cartPromoCodes, ({ one }) => ({\n  cart: one(carts, {\n    fields: [cartPromoCodes.cartId],\n    references: [carts.id],\n  }),\n}));\n\n// Types\nexport type Cart = typeof carts.$inferSelect;\nexport type NewCart = typeof carts.$inferInsert;\nexport type CartItem = typeof cartItems.$inferSelect;\nexport type NewCartItem = typeof cartItems.$inferInsert;\nexport type CartPromoCode = typeof cartPromoCodes.$inferSelect;\nexport type NewCartPromoCode = typeof cartPromoCodes.$inferInsert;\n","import { pgTable, uuid, varchar, text, timestamp, jsonb, pgEnum } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { products } from './products';\n\n// Enums\nexport const importSourceEnum = pgEnum('import_source', ['amazon', 'aliexpress', 'ebay']);\nexport const importStatusEnum = pgEnum('import_status', ['pending', 'processing', 'completed', 'failed']);\n\n// Product import jobs table\nexport const productImportJobs = pgTable('product_import_jobs', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  source: importSourceEnum('source').notNull(),\n  sourceUrl: varchar('source_url', { length: 500 }).notNull(),\n  status: importStatusEnum('status').default('pending').notNull(),\n  importedProductId: uuid('imported_product_id').references(() => products.id, { onDelete: 'set null' }),\n  errorMessage: text('error_message'),\n  rawData: jsonb('raw_data'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  completedAt: timestamp('completed_at'),\n});\n\n// Relations\nexport const productImportJobsRelations = relations(productImportJobs, ({ one }) => ({\n  importedProduct: one(products, {\n    fields: [productImportJobs.importedProductId],\n    references: [products.id],\n  }),\n}));\n\n// Types\nexport type ProductImportJob = typeof productImportJobs.$inferSelect;\nexport type NewProductImportJob = typeof productImportJobs.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, integer, boolean, pgEnum, index } from 'drizzle-orm/pg-core';\n\nexport const verificationCodeTypeEnum = pgEnum('verification_code_type', [\n  'password_reset',\n  'email_verification',\n  'account_unlock'\n]);\n\nexport const verificationCodes = pgTable('verification_codes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  // Code details\n  email: varchar('email', { length: 255 }).notNull(),\n  code: varchar('code', { length: 6 }).notNull(),\n  type: verificationCodeTypeEnum('type').notNull(),\n\n  // Security & tracking\n  attempts: integer('attempts').default(0).notNull(),\n  maxAttempts: integer('max_attempts').default(3).notNull(),\n\n  // Expiration\n  expiresAt: timestamp('expires_at').notNull(),\n\n  // Status tracking\n  isUsed: boolean('is_used').default(false).notNull(),\n  usedAt: timestamp('used_at'),\n\n  // IP tracking\n  ipAddress: varchar('ip_address', { length: 45 }),\n\n  // Timestamps\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n}, (table) => ({\n  emailIdx: index('verification_codes_email_idx').on(table.email),\n  expiresAtIdx: index('verification_codes_expires_at_idx').on(table.expiresAt),\n}));\n\n// Types\nexport type VerificationCode = typeof verificationCodes.$inferSelect;\nexport type NewVerificationCode = typeof verificationCodes.$inferInsert;\nexport type VerificationCodeType = 'password_reset' | 'email_verification' | 'account_unlock';\n","import { pgTable, uuid, varchar, text, timestamp, boolean, decimal, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const sessions = pgTable(\n  'sessions',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id')\n      .notNull()\n      .references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Token tracking\n    tokenHash: varchar('token_hash', { length: 255 }).unique().notNull(),\n\n    // Device information\n    deviceName: varchar('device_name', { length: 100 }),\n    deviceType: varchar('device_type', { length: 50 }), // desktop | mobile | tablet\n    deviceBrowser: varchar('device_browser', { length: 50 }),\n    browserVersion: varchar('browser_version', { length: 50 }),\n    osName: varchar('os_name', { length: 50 }),\n    osVersion: varchar('os_version', { length: 50 }),\n\n    // Network information\n    ipAddress: varchar('ip_address', { length: 45 }).notNull(),\n    ipCountry: varchar('ip_country', { length: 100 }),\n    ipCity: varchar('ip_city', { length: 100 }),\n    ipLatitude: decimal('ip_latitude', { precision: 10, scale: 8 }),\n    ipLongitude: decimal('ip_longitude', { precision: 11, scale: 8 }),\n\n    // Full user agent\n    userAgent: text('user_agent').notNull(),\n\n    // Activity tracking\n    loginAt: timestamp('login_at').notNull().defaultNow(),\n    lastActivityAt: timestamp('last_activity_at').notNull().defaultNow(),\n\n    // Session status\n    isActive: boolean('is_active').default(true).notNull(),\n    revokedAt: timestamp('revoked_at'),\n    revokeReason: varchar('revoke_reason', { length: 100 }), // user_action | security | admin_action\n\n    // Timestamps\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    customerIdx: index('sessions_customer_idx').on(table.customerId),\n    activeIdx: index('sessions_active_idx').on(table.isActive),\n    activityIdx: index('sessions_activity_idx').on(table.lastActivityAt),\n    tokenHashIdx: index('sessions_token_hash_idx').on(table.tokenHash),\n  })\n);\n\nexport type Session = typeof sessions.$inferSelect;\nexport type NewSession = typeof sessions.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const passwordHistory = pgTable(\n  'password_history',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id')\n      .notNull()\n      .references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Password hash (stored to prevent reuse)\n    passwordHash: varchar('password_hash', { length: 255 }).notNull(),\n\n    // Metadata\n    changedAt: timestamp('changed_at').notNull().defaultNow(),\n    ipAddress: varchar('ip_address', { length: 45 }),\n    userAgent: varchar('user_agent', { length: 500 }),\n\n    // Source of change\n    changeReason: varchar('change_reason', { length: 50 }), // user_action | admin_reset | password_reset | forced_change\n  },\n  (table) => ({\n    customerIdx: index('password_history_customer_idx').on(table.customerId),\n    changedAtIdx: index('password_history_changed_at_idx').on(table.changedAt),\n  })\n);\n\nexport type PasswordHistory = typeof passwordHistory.$inferSelect;\nexport type NewPasswordHistory = typeof passwordHistory.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, boolean, integer, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const loginAttempts = pgTable(\n  'login_attempts',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Attempt details\n    email: varchar('email', { length: 255 }).notNull(),\n    success: boolean('success').notNull(),\n    failureReason: varchar('failure_reason', { length: 100 }), // invalid_credentials | account_locked | email_unverified | account_disabled\n\n    // Device and network information\n    ipAddress: varchar('ip_address', { length: 45 }).notNull(),\n    userAgent: varchar('user_agent', { length: 500 }),\n    deviceType: varchar('device_type', { length: 50 }), // desktop | mobile | tablet\n    deviceBrowser: varchar('device_browser', { length: 50 }),\n\n    // Geographic information (optional)\n    ipCountry: varchar('ip_country', { length: 100 }),\n    ipCity: varchar('ip_city', { length: 100 }),\n\n    // Lockout tracking\n    triggeredLockout: boolean('triggered_lockout').default(false).notNull(),\n    consecutiveFailures: integer('consecutive_failures').default(0).notNull(),\n\n    // Timestamp\n    attemptedAt: timestamp('attempted_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    customerIdx: index('login_attempts_customer_idx').on(table.customerId),\n    emailIdx: index('login_attempts_email_idx').on(table.email),\n    attemptedAtIdx: index('login_attempts_attempted_at_idx').on(table.attemptedAt),\n    successIdx: index('login_attempts_success_idx').on(table.success),\n  })\n);\n\nexport type LoginAttempt = typeof loginAttempts.$inferSelect;\nexport type NewLoginAttempt = typeof loginAttempts.$inferInsert;\n","import { pgTable, uuid, varchar, timestamp, integer, boolean, index } from 'drizzle-orm/pg-core';\nimport { customers } from './customers';\n\nexport const breachChecks = pgTable(\n  'breach_checks',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'cascade' }),\n\n    // Password hash prefix (k-anonymity - first 5 chars of SHA-1)\n    passwordHashPrefix: varchar('password_hash_prefix', { length: 5 }).notNull(),\n\n    // Breach status\n    isBreached: boolean('is_breached').notNull(),\n    breachCount: integer('breach_count').default(0).notNull(), // Number of times seen in breaches\n\n    // Check metadata\n    checkedAt: timestamp('checked_at').notNull().defaultNow(),\n    expiresAt: timestamp('expires_at').notNull(), // Cache for 30 days\n\n    // Context\n    checkReason: varchar('check_reason', { length: 50 }), // registration | password_change | password_reset | periodic_check\n    ipAddress: varchar('ip_address', { length: 45 }),\n  },\n  (table) => ({\n    customerIdx: index('breach_checks_customer_idx').on(table.customerId),\n    prefixIdx: index('breach_checks_prefix_idx').on(table.passwordHashPrefix),\n    expiresAtIdx: index('breach_checks_expires_at_idx').on(table.expiresAt),\n  })\n);\n\nexport type BreachCheck = typeof breachChecks.$inferSelect;\nexport type NewBreachCheck = typeof breachChecks.$inferInsert;\n","import { pgTable, uuid, timestamp, varchar, text, jsonb, index } from 'drizzle-orm/pg-core';\n\n/**\n * Security Audit Logs Table\n *\n * Immutable append-only log of all security-critical events.\n * Used for compliance, forensics, and security monitoring.\n *\n * Retention: 90 days\n * Compliance: SOC 2, GDPR, ISO 27001\n */\nexport const securityAuditLogs = pgTable(\n  'security_audit_logs',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    timestamp: timestamp('timestamp').notNull().defaultNow(),\n    eventType: varchar('event_type', { length: 100 }).notNull(),\n\n    // Actor (who performed the action)\n    actorType: varchar('actor_type', { length: 20 }).notNull(), // customer | admin | system\n    actorId: uuid('actor_id'),\n    actorEmail: varchar('actor_email', { length: 255 }),\n\n    // Target (what was acted upon)\n    targetType: varchar('target_type', { length: 50 }),\n    targetId: uuid('target_id'),\n\n    // Action\n    action: varchar('action', { length: 50 }).notNull(),\n    status: varchar('status', { length: 20 }).notNull(), // success | failure | denied\n\n    // Context\n    ipAddress: varchar('ip_address', { length: 45 }),\n    userAgent: text('user_agent'),\n    sessionId: uuid('session_id'),\n    requestId: uuid('request_id'),\n\n    // Event-specific metadata\n    metadata: jsonb('metadata'),\n\n    // Timestamp\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    // Performance indexes for common queries\n    timestampIdx: index('audit_logs_timestamp_idx').on(table.timestamp),\n    eventTypeIdx: index('audit_logs_event_type_idx').on(table.eventType),\n    actorIdx: index('audit_logs_actor_idx').on(table.actorId),\n    ipAddressIdx: index('audit_logs_ip_address_idx').on(table.ipAddress),\n    sessionIdx: index('audit_logs_session_idx').on(table.sessionId),\n  })\n);\n\nexport type SecurityAuditLog = typeof securityAuditLogs.$inferSelect;\nexport type NewSecurityAuditLog = typeof securityAuditLogs.$inferInsert;\n","import { pgTable, uuid, varchar, integer, timestamp, text, boolean, index } from 'drizzle-orm/pg-core';\n\n/**\n * IP Reputation Tracking Table\n *\n * Tracks IP addresses with reputation scores for abuse prevention.\n * Used to identify and block malicious IPs automatically.\n */\nexport const ipReputation = pgTable(\n  'ip_reputation',\n  {\n    id: uuid('id').primaryKey().defaultRandom(),\n    ipAddress: varchar('ip_address', { length: 45 }).notNull().unique(),\n\n    // Reputation scoring\n    reputationScore: integer('reputation_score').notNull().default(100), // 0-100, lower = worse\n\n    // Counters\n    failedLoginAttempts: integer('failed_login_attempts').notNull().default(0),\n    successfulLogins: integer('successful_logins').notNull().default(0),\n    rateLimitViolations: integer('rate_limit_violations').notNull().default(0),\n    abuseReports: integer('abuse_reports').notNull().default(0),\n\n    // Status\n    isBlocked: boolean('is_blocked').default(false).notNull(),\n    blockReason: varchar('block_reason', { length: 255 }),\n    blockedAt: timestamp('blocked_at'),\n    blockedUntil: timestamp('blocked_until'), // Null = permanent block\n\n    // Metadata\n    lastSeenAt: timestamp('last_seen_at').notNull().defaultNow(),\n    firstSeenAt: timestamp('first_seen_at').notNull().defaultNow(),\n    userAgent: text('user_agent'),\n    country: varchar('country', { length: 100 }),\n    notes: text('notes'),\n\n    // Timestamps\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at').notNull().defaultNow(),\n  },\n  (table) => ({\n    ipAddressIdx: index('ip_reputation_ip_address_idx').on(table.ipAddress),\n    isBlockedIdx: index('ip_reputation_is_blocked_idx').on(table.isBlocked),\n    reputationScoreIdx: index('ip_reputation_score_idx').on(table.reputationScore),\n  })\n);\n\nexport type IpReputation = typeof ipReputation.$inferSelect;\nexport type NewIpReputation = typeof ipReputation.$inferInsert;\n","import { pgTable, uuid, varchar, text, boolean, integer, timestamp, jsonb, uniqueIndex } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\nimport { customers } from './customers';\n\n// ===========================================\n// Newsletter Subscribers\n// ===========================================\n\nexport const newsletterSubscribers = pgTable('newsletter_subscribers', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  email: varchar('email', { length: 255 }).notNull(),\n  name: varchar('name', { length: 100 }),\n\n  // Link to customer if they have an account\n  customerId: uuid('customer_id').references(() => customers.id, { onDelete: 'set null' }),\n\n  // Status\n  status: varchar('status', { length: 20 }).default('active').notNull(), // 'active' | 'unsubscribed' | 'bounced'\n\n  // Source of subscription\n  source: varchar('source', { length: 50 }).default('footer').notNull(), // 'footer' | 'checkout' | 'popup' | 'import' | 'admin'\n\n  // Unsubscribe token for secure unsubscribe links\n  unsubscribeToken: varchar('unsubscribe_token', { length: 64 }).notNull(),\n\n  // Timestamps\n  subscribedAt: timestamp('subscribed_at').defaultNow().notNull(),\n  unsubscribedAt: timestamp('unsubscribed_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n}, (table) => [\n  uniqueIndex('newsletter_subscribers_email_idx').on(table.email),\n]);\n\n// ===========================================\n// Newsletter Campaigns\n// ===========================================\n\nexport const newsletterCampaigns = pgTable('newsletter_campaigns', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  // Campaign details\n  name: varchar('name', { length: 255 }).notNull(),\n  subject: varchar('subject', { length: 255 }).notNull(),\n  previewText: varchar('preview_text', { length: 255 }), // Email preview text\n  content: text('content').notNull(), // HTML content\n\n  // Status: draft | scheduled | sending | paused | completed | cancelled\n  status: varchar('status', { length: 20 }).default('draft').notNull(),\n\n  // Sending configuration\n  dailyLimit: integer('daily_limit').default(100).notNull(), // Max emails per day\n  sendTime: varchar('send_time', { length: 5 }), // Preferred send time HH:MM (24h format)\n\n  // Statistics\n  totalRecipients: integer('total_recipients').default(0).notNull(),\n  sentCount: integer('sent_count').default(0).notNull(),\n  failedCount: integer('failed_count').default(0).notNull(),\n  openCount: integer('open_count').default(0).notNull(),\n  clickCount: integer('click_count').default(0).notNull(),\n\n  // Timestamps\n  scheduledAt: timestamp('scheduled_at'), // When to start sending\n  startedAt: timestamp('started_at'), // When sending actually started\n  completedAt: timestamp('completed_at'), // When all emails were sent\n  lastSentAt: timestamp('last_sent_at'), // Last email sent timestamp\n\n  // Created by admin\n  createdBy: uuid('created_by').references(() => customers.id, { onDelete: 'set null' }),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\n// ===========================================\n// Newsletter Sends (Individual email tracking)\n// ===========================================\n\nexport const newsletterSends = pgTable('newsletter_sends', {\n  id: uuid('id').primaryKey().defaultRandom(),\n\n  campaignId: uuid('campaign_id').references(() => newsletterCampaigns.id, { onDelete: 'cascade' }).notNull(),\n  subscriberId: uuid('subscriber_id').references(() => newsletterSubscribers.id, { onDelete: 'cascade' }).notNull(),\n\n  // Email address at time of send (in case subscriber changes email)\n  email: varchar('email', { length: 255 }).notNull(),\n\n  // Status: pending | sent | failed | bounced\n  status: varchar('status', { length: 20 }).default('pending').notNull(),\n\n  // Error tracking\n  errorMessage: text('error_message'),\n  retryCount: integer('retry_count').default(0).notNull(),\n\n  // Engagement tracking\n  openedAt: timestamp('opened_at'),\n  clickedAt: timestamp('clicked_at'),\n\n  // Timestamps\n  scheduledFor: timestamp('scheduled_for'), // When this email should be sent\n  sentAt: timestamp('sent_at'),\n\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\n// ===========================================\n// Relations\n// ===========================================\n\nexport const newsletterSubscribersRelations = relations(newsletterSubscribers, ({ one, many }) => ({\n  customer: one(customers, {\n    fields: [newsletterSubscribers.customerId],\n    references: [customers.id],\n  }),\n  sends: many(newsletterSends),\n}));\n\nexport const newsletterCampaignsRelations = relations(newsletterCampaigns, ({ one, many }) => ({\n  createdByCustomer: one(customers, {\n    fields: [newsletterCampaigns.createdBy],\n    references: [customers.id],\n  }),\n  sends: many(newsletterSends),\n}));\n\nexport const newsletterSendsRelations = relations(newsletterSends, ({ one }) => ({\n  campaign: one(newsletterCampaigns, {\n    fields: [newsletterSends.campaignId],\n    references: [newsletterCampaigns.id],\n  }),\n  subscriber: one(newsletterSubscribers, {\n    fields: [newsletterSends.subscriberId],\n    references: [newsletterSubscribers.id],\n  }),\n}));\n\n// ===========================================\n// Types\n// ===========================================\n\nexport type NewsletterSubscriber = typeof newsletterSubscribers.$inferSelect;\nexport type NewNewsletterSubscriber = typeof newsletterSubscribers.$inferInsert;\n\nexport type NewsletterCampaign = typeof newsletterCampaigns.$inferSelect;\nexport type NewNewsletterCampaign = typeof newsletterCampaigns.$inferInsert;\n\nexport type NewsletterSend = typeof newsletterSends.$inferSelect;\nexport type NewNewsletterSend = typeof newsletterSends.$inferInsert;\n","// ===========================================\n// Lab404Electronics Database Package\n// ===========================================\n\n// Database client\nexport { createDb, getDb, db, type Database } from './client';\n\n// Re-export schema\nexport * from './schema';\n\n// Re-export drizzle-orm utilities to ensure consistent version usage\nexport {\n  sql,\n  eq,\n  ne,\n  gt,\n  gte,\n  lt,\n  lte,\n  and,\n  or,\n  not,\n  like,\n  ilike,\n  isNull,\n  isNotNull,\n  inArray,\n  notInArray,\n  between,\n  desc,\n  asc,\n  count,\n  sum,\n  avg,\n  min,\n  max,\n} from 'drizzle-orm';\n","import { db } from '@lab404/database';\nimport { sessions } from '@lab404/database/schema';\nimport { eq, and, or, lt, desc, ne } from 'drizzle-orm';\nimport bcrypt from 'bcryptjs';\nimport { UAParser } from 'ua-parser-js';\nimport { logger } from '../utils/logger';\n\ninterface CreateSessionOptions {\n  customerId: string;\n  userAgent: string;\n  ipAddress: string;\n}\n\ninterface SessionInfo {\n  id: string;\n  customerId: string;\n  deviceName: string;\n  deviceType: string;\n  deviceBrowser: string;\n  browserVersion: string;\n  osName: string;\n  osVersion: string;\n  ipAddress: string;\n  ipCity: string | null;\n  ipCountry: string | null;\n  loginAt: Date;\n  lastActivityAt: Date;\n  isActive: boolean;\n}\n\nclass SessionService {\n  /**\n   * Parse User-Agent string to extract device information\n   */\n  private parseUserAgent(userAgent: string) {\n    const parser = new UAParser(userAgent);\n    const result = parser.getResult();\n\n    const browser = result.browser.name || 'Unknown Browser';\n    const browserVersion = result.browser.version || '';\n    const os = result.os.name || 'Unknown OS';\n    const osVersion = result.os.version || '';\n    const deviceType = result.device.type || 'desktop'; // desktop | mobile | tablet\n\n    const deviceName = `${browser} on ${os}${osVersion ? ` ${osVersion}` : ''}`;\n\n    return {\n      deviceName,\n      deviceType,\n      deviceBrowser: browser,\n      browserVersion,\n      osName: os,\n      osVersion,\n    };\n  }\n\n  /**\n   * Create new session on login\n   * Returns sessionId for JWT embedding\n   */\n  async createSession(options: CreateSessionOptions): Promise<string> {\n    const { customerId, userAgent, ipAddress } = options;\n\n    // Parse device information\n    const deviceInfo = this.parseUserAgent(userAgent);\n\n    // Create session record (tokenHash will be set after JWT generation)\n    const [session] = await db\n      .insert(sessions)\n      .values({\n        customerId,\n        userAgent,\n        ipAddress,\n        ...deviceInfo,\n        tokenHash: 'pending', // Placeholder, will be updated after token generation\n        loginAt: new Date(),\n        lastActivityAt: new Date(),\n      })\n      .returning();\n\n    logger.info('Session created', {\n      sessionId: session.id,\n      customerId,\n      deviceName: deviceInfo.deviceName,\n      ipAddress,\n    });\n\n    return session.id;\n  }\n\n  /**\n   * Update session with token hash after JWT generation\n   */\n  async setTokenHash(sessionId: string, token: string): Promise<void> {\n    const tokenHash = await bcrypt.hash(token, 10); // 10 rounds (faster than 12)\n\n    await db\n      .update(sessions)\n      .set({ tokenHash, updatedAt: new Date() })\n      .where(eq(sessions.id, sessionId));\n\n    logger.debug('Token hash set for session', { sessionId });\n  }\n\n  /**\n   * Validate session is active\n   */\n  async validateSession(sessionId: string): Promise<SessionInfo | null> {\n    const [session] = await db\n      .select()\n      .from(sessions)\n      .where(and(eq(sessions.id, sessionId), eq(sessions.isActive, true)))\n      .limit(1);\n\n    if (!session) {\n      return null;\n    }\n\n    return {\n      id: session.id,\n      customerId: session.customerId,\n      deviceName: session.deviceName || 'Unknown Device',\n      deviceType: session.deviceType || 'desktop',\n      deviceBrowser: session.deviceBrowser || '',\n      browserVersion: session.browserVersion || '',\n      osName: session.osName || '',\n      osVersion: session.osVersion || '',\n      ipAddress: session.ipAddress,\n      ipCity: session.ipCity,\n      ipCountry: session.ipCountry,\n      loginAt: session.loginAt,\n      lastActivityAt: session.lastActivityAt,\n      isActive: session.isActive,\n    };\n  }\n\n  /**\n   * Update last activity timestamp (async, non-blocking)\n   */\n  async updateActivity(sessionId: string): Promise<void> {\n    await db\n      .update(sessions)\n      .set({ lastActivityAt: new Date(), updatedAt: new Date() })\n      .where(eq(sessions.id, sessionId));\n  }\n\n  /**\n   * Get all active sessions for customer\n   */\n  async getActiveSessions(customerId: string): Promise<SessionInfo[]> {\n    const sessionList = await db\n      .select()\n      .from(sessions)\n      .where(and(eq(sessions.customerId, customerId), eq(sessions.isActive, true)))\n      .orderBy(desc(sessions.lastActivityAt));\n\n    return sessionList.map((session) => ({\n      id: session.id,\n      customerId: session.customerId,\n      deviceName: session.deviceName || 'Unknown Device',\n      deviceType: session.deviceType || 'desktop',\n      deviceBrowser: session.deviceBrowser || '',\n      browserVersion: session.browserVersion || '',\n      osName: session.osName || '',\n      osVersion: session.osVersion || '',\n      ipAddress: session.ipAddress,\n      ipCity: session.ipCity,\n      ipCountry: session.ipCountry,\n      loginAt: session.loginAt,\n      lastActivityAt: session.lastActivityAt,\n      isActive: session.isActive,\n    }));\n  }\n\n  /**\n   * Revoke specific session\n   */\n  async revokeSession(\n    sessionId: string,\n    reason: 'user_action' | 'security' | 'admin_action'\n  ): Promise<void> {\n    await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: reason,\n        updatedAt: new Date(),\n      })\n      .where(eq(sessions.id, sessionId));\n\n    logger.info('Session revoked', { sessionId, reason });\n  }\n\n  /**\n   * Revoke all sessions except current\n   */\n  async revokeOtherSessions(customerId: string, currentSessionId: string): Promise<number> {\n    const result = await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: 'user_action',\n        updatedAt: new Date(),\n      })\n      .where(\n        and(\n          eq(sessions.customerId, customerId),\n          eq(sessions.isActive, true),\n          ne(sessions.id, currentSessionId)\n        )\n      );\n\n    const count = result.rowCount || 0;\n    logger.info('Other sessions revoked', { customerId, count });\n    return count;\n  }\n\n  /**\n   * Revoke all sessions for customer\n   */\n  async revokeAllSessions(customerId: string): Promise<number> {\n    const result = await db\n      .update(sessions)\n      .set({\n        isActive: false,\n        revokedAt: new Date(),\n        revokeReason: 'user_action',\n        updatedAt: new Date(),\n      })\n      .where(and(eq(sessions.customerId, customerId), eq(sessions.isActive, true)));\n\n    const count = result.rowCount || 0;\n    logger.info('All sessions revoked', { customerId, count });\n    return count;\n  }\n\n  /**\n   * Cleanup old/revoked sessions (for cron job)\n   */\n  async cleanupSessions(): Promise<number> {\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n    const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);\n\n    const result = await db\n      .delete(sessions)\n      .where(\n        or(\n          // Revoked sessions older than 30 days\n          and(eq(sessions.isActive, false), lt(sessions.revokedAt, thirtyDaysAgo)),\n          // Inactive sessions older than 7 days\n          and(eq(sessions.isActive, false), lt(sessions.lastActivityAt, sevenDaysAgo)),\n          // Very old sessions (90+ days)\n          lt(sessions.createdAt, ninetyDaysAgo)\n        )\n      );\n\n    const count = result.rowCount || 0;\n    logger.info('Sessions cleaned up', { count });\n    return count;\n  }\n}\n\nexport const sessionService = new SessionService();\n","import { Request, Response, NextFunction } from 'express';\nimport { ZodSchema, ZodError } from 'zod';\nimport { ValidationError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n/**\n * Request validation middleware factory\n * Validates request body, query, or params against a Zod schema\n */\nexport function validate<T>(schema: ZodSchema<T>, source: 'body' | 'query' | 'params' = 'body') {\n  return (req: Request, _res: Response, next: NextFunction): void => {\n    try {\n      const data = req[source];\n      const validated = schema.parse(data);\n\n      // Replace the source data with validated data\n      (req as unknown as Record<string, unknown>)[source] = validated;\n\n      next();\n    } catch (error) {\n      if (error instanceof ZodError) {\n        const details = error.errors.map((e) => ({\n          field: e.path.join('.'),\n          message: e.message,\n          code: e.code,\n        }));\n\n        // Log detailed validation errors for debugging\n        logger.error('Validation failed', {\n          path: req.path,\n          method: req.method,\n          errors: details,\n          receivedData: source === 'body' ? JSON.stringify(req.body).substring(0, 1000) : undefined,\n        });\n\n        next(new ValidationError('Validation failed', details));\n      } else {\n        next(error);\n      }\n    }\n  };\n}\n\n/**\n * Validate request body\n */\nexport function validateBody<T>(schema: ZodSchema<T>) {\n  return validate(schema, 'body');\n}\n\n/**\n * Validate request query parameters\n */\nexport function validateQuery<T>(schema: ZodSchema<T>) {\n  return validate(schema, 'query');\n}\n\n/**\n * Validate request URL parameters\n */\nexport function validateParams<T>(schema: ZodSchema<T>) {\n  return validate(schema, 'params');\n}\n","import rateLimit from 'express-rate-limit';\nimport { sendError } from '../utils/response';\n\n/**\n * Default rate limiter - 100 requests per minute\n */\nexport const defaultLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 100,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Auth rate limiter - Strict limits for authentication endpoints\n * Production: 5 requests per 15 minutes (protects against brute force)\n * Development: 20 requests per 15 minutes (allows testing without being too permissive)\n * For login, register, password reset endpoints\n */\nexport const authLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: process.env['NODE_ENV'] === 'development' ? 20 : 5,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many authentication attempts, please try again later');\n  },\n});\n\n/**\n * API rate limiter - 30 requests per minute\n * For general API endpoints\n */\nexport const apiLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 30,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Strict rate limiter - 10 requests per minute\n * For sensitive operations like checkout\n */\nexport const strictLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 10,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many requests, please try again later');\n  },\n});\n\n/**\n * Cron rate limiter - 10 requests per 15 minutes\n * For cron job endpoints to prevent abuse\n */\nexport const cronLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 10,\n  standardHeaders: true,\n  legacyHeaders: false,\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS', 'Too many cron requests, please try again later');\n  },\n});\n\n/**\n * Verification code rate limiter - 3 requests per hour\n * Rate limited by email address from request body (fallback to IP)\n * For verification code generation endpoints (password reset, email verification)\n */\nexport const verificationLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 hour\n  max: 3, // 3 requests per hour\n\n  // Rate limit by email address from request body, fallback to IP\n  keyGenerator: (req) => {\n    const email = req.body?.email;\n    return email ? email.toLowerCase() : req.ip;\n  },\n\n  standardHeaders: true,\n  legacyHeaders: false,\n\n  handler: (_req, res) => {\n    sendError(res, 429, 'TOO_MANY_REQUESTS',\n      'Too many verification code requests. Please try again in 1 hour.');\n  },\n});\n","import { doubleCsrf } from 'csrf-csrf';\nimport { Request, Response } from 'express';\n\nconst {\n  generateCsrfToken,\n  doubleCsrfProtection,\n} = doubleCsrf({\n  getSecret: () => process.env['CSRF_SECRET'] || process.env['JWT_SECRET'] || '',\n  cookieName: 'x-csrf-token',\n  cookieOptions: {\n    httpOnly: true,\n    sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n    secure: process.env['NODE_ENV'] === 'production',\n    path: '/',\n  },\n  getCsrfTokenFromRequest: (req: Request) => req.headers['x-csrf-token'] as string,\n  getSessionIdentifier: (req: Request) => {\n    // Use session ID if available, otherwise use a combination of user-agent and IP\n    // This is safe because the secret is used for HMAC\n    return req.sessionId || `${req.headers['user-agent']}-${req.ip}`;\n  },\n});\n\n// Export the CSRF functions\nexport { generateCsrfToken, doubleCsrfProtection };\n","import xss, { IFilterXSSOptions } from 'xss';\nimport { Request, Response, NextFunction } from 'express';\n\n/**\n * XSS filter options for strict sanitization (strips all HTML)\n */\nconst strictOptions: IFilterXSSOptions = {\n  whiteList: {}, // No tags allowed\n  stripIgnoreTag: true,\n  stripIgnoreTagBody: ['script', 'style'],\n};\n\n/**\n * XSS filter options for rich content (allows safe HTML)\n */\nconst richContentOptions: IFilterXSSOptions = {\n  whiteList: {\n    p: [], br: [], b: [], i: [], u: [], strong: [], em: [],\n    a: ['href', 'title', 'target'],\n    ul: [], ol: [], li: [],\n    h1: [], h2: [], h3: [], h4: [], h5: [], h6: [],\n    blockquote: [], code: [], pre: [],\n    img: ['src', 'alt', 'title'],\n    span: ['class'], div: ['class'],\n    hr: [],\n    table: [], thead: [], tbody: [], tr: [], th: [], td: [],\n  },\n  stripIgnoreTag: false,\n  stripIgnoreTagBody: ['script'],\n};\n\n/**\n * Sanitize function - recursively sanitizes strings in objects\n */\nconst sanitize = (obj: any, options: IFilterXSSOptions = strictOptions): any => {\n  if (typeof obj === 'string') {\n    return xss(obj, options);\n  }\n  if (Array.isArray(obj)) {\n    return obj.map(item => sanitize(item, options));\n  }\n  if (obj && typeof obj === 'object') {\n    const sanitized: any = {};\n    for (const key in obj) {\n      sanitized[key] = sanitize(obj[key], options);\n    }\n    return sanitized;\n  }\n  return obj;\n};\n\n/**\n * XSS Sanitization Middleware\n * Sanitizes all user input by default (strips all HTML)\n */\nexport const xssSanitize = (req: Request, res: Response, next: NextFunction) => {\n  // Sanitize body\n  if (req.body) {\n    req.body = sanitize(req.body);\n  }\n\n  // Sanitize query params - need to copy properties individually\n  if (req.query) {\n    const sanitizedQuery = sanitize(req.query);\n    for (const key in sanitizedQuery) {\n      req.query[key] = sanitizedQuery[key];\n    }\n  }\n\n  // Sanitize route params - need to copy properties individually\n  if (req.params) {\n    const sanitizedParams = sanitize(req.params);\n    for (const key in sanitizedParams) {\n      req.params[key] = sanitizedParams[key];\n    }\n  }\n\n  next();\n};\n\n/**\n * Sanitize rich content (blogs) - allow safe HTML\n * Use this function explicitly for fields that should allow HTML formatting\n */\nexport const sanitizeRichContent = (html: string): string => {\n  return xss(html, richContentOptions);\n};\n","import { Request, Response, NextFunction } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Request ID Middleware\n *\n * Generates a unique UUID for each request and attaches it to req.id\n * This enables correlation of logs, audit events, and errors across the system\n *\n * Usage:\n * ```ts\n * app.use(requestIdMiddleware);\n * ```\n *\n * The request ID can then be accessed in handlers:\n * ```ts\n * const requestId = req.id;\n * ```\n */\nexport function requestIdMiddleware(req: Request, res: Response, next: NextFunction): void {\n  // Check if request already has an ID (from load balancer/proxy)\n  const existingId = req.get('X-Request-ID');\n\n  // Use existing ID or generate new one\n  const requestId = existingId || uuidv4();\n\n  // Attach to request object\n  (req as any).id = requestId;\n\n  // Also send in response headers for client correlation\n  res.setHeader('X-Request-ID', requestId);\n\n  next();\n}\n","import { Router } from 'express';\n\n// Import route modules\nimport { authRoutes } from './auth.routes';\nimport { sessionsRoutes } from './sessions.routes';\nimport { productsRoutes } from './products.routes';\nimport { categoriesRoutes } from './categories.routes';\nimport { cartRoutes } from './cart.routes';\nimport { ordersRoutes } from './orders.routes';\nimport { customersRoutes } from './customers.routes';\nimport { promoCodesRoutes } from './promoCodes.routes';\nimport { quotationsRoutes } from './quotations.routes';\nimport { quotationTemplatesRoutes } from './quotation-templates.routes';\nimport { blogsRoutes } from './blogs.routes';\nimport { settingsRoutes } from './settings.routes';\nimport { analyticsRoutes } from './analytics.routes';\nimport { exportRoutes } from './export.routes';\nimport { importRoutes } from './import.routes';\nimport { contactRoutes } from './contact.routes';\nimport { uploadRoutes } from './upload.routes';\nimport { healthRoutes } from './health.routes';\nimport notificationsRoutes from './notifications.routes';\nimport { searchRoutes } from './search.routes';\nimport { googleImagesRoutes } from './google-images.routes';\nimport { pdfTemplatesRoutes } from './pdfTemplates.routes';\nimport { cronRoutes } from './cron.routes';\nimport { adminRoutes } from './admin.routes';\nimport { newsletterRoutes } from './newsletter.routes';\n\nexport const router = Router();\n\n// Health check routes (no /api prefix needed, handled at app level too)\nrouter.use('/health', healthRoutes);\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n// Authentication\nrouter.use('/auth', authRoutes);\n\n// Session Management (authenticated only)\nrouter.use('/auth/sessions', sessionsRoutes);\n\n// Products (public read, admin write)\nrouter.use('/products', productsRoutes);\n\n// Search (public search, admin sync)\nrouter.use('/search', searchRoutes);\n\n// Categories (public read, admin write)\nrouter.use('/categories', categoriesRoutes);\n\n// Cart\nrouter.use('/cart', cartRoutes);\n\n// Orders (public create, auth for user orders, admin for all)\nrouter.use('/orders', ordersRoutes);\n\n// Blogs (public read, admin write)\nrouter.use('/blogs', blogsRoutes);\n\n// Settings (public read for public settings, admin for all)\nrouter.use('/settings', settingsRoutes);\n\n// Promo Codes (public validate, admin CRUD)\nrouter.use('/promo-codes', promoCodesRoutes);\n\n// Contact form (public)\nrouter.use('/contact', contactRoutes);\n\n// ===========================================\n// Authenticated Routes\n// ===========================================\n\n// Customers (profile management, admin CRUD)\nrouter.use('/customers', customersRoutes);\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n// Quotations (Admin only)\nrouter.use('/quotations', quotationsRoutes);\n\n// Quotation Templates (Admin only)\nrouter.use('/quotation-templates', quotationTemplatesRoutes);\n\n// Analytics (Admin only)\nrouter.use('/analytics', analyticsRoutes);\n\n// Export (Admin only)\nrouter.use('/export', exportRoutes);\n\n// Import (Admin only)\nrouter.use('/import', importRoutes);\n\n// Upload / Media (Admin only)\nrouter.use('/upload', uploadRoutes);\n\n// Notifications (Admin only)\nrouter.use('/notifications', notificationsRoutes);\n\n// Google Images (Admin only)\nrouter.use('/google-images', googleImagesRoutes);\n\n// PDF Templates (Admin only)\nrouter.use('/pdf-templates', pdfTemplatesRoutes);\n\n// Admin (Admin only)\nrouter.use('/admin', adminRoutes);\n\n// Newsletter (Admin only)\nrouter.use('/newsletter', newsletterRoutes);\n\n// Cron Jobs (Protected by secret)\nrouter.use('/cron', cronRoutes);\n\n// ===========================================\n// API Info\n// ===========================================\n\nrouter.get('/', (_req, res) => {\n  res.json({\n    name: 'Lab404Electronics API',\n    version: '1.0.0',\n    documentation: '/api/docs',\n    endpoints: {\n      // Public\n      auth: '/api/auth',\n      products: '/api/products',\n      search: '/api/search',\n      categories: '/api/categories',\n      cart: '/api/cart',\n      orders: '/api/orders',\n      blogs: '/api/blogs',\n      contact: '/api/contact',\n      health: '/api/health',\n      // Authenticated\n      customers: '/api/customers',\n      // Admin\n      promoCodes: '/api/promo-codes',\n      quotations: '/api/quotations',\n      settings: '/api/settings',\n      analytics: '/api/analytics',\n      export: '/api/export',\n      import: '/api/import',\n      upload: '/api/upload',\n      notifications: '/api/notifications',\n      googleImages: '/api/google-images',\n      newsletter: '/api/newsletter',\n    },\n  });\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport bcrypt from 'bcryptjs';\nimport { getDb, customers, verificationCodes, eq, and, gte, desc } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { authLimiter, verificationLimiter } from '../middleware/rateLimiter';\nimport { requireAuth, generateToken, getTokenExpiration } from '../middleware/auth';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { ConflictError, NotFoundError, UnauthorizedError, BadRequestError } from '../utils/errors';\nimport { verificationCodeService, cartService } from '../services';\nimport { notificationService } from '../services/notification.service';\nimport { sessionService } from '../services/session.service';\nimport { PasswordSecurityService } from '../services/password-security.service';\nimport { LoginAttemptService } from '../services/login-attempt.service';\nimport { auditLogService } from '../services/audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\nimport { xssSanitize } from '../middleware/xss';\nimport { logger } from '../utils/logger';\n\nexport const authRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Common weak passwords to reject\nconst WEAK_PASSWORDS = [\n  '123456', '123456789', 'qwerty', 'password', '12345678',\n  '111111', '1234567890', '1234567', 'password1', '123123',\n  'abc123', 'qwerty123', '1q2w3e4r', 'admin', 'letmein',\n  'welcome', 'monkey', 'dragon', 'master', 'login'\n];\n\n// Sanitize email to prevent SQL injection\nconst sanitizeEmail = (email: string): string => {\n  // Remove any characters that could be used for SQL injection\n  return email.toLowerCase().replace(/['\";\\-\\-\\/\\*\\\\]/g, '').trim();\n};\n\n// Password strength validation\nconst isStrongPassword = (password: string): boolean => {\n  // Check if password is in weak passwords list\n  if (WEAK_PASSWORDS.includes(password.toLowerCase())) {\n    return false;\n  }\n  // Must have at least one uppercase, one lowercase, one number\n  const hasUppercase = /[A-Z]/.test(password);\n  const hasLowercase = /[a-z]/.test(password);\n  const hasNumber = /[0-9]/.test(password);\n  return hasUppercase && hasLowercase && hasNumber;\n};\n\nconst registerSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .max(255)\n    .transform(sanitizeEmail)\n    .refine(\n      (email) => !email.includes('--') && !email.includes('/*') && !email.includes('*/'),\n      { message: 'Invalid email format' }\n    ),\n  password: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(100)\n    .refine(\n      (password) => !WEAK_PASSWORDS.includes(password.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    )\n    .refine(\n      isStrongPassword,\n      { message: 'Password must contain at least one uppercase letter, one lowercase letter, and one number' }\n    ),\n  firstName: z.string().max(100).optional(),\n  lastName: z.string().max(100).optional(),\n  acceptsMarketing: z.boolean().optional().default(false),\n});\n\nconst loginSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  password: z.string().min(1, 'Password is required'),\n});\n\nconst forgotPasswordSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .max(255)\n    .transform(sanitizeEmail),\n});\n\nconst verifyResetCodeSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n});\n\nconst verifyEmailSchema = z.object({\n  email: z.string()\n    .email('Invalid email address')\n    .max(255, 'Email too long')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n});\n\nconst resendVerificationSchema = z.object({\n  email: z.string()\n    .email('Invalid email address')\n    .max(255, 'Email too long')\n    .transform(sanitizeEmail),\n});\n\nconst resetPasswordSchema = z.object({\n  email: z.string()\n    .email('Invalid email format')\n    .transform(sanitizeEmail),\n  code: z.string()\n    .length(6, 'Code must be 6 digits')\n    .regex(/^\\d+$/, 'Code must contain only digits'),\n  newPassword: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(100)\n    .refine(isStrongPassword, {\n      message: 'Password must contain uppercase, lowercase, and number'\n    })\n    .refine(\n      (p) => !WEAK_PASSWORDS.includes(p.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    ),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * POST /api/auth/register\n * Register a new customer account\n */\nauthRoutes.post(\n  '/register',\n  authLimiter,\n  validateBody(registerSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password, firstName, lastName, acceptsMarketing } = req.body;\n      const db = getDb();\n\n      // Check if email already exists\n      const [existing] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()));\n\n      if (existing && !existing.isGuest) {\n        throw new ConflictError('Email already registered');\n      }\n\n      // Hash password\n      const passwordHash = await bcrypt.hash(password, 12);\n\n      // Create customer (or update guest to registered)\n      let customer;\n\n      if (existing && existing.isGuest) {\n        // Convert guest to registered customer\n        const [updated] = await db\n          .update(customers)\n          .set({\n            firstName,\n            lastName,\n            isGuest: false,\n            acceptsMarketing,\n            passwordHash,\n            authUserId: `local_${existing.id}`, // Local auth\n            updatedAt: new Date(),\n          })\n          .where(eq(customers.id, existing.id))\n          .returning();\n        customer = updated;\n      } else {\n        // Create new customer\n        const [created] = await db\n          .insert(customers)\n          .values({\n            email: email.toLowerCase(),\n            firstName,\n            lastName,\n            isGuest: false,\n            acceptsMarketing,\n            passwordHash,\n            authUserId: `local_${Date.now()}`, // Will be updated after insert\n          })\n          .returning();\n        customer = created;\n\n        // Update with proper auth ID\n        if (customer) {\n          await db\n            .update(customers)\n            .set({ authUserId: `local_${customer.id}` })\n            .where(eq(customers.id, customer.id));\n        }\n      }\n\n      if (!customer) {\n        throw new Error('Failed to create or update customer');\n      }\n\n      // Generate verification code\n      const code = await verificationCodeService.createCode({\n        email: customer.email,\n        type: 'email_verification',\n        ipAddress: req.ip,\n        expiryMinutes: 15,\n      });\n\n      // Send verification email (non-blocking)\n      const emailSent = await notificationService.sendEmailVerification({\n        email: customer.email,\n        firstName: customer.firstName,\n        code,\n        expiryMinutes: 15,\n      });\n\n      if (!emailSent) {\n        logger.error('Failed to send verification email', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n      }\n\n      logger.info('Customer registered, verification email sent', {\n        customerId: customer.id,\n        email: customer.email,\n      });\n\n      // Log account creation\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.ACCOUNT_CREATED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'account_registration',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          registrationType: existing && existing.isGuest ? 'guest_conversion' : 'new',\n          emailVerified: false,\n        },\n      });\n\n      // Log email verification sent\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.EMAIL_VERIFICATION_SENT,\n        actorType: ActorType.SYSTEM,\n        targetType: 'customer',\n        targetId: customer.id,\n        action: 'send_verification_email',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          email: customer.email,\n          expiryMinutes: 15,\n        },\n      });\n\n      // NO TOKEN, NO COOKIE - User must verify email first\n      sendSuccess(res, {\n        message: 'Registration successful. Please check your email to verify your account.',\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          emailVerified: false,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n      }, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/login\n * Login with email and password\n */\nauthRoutes.post(\n  '/login',\n  authLimiter,\n  validateBody(loginSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password } = req.body;\n      const normalizedEmail = email.toLowerCase();\n      const db = getDb();\n\n      // Extract device info for logging\n      const deviceInfo = {\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n        userAgent: req.headers['user-agent'],\n      };\n\n      // Check lockout status BEFORE any other checks\n      const lockoutStatus = await LoginAttemptService.checkLockoutStatus(normalizedEmail);\n      if (lockoutStatus.isLocked) {\n        const remainingTime = LoginAttemptService.formatRemainingTime(\n          lockoutStatus.remainingTime || 0\n        );\n\n        logger.warn('Login blocked: Account locked', {\n          email: normalizedEmail,\n          remainingTime,\n        });\n\n        // Log lockout event\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_LOCKED,\n          actorType: ActorType.CUSTOMER,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: {\n            reason: 'account_locked',\n            remainingTime: lockoutStatus.remainingTime,\n            lockoutEndTime: lockoutStatus.lockoutEndTime?.toISOString(),\n          },\n        });\n\n        return sendError(\n          res,\n          403,\n          'ACCOUNT_LOCKED',\n          `Account temporarily locked due to too many failed login attempts. Please try again in ${remainingTime}.`\n        );\n      }\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail));\n\n      if (!customer || customer.isGuest) {\n        // Record failed attempt (no customer ID)\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          null,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'invalid_credentials' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Verify password against stored hash\n      if (!customer.passwordHash) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'no_password_hash' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      const isPasswordValid = await bcrypt.compare(password, customer.passwordHash);\n      if (!isPasswordValid) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'invalid_credentials',\n          deviceInfo\n        );\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.FAILURE,\n          metadata: { reason: 'invalid_password' },\n        });\n\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Check email verification status\n      if (!customer.emailVerified) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'email_unverified',\n          deviceInfo\n        );\n\n        logger.info('Login blocked: Email not verified', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: { reason: 'email_unverified' },\n        });\n\n        return sendError(\n          res,\n          403,\n          'EMAIL_NOT_VERIFIED',\n          'Email not verified. Please check your inbox for the verification code.'\n        );\n      }\n\n      // Check if account is disabled\n      if (!customer.isActive) {\n        await LoginAttemptService.recordAttempt(\n          normalizedEmail,\n          false,\n          customer.id,\n          'account_disabled',\n          deviceInfo\n        );\n\n        logger.warn('Login blocked: Account disabled', {\n          email: customer.email,\n          customerId: customer.id,\n        });\n\n        // Log failed login\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.AUTH_LOGIN_FAILURE,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: normalizedEmail,\n          action: 'login_attempt',\n          status: EventStatus.DENIED,\n          metadata: { reason: 'account_disabled' },\n        });\n\n        throw new UnauthorizedError('Account is disabled. Please contact support.');\n      }\n\n      // Record successful login attempt\n      await LoginAttemptService.recordAttempt(\n        normalizedEmail,\n        true,\n        customer.id,\n        null,\n        deviceInfo\n      );\n\n      // Clear any failed attempts and unlock account\n      await LoginAttemptService.clearFailedAttempts(normalizedEmail);\n\n      // Merge session cart if exists\n      const guestSessionId = req.sessionId || req.headers['x-session-id'] as string;\n      if (guestSessionId) {\n        const mergedItems = await cartService.mergeSessionCart(guestSessionId, customer.id);\n        logger.info('Session cart merged on login', {\n          customerId: customer.id,\n          guestSessionId,\n          itemsMerged: mergedItems,\n        });\n      }\n\n      // Create session\n      const sessionId = await sessionService.createSession({\n        customerId: customer.id,\n        userAgent: req.headers['user-agent'] || '',\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n      });\n\n      // Generate JWT token with sessionId\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: (customer.role || 'customer') as 'customer' | 'admin',\n        customerId: customer.id,\n        sessionId,\n      });\n\n      // Store token hash in session\n      await sessionService.setTokenHash(sessionId, token);\n\n      // Set httpOnly cookie for secure token storage\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      // Log successful login\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.AUTH_LOGIN_SUCCESS,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'login',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          sessionId,\n          deviceType: deviceInfo.userAgent,\n        },\n      });\n\n      logger.info('Login successful', {\n        email: customer.email,\n        customerId: customer.id,\n        sessionId,\n      });\n\n      sendSuccess(res, {\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: (customer.role || 'customer') as 'customer' | 'admin',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/auth/me\n * Get current authenticated user (customer or admin)\n */\nauthRoutes.get('/me', requireAuth, async (req, res, next) => {\n  try {\n    // Prevent caching of auth responses\n    res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n    res.setHeader('Pragma', 'no-cache');\n    res.setHeader('Expires', '0');\n\n    const db = getDb();\n\n    // Handle admin users\n    if (req.user?.role === 'admin') {\n      sendSuccess(res, {\n        id: req.user.id,\n        email: req.user.email,\n        role: 'admin',\n        isAdmin: true,\n      });\n      return;\n    }\n\n    // Handle customer users\n    if (!req.user?.customerId) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.id, req.user.customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    sendSuccess(res, {\n      id: customer.authUserId,\n      email: customer.email,\n      role: req.user.role,\n      customerId: customer.id,\n      firstName: customer.firstName,\n      lastName: customer.lastName,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/auth/logout\n * Logout current user (clear auth cookie)\n */\nauthRoutes.post('/logout', requireAuth, async (req, res, next) => {\n  try {\n    const sessionId = req.user?.sessionId;\n\n    // Revoke session if present\n    if (sessionId) {\n      await sessionService.revokeSession(sessionId, 'user_action');\n      logger.info('Session revoked on logout', {\n        sessionId,\n        customerId: req.user?.customerId,\n      });\n    }\n\n    // Log logout event\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.AUTH_LOGOUT,\n      actorType: ActorType.CUSTOMER,\n      actorId: req.user?.customerId,\n      actorEmail: req.user?.email,\n      action: 'logout',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        sessionId,\n      },\n    });\n\n    // Clear the auth cookie\n    res.clearCookie('auth_token', {\n      httpOnly: true,\n      secure: process.env['NODE_ENV'] === 'production',\n      sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n      domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n      path: '/',\n    });\n\n    sendSuccess(res, { message: 'Logged out successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/auth/admin/login\n * Admin login endpoint\n */\nauthRoutes.post(\n  '/admin/login',\n  authLimiter,\n  validateBody(loginSchema),\n  async (req, res, next) => {\n    try {\n      const { email, password } = req.body;\n      const db = getDb();\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()));\n\n      if (!customer || customer.isGuest) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Verify password against stored hash\n      if (!customer.passwordHash) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      const isPasswordValid = await bcrypt.compare(password, customer.passwordHash);\n      if (!isPasswordValid) {\n        throw new UnauthorizedError('Invalid email or password');\n      }\n\n      // Check if customer has admin role\n      if (customer.role !== 'admin') {\n        throw new UnauthorizedError('Access denied. Admin privileges required.');\n      }\n\n      // Check if account is active\n      if (!customer.isActive) {\n        throw new UnauthorizedError('Account is disabled. Please contact support.');\n      }\n\n      // Check if email is verified\n      if (!customer.emailVerified) {\n        throw new UnauthorizedError('Email not verified. Please verify your email address.');\n      }\n\n      // Create session for admin\n      const sessionId = await sessionService.createSession({\n        customerId: customer.id,\n        userAgent: req.headers['user-agent'] || '',\n        ipAddress: req.ip || req.socket.remoteAddress || '',\n      });\n\n      // Generate JWT token with admin role and sessionId\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'admin',\n        customerId: customer.id,\n        sessionId,\n      });\n\n      // Store token hash in session\n      await sessionService.setTokenHash(sessionId, token);\n\n      // Set httpOnly cookie for secure token storage\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      sendSuccess(res, {\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: 'admin',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/forgot-password\n * Request password reset code\n * Rate limited: 3 requests per hour per email\n */\nauthRoutes.post(\n  '/forgot-password',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(forgotPasswordSchema),\n  async (req, res, next) => {\n    try {\n      const { email } = req.body;\n      const db = getDb();\n\n      // Look up customer by email (case-insensitive)\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, email.toLowerCase()))\n        .limit(1);\n\n      // Security: Always return success (prevent user enumeration)\n      // Process reset only if customer exists, is active, and not guest\n      if (customer && customer.isActive && !customer.isGuest && customer.passwordHash) {\n        // Create verification code\n        const code = await verificationCodeService.createCode({\n          email: customer.email,\n          type: 'password_reset',\n          ipAddress: req.ip,\n          expiryMinutes: 15,\n        });\n\n        // Send verification code email\n        const emailSent = await notificationService.sendVerificationCode({\n          email: customer.email,\n          code,\n          type: 'password_reset',\n          expiryMinutes: 15,\n        });\n\n        if (!emailSent) {\n          logger.error('Failed to send password reset email', {\n            email: customer.email,\n            code\n          });\n        }\n\n        logger.info('Password reset code sent', {\n          email: customer.email,\n          ip: req.ip\n        });\n\n        // Log password reset requested event\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.PASSWORD_RESET_REQUESTED,\n          actorType: ActorType.CUSTOMER,\n          actorId: customer.id,\n          actorEmail: customer.email,\n          action: 'password_reset_request',\n          status: EventStatus.SUCCESS,\n          metadata: {\n            method: 'email_code',\n            expiryMinutes: 15,\n          },\n        });\n      } else {\n        // Log attempt for security monitoring\n        const reason = !customer ? 'not_found'\n          : !customer.isActive ? 'inactive'\n          : customer.isGuest ? 'guest'\n          : !customer.passwordHash ? 'no_password'\n          : 'unknown';\n\n        logger.warn('Password reset attempt for invalid account', {\n          email,\n          reason,\n          ip: req.ip\n        });\n\n        // Small delay to prevent timing attacks\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n\n      // Always return success message (security: no user enumeration)\n      sendSuccess(res, {\n        message: 'If an account exists with this email, a verification code has been sent.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/verify-reset-code\n * Validate password reset code\n * Purpose: Frontend can validate code before showing password reset form\n * Rate limited: 3 requests per hour per email\n */\nauthRoutes.post(\n  '/verify-reset-code',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(verifyResetCodeSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code } = req.body;\n      const db = getDb();\n      const now = new Date();\n\n      // Find the most recent active code for this email/type\n      const [record] = await db\n        .select()\n        .from(verificationCodes)\n        .where(\n          and(\n            eq(verificationCodes.email, email.toLowerCase()),\n            eq(verificationCodes.type, 'password_reset'),\n            eq(verificationCodes.isUsed, false),\n            gte(verificationCodes.expiresAt, now)\n          )\n        )\n        .orderBy(desc(verificationCodes.createdAt))\n        .limit(1);\n\n      if (!record) {\n        logger.warn('Verification code not found or expired', { email, type: 'password_reset' });\n        throw new BadRequestError('Invalid or expired verification code');\n      }\n\n      // Check if max attempts exceeded\n      if (record.attempts >= record.maxAttempts) {\n        logger.warn('Max verification attempts exceeded', { email, type: 'password_reset', attempts: record.attempts });\n        throw new BadRequestError('Maximum verification attempts exceeded. Please request a new code.');\n      }\n\n      // Increment attempts\n      await db\n        .update(verificationCodes)\n        .set({ attempts: record.attempts + 1 })\n        .where(eq(verificationCodes.id, record.id));\n\n      // Validate code\n      if (record.code !== code) {\n        logger.warn('Invalid verification code attempt', { email, type: 'password_reset', attempts: record.attempts + 1 });\n        throw new BadRequestError('Invalid verification code');\n      }\n\n      // Code is valid - DO NOT mark as used (preserves for actual reset)\n      logger.info('Password reset code verified', {\n        email: email.toLowerCase()\n      });\n\n      sendSuccess(res, {\n        valid: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/reset-password\n * Reset password with valid verification code\n * Auto-logins user with new JWT token\n * Rate limited: 5 requests per 15 minutes (authLimiter)\n */\nauthRoutes.post(\n  '/reset-password',\n  authLimiter,\n  xssSanitize,\n  validateBody(resetPasswordSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code, newPassword } = req.body;\n      const normalizedEmail = email.toLowerCase();\n      const db = getDb();\n\n      // Validate code WITHOUT marking as used yet (throws if invalid/expired/max attempts)\n      // We'll mark it as used after password update succeeds\n      const isValid = await verificationCodeService.validateCodeWithoutMarking({\n        email: normalizedEmail,\n        code,\n        type: 'password_reset',\n      });\n\n      if (!isValid) {\n        throw new BadRequestError('Invalid or expired verification code');\n      }\n\n      // Look up customer\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      if (!customer) {\n        logger.error('Customer not found after valid code validation', {\n          email: normalizedEmail\n        });\n        throw new BadRequestError('Invalid verification code');\n      }\n\n      // Additional security checks\n      if (!customer.isActive) {\n        logger.warn('Password reset attempt for inactive account', {\n          customerId: customer.id\n        });\n        throw new BadRequestError('Account is inactive');\n      }\n\n      if (customer.isGuest) {\n        logger.warn('Password reset attempt for guest account', {\n          customerId: customer.id\n        });\n        throw new BadRequestError('Invalid account type');\n      }\n\n      // Validate new password with security checks\n      const userInputs = [customer.email, customer.firstName, customer.lastName].filter(Boolean) as string[];\n      const validation = await PasswordSecurityService.validatePassword(\n        newPassword,\n        customer.id,\n        userInputs\n      );\n\n      if (!validation.isValid) {\n        logger.warn('Password reset rejected due to security checks', {\n          customerId: customer.id,\n          errors: validation.errors\n        });\n\n        // Build helpful error message that guides user to try again\n        const errorMessage = validation.errors.join('. ') + ' You can try again with a different password using the same verification code.';\n        throw new BadRequestError(errorMessage);\n      }\n\n      // Hash new password\n      const passwordHash = await bcrypt.hash(newPassword, 12);\n\n      // Update password\n      await db\n        .update(customers)\n        .set({\n          passwordHash,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customer.id));\n\n      // Record password change in history\n      await PasswordSecurityService.recordPasswordChange({\n        customerId: customer.id,\n        passwordHash,\n        changeReason: 'password_reset',\n        ipAddress: req.ip || req.socket.remoteAddress,\n        userAgent: req.headers['user-agent'],\n      });\n\n      // Mark verification code as used (only after password update succeeded)\n      await verificationCodeService.markCodeAsUsed(normalizedEmail, 'password_reset');\n\n      // Log password reset completed event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.PASSWORD_RESET_COMPLETED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'password_reset_complete',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          method: 'email_code',\n          strengthScore: validation.strengthResult?.score,\n        },\n      });\n\n      // Invalidate all password_reset codes for this email\n      await verificationCodeService.invalidateCodes(\n        normalizedEmail,\n        'password_reset'\n      );\n\n      // Send password changed confirmation email (non-blocking)\n      const emailSent = await notificationService.sendPasswordChangedConfirmation({\n        email: customer.email,\n        firstName: customer.firstName,\n        timestamp: new Date(),\n        ipAddress: req.ip,\n      });\n\n      if (!emailSent) {\n        logger.error('Failed to send password changed email', {\n          email: customer.email,\n          customerId: customer.id\n        });\n        // Continue - don't fail the password reset if email fails\n      }\n\n      // Generate new JWT token (auto-login)\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'customer',\n        customerId: customer.id,\n      });\n\n      // Set auth cookie\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        domain: process.env['NODE_ENV'] === 'production' ? '.lab404electronics.com' : undefined,\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      logger.info('Password reset successful', {\n        customerId: customer.id,\n        email: customer.email\n      });\n\n      // Return user object and token (same as login)\n      sendSuccess(res, {\n        message: 'Password reset successfully',\n        user: {\n          id: customer.authUserId,\n          email: customer.email,\n          role: 'customer',\n          customerId: customer.id,\n          firstName: customer.firstName,\n          lastName: customer.lastName,\n        },\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/verify-email\n * Verify email address with code and auto-login\n *\n * Request body:\n * {\n *   email: string,\n *   code: string\n * }\n *\n * Response:\n * {\n *   user: { id, email, emailVerified, firstName, lastName },\n *   token: string,\n *   expiresAt: string\n * }\n *\n * Rate limit: 3 requests per hour (via verificationLimiter)\n * Security: Auto-login after successful verification\n */\nauthRoutes.post(\n  '/verify-email',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(verifyEmailSchema),\n  async (req, res, next) => {\n    try {\n      const { email, code } = req.body;\n      const normalizedEmail = email.toLowerCase().trim();\n      const db = getDb();\n\n      // Validate verification code\n      const isValid = await verificationCodeService.validateCode({\n        email: normalizedEmail,\n        code,\n        type: 'email_verification',\n      });\n\n      if (!isValid) {\n        return sendError(res, 400, 'INVALID_CODE', 'Invalid or expired verification code.');\n      }\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      if (!customer || customer.isGuest) {\n        return sendError(res, 400, 'INVALID_CODE', 'Invalid verification code.');\n      }\n\n      // Check if already verified\n      if (customer.emailVerified) {\n        return sendError(res, 400, 'ALREADY_VERIFIED', 'Email already verified.');\n      }\n\n      // Update customer: mark email as verified\n      await db\n        .update(customers)\n        .set({\n          emailVerified: true,\n          emailVerifiedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customer.id));\n\n      // Invalidate all email_verification codes for this email\n      await verificationCodeService.invalidateCodes(\n        normalizedEmail,\n        'email_verification'\n      );\n\n      logger.info('Email verified successfully', {\n        email: customer.email,\n        customerId: customer.id,\n      });\n\n      // Log account verified event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.ACCOUNT_VERIFIED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customer.id,\n        actorEmail: customer.email,\n        action: 'email_verification',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          verificationMethod: 'email_code',\n          verifiedAt: new Date().toISOString(),\n        },\n      });\n\n      // Generate JWT token (auto-login after verification)\n      const token = generateToken({\n        userId: customer.authUserId!,\n        email: customer.email,\n        role: 'customer',\n        customerId: customer.id,\n      });\n\n      // Set httpOnly cookie\n      res.cookie('auth_token', token, {\n        httpOnly: true,\n        secure: process.env['NODE_ENV'] === 'production',\n        sameSite: process.env['NODE_ENV'] === 'production' ? 'none' : 'lax',\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      });\n\n      const user = {\n        id: customer.authUserId,\n        email: customer.email,\n        emailVerified: true,\n        firstName: customer.firstName,\n        lastName: customer.lastName,\n        phone: customer.phone,\n        role: 'customer',\n        customerId: customer.id,\n      };\n\n      sendSuccess(res, {\n        message: 'Email verified successfully',\n        user,\n        token,\n        expiresAt: getTokenExpiration().toISOString(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/resend-verification\n * Resend email verification code\n *\n * Request body:\n * {\n *   email: string\n * }\n *\n * Response:\n * {\n *   message: string (generic success message)\n * }\n *\n * Rate limit: 3 requests per hour (via verificationLimiter)\n * Security: No user enumeration, always returns success\n */\nauthRoutes.post(\n  '/resend-verification',\n  verificationLimiter,\n  xssSanitize,\n  validateBody(resendVerificationSchema),\n  async (req, res, next) => {\n    try {\n      const { email } = req.body;\n      const normalizedEmail = email.toLowerCase().trim();\n      const db = getDb();\n\n      // Find customer by email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.email, normalizedEmail))\n        .limit(1);\n\n      // Only send if account exists, is not guest, and is not verified\n      if (customer && !customer.isGuest && !customer.emailVerified) {\n        // Invalidate previous codes\n        await verificationCodeService.invalidateCodes(\n          normalizedEmail,\n          'email_verification'\n        );\n\n        // Generate new verification code\n        const code = await verificationCodeService.createCode({\n          email: customer.email,\n          type: 'email_verification',\n          ipAddress: req.ip,\n          expiryMinutes: 15,\n        });\n\n        // Send verification email\n        const emailSent = await notificationService.sendEmailVerification({\n          email: customer.email,\n          firstName: customer.firstName,\n          code,\n          expiryMinutes: 15,\n        });\n\n        if (!emailSent) {\n          logger.error('Failed to send verification email', {\n            email: customer.email,\n            customerId: customer.id,\n          });\n        } else {\n          logger.info('Verification email resent', {\n            email: customer.email,\n            customerId: customer.id,\n          });\n        }\n      }\n\n      // Always return success (no user enumeration)\n      sendSuccess(res, {\n        message: 'If an unverified account exists, a verification code has been sent.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/password/check\n * Check password strength and breach status\n *\n * Request body:\n * {\n *   password: string,\n *   email?: string,        // Optional: for personalized feedback\n *   customerId?: string    // Optional: for history checking\n * }\n *\n * Response:\n * {\n *   score: number,         // 0-4 (zxcvbn)\n *   feedback: {\n *     warning: string,\n *     suggestions: string[]\n *   },\n *   crackTime: string,\n *   isBreached: boolean,\n *   breachCount: number,\n *   isReused: boolean\n * }\n *\n * Rate limit: 10 requests per 15 minutes\n */\nconst passwordCheckSchema = z.object({\n  password: z.string().min(1),\n  email: z.string().email().optional(),\n  customerId: z.string().uuid().optional(),\n});\n\nauthRoutes.post(\n  '/password/check',\n  authLimiter,\n  validateBody(passwordCheckSchema),\n  async (req, res, next) => {\n    try {\n      const { password, email, customerId } = req.body;\n\n      // Build user inputs for personalized feedback\n      const userInputs: string[] = [];\n      if (email) {\n        userInputs.push(email);\n        const emailParts = email.split('@');\n        userInputs.push(emailParts[0]); // Add username part\n      }\n\n      // If customerId provided, check history and breach\n      let result;\n      if (customerId) {\n        const validation = await PasswordSecurityService.validatePassword(\n          password,\n          customerId,\n          userInputs\n        );\n        result = validation.strengthResult;\n      } else {\n        // New user - just check strength and breach\n        const validation = await PasswordSecurityService.validateNewPassword(\n          password,\n          userInputs\n        );\n        result = validation.strengthResult;\n      }\n\n      sendSuccess(res, result);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import slugify from 'slugify';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Generate a URL-friendly slug from a string\n */\nexport function generateSlug(text: string): string {\n  return slugify(text, {\n    lower: true,\n    strict: true,\n    trim: true,\n  });\n}\n\n/**\n * Generate a unique slug by appending a random suffix\n */\nexport function generateUniqueSlug(text: string): string {\n  const baseSlug = generateSlug(text);\n  const suffix = uuidv4().slice(0, 8);\n  return `${baseSlug}-${suffix}`;\n}\n\n/**\n * Generate an order number\n * Format: LAB-YYYY-NNNN\n */\nexport function generateOrderNumber(sequence: number): string {\n  const year = new Date().getFullYear();\n  const paddedSequence = String(sequence).padStart(4, '0');\n  return `LAB-${year}-${paddedSequence}`;\n}\n\n/**\n * Generate a quotation number\n * Format: QUO-YYYY-NNNN\n */\nexport function generateQuotationNumber(sequence: number): string {\n  const year = new Date().getFullYear();\n  const paddedSequence = String(sequence).padStart(4, '0');\n  return `QUO-${year}-${paddedSequence}`;\n}\n\n/**\n * Generate a random SKU\n * Format: LAB-XXXXXX\n */\nexport function generateSku(): string {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let sku = 'LAB-';\n  for (let i = 0; i < 6; i++) {\n    sku += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return sku;\n}\n\n/**\n * Round a number to specified decimal places\n */\nexport function round(value: number, decimals = 2): number {\n  const factor = Math.pow(10, decimals);\n  return Math.round(value * factor) / factor;\n}\n\n/**\n * Format a price with currency symbol\n */\nexport function formatPrice(amount: number, currency = 'USD'): string {\n  return new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency,\n  }).format(amount);\n}\n\n/**\n * Mask email address for privacy\n * example@domain.com -> e***e@domain.com\n */\nexport function maskEmail(email: string): string {\n  const [name, domain] = email.split('@');\n  if (!name || !domain) {return email;}\n\n  if (name.length <= 2) {\n    return `${name[0]}***@${domain}`;\n  }\n\n  return `${name[0]}***${name[name.length - 1]}@${domain}`;\n}\n\n/**\n * Mask phone number for privacy\n * +1234567890 -> +123****890\n */\nexport function maskPhone(phone: string): string {\n  if (phone.length < 7) {return phone;}\n\n  const start = phone.slice(0, 3);\n  const end = phone.slice(-3);\n  return `${start}****${end}`;\n}\n\n/**\n * Check if a string is a valid UUID\n */\nexport function isValidUuid(str: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(str);\n}\n\n/**\n * Omit specified keys from an object\n */\nexport function omit<T extends object, K extends keyof T>(\n  obj: T,\n  keys: K[]\n): Omit<T, K> {\n  const result = { ...obj };\n  for (const key of keys) {\n    delete result[key];\n  }\n  return result;\n}\n\n/**\n * Pick specified keys from an object\n */\nexport function pick<T extends object, K extends keyof T>(\n  obj: T,\n  keys: K[]\n): Pick<T, K> {\n  const result = {} as Pick<T, K>;\n  for (const key of keys) {\n    if (key in obj) {\n      result[key] = obj[key];\n    }\n  }\n  return result;\n}\n","import { getDb, products, productVariants, promoCodes, settings, eq, inArray } from '@lab404/database';\nimport type { CartCalculation, DiscountType } from '@lab404/shared-types';\nimport { round } from '../utils/helpers';\nimport { BadRequestError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n/**\n * Cart item input for calculation\n */\ninterface CartItemInput {\n  id?: string;        // Cart item database ID (for frontend operations)\n  productId: string;\n  variantId?: string;\n  quantity: number;\n}\n\n/**\n * Promo code validation result\n */\ninterface PromoCodeResult {\n  id: string;\n  code: string;\n  discountType: DiscountType;\n  discountValue: number;\n  minimumOrderAmount?: number;\n  maximumDiscountAmount?: number;\n  appliesToProducts: string[] | null;\n  appliesToCategories: string[] | null;\n}\n\n/**\n * Internal cart item with category info for promo calculation\n */\ninterface CartItemWithCategory {\n  productId: string;\n  categoryId: string | null;\n  lineTotal: number;\n}\n\n/**\n * CRITICAL: Pricing Service\n *\n * This service handles ALL price calculations.\n * NEVER calculate prices on the client side.\n * NEVER trust price values from client requests.\n *\n * All calculations are done using:\n * 1. Current product prices from database\n * 2. Tax rate from settings\n * 3. Validated promo codes\n */\nexport class PricingService {\n  private db = getDb();\n\n  /**\n   * Calculate cart totals\n   * This is the main method for cart calculation\n   *\n   * @param items - Cart items with product/variant IDs and quantities\n   * @param promoCode - Optional promo code to apply\n   * @returns Complete cart calculation with all totals\n   */\n  async calculateCart(\n    items: CartItemInput[],\n    promoCode?: string\n  ): Promise<CartCalculation> {\n    if (items.length === 0) {\n      return this.emptyCartCalculation();\n    }\n\n    // 1. Fetch current product prices from database\n    const productIds = items.map((item) => item.productId);\n    const productData = await this.db\n      .select()\n      .from(products)\n      .where(inArray(products.id, productIds));\n\n    // 2. Fetch variant prices if any variants are specified\n    const variantIds = items\n      .filter((item) => item.variantId)\n      .map((item) => item.variantId as string);\n\n    let variantData: Array<typeof productVariants.$inferSelect> = [];\n    if (variantIds.length > 0) {\n      variantData = await this.db\n        .select()\n        .from(productVariants)\n        .where(inArray(productVariants.id, variantIds));\n    }\n\n    // 3. Build cart items with current prices\n    const calculatedItems = items.map((item) => {\n      const product = productData.find((p) => p.id === item.productId);\n\n      if (!product) {\n        throw new BadRequestError(`Product not found: ${item.productId}`);\n      }\n\n      if (product.status !== 'active') {\n        throw new BadRequestError(`Product is not available: ${product.name}`);\n      }\n\n      let unitPrice = Number(product.basePrice);\n      let variant;\n\n      // If variant is specified, use variant price\n      if (item.variantId) {\n        variant = variantData.find((v) => v.id === item.variantId);\n\n        if (!variant) {\n          throw new BadRequestError(`Variant not found: ${item.variantId}`);\n        }\n\n        if (!variant.isActive) {\n          throw new BadRequestError(`Variant is not available: ${variant.name}`);\n        }\n\n        unitPrice = Number(variant.basePrice);\n      }\n\n      // Check stock\n      const stockQuantity = variant?.stockQuantity ?? product.stockQuantity;\n      const inStock = stockQuantity > 0 || product.allowBackorder;\n\n      if (!inStock) {\n        throw new BadRequestError(`Product is out of stock: ${product.name}`);\n      }\n\n      if (item.quantity > stockQuantity && !product.allowBackorder) {\n        throw new BadRequestError(\n          `Not enough stock for ${product.name}. Available: ${stockQuantity}`\n        );\n      }\n\n      const lineTotal = round(unitPrice * item.quantity, 2);\n\n      return {\n        id: item.id || item.variantId || item.productId,\n        productId: item.productId,\n        variantId: item.variantId,\n        product: {\n          id: product.id,\n          name: product.name,\n          slug: product.slug,\n          sku: product.sku,\n          thumbnailUrl: this.getProductImage(product),\n          basePrice: unitPrice,\n          stockQuantity,\n          inStock,\n        },\n        variant: variant\n          ? {\n              id: variant.id,\n              name: variant.name,\n              sku: variant.sku,\n              options: variant.options as Record<string, string>,\n              basePrice: Number(variant.basePrice),\n            }\n          : undefined,\n        quantity: item.quantity,\n        unitPrice,\n        lineTotal,\n      };\n    });\n\n    // 4. Calculate subtotal from database prices\n    const subtotal = round(\n      calculatedItems.reduce((sum, item) => sum + item.lineTotal, 0),\n      2\n    );\n\n    // 5. Build category mapping for promo code restrictions\n    const itemsWithCategory: CartItemWithCategory[] = calculatedItems.map((item) => {\n      const product = productData.find((p) => p.id === item.productId);\n      return {\n        productId: item.productId,\n        categoryId: product?.categoryId || null,\n        lineTotal: item.lineTotal,\n      };\n    });\n\n    // 6. Validate and calculate promo code discount\n    let discountAmount = 0;\n    let eligibleItemIds: string[] = [];\n    let promoCodeResult: PromoCodeResult | undefined;\n\n    if (promoCode) {\n      promoCodeResult = await this.validatePromoCode(promoCode, subtotal);\n\n      if (promoCodeResult) {\n        const discountResult = this.calculateDiscount(promoCodeResult, itemsWithCategory);\n        discountAmount = discountResult.discountAmount;\n        eligibleItemIds = discountResult.eligibleItemIds;\n      }\n    }\n\n    // 7. Get tax rate from settings\n    const taxRate = await this.getTaxRate();\n\n    // 8. Calculate tax (IMPORTANT: tax applies to discounted amount, not original subtotal)\n    // This is standard practice: customers pay tax on what they actually pay\n    // Formula: taxAmount = (subtotal - discount) * taxRate\n    const taxableAmount = subtotal - discountAmount;\n    const taxAmount = round(taxableAmount * taxRate, 2);\n\n    // 9. Calculate shipping (can be extended later)\n    const shippingAmount = 0; // Free shipping for now\n\n    // 10. Calculate final total\n    // Formula: total = (subtotal - discount) + tax + shipping\n    // Simplified: total = taxableAmount + taxAmount + shippingAmount\n    const total = round(taxableAmount + taxAmount + shippingAmount, 2);\n\n    // 11. Calculate item count\n    const itemCount = calculatedItems.reduce((sum, item) => sum + item.quantity, 0);\n\n    return {\n      items: calculatedItems,\n      itemCount,\n      subtotal,\n      taxRate,\n      taxAmount,\n      shippingAmount,\n      discountAmount,\n      promoCode: promoCodeResult?.code,\n      promoCodeId: promoCodeResult?.id,\n      eligibleItemIds: eligibleItemIds.length > 0 ? eligibleItemIds : undefined,\n      total,\n      currency: 'USD',\n    };\n  }\n\n  /**\n   * Calculate order totals for checkout\n   * Similar to calculateCart but creates snapshots for order creation\n   */\n  async calculateOrderTotals(\n    items: CartItemInput[],\n    promoCode?: string\n  ): Promise<{\n    subtotal: number;\n    taxRate: number;\n    taxAmount: number;\n    shippingAmount: number;\n    discountAmount: number;\n    total: number;\n    promoCodeId?: string;\n    promoCodeSnapshot?: string;\n  }> {\n    const cartCalc = await this.calculateCart(items, promoCode);\n\n    return {\n      subtotal: cartCalc.subtotal,\n      taxRate: cartCalc.taxRate,\n      taxAmount: cartCalc.taxAmount,\n      shippingAmount: cartCalc.shippingAmount,\n      discountAmount: cartCalc.discountAmount,\n      total: cartCalc.total,\n      promoCodeId: cartCalc.promoCodeId,\n      promoCodeSnapshot: cartCalc.promoCode,\n    };\n  }\n\n  /**\n   * Validate a promo code\n   */\n  async validatePromoCode(\n    code: string,\n    subtotal: number\n  ): Promise<PromoCodeResult | undefined> {\n    const [promoCodeData] = await this.db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.code, code.toUpperCase()));\n\n    if (!promoCodeData) {\n      return undefined;\n    }\n\n    // Check if active\n    if (!promoCodeData.isActive) {\n      return undefined;\n    }\n\n    // Check dates\n    const now = new Date();\n\n    if (promoCodeData.startsAt && new Date(promoCodeData.startsAt) > now) {\n      return undefined;\n    }\n\n    if (promoCodeData.expiresAt && new Date(promoCodeData.expiresAt) < now) {\n      return undefined;\n    }\n\n    // Check usage limit\n    if (\n      promoCodeData.usageLimit !== null &&\n      promoCodeData.usageCount >= promoCodeData.usageLimit\n    ) {\n      return undefined;\n    }\n\n    // Check minimum order amount\n    if (\n      promoCodeData.minimumOrderAmount !== null &&\n      subtotal < Number(promoCodeData.minimumOrderAmount)\n    ) {\n      return undefined;\n    }\n\n    return {\n      id: promoCodeData.id,\n      code: promoCodeData.code,\n      discountType: promoCodeData.discountType,\n      discountValue: Number(promoCodeData.discountValue),\n      minimumOrderAmount: promoCodeData.minimumOrderAmount\n        ? Number(promoCodeData.minimumOrderAmount)\n        : undefined,\n      maximumDiscountAmount: promoCodeData.maximumDiscountAmount\n        ? Number(promoCodeData.maximumDiscountAmount)\n        : undefined,\n      appliesToProducts: promoCodeData.appliesToProducts || null,\n      appliesToCategories: promoCodeData.appliesToCategories || null,\n    };\n  }\n\n  /**\n   * Check if an item is eligible for a promo code based on product/category restrictions\n   */\n  private isItemEligibleForPromo(\n    productId: string,\n    categoryId: string | null,\n    promoCode: PromoCodeResult\n  ): boolean {\n    const hasProductRestrictions = promoCode.appliesToProducts && promoCode.appliesToProducts.length > 0;\n    const hasCategoryRestrictions = promoCode.appliesToCategories && promoCode.appliesToCategories.length > 0;\n\n    // If no restrictions, all products are eligible\n    if (!hasProductRestrictions && !hasCategoryRestrictions) {\n      return true;\n    }\n\n    // Check product whitelist\n    if (hasProductRestrictions && promoCode.appliesToProducts!.includes(productId)) {\n      return true;\n    }\n\n    // Check category whitelist\n    if (hasCategoryRestrictions && categoryId && promoCode.appliesToCategories!.includes(categoryId)) {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Calculate discount amount from promo code\n   * Only applies to eligible items based on product/category restrictions\n   */\n  private calculateDiscount(\n    promoCode: PromoCodeResult,\n    items: CartItemWithCategory[]\n  ): { discountAmount: number; eligibleItemIds: string[] } {\n    // Filter items to only those eligible for this promo code\n    const eligibleItems = items.filter((item) =>\n      this.isItemEligibleForPromo(item.productId, item.categoryId, promoCode)\n    );\n\n    // No eligible items = no discount\n    if (eligibleItems.length === 0) {\n      return { discountAmount: 0, eligibleItemIds: [] };\n    }\n\n    // Calculate eligible subtotal (only eligible items)\n    const eligibleSubtotal = round(\n      eligibleItems.reduce((sum, item) => sum + item.lineTotal, 0),\n      2\n    );\n\n    let discount = 0;\n\n    if (promoCode.discountType === 'percentage') {\n      discount = eligibleSubtotal * (promoCode.discountValue / 100);\n    } else {\n      // Fixed amount - cap at eligible subtotal\n      discount = Math.min(promoCode.discountValue, eligibleSubtotal);\n    }\n\n    // Apply maximum discount cap\n    if (promoCode.maximumDiscountAmount) {\n      discount = Math.min(discount, promoCode.maximumDiscountAmount);\n    }\n\n    // Discount cannot exceed eligible subtotal\n    discount = Math.min(discount, eligibleSubtotal);\n\n    return {\n      discountAmount: round(discount, 2),\n      eligibleItemIds: eligibleItems.map((item) => item.productId),\n    };\n  }\n\n  /**\n   * Get current tax rate from settings\n   *\n   * Tax settings are stored in the database with key 'tax':\n   * {\n   *   tax_enabled: boolean,\n   *   tax_rate: number,     // Percentage (0-100)\n   *   tax_label: string     // Display label (e.g., \"VAT\", \"Sales Tax\")\n   * }\n   *\n   * Configure tax via:\n   * - Admin Dashboard  Settings  Tax\n   * - API: PUT /api/settings with tax object\n   *\n   * Fallback behavior: If no tax setting exists in database, returns 0 (no tax applied).\n   * This is a safe default that prevents unexpected charges. Admins must explicitly\n   * enable and configure tax rates.\n   */\n  private async getTaxRate(): Promise<number> {\n    const [taxSetting] = await this.db\n      .select()\n      .from(settings)\n      .where(eq(settings.key, 'tax'));\n\n    if (taxSetting && taxSetting.value && typeof taxSetting.value === 'object') {\n      const taxValue = taxSetting.value as { tax_rate?: number; tax_enabled?: boolean };\n\n      // Only apply tax if tax_enabled is true\n      if (taxValue.tax_enabled && typeof taxValue.tax_rate === 'number') {\n        // Tax rate is stored as percentage (0-100), convert to decimal (0-1)\n        return taxValue.tax_rate / 100;\n      }\n\n      // If tax is disabled, return 0\n      if (taxValue.tax_enabled === false) {\n        return 0;\n      }\n    }\n\n    // No tax setting found in database - return 0 (no tax)\n    // Admins must configure tax via settings API or admin dashboard\n    logger.warn('Tax setting not found in database, applying 0% tax rate');\n    return 0;\n  }\n\n  /**\n   * Return empty cart calculation\n   */\n  private emptyCartCalculation(): CartCalculation {\n    return {\n      items: [],\n      itemCount: 0,\n      subtotal: 0,\n      taxRate: 0, // Tax rate will be applied when items are added\n      taxAmount: 0,\n      shippingAmount: 0,\n      discountAmount: 0,\n      total: 0,\n      currency: 'USD',\n    };\n  }\n\n  /**\n   * Get product image with fallback priority:\n   * 1. thumbnailUrl\n   * 2. First image from images array\n   * 3. undefined (no image)\n   */\n  private getProductImage(product: typeof products.$inferSelect): string | undefined {\n    if (product.thumbnailUrl) {\n      return product.thumbnailUrl;\n    }\n\n    if (product.images && Array.isArray(product.images) && product.images.length > 0) {\n      const firstImage = product.images[0];\n      if (firstImage && typeof firstImage === 'object' && 'url' in firstImage) {\n        return firstImage.url;\n      }\n    }\n\n    return undefined;\n  }\n}\n\n// Export singleton instance\nexport const pricingService = new PricingService();\n","/**\n * PDF Service\n * Handles PDF generation for quotations and invoices\n * Uses PDFKit for server-side PDF generation\n */\n\nimport PDFDocument from 'pdfkit';\n\ninterface QuotationItem {\n  productName: string;\n  sku: string;\n  description?: string;\n  quantity: number;\n  unitPrice: number;\n  lineTotal: number;\n  variantOptions?: Record<string, string>;\n  imageUrl?: string;\n}\n\ninterface QuotationData {\n  quotationNumber: string;\n  createdAt: Date;\n  validUntil: Date;\n  status: string;\n\n  // Customer info\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string;\n  customerCompany?: string;\n\n  // Items\n  items: QuotationItem[];\n\n  // Totals (CALCULATED SERVER-SIDE)\n  subtotal: number;\n  taxRate: number;\n  taxAmount: number;\n  shippingAmount: number;\n  discountAmount: number;\n  total: number;\n  currency: string;\n\n  // Notes\n  notes?: string;\n  terms?: string;\n\n  // Company info\n  companyName: string;\n  companyAddress: string;\n  companyPhone: string;\n  companyEmail: string;\n  companyWebsite?: string;\n  companyLogo?: string;\n}\n\ninterface InvoiceData extends QuotationData {\n  invoiceNumber: string;\n  orderNumber: string;\n  paymentStatus: string;\n  paymentMethod: string;\n  paidAt?: Date;\n}\n\ninterface PdfTemplateConfig {\n  primaryColor?: string;\n  accentColor?: string;\n  logoUrl?: string;\n  showCompanyLogo?: boolean;\n  showLineItemImages?: boolean;\n  showLineItemDescription?: boolean;\n  showSku?: boolean;\n  headerText?: string;\n  footerText?: string;\n  thankYouMessage?: string;\n}\n\nexport class PDFService {\n  // Default colors (can be overridden by template)\n  private primaryColor = '#1a1a2e';\n  private accentColor = '#0066cc';\n  private readonly textColor = '#333333';\n  private readonly lightGray = '#f5f5f5';\n\n  // Template config (set per generation)\n  private template: PdfTemplateConfig = {};\n\n  /**\n   * Parse HTML content to plain text for PDF rendering\n   * Converts HTML tags to readable plain text format\n   */\n  private parseHtmlToText(html: string): string {\n    if (!html) {return '';}\n\n    let text = html;\n\n    // Replace <br> and <br/> with newlines\n    text = text.replace(/<br\\s*\\/?>/gi, '\\n');\n\n    // Replace </p> with double newline (paragraph break)\n    text = text.replace(/<\\/p>/gi, '\\n\\n');\n\n    // Replace <p> tags (opening) with nothing\n    text = text.replace(/<p[^>]*>/gi, '');\n\n    // Handle strong/bold - keep the text\n    text = text.replace(/<\\/?strong>/gi, '');\n    text = text.replace(/<\\/?b>/gi, '');\n\n    // Handle emphasis/italic\n    text = text.replace(/<\\/?em>/gi, '');\n    text = text.replace(/<\\/?i>/gi, '');\n\n    // Handle underline\n    text = text.replace(/<\\/?u>/gi, '');\n\n    // Handle lists - convert to bullet points\n    text = text.replace(/<li[^>]*>/gi, ' ');\n    text = text.replace(/<\\/li>/gi, '\\n');\n    text = text.replace(/<\\/?[ou]l[^>]*>/gi, '\\n');\n\n    // Handle headings - add newlines\n    text = text.replace(/<h[1-6][^>]*>/gi, '\\n');\n    text = text.replace(/<\\/h[1-6]>/gi, '\\n');\n\n    // Handle div and span\n    text = text.replace(/<\\/?div[^>]*>/gi, '\\n');\n    text = text.replace(/<\\/?span[^>]*>/gi, '');\n\n    // Remove any remaining HTML tags\n    text = text.replace(/<[^>]+>/g, '');\n\n    // Decode common HTML entities\n    text = text.replace(/&nbsp;/gi, ' ');\n    text = text.replace(/&amp;/gi, '&');\n    text = text.replace(/&lt;/gi, '<');\n    text = text.replace(/&gt;/gi, '>');\n    text = text.replace(/&quot;/gi, '\"');\n    text = text.replace(/&#39;/gi, \"'\");\n    text = text.replace(/&apos;/gi, \"'\");\n\n    // Clean up multiple newlines (max 2)\n    text = text.replace(/\\n{3,}/g, '\\n\\n');\n\n    // Trim whitespace from each line and remove leading/trailing whitespace\n    text = text.split('\\n').map(line => line.trim()).join('\\n').trim();\n\n    return text;\n  }\n\n  /**\n   * Apply template configuration\n   */\n  private applyTemplate(template?: PdfTemplateConfig): void {\n    this.template = template || {};\n    if (template?.primaryColor) {\n      this.primaryColor = template.primaryColor;\n    } else {\n      this.primaryColor = '#1a1a2e';\n    }\n    if (template?.accentColor) {\n      this.accentColor = template.accentColor;\n    } else {\n      this.accentColor = '#0066cc';\n    }\n  }\n\n  /**\n   * Generate a quotation PDF\n   */\n  async generateQuotationPDF(data: QuotationData, template?: PdfTemplateConfig): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      try {\n        this.applyTemplate(template);\n\n        const doc = new PDFDocument({\n          size: 'A4',\n          margin: 50,\n          bufferPages: true,\n        });\n\n        const chunks: Buffer[] = [];\n\n        doc.on('data', (chunk) => chunks.push(chunk));\n        doc.on('end', () => resolve(Buffer.concat(chunks)));\n        doc.on('error', reject);\n\n        // Custom header text if provided\n        if (this.template.headerText) {\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(this.template.headerText, 50, 30, { align: 'center', width: 495 });\n          doc.y = 50;\n        }\n\n        // Header\n        this.addHeader(doc, data, 'QUOTATION');\n\n        // Customer info\n        this.addCustomerInfo(doc, data);\n\n        // Items table\n        this.addItemsTable(doc, data.items);\n\n        // Totals\n        this.addTotals(doc, data);\n\n        // Thank you message if provided\n        if (this.template.thankYouMessage) {\n          doc.moveDown();\n          doc.fontSize(11).fillColor(this.accentColor);\n          doc.text(this.template.thankYouMessage, 50, doc.y, { align: 'center', width: 495 });\n        }\n\n        // Notes and terms\n        this.addNotesAndTerms(doc, data);\n\n        // Footer\n        this.addFooter(doc, data);\n\n        doc.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /**\n   * Generate an invoice PDF\n   */\n  async generateInvoicePDF(data: InvoiceData, template?: PdfTemplateConfig): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      try {\n        this.applyTemplate(template);\n\n        const doc = new PDFDocument({\n          size: 'A4',\n          margin: 50,\n          bufferPages: true,\n        });\n\n        const chunks: Buffer[] = [];\n\n        doc.on('data', (chunk) => chunks.push(chunk));\n        doc.on('end', () => resolve(Buffer.concat(chunks)));\n        doc.on('error', reject);\n\n        // Custom header text if provided\n        if (this.template.headerText) {\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(this.template.headerText, 50, 30, { align: 'center', width: 495 });\n          doc.y = 50;\n        }\n\n        // Header\n        this.addHeader(doc, data, 'INVOICE');\n\n        // Invoice-specific info\n        doc.fontSize(10).fillColor(this.textColor);\n        doc.text(`Invoice #: ${data.invoiceNumber}`, 50, doc.y);\n        doc.text(`Order #: ${data.orderNumber}`);\n        doc.text(`Payment Status: ${data.paymentStatus.toUpperCase()}`);\n        if (data.paidAt) {\n          doc.text(`Paid On: ${data.paidAt.toLocaleDateString()}`);\n        }\n        doc.moveDown();\n\n        // Customer info\n        this.addCustomerInfo(doc, data);\n\n        // Items table\n        this.addItemsTable(doc, data.items);\n\n        // Totals\n        this.addTotals(doc, data);\n\n        // Payment info\n        if (data.paymentMethod) {\n          doc.moveDown();\n          doc.fontSize(10).fillColor(this.textColor);\n          doc.text(`Payment Method: ${data.paymentMethod.toUpperCase()}`);\n        }\n\n        // Thank you message if provided\n        if (this.template.thankYouMessage) {\n          doc.moveDown();\n          doc.fontSize(11).fillColor(this.accentColor);\n          doc.text(this.template.thankYouMessage, 50, doc.y, { align: 'center', width: 495 });\n        }\n\n        // Footer\n        this.addFooter(doc, data);\n\n        doc.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  private addHeader(doc: PDFKit.PDFDocument, data: QuotationData, title: string): void {\n    // Company name/logo\n    doc.fontSize(24).fillColor(this.primaryColor);\n    doc.text(data.companyName, 50, 50);\n\n    // Title\n    doc.fontSize(20).fillColor(this.accentColor);\n    doc.text(title, 400, 50, { align: 'right' });\n\n    // Document info\n    doc.fontSize(10).fillColor(this.textColor);\n    doc.text(`#: ${data.quotationNumber}`, 400, 80, { align: 'right' });\n    doc.text(`Date: ${data.createdAt.toLocaleDateString()}`, { align: 'right' });\n    doc.text(`Valid Until: ${data.validUntil.toLocaleDateString()}`, { align: 'right' });\n\n    // Company details (address, phone, email)\n    doc.fontSize(9).fillColor('#666666');\n    if (data.companyAddress) {\n      doc.text(data.companyAddress, 50, 80);\n    }\n    if (data.companyPhone) {\n      doc.text(`Phone: ${data.companyPhone}`);\n    }\n    if (data.companyEmail) {\n      doc.text(`Email: ${data.companyEmail}`);\n    }\n    if (data.companyWebsite) {\n      doc.text(`Web: ${data.companyWebsite}`);\n    }\n\n    // Divider\n    doc.moveTo(50, 150).lineTo(545, 150).stroke(this.lightGray);\n    doc.y = 160;\n  }\n\n  private addCustomerInfo(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    doc.fontSize(12).fillColor(this.primaryColor);\n    doc.text('Bill To:', 50, doc.y);\n\n    doc.fontSize(10).fillColor(this.textColor);\n    doc.text(data.customerName);\n    if (data.customerCompany) {\n      doc.text(data.customerCompany);\n    }\n    doc.text(data.customerEmail);\n    if (data.customerPhone) {\n      doc.text(data.customerPhone);\n    }\n\n    doc.moveDown(2);\n  }\n\n  private addItemsTable(doc: PDFKit.PDFDocument, items: QuotationItem[]): void {\n    const tableTop = doc.y;\n    const tableLeft = 50;\n    const showSku = this.template.showSku !== false; // Default true\n    const showDescription = this.template.showLineItemDescription === true;\n\n    // Table header - adjust columns based on showSku\n    doc.rect(tableLeft, tableTop, 495, 25).fill(this.primaryColor);\n    doc.fontSize(10).fillColor('#ffffff');\n\n    if (showSku) {\n      doc.text('Product', tableLeft + 10, tableTop + 8);\n      doc.text('SKU', tableLeft + 210, tableTop + 8);\n      doc.text('Qty', tableLeft + 290, tableTop + 8);\n      doc.text('Price', tableLeft + 350, tableTop + 8);\n      doc.text('Total', tableLeft + 420, tableTop + 8);\n    } else {\n      doc.text('Product', tableLeft + 10, tableTop + 8);\n      doc.text('Qty', tableLeft + 290, tableTop + 8);\n      doc.text('Price', tableLeft + 350, tableTop + 8);\n      doc.text('Total', tableLeft + 420, tableTop + 8);\n    }\n\n    // Table rows\n    let y = tableTop + 30;\n    doc.fillColor(this.textColor);\n\n    items.forEach((item, index) => {\n      const rowHeight = showDescription && item.description ? 40 : 25;\n\n      // Alternate row background\n      if (index % 2 === 0) {\n        doc.rect(tableLeft, y - 5, 495, rowHeight).fill(this.lightGray);\n        doc.fillColor(this.textColor);\n      }\n\n      doc.fontSize(9);\n\n      // Product name with variant options\n      let productName = item.productName;\n      if (item.variantOptions) {\n        const options = Object.entries(item.variantOptions)\n          .map(([k, v]) => `${k}: ${v}`)\n          .join(', ');\n        productName += ` (${options})`;\n      }\n\n      // Truncate long names based on whether SKU is shown\n      const maxNameLength = showSku ? 40 : 60;\n      if (productName.length > maxNameLength) {\n        productName = productName.substring(0, maxNameLength - 3) + '...';\n      }\n\n      doc.text(productName, tableLeft + 10, y, { width: showSku ? 190 : 270 });\n\n      if (showSku) {\n        doc.text(item.sku || '-', tableLeft + 210, y, { width: 70 });\n      }\n\n      doc.text(item.quantity.toString(), tableLeft + 290, y, { width: 50 });\n      doc.text(`$${item.unitPrice.toFixed(2)}`, tableLeft + 350, y, { width: 60 });\n      doc.text(`$${item.lineTotal.toFixed(2)}`, tableLeft + 420, y, { width: 70 });\n\n      // Show description if enabled\n      if (showDescription && item.description) {\n        doc.fontSize(8).fillColor('#666666');\n        const desc = item.description.length > 80\n          ? item.description.substring(0, 77) + '...'\n          : item.description;\n        doc.text(desc, tableLeft + 10, y + 12, { width: 270 });\n        doc.fillColor(this.textColor);\n      }\n\n      y += rowHeight;\n\n      // New page if needed\n      if (y > 700) {\n        doc.addPage();\n        y = 50;\n      }\n    });\n\n    // Table border\n    doc.rect(tableLeft, tableTop, 495, y - tableTop).stroke('#cccccc');\n\n    doc.y = y + 10;\n  }\n\n  private addTotals(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    const totalsX = 350;\n    let y = doc.y + 10;\n\n    doc.fontSize(10).fillColor(this.textColor);\n\n    // Subtotal\n    doc.text('Subtotal:', totalsX, y);\n    doc.text(`$${data.subtotal.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n    y += 20;\n\n    // Discount (if any)\n    if (data.discountAmount > 0) {\n      doc.text('Discount:', totalsX, y);\n      doc.fillColor('#cc0000');\n      doc.text(`-$${data.discountAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n      doc.fillColor(this.textColor);\n      y += 20;\n    }\n\n    // Tax\n    doc.text(`Tax (${(data.taxRate * 100).toFixed(0)}%):`, totalsX, y);\n    doc.text(`$${data.taxAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n    y += 20;\n\n    // Shipping\n    if (data.shippingAmount > 0) {\n      doc.text('Shipping:', totalsX, y);\n      doc.text(`$${data.shippingAmount.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n      y += 20;\n    }\n\n    // Divider\n    doc.moveTo(totalsX, y).lineTo(545, y).stroke('#cccccc');\n    y += 10;\n\n    // Total\n    doc.fontSize(14).fillColor(this.primaryColor);\n    doc.text('Total:', totalsX, y);\n    doc.text(`${data.currency} $${data.total.toFixed(2)}`, totalsX + 100, y, { align: 'right', width: 95 });\n\n    doc.y = y + 30;\n  }\n\n  private addNotesAndTerms(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    if (data.notes || data.terms) {\n      doc.moveDown();\n\n      if (data.notes) {\n        doc.fontSize(11).fillColor(this.primaryColor);\n        doc.text('Notes:', 50, doc.y);\n        doc.fontSize(9).fillColor(this.textColor);\n        doc.text(data.notes, { width: 495 });\n        doc.moveDown();\n      }\n\n      if (data.terms) {\n        doc.fontSize(11).fillColor(this.primaryColor);\n        doc.text('Terms & Conditions:', 50, doc.y);\n        doc.fontSize(9).fillColor(this.textColor);\n        // Parse HTML to plain text for PDF rendering\n        const parsedTerms = this.parseHtmlToText(data.terms);\n        doc.text(parsedTerms, { width: 495 });\n      }\n    }\n  }\n\n  private addFooter(doc: PDFKit.PDFDocument, data: QuotationData): void {\n    const pageCount = doc.bufferedPageRange().count;\n\n    for (let i = 0; i < pageCount; i++) {\n      doc.switchToPage(i);\n\n      // Footer line\n      doc.moveTo(50, 780).lineTo(545, 780).stroke(this.lightGray);\n\n      // Footer text - use template footer or default\n      const footerText = this.template.footerText\n        || `Generated by ${data.companyName} | Page ${i + 1} of ${pageCount}`;\n\n      doc.fontSize(8).fillColor('#666666');\n      doc.text(\n        footerText,\n        50,\n        785,\n        { align: 'center', width: 495 }\n      );\n    }\n  }\n\n  /**\n   * Generate PDF stream for direct response\n   */\n  generatePDFStream(data: QuotationData, type: 'quotation' | 'invoice' = 'quotation'): PDFKit.PDFDocument {\n    const doc = new PDFDocument({\n      size: 'A4',\n      margin: 50,\n      bufferPages: true,\n    });\n\n    // Add content based on type\n    if (type === 'quotation') {\n      this.addHeader(doc, data, 'QUOTATION');\n    } else {\n      this.addHeader(doc, data, 'INVOICE');\n    }\n\n    this.addCustomerInfo(doc, data);\n    this.addItemsTable(doc, data.items);\n    this.addTotals(doc, data);\n    this.addNotesAndTerms(doc, data);\n    this.addFooter(doc, data);\n\n    doc.end();\n\n    return doc;\n  }\n}\n\nexport const pdfService = new PDFService();\n","/**\n * Export Service\n * Handles data export in various formats (CSV, JSON, XLSX)\n */\n\ninterface ExportColumn<T> {\n  key: keyof T | string;\n  header: string;\n  formatter?: (value: unknown, row: T) => string;\n}\n\nexport class ExportService {\n  /**\n   * Export data to CSV format\n   */\n  toCSV<T extends Record<string, unknown>>(\n    data: T[],\n    columns: ExportColumn<T>[]\n  ): string {\n    if (data.length === 0) {\n      return columns.map(c => c.header).join(',');\n    }\n\n    // Header row\n    const headers = columns.map(c => this.escapeCSV(c.header));\n\n    // Data rows\n    const rows = data.map(row => {\n      return columns.map(col => {\n        const value = this.getNestedValue(row, col.key as string);\n        const formatted = col.formatter ? col.formatter(value, row) : value;\n        return this.escapeCSV(String(formatted ?? ''));\n      });\n    });\n\n    return [headers.join(','), ...rows.map(r => r.join(','))].join('\\n');\n  }\n\n  /**\n   * Export data to JSON format\n   */\n  toJSON<T>(data: T[], pretty = true): string {\n    return pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);\n  }\n\n  /**\n   * Export data to JSONL format (JSON Lines - one object per line)\n   */\n  toJSONL<T>(data: T[]): string {\n    return data.map(row => JSON.stringify(row)).join('\\n');\n  }\n\n  /**\n   * Get export content type and file extension\n   */\n  getContentType(format: 'csv' | 'json' | 'jsonl' | 'xlsx'): {\n    contentType: string;\n    extension: string;\n  } {\n    switch (format) {\n      case 'csv':\n        return { contentType: 'text/csv', extension: 'csv' };\n      case 'json':\n        return { contentType: 'application/json', extension: 'json' };\n      case 'jsonl':\n        return { contentType: 'application/x-ndjson', extension: 'jsonl' };\n      case 'xlsx':\n        return { contentType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', extension: 'xlsx' };\n      default:\n        return { contentType: 'application/octet-stream', extension: 'bin' };\n    }\n  }\n\n  /**\n   * Get export filename\n   */\n  getFilename(prefix: string, format: string): string {\n    const date = new Date().toISOString().split('T')[0];\n    return `${prefix}-export-${date}.${format}`;\n  }\n\n  // ===========================================\n  // Predefined Export Configurations\n  // ===========================================\n\n  /**\n   * Product export columns - ALL fields\n   */\n  getProductColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'sku', header: 'SKU' },\n      { key: 'barcode', header: 'Barcode' },\n      { key: 'name', header: 'Name' },\n      { key: 'slug', header: 'Slug' },\n      { key: 'description', header: 'Description' },\n      { key: 'shortDescription', header: 'Short Description' },\n      { key: 'categoryId', header: 'Category ID' },\n      { key: 'categoryName', header: 'Category' },\n      { key: 'brand', header: 'Brand' },\n      { key: 'basePrice', header: 'Base Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'costPrice', header: 'Cost Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'compareAtPrice', header: 'Compare At Price', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'weight', header: 'Weight (g)', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'dimensions', header: 'Dimensions', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'stockQuantity', header: 'Stock Quantity' },\n      { key: 'lowStockThreshold', header: 'Low Stock Threshold' },\n      { key: 'trackInventory', header: 'Track Inventory', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'allowBackorder', header: 'Allow Backorder', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'images', header: 'Images', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'videos', header: 'Videos', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'thumbnailUrl', header: 'Thumbnail URL' },\n      { key: 'tags', header: 'Tags', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'specifications', header: 'Specifications', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'features', header: 'Features', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'metaTitle', header: 'Meta Title' },\n      { key: 'metaDescription', header: 'Meta Description' },\n      { key: 'status', header: 'Status' },\n      { key: 'isFeatured', header: 'Featured', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'isDigital', header: 'Digital Product', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'requiresShipping', header: 'Requires Shipping', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'supplierId', header: 'Supplier ID' },\n      { key: 'supplierSku', header: 'Supplier SKU' },\n      { key: 'importedFrom', header: 'Imported From' },\n      { key: 'externalUrl', header: 'External URL' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Order export columns - ALL fields\n   */\n  getOrderColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'orderNumber', header: 'Order Number' },\n      { key: 'customerId', header: 'Customer ID' },\n      { key: 'customerEmail', header: 'Customer Email' },\n      { key: 'customerName', header: 'Customer Name' },\n      { key: 'status', header: 'Status' },\n      { key: 'paymentStatus', header: 'Payment Status' },\n      { key: 'paymentMethod', header: 'Payment Method' },\n      { key: 'shippingAddress', header: 'Shipping Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'billingAddress', header: 'Billing Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'currency', header: 'Currency' },\n      { key: 'subtotalSnapshot', header: 'Subtotal', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'taxRateSnapshot', header: 'Tax Rate', formatter: (v) => v ? (Number(v) * 100).toFixed(2) + '%' : '' },\n      { key: 'taxAmountSnapshot', header: 'Tax Amount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'shippingAmountSnapshot', header: 'Shipping', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'discountAmountSnapshot', header: 'Discount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'totalSnapshot', header: 'Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'promoCodeId', header: 'Promo Code ID' },\n      { key: 'promoCodeSnapshot', header: 'Promo Code Used' },\n      { key: 'shippingMethod', header: 'Shipping Method' },\n      { key: 'trackingNumber', header: 'Tracking Number' },\n      { key: 'confirmedAt', header: 'Confirmed At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'processingAt', header: 'Processing At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'shippedAt', header: 'Shipped At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'deliveredAt', header: 'Delivered At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'customerNotes', header: 'Customer Notes' },\n      { key: 'adminNotes', header: 'Admin Notes' },\n      { key: 'createdAt', header: 'Order Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Customer export columns - ALL fields\n   */\n  getCustomerColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'authUserId', header: 'Auth User ID' },\n      { key: 'email', header: 'Email' },\n      { key: 'firstName', header: 'First Name' },\n      { key: 'lastName', header: 'Last Name' },\n      { key: 'phone', header: 'Phone' },\n      { key: 'defaultShippingAddress', header: 'Default Shipping Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'defaultBillingAddress', header: 'Default Billing Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'isGuest', header: 'Guest', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'isActive', header: 'Active', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'acceptsMarketing', header: 'Accepts Marketing', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'notes', header: 'Notes' },\n      { key: 'tags', header: 'Tags', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'orderCount', header: 'Order Count' },\n      { key: 'createdAt', header: 'Registered At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Promo code export columns - ALL fields\n   */\n  getPromoCodeColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'code', header: 'Code' },\n      { key: 'description', header: 'Description' },\n      { key: 'discountType', header: 'Discount Type' },\n      { key: 'discountValue', header: 'Discount Value', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'minimumOrderAmount', header: 'Min Order Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'maximumDiscountAmount', header: 'Max Discount Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'usageLimit', header: 'Usage Limit' },\n      { key: 'usageCount', header: 'Times Used' },\n      { key: 'usageLimitPerCustomer', header: 'Usage Limit Per Customer' },\n      { key: 'isActive', header: 'Active', formatter: (v) => v ? 'Yes' : 'No' },\n      { key: 'startsAt', header: 'Start Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'expiresAt', header: 'Expiry Date', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'appliesToProducts', header: 'Applies To Products', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'appliesToCategories', header: 'Applies To Categories', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'customerIds', header: 'Restricted Customer IDs', formatter: (v) => Array.isArray(v) ? v.join(', ') : '' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Quotation export columns - ALL fields\n   */\n  getQuotationColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'quotationNumber', header: 'Quotation Number' },\n      { key: 'customerId', header: 'Customer ID' },\n      { key: 'customerName', header: 'Customer Name' },\n      { key: 'customerEmail', header: 'Customer Email' },\n      { key: 'customerPhone', header: 'Customer Phone' },\n      { key: 'customerCompany', header: 'Customer Company' },\n      { key: 'customerAddress', header: 'Customer Address', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'status', header: 'Status' },\n      { key: 'validUntil', header: 'Valid Until', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'validDays', header: 'Valid Days' },\n      { key: 'currency', header: 'Currency' },\n      { key: 'subtotal', header: 'Subtotal', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'taxRate', header: 'Tax Rate', formatter: (v) => v ? (Number(v) * 100).toFixed(2) + '%' : '' },\n      { key: 'taxAmount', header: 'Tax Amount', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'discountType', header: 'Discount Type' },\n      { key: 'discountValue', header: 'Discount Value', formatter: (v) => v ? Number(v).toFixed(2) : '' },\n      { key: 'discountAmount', header: 'Discount Amount', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'total', header: 'Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'notes', header: 'Notes' },\n      { key: 'termsAndConditions', header: 'Terms & Conditions' },\n      { key: 'pdfUrl', header: 'PDF URL' },\n      { key: 'pdfTemplateId', header: 'PDF Template ID' },\n      { key: 'convertedToOrderId', header: 'Converted To Order ID' },\n      { key: 'acceptanceToken', header: 'Acceptance Token' },\n      { key: 'tokenExpiresAt', header: 'Token Expires At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'viewedAt', header: 'Viewed At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n      { key: 'updatedAt', header: 'Updated At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Order Items export columns\n   */\n  getOrderItemColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'orderId', header: 'Order ID' },\n      { key: 'orderNumber', header: 'Order Number' },\n      { key: 'productId', header: 'Product ID' },\n      { key: 'variantId', header: 'Variant ID' },\n      { key: 'productNameSnapshot', header: 'Product Name' },\n      { key: 'skuSnapshot', header: 'SKU' },\n      { key: 'variantOptionsSnapshot', header: 'Variant Options', formatter: (v) => v ? JSON.stringify(v) : '' },\n      { key: 'quantity', header: 'Quantity' },\n      { key: 'unitPriceSnapshot', header: 'Unit Price', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'lineTotal', header: 'Line Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  /**\n   * Quotation Items export columns\n   */\n  getQuotationItemColumns(): ExportColumn<Record<string, unknown>>[] {\n    return [\n      { key: 'id', header: 'ID' },\n      { key: 'quotationId', header: 'Quotation ID' },\n      { key: 'quotationNumber', header: 'Quotation Number' },\n      { key: 'productId', header: 'Product ID' },\n      { key: 'variantId', header: 'Variant ID' },\n      { key: 'name', header: 'Item Name' },\n      { key: 'description', header: 'Description' },\n      { key: 'sku', header: 'SKU' },\n      { key: 'quantity', header: 'Quantity' },\n      { key: 'unitPrice', header: 'Unit Price', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'lineTotal', header: 'Line Total', formatter: (v) => v ? Number(v).toFixed(2) : '0.00' },\n      { key: 'createdAt', header: 'Created At', formatter: (v) => v ? new Date(v as string).toISOString() : '' },\n    ];\n  }\n\n  // ===========================================\n  // Helper Methods\n  // ===========================================\n\n  private escapeCSV(value: string): string {\n    // If value contains comma, quote, or newline, wrap in quotes and escape quotes\n    if (value.includes(',') || value.includes('\"') || value.includes('\\n')) {\n      return `\"${value.replace(/\"/g, '\"\"')}\"`;\n    }\n    return value;\n  }\n\n  private getNestedValue(obj: Record<string, unknown>, path: string): unknown {\n    return path.split('.').reduce<unknown>((o, p) => (o as Record<string, unknown>)?.[p], obj);\n  }\n}\n\nexport const exportService = new ExportService();\n","/**\n * Import Service\n * Handles data import from CSV files and external sources\n */\n\nimport { z } from 'zod';\n\nexport interface ImportResult<T> {\n  success: boolean;\n  totalRows: number;\n  successCount: number;\n  errorCount: number;\n  errors: Array<{\n    row: number;\n    field?: string;\n    message: string;\n  }>;\n  data: T[];\n}\n\ninterface ColumnMapping {\n  csvColumn: string;\n  field: string;\n  required?: boolean;\n  transform?: (value: string) => unknown;\n}\n\nexport class ImportService {\n  /**\n   * Parse CSV string into array of objects\n   */\n  parseCSV(csvContent: string): Record<string, string>[] {\n    const lines = csvContent.trim().split('\\n');\n    if (lines.length < 2) {\n      return [];\n    }\n\n    const headerLine = lines[0];\n    if (!headerLine) {\n      return [];\n    }\n\n    const headers = this.parseCSVLine(headerLine);\n    const data: Record<string, string>[] = [];\n\n    for (let i = 1; i < lines.length; i++) {\n      const line = lines[i];\n      if (!line) {continue;}\n\n      const values = this.parseCSVLine(line);\n      const row: Record<string, string> = {};\n\n      headers.forEach((header, index) => {\n        row[header.trim()] = values[index]?.trim() || '';\n      });\n\n      data.push(row);\n    }\n\n    return data;\n  }\n\n  /**\n   * Parse a single CSV line handling quoted values\n   */\n  private parseCSVLine(line: string): string[] {\n    const result: string[] = [];\n    let current = '';\n    let inQuotes = false;\n\n    for (let i = 0; i < line.length; i++) {\n      const char = line[i];\n\n      if (char === '\"') {\n        if (inQuotes && line[i + 1] === '\"') {\n          // Escaped quote\n          current += '\"';\n          i++;\n        } else {\n          inQuotes = !inQuotes;\n        }\n      } else if (char === ',' && !inQuotes) {\n        result.push(current);\n        current = '';\n      } else {\n        current += char;\n      }\n    }\n\n    result.push(current);\n    return result;\n  }\n\n  /**\n   * Map CSV data to objects with validation\n   */\n  mapAndValidate<T>(\n    data: Record<string, string>[],\n    mappings: ColumnMapping[],\n    schema: z.ZodSchema<T>\n  ): ImportResult<T> {\n    const result: ImportResult<T> = {\n      success: true,\n      totalRows: data.length,\n      successCount: 0,\n      errorCount: 0,\n      errors: [],\n      data: [],\n    };\n\n    for (let i = 0; i < data.length; i++) {\n      const row = data[i];\n      if (!row) {continue;}\n\n      const rowNumber = i + 2; // Account for header row and 0-indexing\n\n      try {\n        // Map columns\n        const mapped: Record<string, unknown> = {};\n\n        for (const mapping of mappings) {\n          const value = row[mapping.csvColumn];\n\n          if (mapping.required && (!value || value.trim() === '')) {\n            throw new Error(`Missing required field: ${mapping.csvColumn}`);\n          }\n\n          if (value && value.trim() !== '') {\n            mapped[mapping.field] = mapping.transform\n              ? mapping.transform(value)\n              : value;\n          }\n        }\n\n        // Validate with schema\n        const validated = schema.parse(mapped);\n        result.data.push(validated);\n        result.successCount++;\n      } catch (error) {\n        result.errorCount++;\n        result.success = false;\n\n        if (error instanceof z.ZodError) {\n          error.errors.forEach(e => {\n            result.errors.push({\n              row: rowNumber,\n              field: e.path.join('.'),\n              message: e.message,\n            });\n          });\n        } else if (error instanceof Error) {\n          result.errors.push({\n            row: rowNumber,\n            message: error.message,\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  // ===========================================\n  // Predefined Import Configurations\n  // ===========================================\n\n  /**\n   * Product import mapping - ALL fields\n   */\n  getProductMappings(): ColumnMapping[] {\n    return [\n      // Required fields\n      { csvColumn: 'name', field: 'name', required: true },\n      { csvColumn: 'sku', field: 'sku', required: true },\n      {\n        csvColumn: 'price',\n        field: 'basePrice',\n        required: true,\n        transform: (v) => parseFloat(v.replace(/[^0-9.]/g, '')),\n      },\n      // Basic info\n      { csvColumn: 'barcode', field: 'barcode' },\n      { csvColumn: 'description', field: 'description' },\n      { csvColumn: 'short_description', field: 'shortDescription' },\n      { csvColumn: 'category', field: 'categoryName' },\n      { csvColumn: 'brand', field: 'brand' },\n      // Pricing\n      {\n        csvColumn: 'cost_price',\n        field: 'costPrice',\n        transform: (v) => v ? parseFloat(v.replace(/[^0-9.]/g, '')) : undefined,\n      },\n      {\n        csvColumn: 'compare_at_price',\n        field: 'compareAtPrice',\n        transform: (v) => v ? parseFloat(v.replace(/[^0-9.]/g, '')) : undefined,\n      },\n      // Inventory\n      {\n        csvColumn: 'quantity',\n        field: 'stockQuantity',\n        transform: (v) => parseInt(v) || 0,\n      },\n      {\n        csvColumn: 'low_stock_threshold',\n        field: 'lowStockThreshold',\n        transform: (v) => parseInt(v) || 5,\n      },\n      {\n        csvColumn: 'track_inventory',\n        field: 'trackInventory',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'allow_backorder',\n        field: 'allowBackorder',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // Shipping\n      {\n        csvColumn: 'weight',\n        field: 'weight',\n        transform: (v) => v ? parseFloat(v) : undefined,\n      },\n      {\n        csvColumn: 'dimensions',\n        field: 'dimensions',\n        transform: (v) => {\n          if (!v) {return undefined;}\n          try {\n            // Support JSON format: {\"width\": 10, \"height\": 20, \"depth\": 5}\n            if (v.startsWith('{')) {return JSON.parse(v);}\n            // Support simple format: 10x20x5\n            const parts = v.split('x').map(p => parseFloat(p.trim()));\n            if (parts.length === 3) {\n              return { width: parts[0], height: parts[1], depth: parts[2] };\n            }\n            return undefined;\n          } catch {\n            return undefined;\n          }\n        },\n      },\n      {\n        csvColumn: 'is_digital',\n        field: 'isDigital',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'requires_shipping',\n        field: 'requiresShipping',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      // Media\n      { csvColumn: 'image_url', field: 'thumbnailUrl' },\n      {\n        csvColumn: 'images',\n        field: 'images',\n        transform: (v) => {\n          if (!v) {return [];}\n          try {\n            if (v.startsWith('[')) {return JSON.parse(v);}\n            // Support comma-separated URLs\n            return v.split(',').map(url => ({ url: url.trim() })).filter(img => img.url);\n          } catch {\n            return [];\n          }\n        },\n      },\n      // Status\n      {\n        csvColumn: 'status',\n        field: 'status',\n        transform: (v) => {\n          const normalized = v.toLowerCase().trim();\n          if (['active', 'draft', 'archived'].includes(normalized)) {\n            return normalized;\n          }\n          return 'draft';\n        },\n      },\n      {\n        csvColumn: 'featured',\n        field: 'isFeatured',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // SEO\n      { csvColumn: 'meta_title', field: 'metaTitle' },\n      { csvColumn: 'meta_description', field: 'metaDescription' },\n      // Tags and features\n      {\n        csvColumn: 'tags',\n        field: 'tags',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      {\n        csvColumn: 'features',\n        field: 'features',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      {\n        csvColumn: 'specifications',\n        field: 'specifications',\n        transform: (v) => {\n          if (!v) {return {};}\n          try {\n            if (v.startsWith('{')) {return JSON.parse(v);}\n            // Support simple format: key1:value1,key2:value2\n            const specs: Record<string, string> = {};\n            v.split(',').forEach(pair => {\n              const [key, value] = pair.split(':').map(s => s.trim());\n              if (key && value) {specs[key] = value;}\n            });\n            return specs;\n          } catch {\n            return {};\n          }\n        },\n      },\n      // Supplier\n      { csvColumn: 'supplier_id', field: 'supplierId' },\n      { csvColumn: 'supplier_sku', field: 'supplierSku' },\n    ];\n  }\n\n  /**\n   * Product import schema - ALL fields\n   */\n  getProductSchema() {\n    return z.object({\n      // Required\n      name: z.string().min(1).max(255),\n      sku: z.string().min(1).max(100),\n      basePrice: z.number().positive(),\n      // Basic\n      barcode: z.string().max(100).optional(),\n      description: z.string().optional(),\n      shortDescription: z.string().max(500).optional(),\n      categoryName: z.string().optional(),\n      brand: z.string().max(255).optional(),\n      // Pricing\n      costPrice: z.number().positive().optional(),\n      compareAtPrice: z.number().positive().optional(),\n      // Inventory\n      stockQuantity: z.number().int().min(0).optional().default(0),\n      lowStockThreshold: z.number().int().min(0).optional().default(5),\n      trackInventory: z.boolean().optional().default(true),\n      allowBackorder: z.boolean().optional().default(false),\n      // Shipping\n      weight: z.number().optional(),\n      dimensions: z.object({\n        width: z.number().optional(),\n        height: z.number().optional(),\n        depth: z.number().optional(),\n      }).optional(),\n      isDigital: z.boolean().optional().default(false),\n      requiresShipping: z.boolean().optional().default(true),\n      // Media\n      thumbnailUrl: z.string().url().optional(),\n      images: z.array(z.object({\n        url: z.string().url(),\n        alt: z.string().optional(),\n      })).optional(),\n      // Status\n      status: z.enum(['active', 'draft', 'archived']).optional().default('draft'),\n      isFeatured: z.boolean().optional().default(false),\n      // SEO\n      metaTitle: z.string().max(255).optional(),\n      metaDescription: z.string().max(500).optional(),\n      // Tags and features\n      tags: z.array(z.string()).optional(),\n      features: z.array(z.string()).optional(),\n      specifications: z.record(z.string()).optional(),\n      // Supplier\n      supplierId: z.string().optional(),\n      supplierSku: z.string().optional(),\n    });\n  }\n\n  /**\n   * Customer import mapping - ALL fields including addresses\n   */\n  getCustomerMappings(): ColumnMapping[] {\n    return [\n      // Required\n      { csvColumn: 'email', field: 'email', required: true },\n      // Basic info\n      { csvColumn: 'first_name', field: 'firstName' },\n      { csvColumn: 'last_name', field: 'lastName' },\n      { csvColumn: 'phone', field: 'phone' },\n      // Status\n      {\n        csvColumn: 'is_active',\n        field: 'isActive',\n        transform: (v) => !['no', 'false', '0'].includes(v.toLowerCase().trim()),\n      },\n      {\n        csvColumn: 'accepts_marketing',\n        field: 'acceptsMarketing',\n        transform: (v) => ['yes', 'true', '1'].includes(v.toLowerCase().trim()),\n      },\n      // Notes and tags\n      { csvColumn: 'notes', field: 'notes' },\n      {\n        csvColumn: 'tags',\n        field: 'tags',\n        transform: (v) => v.split(',').map(t => t.trim()).filter(Boolean),\n      },\n      // Shipping address fields\n      { csvColumn: 'shipping_first_name', field: 'shippingFirstName' },\n      { csvColumn: 'shipping_last_name', field: 'shippingLastName' },\n      { csvColumn: 'shipping_company', field: 'shippingCompany' },\n      { csvColumn: 'shipping_address_line1', field: 'shippingAddressLine1' },\n      { csvColumn: 'shipping_address_line2', field: 'shippingAddressLine2' },\n      { csvColumn: 'shipping_city', field: 'shippingCity' },\n      { csvColumn: 'shipping_state', field: 'shippingState' },\n      { csvColumn: 'shipping_postal_code', field: 'shippingPostalCode' },\n      { csvColumn: 'shipping_country', field: 'shippingCountry' },\n      { csvColumn: 'shipping_phone', field: 'shippingPhone' },\n      // Billing address fields\n      { csvColumn: 'billing_first_name', field: 'billingFirstName' },\n      { csvColumn: 'billing_last_name', field: 'billingLastName' },\n      { csvColumn: 'billing_company', field: 'billingCompany' },\n      { csvColumn: 'billing_address_line1', field: 'billingAddressLine1' },\n      { csvColumn: 'billing_address_line2', field: 'billingAddressLine2' },\n      { csvColumn: 'billing_city', field: 'billingCity' },\n      { csvColumn: 'billing_state', field: 'billingState' },\n      { csvColumn: 'billing_postal_code', field: 'billingPostalCode' },\n      { csvColumn: 'billing_country', field: 'billingCountry' },\n      { csvColumn: 'billing_phone', field: 'billingPhone' },\n    ];\n  }\n\n  /**\n   * Customer import schema - ALL fields\n   */\n  getCustomerSchema() {\n    return z.object({\n      // Required\n      email: z.string().email(),\n      // Basic\n      firstName: z.string().max(100).optional(),\n      lastName: z.string().max(100).optional(),\n      phone: z.string().max(50).optional(),\n      // Status\n      isActive: z.boolean().optional().default(true),\n      acceptsMarketing: z.boolean().optional().default(false),\n      // Notes and tags\n      notes: z.string().optional(),\n      tags: z.array(z.string()).optional(),\n      // Shipping address fields (will be combined into JSON)\n      shippingFirstName: z.string().optional(),\n      shippingLastName: z.string().optional(),\n      shippingCompany: z.string().optional(),\n      shippingAddressLine1: z.string().optional(),\n      shippingAddressLine2: z.string().optional(),\n      shippingCity: z.string().optional(),\n      shippingState: z.string().optional(),\n      shippingPostalCode: z.string().optional(),\n      shippingCountry: z.string().optional(),\n      shippingPhone: z.string().optional(),\n      // Billing address fields (will be combined into JSON)\n      billingFirstName: z.string().optional(),\n      billingLastName: z.string().optional(),\n      billingCompany: z.string().optional(),\n      billingAddressLine1: z.string().optional(),\n      billingAddressLine2: z.string().optional(),\n      billingCity: z.string().optional(),\n      billingState: z.string().optional(),\n      billingPostalCode: z.string().optional(),\n      billingCountry: z.string().optional(),\n      billingPhone: z.string().optional(),\n    });\n  }\n\n  /**\n   * Generate CSV template for products - ALL fields\n   */\n  getProductTemplate(): string {\n    const headers = [\n      'name',\n      'sku',\n      'price',\n      'barcode',\n      'description',\n      'short_description',\n      'category',\n      'brand',\n      'cost_price',\n      'compare_at_price',\n      'quantity',\n      'low_stock_threshold',\n      'track_inventory',\n      'allow_backorder',\n      'weight',\n      'dimensions',\n      'is_digital',\n      'requires_shipping',\n      'image_url',\n      'images',\n      'status',\n      'featured',\n      'meta_title',\n      'meta_description',\n      'tags',\n      'features',\n      'specifications',\n      'supplier_id',\n      'supplier_sku',\n    ];\n\n    const exampleRow = [\n      'Arduino Uno R3',\n      'ARD-UNO-R3',\n      '29.99',\n      '123456789',\n      'The Arduino Uno R3 is a microcontroller board based on the ATmega328P.',\n      'Popular microcontroller board for beginners',\n      'Microcontrollers',\n      'Arduino',\n      '15.00',\n      '39.99',\n      '100',\n      '10',\n      'Yes',\n      'No',\n      '25',\n      '10x5x2',\n      'No',\n      'Yes',\n      'https://example.com/arduino.jpg',\n      '',\n      'active',\n      'Yes',\n      'Arduino Uno R3 - Buy Online',\n      'Shop the Arduino Uno R3 microcontroller board',\n      'arduino,microcontroller,electronics',\n      'Easy to program,USB powered,14 digital pins',\n      'Processor:ATmega328P,Voltage:5V,Clock:16MHz',\n      'SUP001',\n      'ARD-001',\n    ];\n\n    return `${headers.join(',')}\\n\"${exampleRow.join('\",\"')}\"`;\n  }\n\n  /**\n   * Generate CSV template for customers - ALL fields\n   */\n  getCustomerTemplate(): string {\n    const headers = [\n      'email',\n      'first_name',\n      'last_name',\n      'phone',\n      'is_active',\n      'accepts_marketing',\n      'notes',\n      'tags',\n      'shipping_first_name',\n      'shipping_last_name',\n      'shipping_company',\n      'shipping_address_line1',\n      'shipping_address_line2',\n      'shipping_city',\n      'shipping_state',\n      'shipping_postal_code',\n      'shipping_country',\n      'shipping_phone',\n      'billing_first_name',\n      'billing_last_name',\n      'billing_company',\n      'billing_address_line1',\n      'billing_address_line2',\n      'billing_city',\n      'billing_state',\n      'billing_postal_code',\n      'billing_country',\n      'billing_phone',\n    ];\n\n    const exampleRow = [\n      'john@example.com',\n      'John',\n      'Doe',\n      '+1-555-123-4567',\n      'Yes',\n      'Yes',\n      'VIP customer',\n      'wholesale,priority',\n      'John',\n      'Doe',\n      'Acme Inc',\n      '123 Main Street',\n      'Suite 100',\n      'New York',\n      'NY',\n      '10001',\n      'USA',\n      '+1-555-123-4567',\n      'John',\n      'Doe',\n      'Acme Inc',\n      '123 Main Street',\n      'Suite 100',\n      'New York',\n      'NY',\n      '10001',\n      'USA',\n      '+1-555-123-4567',\n    ];\n\n    return `${headers.join(',')}\\n\"${exampleRow.join('\",\"')}\"`;\n  }\n\n  /**\n   * Build address JSON from flat fields\n   */\n  buildAddressFromFlatFields(data: Record<string, unknown>, prefix: 'shipping' | 'billing'): Record<string, unknown> | null {\n    const addressLine1 = data[`${prefix}AddressLine1`];\n    if (!addressLine1) {return null;}\n\n    return {\n      firstName: data[`${prefix}FirstName`] || '',\n      lastName: data[`${prefix}LastName`] || '',\n      company: data[`${prefix}Company`] || undefined,\n      addressLine1: addressLine1,\n      addressLine2: data[`${prefix}AddressLine2`] || undefined,\n      city: data[`${prefix}City`] || '',\n      state: data[`${prefix}State`] || undefined,\n      postalCode: data[`${prefix}PostalCode`] || undefined,\n      country: data[`${prefix}Country`] || '',\n      phone: data[`${prefix}Phone`] || undefined,\n    };\n  }\n}\n\nexport const importService = new ImportService();\n","import { MeiliSearch, Index, SearchParams, SearchResponse } from 'meilisearch';\nimport { getDb, products, categories, eq } from '@lab404/database';\n\n// ===========================================\n// Configuration\n// ===========================================\n\nconst MEILISEARCH_HOST = process.env['MEILISEARCH_HOST'] || 'http://localhost:7700';\nconst MEILISEARCH_API_KEY = process.env['MEILISEARCH_API_KEY'] || '';\n\n// Index names\nexport const PRODUCTS_INDEX = 'products';\n\n// ===========================================\n// Types\n// ===========================================\n\nexport interface ProductDocument {\n    id: string;\n    sku: string;\n    name: string;\n    slug: string;\n    description: string | null;\n    shortDescription: string | null;\n    brand: string | null;\n    categoryId: string | null;\n    categoryName: string | null;\n    categorySlug: string | null;\n    basePrice: number;\n    compareAtPrice: number | null;\n    stockQuantity: number;\n    inStock: boolean;\n    isFeatured: boolean;\n    tags: string[];\n    thumbnailUrl: string | null;\n    images: Array<{ url: string; alt?: string }>;\n    createdAt: number;\n    updatedAt: number;\n}\n\nexport interface SearchResult {\n    hits: ProductDocument[];\n    query: string;\n    processingTimeMs: number;\n    estimatedTotalHits: number;\n    limit: number;\n    offset: number;\n    facetDistribution?: Record<string, Record<string, number>>;\n}\n\n// ===========================================\n// Meilisearch Service\n// ===========================================\n\nclass SearchService {\n    private client: MeiliSearch | null = null;\n    private initialized = false;\n\n    /**\n     * Get or create Meilisearch client\n     */\n    private getClient(): MeiliSearch {\n        if (!this.client) {\n            this.client = new MeiliSearch({\n                host: MEILISEARCH_HOST,\n                apiKey: MEILISEARCH_API_KEY,\n            });\n        }\n        return this.client;\n    }\n\n    /**\n     * Check if Meilisearch is available\n     */\n    async isAvailable(): Promise<boolean> {\n        try {\n            const client = this.getClient();\n            await client.health();\n            return true;\n        } catch (error) {\n            console.warn('Meilisearch is not available:', error instanceof Error ? error.message : 'Unknown error');\n            return false;\n        }\n    }\n\n    /**\n     * Initialize the search index with proper settings\n     */\n    async initialize(): Promise<void> {\n        if (this.initialized) {return;}\n\n        try {\n            const client = this.getClient();\n\n            // Create products index if it doesn't exist\n            try {\n                await client.getIndex(PRODUCTS_INDEX);\n            } catch {\n                await client.createIndex(PRODUCTS_INDEX, { primaryKey: 'id' });\n            }\n\n            const index = client.index(PRODUCTS_INDEX);\n\n            // Configure searchable attributes\n            await index.updateSearchableAttributes([\n                'name',\n                'description',\n                'shortDescription',\n                'sku',\n                'brand',\n                'categoryName',\n                'tags',\n            ]);\n\n            // Configure filterable attributes for faceted search\n            await index.updateFilterableAttributes([\n                'categoryId',\n                'categorySlug',\n                'inStock',\n                'isFeatured',\n                'basePrice',\n                'brand',\n                'tags',\n            ]);\n\n            // Configure sortable attributes\n            await index.updateSortableAttributes([\n                'name',\n                'basePrice',\n                'createdAt',\n                'stockQuantity',\n            ]);\n\n            // Configure ranking rules\n            await index.updateRankingRules([\n                'words',\n                'typo',\n                'proximity',\n                'attribute',\n                'sort',\n                'exactness',\n            ]);\n\n            // Configure typo tolerance\n            await index.updateTypoTolerance({\n                enabled: true,\n                minWordSizeForTypos: {\n                    oneTypo: 4,\n                    twoTypos: 8,\n                },\n            });\n\n            this.initialized = true;\n            console.log('Meilisearch initialized successfully');\n        } catch (error) {\n            console.error('Failed to initialize Meilisearch:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Get the products index\n     */\n    getProductsIndex(): Index<ProductDocument> {\n        return this.getClient().index(PRODUCTS_INDEX);\n    }\n\n    /**\n     * Index a single product\n     */\n    async indexProduct(product: ProductDocument): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.addDocuments([product]);\n        } catch (error) {\n            console.error('Failed to index product:', error);\n        }\n    }\n\n    /**\n     * Index multiple products\n     */\n    async indexProducts(productDocs: ProductDocument[]): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.addDocuments(productDocs);\n        } catch (error) {\n            console.error('Failed to index products:', error);\n        }\n    }\n\n    /**\n     * Update a product in the index\n     */\n    async updateProduct(product: ProductDocument): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.updateDocuments([product]);\n        } catch (error) {\n            console.error('Failed to update product in index:', error);\n        }\n    }\n\n    /**\n     * Remove a product from the index\n     */\n    async removeProduct(productId: string): Promise<void> {\n        try {\n            const index = this.getProductsIndex();\n            await index.deleteDocument(productId);\n        } catch (error) {\n            console.error('Failed to remove product from index:', error);\n        }\n    }\n\n    /**\n     * Search products\n     */\n    async searchProducts(\n        query: string,\n        options: {\n            limit?: number;\n            offset?: number;\n            filters?: string[];\n            sort?: string[];\n            facets?: string[];\n        } = {}\n    ): Promise<SearchResult> {\n        const { limit = 20, offset = 0, filters = [], sort = [], facets = [] } = options;\n\n        const searchParams: SearchParams = {\n            limit,\n            offset,\n            attributesToRetrieve: [\n                'id',\n                'sku',\n                'name',\n                'slug',\n                'shortDescription',\n                'brand',\n                'categoryId',\n                'categoryName',\n                'categorySlug',\n                'basePrice',\n                'compareAtPrice',\n                'stockQuantity',\n                'inStock',\n                'isFeatured',\n                'tags',\n                'thumbnailUrl',\n                'images',\n            ],\n        };\n\n        // Add filters\n        if (filters.length > 0) {\n            searchParams.filter = filters;\n        }\n\n        // Add sorting\n        if (sort.length > 0) {\n            searchParams.sort = sort;\n        }\n\n        // Add facets for filtering UI\n        if (facets.length > 0) {\n            searchParams.facets = facets;\n        }\n\n        try {\n            const index = this.getProductsIndex();\n            const response = await index.search(query, searchParams);\n\n            return {\n                hits: response.hits as ProductDocument[],\n                query: response.query,\n                processingTimeMs: response.processingTimeMs,\n                estimatedTotalHits: response.estimatedTotalHits || 0,\n                limit,\n                offset,\n                facetDistribution: response.facetDistribution,\n            };\n        } catch (error) {\n            console.error('Search failed:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Sync all products from database to Meilisearch\n     */\n    async syncAllProducts(): Promise<{ indexed: number; errors: number }> {\n        const db = getDb();\n        let indexed = 0;\n        let errors = 0;\n\n        try {\n            // Get all active products\n            const productList = await db\n                .select()\n                .from(products)\n                .where(eq(products.status, 'active'));\n\n            // Get all categories for lookup\n            const categoryList = await db.select().from(categories);\n            const categoryMap = new Map(categoryList.map(c => [c.id, c]));\n\n            // Transform products to search documents\n            const documents: ProductDocument[] = productList.map(product => {\n                const category = product.categoryId ? categoryMap.get(product.categoryId) : null;\n\n                return {\n                    id: product.id,\n                    sku: product.sku,\n                    name: product.name,\n                    slug: product.slug,\n                    description: product.description,\n                    shortDescription: product.shortDescription,\n                    brand: product.brand,\n                    categoryId: product.categoryId,\n                    categoryName: category?.name || null,\n                    categorySlug: category?.slug || null,\n                    basePrice: Number(product.basePrice),\n                    compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n                    stockQuantity: product.stockQuantity,\n                    inStock: product.stockQuantity > 0 || product.allowBackorder,\n                    isFeatured: product.isFeatured,\n                    tags: product.tags as string[] || [],\n                    thumbnailUrl: product.thumbnailUrl,\n                    images: product.images as Array<{ url: string; alt?: string }> || [],\n                    createdAt: new Date(product.createdAt).getTime(),\n                    updatedAt: new Date(product.updatedAt).getTime(),\n                };\n            });\n\n            // Index all products\n            if (documents.length > 0) {\n                const index = this.getProductsIndex();\n                // Replace all documents to ensure clean sync\n                await index.deleteAllDocuments();\n                await index.addDocuments(documents);\n                indexed = documents.length;\n            }\n\n            console.log(`Synced ${indexed} products to Meilisearch`);\n        } catch (error) {\n            console.error('Failed to sync products:', error);\n            errors++;\n        }\n\n        return { indexed, errors };\n    }\n\n    /**\n     * Get index stats\n     */\n    async getIndexStats(): Promise<{\n        numberOfDocuments: number;\n        isIndexing: boolean;\n    }> {\n        try {\n            const index = this.getProductsIndex();\n            const stats = await index.getStats();\n            return {\n                numberOfDocuments: stats.numberOfDocuments,\n                isIndexing: stats.isIndexing,\n            };\n        } catch (error) {\n            console.error('Failed to get index stats:', error);\n            return { numberOfDocuments: 0, isIndexing: false };\n        }\n    }\n}\n\n// Export singleton instance\nexport const searchService = new SearchService();\nexport { SearchService };\n","import { getDb, verificationCodes, VerificationCodeType } from '@lab404/database';\nimport { eq, and, gte, desc, or, lte } from 'drizzle-orm';\nimport { generateVerificationCode } from '../utils/crypto';\nimport { BadRequestError, TooManyRequestsError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\ninterface CreateCodeOptions {\n  email: string;\n  type: VerificationCodeType;\n  ipAddress?: string;\n  expiryMinutes?: number;\n}\n\ninterface ValidateCodeOptions {\n  email: string;\n  code: string;\n  type: VerificationCodeType;\n}\n\nclass VerificationCodeService {\n  private readonly DEFAULT_EXPIRY_MINUTES = 15;\n  private readonly MAX_ATTEMPTS = 10;\n\n  /**\n   * Generate and store a new verification code\n   * Invalidates any existing unused codes for the same email/type\n   */\n  async createCode(options: CreateCodeOptions): Promise<string> {\n    const { email, type, ipAddress, expiryMinutes = this.DEFAULT_EXPIRY_MINUTES } = options;\n    const db = getDb();\n\n    // Invalidate any existing unused codes for this email/type\n    await this.invalidateCodes(email, type);\n\n    // Generate 6-digit code\n    const code = generateVerificationCode();\n\n    // Calculate expiration\n    const expiresAt = new Date();\n    expiresAt.setMinutes(expiresAt.getMinutes() + expiryMinutes);\n\n    // Store in database\n    await db.insert(verificationCodes).values({\n      email: email.toLowerCase(),\n      code,\n      type,\n      expiresAt,\n      ipAddress,\n      maxAttempts: this.MAX_ATTEMPTS,\n    });\n\n    logger.info('Verification code created', { email, type, expiresAt });\n    return code;\n  }\n\n  /**\n   * Validate a verification code\n   * Tracks attempts and enforces expiration\n   */\n  async validateCode(options: ValidateCodeOptions): Promise<boolean> {\n    const { email, code, type } = options;\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (!record) {\n      logger.warn('Verification code not found or expired', { email, type });\n      throw new BadRequestError('Invalid or expired verification code');\n    }\n\n    // Check if max attempts exceeded\n    if (record.attempts >= record.maxAttempts) {\n      logger.warn('Max verification attempts exceeded', { email, type, attempts: record.attempts });\n      throw new TooManyRequestsError('Maximum verification attempts exceeded. Please request a new code.');\n    }\n\n    // Increment attempts\n    await db\n      .update(verificationCodes)\n      .set({ attempts: record.attempts + 1 })\n      .where(eq(verificationCodes.id, record.id));\n\n    // Validate code\n    if (record.code !== code) {\n      logger.warn('Invalid verification code attempt', { email, type, attempts: record.attempts + 1 });\n      throw new BadRequestError('Invalid verification code');\n    }\n\n    // Mark as used\n    await db\n      .update(verificationCodes)\n      .set({\n        isUsed: true,\n        usedAt: now,\n      })\n      .where(eq(verificationCodes.id, record.id));\n\n    logger.info('Verification code validated successfully', { email, type });\n    return true;\n  }\n\n  /**\n   * Validate a verification code without marking it as used\n   * Use this when you need to perform additional operations before marking as used\n   * Tracks attempts and enforces expiration\n   */\n  async validateCodeWithoutMarking(options: ValidateCodeOptions): Promise<boolean> {\n    const { email, code, type } = options;\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (!record) {\n      logger.warn('Verification code not found or expired', { email, type });\n      throw new BadRequestError('Invalid or expired verification code');\n    }\n\n    // Check if max attempts exceeded\n    if (record.attempts >= record.maxAttempts) {\n      logger.warn('Max verification attempts exceeded', { email, type, attempts: record.attempts });\n      throw new TooManyRequestsError('Maximum verification attempts exceeded. Please request a new code.');\n    }\n\n    // Increment attempts\n    await db\n      .update(verificationCodes)\n      .set({ attempts: record.attempts + 1 })\n      .where(eq(verificationCodes.id, record.id));\n\n    // Validate code\n    if (record.code !== code) {\n      logger.warn('Invalid verification code attempt', { email, type, attempts: record.attempts + 1 });\n      throw new BadRequestError('Invalid verification code');\n    }\n\n    logger.info('Verification code validated (not marked as used yet)', { email, type });\n    return true;\n  }\n\n  /**\n   * Mark a validated verification code as used\n   * Call this after validateCodeWithoutMarking() once the operation succeeds\n   */\n  async markCodeAsUsed(email: string, type: VerificationCodeType): Promise<void> {\n    const db = getDb();\n    const now = new Date();\n\n    // Find the most recent active code for this email/type\n    const [record] = await db\n      .select()\n      .from(verificationCodes)\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false),\n          gte(verificationCodes.expiresAt, now)\n        )\n      )\n      .orderBy(desc(verificationCodes.createdAt))\n      .limit(1);\n\n    if (record) {\n      await db\n        .update(verificationCodes)\n        .set({\n          isUsed: true,\n          usedAt: now,\n        })\n        .where(eq(verificationCodes.id, record.id));\n\n      logger.info('Verification code marked as used', { email, type });\n    }\n  }\n\n  /**\n   * Invalidate all unused codes for a specific email/type\n   */\n  async invalidateCodes(email: string, type: VerificationCodeType): Promise<void> {\n    const db = getDb();\n    const now = new Date();\n\n    const result = await db\n      .update(verificationCodes)\n      .set({ isUsed: true, usedAt: now })\n      .where(\n        and(\n          eq(verificationCodes.email, email.toLowerCase()),\n          eq(verificationCodes.type, type),\n          eq(verificationCodes.isUsed, false)\n        )\n      )\n      .returning({ id: verificationCodes.id });\n\n    if (result.length > 0) {\n      logger.info('Invalidated existing verification codes', {\n        email,\n        type,\n        count: result.length\n      });\n    }\n  }\n\n  /**\n   * Cleanup expired and used verification codes\n   * Called by cron job\n   */\n  async cleanupExpiredCodes(): Promise<number> {\n    const db = getDb();\n    const now = new Date();\n\n    // Delete codes that are:\n    // 1. Expired for more than 24 hours, OR\n    // 2. Used and usedAt is more than 24 hours ago\n    const cutoffDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n\n    const deleted = await db\n      .delete(verificationCodes)\n      .where(\n        or(\n          lte(verificationCodes.expiresAt, cutoffDate),\n          and(\n            eq(verificationCodes.isUsed, true),\n            lte(verificationCodes.usedAt, cutoffDate)\n          )\n        )\n      )\n      .returning({ id: verificationCodes.id });\n\n    logger.info('Verification codes cleanup completed', {\n      deletedCount: deleted.length\n    });\n\n    return deleted.length;\n  }\n}\n\nexport const verificationCodeService = new VerificationCodeService();\n","import crypto from 'crypto';\n\n/**\n * Generate a cryptographically secure random token\n * @param length Length of the token in bytes (default 32 = 64 hex chars)\n */\nexport function generateSecureToken(length = 32): string {\n  return crypto.randomBytes(length).toString('hex');\n}\n\n/**\n * Generate a short secure token (for URLs)\n * @param length Length of the token in bytes (default 24 = 48 hex chars)\n */\nexport function generateShortToken(length = 24): string {\n  return crypto.randomBytes(length).toString('hex');\n}\n\n/**\n * Hash a token using SHA256\n */\nexport function hashToken(token: string): string {\n  return crypto.createHash('sha256').update(token).digest('hex');\n}\n\n/**\n * Generate a URL-safe base64 token\n */\nexport function generateUrlSafeToken(length = 32): string {\n  return crypto.randomBytes(length).toString('base64url');\n}\n\n/**\n * Generate a cryptographically secure 6-digit verification code\n * @returns 6-digit string (000000-999999)\n */\nexport function generateVerificationCode(): string {\n  // Generate random number between 0 and 999999\n  const code = crypto.randomInt(0, 1000000);\n\n  // Pad with leading zeros to ensure 6 digits\n  return code.toString().padStart(6, '0');\n}\n","import { db } from '@lab404/database';\nimport { ipReputation, type IpReputation, type NewIpReputation } from '@lab404/database';\nimport { eq, and, lt, lte, gte } from 'drizzle-orm';\nimport { Request } from 'express';\nimport { logger } from '../utils/logger';\n\n/**\n * IP Reputation Service\n *\n * Tracks IP addresses with reputation scores for abuse prevention.\n * Used to identify and block malicious IPs automatically.\n *\n * Reputation Score System (0-100):\n * - Start: 100 (neutral)\n * - Failed login: -5\n * - Rate limit violation: -10\n * - Abuse report: -20\n * - Successful login: +2\n * - Block threshold: score < 20\n * - Suspicious threshold: score < 50\n */\nclass IpReputationService {\n  /**\n   * Track an IP action and update reputation\n   *\n   * @param ip - IP address\n   * @param action - Action type\n   * @param success - Whether the action was successful\n   * @param metadata - Additional metadata\n   */\n  async trackIP(\n    ip: string,\n    action: 'login' | 'rate_limit' | 'abuse_report' | 'api_request',\n    success: boolean,\n    metadata?: {\n      userAgent?: string;\n      country?: string;\n      reason?: string;\n    }\n  ): Promise<void> {\n    try {\n      // Get or create IP record\n      const ipRecord = await this.getOrCreateIP(ip, metadata);\n\n      // Update counters based on action\n      const updates: Partial<IpReputation> = {\n        lastSeenAt: new Date(),\n        updatedAt: new Date(),\n      };\n\n      if (action === 'login') {\n        if (success) {\n          updates.successfulLogins = (ipRecord.successfulLogins || 0) + 1;\n        } else {\n          updates.failedLoginAttempts = (ipRecord.failedLoginAttempts || 0) + 1;\n        }\n      } else if (action === 'rate_limit') {\n        updates.rateLimitViolations = (ipRecord.rateLimitViolations || 0) + 1;\n      } else if (action === 'abuse_report') {\n        updates.abuseReports = (ipRecord.abuseReports || 0) + 1;\n      }\n\n      // Update metadata if provided\n      if (metadata?.userAgent) {\n        updates.userAgent = metadata.userAgent;\n      }\n      if (metadata?.country) {\n        updates.country = metadata.country;\n      }\n\n      // Calculate new reputation score\n      const newScore = await this.calculateScore(ip);\n      updates.reputationScore = newScore;\n\n      // Auto-block if score drops below threshold\n      if (newScore < 20 && !ipRecord.isBlocked) {\n        updates.isBlocked = true;\n        updates.blockedAt = new Date();\n        updates.blockReason = 'Automatic block due to low reputation score';\n        updates.blockedUntil = null; // Permanent until manually unblocked\n\n        logger.warn('IP automatically blocked due to low reputation', {\n          ip,\n          reputationScore: newScore,\n          failedLogins: updates.failedLoginAttempts,\n          rateLimitViolations: updates.rateLimitViolations,\n          abuseReports: updates.abuseReports,\n        });\n      }\n\n      // Update the record\n      await db\n        .update(ipReputation)\n        .set(updates)\n        .where(eq(ipReputation.ipAddress, ip));\n    } catch (error) {\n      logger.error('Failed to track IP', {\n        ip,\n        action,\n        success,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      // Don't throw - tracking failures shouldn't break requests\n    }\n  }\n\n  /**\n   * Get IP reputation record\n   *\n   * @param ip - IP address\n   * @returns IP reputation or null\n   */\n  async getReputation(ip: string): Promise<IpReputation | null> {\n    try {\n      const results = await db\n        .select()\n        .from(ipReputation)\n        .where(eq(ipReputation.ipAddress, ip))\n        .limit(1);\n\n      return results[0] || null;\n    } catch (error) {\n      logger.error('Failed to get IP reputation', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Check if an IP is blocked\n   *\n   * @param ip - IP address\n   * @returns True if blocked, false otherwise\n   */\n  async isBlocked(ip: string): Promise<boolean> {\n    try {\n      const record = await this.getReputation(ip);\n\n      if (!record || !record.isBlocked) {\n        return false;\n      }\n\n      // Check if temporary block has expired\n      if (record.blockedUntil && record.blockedUntil < new Date()) {\n        // Unblock automatically\n        await this.unblockIP(ip);\n        return false;\n      }\n\n      return true;\n    } catch (error) {\n      logger.error('Failed to check if IP is blocked', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      // Default to not blocked on error to avoid false positives\n      return false;\n    }\n  }\n\n  /**\n   * Block an IP address\n   *\n   * @param ip - IP address\n   * @param reason - Block reason\n   * @param duration - Optional duration in hours (null = permanent)\n   */\n  async blockIP(ip: string, reason: string, duration?: number): Promise<void> {\n    try {\n      // Get or create IP record\n      await this.getOrCreateIP(ip);\n\n      const blockedUntil = duration\n        ? new Date(Date.now() + duration * 60 * 60 * 1000)\n        : null;\n\n      await db\n        .update(ipReputation)\n        .set({\n          isBlocked: true,\n          blockReason: reason,\n          blockedAt: new Date(),\n          blockedUntil,\n          updatedAt: new Date(),\n        })\n        .where(eq(ipReputation.ipAddress, ip));\n\n      logger.info('IP blocked', {\n        ip,\n        reason,\n        duration: duration ? `${duration} hours` : 'permanent',\n        blockedUntil: blockedUntil?.toISOString(),\n      });\n    } catch (error) {\n      logger.error('Failed to block IP', {\n        ip,\n        reason,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Unblock an IP address\n   *\n   * @param ip - IP address\n   */\n  async unblockIP(ip: string): Promise<void> {\n    try {\n      await db\n        .update(ipReputation)\n        .set({\n          isBlocked: false,\n          blockReason: null,\n          blockedAt: null,\n          blockedUntil: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(ipReputation.ipAddress, ip));\n\n      logger.info('IP unblocked', { ip });\n    } catch (error) {\n      logger.error('Failed to unblock IP', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Calculate reputation score for an IP\n   *\n   * Score calculation:\n   * - Start: 100\n   * - Failed login: -5\n   * - Rate limit violation: -10\n   * - Abuse report: -20\n   * - Successful login: +2\n   *\n   * @param ip - IP address\n   * @returns Reputation score (0-100)\n   */\n  async calculateScore(ip: string): Promise<number> {\n    try {\n      const record = await this.getReputation(ip);\n\n      if (!record) {\n        return 100; // New IPs start with perfect score\n      }\n\n      let score = 100;\n\n      // Deduct for bad behavior\n      score -= (record.failedLoginAttempts || 0) * 5;\n      score -= (record.rateLimitViolations || 0) * 10;\n      score -= (record.abuseReports || 0) * 20;\n\n      // Add for good behavior\n      score += (record.successfulLogins || 0) * 2;\n\n      // Clamp between 0 and 100\n      return Math.max(0, Math.min(100, score));\n    } catch (error) {\n      logger.error('Failed to calculate IP score', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      return 100; // Default to neutral score on error\n    }\n  }\n\n  /**\n   * Cleanup expired temporary blocks and improve reputation scores\n   *\n   * This should be run periodically (e.g., daily cron job)\n   * - Removes expired temporary blocks\n   * - Gradually improves reputation scores for IPs with score < 100\n   *\n   * @returns Object with cleanup statistics\n   */\n  async cleanupExpiredBlocks(): Promise<{\n    unblockedCount: number;\n    improvedCount: number;\n  }> {\n    try {\n      const now = new Date();\n\n      // Find and unblock expired temporary blocks\n      const expiredBlocks = await db\n        .select()\n        .from(ipReputation)\n        .where(\n          and(\n            eq(ipReputation.isBlocked, true),\n            lt(ipReputation.blockedUntil, now)\n          )\n        );\n\n      let unblockedCount = 0;\n      for (const record of expiredBlocks) {\n        if (record.blockedUntil !== null) {\n          await this.unblockIP(record.ipAddress);\n          unblockedCount++;\n        }\n      }\n\n      // Gradually improve reputation scores (increase by 10 for IPs with score < 100)\n      const ipsToImprove = await db\n        .select()\n        .from(ipReputation)\n        .where(lt(ipReputation.reputationScore, 100));\n\n      let improvedCount = 0;\n      for (const record of ipsToImprove) {\n        const newScore = Math.min(100, (record.reputationScore || 0) + 10);\n        await db\n          .update(ipReputation)\n          .set({\n            reputationScore: newScore,\n            updatedAt: new Date(),\n          })\n          .where(eq(ipReputation.ipAddress, record.ipAddress));\n        improvedCount++;\n      }\n\n      logger.info('IP reputation cleanup completed', {\n        unblockedCount,\n        improvedCount,\n        timestamp: new Date().toISOString(),\n      });\n\n      return { unblockedCount, improvedCount };\n    } catch (error) {\n      logger.error('Failed to cleanup IP reputation', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get statistics about IP reputation\n   *\n   * @returns Statistics object\n   */\n  async getStatistics(): Promise<{\n    totalIPs: number;\n    blockedIPs: number;\n    suspiciousIPs: number;\n    goodIPs: number;\n    averageScore: number;\n  }> {\n    try {\n      const allIPs = await db.select().from(ipReputation);\n\n      const stats = {\n        totalIPs: allIPs.length,\n        blockedIPs: allIPs.filter((ip) => ip.isBlocked).length,\n        suspiciousIPs: allIPs.filter(\n          (ip) => !ip.isBlocked && (ip.reputationScore || 0) < 50\n        ).length,\n        goodIPs: allIPs.filter((ip) => (ip.reputationScore || 0) >= 50).length,\n        averageScore:\n          allIPs.length > 0\n            ? allIPs.reduce((sum, ip) => sum + (ip.reputationScore || 0), 0) /\n              allIPs.length\n            : 100,\n      };\n\n      return stats;\n    } catch (error) {\n      logger.error('Failed to get IP reputation statistics', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Query IP reputations with filters and pagination\n   *\n   * @param filters - Query filters\n   * @returns Array of IP reputations\n   */\n  async query(filters: {\n    isBlocked?: boolean;\n    minScore?: number;\n    maxScore?: number;\n    limit?: number;\n    offset?: number;\n  }): Promise<IpReputation[]> {\n    try {\n      const conditions = [];\n\n      if (filters.isBlocked !== undefined) {\n        conditions.push(eq(ipReputation.isBlocked, filters.isBlocked));\n      }\n\n      if (filters.minScore !== undefined) {\n        conditions.push(gte(ipReputation.reputationScore, filters.minScore));\n      }\n\n      if (filters.maxScore !== undefined) {\n        conditions.push(lte(ipReputation.reputationScore, filters.maxScore));\n      }\n\n      let query = db\n        .select()\n        .from(ipReputation)\n        .limit(filters.limit || 50)\n        .offset(filters.offset || 0);\n\n      if (conditions.length > 0) {\n        query = query.where(and(...conditions));\n      }\n\n      const results = await query;\n      return results;\n    } catch (error) {\n      logger.error('Failed to query IP reputations', {\n        filters,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get or create an IP reputation record\n   *\n   * @param ip - IP address\n   * @param metadata - Optional metadata\n   * @returns IP reputation record\n   */\n  private async getOrCreateIP(\n    ip: string,\n    metadata?: {\n      userAgent?: string;\n      country?: string;\n    }\n  ): Promise<IpReputation> {\n    try {\n      const existing = await this.getReputation(ip);\n\n      if (existing) {\n        return existing;\n      }\n\n      // Create new record\n      const newRecord: NewIpReputation = {\n        ipAddress: ip,\n        reputationScore: 100,\n        failedLoginAttempts: 0,\n        successfulLogins: 0,\n        rateLimitViolations: 0,\n        abuseReports: 0,\n        isBlocked: false,\n        lastSeenAt: new Date(),\n        firstSeenAt: new Date(),\n        userAgent: metadata?.userAgent || null,\n        country: metadata?.country || null,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n\n      const [created] = await db.insert(ipReputation).values(newRecord).returning();\n\n      return created;\n    } catch (error) {\n      logger.error('Failed to get or create IP', {\n        ip,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get client IP address from request\n   *\n   * Handles X-Forwarded-For header for proxies\n   *\n   * @param req - Express request\n   * @returns IP address\n   */\n  getClientIp(req: Request): string {\n    const forwardedFor = req.get('x-forwarded-for');\n    if (forwardedFor) {\n      return forwardedFor.split(',')[0].trim();\n    }\n    return req.ip || req.socket.remoteAddress || 'unknown';\n  }\n}\n\nexport const ipReputationService = new IpReputationService();\n","import { getDb, carts, cartItems, eq, and, isNull } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\n/**\n * Cart Service\n * Handles cart operations including merging session carts on login\n */\nexport class CartService {\n  /**\n   * Merge session cart into customer cart on login\n   * Combines quantities for duplicate items (same product + variant)\n   *\n   * @param sessionId - Session ID from x-session-id header\n   * @param customerId - Customer ID from authenticated user\n   * @returns Number of items merged\n   */\n  async mergeSessionCart(sessionId: string, customerId: string): Promise<number> {\n    const db = getDb();\n\n    try {\n      // Find session cart\n      const [sessionCart] = await db\n        .select()\n        .from(carts)\n        .where(eq(carts.sessionId, sessionId));\n\n      if (!sessionCart) {\n        logger.debug('No session cart to merge', { sessionId, customerId });\n        return 0;\n      }\n\n      // Find or create customer cart\n      let [customerCart] = await db\n        .select()\n        .from(carts)\n        .where(eq(carts.customerId, customerId));\n\n      if (!customerCart) {\n        // Create customer cart\n        [customerCart] = await db\n          .insert(carts)\n          .values({ customerId })\n          .returning();\n      }\n\n      // Get all session cart items\n      const sessionItems = await db\n        .select()\n        .from(cartItems)\n        .where(eq(cartItems.cartId, sessionCart.id));\n\n      if (sessionItems.length === 0) {\n        // Empty session cart - just delete it\n        await db.delete(carts).where(eq(carts.id, sessionCart.id));\n        return 0;\n      }\n\n      let mergedCount = 0;\n\n      // Process each session item\n      for (const item of sessionItems) {\n        // Check if customer cart has same product+variant\n        const [existingItem] = await db\n          .select()\n          .from(cartItems)\n          .where(\n            and(\n              eq(cartItems.cartId, customerCart.id),\n              eq(cartItems.productId, item.productId),\n              item.variantId\n                ? eq(cartItems.variantId, item.variantId)\n                : isNull(cartItems.variantId)\n            )\n          );\n\n        if (existingItem) {\n          // Duplicate found - merge quantities\n          await db\n            .update(cartItems)\n            .set({\n              quantity: existingItem.quantity + item.quantity,\n              updatedAt: new Date(),\n            })\n            .where(eq(cartItems.id, existingItem.id));\n\n          logger.debug('Merged cart item quantities', {\n            productId: item.productId,\n            variantId: item.variantId,\n            oldQuantity: existingItem.quantity,\n            addedQuantity: item.quantity,\n            newQuantity: existingItem.quantity + item.quantity,\n          });\n        } else {\n          // New item - transfer to customer cart\n          await db\n            .update(cartItems)\n            .set({\n              cartId: customerCart.id,\n              updatedAt: new Date(),\n            })\n            .where(eq(cartItems.id, item.id));\n\n          logger.debug('Transferred cart item to customer', {\n            cartItemId: item.id,\n            productId: item.productId,\n          });\n        }\n\n        mergedCount++;\n      }\n\n      // Delete session cart (cascade deletes any remaining items)\n      await db.delete(carts).where(eq(carts.id, sessionCart.id));\n\n      logger.info('Cart merge completed', {\n        sessionId,\n        customerId,\n        itemsMerged: mergedCount,\n      });\n\n      return mergedCount;\n    } catch (error) {\n      logger.error('Cart merge failed', error, {\n        sessionId,\n        customerId,\n      });\n      // Don't throw - merge failure shouldn't block login\n      return 0;\n    }\n  }\n}\n\n// Export singleton instance\nexport const cartService = new CartService();\n","import nodemailer, { Transporter } from 'nodemailer';\nimport { logger } from '../utils/logger';\n\ninterface EmailAttachment {\n  filename: string;\n  content: Buffer;\n  contentType?: string;\n}\n\ninterface EmailOptions {\n  to: string | string[];\n  subject: string;\n  html: string;\n  text?: string;\n  attachments?: EmailAttachment[];\n}\n\ninterface SMTPConfig {\n  host: string;\n  port: number;\n  secure: boolean;\n  auth: {\n    user: string;\n    pass: string;\n  };\n}\n\nclass MailerService {\n  private transporter: Transporter | null = null;\n  private fromEmail: string;\n  private fromName: string;\n  private isConfigured: boolean = false;\n\n  constructor() {\n    // Use SMTP_FROM_EMAIL if set, otherwise fall back to SMTP_USER (the authenticated account)\n    // This prevents \"Sender address rejected\" errors when FROM doesn't match authenticated user\n    this.fromEmail = process.env['SMTP_FROM_EMAIL'] || process.env['SMTP_USER'] || 'noreply@lab404electronics.com';\n    this.fromName = process.env['SMTP_FROM_NAME'] || 'Lab404 Electronics';\n    this.initialize();\n  }\n\n  private initialize() {\n    const host = process.env['SMTP_HOST'];\n    const port = parseInt(process.env['SMTP_PORT'] || '587', 10);\n    const user = process.env['SMTP_USER'];\n    const pass = process.env['SMTP_PASS'];\n\n    if (!host || !user || !pass) {\n      logger.warn('SMTP not configured. Email notifications will be disabled.');\n      this.isConfigured = false;\n      return;\n    }\n\n    const config: SMTPConfig = {\n      host,\n      port,\n      secure: port === 465,\n      auth: { user, pass },\n    };\n\n    this.transporter = nodemailer.createTransport(config);\n    this.isConfigured = true;\n    logger.info('SMTP mailer initialized', { host, port });\n  }\n\n  async sendEmail(options: EmailOptions): Promise<boolean> {\n    if (!this.isConfigured || !this.transporter) {\n      logger.warn('Email not sent - SMTP not configured', { to: options.to, subject: options.subject });\n      return false;\n    }\n\n    try {\n      const mailOptions: nodemailer.SendMailOptions = {\n        from: `\"${this.fromName}\" <${this.fromEmail}>`,\n        to: Array.isArray(options.to) ? options.to.join(', ') : options.to,\n        subject: options.subject,\n        html: options.html,\n        text: options.text || this.stripHtml(options.html),\n      };\n\n      // Add attachments if provided\n      if (options.attachments && options.attachments.length > 0) {\n        mailOptions.attachments = options.attachments.map(att => ({\n          filename: att.filename,\n          content: att.content,\n          contentType: att.contentType || 'application/pdf',\n        }));\n      }\n\n      const info = await this.transporter.sendMail(mailOptions);\n\n      logger.info('Email sent successfully', { messageId: info.messageId, to: options.to });\n      return true;\n    } catch (error) {\n      logger.error('Failed to send email', { error, to: options.to, subject: options.subject });\n      return false;\n    }\n  }\n\n  private stripHtml(html: string): string {\n    return html.replace(/<[^>]*>/g, '').replace(/\\s+/g, ' ').trim();\n  }\n\n  // Verify SMTP connection\n  async verifyConnection(): Promise<boolean> {\n    if (!this.isConfigured || !this.transporter) {\n      return false;\n    }\n\n    try {\n      await this.transporter.verify();\n      logger.info('SMTP connection verified');\n      return true;\n    } catch (error) {\n      logger.error('SMTP connection verification failed', { error });\n      return false;\n    }\n  }\n\n  isReady(): boolean {\n    return this.isConfigured;\n  }\n}\n\nexport const mailerService = new MailerService();\n","import { mailerService } from './mailer.service';\nimport { logger } from '../utils/logger';\n\nexport type NotificationType =\n  | 'new_order'\n  | 'order_status_change'\n  | 'low_stock_alert'\n  | 'new_customer'\n  | 'new_contact_message'\n  | 'quotation_request'\n  | 'payment_received'\n  | 'refund_processed';\n\ninterface NotificationData {\n  [key: string]: string | number | boolean | undefined;\n}\n\ninterface NotificationSettings {\n  enabled: boolean;\n  adminEmails: string[];\n  notifications: {\n    [key in NotificationType]: boolean;\n  };\n}\n\n// Default notification settings\nconst defaultSettings: NotificationSettings = {\n  enabled: true,\n  adminEmails: [process.env['ADMIN_EMAIL'] || 'admin@lab404electronics.com'],\n  notifications: {\n    new_order: true,\n    order_status_change: true,\n    low_stock_alert: true,\n    new_customer: true,\n    new_contact_message: true,\n    quotation_request: true,\n    payment_received: true,\n    refund_processed: true,\n  },\n};\n\n// Helper to get data value safely\nfunction getData(data: NotificationData, key: string): string {\n  const value = data[key];\n  return value !== undefined ? String(value) : '';\n}\n\ninterface QuotationEmailData {\n  quotationNumber: string;\n  customerName: string;\n  customerEmail: string;\n  total: number;\n  validUntil: Date | null;\n  currency: string;\n  itemCount: number;\n  companyName: string;\n  companyEmail?: string;\n  companyPhone?: string;\n}\n\nclass NotificationService {\n  private settings: NotificationSettings = defaultSettings;\n\n  updateSettings(newSettings: Partial<NotificationSettings>) {\n    this.settings = { ...this.settings, ...newSettings };\n    logger.info('Notification settings updated', { settings: this.settings });\n  }\n\n  getSettings(): NotificationSettings {\n    return this.settings;\n  }\n\n  async notify(type: NotificationType, data: NotificationData): Promise<boolean> {\n    if (!this.settings.enabled || !this.settings.notifications[type]) {\n      logger.debug('Notification skipped - disabled', { type });\n      return false;\n    }\n\n    const template = this.getTemplate(type, data);\n    if (!template) {\n      logger.warn('No template found for notification type', { type });\n      return false;\n    }\n\n    return mailerService.sendEmail({\n      to: this.settings.adminEmails,\n      subject: template.subject,\n      html: template.html,\n    });\n  }\n\n  private getAdminUrl(): string {\n    return process.env['ADMIN_URL'] || 'http://localhost:3001';\n  }\n\n  private getTemplate(type: NotificationType, data: NotificationData): { subject: string; html: string } | null {\n    const adminUrl = this.getAdminUrl();\n\n    const templates: Record<NotificationType, () => { subject: string; html: string }> = {\n      new_order: () => ({\n        subject: `New Order #${getData(data, 'orderId')} - Lab404 Electronics`,\n        html: this.wrapTemplate(`\n          <h2>New Order Received</h2>\n          <p>A new order has been placed on your store.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Customer:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Total:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">$${getData(data, 'total')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'itemCount')} item(s)</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      order_status_change: () => ({\n        subject: `Order #${getData(data, 'orderId')} Status Changed to ${getData(data, 'newStatus')}`,\n        html: this.wrapTemplate(`\n          <h2>Order Status Updated</h2>\n          <p>Order #${getData(data, 'orderId')} status has been changed.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Previous Status:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'previousStatus')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>New Status:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong style=\"color: #2563eb;\">${getData(data, 'newStatus')}</strong></td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      low_stock_alert: () => ({\n        subject: `Low Stock Alert: ${getData(data, 'productName')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #dc2626;\">Low Stock Alert</h2>\n          <p>The following product is running low on stock:</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Product:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'productName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>SKU:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'sku')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Current Stock:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #dc2626;\"><strong>${getData(data, 'currentStock')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Threshold:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'threshold')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/products/${getData(data, 'productId')}\" style=\"background: #dc2626; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">Update Stock</a></p>\n        `),\n      }),\n\n      new_customer: () => ({\n        subject: `New Customer Registration - ${getData(data, 'customerName')}`,\n        html: this.wrapTemplate(`\n          <h2>New Customer Registered</h2>\n          <p>A new customer has registered on your store.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Name:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Registered:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${new Date().toLocaleString()}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/customers/${getData(data, 'customerId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Customer</a></p>\n        `),\n      }),\n\n      new_contact_message: () => ({\n        subject: `New Contact Message from ${getData(data, 'name')}`,\n        html: this.wrapTemplate(`\n          <h2>New Contact Message</h2>\n          <p>You have received a new message through the contact form.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Name:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'name')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'email')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Subject:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'subject')}</td>\n            </tr>\n          </table>\n          <div style=\"background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0;\">\n            <strong>Message:</strong>\n            <p style=\"margin-top: 10px;\">${getData(data, 'message')}</p>\n          </div>\n        `),\n      }),\n\n      quotation_request: () => ({\n        subject: `New Quotation Request #${getData(data, 'quotationId')}`,\n        html: this.wrapTemplate(`\n          <h2>New Quotation Request</h2>\n          <p>A new quotation request has been submitted.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Quotation ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'quotationId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Customer:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerName')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Email:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'customerEmail')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'itemCount')} item(s)</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/quotations/${getData(data, 'quotationId')}\" style=\"background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Quotation</a></p>\n        `),\n      }),\n\n      payment_received: () => ({\n        subject: `Payment Received for Order #${getData(data, 'orderId')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #16a34a;\">Payment Received</h2>\n          <p>Payment has been successfully received for an order.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Amount:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #16a34a;\"><strong>$${getData(data, 'amount')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Payment Method:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'paymentMethod')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Transaction ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'transactionId')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #16a34a; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n\n      refund_processed: () => ({\n        subject: `Refund Processed for Order #${getData(data, 'orderId')}`,\n        html: this.wrapTemplate(`\n          <h2 style=\"color: #f59e0b;\">Refund Processed</h2>\n          <p>A refund has been processed for an order.</p>\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Order ID:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">#${getData(data, 'orderId')}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Refund Amount:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd; color: #f59e0b;\"><strong>$${getData(data, 'amount')}</strong></td>\n            </tr>\n            <tr>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Reason:</strong></td>\n              <td style=\"padding: 10px; border: 1px solid #ddd;\">${getData(data, 'reason')}</td>\n            </tr>\n          </table>\n          <p><a href=\"${adminUrl}/orders/${getData(data, 'orderId')}\" style=\"background: #f59e0b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">View Order</a></p>\n        `),\n      }),\n    };\n\n    const templateFn = templates[type];\n    return templateFn ? templateFn() : null;\n  }\n\n  private wrapTemplate(content: string): string {\n    return `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; text-align: center; border-radius: 8px 8px 0 0;\">\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">Lab404 Electronics</h1>\n            <p style=\"color: rgba(255,255,255,0.8); margin: 5px 0 0 0;\">Admin Notification</p>\n          </div>\n          <div style=\"background: white; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px;\">\n            ${content}\n          </div>\n          <div style=\"text-align: center; padding: 20px; color: #6b7280; font-size: 12px;\">\n            <p>This is an automated notification from Lab404 Electronics Admin.</p>\n            <p>&copy; ${new Date().getFullYear()} Lab404 Electronics. All rights reserved.</p>\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * Send quotation email to customer with PDF attachment\n   */\n  async sendQuotationToCustomer(\n    data: QuotationEmailData,\n    pdfBuffer: Buffer\n  ): Promise<boolean> {\n    const formatCurrency = (amount: number, currency: string) => {\n      return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: currency || 'USD',\n      }).format(amount);\n    };\n\n    const formatDate = (date: Date | null) => {\n      if (!date) {return 'No expiration';}\n      return new Date(date).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n      });\n    };\n\n    const html = this.wrapCustomerTemplate(`\n      <h2>Quotation ${data.quotationNumber}</h2>\n      <p>Dear ${data.customerName},</p>\n      <p>Thank you for your interest. Please find attached your quotation from ${data.companyName}.</p>\n\n      <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Quotation Number:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${data.quotationNumber}</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Items:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${data.itemCount} item(s)</td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Total Amount:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong style=\"color: #2563eb;\">${formatCurrency(data.total, data.currency)}</strong></td>\n        </tr>\n        <tr>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\"><strong>Valid Until:</strong></td>\n          <td style=\"padding: 10px; border: 1px solid #ddd;\">${formatDate(data.validUntil)}</td>\n        </tr>\n      </table>\n\n      <p>The detailed quotation is attached as a PDF document.</p>\n\n      <p>If you have any questions or would like to proceed with this quotation, please don't hesitate to contact us:</p>\n      <ul style=\"list-style: none; padding: 0;\">\n        ${data.companyEmail ? `<li style=\"padding: 5px 0;\">Email: <a href=\"mailto:${data.companyEmail}\">${data.companyEmail}</a></li>` : ''}\n        ${data.companyPhone ? `<li style=\"padding: 5px 0;\">Phone: ${data.companyPhone}</li>` : ''}\n      </ul>\n\n      <p>We look forward to doing business with you!</p>\n      <p>Best regards,<br/>${data.companyName}</p>\n    `, data.companyName);\n\n    return mailerService.sendEmail({\n      to: data.customerEmail,\n      subject: `Quotation ${data.quotationNumber} from ${data.companyName}`,\n      html,\n      attachments: [\n        {\n          filename: `${data.quotationNumber}.pdf`,\n          content: pdfBuffer,\n          contentType: 'application/pdf',\n        },\n      ],\n    });\n  }\n\n  private wrapCustomerTemplate(content: string, companyName: string): string {\n    return `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; text-align: center; border-radius: 8px 8px 0 0;\">\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">${companyName}</h1>\n          </div>\n          <div style=\"background: white; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px;\">\n            ${content}\n          </div>\n          <div style=\"text-align: center; padding: 20px; color: #6b7280; font-size: 12px;\">\n            <p>&copy; ${new Date().getFullYear()} ${companyName}. All rights reserved.</p>\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * Send verification code email\n   */\n  async sendVerificationCode(data: {\n    email: string;\n    code: string;\n    type: 'password_reset' | 'email_verification' | 'account_unlock';\n    expiryMinutes: number;\n  }): Promise<boolean> {\n    const { email, code, type, expiryMinutes } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    // Subject based on type\n    const subjects = {\n      password_reset: 'Password Reset Verification Code',\n      email_verification: 'Email Verification Code',\n      account_unlock: 'Account Unlock Verification Code',\n    };\n    const subject = subjects[type];\n\n    // Title based on type\n    const titles = {\n      password_reset: 'Reset Your Password',\n      email_verification: 'Verify Your Email',\n      account_unlock: 'Unlock Your Account',\n    };\n    const title = titles[type];\n\n    const html = this.wrapCustomerTemplate(`\n      <h2 style=\"color: #1f2937; margin-bottom: 24px;\">${title}</h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        Your verification code is:\n      </p>\n\n      <div style=\"text-align: center; margin: 30px 0;\">\n        <div style=\"display: inline-block; background: #f3f4f6; padding: 20px 40px; border-radius: 8px; border: 2px dashed #d1d5db;\">\n          <span style=\"font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #1f2937; font-family: 'Courier New', monospace;\">\n            ${code}\n          </span>\n        </div>\n      </div>\n\n      <p style=\"color: #dc2626; font-weight: bold; font-size: 14px; margin: 20px 0;\">\n         This code will expire in ${expiryMinutes} minutes.\n      </p>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        If you didn't request this code, please ignore this email or contact our support team if you have concerns.\n      </p>\n    `, companyName);\n\n    logger.info('Sending verification code email', { email, type });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject,\n      html,\n    });\n  }\n\n  /**\n   * Send password changed confirmation email\n   * Notifies user of successful password change with timestamp and IP\n   */\n  async sendPasswordChangedConfirmation(data: {\n    email: string;\n    firstName: string | null;\n    timestamp: Date;\n    ipAddress?: string;\n  }): Promise<boolean> {\n    const { email, firstName, timestamp, ipAddress } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    // Format timestamp for display\n    const formattedTimestamp = timestamp.toLocaleString('en-US', {\n      month: 'long',\n      day: 'numeric',\n      year: 'numeric',\n      hour: 'numeric',\n      minute: '2-digit',\n      timeZoneName: 'short'\n    });\n\n    const greeting = firstName ? `Hello ${firstName},` : 'Hello,';\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <div style=\"display: inline-block; background: #16a34a; color: white; width: 48px; height: 48px; border-radius: 50%; line-height: 48px; font-size: 24px; margin-bottom: 16px;\">\n          \n        </div>\n      </div>\n\n      <h2 style=\"color: #1f2937; margin-bottom: 24px; text-align: center;\">\n        Password Changed Successfully\n      </h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        ${greeting}\n      </p>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        Your password was successfully changed on <strong>${formattedTimestamp}</strong>.\n      </p>\n\n      ${ipAddress ? `\n        <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 24px 0; border-left: 4px solid #2563eb;\">\n          <p style=\"margin: 0; color: #6b7280; font-size: 14px;\">\n            <strong>Security Details:</strong><br>\n            From IP address: <code style=\"background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace;\">${ipAddress}</code>\n          </p>\n        </div>\n      ` : ''}\n\n      <div style=\"background: #fef2f2; border: 1px solid #fecaca; padding: 20px; border-radius: 8px; margin: 30px 0;\">\n        <p style=\"color: #dc2626; font-weight: bold; font-size: 16px; margin: 0 0 12px 0;\">\n           Did you make this change?\n        </p>\n        <p style=\"color: #991b1b; font-size: 14px; line-height: 20px; margin: 0;\">\n          If you did not change your password, please contact our support team immediately to secure your account.\n        </p>\n      </div>\n\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"mailto:contact@lab404electronics.com?subject=Unauthorized%20Password%20Change\"\n           style=\"display: inline-block; background: #2563eb; color: white; text-decoration: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; font-size: 16px;\">\n          Contact Support\n        </a>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        For security reasons, we recommend using a strong, unique password and enabling two-factor authentication when available.\n      </p>\n    `, companyName);\n\n    logger.info('Sending password changed confirmation email', { email });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject: `Your Password Was Changed - ${companyName}`,\n      html,\n    });\n  }\n\n  /**\n   * Send email verification code for new account registration\n   * Welcomes user and provides 6-digit verification code\n   */\n  async sendEmailVerification(data: {\n    email: string;\n    firstName: string | null;\n    code: string;\n    expiryMinutes: number;\n  }): Promise<boolean> {\n    const { email, firstName, code, expiryMinutes } = data;\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n\n    const greeting = firstName ? `Hello ${firstName},` : 'Hello,';\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <div style=\"display: inline-block; background: #2563eb; color: white; width: 48px; height: 48px; border-radius: 50%; line-height: 48px; font-size: 24px; margin-bottom: 16px;\">\n          \n        </div>\n      </div>\n\n      <h2 style=\"color: #1f2937; margin-bottom: 24px; text-align: center;\">\n        Welcome to ${companyName}!\n      </h2>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 20px;\">\n        ${greeting}\n      </p>\n\n      <p style=\"color: #4b5563; font-size: 16px; line-height: 24px; margin-bottom: 30px;\">\n        Thank you for creating an account with us. To complete your registration and activate your account, please verify your email address using the code below.\n      </p>\n\n      <div style=\"background: #eff6ff; border: 2px solid #2563eb; padding: 24px; border-radius: 8px; margin: 30px 0; text-align: center;\">\n        <p style=\"color: #1e40af; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;\">\n          Your Verification Code\n        </p>\n        <p style=\"color: #1e3a8a; font-size: 36px; font-weight: bold; letter-spacing: 8px; margin: 0; font-family: 'Courier New', monospace;\">\n          ${code}\n        </p>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-bottom: 20px; text-align: center;\">\n        This code will expire in <strong>${expiryMinutes} minutes</strong>.\n      </p>\n\n      <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 24px 0;\">\n        <p style=\"margin: 0; color: #6b7280; font-size: 14px; line-height: 20px;\">\n          <strong>Didn't create an account?</strong><br>\n          If you didn't request this verification code, you can safely ignore this email. Your email address will not be used without verification.\n        </p>\n      </div>\n\n      <p style=\"color: #6b7280; font-size: 14px; line-height: 20px; margin-top: 30px;\">\n        Need help? Contact our support team at <a href=\"mailto:contact@lab404electronics.com\" style=\"color: #2563eb; text-decoration: none;\">contact@lab404electronics.com</a>\n      </p>\n    `, companyName);\n\n    logger.info('Sending email verification code', { email });\n\n    return mailerService.sendEmail({\n      to: email,\n      subject: `Verify Your Email Address - ${companyName}`,\n      html,\n    });\n  }\n\n  /**\n   * Send quotation expiry reminder to customer\n   */\n  async sendQuotationExpiryReminder(\n    customerEmail: string,\n    customerName: string,\n    quotationNumber: string,\n    daysUntilExpiry: number,\n    expiryDate: Date,\n    acceptanceToken?: string\n  ): Promise<boolean> {\n    const companyName = process.env['COMPANY_NAME'] || 'Lab404 Electronics';\n    const websiteUrl = process.env['WEBSITE_URL'] || 'https://lab404electronics.com';\n\n    const formatDate = (date: Date) => {\n      return new Date(date).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n      });\n    };\n\n    const urgencyColor = daysUntilExpiry <= 1 ? '#dc2626' : daysUntilExpiry <= 3 ? '#f59e0b' : '#3b82f6';\n    const urgencyText = daysUntilExpiry <= 1 ? 'Expires Tomorrow!' : `Expires in ${daysUntilExpiry} Days`;\n\n    const viewLink = acceptanceToken\n      ? `${websiteUrl}/quotations/view/${acceptanceToken}`\n      : null;\n\n    const html = this.wrapCustomerTemplate(`\n      <div style=\"text-align: center; padding: 20px 0;\">\n        <span style=\"background: ${urgencyColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px;\">\n          ${urgencyText}\n        </span>\n      </div>\n\n      <h2>Quotation Expiry Reminder</h2>\n      <p>Dear ${customerName},</p>\n      <p>This is a friendly reminder that your quotation <strong>${quotationNumber}</strong> will expire on <strong style=\"color: ${urgencyColor};\">${formatDate(expiryDate)}</strong>.</p>\n\n      <div style=\"background: #f8fafc; border-left: 4px solid ${urgencyColor}; padding: 15px; margin: 20px 0;\">\n        <p style=\"margin: 0;\"><strong>Don't miss out!</strong> Review and accept your quotation before it expires to secure your pricing.</p>\n      </div>\n\n      ${viewLink ? `\n        <p style=\"text-align: center; margin: 30px 0;\">\n          <a href=\"${viewLink}\" style=\"background: #2563eb; color: white; padding: 14px 28px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;\">\n            View & Accept Quotation\n          </a>\n        </p>\n      ` : ''}\n\n      <p>If you have any questions or need to discuss the quotation, please don't hesitate to contact us.</p>\n\n      <p>Best regards,<br/>${companyName}</p>\n    `, companyName);\n\n    return mailerService.sendEmail({\n      to: customerEmail,\n      subject: `${urgencyText}: Quotation ${quotationNumber} - ${companyName}`,\n      html,\n    });\n  }\n}\n\nexport const notificationService = new NotificationService();\n","import bcrypt from 'bcryptjs';\nimport zxcvbn from 'zxcvbn';\nimport { getDb, passwordHistory, eq, desc, NewPasswordHistory } from '@lab404/database';\nimport { HIBPService } from './hibp.service';\n\n/**\n * Password Security Service\n *\n * Handles password strength calculation, history tracking, and breach checking.\n * Enforces password reuse prevention and provides feedback on password quality.\n */\n\ninterface PasswordStrengthResult {\n  score: number; // 0-4 (zxcvbn scale)\n  feedback: {\n    warning: string;\n    suggestions: string[];\n  };\n  crackTime: string; // Human-readable crack time estimate\n  isBreached: boolean;\n  breachCount: number;\n  isReused: boolean;\n}\n\ninterface PasswordValidationResult {\n  isValid: boolean;\n  errors: string[];\n  strengthResult?: PasswordStrengthResult;\n}\n\nexport class PasswordSecurityService {\n  private static readonly HISTORY_LIMIT = 10; // Store last 10 passwords\n  private static readonly MIN_STRENGTH_SCORE = 2; // Require at least score 2 (fair)\n\n  /**\n   * Calculate password strength using zxcvbn\n   *\n   * @param password - Plain text password\n   * @param userInputs - Optional array of user-specific strings (email, name, etc.)\n   * @returns Strength analysis\n   */\n  static async calculateStrength(\n    password: string,\n    userInputs?: string[]\n  ): Promise<Omit<PasswordStrengthResult, 'isBreached' | 'breachCount' | 'isReused'>> {\n    const result = zxcvbn(password, userInputs);\n\n    return {\n      score: result.score,\n      feedback: {\n        warning: result.feedback.warning || '',\n        suggestions: result.feedback.suggestions || [],\n      },\n      crackTime: result.crack_times_display.offline_slow_hashing_1e4_per_second,\n    };\n  }\n\n  /**\n   * Check if password has been used before by this customer\n   *\n   * @param customerId - Customer ID\n   * @param password - Plain text password to check\n   * @returns True if password was used before\n   */\n  static async checkPasswordHistory(\n    customerId: string,\n    password: string\n  ): Promise<boolean> {\n    try {\n      const db = getDb();\n\n      // Get last N password hashes\n      const history = await db\n        .select()\n        .from(passwordHistory)\n        .where(eq(passwordHistory.customerId, customerId))\n        .orderBy(desc(passwordHistory.changedAt))\n        .limit(this.HISTORY_LIMIT);\n\n      // Check if new password matches any previous hash\n      for (const entry of history) {\n        const matches = await bcrypt.compare(password, entry.passwordHash);\n        if (matches) {\n          return true; // Password was used before\n        }\n      }\n\n      return false;\n    } catch (error) {\n      // Table doesn't exist or query failed - skip history check\n      console.warn('Failed to check password history (table may not exist):', error);\n      return false; // Allow password since we can't verify history\n    }\n  }\n\n  /**\n   * Record password change in history\n   *\n   * @param data - Password history entry data\n   */\n  static async recordPasswordChange(data: NewPasswordHistory): Promise<void> {\n    try {\n      const db = getDb();\n\n      await db.insert(passwordHistory).values(data);\n\n      // Keep only last N passwords\n      const allHistory = await db\n        .select()\n        .from(passwordHistory)\n        .where(eq(passwordHistory.customerId, data.customerId))\n        .orderBy(desc(passwordHistory.changedAt));\n\n      if (allHistory.length > this.HISTORY_LIMIT) {\n        const idsToDelete = allHistory\n          .slice(this.HISTORY_LIMIT)\n          .map((entry) => entry.id);\n\n        if (idsToDelete.length > 0) {\n          await db\n            .delete(passwordHistory)\n            .where(eq(passwordHistory.id, idsToDelete[0])); // Simplified for demo\n        }\n      }\n    } catch (error) {\n      // Table doesn't exist or insert failed - non-critical, just log warning\n      // Password change will still succeed, history just won't be recorded\n      console.warn('Failed to record password change (table may not exist):', error);\n      // Don't throw - allow password change to succeed\n    }\n  }\n\n  /**\n   * Validate password with comprehensive checks\n   *\n   * @param password - Plain text password\n   * @param customerId - Customer ID\n   * @param userInputs - Optional array of user-specific strings\n   * @returns Validation result with detailed feedback\n   */\n  static async validatePassword(\n    password: string,\n    customerId: string,\n    userInputs?: string[]\n  ): Promise<PasswordValidationResult> {\n    const errors: string[] = [];\n\n    // Basic length check\n    if (password.length < 8) {\n      errors.push(' Password Length: Must be at least 8 characters long. Current length: ' + password.length);\n    }\n\n    if (password.length > 100) {\n      errors.push(' Password Length: Must not exceed 100 characters. Current length: ' + password.length);\n    }\n\n    // Calculate strength\n    const strength = await this.calculateStrength(password, userInputs);\n\n    if (strength.score < this.MIN_STRENGTH_SCORE) {\n      const warningText = strength.feedback.warning || 'This password is too predictable.';\n      errors.push(\n        ` Password Strength: Your password is too weak (${strength.score}/4). ${warningText}`\n      );\n      if (strength.feedback.suggestions.length > 0) {\n        errors.push(` Suggestions: ${strength.feedback.suggestions.join(' ')}`);\n      }\n    }\n\n    // Check breach status\n    const breachResult = await HIBPService.checkPassword(password, customerId);\n\n    if (breachResult.isBreached) {\n      const breachText = breachResult.breachCount > 1000\n        ? `${(breachResult.breachCount / 1000).toFixed(1)}k+`\n        : breachResult.breachCount.toString();\n\n      errors.push(\n        ` Security Alert: This password has been exposed in ${breachText} data breaches and is not safe to use. Please choose a unique password that you haven't used elsewhere.`\n      );\n    }\n\n    // Check password history\n    const isReused = await this.checkPasswordHistory(customerId, password);\n\n    if (isReused) {\n      errors.push(' Password History: You\\'ve used this password before. For security, please choose a new password you haven\\'t used on this account.');\n    }\n\n    // Build complete strength result\n    const strengthResult: PasswordStrengthResult = {\n      ...strength,\n      isBreached: breachResult.isBreached,\n      breachCount: breachResult.breachCount,\n      isReused,\n    };\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n      strengthResult,\n    };\n  }\n\n  /**\n   * Validate password without checking history (for new users)\n   *\n   * @param password - Plain text password\n   * @param userInputs - Optional array of user-specific strings\n   * @returns Validation result\n   */\n  static async validateNewPassword(\n    password: string,\n    userInputs?: string[]\n  ): Promise<PasswordValidationResult> {\n    const errors: string[] = [];\n\n    // Basic length check\n    if (password.length < 8) {\n      errors.push(' Password Length: Must be at least 8 characters long. Current length: ' + password.length);\n    }\n\n    if (password.length > 100) {\n      errors.push(' Password Length: Must not exceed 100 characters. Current length: ' + password.length);\n    }\n\n    // Calculate strength\n    const strength = await this.calculateStrength(password, userInputs);\n\n    if (strength.score < this.MIN_STRENGTH_SCORE) {\n      const warningText = strength.feedback.warning || 'This password is too predictable.';\n      errors.push(\n        ` Password Strength: Your password is too weak (${strength.score}/4). ${warningText}`\n      );\n      if (strength.feedback.suggestions.length > 0) {\n        errors.push(` Suggestions: ${strength.feedback.suggestions.join(' ')}`);\n      }\n    }\n\n    // Check breach status (no customer ID for caching)\n    const breachResult = await HIBPService.checkPassword(password);\n\n    if (breachResult.isBreached) {\n      const breachText = breachResult.breachCount > 1000\n        ? `${(breachResult.breachCount / 1000).toFixed(1)}k+`\n        : breachResult.breachCount.toString();\n\n      errors.push(\n        ` Security Alert: This password has been exposed in ${breachText} data breaches and is not safe to use. Please choose a unique password that you haven't used elsewhere.`\n      );\n    }\n\n    const strengthResult: PasswordStrengthResult = {\n      ...strength,\n      isBreached: breachResult.isBreached,\n      breachCount: breachResult.breachCount,\n      isReused: false,\n    };\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n      strengthResult,\n    };\n  }\n}\n","import crypto from 'crypto';\nimport { getDb, breachChecks, eq } from '@lab404/database';\n\n/**\n * Have I Been Pwned (HIBP) Service\n *\n * Checks passwords against the HIBP Pwned Passwords API using k-anonymity.\n * This ensures password privacy by only sending the first 5 characters of the SHA-1 hash.\n *\n * API Documentation: https://haveibeenpwned.com/API/v3#PwnedPasswords\n */\n\ninterface BreachCheckResult {\n  isBreached: boolean;\n  breachCount: number;\n  cached: boolean;\n}\n\nexport class HIBPService {\n  private static readonly HIBP_API_URL = 'https://api.pwnedpasswords.com/range';\n  private static readonly CACHE_DURATION_DAYS = 30;\n\n  /**\n   * Check if a password has been found in data breaches\n   * Uses k-anonymity to protect password privacy\n   *\n   * @param password - Plain text password to check\n   * @param customerId - Optional customer ID for caching\n   * @returns Breach status and count\n   */\n  static async checkPassword(\n    password: string,\n    customerId?: string\n  ): Promise<BreachCheckResult> {\n    // Generate SHA-1 hash of password\n    const hash = crypto.createHash('sha1').update(password).digest('hex').toUpperCase();\n    const hashPrefix = hash.substring(0, 5);\n    const hashSuffix = hash.substring(5);\n\n    // Check cache first if customer ID provided\n    if (customerId) {\n      const cachedResult = await this.getCachedResult(customerId, hashPrefix);\n      if (cachedResult) {\n        return cachedResult;\n      }\n    }\n\n    // Query HIBP API with hash prefix (k-anonymity)\n    try {\n      const response = await fetch(`${this.HIBP_API_URL}/${hashPrefix}`, {\n        headers: {\n          'User-Agent': 'Lab404-Electronics-Auth-System',\n        },\n      });\n\n      if (!response.ok) {\n        // If HIBP is down, gracefully degrade (allow password but log warning)\n        console.warn(`HIBP API returned ${response.status}, allowing password by default`);\n        return { isBreached: false, breachCount: 0, cached: false };\n      }\n\n      const body = await response.text();\n      const lines = body.split('\\n');\n\n      // Check if our hash suffix appears in the results\n      let breachCount = 0;\n      for (const line of lines) {\n        const [suffix, count] = line.split(':');\n        if (suffix.trim() === hashSuffix) {\n          breachCount = parseInt(count.trim(), 10);\n          break;\n        }\n      }\n\n      const result: BreachCheckResult = {\n        isBreached: breachCount > 0,\n        breachCount,\n        cached: false,\n      };\n\n      // Cache result if customer ID provided\n      if (customerId) {\n        await this.setCachedResult(customerId, hashPrefix, result);\n      }\n\n      return result;\n    } catch (error) {\n      // Network error or API unavailable - gracefully degrade\n      console.error('HIBP API check failed:', error);\n      return { isBreached: false, breachCount: 0, cached: false };\n    }\n  }\n\n  /**\n   * Get cached breach check result\n   *\n   * @param customerId - Customer ID\n   * @param hashPrefix - First 5 characters of SHA-1 hash\n   * @returns Cached result if valid, null otherwise\n   */\n  private static async getCachedResult(\n    customerId: string,\n    hashPrefix: string\n  ): Promise<BreachCheckResult | null> {\n    try {\n      const db = getDb();\n\n      const cached = await db\n        .select()\n        .from(breachChecks)\n        .where(eq(breachChecks.customerId, customerId))\n        .where(eq(breachChecks.passwordHashPrefix, hashPrefix))\n        .limit(1);\n\n      if (cached.length === 0) {\n        return null;\n      }\n\n      const check = cached[0];\n\n      // Check if cache is still valid\n      if (new Date() > check.expiresAt) {\n        return null;\n      }\n\n      return {\n        isBreached: check.isBreached,\n        breachCount: check.breachCount,\n        cached: true,\n      };\n    } catch (error) {\n      // Table doesn't exist or query failed - skip cache\n      console.warn('Failed to get cached breach check result:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Cache breach check result\n   *\n   * @param customerId - Customer ID\n   * @param hashPrefix - First 5 characters of SHA-1 hash\n   * @param result - Breach check result to cache\n   */\n  private static async setCachedResult(\n    customerId: string,\n    hashPrefix: string,\n    result: BreachCheckResult\n  ): Promise<void> {\n    try {\n      const db = getDb();\n\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + this.CACHE_DURATION_DAYS);\n\n      await db.insert(breachChecks).values({\n        customerId,\n        passwordHashPrefix: hashPrefix,\n        isBreached: result.isBreached,\n        breachCount: result.breachCount,\n        expiresAt,\n        checkReason: 'password_change',\n      });\n    } catch (error) {\n      // Cache insertion failed or table doesn't exist - non-critical, just log\n      console.warn('Failed to cache HIBP result:', error);\n    }\n  }\n\n  /**\n   * Clean up expired cache entries\n   * Should be called periodically via cron job\n   */\n  static async cleanupExpiredCache(): Promise<number> {\n    const db = getDb();\n\n    try {\n      const result = await db\n        .delete(breachChecks)\n        .where(eq(breachChecks.expiresAt, new Date()));\n\n      return result.rowCount || 0;\n    } catch (error) {\n      console.error('Failed to cleanup expired breach checks:', error);\n      return 0;\n    }\n  }\n}\n","import { getDb } from '@lab404/database';\nimport { securityAuditLogs, type SecurityAuditLog, type NewSecurityAuditLog } from '@lab404/database';\nimport { eq, and, gte, lte, inArray, desc, sql } from 'drizzle-orm';\nimport { Request } from 'express';\nimport type {\n  SecurityEventType,\n  ActorType,\n  EventStatus,\n  AuditLogEvent,\n} from '../types/audit-events';\nimport { logger } from '../utils/logger';\n\n/**\n * Audit Log Service\n *\n * Handles security audit logging for compliance, forensics, and monitoring.\n *\n * Key Features:\n * - Async, non-blocking logging (fire-and-forget)\n * - Automatic context extraction from Express requests\n * - Immutable append-only logs\n * - 90-day retention\n * - Query and export interfaces\n */\nclass AuditLogService {\n  /**\n   * Log a security event\n   *\n   * @param event - The security event to log\n   * @returns Promise<void> - Fire-and-forget, errors are logged but don't throw\n   */\n  async log(event: AuditLogEvent): Promise<void> {\n    try {\n      const db = getDb();\n      const logEntry: NewSecurityAuditLog = {\n        timestamp: new Date(),\n        eventType: event.eventType,\n        actorType: event.actorType,\n        actorId: event.actorId || null,\n        actorEmail: event.actorEmail || null,\n        targetType: event.targetType || null,\n        targetId: event.targetId || null,\n        action: event.action,\n        status: event.status,\n        ipAddress: event.ipAddress || null,\n        userAgent: event.userAgent || null,\n        sessionId: event.sessionId || null,\n        requestId: event.requestId || null,\n        metadata: event.metadata || null,\n        createdAt: new Date(),\n      };\n\n      await db.insert(securityAuditLogs).values(logEntry);\n    } catch (error) {\n      // Log failures don't break requests\n      logger.error('Failed to write audit log', {\n        event,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n    }\n  }\n\n  /**\n   * Log a security event from an Express request\n   *\n   * Automatically extracts context (IP, User-Agent, session, etc.)\n   *\n   * @param req - Express request object\n   * @param event - Partial event (context auto-filled)\n   */\n  async logFromRequest(\n    req: Request,\n    event: Omit<AuditLogEvent, 'ipAddress' | 'userAgent' | 'sessionId' | 'requestId'>\n  ): Promise<void> {\n    const fullEvent: AuditLogEvent = {\n      ...event,\n      ipAddress: this.getClientIp(req),\n      userAgent: req.get('user-agent') || undefined,\n      sessionId: (req as any).user?.sessionId || undefined,\n      requestId: (req as any).id || undefined,\n    };\n\n    await this.log(fullEvent);\n  }\n\n  /**\n   * Query audit logs with filters and pagination\n   *\n   * @param filters - Query filters\n   * @returns Array of audit logs\n   */\n  async query(filters: {\n    actorId?: string;\n    eventTypes?: SecurityEventType[];\n    status?: EventStatus;\n    ipAddress?: string;\n    sessionId?: string;\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n    offset?: number;\n  }): Promise<SecurityAuditLog[]> {\n    try {\n      const db = getDb();\n      const conditions = [];\n\n      if (filters.actorId) {\n        conditions.push(eq(securityAuditLogs.actorId, filters.actorId));\n      }\n\n      if (filters.eventTypes && filters.eventTypes.length > 0) {\n        conditions.push(inArray(securityAuditLogs.eventType, filters.eventTypes));\n      }\n\n      if (filters.status) {\n        conditions.push(eq(securityAuditLogs.status, filters.status));\n      }\n\n      if (filters.ipAddress) {\n        conditions.push(eq(securityAuditLogs.ipAddress, filters.ipAddress));\n      }\n\n      if (filters.sessionId) {\n        conditions.push(eq(securityAuditLogs.sessionId, filters.sessionId));\n      }\n\n      if (filters.startDate) {\n        conditions.push(gte(securityAuditLogs.timestamp, filters.startDate));\n      }\n\n      if (filters.endDate) {\n        conditions.push(lte(securityAuditLogs.timestamp, filters.endDate));\n      }\n\n      let query = db\n        .select()\n        .from(securityAuditLogs)\n        .orderBy(desc(securityAuditLogs.timestamp))\n        .limit(filters.limit || 50)\n        .offset(filters.offset || 0);\n\n      if (conditions.length > 0) {\n        query = query.where(and(...conditions));\n      }\n\n      const results = await query;\n      return results;\n    } catch (error) {\n      logger.error('Failed to query audit logs', {\n        filters,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get a single audit log by ID\n   *\n   * @param id - Audit log ID\n   * @returns Audit log or null\n   */\n  async getById(id: string): Promise<SecurityAuditLog | null> {\n    try {\n      const db = getDb();\n      const results = await db\n        .select()\n        .from(securityAuditLogs)\n        .where(eq(securityAuditLogs.id, id))\n        .limit(1);\n\n      return results[0] || null;\n    } catch (error) {\n      logger.error('Failed to get audit log by ID', {\n        id,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Export audit logs to JSON\n   *\n   * @param filters - Query filters\n   * @returns JSON string of audit logs\n   */\n  async exportToJSON(filters: Parameters<typeof this.query>[0]): Promise<string> {\n    const logs = await this.query({ ...filters, limit: 10000 });\n    return JSON.stringify(logs, null, 2);\n  }\n\n  /**\n   * Export audit logs to CSV\n   *\n   * @param filters - Query filters\n   * @returns CSV string of audit logs\n   */\n  async exportToCSV(filters: Parameters<typeof this.query>[0]): Promise<string> {\n    const logs = await this.query({ ...filters, limit: 10000 });\n\n    if (logs.length === 0) {\n      return 'No logs found';\n    }\n\n    // CSV headers\n    const headers = [\n      'ID',\n      'Timestamp',\n      'Event Type',\n      'Actor Type',\n      'Actor ID',\n      'Actor Email',\n      'Target Type',\n      'Target ID',\n      'Action',\n      'Status',\n      'IP Address',\n      'User Agent',\n      'Session ID',\n      'Request ID',\n      'Metadata',\n    ].join(',');\n\n    // CSV rows\n    const rows = logs.map((log) => {\n      return [\n        log.id,\n        log.timestamp.toISOString(),\n        log.eventType,\n        log.actorType,\n        log.actorId || '',\n        log.actorEmail || '',\n        log.targetType || '',\n        log.targetId || '',\n        log.action,\n        log.status,\n        log.ipAddress || '',\n        log.userAgent ? `\"${log.userAgent.replace(/\"/g, '\"\"')}\"` : '',\n        log.sessionId || '',\n        log.requestId || '',\n        log.metadata ? `\"${JSON.stringify(log.metadata).replace(/\"/g, '\"\"')}\"` : '',\n      ].join(',');\n    });\n\n    return `${headers}\\n${rows.join('\\n')}`;\n  }\n\n  /**\n   * Delete audit logs older than retention period (90 days)\n   *\n   * @returns Number of deleted logs\n   */\n  async cleanup(): Promise<number> {\n    try {\n      const db = getDb();\n      const retentionDays = 90;\n      const cutoffDate = new Date();\n      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\n\n      const deletedLogs = await db\n        .delete(securityAuditLogs)\n        .where(lte(securityAuditLogs.timestamp, cutoffDate))\n        .returning({ id: securityAuditLogs.id });\n\n      logger.info('Audit log cleanup completed', {\n        deletedCount: deletedLogs.length,\n        cutoffDate: cutoffDate.toISOString(),\n      });\n\n      return deletedLogs.length;\n    } catch (error) {\n      logger.error('Failed to cleanup audit logs', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get statistics about audit logs\n   *\n   * @param filters - Optional filters\n   * @returns Statistics object\n   */\n  async getStatistics(filters?: {\n    startDate?: Date;\n    endDate?: Date;\n    actorId?: string;\n  }): Promise<{\n    totalLogs: number;\n    successCount: number;\n    failureCount: number;\n    deniedCount: number;\n    eventTypeCounts: Record<string, number>;\n  }> {\n    try {\n      const db = getDb();\n      const conditions = [];\n\n      if (filters?.startDate) {\n        conditions.push(gte(securityAuditLogs.timestamp, filters.startDate));\n      }\n\n      if (filters?.endDate) {\n        conditions.push(lte(securityAuditLogs.timestamp, filters.endDate));\n      }\n\n      if (filters?.actorId) {\n        conditions.push(eq(securityAuditLogs.actorId, filters.actorId));\n      }\n\n      let logsQuery = db.select().from(securityAuditLogs);\n\n      if (conditions.length > 0) {\n        logsQuery = logsQuery.where(and(...conditions));\n      }\n\n      const logs = await logsQuery;\n\n      const stats = {\n        totalLogs: logs.length,\n        successCount: logs.filter((log) => log.status === 'success').length,\n        failureCount: logs.filter((log) => log.status === 'failure').length,\n        deniedCount: logs.filter((log) => log.status === 'denied').length,\n        eventTypeCounts: logs.reduce(\n          (acc, log) => {\n            acc[log.eventType] = (acc[log.eventType] || 0) + 1;\n            return acc;\n          },\n          {} as Record<string, number>\n        ),\n      };\n\n      return stats;\n    } catch (error) {\n      logger.error('Failed to get audit log statistics', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Get client IP address from request\n   *\n   * Handles X-Forwarded-For header for proxies\n   *\n   * @param req - Express request\n   * @returns IP address\n   */\n  private getClientIp(req: Request): string {\n    const forwardedFor = req.get('x-forwarded-for');\n    if (forwardedFor) {\n      return forwardedFor.split(',')[0].trim();\n    }\n    return req.ip || req.socket.remoteAddress || 'unknown';\n  }\n}\n\nexport const auditLogService = new AuditLogService();\n","/**\n * Security Audit Event Types\n *\n * Comprehensive enum of all security-relevant events for audit logging.\n * Used by AuditLogService to categorize and track security events.\n */\n\nexport enum SecurityEventType {\n  // Authentication Events\n  AUTH_LOGIN_SUCCESS = 'auth.login.success',\n  AUTH_LOGIN_FAILURE = 'auth.login.failure',\n  AUTH_LOGIN_LOCKED = 'auth.login.locked',\n  AUTH_LOGOUT = 'auth.logout',\n  AUTH_SESSION_CREATED = 'auth.session.created',\n  AUTH_SESSION_REVOKED = 'auth.session.revoked',\n\n  // Password Events\n  PASSWORD_CHANGED = 'password.changed',\n  PASSWORD_RESET_REQUESTED = 'password.reset.requested',\n  PASSWORD_RESET_COMPLETED = 'password.reset.completed',\n  PASSWORD_BREACH_DETECTED = 'password.breach.detected',\n  PASSWORD_REUSE_BLOCKED = 'password.reuse.blocked',\n\n  // Account Management Events\n  ACCOUNT_CREATED = 'account.created',\n  ACCOUNT_VERIFIED = 'account.verified',\n  ACCOUNT_LOCKED = 'account.locked',\n  ACCOUNT_UNLOCKED = 'account.unlocked',\n  ACCOUNT_DISABLED = 'account.disabled',\n  EMAIL_CHANGED = 'email.changed',\n  EMAIL_VERIFICATION_SENT = 'email.verification.sent',\n\n  // Authorization Events\n  PERMISSION_DENIED = 'permission.denied',\n  ADMIN_ACCESS_GRANTED = 'admin.access.granted',\n  ADMIN_ACTION = 'admin.action.performed',\n\n  // Security Events\n  RATE_LIMIT_EXCEEDED = 'rate_limit.exceeded',\n  SUSPICIOUS_ACTIVITY = 'suspicious_activity.detected',\n}\n\nexport enum ActorType {\n  CUSTOMER = 'customer',\n  ADMIN = 'admin',\n  SYSTEM = 'system',\n}\n\nexport enum EventStatus {\n  SUCCESS = 'success',\n  FAILURE = 'failure',\n  DENIED = 'denied',\n}\n\nexport interface AuditLogEvent {\n  eventType: SecurityEventType;\n  actorType: ActorType;\n  actorId?: string;\n  actorEmail?: string;\n  targetType?: string;\n  targetId?: string;\n  action: string;\n  status: EventStatus;\n  ipAddress?: string;\n  userAgent?: string;\n  sessionId?: string;\n  requestId?: string;\n  metadata?: Record<string, any>;\n}\n","import { getDb, loginAttempts, customers, eq, desc, and, gte, NewLoginAttempt } from '@lab404/database';\nimport { auditLogService } from './audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\n\n/**\n * Login Attempt Service\n *\n * Tracks login attempts and manages account lockouts.\n * Implements exponential backoff and automatic lockout after repeated failures.\n */\n\ninterface LockoutStatus {\n  isLocked: boolean;\n  lockoutEndTime?: Date;\n  consecutiveFailures: number;\n  remainingTime?: number; // milliseconds\n}\n\ninterface DeviceInfo {\n  deviceType?: string;\n  deviceBrowser?: string;\n  ipAddress: string;\n  userAgent?: string;\n  ipCountry?: string;\n  ipCity?: string;\n}\n\nexport class LoginAttemptService {\n  private static readonly MAX_ATTEMPTS = 5; // Lock after 5 failures\n  private static readonly LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutes\n  private static readonly ATTEMPT_WINDOW_MS = 30 * 60 * 1000; // 30-minute window for counting attempts\n\n  /**\n   * Record a login attempt\n   *\n   * @param email - Email address attempted\n   * @param success - Whether login was successful\n   * @param customerId - Customer ID (if successful)\n   * @param failureReason - Reason for failure (if unsuccessful)\n   * @param deviceInfo - Device and network information\n   */\n  static async recordAttempt(\n    email: string,\n    success: boolean,\n    customerId: string | null,\n    failureReason: string | null,\n    deviceInfo: DeviceInfo\n  ): Promise<void> {\n    const db = getDb();\n\n    // Get consecutive failures in the attempt window\n    const recentFailures = await this.getRecentFailures(email);\n    const consecutiveFailures = success ? 0 : recentFailures + 1;\n\n    // Check if this attempt triggers a lockout\n    const triggeredLockout = !success && consecutiveFailures >= this.MAX_ATTEMPTS;\n\n    // Record the attempt\n    const attemptData: NewLoginAttempt = {\n      customerId: customerId || undefined,\n      email,\n      success,\n      failureReason: failureReason || undefined,\n      ipAddress: deviceInfo.ipAddress,\n      userAgent: deviceInfo.userAgent,\n      deviceType: deviceInfo.deviceType,\n      deviceBrowser: deviceInfo.deviceBrowser,\n      ipCountry: deviceInfo.ipCountry,\n      ipCity: deviceInfo.ipCity,\n      triggeredLockout,\n      consecutiveFailures,\n    };\n\n    await db.insert(loginAttempts).values(attemptData);\n\n    // If lockout triggered and we have a customer ID, update customer record\n    if (triggeredLockout && customerId) {\n      await this.lockAccount(customerId);\n    }\n  }\n\n  /**\n   * Check if an account is currently locked\n   *\n   * @param email - Email address to check\n   * @returns Lockout status\n   */\n  static async checkLockoutStatus(email: string): Promise<LockoutStatus> {\n    const db = getDb();\n\n    // Get the most recent lockout trigger\n    const recentAttempts = await db\n      .select()\n      .from(loginAttempts)\n      .where(eq(loginAttempts.email, email))\n      .where(eq(loginAttempts.triggeredLockout, true))\n      .orderBy(desc(loginAttempts.attemptedAt))\n      .limit(1);\n\n    if (recentAttempts.length === 0) {\n      return {\n        isLocked: false,\n        consecutiveFailures: await this.getRecentFailures(email),\n      };\n    }\n\n    const lastLockout = recentAttempts[0];\n    const lockoutEndTime = new Date(\n      lastLockout.attemptedAt.getTime() + this.LOCKOUT_DURATION_MS\n    );\n    const now = new Date();\n\n    // Check if lockout has expired\n    if (now >= lockoutEndTime) {\n      return {\n        isLocked: false,\n        consecutiveFailures: 0, // Reset after lockout expires\n      };\n    }\n\n    return {\n      isLocked: true,\n      lockoutEndTime,\n      consecutiveFailures: lastLockout.consecutiveFailures,\n      remainingTime: lockoutEndTime.getTime() - now.getTime(),\n    };\n  }\n\n  /**\n   * Get count of recent failed attempts in the attempt window\n   *\n   * @param email - Email address\n   * @returns Number of consecutive failures\n   */\n  private static async getRecentFailures(email: string): Promise<number> {\n    const db = getDb();\n    const windowStart = new Date(Date.now() - this.ATTEMPT_WINDOW_MS);\n\n    const recentAttempts = await db\n      .select()\n      .from(loginAttempts)\n      .where(\n        and(\n          eq(loginAttempts.email, email),\n          gte(loginAttempts.attemptedAt, windowStart)\n        )\n      )\n      .orderBy(desc(loginAttempts.attemptedAt));\n\n    // Count consecutive failures from most recent\n    let failures = 0;\n    for (const attempt of recentAttempts) {\n      if (attempt.success) {\n        break; // Stop at first success\n      }\n      failures++;\n    }\n\n    return failures;\n  }\n\n  /**\n   * Clear failed attempts after successful login\n   *\n   * @param email - Email address\n   */\n  static async clearFailedAttempts(email: string): Promise<void> {\n    // Successful login is recorded, which breaks the consecutive failure chain\n    // No need to delete old attempts - they provide audit trail\n    // The getRecentFailures() method will return 0 after a successful login\n\n    // However, we should unlock the customer account if it was locked\n    const db = getDb();\n    const customer = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.email, email))\n      .limit(1);\n\n    if (customer.length > 0 && customer[0].accountLocked) {\n      await db\n        .update(customers)\n        .set({\n          accountLocked: false,\n          accountLockedAt: null,\n          accountLockedReason: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customer[0].id));\n    }\n  }\n\n  /**\n   * Lock a customer account\n   *\n   * @param customerId - Customer ID to lock\n   */\n  private static async lockAccount(customerId: string): Promise<void> {\n    const db = getDb();\n\n    // Get customer email for audit logging\n    const [customer] = await db\n      .select({ email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, customerId))\n      .limit(1);\n\n    await db\n      .update(customers)\n      .set({\n        accountLocked: true,\n        accountLockedAt: new Date(),\n        accountLockedReason: 'Too many failed login attempts',\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, customerId));\n\n    // Log account locked event\n    if (customer) {\n      await auditLogService.log({\n        eventType: SecurityEventType.ACCOUNT_LOCKED,\n        actorType: ActorType.SYSTEM,\n        actorId: customerId,\n        actorEmail: customer.email,\n        action: 'account_lockout',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          reason: 'too_many_failed_attempts',\n          lockoutDuration: '15_minutes',\n        },\n      });\n    }\n  }\n\n  /**\n   * Get login attempt history for a customer\n   *\n   * @param customerId - Customer ID\n   * @param limit - Maximum number of attempts to return\n   * @returns Array of login attempts\n   */\n  static async getAttemptHistory(\n    customerId: string,\n    limit: number = 50\n  ): Promise<typeof loginAttempts.$inferSelect[]> {\n    const db = getDb();\n\n    return await db\n      .select()\n      .from(loginAttempts)\n      .where(eq(loginAttempts.customerId, customerId))\n      .orderBy(desc(loginAttempts.attemptedAt))\n      .limit(limit);\n  }\n\n  /**\n   * Admin: Unlock a customer account\n   *\n   * @param customerId - Customer ID to unlock\n   */\n  static async unlockAccount(customerId: string): Promise<void> {\n    const db = getDb();\n\n    // Get customer email for audit logging\n    const [customer] = await db\n      .select({ email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, customerId))\n      .limit(1);\n\n    await db\n      .update(customers)\n      .set({\n        accountLocked: false,\n        accountLockedAt: null,\n        accountLockedReason: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, customerId));\n\n    // Log account unlocked event\n    if (customer) {\n      await auditLogService.log({\n        eventType: SecurityEventType.ACCOUNT_UNLOCKED,\n        actorType: ActorType.ADMIN,\n        targetType: 'customer',\n        targetId: customerId,\n        action: 'account_unlock',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          method: 'admin_action',\n        },\n      });\n    }\n  }\n\n  /**\n   * Format remaining lockout time for display\n   *\n   * @param milliseconds - Remaining time in milliseconds\n   * @returns Human-readable time string\n   */\n  static formatRemainingTime(milliseconds: number): string {\n    const minutes = Math.ceil(milliseconds / 60000);\n    if (minutes === 1) {\n      return '1 minute';\n    }\n    return `${minutes} minutes`;\n  }\n}\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { sessionService } from '../services/session.service';\nimport { requireAuth } from '../middleware/auth';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { logger } from '../utils/logger';\n\nconst sessionsRoutes = Router();\n\n/**\n * GET /api/auth/sessions\n * List all active sessions for current user\n */\nsessionsRoutes.get(\n  '/',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n      const currentSessionId = req.user?.sessionId;\n\n      if (!customerId) {\n        return sendError(res, 'Customer ID not found', 400);\n      }\n\n      // Get all active sessions\n      const sessions = await sessionService.getActiveSessions(customerId);\n\n      // Add isCurrent flag\n      const sessionsWithCurrent = sessions.map((session) => ({\n        ...session,\n        isCurrent: session.id === currentSessionId,\n      }));\n\n      sendSuccess(res, {\n        sessions: sessionsWithCurrent,\n        currentSessionId,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/auth/sessions/:sessionId\n * Revoke specific session\n */\nsessionsRoutes.delete(\n  '/:sessionId',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { sessionId } = req.params;\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        return sendError(res, 'Customer ID not found', 400);\n      }\n\n      // Verify session belongs to customer\n      const sessions = await sessionService.getActiveSessions(customerId);\n      const session = sessions.find((s) => s.id === sessionId);\n\n      if (!session) {\n        return sendError(res, 'Session not found or already revoked', 404);\n      }\n\n      // Revoke session\n      await sessionService.revokeSession(sessionId, 'user_action');\n\n      logger.info('Session revoked via API', {\n        sessionId,\n        customerId,\n        deviceName: session.deviceName,\n      });\n\n      sendSuccess(res, { message: 'Session revoked successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/sessions/logout-others\n * Logout all other sessions except current\n */\nsessionsRoutes.post(\n  '/logout-others',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n      const currentSessionId = req.user?.sessionId;\n\n      if (!customerId || !currentSessionId) {\n        return sendError(res, 'Session information not found', 400);\n      }\n\n      const count = await sessionService.revokeOtherSessions(customerId, currentSessionId);\n\n      logger.info('Other sessions revoked', { customerId, count });\n\n      sendSuccess(res, {\n        message: `${count} session(s) logged out successfully`,\n        count,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/auth/sessions/logout-all\n * Logout all sessions including current\n */\nsessionsRoutes.post(\n  '/logout-all',\n  requireAuth,\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        return sendError(res, 'Customer ID not found', 400);\n      }\n\n      const count = await sessionService.revokeAllSessions(customerId);\n\n      // Clear current cookie\n      res.clearCookie('auth_token');\n\n      logger.info('All sessions revoked', { customerId, count });\n\n      sendSuccess(res, {\n        message: `All ${count} session(s) logged out successfully`,\n        count,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\nexport { sessionsRoutes };\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, productVariants, eq, ilike, and, or, gte, lte, sql, desc, asc } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin, optionalAuth } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug, generateSku } from '../utils/helpers';\nimport { searchService } from '../services';\nimport { logger } from '../utils/logger';\n\nexport const productsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst productFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  categoryId: z.string().uuid().optional(),\n  categorySlug: z.string().optional(),\n  category: z.string().optional(), // Alias for categorySlug\n  brand: z.string().optional(),\n  status: z.enum(['draft', 'active', 'archived']).optional(),\n  isFeatured: z.enum(['true', 'false']).optional(),\n  minPrice: z.string().optional(),\n  maxPrice: z.string().optional(),\n  inStock: z.enum(['true', 'false']).optional(),\n  sortBy: z.enum(['name', 'basePrice', 'createdAt', 'stockQuantity']).optional(),\n  sortOrder: z.enum(['asc', 'desc']).optional(),\n});\n\nconst createProductSchema = z.object({\n  // Basic info\n  sku: z.string().min(1).max(100).optional(),\n  barcode: z.string().max(100).optional(),\n  name: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  description: z.string().optional(),\n  shortDescription: z.string().max(500).optional(),\n  categoryId: z.string().uuid().optional().nullable(),\n  brand: z.string().max(255).optional(),\n\n  // Pricing\n  basePrice: z.number().positive().max(999999.99),\n  costPrice: z.number().positive().max(999999.99).optional().nullable(),\n  compareAtPrice: z.number().positive().max(999999.99).optional().nullable(),\n\n  // Physical attributes\n  weight: z.number().positive().optional().nullable(),\n  dimensions: z.object({\n    width: z.number().positive().optional(),\n    height: z.number().positive().optional(),\n    depth: z.number().positive().optional(),\n  }).optional().nullable(),\n\n  // Inventory\n  stockQuantity: z.number().int().min(0).optional().default(0),\n  lowStockThreshold: z.number().int().min(0).optional().default(5),\n  trackInventory: z.boolean().optional().default(true),\n  allowBackorder: z.boolean().optional().default(false),\n\n  // Media\n  images: z.array(z.object({\n    url: z.string().url(),\n    alt: z.string().optional(),\n    width: z.number().optional(),\n    height: z.number().optional(),\n  })).optional().default([]),\n  videos: z.array(z.object({\n    url: z.string().url(),\n    title: z.string().optional(),\n  })).optional().default([]),\n  thumbnailUrl: z.string().url().optional().nullable(),\n\n  // Organization & categorization\n  tags: z.array(z.string()).max(20).optional().default([]),\n  specifications: z.record(z.string()).optional().default({}),\n  features: z.array(z.string()).max(20).optional().default([]),\n\n  // SEO\n  metaTitle: z.string().max(255).optional(),\n  metaDescription: z.string().max(500).optional(),\n\n  // Status & flags\n  status: z.enum(['draft', 'active', 'archived']).optional().default('draft'),\n  isFeatured: z.boolean().optional().default(false),\n  isDigital: z.boolean().optional().default(false),\n  requiresShipping: z.boolean().optional().default(true),\n\n  // Supplier\n  supplierId: z.string().max(255).optional(),\n  supplierSku: z.string().max(255).optional(),\n\n  // Import\n  importedFrom: z.string().max(255).optional(),\n  externalUrl: z.string().url().max(500).optional(),\n});\n\nconst updateProductSchema = createProductSchema.partial();\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/products\n * List products with pagination and filters\n */\nproductsRoutes.get('/', validateQuery(productFiltersSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const filters = req.query;\n\n    // Build where conditions\n    const conditions = [];\n\n    // Only show active products for public\n    conditions.push(eq(products.status, 'active'));\n\n    const search = filters['search'] as string | undefined;\n    const categoryId = filters['categoryId'] as string | undefined;\n    // Support both 'category' and 'categorySlug' for filtering by slug\n    const categorySlug = (filters['categorySlug'] || filters['category']) as string | undefined;\n    const brand = filters['brand'] as string | undefined;\n    const minPrice = filters['minPrice'] as string | undefined;\n    const maxPrice = filters['maxPrice'] as string | undefined;\n    const inStock = filters['inStock'] as string | undefined;\n    const isFeatured = filters['isFeatured'] as string | undefined;\n    const sortBy = (filters['sortBy'] as string) || 'createdAt';\n    const sortOrder = (filters['sortOrder'] as string) || 'desc';\n\n    if (search) {\n      conditions.push(\n        or(\n          ilike(products.name, `%${search}%`),\n          ilike(products.sku, `%${search}%`)\n        )\n      );\n    }\n\n    if (categoryId) {\n      conditions.push(eq(products.categoryId, categoryId));\n    }\n\n    // Handle categorySlug filter by looking up the category ID\n    if (categorySlug) {\n      const [cat] = await db.select({ id: categories.id })\n        .from(categories)\n        .where(eq(categories.slug, categorySlug));\n      if (cat) {\n        conditions.push(eq(products.categoryId, cat.id));\n      }\n    }\n\n    // Handle brand filter\n    if (brand) {\n      conditions.push(eq(products.brand, brand));\n    }\n\n    if (minPrice) {\n      conditions.push(gte(products.basePrice, minPrice));\n    }\n\n    if (maxPrice) {\n      conditions.push(lte(products.basePrice, maxPrice));\n    }\n\n    if (inStock === 'true') {\n      conditions.push(\n        or(\n          sql`${products.stockQuantity} > 0`,\n          eq(products.allowBackorder, true)\n        )\n      );\n    }\n\n    if (isFeatured === 'true') {\n      conditions.push(eq(products.isFeatured, true));\n    }\n\n    // Get total count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(products)\n      .where(and(...conditions));\n    const count = countResult[0]?.count ?? 0;\n\n    // Create a mapping of sort columns\n    const sortColumnMap: Record<string, typeof products.name | typeof products.basePrice | typeof products.createdAt | typeof products.stockQuantity> = {\n      name: products.name,\n      basePrice: products.basePrice,\n      createdAt: products.createdAt,\n      stockQuantity: products.stockQuantity,\n    };\n    const sortColumn = sortColumnMap[sortBy] || products.createdAt;\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        name: products.name,\n        slug: products.slug,\n        thumbnailUrl: products.thumbnailUrl,\n        images: products.images,\n        basePrice: products.basePrice,\n        compareAtPrice: products.compareAtPrice,\n        stockQuantity: products.stockQuantity,\n        lowStockThreshold: products.lowStockThreshold,\n        status: products.status,\n        isFeatured: products.isFeatured,\n        categoryId: products.categoryId,\n        categoryName: categories.name,\n        categorySlug: categories.slug,\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.categoryId, categories.id))\n      .where(and(...conditions))\n      .orderBy(sortOrder === 'desc' ? desc(sortColumn) : asc(sortColumn))\n      .limit(limit)\n      .offset(offset);\n\n    // Add computed inStock field, category object, and ensure images is an array\n    const productsWithStock = productList.map(p => ({\n      ...p,\n      basePrice: Number(p.basePrice),\n      compareAtPrice: p.compareAtPrice ? Number(p.compareAtPrice) : undefined,\n      images: p.images || [],\n      inStock: p.stockQuantity > 0,\n      category: p.categoryId && p.categoryName ? {\n        id: p.categoryId,\n        name: p.categoryName,\n        slug: p.categorySlug,\n      } : null,\n    }));\n\n    sendSuccess(res, productsWithStock, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/featured\n * Get featured products\n */\nproductsRoutes.get('/featured', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const limit = Math.min(20, parseInt(req.query['limit'] as string || '8', 10));\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        name: products.name,\n        slug: products.slug,\n        thumbnailUrl: products.thumbnailUrl,\n        basePrice: products.basePrice,\n        compareAtPrice: products.compareAtPrice,\n        stockQuantity: products.stockQuantity,\n      })\n      .from(products)\n      .where(and(eq(products.status, 'active'), eq(products.isFeatured, true)))\n      .orderBy(desc(products.createdAt))\n      .limit(limit);\n\n    const productsWithStock = productList.map(p => ({\n      ...p,\n      basePrice: Number(p.basePrice),\n      compareAtPrice: p.compareAtPrice ? Number(p.compareAtPrice) : undefined,\n      inStock: p.stockQuantity > 0,\n    }));\n\n    sendSuccess(res, productsWithStock);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/:productId/variants\n * Get all variants for a product\n */\nproductsRoutes.get('/:productId/variants', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const productId = req.params['productId'] as string;\n\n    // Validate UUID format\n    if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(productId)) {\n      // Not a UUID, pass to next route (slug handler)\n      return next();\n    }\n\n    // Check if product exists\n    const [product] = await db\n      .select({ id: products.id, name: products.name })\n      .from(products)\n      .where(eq(products.id, productId));\n\n    if (!product) {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get variants\n    const variants = await db\n      .select()\n      .from(productVariants)\n      .where(and(\n        eq(productVariants.productId, productId),\n        eq(productVariants.isActive, true)\n      ))\n      .orderBy(asc(productVariants.name));\n\n    sendSuccess(res, variants.map(v => ({\n      ...v,\n      basePrice: Number(v.basePrice),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/products/:slug\n * Get product by slug\n */\nproductsRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const slug = req.params['slug'] as string;\n\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.slug, slug));\n\n    if (!product || product.status !== 'active') {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get category\n    let category;\n    if (product.categoryId) {\n      [category] = await db\n        .select({ id: categories.id, name: categories.name, slug: categories.slug })\n        .from(categories)\n        .where(eq(categories.id, product.categoryId));\n    }\n\n    sendSuccess(res, {\n      ...product,\n      basePrice: Number(product.basePrice),\n      costPrice: product.costPrice ? Number(product.costPrice) : undefined,\n      compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : undefined,\n      inStock: product.stockQuantity > 0 || product.allowBackorder,\n      category,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/products/admin/:id\n * Get product by ID (Admin only - returns any status)\n */\nproductsRoutes.get('/admin/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.id, id));\n\n    if (!product) {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Get category\n    let category;\n    if (product.categoryId) {\n      [category] = await db\n        .select({ id: categories.id, name: categories.name, slug: categories.slug })\n        .from(categories)\n        .where(eq(categories.id, product.categoryId));\n    }\n\n    sendSuccess(res, {\n      ...product,\n      basePrice: Number(product.basePrice),\n      costPrice: product.costPrice ? Number(product.costPrice) : undefined,\n      compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : undefined,\n      weight: product.weight ? Number(product.weight) : undefined,\n      inStock: product.stockQuantity > 0 || product.allowBackorder,\n      category,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/products\n * Create a new product (Admin only)\n */\nproductsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createProductSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate SKU if not provided\n      const sku = data.sku || generateSku();\n\n      // Check if SKU already exists\n      const [existingSku] = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.sku, sku));\n\n      if (existingSku) {\n        throw new ConflictError('SKU already exists');\n      }\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.name);\n\n      // Check if slug already exists\n      const [existingSlug] = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.slug, slug));\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Create product\n      const insertResult = await db\n        .insert(products)\n        .values({\n          ...data,\n          sku,\n          slug,\n          basePrice: String(data.basePrice),\n          costPrice: data.costPrice ? String(data.costPrice) : null,\n          compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : null,\n          weight: data.weight ? String(data.weight) : null,\n          categoryId: data.categoryId || null,\n          thumbnailUrl: data.thumbnailUrl || null,\n        })\n        .returning();\n\n      const product = insertResult[0];\n      if (!product) {\n        throw new Error('Failed to create product');\n      }\n\n      // Sync to search index\n      try {\n        if (await searchService.isAvailable()) {\n          // Fetch category info for the search document\n          let categoryName = '';\n          let categorySlugValue = '';\n          if (product.categoryId) {\n            const [cat] = await db.select({ name: categories.name, slug: categories.slug })\n              .from(categories)\n              .where(eq(categories.id, product.categoryId));\n            if (cat) {\n              categoryName = cat.name;\n              categorySlugValue = cat.slug;\n            }\n          }\n\n          await searchService.indexProduct({\n            id: product.id,\n            sku: product.sku,\n            name: product.name,\n            slug: product.slug,\n            description: product.description,\n            shortDescription: product.shortDescription,\n            brand: product.brand,\n            categoryId: product.categoryId,\n            categoryName,\n            categorySlug: categorySlugValue,\n            basePrice: Number(product.basePrice),\n            compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n            stockQuantity: product.stockQuantity,\n            inStock: product.stockQuantity > 0 || product.allowBackorder,\n            isFeatured: product.isFeatured,\n            tags: product.tags as string[] || [],\n            thumbnailUrl: product.thumbnailUrl,\n            images: product.images as Array<{ url: string; alt?: string }> || [],\n            createdAt: new Date(product.createdAt).getTime(),\n            updatedAt: new Date(product.updatedAt).getTime(),\n          });\n        }\n      } catch (e) {\n        logger.error('Failed to index product in search', { error: e, productId: product.id });\n      }\n\n      sendCreated(res, {\n        ...product,\n        basePrice: Number(product.basePrice),\n        costPrice: product.costPrice ? Number(product.costPrice) : null,\n        compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n        weight: product.weight ? Number(product.weight) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/products/:id\n * Update a product (Admin only)\n */\nproductsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateProductSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      // Check if product exists\n      const [existing] = await db\n        .select()\n        .from(products)\n        .where(eq(products.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Product not found');\n      }\n\n      // Update product\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      // Convert decimal fields to strings for database\n      if (data.basePrice !== undefined) {\n        updateData['basePrice'] = String(data.basePrice);\n      }\n      if (data.costPrice !== undefined) {\n        updateData['costPrice'] = data.costPrice ? String(data.costPrice) : null;\n      }\n      if (data.compareAtPrice !== undefined) {\n        updateData['compareAtPrice'] = data.compareAtPrice ? String(data.compareAtPrice) : null;\n      }\n      if (data.weight !== undefined) {\n        updateData['weight'] = data.weight ? String(data.weight) : null;\n      }\n      // Handle nullable fields\n      if (data.categoryId !== undefined) {\n        updateData['categoryId'] = data.categoryId || null;\n      }\n      if (data.thumbnailUrl !== undefined) {\n        updateData['thumbnailUrl'] = data.thumbnailUrl || null;\n      }\n\n      const updateResult = await db\n        .update(products)\n        .set(updateData)\n        .where(eq(products.id, id))\n        .returning();\n\n      const product = updateResult[0];\n      if (!product) {\n        throw new NotFoundError('Product not found');\n      }\n\n      // Sync to search index\n      try {\n        if (await searchService.isAvailable()) {\n          // Fetch category info for the search document\n          let categoryName = '';\n          let categorySlugValue = '';\n          if (product.categoryId) {\n            const [cat] = await db.select({ name: categories.name, slug: categories.slug })\n              .from(categories)\n              .where(eq(categories.id, product.categoryId));\n            if (cat) {\n              categoryName = cat.name;\n              categorySlugValue = cat.slug;\n            }\n          }\n\n          await searchService.updateProduct({\n            id: product.id,\n            sku: product.sku,\n            name: product.name,\n            slug: product.slug,\n            description: product.description,\n            shortDescription: product.shortDescription,\n            brand: product.brand,\n            categoryId: product.categoryId,\n            categoryName,\n            categorySlug: categorySlugValue,\n            basePrice: Number(product.basePrice),\n            compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n            stockQuantity: product.stockQuantity,\n            inStock: product.stockQuantity > 0 || product.allowBackorder,\n            isFeatured: product.isFeatured,\n            tags: product.tags as string[] || [],\n            thumbnailUrl: product.thumbnailUrl,\n            images: product.images as Array<{ url: string; alt?: string }> || [],\n            createdAt: new Date(product.createdAt).getTime(),\n            updatedAt: new Date(product.updatedAt).getTime(),\n          });\n        }\n      } catch (e) {\n        logger.error('Failed to update product in search', { error: e, productId: product.id });\n      }\n\n      sendSuccess(res, {\n        ...product,\n        basePrice: Number(product.basePrice),\n        costPrice: product.costPrice ? Number(product.costPrice) : null,\n        compareAtPrice: product.compareAtPrice ? Number(product.compareAtPrice) : null,\n        weight: product.weight ? Number(product.weight) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/products/:id\n * Delete a product (Admin only)\n */\nproductsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: products.id })\n      .from(products)\n      .where(eq(products.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Product not found');\n    }\n\n    await db.delete(products).where(eq(products.id, id));\n\n    // Remove from search index\n    try {\n      if (await searchService.isAvailable()) {\n        await searchService.removeProduct(id);\n      }\n    } catch (e) {\n      logger.error('Failed to remove product from search', { error: e, productId: id });\n    }\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, categories, products, eq, isNull, sql } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug } from '../utils/helpers';\n\nexport const categoriesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createCategorySchema = z.object({\n  name: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  description: z.string().optional(),\n  imageUrl: z.string().url().optional(),\n  parentId: z.string().uuid().optional(),\n  isActive: z.boolean().optional().default(true),\n  sortOrder: z.number().int().min(0).optional().default(0),\n});\n\nconst updateCategorySchema = createCategorySchema.partial();\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/categories\n * List all categories (hierarchical)\n */\ncategoriesRoutes.get('/', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Get all active categories\n    const categoryList = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.isActive, true))\n      .orderBy(categories.sortOrder);\n\n    // Build hierarchy\n    const rootCategories = categoryList.filter(c => !c.parentId);\n    const categoryMap = new Map(categoryList.map(c => [c.id, { ...c, children: [] as typeof categoryList }]));\n\n    for (const category of categoryList) {\n      if (category.parentId) {\n        const parent = categoryMap.get(category.parentId);\n        if (parent) {\n          parent.children.push(categoryMap.get(category.id)!);\n        }\n      }\n    }\n\n    const hierarchicalCategories = rootCategories.map(c => categoryMap.get(c.id)!);\n\n    sendSuccess(res, hierarchicalCategories);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/categories/:slug\n * Get category by slug with products\n */\ncategoriesRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const slug = req.params['slug'] as string;\n\n    const categoryResult = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.slug, slug));\n\n    const category = categoryResult[0];\n\n    if (!category || !category.isActive) {\n      throw new NotFoundError('Category not found');\n    }\n\n    // Get product count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(products)\n      .where(eq(products.categoryId, category.id));\n\n    const count = countResult[0]?.count ?? 0;\n\n    // Get subcategories\n    const subcategories = await db\n      .select()\n      .from(categories)\n      .where(eq(categories.parentId, category.id));\n\n    sendSuccess(res, {\n      ...category,\n      productCount: Number(count),\n      children: subcategories,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * POST /api/categories\n * Create a new category (Admin only)\n */\ncategoriesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createCategorySchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.name);\n\n      // Check if slug already exists\n      const existingSlugResult = await db\n        .select({ id: categories.id })\n        .from(categories)\n        .where(eq(categories.slug, slug));\n\n      const existingSlug = existingSlugResult[0];\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Create category\n      const categoryResult = await db\n        .insert(categories)\n        .values({\n          ...data,\n          slug,\n        })\n        .returning();\n\n      const category = categoryResult[0];\n\n      sendCreated(res, category);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/categories/:id\n * Update a category (Admin only)\n */\ncategoriesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateCategorySchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const existingResult = await db\n        .select()\n        .from(categories)\n        .where(eq(categories.id, id));\n\n      const existing = existingResult[0];\n\n      if (!existing) {\n        throw new NotFoundError('Category not found');\n      }\n\n      const categoryResult = await db\n        .update(categories)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(categories.id, id))\n        .returning();\n\n      const category = categoryResult[0];\n\n      sendSuccess(res, category);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/categories/:id\n * Delete a category (Admin only)\n */\ncategoriesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const existingResult = await db\n      .select({ id: categories.id })\n      .from(categories)\n      .where(eq(categories.id, id));\n\n    const existing = existingResult[0];\n\n    if (!existing) {\n      throw new NotFoundError('Category not found');\n    }\n\n    // Update products to remove category reference\n    await db\n      .update(products)\n      .set({ categoryId: null })\n      .where(eq(products.categoryId, id));\n\n    // Update child categories to remove parent\n    await db\n      .update(categories)\n      .set({ parentId: null })\n      .where(eq(categories.parentId, id));\n\n    await db.delete(categories).where(eq(categories.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, carts, cartItems, cartPromoCodes, products, productVariants, eq, and, isNull } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { optionalAuth } from '../middleware/auth';\nimport { sendSuccess, sendNoContent } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { logger } from '../utils/logger';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport const cartRoutes = Router();\n\n// Apply optional auth to all cart routes\ncartRoutes.use(optionalAuth);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst addToCartSchema = z.object({\n  productId: z.string().uuid(),\n  variantId: z.string().uuid().optional(),\n  quantity: z.preprocess(\n    (val) => (typeof val === 'string' ? parseInt(val, 10) : val),\n    z.number()\n      .int('Quantity must be a whole number')\n      .positive('Quantity must be positive')\n      .min(1, 'Quantity must be at least 1')\n      .max(9999, 'Quantity cannot exceed 9999')\n  ),\n});\n\nconst updateCartItemSchema = z.object({\n  quantity: z.preprocess(\n    (val) => (typeof val === 'string' ? parseInt(val, 10) : val),\n    z.number()\n      .int('Quantity must be a whole number')\n      .positive('Quantity must be positive')\n      .min(1, 'Quantity must be at least 1')\n      .max(9999, 'Quantity cannot exceed 9999')\n  ),\n});\n\nconst applyPromoSchema = z.object({\n  code: z.string().min(1).max(50),\n});\n\n// ===========================================\n// Helper Functions\n// ===========================================\n\nasync function getOrCreateCart(userId?: string, sessionId?: string): Promise<typeof carts.$inferSelect> {\n  const db = getDb();\n\n  // Try to find existing cart\n  let cart: typeof carts.$inferSelect | undefined;\n\n  if (userId) {\n    const [existing] = await db\n      .select()\n      .from(carts)\n      .where(eq(carts.customerId, userId));\n    cart = existing;\n  } else if (sessionId) {\n    const [existing] = await db\n      .select()\n      .from(carts)\n      .where(eq(carts.sessionId, sessionId));\n    cart = existing;\n  }\n\n  // Create new cart if not found\n  if (!cart) {\n    const newSessionId = sessionId || uuidv4();\n    const [created] = await db\n      .insert(carts)\n      .values({\n        customerId: userId,\n        sessionId: userId ? undefined : newSessionId,\n      })\n      .returning();\n    if (!created) {\n      throw new Error('Failed to create cart');\n    }\n    cart = created;\n  }\n\n  return cart;\n}\n\nasync function getCartItems(cartId: string) {\n  const db = getDb();\n\n  return db\n    .select()\n    .from(cartItems)\n    .where(eq(cartItems.cartId, cartId));\n}\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/cart\n * Get current cart\n */\ncartRoutes.get('/', async (req, res, next) => {\n  try {\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      // Return empty cart for anonymous users without session\n      return sendSuccess(res, {\n        id: null,\n        items: [],\n        itemCount: 0,\n      });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    sendSuccess(res, {\n      id: cart.id,\n      sessionId: cart.sessionId,\n      items,\n      itemCount: items.reduce((sum, item) => sum + item.quantity, 0),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/cart/calculate\n * Calculate cart totals (CRITICAL - server-side calculation)\n */\ncartRoutes.get('/calculate', async (req, res, next) => {\n  try {\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      return sendSuccess(res, {\n        items: [],\n        itemCount: 0,\n        subtotal: 0,\n        taxRate: 0, // Tax rate will be applied when items are added\n        taxAmount: 0,\n        shippingAmount: 0,\n        discountAmount: 0,\n        total: 0,\n        currency: 'USD',\n      });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    if (items.length === 0) {\n      return sendSuccess(res, {\n        items: [],\n        itemCount: 0,\n        subtotal: 0,\n        taxRate: 0, // Tax rate will be applied when items are added\n        taxAmount: 0,\n        shippingAmount: 0,\n        discountAmount: 0,\n        total: 0,\n        currency: 'USD',\n      });\n    }\n\n    // Get promo code if applied\n    const db = getDb();\n    const [promoCode] = await db\n      .select()\n      .from(cartPromoCodes)\n      .where(eq(cartPromoCodes.cartId, cart.id));\n\n    // Calculate totals using pricing service\n    const cartInput = items.map(item => ({\n      id: item.id,  // Pass actual cart item ID to pricing service\n      productId: item.productId,\n      variantId: item.variantId || undefined,\n      quantity: item.quantity,\n    }));\n\n    const calculation = await pricingService.calculateCart(\n      cartInput,\n      promoCode?.code\n    );\n\n    sendSuccess(res, calculation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/items\n * Add item to cart\n */\ncartRoutes.post('/items', validateBody(addToCartSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string || uuidv4();\n    const { productId, variantId, quantity } = req.body;\n\n    // Validate product exists\n    const [product] = await db\n      .select()\n      .from(products)\n      .where(eq(products.id, productId));\n\n    if (!product || product.status !== 'active') {\n      throw new NotFoundError('Product not found');\n    }\n\n    // Validate variant if provided\n    if (variantId) {\n      const [variant] = await db\n        .select()\n        .from(productVariants)\n        .where(eq(productVariants.id, variantId));\n\n      if (!variant || !variant.isActive) {\n        throw new NotFoundError('Variant not found');\n      }\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Check if item already in cart\n    const [existingItem] = await db\n      .select()\n      .from(cartItems)\n      .where(\n        and(\n          eq(cartItems.cartId, cart.id),\n          eq(cartItems.productId, productId),\n          variantId ? eq(cartItems.variantId, variantId) : isNull(cartItems.variantId)\n        )\n      );\n\n    let cartItem;\n\n    if (existingItem) {\n      // Update quantity\n      [cartItem] = await db\n        .update(cartItems)\n        .set({\n          quantity: existingItem.quantity + quantity,\n          updatedAt: new Date(),\n        })\n        .where(eq(cartItems.id, existingItem.id))\n        .returning();\n    } else {\n      // Add new item\n      const [created] = await db\n        .insert(cartItems)\n        .values({\n          cartId: cart.id,\n          productId,\n          variantId,\n          quantity,\n        })\n        .returning();\n      cartItem = created;\n    }\n\n    if (!cartItem) {\n      throw new Error('Failed to add item to cart');\n    }\n\n    sendSuccess(res, {\n      id: cartItem.id,\n      cartId: cart.id,\n      sessionId: cart.sessionId,\n      productId: cartItem.productId,\n      variantId: cartItem.variantId,\n      quantity: cartItem.quantity,\n    }, 201);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/cart/items/:id\n * Update cart item quantity\n */\ncartRoutes.put('/items/:id', validateBody(updateCartItemSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const { quantity } = req.body;\n\n    // Get user's cart for ownership verification\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Verify cart item belongs to user's cart\n    const [cartItem] = await db\n      .select()\n      .from(cartItems)\n      .where(and(\n        eq(cartItems.id, id),\n        eq(cartItems.cartId, cart.id)\n      ));\n\n    if (!cartItem) {\n      logger.warn('Cart item not found for update', {\n        requestedId: id,\n        cartId: cart.id,\n        userId: req.user?.customerId,\n        sessionId: req.sessionId || req.headers['x-session-id'],\n        requestBody: req.body,\n      });\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const [updated] = await db\n      .update(cartItems)\n      .set({\n        quantity,\n        updatedAt: new Date(),\n      })\n      .where(eq(cartItems.id, id))\n      .returning();\n\n    sendSuccess(res, updated);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/cart/items/:id\n * Remove item from cart\n */\ncartRoutes.delete('/items/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Get user's cart for ownership verification\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new NotFoundError('Cart item not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Verify cart item belongs to user's cart\n    const [cartItem] = await db\n      .select()\n      .from(cartItems)\n      .where(and(\n        eq(cartItems.id, id),\n        eq(cartItems.cartId, cart.id)\n      ));\n\n    if (!cartItem) {\n      logger.warn('Cart item not found for deletion', {\n        requestedId: id,\n        cartId: cart.id,\n        userId: req.user?.customerId,\n        sessionId: req.sessionId || req.headers['x-session-id'],\n      });\n      throw new NotFoundError('Cart item not found');\n    }\n\n    await db.delete(cartItems).where(eq(cartItems.id, id));\n\n    logger.info('Cart item deleted', {\n      cartItemId: id,\n      productId: cartItem.productId,\n      quantity: cartItem.quantity,\n      userId: req.user?.customerId,\n    });\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/apply-promo\n * Apply promo code to cart\n */\ncartRoutes.post('/apply-promo', validateBody(applyPromoSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n    const { code } = req.body;\n\n    if (!userId && !sessionId) {\n      throw new BadRequestError('Cart not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n    const items = await getCartItems(cart.id);\n\n    if (items.length === 0) {\n      throw new BadRequestError('Cart is empty');\n    }\n\n    // Calculate current subtotal\n    const cartInput = items.map(item => ({\n      productId: item.productId,\n      variantId: item.variantId || undefined,\n      quantity: item.quantity,\n    }));\n\n    // Validate promo code and check eligibility\n    const calculation = await pricingService.calculateCart(cartInput, code);\n\n    // Check if promo code was validated\n    if (!calculation.promoCodeId) {\n      throw new BadRequestError('Invalid or expired promo code');\n    }\n\n    // Check if any items are eligible for this promo code\n    // If promo has restrictions but no items match, reject it\n    if (calculation.discountAmount === 0 && calculation.promoCode) {\n      throw new BadRequestError(\n        'This promo code does not apply to any items in your cart. ' +\n        'It may only be valid for specific products or categories.'\n      );\n    }\n\n    // Remove existing promo code\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    // Apply new promo code\n    await db.insert(cartPromoCodes).values({\n      cartId: cart.id,\n      promoCodeId: calculation.promoCodeId,\n      code: calculation.promoCode!,\n    });\n\n    sendSuccess(res, calculation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/cart/promo\n * Remove promo code from cart\n */\ncartRoutes.delete('/promo', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      throw new BadRequestError('Cart not found');\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cart/clear\n * Clear all items from cart\n */\ncartRoutes.post('/clear', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const userId = req.user?.customerId;\n    const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n\n    if (!userId && !sessionId) {\n      return sendSuccess(res, { success: true, itemsRemoved: 0 });\n    }\n\n    const cart = await getOrCreateCart(userId, sessionId);\n\n    // Delete all cart items\n    const deleted = await db.delete(cartItems).where(eq(cartItems.cartId, cart.id)).returning();\n\n    // Also remove any applied promo codes\n    await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n    logger.info('Cart cleared', {\n      cartId: cart.id,\n      itemsRemoved: deleted.length,\n      userId: req.user?.customerId,\n    });\n\n    sendSuccess(res, { success: true, itemsRemoved: deleted.length });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, orders, orderItems, customers, carts, cartItems, cartPromoCodes, products, productVariants, promoCodes, settings, eq, sql, desc, and, or, ilike } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { optionalAuth, requireAuth, requireAdmin } from '../middleware/auth';\nimport { strictLimiter } from '../middleware/rateLimiter';\nimport { sendSuccess, sendCreated, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError, ForbiddenError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { pdfService } from '../services/pdf.service';\nimport { generateOrderNumber } from '../utils/helpers';\nimport { emailTemplatesService } from '../services/email-templates.service';\nimport { mailerService } from '../services/mailer.service';\nimport { logger } from '../utils/logger';\n\nexport const ordersRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst addressSchema = z.object({\n  firstName: z.string().min(1).max(100),\n  lastName: z.string().min(1).max(100),\n  company: z.string().max(255).optional(),\n  addressLine1: z.string().min(1).max(255),\n  addressLine2: z.string().max(255).optional(),\n  city: z.string().min(1).max(100),\n  state: z.string().max(100).optional(),\n  postalCode: z.string().max(20).optional(),\n  country: z.string().min(1).max(100),\n  phone: z.string().max(50).optional(),\n});\n\nconst createOrderSchema = z.object({\n  shippingAddress: addressSchema,\n  billingAddress: addressSchema.optional(),\n  sameAsShipping: z.boolean().optional().default(true),\n  customerEmail: z.string().email(),\n  customerNotes: z.string().max(1000).optional(),\n  paymentMethod: z.enum(['cod']).default('cod'),\n});\n\nconst updateOrderSchema = z.object({\n  status: z.enum(['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']).optional(),\n  paymentStatus: z.enum(['pending', 'paid', 'refunded', 'failed']).optional(),\n  trackingNumber: z.string().max(255).optional(),\n  shippingMethod: z.string().max(100).optional(),\n  adminNotes: z.string().max(1000).optional(),\n  shippingAddress: addressSchema.optional(),\n  billingAddress: addressSchema.optional(),\n});\n\nconst orderFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']).optional(),\n  paymentStatus: z.enum(['pending', 'paid', 'refunded', 'failed']).optional(),\n  search: z.string().optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * POST /api/orders\n * Create a new order (checkout)\n */\nordersRoutes.post(\n  '/',\n  strictLimiter,\n  optionalAuth,\n  validateBody(createOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const userId = req.user?.customerId;\n      const sessionId = req.sessionId || req.headers['x-session-id'] as string;\n      const data = req.body;\n\n      if (!userId && !sessionId) {\n        throw new BadRequestError('No cart found');\n      }\n\n      // Get cart\n      let cart;\n      if (userId) {\n        [cart] = await db.select().from(carts).where(eq(carts.customerId, userId));\n      } else if (sessionId) {\n        [cart] = await db.select().from(carts).where(eq(carts.sessionId, sessionId));\n      }\n\n      if (!cart) {\n        throw new BadRequestError('Cart not found');\n      }\n\n      // Get cart items\n      const items = await db\n        .select()\n        .from(cartItems)\n        .where(eq(cartItems.cartId, cart.id));\n\n      if (items.length === 0) {\n        throw new BadRequestError('Cart is empty');\n      }\n\n      // Get promo code if applied\n      const [promoCode] = await db\n        .select()\n        .from(cartPromoCodes)\n        .where(eq(cartPromoCodes.cartId, cart.id));\n\n      // Calculate totals using pricing service\n      const cartInput = items.map(item => ({\n        productId: item.productId,\n        variantId: item.variantId || undefined,\n        quantity: item.quantity,\n      }));\n\n      const totals = await pricingService.calculateOrderTotals(\n        cartInput,\n        promoCode?.code\n      );\n\n      // Get or create customer\n      let customer;\n      if (userId) {\n        [customer] = await db.select().from(customers).where(eq(customers.id, userId));\n      } else {\n        // Create guest customer\n        [customer] = await db\n          .insert(customers)\n          .values({\n            email: data.customerEmail.toLowerCase(),\n            firstName: data.shippingAddress.firstName,\n            lastName: data.shippingAddress.lastName,\n            phone: data.shippingAddress.phone,\n            isGuest: true,\n          })\n          .returning();\n      }\n\n      // Generate order number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(orders);\n      const count = countResult[0]?.count ?? 0;\n      const orderNumber = generateOrderNumber(Number(count) + 1);\n\n      // Determine billing address\n      const billingAddress = data.sameAsShipping\n        ? data.shippingAddress\n        : data.billingAddress || data.shippingAddress;\n\n      if (!customer) {\n        throw new BadRequestError('Failed to create or find customer');\n      }\n\n      // Create order\n      const orderResult = await db\n        .insert(orders)\n        .values({\n          orderNumber,\n          customerId: customer.id,\n          status: 'pending',\n          paymentStatus: 'pending',\n          shippingAddress: data.shippingAddress,\n          billingAddress,\n          currency: 'USD',\n          subtotalSnapshot: String(totals.subtotal),\n          taxRateSnapshot: String(totals.taxRate),\n          taxAmountSnapshot: String(totals.taxAmount),\n          shippingAmountSnapshot: String(totals.shippingAmount),\n          discountAmountSnapshot: String(totals.discountAmount),\n          totalSnapshot: String(totals.total),\n          promoCodeId: totals.promoCodeId,\n          promoCodeSnapshot: totals.promoCodeSnapshot,\n          paymentMethod: data.paymentMethod,\n          customerNotes: data.customerNotes,\n        })\n        .returning();\n      const order = orderResult[0];\n\n      if (!order) {\n        throw new BadRequestError('Failed to create order');\n      }\n\n      // Create order items with product snapshots\n      for (const item of items) {\n        const productResult = await db\n          .select()\n          .from(products)\n          .where(eq(products.id, item.productId));\n        const product = productResult[0];\n\n        if (!product) {\n          throw new BadRequestError(`Product not found: ${item.productId}`);\n        }\n\n        let variant;\n        if (item.variantId) {\n          const variantResult = await db\n            .select()\n            .from(productVariants)\n            .where(eq(productVariants.id, item.variantId));\n          variant = variantResult[0];\n        }\n\n        const unitPrice = variant ? Number(variant.basePrice) : Number(product.basePrice);\n\n        await db.insert(orderItems).values({\n          orderId: order.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          productNameSnapshot: product.name,\n          skuSnapshot: variant?.sku || product.sku,\n          variantOptionsSnapshot: variant?.options,\n          quantity: item.quantity,\n          unitPriceSnapshot: String(unitPrice),\n        });\n      }\n\n      // Deduct stock for each item\n      for (const item of items) {\n        if (item.variantId) {\n          // Deduct from variant\n          await db\n            .update(productVariants)\n            .set({\n              stockQuantity: sql`${productVariants.stockQuantity} - ${item.quantity}`,\n              updatedAt: new Date(),\n            })\n            .where(eq(productVariants.id, item.variantId));\n        } else {\n          // Check if product tracks inventory\n          const [product] = await db.select({ trackInventory: products.trackInventory })\n            .from(products)\n            .where(eq(products.id, item.productId));\n\n          if (product?.trackInventory) {\n            await db\n              .update(products)\n              .set({\n                stockQuantity: sql`${products.stockQuantity} - ${item.quantity}`,\n                updatedAt: new Date(),\n              })\n              .where(eq(products.id, item.productId));\n          }\n        }\n      }\n\n      // Update promo code usage\n      if (totals.promoCodeId) {\n        await db\n          .update(promoCodes)\n          .set({ usageCount: sql`${promoCodes.usageCount} + 1` })\n          .where(eq(promoCodes.id, totals.promoCodeId));\n      }\n\n      // Update customer order count\n      await db\n        .update(customers)\n        .set({ orderCount: sql`${customers.orderCount} + 1` })\n        .where(eq(customers.id, customer.id));\n\n      // Clear cart\n      await db.delete(cartItems).where(eq(cartItems.cartId, cart.id));\n      await db.delete(cartPromoCodes).where(eq(cartPromoCodes.cartId, cart.id));\n\n      sendCreated(res, {\n        orderId: order.id,\n        orderNumber: order.orderNumber,\n        total: totals.total,\n        status: order.status,\n        paymentMethod: order.paymentMethod,\n      });\n\n      // Send emails asynchronously (don't block response)\n      // Email failures will not affect order creation\n      try {\n        // Fetch full order with items for email\n        const orderWithItems = await db.query.orders.findFirst({\n          where: eq(orders.id, order.id),\n          with: {\n            items: true,\n          },\n        });\n\n        if (!orderWithItems) {\n          logger.warn('Order not found for email notification', { orderId: order.id });\n          return;\n        }\n\n        // Get settings for admin email\n        const [storeSettings] = await db\n          .select()\n          .from(settings)\n          .where(eq(settings.key, 'store'));\n\n        const storeConfig = (storeSettings?.value as {\n          orderNotificationEmail?: string;\n          storeEmail?: string;\n          storeName?: string;\n        }) || {};\n\n        // Prepare email data\n        const emailData = {\n          orderNumber: order.orderNumber,\n          customerName: `${order.shippingAddress.firstName} ${order.shippingAddress.lastName}`,\n          customerEmail: order.shippingAddress.email || data.customerEmail,\n          shippingAddress: order.shippingAddress,\n          items: orderWithItems.items.map((item) => ({\n            productName: item.productNameSnapshot,\n            sku: item.skuSnapshot,\n            quantity: item.quantity,\n            unitPrice: Number(item.unitPriceSnapshot),\n            lineTotal: Number(item.unitPriceSnapshot) * item.quantity,\n          })),\n          subtotal: Number(order.subtotalSnapshot),\n          taxRate: Number(order.taxRateSnapshot),\n          taxAmount: Number(order.taxAmountSnapshot),\n          shippingAmount: Number(order.shippingAmountSnapshot),\n          discountAmount: Number(order.discountAmountSnapshot),\n          total: Number(order.totalSnapshot),\n          currency: order.currency,\n          promoCode: order.promoCodeSnapshot || undefined,\n          customerNotes: order.customerNotes || undefined,\n          orderDate: order.createdAt.toISOString(),\n          paymentMethod: order.paymentMethod,\n        };\n\n        // Send customer confirmation email\n        const customerEmailHtml = emailTemplatesService.generateOrderConfirmationEmail(emailData);\n        mailerService\n          .sendEmail({\n            to: emailData.customerEmail,\n            subject: `Order Confirmation - ${order.orderNumber}`,\n            html: customerEmailHtml,\n          })\n          .then((success) => {\n            if (success) {\n              logger.info('Order confirmation email sent', {\n                orderId: order.id,\n                orderNumber: order.orderNumber,\n                customerEmail: emailData.customerEmail,\n              });\n            }\n          })\n          .catch((error) => {\n            logger.error('Failed to send customer order confirmation email', {\n              error,\n              orderId: order.id,\n              orderNumber: order.orderNumber,\n              customerEmail: emailData.customerEmail,\n            });\n          });\n\n        // Send admin notification email (if configured)\n        if (storeConfig.orderNotificationEmail) {\n          const adminEmailHtml = emailTemplatesService.generateNewOrderNotificationEmail(emailData);\n          mailerService\n            .sendEmail({\n              to: storeConfig.orderNotificationEmail,\n              subject: `New Order: ${order.orderNumber}`,\n              html: adminEmailHtml,\n            })\n            .then((success) => {\n              if (success) {\n                logger.info('Admin order notification email sent', {\n                  orderId: order.id,\n                  orderNumber: order.orderNumber,\n                  adminEmail: storeConfig.orderNotificationEmail,\n                });\n              }\n            })\n            .catch((error) => {\n              logger.error('Failed to send admin order notification email', {\n                error,\n                orderId: order.id,\n                orderNumber: order.orderNumber,\n                adminEmail: storeConfig.orderNotificationEmail,\n              });\n            });\n        }\n      } catch (emailError) {\n        // Log email errors but don't fail the request\n        logger.error('Error in email notification process', {\n          error: emailError,\n          orderId: order.id,\n          orderNumber: order.orderNumber,\n        });\n      }\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/orders/track/:orderNumber\n * Public order tracking\n */\nordersRoutes.get('/track/:orderNumber', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const orderNumber = req.params['orderNumber'] as string;\n\n    const [order] = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.orderNumber, orderNumber));\n\n    if (!order) {\n      throw new NotFoundError('Order not found');\n    }\n\n    // Get order items\n    const items = await db\n      .select()\n      .from(orderItems)\n      .where(eq(orderItems.orderId, order.id));\n\n    // Build timeline with accurate timestamps\n    const timeline = [\n      { status: 'pending', timestamp: order.createdAt.toISOString(), description: 'Order placed' },\n    ];\n\n    if (order.status !== 'pending' && order.status !== 'cancelled' && order.confirmedAt) {\n      timeline.push({ status: 'confirmed', timestamp: order.confirmedAt.toISOString(), description: 'Order confirmed' });\n    }\n\n    if (['processing', 'shipped', 'delivered'].includes(order.status) && order.processingAt) {\n      timeline.push({ status: 'processing', timestamp: order.processingAt.toISOString(), description: 'Order is being processed' });\n    }\n\n    if (['shipped', 'delivered'].includes(order.status) && order.shippedAt) {\n      timeline.push({ status: 'shipped', timestamp: order.shippedAt.toISOString(), description: 'Order shipped' });\n    }\n\n    if (order.status === 'delivered' && order.deliveredAt) {\n      timeline.push({ status: 'delivered', timestamp: order.deliveredAt.toISOString(), description: 'Order delivered' });\n    }\n\n    // Extract shipping location (city/country only for privacy)\n    const shippingAddress = order.shippingAddress as { city?: string; country?: string } | null;\n\n    sendSuccess(res, {\n      orderNumber: order.orderNumber,\n      status: order.status,\n      paymentStatus: order.paymentStatus,\n      shippingMethod: order.shippingMethod,\n      trackingNumber: order.trackingNumber,\n      createdAt: order.createdAt.toISOString(),\n      total: Number(order.totalSnapshot),\n      itemCount: items.length,\n      items: items.map(item => ({\n        productName: item.productNameSnapshot,\n        quantity: item.quantity,\n        price: Number(item.unitPriceSnapshot),\n      })),\n      shippingLocation: shippingAddress ? {\n        city: shippingAddress.city,\n        country: shippingAddress.country,\n      } : null,\n      timeline,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Routes\n// ===========================================\n\n/**\n * GET /api/orders\n * Get customer's orders\n */\nordersRoutes.get('/', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(orders)\n      .where(eq(orders.customerId, customerId));\n    const count = countResult[0]?.count ?? 0;\n\n    const orderList = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        totalSnapshot: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, customerId))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    const ordersWithTotals = orderList.map(o => ({\n      ...o,\n      totalSnapshot: Number(o.totalSnapshot),\n    }));\n\n    sendSuccess(res, ordersWithTotals, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/orders/:id\n * Get order details\n */\nordersRoutes.get('/:id', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const customerId = req.user?.customerId;\n    const isAdmin = req.user?.role === 'admin';\n\n    const [order] = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.id, id));\n\n    if (!order) {\n      throw new NotFoundError('Order not found');\n    }\n\n    // Check ownership (unless admin)\n    if (!isAdmin && order.customerId !== customerId) {\n      throw new ForbiddenError('Access denied');\n    }\n\n    // Get order items\n    const items = await db\n      .select()\n      .from(orderItems)\n      .where(eq(orderItems.orderId, order.id));\n\n    // Get customer info if exists\n    let customer = null;\n    if (order.customerId) {\n      const [customerData] = await db\n        .select({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n        })\n        .from(customers)\n        .where(eq(customers.id, order.customerId));\n      customer = customerData || null;\n    }\n\n    sendSuccess(res, {\n      id: order.id,\n      orderNumber: order.orderNumber,\n      customerId: order.customerId,\n      customer,\n\n      // Status\n      status: order.status,\n      paymentStatus: order.paymentStatus,\n\n      // Financial\n      currency: order.currency,\n      subtotal: Number(order.subtotalSnapshot),\n      taxRate: Number(order.taxRateSnapshot),\n      tax: Number(order.taxAmountSnapshot),\n      shipping: Number(order.shippingAmountSnapshot),\n      discount: Number(order.discountAmountSnapshot),\n      total: Number(order.totalSnapshot),\n\n      // Promo\n      promoCodeId: order.promoCodeId,\n      promoCodeSnapshot: order.promoCodeSnapshot,\n\n      // Payment & Shipping\n      paymentMethod: order.paymentMethod,\n      shippingMethod: order.shippingMethod,\n      trackingNumber: order.trackingNumber,\n\n      // Addresses\n      shippingAddress: order.shippingAddress,\n      billingAddress: order.billingAddress,\n\n      // Notes\n      customerNotes: order.customerNotes,\n      adminNotes: order.adminNotes,\n\n      // Status Timestamps\n      confirmedAt: order.confirmedAt?.toISOString(),\n      processingAt: order.processingAt?.toISOString(),\n      shippedAt: order.shippedAt?.toISOString(),\n      deliveredAt: order.deliveredAt?.toISOString(),\n      createdAt: order.createdAt.toISOString(),\n      updatedAt: order.updatedAt.toISOString(),\n\n      // Items\n      items: items.map(item => ({\n        id: item.id,\n        productId: item.productId,\n        productName: item.productNameSnapshot,\n        productImage: null,\n        sku: item.skuSnapshot,\n        variantOptions: item.variantOptionsSnapshot,\n        quantity: item.quantity,\n        price: Number(item.unitPriceSnapshot),\n        total: Number(item.unitPriceSnapshot) * item.quantity,\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/orders/admin/all\n * Get all orders (Admin only)\n */\nordersRoutes.get(\n  '/admin/all',\n  requireAuth,\n  requireAdmin,\n  validateQuery(orderFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const filters = req.query;\n\n      const conditions = [];\n\n      if (filters['status']) {\n        conditions.push(eq(orders.status, filters['status'] as 'pending' | 'confirmed' | 'processing' | 'shipped' | 'delivered' | 'cancelled'));\n      }\n\n      if (filters['paymentStatus']) {\n        conditions.push(eq(orders.paymentStatus, filters['paymentStatus'] as 'pending' | 'paid' | 'refunded' | 'failed'));\n      }\n\n      // Search by customer name, email, or order number\n      if (filters['search']) {\n        const searchTerm = `%${filters['search']}%`;\n        conditions.push(\n          or(\n            ilike(orders.orderNumber, searchTerm),\n            ilike(customers.email, searchTerm),\n            ilike(customers.firstName, searchTerm),\n            ilike(customers.lastName, searchTerm),\n            sql`CONCAT(${customers.firstName}, ' ', ${customers.lastName}) ILIKE ${searchTerm}`\n          )\n        );\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Count query needs join when searching by customer fields\n      const countQuery = filters['search']\n        ? db.select({ count: sql<number>`count(*)` })\n            .from(orders)\n            .leftJoin(customers, eq(orders.customerId, customers.id))\n            .where(whereClause)\n        : db.select({ count: sql<number>`count(*)` })\n            .from(orders)\n            .where(whereClause);\n      const countResult = await countQuery;\n      const count = countResult[0]?.count ?? 0;\n\n      const orderList = await db\n        .select({\n          id: orders.id,\n          orderNumber: orders.orderNumber,\n          customerId: orders.customerId,\n          status: orders.status,\n          paymentStatus: orders.paymentStatus,\n          totalSnapshot: orders.totalSnapshot,\n          shippingAddress: orders.shippingAddress,\n          adminNotes: orders.adminNotes,\n          createdAt: orders.createdAt,\n          updatedAt: orders.updatedAt,\n          customer: {\n            id: customers.id,\n            email: customers.email,\n            firstName: customers.firstName,\n            lastName: customers.lastName,\n          },\n        })\n        .from(orders)\n        .leftJoin(customers, eq(orders.customerId, customers.id))\n        .where(whereClause)\n        .orderBy(desc(orders.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      // Format the response with proper totals\n      const formattedOrders = orderList.map(o => ({\n        ...o,\n        total: Number(o.totalSnapshot),\n        customer: o.customer?.id ? o.customer : null,\n      }));\n\n      sendSuccess(res, formattedOrders, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/orders/:id\n * Update order (Admin only)\n */\nordersRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Validate status transitions\n      const validTransitions: Record<string, string[]> = {\n        pending: ['confirmed', 'cancelled'],\n        confirmed: ['processing', 'cancelled'],\n        processing: ['shipped', 'cancelled'],\n        shipped: ['delivered'],\n        delivered: [],\n        cancelled: [],\n      };\n\n      if (data.status && data.status !== existing.status) {\n        const allowedNextStates = validTransitions[existing.status] || [];\n        if (!allowedNextStates.includes(data.status)) {\n          throw new BadRequestError(\n            `Cannot transition from '${existing.status}' to '${data.status}'`\n          );\n        }\n      }\n\n      // Restore stock on cancellation\n      if (data.status === 'cancelled' && existing.status !== 'cancelled') {\n        // Get order items\n        const orderItemsList = await db.select().from(orderItems)\n          .where(eq(orderItems.orderId, id));\n\n        // Restore stock for each item\n        for (const item of orderItemsList) {\n          if (item.variantId) {\n            await db.update(productVariants)\n              .set({\n                stockQuantity: sql`${productVariants.stockQuantity} + ${item.quantity}`,\n              })\n              .where(eq(productVariants.id, item.variantId));\n          } else if (item.productId) {\n            await db.update(products)\n              .set({\n                stockQuantity: sql`${products.stockQuantity} + ${item.quantity}`,\n              })\n              .where(eq(products.id, item.productId));\n          }\n        }\n      }\n\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      // Set timestamp when status changes to confirmed\n      if (data.status === 'confirmed' && existing.status !== 'confirmed') {\n        updateData['confirmedAt'] = new Date();\n      }\n\n      // Set timestamp when status changes to processing\n      if (data.status === 'processing' && existing.status !== 'processing') {\n        updateData['processingAt'] = new Date();\n      }\n\n      // Set shipped date if status changed to shipped\n      if (data.status === 'shipped' && existing.status !== 'shipped') {\n        updateData['shippedAt'] = new Date();\n      }\n\n      // Set delivered date if status changed to delivered\n      if (data.status === 'delivered' && existing.status !== 'delivered') {\n        updateData['deliveredAt'] = new Date();\n      }\n\n      const orderResult = await db\n        .update(orders)\n        .set(updateData)\n        .where(eq(orders.id, id))\n        .returning();\n      const order = orderResult[0];\n\n      sendSuccess(res, order);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/orders/:id/invoice\n * Download order invoice as PDF (Admin only)\n */\nordersRoutes.get(\n  '/:id/invoice',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [order] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!order) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Get order items\n      const items = await db\n        .select()\n        .from(orderItems)\n        .where(eq(orderItems.orderId, order.id));\n\n      // Get customer info\n      let customer = null;\n      if (order.customerId) {\n        const [customerData] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.id, order.customerId));\n        customer = customerData || null;\n      }\n\n      // Get shipping address for customer details\n      const shippingAddress = order.shippingAddress as {\n        firstName: string;\n        lastName: string;\n        phone?: string;\n        company?: string;\n      } | null;\n\n      // Prepare invoice data\n      const invoiceData = {\n        invoiceNumber: `INV-${order.orderNumber}`,\n        orderNumber: order.orderNumber,\n        quotationNumber: order.orderNumber,\n        createdAt: order.createdAt,\n        validUntil: new Date(order.createdAt.getTime() + 30 * 24 * 60 * 60 * 1000), // 30 days\n        status: order.status,\n        paymentStatus: order.paymentStatus,\n        paymentMethod: order.paymentMethod || 'cod',\n        paidAt: order.paymentStatus === 'paid' ? order.updatedAt : undefined,\n\n        // Customer info\n        customerName: customer\n          ? `${customer.firstName} ${customer.lastName}`\n          : shippingAddress\n            ? `${shippingAddress.firstName} ${shippingAddress.lastName}`\n            : 'Guest Customer',\n        customerEmail: customer?.email || '',\n        customerPhone: customer?.phone || shippingAddress?.phone,\n        customerCompany: shippingAddress?.company,\n\n        // Items\n        items: items.map(item => ({\n          productName: item.productNameSnapshot || 'Unknown Product',\n          sku: item.skuSnapshot || '',\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPriceSnapshot),\n          lineTotal: Number(item.unitPriceSnapshot) * item.quantity,\n          variantOptions: item.variantOptionsSnapshot as Record<string, string> | undefined,\n        })),\n\n        // Totals\n        subtotal: Number(order.subtotalSnapshot),\n        taxRate: Number(order.taxRateSnapshot),\n        taxAmount: Number(order.taxAmountSnapshot),\n        shippingAmount: Number(order.shippingAmountSnapshot),\n        discountAmount: Number(order.discountAmountSnapshot),\n        total: Number(order.totalSnapshot),\n        currency: order.currency || 'USD',\n\n        // Company info (can be configured via env)\n        companyName: process.env['COMPANY_NAME'] || 'Lab404',\n        companyAddress: process.env['COMPANY_ADDRESS'] || '123 Business Street, City, State 12345',\n        companyPhone: process.env['COMPANY_PHONE'] || '+1 (555) 123-4567',\n        companyEmail: process.env['COMPANY_EMAIL'] || 'contact@lab404.com',\n        companyWebsite: process.env['COMPANY_WEBSITE'] || 'https://lab404.com',\n      };\n\n      // Generate PDF\n      const pdfBuffer = await pdfService.generateInvoicePDF(invoiceData);\n\n      // Set response headers\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader(\n        'Content-Disposition',\n        `attachment; filename=\"invoice-${order.orderNumber}.pdf\"`\n      );\n      res.setHeader('Content-Length', pdfBuffer.length);\n\n      // Send PDF\n      res.send(pdfBuffer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Admin Order Creation\n// ===========================================\n\nconst adminCreateOrderSchema = z.object({\n  // Customer - either existing or new\n  customerId: z.string().uuid().optional(),\n  customerEmail: z.string().email().optional(),\n  customerFirstName: z.string().max(100).optional(),\n  customerLastName: z.string().max(100).optional(),\n  customerPhone: z.string().max(50).optional(),\n\n  // Items (required)\n  items: z.array(z.object({\n    productId: z.string().uuid(),\n    variantId: z.string().uuid().optional(),\n    quantity: z.number().int().positive(),\n  })).min(1, 'At least one item is required'),\n\n  // Addresses\n  shippingAddress: addressSchema,\n  billingAddress: addressSchema.optional(),\n  sameAsShipping: z.boolean().default(true),\n\n  // Payment\n  paymentMethod: z.enum(['cod', 'bank_transfer', 'cash']),\n  paymentStatus: z.enum(['pending', 'paid']).default('pending'),\n\n  // Discounts\n  promoCode: z.string().optional(),\n  manualDiscount: z.number().min(0).optional(),\n\n  // Notes\n  adminNotes: z.string().max(1000).optional(),\n  customerNotes: z.string().max(1000).optional(),\n});\n\n/**\n * POST /api/orders/admin\n * Create a new order (Admin only - bypasses cart)\n */\nordersRoutes.post(\n  '/admin',\n  requireAuth,\n  requireAdmin,\n  validateBody(adminCreateOrderSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // 1. Resolve customer\n      let customer;\n      if (data.customerId) {\n        // Use existing customer\n        const [existingCustomer] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.id, data.customerId));\n\n        if (!existingCustomer) {\n          throw new BadRequestError('Customer not found');\n        }\n        customer = existingCustomer;\n      } else if (data.customerEmail) {\n        // Find or create guest customer\n        const [existingCustomer] = await db\n          .select()\n          .from(customers)\n          .where(eq(customers.email, data.customerEmail.toLowerCase()));\n\n        if (existingCustomer) {\n          customer = existingCustomer;\n        } else {\n          // Create new guest customer\n          const [newCustomer] = await db\n            .insert(customers)\n            .values({\n              email: data.customerEmail.toLowerCase(),\n              firstName: data.customerFirstName || data.shippingAddress.firstName,\n              lastName: data.customerLastName || data.shippingAddress.lastName,\n              phone: data.customerPhone || data.shippingAddress.phone,\n              isGuest: true,\n            })\n            .returning();\n          customer = newCustomer;\n        }\n      } else {\n        throw new BadRequestError('Either customerId or customerEmail is required');\n      }\n\n      if (!customer) {\n        throw new BadRequestError('Failed to resolve customer');\n      }\n\n      // 2. Calculate totals using pricing service\n      const cartInput = data.items.map((item: { productId: string; variantId?: string; quantity: number }) => ({\n        productId: item.productId,\n        variantId: item.variantId,\n        quantity: item.quantity,\n      }));\n\n      const totals = await pricingService.calculateOrderTotals(\n        cartInput,\n        data.promoCode\n      );\n\n      // 3. Apply manual discount if provided\n      let finalDiscount = totals.discountAmount;\n      let finalTotal = totals.total;\n\n      if (data.manualDiscount && data.manualDiscount > 0) {\n        // Add manual discount (cap at remaining subtotal after promo discount)\n        const maxManualDiscount = totals.subtotal - totals.discountAmount;\n        const appliedManualDiscount = Math.min(data.manualDiscount, maxManualDiscount);\n        finalDiscount += appliedManualDiscount;\n        finalTotal = totals.subtotal - finalDiscount + totals.taxAmount + totals.shippingAmount;\n\n        // Recalculate tax on discounted amount\n        const discountedSubtotal = totals.subtotal - finalDiscount;\n        const newTax = discountedSubtotal * totals.taxRate;\n        finalTotal = discountedSubtotal + newTax + totals.shippingAmount;\n      }\n\n      // 4. Generate order number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(orders);\n      const count = countResult[0]?.count ?? 0;\n      const orderNumber = generateOrderNumber(Number(count) + 1);\n\n      // 5. Determine billing address\n      const billingAddress = data.sameAsShipping\n        ? data.shippingAddress\n        : data.billingAddress || data.shippingAddress;\n\n      // 6. Create order\n      const [order] = await db\n        .insert(orders)\n        .values({\n          orderNumber,\n          customerId: customer.id,\n          status: 'pending',\n          paymentStatus: data.paymentStatus,\n          shippingAddress: data.shippingAddress,\n          billingAddress,\n          currency: 'USD',\n          subtotalSnapshot: String(totals.subtotal),\n          taxRateSnapshot: String(totals.taxRate),\n          taxAmountSnapshot: String(data.manualDiscount ? (totals.subtotal - finalDiscount) * totals.taxRate : totals.taxAmount),\n          shippingAmountSnapshot: String(totals.shippingAmount),\n          discountAmountSnapshot: String(finalDiscount),\n          totalSnapshot: String(finalTotal),\n          promoCodeId: totals.promoCodeId,\n          promoCodeSnapshot: totals.promoCodeSnapshot,\n          paymentMethod: data.paymentMethod,\n          customerNotes: data.customerNotes,\n          adminNotes: data.adminNotes,\n        })\n        .returning();\n\n      if (!order) {\n        throw new BadRequestError('Failed to create order');\n      }\n\n      // 7. Create order items with product snapshots\n      for (const item of data.items) {\n        const [product] = await db\n          .select()\n          .from(products)\n          .where(eq(products.id, item.productId));\n\n        if (!product) {\n          throw new BadRequestError(`Product not found: ${item.productId}`);\n        }\n\n        let variant;\n        if (item.variantId) {\n          const [variantResult] = await db\n            .select()\n            .from(productVariants)\n            .where(eq(productVariants.id, item.variantId));\n          variant = variantResult;\n        }\n\n        const unitPrice = variant ? Number(variant.basePrice) : Number(product.basePrice);\n\n        await db.insert(orderItems).values({\n          orderId: order.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          productNameSnapshot: product.name,\n          skuSnapshot: variant?.sku || product.sku,\n          variantOptionsSnapshot: variant?.options,\n          quantity: item.quantity,\n          unitPriceSnapshot: String(unitPrice),\n        });\n      }\n\n      // 8. Update promo code usage if used\n      if (totals.promoCodeId) {\n        await db\n          .update(promoCodes)\n          .set({ usageCount: sql`${promoCodes.usageCount} + 1` })\n          .where(eq(promoCodes.id, totals.promoCodeId));\n      }\n\n      // 9. Update customer order count\n      await db\n        .update(customers)\n        .set({ orderCount: sql`${customers.orderCount} + 1` })\n        .where(eq(customers.id, customer.id));\n\n      sendCreated(res, {\n        id: order.id,\n        orderNumber: order.orderNumber,\n        total: finalTotal,\n        status: order.status,\n        paymentStatus: order.paymentStatus,\n        paymentMethod: order.paymentMethod,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/orders/:id\n * Delete a cancelled order (Admin only)\n */\nordersRoutes.delete(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [order] = await db\n        .select()\n        .from(orders)\n        .where(eq(orders.id, id));\n\n      if (!order) {\n        throw new NotFoundError('Order not found');\n      }\n\n      // Only allow deletion of cancelled orders\n      if (order.status !== 'cancelled') {\n        throw new BadRequestError('Only cancelled orders can be deleted');\n      }\n\n      // Delete order items first (cascade should handle this, but being explicit)\n      await db.delete(orderItems).where(eq(orderItems.orderId, id));\n\n      // Delete the order\n      await db.delete(orders).where(eq(orders.id, id));\n\n      sendSuccess(res, { message: 'Order deleted successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","/**\n * Email Templates Service\n *\n * Generates HTML email templates for order notifications and confirmations.\n * Uses inline CSS and table-based layouts for email client compatibility.\n */\n\ninterface AddressJson {\n  firstName: string;\n  lastName: string;\n  addressLine1: string;\n  addressLine2?: string;\n  city: string;\n  state?: string;\n  postalCode?: string;\n  country: string;\n  phone: string;\n  email: string;\n}\n\ninterface OrderEmailData {\n  orderNumber: string;\n  customerName: string;\n  customerEmail: string;\n  shippingAddress: AddressJson;\n  items: Array<{\n    productName: string;\n    sku: string;\n    quantity: number;\n    unitPrice: number;\n    lineTotal: number;\n  }>;\n  subtotal: number;\n  taxRate: number;\n  taxAmount: number;\n  shippingAmount: number;\n  discountAmount: number;\n  total: number;\n  currency: string;\n  promoCode?: string;\n  customerNotes?: string;\n  orderDate: string;\n  paymentMethod: string;\n}\n\nclass EmailTemplatesService {\n  /**\n   * Generate customer order confirmation email HTML\n   */\n  generateOrderConfirmationEmail(data: OrderEmailData): string {\n    const itemsHtml = data.items\n      .map(\n        (item) => `\n      <tr>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937;\">\n          <strong>${this.escapeHtml(item.productName)}</strong><br>\n          <span style=\"color: #6b7280; font-size: 12px;\">SKU: ${this.escapeHtml(item.sku)}</span>\n        </td>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; color: #1f2937;\">\n          ${item.quantity}\n        </td>\n        <td style=\"padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #1f2937;\">\n          ${this.formatCurrency(item.lineTotal, data.currency)}\n        </td>\n      </tr>\n    `\n      )\n      .join('');\n\n    const content = `\n      <!-- Order Confirmation Message -->\n      <tr>\n        <td style=\"padding: 40px 40px 20px;\">\n          <h2 style=\"margin: 0 0 10px; color: #1f2937; font-size: 24px; font-weight: bold;\">Order Confirmed!</h2>\n          <p style=\"margin: 0; color: #6b7280; font-size: 16px; line-height: 1.5;\">\n            Thank you for your order. We'll prepare it and contact you for delivery.\n          </p>\n        </td>\n      </tr>\n\n      <!-- Order Number -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <div style=\"background-color: #f3f4f6; padding: 20px; border-radius: 6px; text-align: center;\">\n            <p style=\"margin: 0 0 5px; font-size: 14px; color: #6b7280;\">Order Number</p>\n            <p style=\"margin: 0; font-size: 24px; font-weight: bold; color: #1f2937;\">#${this.escapeHtml(data.orderNumber)}</p>\n          </div>\n        </td>\n      </tr>\n\n      <!-- Order Items -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 15px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Details</h3>\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border: 1px solid #e5e7eb; border-radius: 6px;\">\n            <thead>\n              <tr style=\"background-color: #f9fafb;\">\n                <th style=\"padding: 12px 8px; text-align: left; font-size: 14px; color: #6b7280; font-weight: 600;\">Item</th>\n                <th style=\"padding: 12px 8px; text-align: center; font-size: 14px; color: #6b7280; font-weight: 600;\">Qty</th>\n                <th style=\"padding: 12px 8px; text-align: right; font-size: 14px; color: #6b7280; font-weight: 600;\">Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${itemsHtml}\n            </tbody>\n          </table>\n        </td>\n      </tr>\n\n      <!-- Price Breakdown -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <table width=\"100%\" cellpadding=\"8\" cellspacing=\"0\">\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Subtotal</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">${this.formatCurrency(data.subtotal, data.currency)}</td>\n            </tr>\n            ${\n              data.discountAmount > 0\n                ? `\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">\n                Discount ${data.promoCode ? `(${this.escapeHtml(data.promoCode)})` : ''}\n              </td>\n              <td style=\"text-align: right; font-size: 14px; color: #10b981;\">-${this.formatCurrency(data.discountAmount, data.currency)}</td>\n            </tr>\n            `\n                : ''\n            }\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Tax (${(data.taxRate * 100).toFixed(0)}%)</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">${this.formatCurrency(data.taxAmount, data.currency)}</td>\n            </tr>\n            <tr>\n              <td style=\"font-size: 14px; color: #6b7280;\">Shipping</td>\n              <td style=\"text-align: right; font-size: 14px; color: #1f2937;\">\n                ${data.shippingAmount > 0 ? this.formatCurrency(data.shippingAmount, data.currency) : 'Free'}\n              </td>\n            </tr>\n            <tr style=\"border-top: 2px solid #e5e7eb;\">\n              <td style=\"font-size: 18px; font-weight: bold; color: #1f2937; padding-top: 12px;\">Total</td>\n              <td style=\"text-align: right; font-size: 18px; font-weight: bold; color: #1f2937; padding-top: 12px;\">\n                ${this.formatCurrency(data.total, data.currency)}\n              </td>\n            </tr>\n          </table>\n        </td>\n      </tr>\n\n      <!-- COD Payment Notice -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <div style=\"background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 4px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #92400e; line-height: 1.6;\">\n              <strong>Payment Method:</strong> Cash on Delivery (COD)<br>\n              Pay with cash when you receive your order.\n            </p>\n          </div>\n        </td>\n      </tr>\n\n      <!-- Shipping Address -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Shipping Address</h3>\n          <p style=\"margin: 0; font-size: 14px; color: #6b7280; line-height: 1.8;\">\n            ${this.formatAddress(data.shippingAddress)}\n          </p>\n        </td>\n      </tr>\n\n      ${\n        data.customerNotes\n          ? `\n      <!-- Customer Notes -->\n      <tr>\n        <td style=\"padding: 0 40px 30px;\">\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Notes</h3>\n          <p style=\"margin: 0; font-size: 14px; color: #6b7280; line-height: 1.6;\">\n            ${this.escapeHtml(data.customerNotes)}\n          </p>\n        </td>\n      </tr>\n      `\n          : ''\n      }\n    `;\n\n    return this.generateEmailLayout(content, `Order Confirmation - #${data.orderNumber}`);\n  }\n\n  /**\n   * Generate admin new order notification email HTML\n   */\n  generateNewOrderNotificationEmail(data: OrderEmailData): string {\n    const itemsHtml = data.items\n      .map(\n        (item) => `\n      <tr>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937;\">\n          <strong>${this.escapeHtml(item.productName)}</strong><br>\n          <span style=\"color: #6b7280; font-size: 12px;\">SKU: ${this.escapeHtml(item.sku)}</span>\n        </td>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; color: #1f2937;\">\n          ${item.quantity}\n        </td>\n        <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #1f2937;\">\n          ${this.formatCurrency(item.lineTotal, data.currency)}\n        </td>\n      </tr>\n    `\n      )\n      .join('');\n\n    const content = `\n      <tr>\n        <td style=\"padding: 40px;\">\n          <h2 style=\"margin: 0 0 20px; color: #1f2937; font-size: 24px; font-weight: bold;\">New Order Received</h2>\n\n          <div style=\"background-color: #dbeafe; padding: 15px; border-radius: 6px; margin-bottom: 20px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #1e40af;\">\n              <strong>Order Number:</strong> #${this.escapeHtml(data.orderNumber)}\n            </p>\n          </div>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Customer</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.8;\">\n            <strong>${this.escapeHtml(data.customerName)}</strong><br>\n            ${this.escapeHtml(data.customerEmail)}<br>\n            ${this.escapeHtml(data.shippingAddress.phone)}\n          </p>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Order Summary</h3>\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border: 1px solid #e5e7eb; margin-bottom: 20px; border-radius: 6px;\">\n            <thead>\n              <tr style=\"background-color: #f9fafb;\">\n                <th style=\"padding: 12px 8px; text-align: left; font-size: 14px; color: #6b7280; font-weight: 600;\">Item</th>\n                <th style=\"padding: 12px 8px; text-align: center; font-size: 14px; color: #6b7280; font-weight: 600;\">Qty</th>\n                <th style=\"padding: 12px 8px; text-align: right; font-size: 14px; color: #6b7280; font-weight: 600;\">Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${itemsHtml}\n            </tbody>\n          </table>\n\n          <div style=\"text-align: right; font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 20px;\">\n            Total: ${this.formatCurrency(data.total, data.currency)}\n          </div>\n\n          <div style=\"background-color: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 20px;\">\n            <p style=\"margin: 0; color: #92400e; font-size: 14px;\">\n              <strong>Payment:</strong> Cash on Delivery (COD)\n            </p>\n          </div>\n\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Shipping Address</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.8;\">\n            ${this.formatAddress(data.shippingAddress)}\n          </p>\n\n          ${\n            data.customerNotes\n              ? `\n          <h3 style=\"margin: 0 0 10px; color: #1f2937; font-size: 18px; font-weight: bold;\">Customer Notes</h3>\n          <p style=\"margin: 0 0 20px; color: #6b7280; font-size: 14px; line-height: 1.6;\">\n            ${this.escapeHtml(data.customerNotes)}\n          </p>\n          `\n              : ''\n          }\n\n          <div style=\"text-align: center; margin-top: 30px;\">\n            <p style=\"margin: 0; font-size: 14px; color: #6b7280;\">\n              Log in to your admin dashboard to view and manage this order.\n            </p>\n          </div>\n        </td>\n      </tr>\n    `;\n\n    return this.generateEmailLayout(content, `New Order: #${data.orderNumber}`);\n  }\n\n  /**\n   * Generate email layout wrapper with header and footer\n   */\n  private generateEmailLayout(content: string, title: string): string {\n    return `<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>${this.escapeHtml(title)}</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; background-color: #f4f4f4; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #f4f4f4;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 20px 0;\">\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px;\">\n\n          <!-- Header -->\n          <tr>\n            <td style=\"background-color: #2563eb; color: #ffffff; padding: 30px 40px; text-align: center; border-radius: 8px 8px 0 0;\">\n              <h1 style=\"margin: 0; font-size: 28px; font-weight: bold; letter-spacing: -0.5px;\">Lab404 Electronics</h1>\n            </td>\n          </tr>\n\n          <!-- Content -->\n          ${content}\n\n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #f9fafb; padding: 30px 40px; text-align: center; border-top: 1px solid #e5e7eb; border-radius: 0 0 8px 8px;\">\n              <p style=\"margin: 0 0 10px; font-size: 14px; color: #6b7280; line-height: 1.6;\">\n                Questions? Contact us at <a href=\"mailto:contact@lab404electronics.com\" style=\"color: #2563eb; text-decoration: none;\">contact@lab404electronics.com</a>\n              </p>\n              <p style=\"margin: 0; font-size: 12px; color: #9ca3af;\">\n                &copy; 2026 Lab404 Electronics. All rights reserved.\n              </p>\n            </td>\n          </tr>\n\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  /**\n   * Format currency for display\n   */\n  private formatCurrency(amount: number, currency: string): string {\n    // Simple USD formatting - can be extended for other currencies\n    return `$${amount.toFixed(2)}`;\n  }\n\n  /**\n   * Format address for display\n   */\n  private formatAddress(address: AddressJson): string {\n    const parts: string[] = [];\n\n    parts.push(`<strong>${this.escapeHtml(address.firstName)} ${this.escapeHtml(address.lastName)}</strong>`);\n    parts.push(this.escapeHtml(address.addressLine1));\n\n    if (address.addressLine2) {\n      parts.push(this.escapeHtml(address.addressLine2));\n    }\n\n    const cityStateLine: string[] = [];\n    cityStateLine.push(this.escapeHtml(address.city));\n    if (address.state) {\n      cityStateLine.push(this.escapeHtml(address.state));\n    }\n    if (address.postalCode) {\n      cityStateLine.push(this.escapeHtml(address.postalCode));\n    }\n    parts.push(cityStateLine.join(', '));\n\n    parts.push(this.escapeHtml(address.country));\n    parts.push(this.escapeHtml(address.phone));\n\n    return parts.join('<br>');\n  }\n\n  /**\n   * Escape HTML to prevent XSS in email templates\n   */\n  private escapeHtml(text: string): string {\n    const map: { [key: string]: string } = {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#039;',\n    };\n    return text.replace(/[&<>\"']/g, (char) => map[char] || char);\n  }\n}\n\nexport const emailTemplatesService = new EmailTemplatesService();\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport bcrypt from 'bcryptjs';\nimport { getDb, customers, addresses, orders, eq, sql, desc, like, or, and } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ForbiddenError, BadRequestError } from '../utils/errors';\nimport { PasswordSecurityService } from '../services/password-security.service';\nimport { LoginAttemptService } from '../services/login-attempt.service';\nimport { notificationService } from '../services/notification.service';\nimport { auditLogService } from '../services/audit-log.service';\nimport { SecurityEventType, ActorType, EventStatus } from '../types/audit-events';\n\nexport const customersRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Common weak passwords to reject\nconst WEAK_PASSWORDS = [\n  '123456', '123456789', 'qwerty', 'password', '12345678',\n  '111111', '1234567890', '1234567', 'password1', '123123',\n  'abc123', 'qwerty123', '1q2w3e4r', 'admin', 'letmein',\n  'welcome', 'monkey', 'dragon', 'master', 'login'\n];\n\nconst updateProfileSchema = z.object({\n  firstName: z.string().min(1).max(100).optional(),\n  lastName: z.string().min(1).max(100).optional(),\n  phone: z.string().max(50).optional(),\n});\n\nconst changePasswordSchema = z.object({\n  currentPassword: z.string().min(1, 'Current password is required'),\n  newPassword: z.string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(72, 'Password must be less than 72 characters')\n    .refine(\n      (password) => {\n        const hasUppercase = /[A-Z]/.test(password);\n        const hasLowercase = /[a-z]/.test(password);\n        const hasNumber = /[0-9]/.test(password);\n        return hasUppercase && hasLowercase && hasNumber;\n      },\n      { message: 'Password must contain uppercase, lowercase, and number' }\n    )\n    .refine(\n      (password) => !WEAK_PASSWORDS.includes(password.toLowerCase()),\n      { message: 'Password is too common. Please choose a stronger password.' }\n    ),\n  confirmPassword: z.string().min(1, 'Please confirm your password'),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\nconst addressSchema = z.object({\n  type: z.enum(['shipping', 'billing'], {\n    errorMap: () => ({ message: 'Address type must be shipping or billing' })\n  }),\n  isDefault: z.boolean().optional().default(false),\n  firstName: z.string()\n    .min(1, 'First name is required')\n    .max(100, 'First name must be less than 100 characters'),\n  lastName: z.string()\n    .min(1, 'Last name is required')\n    .max(100, 'Last name must be less than 100 characters'),\n  company: z.string()\n    .max(255, 'Company must be less than 255 characters')\n    .optional(),\n  addressLine1: z.string()\n    .min(1, 'Address is required')\n    .max(255, 'Address must be less than 255 characters'),\n  addressLine2: z.string()\n    .max(255, 'Address line 2 must be less than 255 characters')\n    .optional(),\n  city: z.string()\n    .min(1, 'City is required')\n    .max(100, 'City must be less than 100 characters'),\n  state: z.string()\n    .max(100, 'State must be less than 100 characters')\n    .optional(),\n  postalCode: z.string()\n    .max(20, 'Postal code must be less than 20 characters')\n    .optional(),\n  country: z.string()\n    .min(1, 'Country is required')\n    .max(100, 'Country must be less than 100 characters'),\n  phone: z.string()\n    .max(50, 'Phone must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n});\n\nconst customerFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  isGuest: z.enum(['true', 'false']).optional(),\n});\n\nconst auditLogFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst adminUpdateCustomerSchema = z.object({\n  email: z.string()\n    .email('Please enter a valid email address')\n    .max(255, 'Email must be less than 255 characters')\n    .optional(),\n  firstName: z.string()\n    .min(1, 'First name cannot be empty')\n    .max(100, 'First name must be less than 100 characters')\n    .optional(),\n  lastName: z.string()\n    .min(1, 'Last name cannot be empty')\n    .max(100, 'Last name must be less than 100 characters')\n    .optional(),\n  phone: z.string()\n    .max(50, 'Phone number must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n  isGuest: z.boolean().optional(),\n  isActive: z.boolean().optional(),\n  acceptsMarketing: z.boolean().optional(),\n  notes: z.string()\n    .max(5000, 'Notes must be less than 5000 characters')\n    .optional(),\n  tags: z.array(\n    z.string().max(50, 'Each tag must be less than 50 characters')\n  ).optional(),\n});\n\nconst createCustomerSchema = z.object({\n  email: z.string()\n    .min(1, 'Email is required')\n    .email('Please enter a valid email address')\n    .max(255, 'Email must be less than 255 characters'),\n  firstName: z.string()\n    .min(1, 'First name cannot be empty')\n    .max(100, 'First name must be less than 100 characters')\n    .optional(),\n  lastName: z.string()\n    .min(1, 'Last name cannot be empty')\n    .max(100, 'Last name must be less than 100 characters')\n    .optional(),\n  phone: z.string()\n    .max(50, 'Phone number must be less than 50 characters')\n    .regex(/^[+]?[\\d\\s\\-().]*$/, 'Please enter a valid phone number')\n    .optional()\n    .or(z.literal('')),\n  isGuest: z.boolean().optional().default(false),\n  isActive: z.boolean().optional().default(true),\n  acceptsMarketing: z.boolean().optional().default(false),\n  notes: z.string()\n    .max(5000, 'Notes must be less than 5000 characters')\n    .optional(),\n  tags: z.array(\n    z.string().max(50, 'Each tag must be less than 50 characters')\n  ).optional(),\n});\n\n// ===========================================\n// Customer Profile Routes (Authenticated)\n// ===========================================\n\n/**\n * GET /api/customers/me\n * Get current customer profile\n */\ncustomersRoutes.get('/me', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const [customer] = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        phone: customers.phone,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n      })\n      .from(customers)\n      .where(eq(customers.id, customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Get addresses\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, {\n      ...customer,\n      addresses: customerAddresses,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/customers/me\n * Update current customer profile\n */\ncustomersRoutes.put(\n  '/me',\n  requireAuth,\n  validateBody(updateProfileSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      const customerResult = await db\n        .update(customers)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customerId))\n        .returning({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n          phone: customers.phone,\n        });\n      const customer = customerResult[0];\n\n      sendSuccess(res, customer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/me/password\n * Change customer password\n */\ncustomersRoutes.put(\n  '/me/password',\n  requireAuth,\n  validateBody(changePasswordSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const { currentPassword, newPassword } = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // Get customer with password hash and email\n      const [customer] = await db\n        .select()\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer || !customer.passwordHash) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Verify current password\n      const isPasswordValid = await bcrypt.compare(currentPassword, customer.passwordHash);\n      if (!isPasswordValid) {\n        throw new BadRequestError('Current password is incorrect');\n      }\n\n      // Validate new password with security checks\n      const userInputs = [customer.email, customer.firstName, customer.lastName].filter(Boolean) as string[];\n      const validation = await PasswordSecurityService.validatePassword(\n        newPassword,\n        customerId,\n        userInputs\n      );\n\n      if (!validation.isValid) {\n        throw new BadRequestError(validation.errors.join('. '));\n      }\n\n      // Hash new password\n      const newPasswordHash = await bcrypt.hash(newPassword, 12);\n\n      // Update password\n      await db\n        .update(customers)\n        .set({\n          passwordHash: newPasswordHash,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, customerId));\n\n      // Record password change in history\n      await PasswordSecurityService.recordPasswordChange({\n        customerId,\n        passwordHash: newPasswordHash,\n        changeReason: 'user_action',\n        ipAddress: req.ip || req.socket.remoteAddress,\n        userAgent: req.headers['user-agent'],\n      });\n\n      // Log password change event\n      await auditLogService.logFromRequest(req, {\n        eventType: SecurityEventType.PASSWORD_CHANGED,\n        actorType: ActorType.CUSTOMER,\n        actorId: customerId,\n        actorEmail: customer.email,\n        action: 'password_change',\n        status: EventStatus.SUCCESS,\n        metadata: {\n          changeReason: 'user_action',\n          strengthScore: validation.strengthResult?.score,\n        },\n      });\n\n      // Log breach/reuse warnings if any\n      if (validation.strengthResult?.isBreached) {\n        await auditLogService.logFromRequest(req, {\n          eventType: SecurityEventType.PASSWORD_BREACH_DETECTED,\n          actorType: ActorType.CUSTOMER,\n          actorId: customerId,\n          actorEmail: customer.email,\n          action: 'password_breach_check',\n          status: EventStatus.SUCCESS,\n          metadata: { breachCount: validation.strengthResult?.breachCount || 0 },\n        });\n      }\n\n      // Send confirmation email (non-blocking)\n      notificationService.sendPasswordChangedConfirmation({\n        email: customer.email,\n        firstName: customer.firstName,\n        timestamp: new Date(),\n        ipAddress: req.ip || req.socket.remoteAddress,\n      }).catch((error) => {\n        console.error('Failed to send password change confirmation:', error);\n      });\n\n      sendSuccess(res, { message: 'Password changed successfully' });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Customer Address Routes\n// ===========================================\n\n/**\n * GET /api/customers/me/addresses\n * Get customer addresses\n */\ncustomersRoutes.get('/me/addresses', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, customerAddresses);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/customers/me/addresses\n * Add new address\n */\ncustomersRoutes.post(\n  '/me/addresses',\n  requireAuth,\n  validateBody(addressSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .insert(addresses)\n        .values({\n          customerId,\n          ...data,\n        })\n        .returning();\n      const address = addressResult[0];\n\n      sendCreated(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/me/addresses/:id\n * Update address\n */\ncustomersRoutes.put(\n  '/me/addresses/:id',\n  requireAuth,\n  validateBody(addressSchema.partial()),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.user?.customerId;\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      // Verify ownership\n      const [existing] = await db\n        .select()\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, id),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type || existing.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .update(addresses)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(addresses.id, id))\n        .returning();\n      const address = addressResult[0];\n\n      sendSuccess(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/me/addresses/:id\n * Delete address\n */\ncustomersRoutes.delete('/me/addresses/:id', requireAuth, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.user?.customerId;\n    const id = req.params['id'] as string;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    // Verify ownership\n    const [existing] = await db\n      .select({ id: addresses.id })\n      .from(addresses)\n      .where(\n        and(\n          eq(addresses.id, id),\n          eq(addresses.customerId, customerId)\n        )\n      );\n\n    if (!existing) {\n      throw new NotFoundError('Address not found');\n    }\n\n    await db.delete(addresses).where(eq(addresses.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/customers\n * List all customers (Admin only)\n */\ncustomersRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(customerFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const search = req.query['search'];\n      const isGuest = req.query['isGuest'];\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(customers.email, `%${search}%`),\n            like(customers.firstName, `%${search}%`),\n            like(customers.lastName, `%${search}%`)\n          )\n        );\n      }\n\n      if (isGuest !== undefined) {\n        conditions.push(eq(customers.isGuest, isGuest === 'true'));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(customers)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const customerList = await db\n        .select({\n          id: customers.id,\n          email: customers.email,\n          firstName: customers.firstName,\n          lastName: customers.lastName,\n          phone: customers.phone,\n          isGuest: customers.isGuest,\n          isActive: customers.isActive,\n          orderCount: sql<number>`COUNT(${orders.id})`.as('order_count'),\n          paidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} = 'paid' THEN 1 END)`.as('paid_orders'),\n          unpaidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} != 'paid' AND ${orders.id} IS NOT NULL THEN 1 END)`.as('unpaid_orders'),\n          totalSpent: sql<number>`COALESCE(SUM(CASE WHEN ${orders.paymentStatus} = 'paid' THEN ${orders.totalSnapshot} ELSE 0 END), 0)`.as('total_spent'),\n          debt: sql<number>`COALESCE(SUM(CASE WHEN ${orders.paymentStatus} != 'paid' THEN ${orders.totalSnapshot} ELSE 0 END), 0)`.as('debt'),\n          createdAt: customers.createdAt,\n        })\n        .from(customers)\n        .leftJoin(orders, eq(orders.customerId, customers.id))\n        .where(whereClause)\n        .groupBy(\n          customers.id,\n          customers.email,\n          customers.firstName,\n          customers.lastName,\n          customers.phone,\n          customers.isGuest,\n          customers.isActive,\n          customers.createdAt\n        )\n        .orderBy(desc(customers.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      // Map orderCount to totalOrders for frontend consistency\n      const formattedList = customerList.map(c => ({\n        ...c,\n        totalOrders: c.orderCount,\n        paidOrders: Number(c.paidOrders),\n        unpaidOrders: Number(c.unpaidOrders),\n        totalSpent: Number(c.totalSpent),\n        debt: Number(c.debt),\n        orderCount: undefined,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/customers\n * Create new customer (Admin only)\n */\ncustomersRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createCustomerSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Check if email already exists\n      const [existingCustomer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.email, data.email));\n\n      if (existingCustomer) {\n        throw new BadRequestError('A customer with this email already exists');\n      }\n\n      // Create customer\n      const customerResult = await db\n        .insert(customers)\n        .values({\n          email: data.email,\n          firstName: data.firstName || null,\n          lastName: data.lastName || null,\n          phone: data.phone || null,\n          isGuest: data.isGuest ?? false,\n          isActive: data.isActive ?? true,\n          acceptsMarketing: data.acceptsMarketing ?? false,\n          notes: data.notes || null,\n          tags: data.tags || null,\n        })\n        .returning();\n      const customer = customerResult[0];\n\n      sendCreated(res, customer);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/customers/:id\n * Get customer details (Admin only)\n */\ncustomersRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Get addresses\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, id));\n\n    // Get recent orders\n    const recentOrders = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        totalSnapshot: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, id))\n      .orderBy(desc(orders.createdAt))\n      .limit(10);\n\n    // Calculate total spent (paid orders only)\n    const totalSpentResult = await db\n      .select({\n        totalSpent: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          eq(orders.customerId, id),\n          eq(orders.paymentStatus, 'paid')\n        )\n      );\n    const totalSpent = Number(totalSpentResult[0]?.totalSpent ?? 0);\n\n    // Calculate debt (unpaid orders)\n    const debtResult = await db\n      .select({\n        debt: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          eq(orders.customerId, id),\n          sql`${orders.paymentStatus} != 'paid'`\n        )\n      );\n    const debt = Number(debtResult[0]?.debt ?? 0);\n\n    // Calculate order counts\n    const orderCountsResult = await db\n      .select({\n        totalOrders: sql<number>`COUNT(*)`,\n        paidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} = 'paid' THEN 1 END)`,\n        unpaidOrders: sql<number>`COUNT(CASE WHEN ${orders.paymentStatus} != 'paid' THEN 1 END)`,\n      })\n      .from(orders)\n      .where(eq(orders.customerId, id));\n    const totalOrders = Number(orderCountsResult[0]?.totalOrders ?? 0);\n    const paidOrders = Number(orderCountsResult[0]?.paidOrders ?? 0);\n    const unpaidOrders = Number(orderCountsResult[0]?.unpaidOrders ?? 0);\n\n    sendSuccess(res, {\n      ...customer,\n      passwordHash: undefined, // Never expose password hash\n      totalOrders,\n      paidOrders,\n      unpaidOrders,\n      totalSpent,\n      debt,\n      addresses: customerAddresses,\n      recentOrders: recentOrders.map(o => ({\n        ...o,\n        totalSnapshot: Number(o.totalSnapshot),\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/customers/:id\n * Update customer (Admin only)\n */\ncustomersRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(adminUpdateCustomerSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Check email uniqueness if email is being updated\n      if (data.email) {\n        const [emailExists] = await db\n          .select({ id: customers.id })\n          .from(customers)\n          .where(\n            and(\n              eq(customers.email, data.email),\n              sql`${customers.id} != ${id}`\n            )\n          );\n\n        if (emailExists) {\n          throw new BadRequestError('A customer with this email already exists');\n        }\n      }\n\n      const customerResult = await db\n        .update(customers)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(customers.id, id))\n        .returning();\n      const customer = customerResult[0];\n\n      sendSuccess(res, {\n        ...customer,\n        passwordHash: undefined, // Never expose password hash\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/:id\n * Soft delete customer (Admin only)\n */\ncustomersRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: customers.id })\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Soft delete - just deactivate\n    await db\n      .update(customers)\n      .set({\n        isActive: false,\n        updatedAt: new Date(),\n      })\n      .where(eq(customers.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Customer Address Routes\n// ===========================================\n\n/**\n * GET /api/customers/:id/addresses\n * Get customer addresses (Admin only)\n */\ncustomersRoutes.get('/:id/addresses', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const customerId = req.params['id'] as string;\n\n    // Verify customer exists\n    const [customer] = await db\n      .select({ id: customers.id })\n      .from(customers)\n      .where(eq(customers.id, customerId));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    const customerAddresses = await db\n      .select()\n      .from(addresses)\n      .where(eq(addresses.customerId, customerId));\n\n    sendSuccess(res, customerAddresses);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/customers/:id/addresses\n * Add address to customer (Admin only)\n */\ncustomersRoutes.post(\n  '/:id/addresses',\n  requireAuth,\n  requireAdmin,\n  validateBody(addressSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const data = req.body;\n\n      // Verify customer exists\n      const [customer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .insert(addresses)\n        .values({\n          customerId,\n          ...data,\n        })\n        .returning();\n      const address = addressResult[0];\n\n      sendCreated(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/customers/:id/addresses/:addressId\n * Update customer address (Admin only)\n */\ncustomersRoutes.put(\n  '/:id/addresses/:addressId',\n  requireAuth,\n  requireAdmin,\n  validateBody(addressSchema.partial()),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const addressId = req.params['addressId'] as string;\n      const data = req.body;\n\n      // Verify customer exists\n      const [customer] = await db\n        .select({ id: customers.id })\n        .from(customers)\n        .where(eq(customers.id, customerId));\n\n      if (!customer) {\n        throw new NotFoundError('Customer not found');\n      }\n\n      // Verify address belongs to customer\n      const [existing] = await db\n        .select()\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, addressId),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      // If setting as default, unset other defaults of same type\n      if (data.isDefault) {\n        await db\n          .update(addresses)\n          .set({ isDefault: false })\n          .where(\n            and(\n              eq(addresses.customerId, customerId),\n              eq(addresses.type, data.type || existing.type)\n            )\n          );\n      }\n\n      const addressResult = await db\n        .update(addresses)\n        .set({\n          ...data,\n          updatedAt: new Date(),\n        })\n        .where(eq(addresses.id, addressId))\n        .returning();\n      const address = addressResult[0];\n\n      sendSuccess(res, address);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/customers/:id/addresses/:addressId\n * Delete customer address (Admin only)\n */\ncustomersRoutes.delete(\n  '/:id/addresses/:addressId',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const customerId = req.params['id'] as string;\n      const addressId = req.params['addressId'] as string;\n\n      // Verify address belongs to customer\n      const [existing] = await db\n        .select({ id: addresses.id })\n        .from(addresses)\n        .where(\n          and(\n            eq(addresses.id, addressId),\n            eq(addresses.customerId, customerId)\n          )\n        );\n\n      if (!existing) {\n        throw new NotFoundError('Address not found');\n      }\n\n      await db.delete(addresses).where(eq(addresses.id, addressId));\n\n      sendNoContent(res);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/customers/:id/orders\n * Get customer orders (Admin only)\n */\ncustomersRoutes.get('/:id/orders', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(orders)\n      .where(eq(orders.customerId, id));\n    const count = countResult[0]?.count ?? 0;\n\n    const orderList = await db\n      .select()\n      .from(orders)\n      .where(eq(orders.customerId, id))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(\n      res,\n      orderList.map(o => ({\n        id: o.id,\n        orderNumber: o.orderNumber,\n        status: o.status,\n        paymentStatus: o.paymentStatus,\n        total: Number(o.totalSnapshot),\n        createdAt: o.createdAt,\n      })),\n      200,\n      createPaginationMeta(page, limit, Number(count))\n    );\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Security Routes\n// ===========================================\n\n/**\n * GET /api/customers/me/security/login-attempts\n * Get login attempt history for the current customer\n */\ncustomersRoutes.get('/me/security/login-attempts', requireAuth, async (req, res, next) => {\n  try {\n    const customerId = req.user?.customerId;\n\n    if (!customerId) {\n      throw new ForbiddenError('Customer not found');\n    }\n\n    const attempts = await LoginAttemptService.getAttemptHistory(customerId, 50);\n\n    sendSuccess(res, attempts);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/customers/me/audit-logs\n * Get audit logs for the current customer\n */\ncustomersRoutes.get(\n  '/me/audit-logs',\n  requireAuth,\n  validateQuery(auditLogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const customerId = req.user?.customerId;\n\n      if (!customerId) {\n        throw new ForbiddenError('Customer not found');\n      }\n\n      const {\n        startDate,\n        endDate,\n        eventType,\n        limit,\n        offset,\n      } = req.query;\n\n      // Parse query parameters\n      const filters: Parameters<typeof auditLogService.query>[0] = {\n        actorId: customerId, // Only return logs for this customer\n        startDate: startDate ? new Date(startDate as string) : undefined,\n        endDate: endDate ? new Date(endDate as string) : undefined,\n        eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n        limit: limit ? parseInt(limit as string, 10) : 50,\n        offset: offset ? parseInt(offset as string, 10) : 0,\n      };\n\n      const logs = await auditLogService.query(filters);\n\n      sendSuccess(res, logs);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/admin/customers/:id/unlock\n * Admin: Unlock a customer account\n */\ncustomersRoutes.post('/admin/customers/:id/unlock', requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const db = getDb();\n\n    // Verify customer exists\n    const [customer] = await db\n      .select({ id: customers.id, email: customers.email })\n      .from(customers)\n      .where(eq(customers.id, id));\n\n    if (!customer) {\n      throw new NotFoundError('Customer not found');\n    }\n\n    // Unlock the account\n    await LoginAttemptService.unlockAccount(id);\n\n    sendSuccess(res, {\n      message: 'Customer account unlocked successfully',\n      customerId: id,\n      email: customer.email,\n    });\n  } catch (error) {\n    next(error);\n  }\n});","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, promoCodes, eq, sql, desc, and, gte, lte, or, like } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError, BadRequestError } from '../utils/errors';\n\nexport const promoCodesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createPromoCodeSchema = z.object({\n  code: z.string().min(3).max(50).transform(s => s.toUpperCase()),\n  description: z.string().max(500).optional(),\n  discountType: z.enum(['percentage', 'fixed_amount']),\n  discountValue: z.number().positive(),\n  minimumOrderAmount: z.number().min(0).optional(),\n  maximumDiscountAmount: z.number().positive().optional(),\n  usageLimit: z.number().int().positive().optional(),\n  usageLimitPerCustomer: z.number().int().positive().optional(),\n  startsAt: z.string().datetime().optional(),\n  expiresAt: z.string().datetime().optional(),\n  isActive: z.boolean().optional().default(true),\n});\n\nconst updatePromoCodeSchema = createPromoCodeSchema.partial().omit({ code: true });\n\nconst promoCodeFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  isActive: z.enum(['true', 'false']).optional(),\n  status: z.enum(['active', 'expired', 'upcoming']).optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * POST /api/promo-codes/validate\n * Validate a promo code (public endpoint for cart)\n */\npromoCodesRoutes.post(\n  '/validate',\n  validateBody(z.object({ code: z.string().min(1), orderAmount: z.number().min(0) })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { code, orderAmount } = req.body;\n\n      const [promoCode] = await db\n        .select()\n        .from(promoCodes)\n        .where(eq(promoCodes.code, code.toUpperCase()));\n\n      if (!promoCode) {\n        throw new BadRequestError('Invalid promo code');\n      }\n\n      // Check if active\n      if (!promoCode.isActive) {\n        throw new BadRequestError('Promo code is not active');\n      }\n\n      // Check dates\n      const now = new Date();\n      if (promoCode.startsAt && new Date(promoCode.startsAt) > now) {\n        throw new BadRequestError('Promo code is not yet valid');\n      }\n      if (promoCode.expiresAt && new Date(promoCode.expiresAt) < now) {\n        throw new BadRequestError('Promo code has expired');\n      }\n\n      // Check usage limit\n      if (promoCode.usageLimit && promoCode.usageCount >= promoCode.usageLimit) {\n        throw new BadRequestError('Promo code usage limit reached');\n      }\n\n      // Check minimum order amount\n      if (promoCode.minimumOrderAmount && orderAmount < Number(promoCode.minimumOrderAmount)) {\n        throw new BadRequestError(\n          `Minimum order amount of $${promoCode.minimumOrderAmount} required`\n        );\n      }\n\n      // Calculate discount\n      let discountAmount: number;\n      if (promoCode.discountType === 'percentage') {\n        discountAmount = (orderAmount * Number(promoCode.discountValue)) / 100;\n        // Apply maximum discount cap if set\n        if (promoCode.maximumDiscountAmount) {\n          discountAmount = Math.min(discountAmount, Number(promoCode.maximumDiscountAmount));\n        }\n      } else {\n        discountAmount = Math.min(Number(promoCode.discountValue), orderAmount);\n      }\n\n      sendSuccess(res, {\n        valid: true,\n        code: promoCode.code,\n        discountType: promoCode.discountType,\n        discountValue: Number(promoCode.discountValue),\n        discountAmount: Math.round(discountAmount * 100) / 100,\n        description: promoCode.description,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/promo-codes\n * List all promo codes (Admin only)\n */\npromoCodesRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(promoCodeFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, isActive, status } = req.query;\n\n      const conditions = [];\n      const now = new Date();\n\n      if (search) {\n        conditions.push(\n          or(\n            like(promoCodes.code, `%${(search as string).toUpperCase()}%`),\n            like(promoCodes.description, `%${search}%`)\n          )\n        );\n      }\n\n      if (isActive !== undefined) {\n        conditions.push(eq(promoCodes.isActive, isActive === 'true'));\n      }\n\n      if (status === 'active') {\n        conditions.push(eq(promoCodes.isActive, true));\n        conditions.push(\n          or(\n            sql`${promoCodes.startsAt} IS NULL`,\n            lte(promoCodes.startsAt, now)\n          )\n        );\n        conditions.push(\n          or(\n            sql`${promoCodes.expiresAt} IS NULL`,\n            gte(promoCodes.expiresAt, now)\n          )\n        );\n      } else if (status === 'expired') {\n        conditions.push(lte(promoCodes.expiresAt, now));\n      } else if (status === 'upcoming') {\n        conditions.push(gte(promoCodes.startsAt, now));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(promoCodes)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const promoCodeList = await db\n        .select()\n        .from(promoCodes)\n        .where(whereClause)\n        .orderBy(desc(promoCodes.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      const formattedList = promoCodeList.map(pc => ({\n        ...pc,\n        discountValue: Number(pc.discountValue),\n        minimumOrderAmount: pc.minimumOrderAmount ? Number(pc.minimumOrderAmount) : null,\n        maximumDiscountAmount: pc.maximumDiscountAmount ? Number(pc.maximumDiscountAmount) : null,\n        isExpired: pc.expiresAt ? new Date(pc.expiresAt) < now : false,\n        isUpcoming: pc.startsAt ? new Date(pc.startsAt) > now : false,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/promo-codes/:id\n * Get promo code details (Admin only)\n */\npromoCodesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [promoCode] = await db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!promoCode) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    sendSuccess(res, {\n      ...promoCode,\n      discountValue: Number(promoCode.discountValue),\n      minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n      maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/promo-codes\n * Create a new promo code (Admin only)\n */\npromoCodesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createPromoCodeSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Check if code already exists\n      const [existing] = await db\n        .select({ id: promoCodes.id })\n        .from(promoCodes)\n        .where(eq(promoCodes.code, data.code));\n\n      if (existing) {\n        throw new ConflictError('Promo code already exists');\n      }\n\n      // Validate percentage discount\n      if (data.discountType === 'percentage' && data.discountValue > 100) {\n        throw new BadRequestError('Percentage discount cannot exceed 100%');\n      }\n\n      // Validate dates\n      if (data.startsAt && data.expiresAt) {\n        if (new Date(data.startsAt) >= new Date(data.expiresAt)) {\n          throw new BadRequestError('Start date must be before expiry date');\n        }\n      }\n\n      const promoCodeResult = await db\n        .insert(promoCodes)\n        .values({\n          ...data,\n          startsAt: data.startsAt ? new Date(data.startsAt) : undefined,\n          expiresAt: data.expiresAt ? new Date(data.expiresAt) : undefined,\n        })\n        .returning();\n      const promoCode = promoCodeResult[0];\n\n      if (!promoCode) {\n        throw new BadRequestError('Failed to create promo code');\n      }\n\n      sendCreated(res, {\n        ...promoCode,\n        discountValue: Number(promoCode.discountValue),\n        minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n        maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/promo-codes/:id\n * Update a promo code (Admin only)\n */\npromoCodesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updatePromoCodeSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(promoCodes)\n        .where(eq(promoCodes.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Promo code not found');\n      }\n\n      // Validate percentage discount\n      if (data.discountType === 'percentage' && data.discountValue && data.discountValue > 100) {\n        throw new BadRequestError('Percentage discount cannot exceed 100%');\n      }\n\n      // Validate dates\n      const startsAt = data.startsAt ? new Date(data.startsAt) : existing.startsAt;\n      const expiresAt = data.expiresAt ? new Date(data.expiresAt) : existing.expiresAt;\n      if (startsAt && expiresAt && startsAt >= expiresAt) {\n        throw new BadRequestError('Start date must be before expiry date');\n      }\n\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      if (data['startsAt']) {\n        updateData['startsAt'] = new Date(data['startsAt'] as string);\n      }\n      if (data['expiresAt']) {\n        updateData['expiresAt'] = new Date(data['expiresAt'] as string);\n      }\n\n      const promoCodeResult = await db\n        .update(promoCodes)\n        .set(updateData)\n        .where(eq(promoCodes.id, id))\n        .returning();\n      const promoCode = promoCodeResult[0];\n\n      if (!promoCode) {\n        throw new NotFoundError('Promo code not found');\n      }\n\n      sendSuccess(res, {\n        ...promoCode,\n        discountValue: Number(promoCode.discountValue),\n        minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n        maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/promo-codes/:id\n * Delete a promo code (Admin only)\n */\npromoCodesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: promoCodes.id, usageCount: promoCodes.usageCount })\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    // Prevent deletion if code has been used\n    if (existing.usageCount > 0) {\n      throw new BadRequestError(\n        'Cannot delete promo code that has been used. Consider deactivating it instead.'\n      );\n    }\n\n    await db.delete(promoCodes).where(eq(promoCodes.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/promo-codes/:id/toggle\n * Toggle promo code active status (Admin only)\n */\npromoCodesRoutes.post('/:id/toggle', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(promoCodes)\n      .where(eq(promoCodes.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    const promoCodeResult = await db\n      .update(promoCodes)\n      .set({\n        isActive: !existing.isActive,\n        updatedAt: new Date(),\n      })\n      .where(eq(promoCodes.id, id))\n      .returning();\n    const promoCode = promoCodeResult[0];\n\n    if (!promoCode) {\n      throw new NotFoundError('Promo code not found');\n    }\n\n    sendSuccess(res, {\n      ...promoCode,\n      discountValue: Number(promoCode.discountValue),\n      minimumOrderAmount: promoCode.minimumOrderAmount ? Number(promoCode.minimumOrderAmount) : null,\n      maximumDiscountAmount: promoCode.maximumDiscountAmount ? Number(promoCode.maximumDiscountAmount) : null,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/promo-codes/stats/summary\n * Get promo code usage statistics (Admin only)\n */\npromoCodesRoutes.get('/stats/summary', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n\n    // Total promo codes\n    const totalResult = await db\n      .select({ total: sql<number>`count(*)` })\n      .from(promoCodes);\n    const total = totalResult[0]?.total ?? 0;\n\n    // Active promo codes\n    const activeResult = await db\n      .select({ active: sql<number>`count(*)` })\n      .from(promoCodes)\n      .where(\n        and(\n          eq(promoCodes.isActive, true),\n          or(\n            sql`${promoCodes.startsAt} IS NULL`,\n            lte(promoCodes.startsAt, now)\n          ),\n          or(\n            sql`${promoCodes.expiresAt} IS NULL`,\n            gte(promoCodes.expiresAt, now)\n          )\n        )\n      );\n    const active = activeResult[0]?.active ?? 0;\n\n    // Total usage\n    const usageResult = await db\n      .select({ totalUsage: sql<number>`COALESCE(sum(${promoCodes.usageCount}), 0)` })\n      .from(promoCodes);\n    const totalUsage = usageResult[0]?.totalUsage ?? 0;\n\n    // Most used promo codes\n    const topCodes = await db\n      .select({\n        code: promoCodes.code,\n        usageCount: promoCodes.usageCount,\n        discountType: promoCodes.discountType,\n        discountValue: promoCodes.discountValue,\n      })\n      .from(promoCodes)\n      .where(sql`${promoCodes.usageCount} > 0`)\n      .orderBy(desc(promoCodes.usageCount))\n      .limit(5);\n\n    sendSuccess(res, {\n      total: Number(total),\n      active: Number(active),\n      expired: Number(total) - Number(active),\n      totalUsage: Number(totalUsage),\n      topCodes: topCodes.map(c => ({\n        ...c,\n        discountValue: Number(c.discountValue),\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, quotations, quotationItems, customers, products, productVariants, settings, pdfTemplates, eq, sql, desc, and, or, like, gte, lte } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\nimport { pricingService } from '../services/pricing.service';\nimport { pdfService } from '../services/pdf.service';\nimport { notificationService } from '../services/notification.service';\nimport { quotationActivityService } from '../services/quotation-activity.service';\nimport { quotationRevisionService } from '../services/quotation-revision.service';\nimport { generateSecureToken } from '../utils/crypto';\nimport { logger } from '../utils/logger';\n\nexport const quotationsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\n// Schema for quotation items - supports both product-based and custom items\nconst quotationItemSchema = z.object({\n  // For product-based items\n  productId: z.string().uuid().optional(),\n  variantId: z.string().uuid().optional(),\n\n  // For custom items (required if no productId)\n  name: z.string().min(1).max(200).optional(),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  unitPrice: z.number().positive().optional(),\n\n  // Common fields\n  quantity: z.number().int().min(1),\n  customPrice: z.number().positive().optional(), // Override price for product items\n}).refine(\n  (data) => {\n    // Either productId OR (name + unitPrice) must be provided\n    if (data.productId) {\n      return true; // Product-based item\n    }\n    return data.name && data.unitPrice; // Custom item needs name and price\n  },\n  { message: 'Either productId or (name and unitPrice) is required' }\n);\n\nconst createQuotationSchema = z.object({\n  customerId: z.string().uuid().optional(),\n  customerName: z.string().min(1).max(200),\n  customerEmail: z.string().email(),\n  customerPhone: z.string().max(50).optional(),\n  customerCompany: z.string().max(255).optional(),\n  items: z.array(quotationItemSchema).min(1),\n  notes: z.string().max(2000).optional(),\n  terms: z.string().max(2000).optional(),\n  validDays: z.number().int().min(1).max(365).optional().default(30),\n  discountType: z.enum(['percentage', 'fixed']).optional(),\n  discountValue: z.number().min(0).optional(),\n});\n\n// Schema for update quotation items - supports both product-based and custom items\nconst updateQuotationItemSchema = z.object({\n  // For product-based items\n  productId: z.string().uuid().optional(),\n  variantId: z.string().uuid().optional(),\n\n  // For custom items\n  name: z.string().min(1).max(200).optional(),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  unitPrice: z.number().positive().optional(),\n\n  // Common fields\n  quantity: z.number().int().min(1),\n  customPrice: z.number().positive().optional(),\n}).refine(\n  (data) => {\n    if (data.productId) {\n      return true;\n    }\n    return data.name && data.unitPrice;\n  },\n  { message: 'Either productId or (name and unitPrice) is required' }\n);\n\nconst updateQuotationSchema = z.object({\n  customerName: z.string().min(1).max(200).optional(),\n  customerEmail: z.string().email().optional(),\n  customerPhone: z.string().max(50).optional().nullable(),\n  customerCompany: z.string().max(255).optional().nullable(),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n  notes: z.string().max(2000).optional().nullable(),\n  terms: z.string().max(2000).optional().nullable(),\n  validDays: z.number().int().min(1).max(365).optional(),\n  discountType: z.enum(['percentage', 'fixed']).optional(),\n  discountValue: z.number().min(0).optional(),\n  taxRate: z.number().min(0).max(1).optional(), // Decimal 0-1\n  items: z.array(updateQuotationItemSchema).min(1).optional(),\n});\n\nconst quotationFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n  customerId: z.string().uuid().optional(),\n});\n\n// Helper to generate quotation number\nfunction generateQuotationNumber(count: number): string {\n  const year = new Date().getFullYear();\n  const sequence = String(count).padStart(5, '0');\n  return `QT-${year}-${sequence}`;\n}\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/quotations\n * List all quotations (Admin only)\n */\nquotationsRoutes.get(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateQuery(quotationFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, status, customerId } = req.query;\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(quotations.quotationNumber, `%${search}%`),\n            like(quotations.customerName, `%${search}%`),\n            like(quotations.customerEmail, `%${search}%`)\n          )\n        );\n      }\n\n      if (status) {\n        conditions.push(eq(quotations.status, status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired'));\n      }\n\n      if (customerId) {\n        conditions.push(eq(quotations.customerId, customerId as string));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(quotations)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const quotationList = await db\n        .select()\n        .from(quotations)\n        .where(whereClause)\n        .orderBy(desc(quotations.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      const formattedList = quotationList.map(q => ({\n        ...q,\n        subtotal: Number(q.subtotal),\n        taxAmount: Number(q.taxAmount || 0),\n        discountAmount: Number(q.discountAmount),\n        total: Number(q.total),\n        isExpired: q.validUntil ? new Date(q.validUntil) < new Date() : false,\n      }));\n\n      sendSuccess(res, formattedList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/quotations/stats\n * Get quotation statistics (Admin only)\n */\nquotationsRoutes.get('/stats', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);\n\n    // Get total count\n    const [totalResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations);\n\n    // Get counts by status\n    const statusCounts = await db\n      .select({\n        status: quotations.status,\n        count: sql<number>`count(*)`,\n      })\n      .from(quotations)\n      .groupBy(quotations.status);\n\n    // Get total value of all quotations\n    const [totalValueResult] = await db\n      .select({ total: sql<number>`COALESCE(SUM(total), 0)` })\n      .from(quotations);\n\n    // Get total value of accepted quotations\n    const [acceptedValueResult] = await db\n      .select({ total: sql<number>`COALESCE(SUM(total), 0)` })\n      .from(quotations)\n      .where(eq(quotations.status, 'accepted'));\n\n    // Get quotations expiring soon (within 7 days, status = sent)\n    const [expiringSoonResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations)\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          gte(quotations.validUntil, now),\n          lte(quotations.validUntil, sevenDaysFromNow)\n        )\n      );\n\n    // Get quotations created this month\n    const [thisMonthResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations)\n      .where(gte(quotations.createdAt, startOfMonth));\n\n    // Calculate conversion rate (accepted / (accepted + rejected))\n    const statusMap = statusCounts.reduce((acc, item) => {\n      acc[item.status] = Number(item.count);\n      return acc;\n    }, {} as Record<string, number>);\n\n    const acceptedCount = statusMap['accepted'] || 0;\n    const rejectedCount = statusMap['rejected'] || 0;\n    const convertedCount = statusMap['converted'] || 0;\n    const totalDecided = acceptedCount + rejectedCount + convertedCount;\n    const conversionRate = totalDecided > 0 ? ((acceptedCount + convertedCount) / totalDecided) * 100 : 0;\n\n    sendSuccess(res, {\n      total: Number(totalResult.count),\n      byStatus: {\n        draft: statusMap['draft'] || 0,\n        sent: statusMap['sent'] || 0,\n        accepted: statusMap['accepted'] || 0,\n        rejected: statusMap['rejected'] || 0,\n        expired: statusMap['expired'] || 0,\n        converted: statusMap['converted'] || 0,\n      },\n      totalValue: Number(totalValueResult.total),\n      acceptedValue: Number(acceptedValueResult.total),\n      conversionRate: Math.round(conversionRate * 100) / 100,\n      expiringSoon: Number(expiringSoonResult.count),\n      thisMonth: Number(thisMonthResult.count),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Check and Update Expired Quotations\n// ===========================================\n\nquotationsRoutes.post('/check-expired', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n\n    // Find quotations that should be expired:\n    // - Only 'sent' quotations are checked (drafts don't expire automatically)\n    // - validUntil date has passed (validUntil is set when quotation is sent)\n    const expiredQuotations = await db\n      .select({ id: quotations.id, quotationNumber: quotations.quotationNumber })\n      .from(quotations)\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      );\n\n    if (expiredQuotations.length === 0) {\n      sendSuccess(res, {\n        updated: 0,\n        message: 'No quotations to expire'\n      });\n      return;\n    }\n\n    // Update all expired quotations\n    await db\n      .update(quotations)\n      .set({\n        status: 'expired',\n        updatedAt: now\n      })\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      );\n\n    // Log activity for each expired quotation\n    for (const q of expiredQuotations) {\n      await quotationActivityService.logActivity({\n        quotationId: q.id,\n        activityType: 'status_changed',\n        description: `Quotation automatically expired (past valid date)`,\n        actorType: 'system',\n        actorName: 'System',\n        metadata: {\n          previousStatus: 'sent',\n          newStatus: 'expired',\n          automatic: true\n        },\n      });\n    }\n\n    logger.info('Auto-expired quotations', {\n      count: expiredQuotations.length,\n      quotationNumbers: expiredQuotations.map(q => q.quotationNumber)\n    });\n\n    sendSuccess(res, {\n      updated: expiredQuotations.length,\n      quotations: expiredQuotations.map(q => q.quotationNumber),\n      message: `${expiredQuotations.length} quotation(s) marked as expired`\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Bulk Actions Schema\n// ===========================================\n\nconst bulkActionsSchema = z.object({\n  action: z.enum(['delete', 'send', 'changeStatus']),\n  ids: z.array(z.string().uuid()).min(1).max(100),\n  status: z.enum(['draft', 'sent', 'accepted', 'rejected', 'expired']).optional(),\n}).refine(\n  (data) => {\n    if (data.action === 'changeStatus' && !data.status) {\n      return false;\n    }\n    return true;\n  },\n  { message: 'Status is required for changeStatus action' }\n);\n\n/**\n * POST /api/quotations/bulk\n * Perform bulk actions on quotations (Admin only)\n */\nquotationsRoutes.post(\n  '/bulk',\n  requireAuth,\n  requireAdmin,\n  validateBody(bulkActionsSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { action, ids, status } = req.body;\n      const results: { success: string[]; failed: string[] } = { success: [], failed: [] };\n\n      for (const id of ids) {\n        try {\n          const [quotation] = await db\n            .select()\n            .from(quotations)\n            .where(eq(quotations.id, id));\n\n          if (!quotation) {\n            results.failed.push(id);\n            continue;\n          }\n\n          switch (action) {\n            case 'delete':\n              // Delete associated items first (cascade should handle this but being explicit)\n              await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n              await db.delete(quotations).where(eq(quotations.id, id));\n              results.success.push(id);\n              break;\n\n            case 'send':\n              // Only send draft quotations\n              if (quotation.status !== 'draft') {\n                results.failed.push(id);\n                continue;\n              }\n\n              // Generate acceptance token\n              const acceptanceToken = generateSecureToken(32);\n              const tokenExpiresAt = new Date();\n              tokenExpiresAt.setDate(tokenExpiresAt.getDate() + 30);\n\n              await db\n                .update(quotations)\n                .set({\n                  status: 'sent',\n                  acceptanceToken,\n                  tokenExpiresAt,\n                  updatedAt: new Date(),\n                })\n                .where(eq(quotations.id, id));\n\n              // Log activity\n              await quotationActivityService.logSent(\n                id,\n                quotation.customerEmail,\n                (req as { user?: { name?: string } }).user?.name\n              ).catch(() => {}); // Non-blocking\n\n              results.success.push(id);\n              break;\n\n            case 'changeStatus':\n              if (!status) {\n                results.failed.push(id);\n                continue;\n              }\n\n              await db\n                .update(quotations)\n                .set({\n                  status,\n                  updatedAt: new Date(),\n                })\n                .where(eq(quotations.id, id));\n\n              // Log activity\n              await quotationActivityService.logStatusChanged(\n                id,\n                quotation.status,\n                status,\n                (req as { user?: { name?: string } }).user?.name\n              ).catch(() => {}); // Non-blocking\n\n              results.success.push(id);\n              break;\n          }\n        } catch (error) {\n          logger.error(`Bulk action ${action} failed for ${id}:`, error);\n          results.failed.push(id);\n        }\n      }\n\n      sendSuccess(res, {\n        action,\n        results,\n        message: `Bulk ${action} completed: ${results.success.length} successful, ${results.failed.length} failed`,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/quotations/:id\n * Get quotation details (Admin only)\n */\nquotationsRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    sendSuccess(res, {\n      ...quotation,\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      items: items.map(item => ({\n        ...item,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations\n * Create a new quotation (Admin only)\n */\nquotationsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createQuotationSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate quotation number\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(quotations);\n      const qCount = countResult[0]?.count ?? 0;\n      const quotationNumber = generateQuotationNumber(Number(qCount) + 1);\n\n      // Calculate valid until date\n      const validUntil = new Date();\n      validUntil.setDate(validUntil.getDate() + (data.validDays || 30));\n\n      // Process items and calculate totals\n      const processedItems: Array<{\n        productId: string | null;\n        variantId?: string | null;\n        name: string;\n        description?: string;\n        sku: string | null;\n        quantity: number;\n        unitPrice: number;\n        isCustomItem: boolean;\n      }> = [];\n\n      let subtotal = 0;\n\n      for (const item of data.items) {\n        // Check if this is a product-based item or a custom item\n        if (item.productId) {\n          // Product-based item\n          const [product] = await db\n            .select()\n            .from(products)\n            .where(eq(products.id, item.productId));\n\n          if (!product) {\n            throw new BadRequestError(`Product not found: ${item.productId}`);\n          }\n\n          let unitPrice = Number(product.basePrice);\n          let sku = product.sku;\n          let variantId: string | null = null;\n\n          if (item.variantId) {\n            const [variant] = await db\n              .select()\n              .from(productVariants)\n              .where(eq(productVariants.id, item.variantId));\n\n            if (variant) {\n              unitPrice = Number(variant.basePrice);\n              sku = variant.sku;\n              variantId = variant.id;\n            }\n          }\n\n          // Use custom price if provided (admin override)\n          if (item.customPrice) {\n            unitPrice = item.customPrice;\n          }\n\n          const lineTotal = unitPrice * item.quantity;\n          subtotal += lineTotal;\n\n          processedItems.push({\n            productId: item.productId,\n            variantId,\n            name: product.name,\n            description: product.description || undefined,\n            sku,\n            quantity: item.quantity,\n            unitPrice,\n            isCustomItem: false,\n          });\n        } else {\n          // Custom item (no productId)\n          const unitPrice = item.unitPrice!; // Already validated by schema\n          const lineTotal = unitPrice * item.quantity;\n          subtotal += lineTotal;\n\n          processedItems.push({\n            productId: null,\n            variantId: null,\n            name: item.name!, // Already validated by schema\n            description: item.description,\n            sku: item.sku || null,\n            quantity: item.quantity,\n            unitPrice,\n            isCustomItem: true,\n          });\n        }\n      }\n\n      // Apply discount\n      let discountAmount = 0;\n      if (data.discountValue && data.discountValue > 0) {\n        if (data.discountType === 'percentage') {\n          discountAmount = (subtotal * data.discountValue) / 100;\n        } else {\n          discountAmount = Math.min(data.discountValue, subtotal);\n        }\n      }\n\n      // Get tax rate from settings (key is 'tax', not 'tax_rate')\n      const [taxSetting] = await db\n        .select()\n        .from(settings)\n        .where(eq(settings.key, 'tax'));\n\n      // Extract tax rate from the JSON structure\n      let taxRate = 0;\n      if (taxSetting && taxSetting.value && typeof taxSetting.value === 'object') {\n        const taxValue = taxSetting.value as { tax_rate?: number; tax_enabled?: boolean };\n        if (taxValue.tax_enabled && typeof taxValue.tax_rate === 'number') {\n          taxRate = taxValue.tax_rate / 100; // Convert percentage to decimal\n        }\n      }\n\n      // Calculate tax on discounted subtotal\n      const taxableAmount = subtotal - discountAmount;\n      const taxAmount = taxableAmount * taxRate;\n\n      // Calculate total\n      const total = taxableAmount + taxAmount;\n\n      // Create quotation\n      const quotationResult = await db\n        .insert(quotations)\n        .values({\n          quotationNumber,\n          customerId: data.customerId,\n          customerName: data.customerName,\n          customerEmail: data.customerEmail.toLowerCase(),\n          customerPhone: data.customerPhone,\n          customerCompany: data.customerCompany,\n          status: 'draft',\n          currency: 'USD',\n          subtotal: String(subtotal),\n          taxRate: String(taxRate),\n          taxAmount: String(taxAmount),\n          discountType: data.discountType,\n          discountValue: data.discountValue ? String(data.discountValue) : null,\n          discountAmount: String(discountAmount),\n          total: String(total),\n          validUntil,\n          validDays: data.validDays || 30,\n          notes: data.notes,\n          termsAndConditions: data.terms,\n        })\n        .returning();\n      const quotation = quotationResult[0];\n\n      if (!quotation) {\n        throw new BadRequestError('Failed to create quotation');\n      }\n\n      // Create quotation items\n      for (const item of processedItems) {\n        await db.insert(quotationItems).values({\n          quotationId: quotation.id,\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: String(item.unitPrice),\n        });\n      }\n\n      // Log activity\n      await quotationActivityService.logCreated(\n        quotation.id,\n        quotation.quotationNumber\n      );\n\n      sendCreated(res, {\n        id: quotation.id,\n        quotationNumber: quotation.quotationNumber,\n        status: quotation.status,\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/quotations/:id\n * Update quotation (Admin only)\n */\nquotationsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateQuotationSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Quotation not found');\n      }\n\n      // Check what's being updated\n      const isStatusOnlyUpdate = Object.keys(data).length === 1 && data.status !== undefined;\n\n      // Only allow editing draft quotations (except for status-only updates)\n      if (existing.status !== 'draft' && !isStatusOnlyUpdate) {\n        throw new BadRequestError('Only draft quotations can be edited. Non-draft quotations can only have their status changed.');\n      }\n\n      // Create revision before making changes\n      await quotationRevisionService.createRevision(\n        id,\n        'Quotation updated',\n        (req as { user?: { id?: string } }).user?.id,\n        (req as { user?: { name?: string } }).user?.name\n      ).catch(() => {}); // Non-blocking\n\n      // Build update data object with proper field mappings\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      // Customer fields\n      if (data.customerName !== undefined) {updateData.customerName = data.customerName;}\n      if (data.customerEmail !== undefined) {updateData.customerEmail = data.customerEmail.toLowerCase();}\n      if (data.customerPhone !== undefined) {updateData.customerPhone = data.customerPhone || null;}\n      if (data.customerCompany !== undefined) {updateData.customerCompany = data.customerCompany || null;}\n\n      // Status\n      if (data.status !== undefined) {updateData.status = data.status;}\n\n      // Notes and terms (map 'terms' to 'termsAndConditions')\n      if (data.notes !== undefined) {updateData.notes = data.notes || null;}\n      if (data.terms !== undefined) {updateData.termsAndConditions = data.terms || null;}\n\n      // Discount and tax fields\n      if (data.discountType !== undefined) {updateData.discountType = data.discountType;}\n      if (data.discountValue !== undefined) {updateData.discountValue = String(data.discountValue);}\n      if (data.taxRate !== undefined) {updateData.taxRate = String(data.taxRate);}\n\n      // Update valid until if validDays provided\n      if (data.validDays !== undefined) {\n        const validUntil = new Date();\n        validUntil.setDate(validUntil.getDate() + data.validDays);\n        updateData.validUntil = validUntil;\n      }\n\n      // Recalculate totals if discount/tax changed or items updated\n      const shouldRecalculate = data.discountType !== undefined ||\n                                 data.discountValue !== undefined ||\n                                 data.taxRate !== undefined ||\n                                 (data.items && data.items.length > 0);\n\n      // Handle items update if provided\n      if (data.items && data.items.length > 0) {\n        // Delete existing items\n        await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n\n        // Process new items and calculate new subtotal\n        let subtotal = 0;\n        const processedItems: Array<{\n          productId: string | null;\n          variantId?: string | null;\n          name: string;\n          description?: string;\n          sku: string | null;\n          quantity: number;\n          unitPrice: number;\n        }> = [];\n\n        for (const item of data.items) {\n          // Check if this is a product-based item or a custom item\n          if (item.productId) {\n            // Product-based item\n            const [product] = await db\n              .select()\n              .from(products)\n              .where(eq(products.id, item.productId));\n\n            if (!product) {\n              throw new BadRequestError(`Product not found: ${item.productId}`);\n            }\n\n            let unitPrice = Number(product.basePrice);\n            let sku = product.sku;\n\n            let variantId: string | null = null;\n            if (item.variantId) {\n              const [variant] = await db\n                .select()\n                .from(productVariants)\n                .where(eq(productVariants.id, item.variantId));\n\n              if (variant) {\n                unitPrice = Number(variant.basePrice);\n                sku = variant.sku;\n                variantId = variant.id;\n              }\n            }\n\n            // Use custom price if provided\n            if (item.customPrice) {\n              unitPrice = item.customPrice;\n            }\n\n            const lineTotal = unitPrice * item.quantity;\n            subtotal += lineTotal;\n\n            processedItems.push({\n              productId: item.productId,\n              variantId,\n              name: product.name,\n              description: product.description || undefined,\n              sku,\n              quantity: item.quantity,\n              unitPrice,\n            });\n          } else {\n            // Custom item (no productId)\n            const unitPrice = item.unitPrice!; // Validated by schema\n            const lineTotal = unitPrice * item.quantity;\n            subtotal += lineTotal;\n\n            processedItems.push({\n              productId: null,\n              variantId: null,\n              name: item.name!, // Validated by schema\n              description: item.description,\n              sku: item.sku || null,\n              quantity: item.quantity,\n              unitPrice,\n            });\n          }\n        }\n\n        // Get discount and tax values (prefer new values, fallback to existing)\n        const discountType = data.discountType ?? existing.discountType ?? 'percentage';\n        const discountValue = data.discountValue ?? Number(existing.discountValue || 0);\n        const taxRate = data.taxRate ?? Number(existing.taxRate || 0);\n\n        // Calculate discount amount based on type\n        let discountAmount = 0;\n        if (discountType === 'percentage') {\n          discountAmount = (subtotal * discountValue) / 100;\n        } else {\n          discountAmount = Math.min(discountValue, subtotal);\n        }\n\n        // Calculate tax and total\n        const taxableAmount = subtotal - discountAmount;\n        const taxAmount = taxableAmount * taxRate;\n        const total = taxableAmount + taxAmount;\n\n        // Update pricing fields\n        updateData.subtotal = String(subtotal);\n        updateData.discountAmount = String(discountAmount);\n        updateData.taxAmount = String(taxAmount);\n        updateData.total = String(total);\n\n        // Insert new items\n        for (const item of processedItems) {\n          await db.insert(quotationItems).values({\n            quotationId: id,\n            productId: item.productId,\n            variantId: item.variantId,\n            name: item.name,\n            description: item.description,\n            sku: item.sku,\n            quantity: item.quantity,\n            unitPrice: String(item.unitPrice),\n          });\n        }\n      } else if (shouldRecalculate) {\n        // Recalculate totals based on existing items when only discount/tax changed\n        const existingItems = await db\n          .select()\n          .from(quotationItems)\n          .where(eq(quotationItems.quotationId, id));\n\n        const subtotal = existingItems.reduce((sum, item) => {\n          return sum + Number(item.unitPrice) * item.quantity;\n        }, 0);\n\n        // Get discount and tax values\n        const discountType = data.discountType ?? existing.discountType ?? 'percentage';\n        const discountValue = data.discountValue ?? Number(existing.discountValue || 0);\n        const taxRate = data.taxRate ?? Number(existing.taxRate || 0);\n\n        // Calculate discount amount based on type\n        let discountAmount = 0;\n        if (discountType === 'percentage') {\n          discountAmount = (subtotal * discountValue) / 100;\n        } else {\n          discountAmount = Math.min(discountValue, subtotal);\n        }\n\n        // Calculate tax and total\n        const taxableAmount = subtotal - discountAmount;\n        const taxAmount = taxableAmount * taxRate;\n        const total = taxableAmount + taxAmount;\n\n        // Update pricing fields\n        updateData.subtotal = String(subtotal);\n        updateData.discountAmount = String(discountAmount);\n        updateData.taxAmount = String(taxAmount);\n        updateData.total = String(total);\n      }\n\n      const quotationResult = await db\n        .update(quotations)\n        .set(updateData)\n        .where(eq(quotations.id, id))\n        .returning();\n      const quotation = quotationResult[0];\n\n      if (!quotation) {\n        throw new NotFoundError('Quotation not found');\n      }\n\n      // Fetch updated items\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, id));\n\n      sendSuccess(res, {\n        ...quotation,\n        subtotal: Number(quotation.subtotal),\n        taxRate: Number(quotation.taxRate || 0),\n        taxAmount: Number(quotation.taxAmount || 0),\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        items: items.map(item => ({\n          ...item,\n          unitPrice: Number(item.unitPrice),\n          lineTotal: Number(item.unitPrice) * item.quantity,\n        })),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/quotations/:id\n * Delete quotation (Admin only)\n */\nquotationsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: quotations.id, status: quotations.status })\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Only allow deletion of draft, rejected, or expired quotations\n    // Sent and accepted quotations should be preserved for business records\n    const deletableStatuses = ['draft', 'rejected', 'expired'];\n    if (!deletableStatuses.includes(existing.status)) {\n      throw new BadRequestError('Only draft, rejected, or expired quotations can be deleted. Sent and accepted quotations must be preserved.');\n    }\n\n    // Delete items first\n    await db.delete(quotationItems).where(eq(quotationItems.quotationId, id));\n\n    // Delete quotation\n    await db.delete(quotations).where(eq(quotations.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/activities\n * Get activity timeline for a quotation (Admin only)\n */\nquotationsRoutes.get('/:id/activities', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n\n    const activities = await quotationActivityService.getActivities(id);\n\n    sendSuccess(res, activities);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions\n * Get revision history for a quotation (Admin only)\n */\nquotationsRoutes.get('/:id/revisions', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisions = await quotationRevisionService.getRevisions(id);\n    sendSuccess(res, revisions);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions/:revisionId\n * Get a specific revision (Admin only)\n */\nquotationsRoutes.get('/:id/revisions/:revisionId', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const revisionId = req.params['revisionId'] as string;\n    const revision = await quotationRevisionService.getRevision(revisionId);\n\n    if (!revision) {\n      throw new NotFoundError('Revision not found');\n    }\n\n    sendSuccess(res, revision);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/revisions/:revisionId/restore\n * Restore a quotation to a previous revision (Admin only)\n */\nquotationsRoutes.post('/:id/revisions/:revisionId/restore', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisionId = req.params['revisionId'] as string;\n\n    const success = await quotationRevisionService.restoreRevision(\n      id,\n      revisionId,\n      (req as { user?: { id?: string } }).user?.id,\n      (req as { user?: { name?: string } }).user?.name\n    );\n\n    if (!success) {\n      throw new NotFoundError('Revision not found or does not belong to this quotation');\n    }\n\n    // Log activity\n    await quotationActivityService.logUpdated(id, '', ['Restored from previous version']).catch(() => {});\n\n    sendSuccess(res, { message: 'Quotation restored from revision successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/revisions/:revisionId/compare\n * Compare a revision with current state or another revision (Admin only)\n * Query param: ?compareWith=<revisionId> to compare with another revision\n */\nquotationsRoutes.get('/:id/revisions/:revisionId/compare', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const id = req.params['id'] as string;\n    const revisionId = req.params['revisionId'] as string;\n    const compareWith = req.query.compareWith as string | undefined;\n\n    const comparison = await quotationRevisionService.compareRevisions(id, revisionId, compareWith);\n\n    if (!comparison) {\n      throw new NotFoundError('Revision not found');\n    }\n\n    sendSuccess(res, comparison);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/:id/pdf\n * Generate and download quotation PDF (Admin only)\n * Optional query param: ?templateId=<uuid> to use specific template\n */\nquotationsRoutes.get('/:id/pdf', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const templateId = req.query.templateId as string | undefined;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    // Get company settings\n    const companySettings = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map<string, string>(companySettings.map(s => [s.key, s.value as string]));\n\n    // Get PDF template (use specified, quotation's template, or default)\n    let template = null;\n\n    if (templateId) {\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, templateId));\n    } else if (quotation.pdfTemplateId) {\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, quotation.pdfTemplateId));\n    } else {\n      // Get default template\n      [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.isDefault, true))\n        .limit(1);\n    }\n\n    // Build template config for PDF service\n    const templateConfig = template ? {\n      primaryColor: template.primaryColor,\n      accentColor: template.accentColor,\n      logoUrl: template.logoUrl || undefined,\n      showCompanyLogo: template.showCompanyLogo,\n      showLineItemImages: template.showLineItemImages,\n      showLineItemDescription: template.showLineItemDescription,\n      showSku: template.showSku,\n      headerText: template.headerText || undefined,\n      footerText: template.footerText || undefined,\n      thankYouMessage: template.thankYouMessage || undefined,\n    } : undefined;\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      createdAt: quotation.createdAt,\n      validUntil: quotation.validUntil!,\n      status: quotation.status,\n\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n\n      items: items.map(item => ({\n        productName: item.name,\n        sku: item.sku || '',\n        description: item.description || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n        variantOptions: undefined,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0, // Not in schema\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || settingsMap.get('quotation_terms') || undefined,\n\n      companyName: settingsMap.get('company_name') || 'Lab404 Electronics',\n      companyAddress: settingsMap.get('company_address') || '',\n      companyPhone: settingsMap.get('company_phone') || '',\n      companyEmail: settingsMap.get('company_email') || '',\n      companyWebsite: settingsMap.get('company_website') || undefined,\n    }, templateConfig);\n\n    // Set response headers\n    res.setHeader('Content-Type', 'application/pdf');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"${quotation.quotationNumber}.pdf\"`\n    );\n    res.setHeader('Content-Length', pdfBuffer.length);\n\n    res.send(pdfBuffer);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/send\n * Send quotation to customer via email (Admin only)\n */\nquotationsRoutes.post('/:id/send', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    if (quotation.status !== 'draft') {\n      throw new BadRequestError('Only draft quotations can be sent');\n    }\n\n    // Get quotation items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    // Get PDF template config if exists\n    let templateConfig = {};\n    if (quotation.pdfTemplateId) {\n      const [template] = await db\n        .select()\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, quotation.pdfTemplateId));\n      if (template) {\n        templateConfig = {\n          primaryColor: template.primaryColor || undefined,\n          accentColor: template.accentColor || undefined,\n          logoUrl: template.logoUrl || undefined,\n          showCompanyLogo: template.showCompanyLogo ?? true,\n          showLineItemImages: template.showLineItemImages ?? false,\n          headerText: template.headerText || undefined,\n          footerText: template.footerText || undefined,\n        };\n      }\n    }\n\n    const companyName = settingsMap.get('company_name') || 'Lab404 Electronics';\n    const companyEmail = settingsMap.get('company_email') || undefined;\n    const companyPhone = settingsMap.get('company_phone') || undefined;\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n      customerAddress: quotation.customerAddress as Record<string, string> | undefined,\n\n      status: quotation.status,\n      validUntil: quotation.validUntil || undefined,\n      createdAt: quotation.createdAt,\n\n      items: items.map(item => ({\n        productName: item.name,\n        description: item.description || undefined,\n        sku: item.sku || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0,\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || settingsMap.get('quotation_terms') || undefined,\n\n      companyName,\n      companyAddress: settingsMap.get('company_address') || '',\n      companyPhone: companyPhone || '',\n      companyEmail: companyEmail || '',\n      companyWebsite: settingsMap.get('company_website') || undefined,\n    }, templateConfig);\n\n    // Send email with PDF attachment\n    const emailSent = await notificationService.sendQuotationToCustomer(\n      {\n        quotationNumber: quotation.quotationNumber,\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n        currency: quotation.currency,\n        itemCount: items.length,\n        companyName,\n        companyEmail,\n        companyPhone,\n      },\n      pdfBuffer\n    );\n\n    if (!emailSent) {\n      logger.warn('Email not sent - SMTP may not be configured', {\n        quotationId: id,\n        customerEmail: quotation.customerEmail,\n      });\n    }\n\n    // Generate acceptance token (valid for 30 days)\n    const acceptanceToken = generateSecureToken(32);\n    const tokenExpiresAt = new Date();\n    tokenExpiresAt.setDate(tokenExpiresAt.getDate() + 30);\n\n    // Calculate validUntil from NOW + quotation's validDays\n    // This ensures the expiry countdown starts when the quotation is sent\n    const validDays = quotation.validDays || 30;\n    const newValidUntil = new Date();\n    newValidUntil.setDate(newValidUntil.getDate() + validDays);\n\n    // Update status to sent, recalculate validUntil, and add acceptance token\n    await db\n      .update(quotations)\n      .set({\n        status: 'sent',\n        validUntil: newValidUntil,\n        acceptanceToken,\n        tokenExpiresAt,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, id));\n\n    // Log activity\n    await quotationActivityService.logSent(id, quotation.customerEmail);\n\n    // Generate acceptance link\n    const baseUrl = process.env['WEB_APP_URL'] || 'http://localhost:3000';\n    const acceptanceLink = `${baseUrl}/quotations/view/${acceptanceToken}`;\n\n    sendSuccess(res, {\n      message: emailSent ? 'Quotation sent successfully' : 'Quotation marked as sent (email not configured)',\n      emailSent,\n      quotationNumber: quotation.quotationNumber,\n      sentTo: quotation.customerEmail,\n      acceptanceLink,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/convert-to-order\n * Convert accepted quotation to order (Admin only)\n */\nquotationsRoutes.post('/:id/convert-to-order', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    if (quotation.status !== 'accepted') {\n      throw new BadRequestError('Only accepted quotations can be converted to orders');\n    }\n\n    if (quotation.convertedToOrderId) {\n      throw new BadRequestError('Quotation has already been converted to an order');\n    }\n\n    // TODO: Implement order creation from quotation\n    // This would involve creating an order with the quotation's items and pricing\n\n    sendSuccess(res, {\n      message: 'Order creation from quotation not yet implemented',\n      quotationId: quotation.id,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/:id/duplicate\n * Duplicate a quotation (Admin only)\n */\nquotationsRoutes.post('/:id/duplicate', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [original] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.id, id));\n\n    if (!original) {\n      throw new NotFoundError('Quotation not found');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, id));\n\n    // Generate new quotation number\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(quotations);\n    const count = countResult[0]?.count ?? 0;\n    const quotationNumber = generateQuotationNumber(Number(count) + 1);\n\n    // Calculate new valid until\n    const validUntil = new Date();\n    validUntil.setDate(validUntil.getDate() + 30);\n\n    // Create new quotation\n    const [newQuotation] = await db\n      .insert(quotations)\n      .values({\n        quotationNumber,\n        customerId: original.customerId,\n        customerName: original.customerName,\n        customerEmail: original.customerEmail,\n        customerPhone: original.customerPhone,\n        customerCompany: original.customerCompany,\n        status: 'draft',\n        currency: original.currency,\n        subtotal: original.subtotal,\n        taxRate: original.taxRate,\n        taxAmount: original.taxAmount,\n        discountAmount: original.discountAmount,\n        total: original.total,\n        validUntil,\n        notes: original.notes,\n        termsAndConditions: original.termsAndConditions,\n      })\n      .returning();\n\n    if (!newQuotation) {\n      throw new BadRequestError('Failed to create quotation');\n    }\n\n    // Copy items\n    for (const item of items) {\n      await db.insert(quotationItems).values({\n        quotationId: newQuotation.id,\n        productId: item.productId,\n        name: item.name,\n        sku: item.sku,\n        description: item.description,\n        quantity: item.quantity,\n        unitPrice: item.unitPrice,\n      });\n    }\n\n    // Log activities for both original and new quotation\n    await quotationActivityService.logDuplicated(\n      original.id,\n      newQuotation.id,\n      newQuotation.quotationNumber\n    );\n    await quotationActivityService.logCreated(\n      newQuotation.id,\n      newQuotation.quotationNumber\n    );\n\n    sendCreated(res, {\n      id: newQuotation.id,\n      quotationNumber: newQuotation.quotationNumber,\n      status: newQuotation.status,\n      total: Number(newQuotation.total),\n      validUntil: newQuotation.validUntil,\n      duplicatedFrom: original.quotationNumber,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Public Routes (No Authentication Required)\n// ===========================================\n\n/**\n * GET /api/quotations/public/:token\n * View quotation by acceptance token (Public - no auth)\n */\nquotationsRoutes.get('/public/:token', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, quotation.id));\n\n    // Update viewedAt if not already viewed\n    if (!quotation.viewedAt) {\n      await db\n        .update(quotations)\n        .set({ viewedAt: new Date() })\n        .where(eq(quotations.id, quotation.id));\n\n      // Log activity\n      await quotationActivityService.logViewed(quotation.id, quotation.customerName);\n    }\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    sendSuccess(res, {\n      id: quotation.id,\n      quotationNumber: quotation.quotationNumber,\n      status: quotation.status,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerCompany: quotation.customerCompany,\n\n      items: items.map(item => ({\n        name: item.name,\n        description: item.description,\n        sku: item.sku,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes,\n      termsAndConditions: quotation.termsAndConditions,\n      validUntil: quotation.validUntil,\n      createdAt: quotation.createdAt,\n\n      company: {\n        name: settingsMap.get('company_name') || 'Lab404 Electronics',\n        email: settingsMap.get('company_email'),\n        phone: settingsMap.get('company_phone'),\n        address: settingsMap.get('company_address'),\n        website: settingsMap.get('company_website'),\n      },\n\n      canAccept: quotation.status === 'sent',\n      canReject: quotation.status === 'sent',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotations/public/:token/accept\n * Accept quotation (Public - no auth)\n */\nquotationsRoutes.post('/public/:token/accept', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    if (quotation.status !== 'sent') {\n      throw new BadRequestError(`Quotation cannot be accepted (current status: ${quotation.status})`);\n    }\n\n    // Update status to accepted\n    await db\n      .update(quotations)\n      .set({\n        status: 'accepted',\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotation.id));\n\n    // Log activity\n    await quotationActivityService.logAccepted(quotation.id, quotation.customerName);\n\n    sendSuccess(res, {\n      message: 'Quotation accepted successfully',\n      quotationNumber: quotation.quotationNumber,\n      status: 'accepted',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\nconst rejectQuotationSchema = z.object({\n  reason: z.string().max(1000).optional(),\n});\n\n/**\n * POST /api/quotations/public/:token/reject\n * Reject quotation (Public - no auth)\n */\nquotationsRoutes.post('/public/:token/reject', validateBody(rejectQuotationSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n    const { reason } = req.body;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    if (quotation.status !== 'sent') {\n      throw new BadRequestError(`Quotation cannot be rejected (current status: ${quotation.status})`);\n    }\n\n    // Update status to rejected\n    await db\n      .update(quotations)\n      .set({\n        status: 'rejected',\n        notes: reason ? `${quotation.notes || ''}\\n\\nRejection reason: ${reason}`.trim() : quotation.notes,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotation.id));\n\n    // Log activity\n    await quotationActivityService.logRejected(quotation.id, reason, quotation.customerName);\n\n    sendSuccess(res, {\n      message: 'Quotation rejected',\n      quotationNumber: quotation.quotationNumber,\n      status: 'rejected',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotations/public/:token/pdf\n * Download quotation PDF (Public - no auth)\n */\nquotationsRoutes.get('/public/:token/pdf', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const token = req.params['token'] as string;\n\n    if (!token || token.length !== 64) {\n      throw new BadRequestError('Invalid token');\n    }\n\n    const [quotation] = await db\n      .select()\n      .from(quotations)\n      .where(eq(quotations.acceptanceToken, token));\n\n    if (!quotation) {\n      throw new NotFoundError('Quotation not found or link has expired');\n    }\n\n    // Check if token has expired\n    if (quotation.tokenExpiresAt && new Date(quotation.tokenExpiresAt) < new Date()) {\n      throw new BadRequestError('This quotation link has expired');\n    }\n\n    // Get items\n    const items = await db\n      .select()\n      .from(quotationItems)\n      .where(eq(quotationItems.quotationId, quotation.id));\n\n    // Get company settings\n    const settingsRows = await db\n      .select()\n      .from(settings)\n      .where(\n        or(\n          eq(settings.key, 'company_name'),\n          eq(settings.key, 'company_email'),\n          eq(settings.key, 'company_phone'),\n          eq(settings.key, 'company_address'),\n          eq(settings.key, 'company_website'),\n          eq(settings.key, 'quotation_terms')\n        )\n      );\n\n    const settingsMap = new Map(settingsRows.map(s => [s.key, s.value]));\n\n    // Generate PDF\n    const pdfBuffer = await pdfService.generateQuotationPDF({\n      quotationNumber: quotation.quotationNumber,\n      customerName: quotation.customerName,\n      customerEmail: quotation.customerEmail,\n      customerPhone: quotation.customerPhone || undefined,\n      customerCompany: quotation.customerCompany || undefined,\n      customerAddress: quotation.customerAddress as Record<string, string> | undefined,\n\n      status: quotation.status,\n      validUntil: quotation.validUntil || undefined,\n      createdAt: quotation.createdAt,\n\n      items: items.map(item => ({\n        productName: item.name,\n        description: item.description || undefined,\n        sku: item.sku || undefined,\n        quantity: item.quantity,\n        unitPrice: Number(item.unitPrice),\n        lineTotal: Number(item.unitPrice) * item.quantity,\n      })),\n\n      subtotal: Number(quotation.subtotal),\n      taxRate: Number(quotation.taxRate || 0),\n      taxAmount: Number(quotation.taxAmount || 0),\n      shippingAmount: 0,\n      discountAmount: Number(quotation.discountAmount),\n      total: Number(quotation.total),\n      currency: quotation.currency,\n\n      notes: quotation.notes || undefined,\n      terms: quotation.termsAndConditions || settingsMap.get('quotation_terms') || undefined,\n\n      companyName: settingsMap.get('company_name') || 'Lab404 Electronics',\n      companyAddress: settingsMap.get('company_address') || '',\n      companyPhone: settingsMap.get('company_phone') || '',\n      companyEmail: settingsMap.get('company_email') || '',\n      companyWebsite: settingsMap.get('company_website') || undefined,\n    });\n\n    res.setHeader('Content-Type', 'application/pdf');\n    res.setHeader('Content-Disposition', `attachment; filename=\"${quotation.quotationNumber}.pdf\"`);\n    res.send(pdfBuffer);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { getDb, quotationActivities, desc, eq } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\ntype ActivityType =\n  | 'created'\n  | 'updated'\n  | 'sent'\n  | 'viewed'\n  | 'accepted'\n  | 'rejected'\n  | 'expired'\n  | 'converted'\n  | 'duplicated'\n  | 'pdf_generated'\n  | 'note_added'\n  | 'status_changed';\n\ntype ActorType = 'system' | 'admin' | 'customer';\n\ninterface LogActivityParams {\n  quotationId: string;\n  activityType: ActivityType;\n  description: string;\n  actorType?: ActorType;\n  actorId?: string;\n  actorName?: string;\n  metadata?: Record<string, unknown>;\n}\n\ninterface Activity {\n  id: string;\n  quotationId: string;\n  activityType: string;\n  description: string;\n  actorType: string;\n  actorId: string | null;\n  actorName: string | null;\n  metadata: Record<string, unknown> | null;\n  createdAt: Date;\n}\n\nclass QuotationActivityService {\n  /**\n   * Log an activity for a quotation\n   */\n  async logActivity(params: LogActivityParams): Promise<void> {\n    try {\n      const db = getDb();\n\n      await db.insert(quotationActivities).values({\n        quotationId: params.quotationId,\n        activityType: params.activityType,\n        description: params.description,\n        actorType: params.actorType || 'system',\n        actorId: params.actorId,\n        actorName: params.actorName,\n        metadata: params.metadata,\n      });\n\n      logger.debug('Activity logged', {\n        quotationId: params.quotationId,\n        activityType: params.activityType,\n      });\n    } catch (error) {\n      // Don't throw - activity logging should not break main flow\n      logger.error('Failed to log activity', { error, params });\n    }\n  }\n\n  /**\n   * Get activities for a quotation\n   */\n  async getActivities(quotationId: string, limit = 50): Promise<Activity[]> {\n    const db = getDb();\n\n    const activities = await db\n      .select()\n      .from(quotationActivities)\n      .where(eq(quotationActivities.quotationId, quotationId))\n      .orderBy(desc(quotationActivities.createdAt))\n      .limit(limit);\n\n    return activities as Activity[];\n  }\n\n  // Helper methods for common activity types\n\n  async logCreated(quotationId: string, quotationNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'created',\n      description: `Quotation ${quotationNumber} was created`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { quotationNumber },\n    });\n  }\n\n  async logUpdated(quotationId: string, quotationNumber: string, changes?: string[], actorName?: string): Promise<void> {\n    const description = changes?.length\n      ? `Quotation updated: ${changes.join(', ')}`\n      : `Quotation ${quotationNumber} was updated`;\n\n    await this.logActivity({\n      quotationId,\n      activityType: 'updated',\n      description,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { changes },\n    });\n  }\n\n  async logSent(quotationId: string, recipientEmail: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'sent',\n      description: `Quotation sent to ${recipientEmail}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { recipientEmail },\n    });\n  }\n\n  async logViewed(quotationId: string, viewerInfo?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'viewed',\n      description: viewerInfo ? `Quotation viewed by ${viewerInfo}` : 'Quotation was viewed',\n      actorType: 'customer',\n      metadata: { viewerInfo },\n    });\n  }\n\n  async logAccepted(quotationId: string, customerName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'accepted',\n      description: customerName\n        ? `Quotation accepted by ${customerName}`\n        : 'Quotation was accepted',\n      actorType: 'customer',\n      actorName: customerName,\n    });\n  }\n\n  async logRejected(quotationId: string, reason?: string, customerName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'rejected',\n      description: reason\n        ? `Quotation rejected: ${reason}`\n        : 'Quotation was rejected',\n      actorType: 'customer',\n      actorName: customerName,\n      metadata: { reason },\n    });\n  }\n\n  async logExpired(quotationId: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'expired',\n      description: 'Quotation has expired',\n      actorType: 'system',\n    });\n  }\n\n  async logConverted(quotationId: string, orderId: string, orderNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'converted',\n      description: `Quotation converted to order ${orderNumber}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { orderId, orderNumber },\n    });\n  }\n\n  async logDuplicated(quotationId: string, newQuotationId: string, newQuotationNumber: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'duplicated',\n      description: `Quotation duplicated as ${newQuotationNumber}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { newQuotationId, newQuotationNumber },\n    });\n  }\n\n  async logPdfGenerated(quotationId: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'pdf_generated',\n      description: 'PDF was generated',\n      actorType: 'system',\n    });\n  }\n\n  async logStatusChanged(quotationId: string, oldStatus: string, newStatus: string, actorName?: string): Promise<void> {\n    await this.logActivity({\n      quotationId,\n      activityType: 'status_changed',\n      description: `Status changed from ${oldStatus} to ${newStatus}`,\n      actorType: actorName ? 'admin' : 'system',\n      actorName,\n      metadata: { oldStatus, newStatus },\n    });\n  }\n}\n\nexport const quotationActivityService = new QuotationActivityService();\n","import { getDb, quotations, quotationItems, quotationRevisions, eq, desc, sql } from '@lab404/database';\nimport { logger } from '../utils/logger';\n\ninterface RevisionSnapshot {\n  customerName: string;\n  customerEmail: string;\n  customerPhone?: string | null;\n  customerCompany?: string | null;\n  status: string;\n  subtotal: number;\n  taxRate?: number;\n  taxAmount?: number;\n  discountType?: string | null;\n  discountValue?: number;\n  discountAmount: number;\n  total: number;\n  validUntil?: Date | null;\n  notes?: string | null;\n  termsAndConditions?: string | null;\n  items: Array<{\n    productId?: string | null;\n    variantId?: string | null;\n    name: string;\n    description?: string | null;\n    sku?: string | null;\n    quantity: number;\n    unitPrice: number;\n  }>;\n}\n\ninterface Revision {\n  id: string;\n  quotationId: string;\n  versionNumber: number;\n  snapshot: RevisionSnapshot;\n  changeDescription: string | null;\n  createdBy: string | null;\n  createdByName: string | null;\n  createdAt: Date;\n}\n\nclass QuotationRevisionService {\n  /**\n   * Create a revision snapshot before updating a quotation\n   */\n  async createRevision(\n    quotationId: string,\n    changeDescription?: string,\n    createdBy?: string,\n    createdByName?: string\n  ): Promise<void> {\n    try {\n      const db = getDb();\n\n      // Get current quotation state\n      const [quotation] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, quotationId));\n\n      if (!quotation) {\n        logger.warn('Cannot create revision: Quotation not found', { quotationId });\n        return;\n      }\n\n      // Get current items\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, quotationId));\n\n      // Get the next version number\n      const [lastRevision] = await db\n        .select({ maxVersion: sql<number>`COALESCE(MAX(${quotationRevisions.versionNumber}), 0)` })\n        .from(quotationRevisions)\n        .where(eq(quotationRevisions.quotationId, quotationId));\n\n      const nextVersion = (lastRevision?.maxVersion || 0) + 1;\n\n      // Create snapshot\n      const snapshot: RevisionSnapshot = {\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        customerPhone: quotation.customerPhone,\n        customerCompany: quotation.customerCompany,\n        status: quotation.status,\n        subtotal: Number(quotation.subtotal),\n        taxRate: quotation.taxRate ? Number(quotation.taxRate) : undefined,\n        taxAmount: quotation.taxAmount ? Number(quotation.taxAmount) : undefined,\n        discountType: quotation.discountType,\n        discountValue: quotation.discountValue ? Number(quotation.discountValue) : undefined,\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n        notes: quotation.notes,\n        termsAndConditions: quotation.termsAndConditions,\n        items: items.map((item) => ({\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPrice),\n        })),\n      };\n\n      // Save revision\n      await db.insert(quotationRevisions).values({\n        quotationId,\n        versionNumber: nextVersion,\n        snapshot,\n        changeDescription,\n        createdBy,\n        createdByName,\n      });\n\n      logger.debug('Revision created', {\n        quotationId,\n        versionNumber: nextVersion,\n      });\n    } catch (error) {\n      // Don't throw - revision creation should not break main flow\n      logger.error('Failed to create revision', { error, quotationId });\n    }\n  }\n\n  /**\n   * Get all revisions for a quotation\n   */\n  async getRevisions(quotationId: string): Promise<Revision[]> {\n    const db = getDb();\n\n    const revisions = await db\n      .select()\n      .from(quotationRevisions)\n      .where(eq(quotationRevisions.quotationId, quotationId))\n      .orderBy(desc(quotationRevisions.versionNumber));\n\n    return revisions as Revision[];\n  }\n\n  /**\n   * Get a specific revision\n   */\n  async getRevision(revisionId: string): Promise<Revision | null> {\n    const db = getDb();\n\n    const [revision] = await db\n      .select()\n      .from(quotationRevisions)\n      .where(eq(quotationRevisions.id, revisionId));\n\n    return (revision as Revision) || null;\n  }\n\n  /**\n   * Compare two revisions or a revision with current state\n   */\n  async compareRevisions(\n    quotationId: string,\n    revisionIdA: string,\n    revisionIdB?: string // If not provided, compare with current state\n  ): Promise<{\n    versionA: number | 'current';\n    versionB: number | 'current';\n    snapshotA: RevisionSnapshot;\n    snapshotB: RevisionSnapshot;\n    changes: Array<{\n      field: string;\n      oldValue: unknown;\n      newValue: unknown;\n    }>;\n  } | null> {\n    const db = getDb();\n\n    // Get revision A\n    const revisionA = await this.getRevision(revisionIdA);\n    if (!revisionA) {return null;}\n\n    let snapshotB: RevisionSnapshot;\n    let versionB: number | 'current';\n\n    if (revisionIdB) {\n      // Compare with another revision\n      const revisionB = await this.getRevision(revisionIdB);\n      if (!revisionB) {return null;}\n      snapshotB = revisionB.snapshot;\n      versionB = revisionB.versionNumber;\n    } else {\n      // Compare with current state\n      const [quotation] = await db\n        .select()\n        .from(quotations)\n        .where(eq(quotations.id, quotationId));\n\n      if (!quotation) {return null;}\n\n      const items = await db\n        .select()\n        .from(quotationItems)\n        .where(eq(quotationItems.quotationId, quotationId));\n\n      snapshotB = {\n        customerName: quotation.customerName,\n        customerEmail: quotation.customerEmail,\n        customerPhone: quotation.customerPhone,\n        customerCompany: quotation.customerCompany,\n        status: quotation.status,\n        subtotal: Number(quotation.subtotal),\n        taxRate: quotation.taxRate ? Number(quotation.taxRate) : undefined,\n        taxAmount: quotation.taxAmount ? Number(quotation.taxAmount) : undefined,\n        discountType: quotation.discountType,\n        discountValue: quotation.discountValue ? Number(quotation.discountValue) : undefined,\n        discountAmount: Number(quotation.discountAmount),\n        total: Number(quotation.total),\n        validUntil: quotation.validUntil,\n        notes: quotation.notes,\n        termsAndConditions: quotation.termsAndConditions,\n        items: items.map((item) => ({\n          productId: item.productId,\n          variantId: item.variantId,\n          name: item.name,\n          description: item.description,\n          sku: item.sku,\n          quantity: item.quantity,\n          unitPrice: Number(item.unitPrice),\n        })),\n      };\n      versionB = 'current';\n    }\n\n    // Compute changes\n    const changes: Array<{ field: string; oldValue: unknown; newValue: unknown }> = [];\n\n    const fieldsToCompare = [\n      'customerName',\n      'customerEmail',\n      'customerPhone',\n      'customerCompany',\n      'status',\n      'subtotal',\n      'taxRate',\n      'taxAmount',\n      'discountType',\n      'discountValue',\n      'discountAmount',\n      'total',\n      'notes',\n      'termsAndConditions',\n    ];\n\n    for (const field of fieldsToCompare) {\n      const oldValue = (revisionA.snapshot as Record<string, unknown>)[field];\n      const newValue = (snapshotB as Record<string, unknown>)[field];\n      if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {\n        changes.push({ field, oldValue, newValue });\n      }\n    }\n\n    // Compare items (simplified - just check if different)\n    if (JSON.stringify(revisionA.snapshot.items) !== JSON.stringify(snapshotB.items)) {\n      changes.push({\n        field: 'items',\n        oldValue: `${revisionA.snapshot.items.length} items`,\n        newValue: `${snapshotB.items.length} items`,\n      });\n    }\n\n    return {\n      versionA: revisionA.versionNumber,\n      versionB,\n      snapshotA: revisionA.snapshot,\n      snapshotB,\n      changes,\n    };\n  }\n\n  /**\n   * Restore a quotation to a previous revision\n   */\n  async restoreRevision(\n    quotationId: string,\n    revisionId: string,\n    restoredBy?: string,\n    restoredByName?: string\n  ): Promise<boolean> {\n    const db = getDb();\n\n    const revision = await this.getRevision(revisionId);\n    if (!revision || revision.quotationId !== quotationId) {\n      return false;\n    }\n\n    // Create a revision of current state before restoring\n    await this.createRevision(\n      quotationId,\n      `Restored from version ${revision.versionNumber}`,\n      restoredBy,\n      restoredByName\n    );\n\n    // Delete current items\n    await db.delete(quotationItems).where(eq(quotationItems.quotationId, quotationId));\n\n    // Restore quotation fields\n    await db\n      .update(quotations)\n      .set({\n        customerName: revision.snapshot.customerName,\n        customerEmail: revision.snapshot.customerEmail,\n        customerPhone: revision.snapshot.customerPhone,\n        customerCompany: revision.snapshot.customerCompany,\n        status: revision.snapshot.status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired',\n        subtotal: String(revision.snapshot.subtotal),\n        taxRate: revision.snapshot.taxRate ? String(revision.snapshot.taxRate) : null,\n        taxAmount: revision.snapshot.taxAmount ? String(revision.snapshot.taxAmount) : null,\n        discountType: revision.snapshot.discountType,\n        discountValue: revision.snapshot.discountValue ? String(revision.snapshot.discountValue) : null,\n        discountAmount: String(revision.snapshot.discountAmount),\n        total: String(revision.snapshot.total),\n        notes: revision.snapshot.notes,\n        termsAndConditions: revision.snapshot.termsAndConditions,\n        updatedAt: new Date(),\n      })\n      .where(eq(quotations.id, quotationId));\n\n    // Restore items\n    for (const item of revision.snapshot.items) {\n      await db.insert(quotationItems).values({\n        quotationId,\n        productId: item.productId,\n        variantId: item.variantId,\n        name: item.name,\n        description: item.description,\n        sku: item.sku,\n        quantity: item.quantity,\n        unitPrice: String(item.unitPrice),\n      });\n    }\n\n    logger.info('Quotation restored from revision', {\n      quotationId,\n      revisionId,\n      versionNumber: revision.versionNumber,\n    });\n\n    return true;\n  }\n}\n\nexport const quotationRevisionService = new QuotationRevisionService();\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, quotationTemplates, eq, desc } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\n\nexport const quotationTemplatesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst templateItemSchema = z.object({\n  productId: z.string().uuid().optional(),\n  name: z.string().min(1).max(200),\n  description: z.string().max(1000).optional(),\n  sku: z.string().max(100).optional(),\n  quantity: z.number().int().min(1),\n  unitPrice: z.number().min(0),\n});\n\nconst createTemplateSchema = z.object({\n  name: z.string().min(1).max(255),\n  description: z.string().max(2000).optional(),\n  items: z.array(templateItemSchema).min(1),\n  defaultDiscount: z.number().min(0).optional(),\n  defaultDiscountType: z.enum(['percentage', 'fixed']).optional(),\n  defaultTaxRate: z.number().min(0).max(1).optional(),\n  defaultValidDays: z.number().int().min(1).max(365).optional(),\n  defaultTerms: z.string().max(5000).optional(),\n});\n\nconst updateTemplateSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  description: z.string().max(2000).optional().nullable(),\n  items: z.array(templateItemSchema).min(1).optional(),\n  defaultDiscount: z.number().min(0).optional().nullable(),\n  defaultDiscountType: z.enum(['percentage', 'fixed']).optional().nullable(),\n  defaultTaxRate: z.number().min(0).max(1).optional().nullable(),\n  defaultValidDays: z.number().int().min(1).max(365).optional(),\n  defaultTerms: z.string().max(5000).optional().nullable(),\n  isActive: z.boolean().optional(),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/quotation-templates\n * List all quotation templates (Admin only)\n */\nquotationTemplatesRoutes.get('/', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const activeOnly = req.query.activeOnly !== 'false';\n\n    let query = db.select().from(quotationTemplates);\n\n    if (activeOnly) {\n      query = query.where(eq(quotationTemplates.isActive, 1));\n    }\n\n    const templates = await query.orderBy(desc(quotationTemplates.createdAt));\n\n    sendSuccess(res, templates.map(t => ({\n      ...t,\n      defaultDiscount: t.defaultDiscount ? Number(t.defaultDiscount) : null,\n      defaultTaxRate: t.defaultTaxRate ? Number(t.defaultTaxRate) : null,\n      isActive: Boolean(t.isActive),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/quotation-templates/:id\n * Get template details (Admin only)\n */\nquotationTemplatesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [template] = await db\n      .select()\n      .from(quotationTemplates)\n      .where(eq(quotationTemplates.id, id));\n\n    if (!template) {\n      throw new NotFoundError('Template not found');\n    }\n\n    sendSuccess(res, {\n      ...template,\n      defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n      defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n      isActive: Boolean(template.isActive),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/quotation-templates\n * Create a new template (Admin only)\n */\nquotationTemplatesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      const [template] = await db\n        .insert(quotationTemplates)\n        .values({\n          name: data.name,\n          description: data.description,\n          items: data.items,\n          defaultDiscount: data.defaultDiscount ? String(data.defaultDiscount) : null,\n          defaultDiscountType: data.defaultDiscountType,\n          defaultTaxRate: data.defaultTaxRate ? String(data.defaultTaxRate) : null,\n          defaultValidDays: data.defaultValidDays,\n          defaultTerms: data.defaultTerms,\n        })\n        .returning();\n\n      sendCreated(res, {\n        ...template,\n        defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n        defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n        isActive: Boolean(template.isActive),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/quotation-templates/:id\n * Update a template (Admin only)\n */\nquotationTemplatesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(quotationTemplates)\n        .where(eq(quotationTemplates.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Template not found');\n      }\n\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      if (data.name !== undefined) {updateData.name = data.name;}\n      if (data.description !== undefined) {updateData.description = data.description;}\n      if (data.items !== undefined) {updateData.items = data.items;}\n      if (data.defaultDiscount !== undefined) {\n        updateData.defaultDiscount = data.defaultDiscount !== null ? String(data.defaultDiscount) : null;\n      }\n      if (data.defaultDiscountType !== undefined) {updateData.defaultDiscountType = data.defaultDiscountType;}\n      if (data.defaultTaxRate !== undefined) {\n        updateData.defaultTaxRate = data.defaultTaxRate !== null ? String(data.defaultTaxRate) : null;\n      }\n      if (data.defaultValidDays !== undefined) {updateData.defaultValidDays = data.defaultValidDays;}\n      if (data.defaultTerms !== undefined) {updateData.defaultTerms = data.defaultTerms;}\n      if (data.isActive !== undefined) {updateData.isActive = data.isActive ? 1 : 0;}\n\n      const [template] = await db\n        .update(quotationTemplates)\n        .set(updateData)\n        .where(eq(quotationTemplates.id, id))\n        .returning();\n\n      sendSuccess(res, {\n        ...template,\n        defaultDiscount: template.defaultDiscount ? Number(template.defaultDiscount) : null,\n        defaultTaxRate: template.defaultTaxRate ? Number(template.defaultTaxRate) : null,\n        isActive: Boolean(template.isActive),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/quotation-templates/:id\n * Delete a template (Admin only)\n */\nquotationTemplatesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(quotationTemplates)\n      .where(eq(quotationTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Template not found');\n    }\n\n    await db.delete(quotationTemplates).where(eq(quotationTemplates.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, blogs, eq, sql, desc, and, or, like, gte, lte } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, ConflictError } from '../utils/errors';\nimport { generateSlug } from '../utils/helpers';\nimport { sanitizeRichContent } from '../middleware/xss';\n\nexport const blogsRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createBlogSchema = z.object({\n  title: z.string().min(1).max(255),\n  slug: z.string().max(255).optional(),\n  excerpt: z.string().max(500).optional(),\n  content: z.string().min(1),\n  featuredImageUrl: z.string().url().optional(),\n  tags: z.array(z.string()).optional(),\n  status: z.enum(['draft', 'published']).optional().default('draft'),\n  publishedAt: z.string().datetime().optional(),\n  metaTitle: z.string().max(100).optional(),\n  metaDescription: z.string().max(200).optional(),\n});\n\nconst updateBlogSchema = createBlogSchema.partial();\n\nconst blogFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  search: z.string().optional(),\n  status: z.enum(['draft', 'published']).optional(),\n  tag: z.string().optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/blogs\n * List published blog posts (Public)\n */\nblogsRoutes.get('/', validateQuery(blogFiltersSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const { search, tag } = req.query;\n    const isAdmin = req.user?.role === 'admin';\n\n    const conditions = [];\n\n    // Non-admins only see published posts\n    if (!isAdmin) {\n      conditions.push(eq(blogs.status, 'published'));\n      conditions.push(lte(blogs.publishedAt, new Date()));\n    }\n\n    if (search) {\n      conditions.push(\n        or(\n          like(blogs.title, `%${search}%`),\n          like(blogs.excerpt, `%${search}%`)\n        )\n      );\n    }\n\n    if (tag) {\n      conditions.push(sql`${tag} = ANY(${blogs.tags})`);\n    }\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(blogs)\n      .where(whereClause);\n    const count = countResult[0]?.count ?? 0;\n\n    const blogList = await db\n      .select({\n        id: blogs.id,\n        title: blogs.title,\n        slug: blogs.slug,\n        excerpt: blogs.excerpt,\n        featuredImageUrl: blogs.featuredImageUrl,\n        tags: blogs.tags,\n        status: blogs.status,\n        publishedAt: blogs.publishedAt,\n        createdAt: blogs.createdAt,\n      })\n      .from(blogs)\n      .where(whereClause)\n      .orderBy(desc(blogs.publishedAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, blogList, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/tags\n * Get all unique tags (Public)\n */\nblogsRoutes.get('/tags', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Get all unique tags from published posts\n    const result = await db\n      .select({ tags: blogs.tags })\n      .from(blogs)\n      .where(eq(blogs.status, 'published'));\n\n    // Flatten and get unique tags\n    const allTags = result\n      .flatMap(r => r.tags || [])\n      .filter((tag, index, self) => self.indexOf(tag) === index)\n      .sort();\n\n    sendSuccess(res, allTags);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/:slug\n * Get blog post by slug (Public)\n */\nblogsRoutes.get('/:slug', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { slug } = req.params;\n    const isAdmin = req.user?.role === 'admin';\n\n    const [blog] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.slug, slug));\n\n    if (!blog) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Non-admins can only view published posts\n    if (!isAdmin && blog.status !== 'published') {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Note: viewCount tracking removed - not in current schema\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/blogs/:slug/related\n * Get related blog posts (Public)\n */\nblogsRoutes.get('/:slug/related', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { slug } = req.params;\n    const limitParam = parseInt(req.query['limit'] as string) || 3;\n\n    // Get current blog\n    const [currentBlog] = await db\n      .select({ id: blogs.id, tags: blogs.tags })\n      .from(blogs)\n      .where(eq(blogs.slug, slug));\n\n    if (!currentBlog) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Find related posts by tags\n    let relatedPosts: Array<{\n      id: string;\n      title: string;\n      slug: string;\n      excerpt: string | null;\n      featuredImageUrl: string | null;\n      publishedAt: Date | null;\n    }> = [];\n\n    if (currentBlog.tags && currentBlog.tags.length > 0) {\n      // Get posts with matching tags\n      relatedPosts = await db\n        .select({\n          id: blogs.id,\n          title: blogs.title,\n          slug: blogs.slug,\n          excerpt: blogs.excerpt,\n          featuredImageUrl: blogs.featuredImageUrl,\n          publishedAt: blogs.publishedAt,\n        })\n        .from(blogs)\n        .where(\n          and(\n            eq(blogs.status, 'published'),\n            sql`${blogs.id} != ${currentBlog.id}`,\n            sql`${blogs.tags} && ${currentBlog.tags}` // Array overlap\n          )\n        )\n        .orderBy(desc(blogs.publishedAt))\n        .limit(limitParam);\n    }\n\n    // If not enough related posts, get recent posts\n    if (relatedPosts.length < limitParam) {\n      const existing = relatedPosts.map(p => p.id);\n      const needed = limitParam - relatedPosts.length;\n\n      const recentPosts = await db\n        .select({\n          id: blogs.id,\n          title: blogs.title,\n          slug: blogs.slug,\n          excerpt: blogs.excerpt,\n          featuredImageUrl: blogs.featuredImageUrl,\n          publishedAt: blogs.publishedAt,\n        })\n        .from(blogs)\n        .where(\n          and(\n            eq(blogs.status, 'published'),\n            sql`${blogs.id} != ${currentBlog.id}`,\n            existing.length > 0 ? sql`${blogs.id} != ALL(${existing})` : sql`true`\n          )\n        )\n        .orderBy(desc(blogs.publishedAt))\n        .limit(needed);\n\n      relatedPosts = [...relatedPosts, ...recentPosts];\n    }\n\n    sendSuccess(res, relatedPosts);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/blogs/admin/all\n * List all blog posts including drafts (Admin only)\n */\nblogsRoutes.get(\n  '/admin/all',\n  requireAuth,\n  requireAdmin,\n  validateQuery(blogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { search, status, tag } = req.query;\n\n      const conditions = [];\n\n      if (search) {\n        conditions.push(\n          or(\n            like(blogs.title, `%${search}%`),\n            like(blogs.excerpt, `%${search}%`)\n          )\n        );\n      }\n\n      if (status) {\n        conditions.push(eq(blogs.status, status as 'draft' | 'published' | 'archived'));\n      }\n\n      if (tag) {\n        conditions.push(sql`${tag} = ANY(${blogs.tags})`);\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(blogs)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const blogList = await db\n        .select()\n        .from(blogs)\n        .where(whereClause)\n        .orderBy(desc(blogs.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, blogList, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/blogs/admin/:id\n * Get blog post by ID (Admin only)\n */\nblogsRoutes.get(\n  '/admin/:id',\n  requireAuth,\n  requireAdmin,\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n\n      const [blog] = await db\n        .select()\n        .from(blogs)\n        .where(eq(blogs.id, id));\n\n      if (!blog) {\n        throw new NotFoundError('Blog post not found');\n      }\n\n      sendSuccess(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/blogs\n * Create a new blog post (Admin only)\n */\nblogsRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createBlogSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // Generate slug if not provided\n      let slug = data.slug || generateSlug(data.title);\n\n      // Check if slug exists\n      const [existingSlug] = await db\n        .select({ id: blogs.id })\n        .from(blogs)\n        .where(eq(blogs.slug, slug));\n\n      if (existingSlug) {\n        slug = `${slug}-${Date.now()}`;\n      }\n\n      // Set publishedAt if publishing\n      let publishedAt = data.publishedAt ? new Date(data.publishedAt) : undefined;\n      if (data.status === 'published' && !publishedAt) {\n        publishedAt = new Date();\n      }\n\n      // Generate excerpt if not provided\n      let excerpt = data.excerpt;\n      if (!excerpt && data.content) {\n        // Strip HTML and truncate\n        const plainText = data.content.replace(/<[^>]*>/g, '');\n        excerpt = plainText.substring(0, 200) + (plainText.length > 200 ? '...' : '');\n      }\n\n      // Sanitize rich content (allow safe HTML for blog content)\n      const sanitizedContent = sanitizeRichContent(data.content);\n\n      // Only set authorId if it's a valid UUID\n      const isValidUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(req.user?.id || '');\n\n      const [blog] = await db\n        .insert(blogs)\n        .values({\n          title: data.title,\n          slug,\n          excerpt,\n          content: sanitizedContent,\n          featuredImageUrl: data.featuredImageUrl,\n          tags: data.tags || [],\n          status: data.status || 'draft',\n          publishedAt,\n          metaTitle: data.metaTitle || data.title,\n          metaDescription: data.metaDescription || excerpt,\n          authorId: isValidUuid ? req.user?.id : undefined,\n          authorName: req.user?.email?.split('@')[0] || 'Admin',\n        })\n        .returning();\n\n      sendCreated(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/blogs/:id\n * Update a blog post (Admin only)\n */\nblogsRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateBlogSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(blogs)\n        .where(eq(blogs.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Blog post not found');\n      }\n\n      // Sanitize content if provided (allow safe HTML for blog content)\n      const updateData: Record<string, unknown> = {\n        ...data,\n        updatedAt: new Date(),\n      };\n\n      if (data.content) {\n        updateData.content = sanitizeRichContent(data.content);\n      }\n\n      // Handle slug update\n      if (data.slug && data.slug !== existing.slug) {\n        const [existingSlug] = await db\n          .select({ id: blogs.id })\n          .from(blogs)\n          .where(and(eq(blogs.slug, data.slug), sql`${blogs.id} != ${id}`));\n\n        if (existingSlug) {\n          throw new ConflictError('Slug already exists');\n        }\n      }\n\n      // Handle publishedAt\n      if (data['publishedAt']) {\n        updateData['publishedAt'] = new Date(data['publishedAt']);\n      } else if (data.status === 'published' && !existing.publishedAt) {\n        updateData['publishedAt'] = new Date();\n      }\n\n      const [blog] = await db\n        .update(blogs)\n        .set(updateData)\n        .where(eq(blogs.id, id))\n        .returning();\n\n      sendSuccess(res, blog);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/blogs/:id\n * Delete a blog post (Admin only)\n */\nblogsRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: blogs.id })\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    await db.delete(blogs).where(eq(blogs.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/publish\n * Publish a blog post (Admin only)\n */\nblogsRoutes.post('/:id/publish', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    const [blog] = await db\n      .update(blogs)\n      .set({\n        status: 'published',\n        publishedAt: existing.publishedAt || new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(blogs.id, id))\n      .returning();\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/unpublish\n * Unpublish a blog post (Admin only)\n */\nblogsRoutes.post('/:id/unpublish', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [existing] = await db\n      .select({ id: blogs.id })\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    const [blog] = await db\n      .update(blogs)\n      .set({\n        status: 'draft',\n        updatedAt: new Date(),\n      })\n      .where(eq(blogs.id, id))\n      .returning();\n\n    sendSuccess(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/blogs/:id/duplicate\n * Duplicate a blog post (Admin only)\n */\nblogsRoutes.post('/:id/duplicate', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [original] = await db\n      .select()\n      .from(blogs)\n      .where(eq(blogs.id, id));\n\n    if (!original) {\n      throw new NotFoundError('Blog post not found');\n    }\n\n    // Generate new slug\n    const slug = `${original.slug}-copy-${Date.now()}`;\n\n    const [blog] = await db\n      .insert(blogs)\n      .values({\n        title: `${original.title} (Copy)`,\n        slug,\n        excerpt: original.excerpt,\n        content: original.content,\n        featuredImageUrl: original.featuredImageUrl,\n        tags: original.tags,\n        status: 'draft',\n        metaTitle: original.metaTitle,\n        metaDescription: original.metaDescription,\n        authorId: req.user?.id,\n      })\n      .returning();\n\n    sendCreated(res, blog);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, settings, adminActivityLogs, eq, desc, and, gte, inArray, sql } from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\n\nexport const settingsRoutes = Router();\n\n// ===========================================\n// Types for grouped settings in database\n// ===========================================\n\ninterface BusinessSettings {\n  business_name: string;\n  business_email: string;\n  business_phone: string;\n  business_address: string;\n  currency: string;\n  currency_symbol: string;\n}\n\ninterface TaxSettings {\n  tax_rate: number;\n  tax_label: string;\n  tax_enabled: boolean;\n}\n\ninterface DeliverySettings {\n  delivery_fee: number;\n  delivery_enabled: boolean;\n  free_delivery_threshold: number;\n  delivery_time_min: number;\n  delivery_time_max: number;\n}\n\ninterface NotificationSettings {\n  email_notifications: boolean;\n  sound_notifications: boolean;\n  low_stock_notifications: boolean;\n  new_order_notifications: boolean;\n}\n\ninterface SystemSettings {\n  site_title: string;\n  site_description: string;\n  maintenance_mode: boolean;\n  allow_guest_checkout: boolean;\n  max_cart_items: number;\n}\n\n// Default values for grouped settings\n// These defaults are returned when settings don't exist in the database yet.\n// Admins can update these values via PUT /api/settings endpoint.\nconst DEFAULT_BUSINESS: BusinessSettings = {\n  business_name: 'Lab404 Electronics',\n  business_email: 'info@lab404.com',\n  business_phone: '',\n  business_address: '',\n  currency: 'USD',\n  currency_symbol: '$',\n};\n\n// Tax is DISABLED by default with 0% rate for safety.\n// Admins must explicitly enable tax and set the rate via settings.\n// This prevents unexpected charges to customers.\nconst DEFAULT_TAX: TaxSettings = {\n  tax_rate: 0,\n  tax_label: 'VAT',\n  tax_enabled: false,\n};\n\nconst DEFAULT_DELIVERY: DeliverySettings = {\n  delivery_fee: 0,\n  delivery_enabled: false,\n  free_delivery_threshold: 0,\n  delivery_time_min: 7,\n  delivery_time_max: 14,\n};\n\nconst DEFAULT_NOTIFICATIONS: NotificationSettings = {\n  email_notifications: true,\n  sound_notifications: true,\n  low_stock_notifications: true,\n  new_order_notifications: true,\n};\n\nconst DEFAULT_SYSTEM: SystemSettings = {\n  site_title: 'Lab404 Electronics',\n  site_description: 'Your trusted electronics store',\n  maintenance_mode: false,\n  allow_guest_checkout: true,\n  max_cart_items: 99,\n};\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst activityLogFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  adminId: z.string().uuid().optional(),\n  action: z.string().optional(),\n  entityType: z.string().optional(),\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n});\n\n// Schema for updating all admin settings at once\nconst updateAdminSettingsSchema = z.object({\n  // Business/Store Info\n  business_name: z.string().min(1).optional(),\n  business_email: z.string().email().optional(),\n  business_phone: z.string().optional(),\n  business_address: z.string().optional(),\n  currency: z.string().optional(),\n  currency_symbol: z.string().optional(),\n  // Tax\n  tax_rate: z.number().min(0).max(100).optional(),\n  tax_label: z.string().optional(),\n  tax_enabled: z.boolean().optional(),\n  // Delivery/Shipping\n  delivery_fee: z.number().min(0).optional(),\n  delivery_enabled: z.boolean().optional(),\n  free_delivery_threshold: z.number().min(0).optional(),\n  // System\n  site_title: z.string().optional(),\n  site_description: z.string().optional(),\n  low_stock_threshold: z.number().min(0).optional(),\n  // Notifications\n  email_notifications: z.boolean().optional(),\n  low_stock_notifications: z.boolean().optional(),\n  new_order_notifications: z.boolean().optional(),\n});\n\n// ===========================================\n// Helper Functions\n// ===========================================\n\nasync function getGroupedSetting<T>(db: ReturnType<typeof getDb>, key: string, defaultValue: T): Promise<T> {\n  const [result] = await db\n    .select()\n    .from(settings)\n    .where(eq(settings.key, key));\n\n  if (result && result.value) {\n    return { ...defaultValue, ...(result.value as T) };\n  }\n  return defaultValue;\n}\n\nasync function updateGroupedSetting<T extends object>(\n  db: ReturnType<typeof getDb>,\n  key: string,\n  updates: Partial<T>,\n  description: string\n): Promise<T> {\n  // Get current value\n  const [existing] = await db\n    .select()\n    .from(settings)\n    .where(eq(settings.key, key));\n\n  let currentValue: T;\n  if (existing && existing.value) {\n    currentValue = existing.value as T;\n  } else {\n    // Get default based on key\n    switch (key) {\n      case 'business': currentValue = DEFAULT_BUSINESS as T; break;\n      case 'tax': currentValue = DEFAULT_TAX as T; break;\n      case 'delivery': currentValue = DEFAULT_DELIVERY as T; break;\n      case 'notifications': currentValue = DEFAULT_NOTIFICATIONS as T; break;\n      case 'system': currentValue = DEFAULT_SYSTEM as T; break;\n      default: currentValue = {} as T;\n    }\n  }\n\n  // Merge updates\n  const newValue = { ...currentValue, ...updates };\n\n  if (existing) {\n    await db\n      .update(settings)\n      .set({ value: newValue, updatedAt: new Date() })\n      .where(eq(settings.key, key));\n  } else {\n    await db.insert(settings).values({\n      key,\n      value: newValue,\n      description,\n    });\n  }\n\n  return newValue;\n}\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/settings/public\n * Get public settings (non-sensitive) - reads from grouped settings\n */\nsettingsRoutes.get('/public', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Fetch grouped settings\n    const [businessRow, taxRow, deliveryRow, systemRow] = await Promise.all([\n      db.select().from(settings).where(eq(settings.key, 'business')),\n      db.select().from(settings).where(eq(settings.key, 'tax')),\n      db.select().from(settings).where(eq(settings.key, 'delivery')),\n      db.select().from(settings).where(eq(settings.key, 'system')),\n    ]);\n\n    const business = businessRow[0]?.value as BusinessSettings || DEFAULT_BUSINESS;\n    const tax = taxRow[0]?.value as TaxSettings || DEFAULT_TAX;\n    const delivery = deliveryRow[0]?.value as DeliverySettings || DEFAULT_DELIVERY;\n    const system = systemRow[0]?.value as SystemSettings || DEFAULT_SYSTEM;\n\n    // Return flattened public settings\n    sendSuccess(res, {\n      // Business\n      company_name: business.business_name,\n      company_email: business.business_email,\n      company_phone: business.business_phone,\n      company_address: business.business_address,\n      currency: business.currency,\n      currency_symbol: business.currency_symbol,\n      // Tax\n      tax_rate: tax.tax_rate,\n      tax_label: tax.tax_label,\n      tax_enabled: tax.tax_enabled,\n      // Delivery\n      delivery_fee: delivery.delivery_fee,\n      delivery_enabled: delivery.delivery_enabled,\n      free_delivery_threshold: delivery.free_delivery_threshold,\n      // System\n      site_title: system.site_title,\n      site_description: system.site_description,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/settings\n * Get all settings for admin panel - returns flat structure for easy form binding\n */\nsettingsRoutes.get('/', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // Fetch all grouped settings\n    const [businessRow, taxRow, deliveryRow, notificationsRow, systemRow] = await Promise.all([\n      db.select().from(settings).where(eq(settings.key, 'business')),\n      db.select().from(settings).where(eq(settings.key, 'tax')),\n      db.select().from(settings).where(eq(settings.key, 'delivery')),\n      db.select().from(settings).where(eq(settings.key, 'notifications')),\n      db.select().from(settings).where(eq(settings.key, 'system')),\n    ]);\n\n    const business = { ...DEFAULT_BUSINESS, ...(businessRow[0]?.value as BusinessSettings || {}) };\n    const tax = { ...DEFAULT_TAX, ...(taxRow[0]?.value as TaxSettings || {}) };\n    const delivery = { ...DEFAULT_DELIVERY, ...(deliveryRow[0]?.value as DeliverySettings || {}) };\n    const notifications = { ...DEFAULT_NOTIFICATIONS, ...(notificationsRow[0]?.value as NotificationSettings || {}) };\n    const system = { ...DEFAULT_SYSTEM, ...(systemRow[0]?.value as SystemSettings || {}) };\n\n    // Return flat structure for admin form\n    sendSuccess(res, {\n      // Store/Business Information\n      business_name: business.business_name,\n      business_email: business.business_email,\n      business_phone: business.business_phone,\n      business_address: business.business_address,\n\n      // Currency\n      currency: business.currency,\n      currency_symbol: business.currency_symbol,\n\n      // Tax\n      tax_rate: tax.tax_rate,\n      tax_label: tax.tax_label,\n      tax_enabled: tax.tax_enabled,\n\n      // Delivery/Shipping\n      delivery_fee: delivery.delivery_fee,\n      delivery_enabled: delivery.delivery_enabled,\n      free_delivery_threshold: delivery.free_delivery_threshold,\n      delivery_time_min: delivery.delivery_time_min,\n      delivery_time_max: delivery.delivery_time_max,\n\n      // Notifications\n      email_notifications: notifications.email_notifications,\n      sound_notifications: notifications.sound_notifications,\n      low_stock_notifications: notifications.low_stock_notifications,\n      new_order_notifications: notifications.new_order_notifications,\n\n      // System\n      site_title: system.site_title,\n      site_description: system.site_description,\n      maintenance_mode: system.maintenance_mode,\n      allow_guest_checkout: system.allow_guest_checkout,\n      max_cart_items: system.max_cart_items,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * PUT /api/settings\n * Update settings - accepts flat structure and updates grouped settings\n */\nsettingsRoutes.put(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateAdminSettingsSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const updates = req.body;\n      const updatedGroups: string[] = [];\n\n      // Group updates by category\n      const businessUpdates: Partial<BusinessSettings> = {};\n      const taxUpdates: Partial<TaxSettings> = {};\n      const deliveryUpdates: Partial<DeliverySettings> = {};\n      const notificationUpdates: Partial<NotificationSettings> = {};\n      const systemUpdates: Partial<SystemSettings> = {};\n\n      // Map flat fields to groups\n      if (updates.business_name !== undefined) {businessUpdates.business_name = updates.business_name;}\n      if (updates.business_email !== undefined) {businessUpdates.business_email = updates.business_email;}\n      if (updates.business_phone !== undefined) {businessUpdates.business_phone = updates.business_phone;}\n      if (updates.business_address !== undefined) {businessUpdates.business_address = updates.business_address;}\n      if (updates.currency !== undefined) {businessUpdates.currency = updates.currency;}\n      if (updates.currency_symbol !== undefined) {businessUpdates.currency_symbol = updates.currency_symbol;}\n\n      if (updates.tax_rate !== undefined) {taxUpdates.tax_rate = updates.tax_rate;}\n      if (updates.tax_label !== undefined) {taxUpdates.tax_label = updates.tax_label;}\n      if (updates.tax_enabled !== undefined) {taxUpdates.tax_enabled = updates.tax_enabled;}\n\n      if (updates.delivery_fee !== undefined) {deliveryUpdates.delivery_fee = updates.delivery_fee;}\n      if (updates.delivery_enabled !== undefined) {deliveryUpdates.delivery_enabled = updates.delivery_enabled;}\n      if (updates.free_delivery_threshold !== undefined) {deliveryUpdates.free_delivery_threshold = updates.free_delivery_threshold;}\n\n      if (updates.email_notifications !== undefined) {notificationUpdates.email_notifications = updates.email_notifications;}\n      if (updates.low_stock_notifications !== undefined) {notificationUpdates.low_stock_notifications = updates.low_stock_notifications;}\n      if (updates.new_order_notifications !== undefined) {notificationUpdates.new_order_notifications = updates.new_order_notifications;}\n\n      if (updates.site_title !== undefined) {systemUpdates.site_title = updates.site_title;}\n      if (updates.site_description !== undefined) {systemUpdates.site_description = updates.site_description;}\n\n      // Update each group if there are changes\n      if (Object.keys(businessUpdates).length > 0) {\n        await updateGroupedSetting(db, 'business', businessUpdates, 'Business settings');\n        updatedGroups.push('business');\n      }\n\n      if (Object.keys(taxUpdates).length > 0) {\n        await updateGroupedSetting(db, 'tax', taxUpdates, 'Tax settings');\n        updatedGroups.push('tax');\n      }\n\n      if (Object.keys(deliveryUpdates).length > 0) {\n        await updateGroupedSetting(db, 'delivery', deliveryUpdates, 'Delivery settings');\n        updatedGroups.push('delivery');\n      }\n\n      if (Object.keys(notificationUpdates).length > 0) {\n        await updateGroupedSetting(db, 'notifications', notificationUpdates, 'Notification settings');\n        updatedGroups.push('notifications');\n      }\n\n      if (Object.keys(systemUpdates).length > 0) {\n        await updateGroupedSetting(db, 'system', systemUpdates, 'System settings');\n        updatedGroups.push('system');\n      }\n\n      // Log activity\n      if (updatedGroups.length > 0) {\n        await db.insert(adminActivityLogs).values({\n          adminUserId: req.user!.id,\n          action: 'update',\n          entityType: 'settings',\n          details: { updatedGroups, updatedFields: Object.keys(updates) },\n        });\n      }\n\n      sendSuccess(res, {\n        message: 'Settings updated successfully',\n        updatedGroups,\n        updatedFields: Object.keys(updates),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/settings/:key\n * Get a specific grouped setting (Admin only)\n */\nsettingsRoutes.get('/:key', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const key = req.params['key'] as string;\n\n    const [setting] = await db\n      .select()\n      .from(settings)\n      .where(eq(settings.key, key));\n\n    if (!setting) {\n      // Return default if it's a known group\n      const defaults: Record<string, unknown> = {\n        business: DEFAULT_BUSINESS,\n        tax: DEFAULT_TAX,\n        delivery: DEFAULT_DELIVERY,\n        notifications: DEFAULT_NOTIFICATIONS,\n        system: DEFAULT_SYSTEM,\n      };\n\n      if (defaults[key]) {\n        return sendSuccess(res, {\n          key,\n          value: defaults[key],\n          isDefault: true,\n        });\n      }\n      throw new NotFoundError('Setting not found');\n    }\n\n    sendSuccess(res, setting);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/settings/reset\n * Reset settings to defaults (Admin only)\n */\nsettingsRoutes.post('/reset', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { groups } = req.body as { groups?: string[] };\n\n    const validGroups = ['business', 'tax', 'delivery', 'notifications', 'system'];\n\n    if (groups && groups.length > 0) {\n      // Reset specific groups\n      for (const group of groups) {\n        if (validGroups.includes(group)) {\n          await db.delete(settings).where(eq(settings.key, group));\n        }\n      }\n    } else {\n      // Reset all grouped settings\n      for (const group of validGroups) {\n        await db.delete(settings).where(eq(settings.key, group));\n      }\n    }\n\n    // Log activity\n    await db.insert(adminActivityLogs).values({\n      adminUserId: req.user!.id,\n      action: 'reset',\n      entityType: 'settings',\n      details: { resetGroups: groups || 'all' },\n    });\n\n    sendSuccess(res, { message: 'Settings reset to defaults' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Activity Log Routes\n// ===========================================\n\n/**\n * GET /api/settings/activity-logs\n * Get admin activity logs (Admin only)\n */\nsettingsRoutes.get(\n  '/activity-logs',\n  requireAuth,\n  requireAdmin,\n  validateQuery(activityLogFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { adminId, action, entityType, startDate, endDate } = req.query;\n\n      const conditions = [];\n\n      if (adminId) {\n        conditions.push(eq(adminActivityLogs.adminUserId, adminId as string));\n      }\n\n      if (action) {\n        conditions.push(eq(adminActivityLogs.action, action as string));\n      }\n\n      if (entityType) {\n        conditions.push(eq(adminActivityLogs.entityType, entityType as string));\n      }\n\n      if (startDate) {\n        conditions.push(gte(adminActivityLogs.createdAt, new Date(startDate as string)));\n      }\n\n      if (endDate) {\n        const end = new Date(endDate as string);\n        end.setHours(23, 59, 59, 999);\n        conditions.push(sql`${adminActivityLogs.createdAt} <= ${end}`);\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(adminActivityLogs)\n        .where(whereClause);\n      const count = countResult[0]?.count ?? 0;\n\n      const logs = await db\n        .select({\n          id: adminActivityLogs.id,\n          adminUserId: adminActivityLogs.adminUserId,\n          action: adminActivityLogs.action,\n          entityType: adminActivityLogs.entityType,\n          entityId: adminActivityLogs.entityId,\n          details: adminActivityLogs.details,\n          ipAddress: adminActivityLogs.ipAddress,\n          createdAt: adminActivityLogs.createdAt,\n        })\n        .from(adminActivityLogs)\n        .where(whereClause)\n        .orderBy(desc(adminActivityLogs.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, logs, 200, createPaginationMeta(page, limit, Number(count)));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, orders, orderItems, customers, products, productVariants, sql, desc, eq, and, gte, lte } from '@lab404/database';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\n\nexport const analyticsRoutes = Router();\n\n// Apply admin auth to all routes\nanalyticsRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst dateRangeSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  period: z.enum(['today', 'yesterday', 'week', 'month', 'quarter', 'year', 'all']).optional(),\n});\n\n// Helper to get date range\nfunction getDateRange(query: { startDate?: string; endDate?: string; period?: string }) {\n  const now = new Date();\n  let startDate: Date | undefined;\n  let endDate: Date | undefined = new Date(now);\n  endDate.setHours(23, 59, 59, 999);\n\n  if (query.period) {\n    switch (query.period) {\n      case 'today':\n        startDate = new Date(now);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'yesterday':\n        startDate = new Date(now);\n        startDate.setDate(startDate.getDate() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        endDate = new Date(startDate);\n        endDate.setHours(23, 59, 59, 999);\n        break;\n      case 'week':\n        startDate = new Date(now);\n        startDate.setDate(startDate.getDate() - 7);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'month':\n        startDate = new Date(now);\n        startDate.setMonth(startDate.getMonth() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'quarter':\n        startDate = new Date(now);\n        startDate.setMonth(startDate.getMonth() - 3);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'year':\n        startDate = new Date(now);\n        startDate.setFullYear(startDate.getFullYear() - 1);\n        startDate.setHours(0, 0, 0, 0);\n        break;\n      case 'all':\n        startDate = undefined;\n        endDate = undefined;\n        break;\n    }\n  } else {\n    if (query.startDate) {\n      startDate = new Date(query.startDate);\n      startDate.setHours(0, 0, 0, 0);\n    }\n    if (query.endDate) {\n      endDate = new Date(query.endDate);\n      endDate.setHours(23, 59, 59, 999);\n    }\n  }\n\n  return { startDate, endDate };\n}\n\n// ===========================================\n// Dashboard Overview\n// ===========================================\n\n/**\n * GET /api/analytics/dashboard\n * Get dashboard overview stats\n */\nanalyticsRoutes.get('/dashboard', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    // Build date conditions\n    const orderConditions = [];\n    if (startDate) {orderConditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {orderConditions.push(lte(orders.createdAt, endDate));}\n    const orderWhere = orderConditions.length > 0 ? and(...orderConditions) : undefined;\n\n    // Total revenue\n    const [revenueResult] = await db\n      .select({\n        totalRevenue: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(\n        and(\n          orderWhere,\n          eq(orders.paymentStatus, 'paid')\n        )\n      );\n\n    // Pending orders\n    const [pendingResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(orders)\n      .where(\n        and(\n          orderWhere,\n          eq(orders.status, 'pending')\n        )\n      );\n\n    // Total customers\n    const customerConditions = [];\n    if (startDate) {customerConditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {customerConditions.push(lte(customers.createdAt, endDate));}\n    const customerWhere = customerConditions.length > 0 ? and(...customerConditions) : undefined;\n\n    const [customerResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(customerWhere);\n\n    // Average order value\n    const averageOrderValue = revenueResult?.orderCount && revenueResult.orderCount > 0\n      ? Number(revenueResult.totalRevenue) / Number(revenueResult.orderCount)\n      : 0;\n\n    // Compare with previous period\n    let previousPeriodData = null;\n    if (startDate && endDate) {\n      const periodLength = endDate.getTime() - startDate.getTime();\n      const prevStart = new Date(startDate.getTime() - periodLength);\n      const prevEnd = new Date(startDate.getTime() - 1);\n\n      const [prevRevenue] = await db\n        .select({\n          totalRevenue: sql<number>`COALESCE(SUM(CAST(${orders.totalSnapshot} AS DECIMAL)), 0)`,\n          orderCount: sql<number>`COUNT(*)`,\n        })\n        .from(orders)\n        .where(\n          and(\n            gte(orders.createdAt, prevStart),\n            lte(orders.createdAt, prevEnd),\n            eq(orders.paymentStatus, 'paid')\n          )\n        );\n\n      const [prevCustomers] = await db\n        .select({ count: sql<number>`COUNT(*)` })\n        .from(customers)\n        .where(\n          and(\n            gte(customers.createdAt, prevStart),\n            lte(customers.createdAt, prevEnd)\n          )\n        );\n\n      const currentRevenue = Number(revenueResult?.totalRevenue ?? 0);\n      const prevRevenueNum = Number(prevRevenue?.totalRevenue ?? 0);\n\n      previousPeriodData = {\n        revenueChange: prevRevenueNum > 0\n          ? ((currentRevenue - prevRevenueNum) / prevRevenueNum) * 100\n          : currentRevenue > 0 ? 100 : 0,\n        orderCountChange: Number(prevRevenue?.orderCount ?? 0) > 0\n          ? ((Number(revenueResult?.orderCount ?? 0) - Number(prevRevenue?.orderCount ?? 0)) / Number(prevRevenue?.orderCount ?? 1)) * 100\n          : Number(revenueResult?.orderCount ?? 0) > 0 ? 100 : 0,\n        customerCountChange: Number(prevCustomers?.count ?? 0) > 0\n          ? ((Number(customerResult?.count ?? 0) - Number(prevCustomers?.count ?? 0)) / Number(prevCustomers?.count ?? 1)) * 100\n          : Number(customerResult?.count ?? 0) > 0 ? 100 : 0,\n      };\n    }\n\n    sendSuccess(res, {\n      totalRevenue: Number(revenueResult?.totalRevenue ?? 0),\n      orderCount: Number(revenueResult?.orderCount ?? 0),\n      pendingOrders: Number(pendingResult?.count ?? 0),\n      customerCount: Number(customerResult?.count ?? 0),\n      averageOrderValue: Math.round(averageOrderValue * 100) / 100,\n      previousPeriodComparison: previousPeriodData,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Sales Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/sales\n * Get sales data over time\n */\nanalyticsRoutes.get('/sales', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const groupBy = (req.query['groupBy'] as string) || 'day';\n\n    let dateFormat: string;\n    switch (groupBy) {\n      case 'hour':\n        dateFormat = 'YYYY-MM-DD HH24:00';\n        break;\n      case 'day':\n        dateFormat = 'YYYY-MM-DD';\n        break;\n      case 'week':\n        dateFormat = 'IYYY-IW';\n        break;\n      case 'month':\n        dateFormat = 'YYYY-MM';\n        break;\n      default:\n        dateFormat = 'YYYY-MM-DD';\n    }\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Create the period expression as a reusable SQL fragment\n    const periodExpr = sql`TO_CHAR(${orders.createdAt}, ${sql.raw(`'${dateFormat}'`)})`;\n\n    const salesData = await db\n      .select({\n        period: sql<string>`${periodExpr}`,\n        revenue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n        averageOrderValue: sql<number>`AVG(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n      })\n      .from(orders)\n      .where(and(...conditions))\n      .groupBy(periodExpr)\n      .orderBy(periodExpr);\n\n    sendSuccess(res, salesData.map(row => ({\n      period: row.period,\n      revenue: Number(row.revenue),\n      orderCount: Number(row.orderCount),\n      averageOrderValue: Math.round(Number(row.averageOrderValue) * 100) / 100,\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/sales/by-status\n * Get sales breakdown by order status\n */\nanalyticsRoutes.get('/sales/by-status', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const statusData = await db\n      .select({\n        status: orders.status,\n        count: sql<number>`COUNT(*)`,\n        totalValue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n      })\n      .from(orders)\n      .where(whereClause)\n      .groupBy(orders.status);\n\n    sendSuccess(res, statusData.map(row => ({\n      status: row.status,\n      count: Number(row.count),\n      totalValue: Number(row.totalValue) || 0,\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Product Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/products/top-selling\n * Get top selling products\n */\nanalyticsRoutes.get('/products/top-selling', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const limit = parseInt(req.query['limit'] as string) || 10;\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Only count delivered/completed orders\n    conditions.push(eq(orders.paymentStatus, 'paid'));\n\n    const topProducts = await db\n      .select({\n        productId: orderItems.productId,\n        productName: orderItems.productNameSnapshot,\n        totalQuantity: sql<number>`SUM(${orderItems.quantity})`,\n        totalRevenue: sql<number>`SUM(CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity})`,\n        orderCount: sql<number>`COUNT(DISTINCT ${orderItems.orderId})`,\n      })\n      .from(orderItems)\n      .innerJoin(orders, eq(orderItems.orderId, orders.id))\n      .where(and(...conditions))\n      .groupBy(orderItems.productId, orderItems.productNameSnapshot)\n      .orderBy(desc(sql`SUM(${orderItems.quantity})`))\n      .limit(limit);\n\n    sendSuccess(res, topProducts.map(row => ({\n      productId: row.productId,\n      productName: row.productName,\n      totalQuantity: Number(row.totalQuantity),\n      totalRevenue: Number(row.totalRevenue),\n      orderCount: Number(row.orderCount),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/products/low-stock\n * Get products with low stock\n */\nanalyticsRoutes.get('/products/low-stock', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const threshold = parseInt(req.query['threshold'] as string) || 10;\n\n    // Products with low stock\n    const lowStockProducts = await db\n      .select({\n        id: products.id,\n        name: products.name,\n        sku: products.sku,\n        stockQuantity: products.stockQuantity,\n        status: products.status,\n      })\n      .from(products)\n      .where(\n        and(\n          eq(products.status, 'active'),\n          lte(products.stockQuantity, threshold)\n        )\n      )\n      .orderBy(products.stockQuantity)\n      .limit(50);\n\n    // Variants with low stock\n    const lowStockVariants = await db\n      .select({\n        id: productVariants.id,\n        productId: productVariants.productId,\n        productName: products.name,\n        sku: productVariants.sku,\n        options: productVariants.options,\n        stockQuantity: productVariants.stockQuantity,\n      })\n      .from(productVariants)\n      .innerJoin(products, eq(productVariants.productId, products.id))\n      .where(\n        and(\n          eq(productVariants.isActive, true),\n          lte(productVariants.stockQuantity, threshold)\n        )\n      )\n      .orderBy(productVariants.stockQuantity)\n      .limit(50);\n\n    sendSuccess(res, {\n      products: lowStockProducts,\n      variants: lowStockVariants,\n      threshold,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/customers/overview\n * Get customer analytics overview\n */\nanalyticsRoutes.get('/customers/overview', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(customers.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    // Total customers\n    const [totalResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(whereClause);\n\n    // Guest vs registered\n    const [guestResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(\n        and(\n          whereClause,\n          eq(customers.isGuest, true)\n        )\n      );\n\n    // Customers with orders\n    const [withOrdersResult] = await db\n      .select({ count: sql<number>`COUNT(*)` })\n      .from(customers)\n      .where(\n        and(\n          whereClause,\n          sql`${customers.orderCount} > 0`\n        )\n      );\n\n    // Top customers by order count\n    const topCustomers = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        orderCount: customers.orderCount,\n      })\n      .from(customers)\n      .where(sql`${customers.orderCount} > 0`)\n      .orderBy(desc(customers.orderCount))\n      .limit(10);\n\n    sendSuccess(res, {\n      totalCustomers: Number(totalResult?.count ?? 0),\n      guestCustomers: Number(guestResult?.count ?? 0),\n      registeredCustomers: Number(totalResult?.count ?? 0) - Number(guestResult?.count ?? 0),\n      customersWithOrders: Number(withOrdersResult?.count ?? 0),\n      topCustomers,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/customers/new\n * Get new customer registrations over time\n */\nanalyticsRoutes.get('/customers/new', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n    const groupBy = (req.query['groupBy'] as string) || 'day';\n\n    let dateFormat: string;\n    switch (groupBy) {\n      case 'day':\n        dateFormat = 'YYYY-MM-DD';\n        break;\n      case 'week':\n        dateFormat = 'IYYY-IW';\n        break;\n      case 'month':\n        dateFormat = 'YYYY-MM';\n        break;\n      default:\n        dateFormat = 'YYYY-MM-DD';\n    }\n\n    const conditions = [];\n    if (startDate) {conditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(customers.createdAt, endDate));}\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const customerData = await db\n      .select({\n        period: sql<string>`TO_CHAR(${customers.createdAt}, ${dateFormat})`,\n        total: sql<number>`COUNT(*)`,\n        guests: sql<number>`COUNT(*) FILTER (WHERE ${customers.isGuest} = true)`,\n        registered: sql<number>`COUNT(*) FILTER (WHERE ${customers.isGuest} = false)`,\n      })\n      .from(customers)\n      .where(whereClause)\n      .groupBy(sql`TO_CHAR(${customers.createdAt}, ${dateFormat})`)\n      .orderBy(sql`TO_CHAR(${customers.createdAt}, ${dateFormat})`);\n\n    sendSuccess(res, customerData.map(row => ({\n      period: row.period,\n      total: Number(row.total),\n      guests: Number(row.guests),\n      registered: Number(row.registered),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Revenue Analytics\n// ===========================================\n\n/**\n * GET /api/analytics/revenue/breakdown\n * Get revenue breakdown\n */\nanalyticsRoutes.get('/revenue/breakdown', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    const [breakdown] = await db\n      .select({\n        subtotal: sql<number>`SUM(CAST(${orders.subtotalSnapshot} AS DECIMAL))`,\n        taxAmount: sql<number>`SUM(CAST(${orders.taxAmountSnapshot} AS DECIMAL))`,\n        shippingAmount: sql<number>`SUM(CAST(${orders.shippingAmountSnapshot} AS DECIMAL))`,\n        discountAmount: sql<number>`SUM(CAST(${orders.discountAmountSnapshot} AS DECIMAL))`,\n        total: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(and(...conditions));\n\n    sendSuccess(res, {\n      subtotal: Number(breakdown?.subtotal) || 0,\n      taxAmount: Number(breakdown?.taxAmount) || 0,\n      shippingAmount: Number(breakdown?.shippingAmount) || 0,\n      discountAmount: Number(breakdown?.discountAmount) || 0,\n      total: Number(breakdown?.total) || 0,\n      orderCount: Number(breakdown?.orderCount) || 0,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/analytics/revenue/by-payment-method\n * Get revenue by payment method\n */\nanalyticsRoutes.get('/revenue/by-payment-method', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    const conditions = [eq(orders.paymentStatus, 'paid')];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    const byPaymentMethod = await db\n      .select({\n        paymentMethod: orders.paymentMethod,\n        revenue: sql<number>`SUM(CAST(${orders.totalSnapshot} AS DECIMAL))`,\n        orderCount: sql<number>`COUNT(*)`,\n      })\n      .from(orders)\n      .where(and(...conditions))\n      .groupBy(orders.paymentMethod);\n\n    sendSuccess(res, byPaymentMethod.map(row => ({\n      paymentMethod: row.paymentMethod || 'unknown',\n      revenue: Number(row.revenue),\n      orderCount: Number(row.orderCount),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Recent Orders\n// ===========================================\n\n/**\n * GET /api/analytics/orders/recent\n * Get most recent orders for dashboard display\n */\nanalyticsRoutes.get('/orders/recent', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const limit = parseInt(req.query['limit'] as string) || 10;\n\n    const recentOrders = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        customerId: orders.customerId,\n        customerEmail: customers.email,\n        customerFirstName: customers.firstName,\n        customerLastName: customers.lastName,\n        total: orders.totalSnapshot,\n        status: orders.status,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .leftJoin(customers, eq(orders.customerId, customers.id))\n      .orderBy(desc(orders.createdAt))\n      .limit(limit);\n\n    sendSuccess(res, recentOrders.map(order => ({\n      id: order.id,\n      orderNumber: order.orderNumber,\n      customer: order.customerFirstName && order.customerLastName\n        ? `${order.customerFirstName} ${order.customerLastName}`\n        : order.customerEmail || 'Guest',\n      total: Number(order.total),\n      status: order.status,\n      createdAt: order.createdAt?.toISOString() || new Date().toISOString(),\n    })));\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Export Analytics Data\n// ===========================================\n\n/**\n * GET /api/analytics/export\n * Export analytics data as JSON\n */\nanalyticsRoutes.get('/export', validateQuery(dateRangeSchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { startDate, endDate } = getDateRange(req.query);\n\n    // Gather all analytics data\n    const conditions = [];\n    if (startDate) {conditions.push(gte(orders.createdAt, startDate));}\n    if (endDate) {conditions.push(lte(orders.createdAt, endDate));}\n\n    // Get all orders in range\n    const orderData = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        total: orders.totalSnapshot,\n        createdAt: orders.createdAt,\n      })\n      .from(orders)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    // Get customer data\n    const customerConditions = [];\n    if (startDate) {customerConditions.push(gte(customers.createdAt, startDate));}\n    if (endDate) {customerConditions.push(lte(customers.createdAt, endDate));}\n\n    const customerData = await db\n      .select({\n        id: customers.id,\n        email: customers.email,\n        isGuest: customers.isGuest,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n      })\n      .from(customers)\n      .where(customerConditions.length > 0 ? and(...customerConditions) : undefined);\n\n    const exportData = {\n      exportedAt: new Date().toISOString(),\n      dateRange: { startDate, endDate },\n      summary: {\n        totalOrders: orderData.length,\n        totalCustomers: customerData.length,\n        totalRevenue: orderData\n          .filter(o => o.paymentStatus === 'paid')\n          .reduce((sum, o) => sum + Number(o.total), 0),\n      },\n      orders: orderData.map(o => ({\n        ...o,\n        total: Number(o.total),\n      })),\n      customers: customerData,\n    };\n\n    res.setHeader('Content-Type', 'application/json');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"analytics-export-${new Date().toISOString().split('T')[0]}.json\"`\n    );\n\n    res.json(exportData);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, orders, customers, promoCodes, quotations, orderItems, quotationItems, eq, desc, and, gte, lte, sql } from '@lab404/database';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { exportService } from '../services/export.service';\n\nexport const exportRoutes = Router();\n\n// Apply admin auth to all routes\nexportRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst exportQuerySchema = z.object({\n  format: z.enum(['csv', 'json', 'jsonl']).optional().default('csv'),\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  status: z.string().optional(),\n});\n\n// Helper to set export headers\nfunction setExportHeaders(res: any, filename: string, contentType: string) {\n  res.setHeader('Content-Type', contentType);\n  res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n}\n\n// ===========================================\n// Product Export\n// ===========================================\n\n/**\n * GET /api/export/products\n * Export all products - ALL fields\n */\nexportRoutes.get('/products', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, status } = req.query;\n\n    const conditions = [];\n    if (status) {\n      conditions.push(eq(products.status, status as 'draft' | 'active' | 'archived'));\n    }\n\n    const productList = await db\n      .select({\n        id: products.id,\n        sku: products.sku,\n        barcode: products.barcode,\n        name: products.name,\n        slug: products.slug,\n        description: products.description,\n        shortDescription: products.shortDescription,\n        categoryId: products.categoryId,\n        categoryName: categories.name,\n        brand: products.brand,\n        basePrice: products.basePrice,\n        costPrice: products.costPrice,\n        compareAtPrice: products.compareAtPrice,\n        weight: products.weight,\n        dimensions: products.dimensions,\n        stockQuantity: products.stockQuantity,\n        lowStockThreshold: products.lowStockThreshold,\n        trackInventory: products.trackInventory,\n        allowBackorder: products.allowBackorder,\n        images: products.images,\n        videos: products.videos,\n        thumbnailUrl: products.thumbnailUrl,\n        tags: products.tags,\n        specifications: products.specifications,\n        features: products.features,\n        metaTitle: products.metaTitle,\n        metaDescription: products.metaDescription,\n        status: products.status,\n        isFeatured: products.isFeatured,\n        isDigital: products.isDigital,\n        requiresShipping: products.requiresShipping,\n        supplierId: products.supplierId,\n        supplierSku: products.supplierSku,\n        importedFrom: products.importedFrom,\n        externalUrl: products.externalUrl,\n        createdAt: products.createdAt,\n        updatedAt: products.updatedAt,\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.categoryId, categories.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(products.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('products', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(productList as any[], exportService.getProductColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(productList));\n    } else {\n      res.send(exportService.toJSON(productList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Order Export\n// ===========================================\n\n/**\n * GET /api/export/orders\n * Export orders - ALL fields\n */\nexportRoutes.get('/orders', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate, status } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(orders.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(orders.createdAt, end));\n    }\n    if (status) {\n      conditions.push(eq(orders.status, status as 'pending' | 'confirmed' | 'processing' | 'shipped' | 'delivered' | 'cancelled'));\n    }\n\n    const orderList = await db\n      .select({\n        id: orders.id,\n        orderNumber: orders.orderNumber,\n        customerId: orders.customerId,\n        customerEmail: customers.email,\n        customerName: sql<string>`CONCAT(${customers.firstName}, ' ', ${customers.lastName})`,\n        status: orders.status,\n        paymentStatus: orders.paymentStatus,\n        paymentMethod: orders.paymentMethod,\n        shippingAddress: orders.shippingAddress,\n        billingAddress: orders.billingAddress,\n        currency: orders.currency,\n        subtotalSnapshot: orders.subtotalSnapshot,\n        taxRateSnapshot: orders.taxRateSnapshot,\n        taxAmountSnapshot: orders.taxAmountSnapshot,\n        shippingAmountSnapshot: orders.shippingAmountSnapshot,\n        discountAmountSnapshot: orders.discountAmountSnapshot,\n        totalSnapshot: orders.totalSnapshot,\n        promoCodeId: orders.promoCodeId,\n        promoCodeSnapshot: orders.promoCodeSnapshot,\n        shippingMethod: orders.shippingMethod,\n        trackingNumber: orders.trackingNumber,\n        confirmedAt: orders.confirmedAt,\n        processingAt: orders.processingAt,\n        shippedAt: orders.shippedAt,\n        deliveredAt: orders.deliveredAt,\n        customerNotes: orders.customerNotes,\n        adminNotes: orders.adminNotes,\n        createdAt: orders.createdAt,\n        updatedAt: orders.updatedAt,\n      })\n      .from(orders)\n      .leftJoin(customers, eq(orders.customerId, customers.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('orders', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(orderList as any[], exportService.getOrderColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(orderList));\n    } else {\n      res.send(exportService.toJSON(orderList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/orders/:id/items\n * Export order items for a specific order\n */\nexportRoutes.get('/orders/:id/items', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n    const format = (req.query['format'] as string) || 'csv';\n\n    // Get order number for context\n    const [order] = await db.select({ orderNumber: orders.orderNumber }).from(orders).where(eq(orders.id, id));\n\n    const items = await db\n      .select({\n        id: orderItems.id,\n        orderId: orderItems.orderId,\n        orderNumber: sql<string>`${order?.orderNumber || ''}`,\n        productId: orderItems.productId,\n        variantId: orderItems.variantId,\n        productNameSnapshot: orderItems.productNameSnapshot,\n        skuSnapshot: orderItems.skuSnapshot,\n        variantOptionsSnapshot: orderItems.variantOptionsSnapshot,\n        quantity: orderItems.quantity,\n        unitPriceSnapshot: orderItems.unitPriceSnapshot,\n        lineTotal: sql<string>`CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity}`,\n        createdAt: orderItems.createdAt,\n      })\n      .from(orderItems)\n      .where(eq(orderItems.orderId, id));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename(`order-${order?.orderNumber || id}-items`, extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getOrderItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/order-items\n * Export ALL order items (bulk export)\n */\nexportRoutes.get('/order-items', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(orders.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(orders.createdAt, end));\n    }\n\n    const items = await db\n      .select({\n        id: orderItems.id,\n        orderId: orderItems.orderId,\n        orderNumber: orders.orderNumber,\n        productId: orderItems.productId,\n        variantId: orderItems.variantId,\n        productNameSnapshot: orderItems.productNameSnapshot,\n        skuSnapshot: orderItems.skuSnapshot,\n        variantOptionsSnapshot: orderItems.variantOptionsSnapshot,\n        quantity: orderItems.quantity,\n        unitPriceSnapshot: orderItems.unitPriceSnapshot,\n        lineTotal: sql<string>`CAST(${orderItems.unitPriceSnapshot} AS DECIMAL) * ${orderItems.quantity}`,\n        createdAt: orderItems.createdAt,\n      })\n      .from(orderItems)\n      .innerJoin(orders, eq(orderItems.orderId, orders.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(orders.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('order-items', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getOrderItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Customer Export\n// ===========================================\n\n/**\n * GET /api/export/customers\n * Export customers - ALL fields\n */\nexportRoutes.get('/customers', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(customers.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(customers.createdAt, end));\n    }\n\n    const customerList = await db\n      .select({\n        id: customers.id,\n        authUserId: customers.authUserId,\n        email: customers.email,\n        firstName: customers.firstName,\n        lastName: customers.lastName,\n        phone: customers.phone,\n        defaultShippingAddress: customers.defaultShippingAddress,\n        defaultBillingAddress: customers.defaultBillingAddress,\n        isGuest: customers.isGuest,\n        isActive: customers.isActive,\n        acceptsMarketing: customers.acceptsMarketing,\n        notes: customers.notes,\n        tags: customers.tags,\n        orderCount: customers.orderCount,\n        createdAt: customers.createdAt,\n        updatedAt: customers.updatedAt,\n      })\n      .from(customers)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(customers.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('customers', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(customerList as any[], exportService.getCustomerColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(customerList));\n    } else {\n      res.send(exportService.toJSON(customerList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Promo Code Export\n// ===========================================\n\n/**\n * GET /api/export/promo-codes\n * Export promo codes - ALL fields\n */\nexportRoutes.get('/promo-codes', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format } = req.query;\n\n    const promoCodeList = await db\n      .select()\n      .from(promoCodes)\n      .orderBy(desc(promoCodes.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('promo-codes', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(promoCodeList as any[], exportService.getPromoCodeColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(promoCodeList));\n    } else {\n      res.send(exportService.toJSON(promoCodeList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Quotation Export\n// ===========================================\n\n/**\n * GET /api/export/quotations\n * Export quotations - ALL fields\n */\nexportRoutes.get('/quotations', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate, status } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(quotations.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(quotations.createdAt, end));\n    }\n    if (status) {\n      conditions.push(eq(quotations.status, status as 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired'));\n    }\n\n    const quotationList = await db\n      .select()\n      .from(quotations)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(quotations.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('quotations', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(quotationList as any[], exportService.getQuotationColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(quotationList));\n    } else {\n      res.send(exportService.toJSON(quotationList));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/export/quotation-items\n * Export ALL quotation items (bulk export)\n */\nexportRoutes.get('/quotation-items', validateQuery(exportQuerySchema), async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { format, startDate, endDate } = req.query;\n\n    const conditions = [];\n    if (startDate) {\n      conditions.push(gte(quotations.createdAt, new Date(startDate as string)));\n    }\n    if (endDate) {\n      const end = new Date(endDate as string);\n      end.setHours(23, 59, 59, 999);\n      conditions.push(lte(quotations.createdAt, end));\n    }\n\n    const items = await db\n      .select({\n        id: quotationItems.id,\n        quotationId: quotationItems.quotationId,\n        quotationNumber: quotations.quotationNumber,\n        productId: quotationItems.productId,\n        variantId: quotationItems.variantId,\n        name: quotationItems.name,\n        description: quotationItems.description,\n        sku: quotationItems.sku,\n        quantity: quotationItems.quantity,\n        unitPrice: quotationItems.unitPrice,\n        lineTotal: sql<string>`CAST(${quotationItems.unitPrice} AS DECIMAL) * ${quotationItems.quantity}`,\n        createdAt: quotationItems.createdAt,\n      })\n      .from(quotationItems)\n      .innerJoin(quotations, eq(quotationItems.quotationId, quotations.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(quotations.createdAt));\n\n    const { contentType, extension } = exportService.getContentType(format as 'csv' | 'json' | 'jsonl');\n    const filename = exportService.getFilename('quotation-items', extension);\n\n    setExportHeaders(res, filename, contentType);\n\n    if (format === 'csv') {\n      const csv = exportService.toCSV(items as any[], exportService.getQuotationItemColumns());\n      res.send(csv);\n    } else if (format === 'jsonl') {\n      res.send(exportService.toJSONL(items));\n    } else {\n      res.send(exportService.toJSON(items));\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, products, categories, customers, productImportJobs, eq } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendCreated } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\nimport { importService } from '../services/import.service';\nimport { generateSlug } from '../utils/helpers';\n\nexport const importRoutes = Router();\n\n// Apply admin auth to all routes\nimportRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst csvImportSchema = z.object({\n  csvContent: z.string().min(1),\n  dryRun: z.boolean().optional().default(false),\n  updateExisting: z.boolean().optional().default(false),\n});\n\nconst urlImportSchema = z.object({\n  url: z.string().url(),\n  source: z.enum(['amazon', 'aliexpress', 'ebay', 'other']).optional().default('other'),\n});\n\n// ===========================================\n// Template Downloads\n// ===========================================\n\n/**\n * GET /api/import/templates/products\n * Download product import template\n */\nimportRoutes.get('/templates/products', (_req, res) => {\n  res.setHeader('Content-Type', 'text/csv');\n  res.setHeader('Content-Disposition', 'attachment; filename=\"product-import-template.csv\"');\n  res.send(importService.getProductTemplate());\n});\n\n/**\n * GET /api/import/templates/customers\n * Download customer import template\n */\nimportRoutes.get('/templates/customers', (_req, res) => {\n  res.setHeader('Content-Type', 'text/csv');\n  res.setHeader('Content-Disposition', 'attachment; filename=\"customer-import-template.csv\"');\n  res.send(importService.getCustomerTemplate());\n});\n\n// ===========================================\n// Product Import\n// ===========================================\n\n/**\n * POST /api/import/products\n * Import products from CSV\n */\nimportRoutes.post(\n  '/products',\n  validateBody(csvImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { csvContent, dryRun, updateExisting } = req.body;\n\n      // Parse CSV\n      const rawData = importService.parseCSV(csvContent);\n\n      if (rawData.length === 0) {\n        throw new BadRequestError('CSV file is empty or invalid');\n      }\n\n      // Validate and map data\n      const result = importService.mapAndValidate(\n        rawData,\n        importService.getProductMappings(),\n        importService.getProductSchema()\n      );\n\n      // If dry run, just return validation results\n      if (dryRun) {\n        return sendSuccess(res, {\n          dryRun: true,\n          ...result,\n          data: result.data.slice(0, 5), // Only return first 5 for preview\n        });\n      }\n\n      // Import products\n      let importedCount = 0;\n      let updatedCount = 0;\n      let skippedCount = 0;\n\n      for (const productData of result.data) {\n        const data = productData as z.infer<ReturnType<typeof importService.getProductSchema>>;\n\n        // Check if product with same SKU exists\n        const [existingProduct] = await db\n          .select({ id: products.id })\n          .from(products)\n          .where(eq(products.sku, data.sku));\n\n        if (existingProduct) {\n          if (updateExisting) {\n            // Update existing product with ALL fields\n            await db\n              .update(products)\n              .set({\n                name: data.name,\n                barcode: data.barcode,\n                description: data.description,\n                shortDescription: data.shortDescription,\n                basePrice: String(data.basePrice),\n                costPrice: data.costPrice ? String(data.costPrice) : undefined,\n                compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : undefined,\n                stockQuantity: data.stockQuantity,\n                lowStockThreshold: data.lowStockThreshold,\n                trackInventory: data.trackInventory,\n                allowBackorder: data.allowBackorder,\n                weight: data.weight ? String(data.weight) : undefined,\n                dimensions: data.dimensions,\n                brand: data.brand,\n                status: data.status,\n                isFeatured: data.isFeatured,\n                isDigital: data.isDigital,\n                requiresShipping: data.requiresShipping,\n                thumbnailUrl: data.thumbnailUrl,\n                images: data.images,\n                metaTitle: data.metaTitle,\n                metaDescription: data.metaDescription,\n                tags: data.tags,\n                features: data.features,\n                specifications: data.specifications,\n                supplierId: data.supplierId,\n                supplierSku: data.supplierSku,\n                updatedAt: new Date(),\n              })\n              .where(eq(products.id, existingProduct.id));\n            updatedCount++;\n          } else {\n            skippedCount++;\n          }\n          continue;\n        }\n\n        // Get category ID if category name provided\n        let categoryId: string | undefined;\n        if (data.categoryName) {\n          const [category] = await db\n            .select({ id: categories.id })\n            .from(categories)\n            .where(eq(categories.name, data.categoryName));\n\n          if (category) {\n            categoryId = category.id;\n          }\n        }\n\n        // Generate slug\n        const slug = generateSlug(data.name);\n\n        // Create product with ALL fields\n        await db.insert(products).values({\n          name: data.name,\n          slug: `${slug}-${Date.now()}`, // Ensure unique slug\n          sku: data.sku,\n          barcode: data.barcode,\n          description: data.description,\n          shortDescription: data.shortDescription,\n          basePrice: String(data.basePrice),\n          costPrice: data.costPrice ? String(data.costPrice) : undefined,\n          compareAtPrice: data.compareAtPrice ? String(data.compareAtPrice) : undefined,\n          stockQuantity: data.stockQuantity || 0,\n          lowStockThreshold: data.lowStockThreshold || 5,\n          trackInventory: data.trackInventory ?? true,\n          allowBackorder: data.allowBackorder || false,\n          weight: data.weight ? String(data.weight) : undefined,\n          dimensions: data.dimensions,\n          categoryId,\n          brand: data.brand,\n          status: data.status || 'draft',\n          isFeatured: data.isFeatured || false,\n          isDigital: data.isDigital || false,\n          requiresShipping: data.requiresShipping ?? true,\n          thumbnailUrl: data.thumbnailUrl,\n          images: data.images || [],\n          metaTitle: data.metaTitle,\n          metaDescription: data.metaDescription,\n          tags: data.tags || [],\n          features: data.features || [],\n          specifications: data.specifications || {},\n          supplierId: data.supplierId,\n          supplierSku: data.supplierSku,\n        });\n\n        importedCount++;\n      }\n\n      sendSuccess(res, {\n        success: true,\n        totalRows: result.totalRows,\n        imported: importedCount,\n        updated: updatedCount,\n        skipped: skippedCount,\n        errors: result.errors,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Customer Import\n// ===========================================\n\n/**\n * POST /api/import/customers\n * Import customers from CSV\n */\nimportRoutes.post(\n  '/customers',\n  validateBody(csvImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { csvContent, dryRun, updateExisting } = req.body;\n\n      // Parse CSV\n      const rawData = importService.parseCSV(csvContent);\n\n      if (rawData.length === 0) {\n        throw new BadRequestError('CSV file is empty or invalid');\n      }\n\n      // Validate and map data\n      const result = importService.mapAndValidate(\n        rawData,\n        importService.getCustomerMappings(),\n        importService.getCustomerSchema()\n      );\n\n      // If dry run, just return validation results\n      if (dryRun) {\n        return sendSuccess(res, {\n          dryRun: true,\n          ...result,\n          data: result.data.slice(0, 5),\n        });\n      }\n\n      // Import customers\n      let importedCount = 0;\n      let updatedCount = 0;\n      let skippedCount = 0;\n\n      for (const customerData of result.data) {\n        const data = customerData as z.infer<ReturnType<typeof importService.getCustomerSchema>>;\n\n        // Check if customer with same email exists\n        const [existingCustomer] = await db\n          .select({ id: customers.id })\n          .from(customers)\n          .where(eq(customers.email, data.email.toLowerCase()));\n\n        if (existingCustomer) {\n          if (updateExisting) {\n            // Build address JSON from flat fields\n            const shippingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'shipping');\n            const billingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'billing');\n\n            await db\n              .update(customers)\n              .set({\n                firstName: data.firstName,\n                lastName: data.lastName,\n                phone: data.phone,\n                isActive: data.isActive,\n                acceptsMarketing: data.acceptsMarketing,\n                notes: data.notes,\n                tags: data.tags,\n                defaultShippingAddress: shippingAddress,\n                defaultBillingAddress: billingAddress,\n                updatedAt: new Date(),\n              })\n              .where(eq(customers.id, existingCustomer.id));\n            updatedCount++;\n          } else {\n            skippedCount++;\n          }\n          continue;\n        }\n\n        // Build address JSON from flat fields\n        const shippingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'shipping');\n        const billingAddress = importService.buildAddressFromFlatFields(data as Record<string, unknown>, 'billing');\n\n        // Create customer with ALL fields\n        await db.insert(customers).values({\n          email: data.email.toLowerCase(),\n          firstName: data.firstName,\n          lastName: data.lastName,\n          phone: data.phone,\n          isActive: data.isActive ?? true,\n          isGuest: false,\n          acceptsMarketing: data.acceptsMarketing || false,\n          notes: data.notes,\n          tags: data.tags || [],\n          defaultShippingAddress: shippingAddress,\n          defaultBillingAddress: billingAddress,\n        });\n\n        importedCount++;\n      }\n\n      sendSuccess(res, {\n        success: true,\n        totalRows: result.totalRows,\n        imported: importedCount,\n        updated: updatedCount,\n        skipped: skippedCount,\n        errors: result.errors,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// URL Import (Web Scraping)\n// ===========================================\n\n/**\n * POST /api/import/from-url\n * Create import job from URL (Amazon, AliExpress, eBay)\n */\nimportRoutes.post(\n  '/from-url',\n  validateBody(urlImportSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { url, source } = req.body;\n\n      // Validate URL domain matches source\n      const urlObj = new URL(url);\n      const hostname = urlObj.hostname.toLowerCase();\n\n      let detectedSource = source;\n      if (hostname.includes('amazon')) {\n        detectedSource = 'amazon';\n      } else if (hostname.includes('aliexpress')) {\n        detectedSource = 'aliexpress';\n      } else if (hostname.includes('ebay')) {\n        detectedSource = 'ebay';\n      }\n\n      // Create import job\n      const jobResult = await db\n        .insert(productImportJobs)\n        .values({\n          source: detectedSource as 'amazon' | 'aliexpress' | 'ebay',\n          sourceUrl: url,\n          status: 'pending',\n        })\n        .returning();\n      const job = jobResult[0];\n\n      if (!job) {\n        throw new BadRequestError('Failed to create import job');\n      }\n\n      // TODO: Queue job for background processing\n      // For now, just return the job ID\n\n      sendCreated(res, {\n        jobId: job.id,\n        status: job.status,\n        source: detectedSource,\n        url,\n        message: 'Import job created. Product data will be extracted in the background.',\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/import/jobs\n * List import jobs\n */\nimportRoutes.get('/jobs', async (req, res, next) => {\n  try {\n    const db = getDb();\n\n    const jobs = await db\n      .select()\n      .from(productImportJobs)\n      .orderBy(productImportJobs.createdAt);\n\n    sendSuccess(res, jobs);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/import/jobs/:id\n * Get import job status\n */\nimportRoutes.get('/jobs/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select()\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    sendSuccess(res, job);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/import/jobs/:id/retry\n * Retry failed import job\n */\nimportRoutes.post('/jobs/:id/retry', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select()\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    if (job.status !== 'failed') {\n      throw new BadRequestError('Only failed jobs can be retried');\n    }\n\n    // Reset job status\n    await db\n      .update(productImportJobs)\n      .set({\n        status: 'pending',\n        errorMessage: null,\n      })\n      .where(eq(productImportJobs.id, id));\n\n    // TODO: Re-queue job for processing\n\n    sendSuccess(res, { message: 'Job queued for retry' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/import/jobs/:id\n * Delete import job\n */\nimportRoutes.delete('/jobs/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [job] = await db\n      .select({ id: productImportJobs.id })\n      .from(productImportJobs)\n      .where(eq(productImportJobs.id, id));\n\n    if (!job) {\n      throw new NotFoundError('Import job not found');\n    }\n\n    await db.delete(productImportJobs).where(eq(productImportJobs.id, id));\n\n    sendSuccess(res, { message: 'Import job deleted' });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport crypto from 'crypto';\nimport { getDb, newsletterSubscribers, eq } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { strictLimiter } from '../middleware/rateLimiter';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\n\nexport const contactRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst contactFormSchema = z.object({\n  name: z.string().min(1).max(100),\n  email: z.string().email(),\n  phone: z.string().max(50).optional(),\n  subject: z.string().min(1).max(200),\n  message: z.string().min(10).max(5000),\n  recaptchaToken: z.string().optional(), // For future reCAPTCHA integration\n});\n\nconst newsletterSchema = z.object({\n  email: z.string().email(),\n  name: z.string().max(100).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional(),\n});\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * POST /api/contact\n * Submit contact form\n */\ncontactRoutes.post(\n  '/',\n  strictLimiter,\n  validateBody(contactFormSchema),\n  async (req, res, next) => {\n    try {\n      const { name, email, phone, subject, message } = req.body;\n\n      // TODO: Integrate with email service to send contact form\n      // TODO: Optionally store in database for admin review\n      // TODO: Integrate reCAPTCHA validation\n\n      // For now, just return success\n      // In production, this would send an email\n\n      // Log the contact form submission\n      console.log('Contact form submission:', {\n        name,\n        email,\n        phone,\n        subject,\n        messageLength: message.length,\n        timestamp: new Date().toISOString(),\n      });\n\n      sendSuccess(res, {\n        message: 'Thank you for contacting us. We will get back to you soon.',\n        received: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/newsletter\n * Subscribe to newsletter\n */\ncontactRoutes.post(\n  '/newsletter',\n  strictLimiter,\n  validateBody(newsletterSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { email, name, source = 'footer' } = req.body;\n\n      // Check if already subscribed\n      const [existing] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.email, email.toLowerCase()));\n\n      if (existing) {\n        // If unsubscribed, resubscribe them\n        if (existing.status === 'unsubscribed') {\n          await db\n            .update(newsletterSubscribers)\n            .set({\n              status: 'active',\n              name: name || existing.name,\n              unsubscribedAt: null,\n              updatedAt: new Date(),\n            })\n            .where(eq(newsletterSubscribers.id, existing.id));\n\n          return sendSuccess(res, {\n            message: 'Welcome back! You have been resubscribed to our newsletter.',\n            subscribed: true,\n          });\n        }\n\n        // Already active\n        return sendSuccess(res, {\n          message: 'You are already subscribed to our newsletter.',\n          subscribed: true,\n        });\n      }\n\n      // Generate unsubscribe token\n      const unsubscribeToken = crypto.randomBytes(32).toString('hex');\n\n      // Create new subscriber\n      await db.insert(newsletterSubscribers).values({\n        email: email.toLowerCase(),\n        name: name || null,\n        source,\n        unsubscribeToken,\n        status: 'active',\n      });\n\n      sendSuccess(res, {\n        message: 'Successfully subscribed to the newsletter.',\n        subscribed: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/contact/newsletter/unsubscribe/:token\n * Get unsubscribe info (for unsubscribe page)\n */\ncontactRoutes.get(\n  '/newsletter/unsubscribe/:token',\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { token } = req.params;\n\n      const [subscriber] = await db\n        .select({ email: newsletterSubscribers.email, status: newsletterSubscribers.status })\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.unsubscribeToken, token));\n\n      if (!subscriber) {\n        throw new NotFoundError('Invalid unsubscribe link');\n      }\n\n      sendSuccess(res, {\n        email: subscriber.email,\n        status: subscriber.status,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/newsletter/unsubscribe/:token\n * Process unsubscribe request\n */\ncontactRoutes.post(\n  '/newsletter/unsubscribe/:token',\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { token } = req.params;\n\n      const [subscriber] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.unsubscribeToken, token));\n\n      if (!subscriber) {\n        throw new NotFoundError('Invalid unsubscribe link');\n      }\n\n      if (subscriber.status === 'unsubscribed') {\n        return sendSuccess(res, {\n          message: 'You have already unsubscribed from our newsletter.',\n          unsubscribed: true,\n        });\n      }\n\n      await db\n        .update(newsletterSubscribers)\n        .set({\n          status: 'unsubscribed',\n          unsubscribedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(newsletterSubscribers.id, subscriber.id));\n\n      sendSuccess(res, {\n        message: 'You have been successfully unsubscribed from our newsletter.',\n        unsubscribed: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/contact/quote-request\n * Request a quote\n */\ncontactRoutes.post(\n  '/quote-request',\n  strictLimiter,\n  validateBody(\n    z.object({\n      name: z.string().min(1).max(100),\n      email: z.string().email(),\n      phone: z.string().max(50).optional(),\n      company: z.string().max(255).optional(),\n      products: z\n        .array(\n          z.object({\n            productId: z.string().uuid(),\n            quantity: z.number().int().min(1),\n          })\n        )\n        .min(1),\n      message: z.string().max(2000).optional(),\n    })\n  ),\n  async (req, res, next) => {\n    try {\n      const { name, email, phone, company, products, message } = req.body;\n\n      // TODO: Create quotation in database\n      // TODO: Send notification email to admin\n      // TODO: Send confirmation email to customer\n\n      console.log('Quote request:', {\n        name,\n        email,\n        phone,\n        company,\n        productCount: products.length,\n        timestamp: new Date().toISOString(),\n      });\n\n      sendSuccess(res, {\n        message: 'Quote request received. We will contact you shortly with pricing.',\n        received: true,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport ImageKit from 'imagekit';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError } from '../utils/errors';\nimport { config } from '../config';\n\nexport const uploadRoutes = Router();\n\n// Initialize ImageKit\nlet imagekit: ImageKit | null = null;\n\nfunction getImageKit(): ImageKit {\n  if (!imagekit) {\n    if (\n      !config.imagekit.publicKey ||\n      !config.imagekit.privateKey ||\n      !config.imagekit.urlEndpoint\n    ) {\n      throw new BadRequestError('ImageKit is not configured');\n    }\n\n    imagekit = new ImageKit({\n      publicKey: config.imagekit.publicKey,\n      privateKey: config.imagekit.privateKey,\n      urlEndpoint: config.imagekit.urlEndpoint,\n    });\n  }\n  return imagekit;\n}\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst uploadSchema = z.object({\n  file: z.string().min(1), // Base64 encoded file\n  fileName: z.string().min(1).max(255),\n  folder: z.string().optional().default('/uploads'),\n});\n\nconst uploadUrlSchema = z.object({\n  url: z.string().url(),\n  fileName: z.string().min(1).max(255),\n  folder: z.string().optional().default('/uploads'),\n});\n\nconst deleteSchema = z.object({\n  fileId: z.string().min(1),\n});\n\n// ===========================================\n// Auth Required for All Routes\n// ===========================================\n\nuploadRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/upload/auth\n * Get ImageKit authentication parameters for client-side uploads\n */\nuploadRoutes.get('/auth', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const authParams = ik.getAuthenticationParameters();\n\n    sendSuccess(res, authParams);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/upload\n * Upload a file (base64)\n */\nuploadRoutes.post(\n  '/',\n  validateBody(uploadSchema),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { file, fileName, folder } = req.body;\n\n      const result = await ik.upload({\n        file,\n        fileName,\n        folder,\n        useUniqueFileName: true,\n      });\n\n      sendSuccess(res, {\n        fileId: result.fileId,\n        name: result.name,\n        url: result.url,\n        thumbnailUrl: result.thumbnailUrl,\n        filePath: result.filePath,\n        fileType: result.fileType,\n        size: result.size,\n        width: result.width,\n        height: result.height,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/upload/from-url\n * Upload a file from URL\n */\nuploadRoutes.post(\n  '/from-url',\n  validateBody(uploadUrlSchema),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { url, fileName, folder } = req.body;\n\n      const result = await ik.upload({\n        file: url,\n        fileName,\n        folder,\n        useUniqueFileName: true,\n      });\n\n      sendSuccess(res, {\n        fileId: result.fileId,\n        name: result.name,\n        url: result.url,\n        thumbnailUrl: result.thumbnailUrl,\n        filePath: result.filePath,\n        fileType: result.fileType,\n        size: result.size,\n        width: result.width,\n        height: result.height,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/upload/:fileId\n * Delete a file\n */\nuploadRoutes.delete('/:fileId', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { fileId } = req.params;\n\n    await ik.deleteFile(fileId);\n\n    sendSuccess(res, { message: 'File deleted successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/upload/list\n * List files in a folder\n */\nuploadRoutes.get('/list', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { folder, limit, skip } = req.query;\n\n    const files = await ik.listFiles({\n      path: (folder as string) || '/uploads',\n      limit: limit ? parseInt(limit as string) : 20,\n      skip: skip ? parseInt(skip as string) : 0,\n    });\n\n    sendSuccess(res, files);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/upload/:fileId\n * Get file details\n */\nuploadRoutes.get('/:fileId', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { fileId } = req.params;\n\n    const file = await ik.getFileDetails(fileId);\n\n    sendSuccess(res, file);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/upload/bulk-delete\n * Delete multiple files\n */\nuploadRoutes.post(\n  '/bulk-delete',\n  validateBody(z.object({ fileIds: z.array(z.string()).min(1).max(100) })),\n  async (req, res, next) => {\n    try {\n      const ik = getImageKit();\n      const { fileIds } = req.body;\n\n      await ik.bulkDeleteFiles(fileIds);\n\n      sendSuccess(res, {\n        message: `${fileIds.length} files deleted successfully`,\n        deletedCount: fileIds.length,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/upload/transform\n * Get transformed image URL\n */\nuploadRoutes.get('/transform/:filePath(*)', async (req, res, next) => {\n  try {\n    const ik = getImageKit();\n    const { filePath } = req.params;\n    const { width, height, quality, format, crop } = req.query;\n\n    const transformations: Array<{ width?: number; height?: number; quality?: number; format?: string; cropMode?: string }> = [];\n\n    if (width || height || quality || format || crop) {\n      const transform: typeof transformations[0] = {};\n      if (width) {transform.width = parseInt(width as string);}\n      if (height) {transform.height = parseInt(height as string);}\n      if (quality) {transform.quality = parseInt(quality as string);}\n      if (format) {transform.format = format as string;}\n      if (crop) {transform.cropMode = crop as string;}\n      transformations.push(transform);\n    }\n\n    const url = ik.url({\n      path: `/${filePath}`,\n      transformation: transformations.length > 0 ? transformations : undefined,\n    });\n\n    sendSuccess(res, { url });\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { checkDbHealth, verifySchema, testConnection } from '../utils/db-health';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\n\nexport const healthRoutes = Router();\n\n/**\n * GET /api/health\n * Basic health check (public)\n */\nhealthRoutes.get('/', async (_req, res) => {\n  const dbConnected = await testConnection();\n\n  res.json({\n    status: dbConnected ? 'ok' : 'degraded',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    database: dbConnected ? 'connected' : 'disconnected',\n  });\n});\n\n/**\n * GET /api/health/detailed\n * Detailed health check (admin only)\n */\nhealthRoutes.get('/detailed', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const dbHealth = await checkDbHealth();\n    const schemaStatus = await verifySchema();\n\n    sendSuccess(res, {\n      status: dbHealth.connected && schemaStatus.valid ? 'healthy' : 'unhealthy',\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n      memory: {\n        heapUsed: Math.round(process.memoryUsage().heapUsed / 1024 / 1024),\n        heapTotal: Math.round(process.memoryUsage().heapTotal / 1024 / 1024),\n        rss: Math.round(process.memoryUsage().rss / 1024 / 1024),\n      },\n      database: {\n        connected: dbHealth.connected,\n        latency: dbHealth.latency,\n        version: dbHealth.version,\n        error: dbHealth.error,\n      },\n      schema: {\n        valid: schemaStatus.valid,\n        tablesCount: dbHealth.tables.length,\n        missingTables: schemaStatus.missingTables,\n      },\n      environment: process.env['NODE_ENV'] || 'development',\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/health/ready\n * Readiness probe for Kubernetes/Docker\n */\nhealthRoutes.get('/ready', async (_req, res) => {\n  const dbConnected = await testConnection();\n\n  if (dbConnected) {\n    res.status(200).json({ ready: true });\n  } else {\n    res.status(503).json({ ready: false, reason: 'Database not connected' });\n  }\n});\n\n/**\n * GET /api/health/live\n * Liveness probe for Kubernetes/Docker\n */\nhealthRoutes.get('/live', (_req, res) => {\n  res.status(200).json({ alive: true });\n});\n","/**\n * Database Health Check Utility\n * Verifies NeonDB connection and schema integrity\n */\n\nimport { getDb, sql } from '@lab404/database';\n\nexport interface DbHealthStatus {\n  connected: boolean;\n  latency: number;\n  version: string;\n  tables: string[];\n  error?: string;\n}\n\n/**\n * Check database connection and health\n */\nexport async function checkDbHealth(): Promise<DbHealthStatus> {\n  const startTime = Date.now();\n\n  try {\n    const db = getDb();\n\n    // Test connection with simple query\n    const versionResult = await db.execute(sql`SELECT version()`);\n    const rows = versionResult.rows as Array<{ version: string }>;\n    const version = rows[0]?.version || 'unknown';\n\n    const latency = Date.now() - startTime;\n\n    // Get list of tables\n    const tablesResult = await db.execute(sql`\n      SELECT table_name\n      FROM information_schema.tables\n      WHERE table_schema = 'public'\n      ORDER BY table_name\n    `);\n\n    const tableRows = tablesResult.rows as Array<{ table_name: string }>;\n    const tables = tableRows.map(t => t.table_name);\n\n    return {\n      connected: true,\n      latency,\n      version,\n      tables,\n    };\n  } catch (error) {\n    return {\n      connected: false,\n      latency: Date.now() - startTime,\n      version: 'unknown',\n      tables: [],\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Verify all required tables exist\n */\nexport async function verifySchema(): Promise<{\n  valid: boolean;\n  missingTables: string[];\n  extraTables: string[];\n}> {\n  const requiredTables = [\n    'addresses',\n    'admin_activity_logs',\n    'blogs',\n    'cart_items',\n    'cart_promo_codes',\n    'carts',\n    'categories',\n    'customers',\n    'order_items',\n    'orders',\n    'product_import_jobs',\n    'product_variants',\n    'products',\n    'promo_codes',\n    'quotation_items',\n    'quotations',\n    'settings',\n  ];\n\n  try {\n    const health = await checkDbHealth();\n\n    if (!health.connected) {\n      return {\n        valid: false,\n        missingTables: requiredTables,\n        extraTables: [],\n      };\n    }\n\n    const existingTables = new Set(health.tables);\n    const missingTables = requiredTables.filter(t => !existingTables.has(t));\n    const extraTables = health.tables.filter(t => !requiredTables.includes(t));\n\n    return {\n      valid: missingTables.length === 0,\n      missingTables,\n      extraTables,\n    };\n  } catch (error) {\n    return {\n      valid: false,\n      missingTables: requiredTables,\n      extraTables: [],\n    };\n  }\n}\n\n/**\n * Run database connection test\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const db = getDb();\n    await db.execute(sql`SELECT 1`);\n    return true;\n  } catch {\n    return false;\n  }\n}\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { notificationService, NotificationType } from '../services/notification.service';\nimport { mailerService } from '../services/mailer.service';\nimport { validateBody } from '../middleware/validator';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\n\nconst router = Router();\n\n// Schema for updating notification settings\nconst updateSettingsSchema = z.object({\n  enabled: z.boolean().optional(),\n  adminEmails: z.array(z.string().email()).optional(),\n  notifications: z.object({\n    new_order: z.boolean().optional(),\n    order_status_change: z.boolean().optional(),\n    low_stock_alert: z.boolean().optional(),\n    new_customer: z.boolean().optional(),\n    new_contact_message: z.boolean().optional(),\n    quotation_request: z.boolean().optional(),\n    payment_received: z.boolean().optional(),\n    refund_processed: z.boolean().optional(),\n  }).optional(),\n});\n\n// Schema for sending test notification\nconst testNotificationSchema = z.object({\n  type: z.enum([\n    'new_order',\n    'order_status_change',\n    'low_stock_alert',\n    'new_customer',\n    'new_contact_message',\n    'quotation_request',\n    'payment_received',\n    'refund_processed',\n  ]),\n  email: z.string().email().optional(),\n});\n\n/**\n * @route GET /api/notifications/settings\n * @desc Get notification settings\n * @access Admin\n */\nrouter.get('/settings', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const settings = notificationService.getSettings();\n    const smtpConfigured = mailerService.isReady();\n\n    sendSuccess(res, {\n      ...settings,\n      smtpConfigured,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * @route PUT /api/notifications/settings\n * @desc Update notification settings\n * @access Admin\n */\nrouter.put(\n  '/settings',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateSettingsSchema),\n  async (req, res, next) => {\n    try {\n      const updates = req.body;\n      notificationService.updateSettings(updates);\n\n      sendSuccess(res, {\n        message: 'Notification settings updated successfully',\n        settings: notificationService.getSettings(),\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * @route POST /api/notifications/test\n * @desc Send a test notification\n * @access Admin\n */\nrouter.post(\n  '/test',\n  requireAuth,\n  requireAdmin,\n  validateBody(testNotificationSchema),\n  async (req, res, next) => {\n    try {\n      const { type, email } = req.body;\n\n      if (!mailerService.isReady()) {\n        return sendError(res, 400, 'SMTP_NOT_CONFIGURED', 'SMTP not configured. Please configure SMTP settings first.');\n      }\n\n      // Test data for different notification types\n      const testData: Record<NotificationType, Record<string, string | number>> = {\n        new_order: {\n          orderId: 'TEST-001',\n          customerName: 'Test Customer',\n          customerEmail: 'test@example.com',\n          total: '299.99',\n          itemCount: 3,\n        },\n        order_status_change: {\n          orderId: 'TEST-001',\n          previousStatus: 'pending',\n          newStatus: 'processing',\n        },\n        low_stock_alert: {\n          productId: 'prod_123',\n          productName: 'Arduino Uno R3',\n          sku: 'ARD-UNO-R3',\n          currentStock: 5,\n          threshold: 10,\n        },\n        new_customer: {\n          customerId: 'cust_123',\n          customerName: 'John Doe',\n          customerEmail: 'john@example.com',\n        },\n        new_contact_message: {\n          name: 'Jane Smith',\n          email: 'jane@example.com',\n          subject: 'Product Inquiry',\n          message: 'I would like to know more about your Arduino kits.',\n        },\n        quotation_request: {\n          quotationId: 'QT-001',\n          customerName: 'Acme Corp',\n          customerEmail: 'purchasing@acme.com',\n          itemCount: 5,\n        },\n        payment_received: {\n          orderId: 'ORD-001',\n          amount: '499.99',\n          paymentMethod: 'Credit Card',\n          transactionId: 'txn_abc123',\n        },\n        refund_processed: {\n          orderId: 'ORD-001',\n          amount: '99.99',\n          reason: 'Customer requested cancellation',\n        },\n      };\n\n      // Temporarily override admin emails if a test email is provided\n      const originalSettings = notificationService.getSettings();\n      if (email) {\n        notificationService.updateSettings({ adminEmails: [email] });\n      }\n\n      const success = await notificationService.notify(type as NotificationType, testData[type as NotificationType]);\n\n      // Restore original settings\n      if (email) {\n        notificationService.updateSettings({ adminEmails: originalSettings.adminEmails });\n      }\n\n      if (success) {\n        sendSuccess(res, {\n          message: `Test ${type} notification sent successfully`,\n          sentTo: email || originalSettings.adminEmails,\n        });\n      } else {\n        sendError(res, 500, 'NOTIFICATION_FAILED', 'Failed to send test notification');\n      }\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * @route POST /api/notifications/verify-smtp\n * @desc Verify SMTP connection\n * @access Admin\n */\nrouter.post('/verify-smtp', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const isConnected = await mailerService.verifyConnection();\n\n    if (isConnected) {\n      sendSuccess(res, {\n        message: 'SMTP connection verified successfully',\n        connected: true,\n      });\n    } else {\n      sendError(res, 400, 'SMTP_CONNECTION_FAILED', 'SMTP connection failed. Please check your settings.');\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\nexport default router;\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { searchService } from '../services';\n\nexport const searchRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst searchQuerySchema = z.object({\n    q: z.string().min(1).max(200),\n    limit: z.coerce.number().min(1).max(100).optional(),\n    offset: z.coerce.number().min(0).optional(),\n    category: z.string().optional(),\n    minPrice: z.coerce.number().optional(),\n    maxPrice: z.coerce.number().optional(),\n    inStock: z.string().optional(),\n    brand: z.string().optional(),\n    sort: z.enum(['name:asc', 'name:desc', 'basePrice:asc', 'basePrice:desc', 'createdAt:desc']).optional(),\n    facets: z.string().optional(), // comma-separated list of facet fields\n});\n\nconst autocompleteSchema = z.object({\n    q: z.string().min(1).max(100),\n    limit: z.coerce.number().min(1).max(10).optional(),\n});\n\n// ===========================================\n// Public Routes\n// ===========================================\n\n/**\n * GET /api/search\n * Full-text product search with filters and facets\n */\nsearchRoutes.get('/', validateQuery(searchQuerySchema), async (req, res, next) => {\n    try {\n        const { q, limit = 20, offset = 0, category, minPrice, maxPrice, inStock, brand, sort, facets } = req.query;\n\n        // Check if Meilisearch is available\n        const isAvailable = await searchService.isAvailable();\n        if (!isAvailable) {\n            return sendSuccess(res, {\n                hits: [],\n                query: q as string,\n                processingTimeMs: 0,\n                estimatedTotalHits: 0,\n                limit: Number(limit),\n                offset: Number(offset),\n                error: 'Search service temporarily unavailable',\n            });\n        }\n\n        // Build filters\n        const filters: string[] = [];\n\n        if (category) {\n            filters.push(`categorySlug = \"${category}\"`);\n        }\n\n        if (minPrice !== undefined) {\n            filters.push(`basePrice >= ${minPrice}`);\n        }\n\n        if (maxPrice !== undefined) {\n            filters.push(`basePrice <= ${maxPrice}`);\n        }\n\n        if (inStock === 'true') {\n            filters.push('inStock = true');\n        }\n\n        if (brand) {\n            filters.push(`brand = \"${brand}\"`);\n        }\n\n        // Build sort array\n        const sortArray: string[] = [];\n        if (sort) {\n            sortArray.push(sort as string);\n        }\n\n        // Build facets array\n        const facetFields = facets ? (facets as string).split(',') : ['categorySlug', 'brand', 'inStock'];\n\n        // Perform search\n        const result = await searchService.searchProducts(q as string, {\n            limit: Number(limit),\n            offset: Number(offset),\n            filters,\n            sort: sortArray,\n            facets: facetFields,\n        });\n\n        sendSuccess(res, result);\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * GET /api/search/autocomplete\n * Quick autocomplete suggestions\n */\nsearchRoutes.get('/autocomplete', validateQuery(autocompleteSchema), async (req, res, next) => {\n    try {\n        const { q, limit = 5 } = req.query;\n\n        // Check if Meilisearch is available\n        const isAvailable = await searchService.isAvailable();\n        if (!isAvailable) {\n            return sendSuccess(res, { suggestions: [] });\n        }\n\n        const result = await searchService.searchProducts(q as string, {\n            limit: Number(limit),\n            offset: 0,\n        });\n\n        // Return simplified suggestions\n        const suggestions = result.hits.map(hit => ({\n            id: hit.id,\n            name: hit.name,\n            slug: hit.slug,\n            thumbnailUrl: hit.thumbnailUrl,\n            basePrice: hit.basePrice,\n            categoryName: hit.categoryName,\n        }));\n\n        sendSuccess(res, { suggestions, query: q });\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * GET /api/search/health\n * Check search service health\n */\nsearchRoutes.get('/health', async (req, res, next) => {\n    try {\n        const isAvailable = await searchService.isAvailable();\n        const stats = isAvailable ? await searchService.getIndexStats() : null;\n\n        sendSuccess(res, {\n            available: isAvailable,\n            stats,\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * POST /api/search/sync\n * Sync all products to search index (Admin only)\n */\nsearchRoutes.post('/sync', requireAuth, requireAdmin, async (req, res, next) => {\n    try {\n        // Initialize the index if needed\n        await searchService.initialize();\n\n        // Sync all products\n        const result = await searchService.syncAllProducts();\n\n        sendSuccess(res, {\n            message: 'Products synced successfully',\n            ...result,\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n\n/**\n * POST /api/search/initialize\n * Initialize search index with settings (Admin only)\n */\nsearchRoutes.post('/initialize', requireAuth, requireAdmin, async (req, res, next) => {\n    try {\n        await searchService.initialize();\n\n        sendSuccess(res, {\n            message: 'Search index initialized successfully',\n        });\n    } catch (error) {\n        next(error);\n    }\n});\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { z } from 'zod';\nimport { google } from 'googleapis';\nimport ImageKit from 'imagekit';\nimport { config } from '../config';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { validateQuery, validateBody } from '../middleware/validator';\nimport { sendSuccess } from '../utils/response';\nimport { BadRequestError } from '../utils/errors';\n\nexport const googleImagesRoutes = Router();\n\n// ===========================================\n// ImageKit Instance\n// ===========================================\n\nlet imagekit: ImageKit | null = null;\n\nfunction getImageKit(): ImageKit {\n  if (!imagekit) {\n    if (\n      !config.imagekit.publicKey ||\n      !config.imagekit.privateKey ||\n      !config.imagekit.urlEndpoint\n    ) {\n      throw new BadRequestError('ImageKit is not configured');\n    }\n\n    imagekit = new ImageKit({\n      publicKey: config.imagekit.publicKey,\n      privateKey: config.imagekit.privateKey,\n      urlEndpoint: config.imagekit.urlEndpoint,\n    });\n  }\n  return imagekit;\n}\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst searchQuerySchema = z.object({\n  query: z.string().min(1, 'Search query is required').max(200, 'Query too long'),\n  limit: z.string().optional().transform(val => Math.min(parseInt(val || '10', 10), 10)),\n  start: z.string().optional().transform(val => Math.max(parseInt(val || '1', 10), 1)),\n  safeSearch: z.enum(['off', 'medium', 'high']).optional().default('medium'),\n  imageSize: z.enum(['huge', 'icon', 'large', 'medium', 'small', 'xlarge', 'xxlarge']).optional(),\n  imageType: z.enum(['clipart', 'face', 'lineart', 'stock', 'photo', 'animated']).optional(),\n  fileType: z.enum(['jpg', 'png', 'gif', 'bmp', 'svg', 'webp', 'ico']).optional(),\n});\n\nconst downloadSchema = z.object({\n  imageUrl: z.string().url('Invalid image URL').optional(),\n  imageUrls: z.array(z.string().url('Invalid image URL')).max(10, 'Maximum 10 images per batch').optional(),\n  folder: z.string().optional().default('/products'),\n});\n\n// Cache for search results\ninterface CacheEntry {\n  data: any;\n  timestamp: number;\n}\n\nconst CACHE_TTL = 5 * 60 * 1000; // 5 minutes\nconst searchCache = new Map<string, CacheEntry>();\n\n// Initialize Google Custom Search client\nlet customSearch: any = null;\n\nfunction getCustomSearchClient() {\n  if (!customSearch) {\n    customSearch = google.customsearch('v1');\n  }\n  return customSearch;\n}\n\n// Generate cache key\nfunction generateCacheKey(options: any): string {\n  return JSON.stringify({\n    q: options.query,\n    start: options.start || 1,\n    num: options.limit || 10,\n    safe: options.safeSearch || 'medium',\n    imgSize: options.imageSize,\n    imgType: options.imageType,\n    fileType: options.fileType,\n  });\n}\n\n// ===========================================\n// Routes\n// ===========================================\n\n/**\n * GET /api/google-images/search\n * Search Google Images with filters and pagination\n */\ngoogleImagesRoutes.get(\n  '/search',\n  requireAuth,\n  requireAdmin,\n  validateQuery(searchQuerySchema),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { query, limit, start, safeSearch, imageSize, imageType, fileType } = req.query as any;\n\n      // Check if Google API is configured\n      if (!config.google.apiKey || !config.google.searchEngineId) {\n        throw new BadRequestError('Google API is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID environment variables.');\n      }\n\n      // Generate cache key\n      const cacheKey = generateCacheKey({ query, limit, start, safeSearch, imageSize, imageType, fileType });\n\n      // Check cache\n      const cached = searchCache.get(cacheKey);\n      if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n        return sendSuccess(res, cached.data);\n      }\n\n      // Initialize client\n      const client = getCustomSearchClient();\n\n      // Build search params\n      const searchParams: any = {\n        auth: config.google.apiKey,\n        cx: config.google.searchEngineId,\n        q: query,\n        searchType: 'image',\n        num: limit || 10,\n        start: start || 1,\n        safe: safeSearch || 'medium',\n      };\n\n      if (imageSize) {searchParams.imgSize = imageSize;}\n      if (imageType) {searchParams.imgType = imageType;}\n      if (fileType) {searchParams.fileType = fileType;}\n\n      // Execute search\n      const response = await client.cse.list(searchParams);\n\n      if (!response || !response.data) {\n        throw new BadRequestError('Invalid response from Google API');\n      }\n\n      const result = {\n        query,\n        results: (response.data.items || []).map((item: any) => ({\n          title: item.title,\n          link: item.link,\n          thumbnail: item.image?.thumbnailLink,\n          displayLink: item.displayLink,\n          snippet: item.snippet,\n          mime: item.mime,\n          image: {\n            contextLink: item.image?.contextLink,\n            height: item.image?.height,\n            width: item.image?.width,\n            byteSize: item.image?.byteSize,\n            thumbnailLink: item.image?.thumbnailLink,\n            thumbnailHeight: item.image?.thumbnailHeight,\n            thumbnailWidth: item.image?.thumbnailWidth,\n          },\n        })),\n        totalResults: response.data.searchInformation?.totalResults || '0',\n        searchTime: response.data.searchInformation?.searchTime || 0,\n        pagination: {\n          start: start || 1,\n          limit: limit || 10,\n          hasNextPage: !!response.data.queries?.nextPage,\n          nextStart: response.data.queries?.nextPage?.[0]?.startIndex,\n        },\n      };\n\n      // Cache the result\n      searchCache.set(cacheKey, { data: result, timestamp: Date.now() });\n\n      // Clean old cache entries\n      if (searchCache.size > 100) {\n        const oldestKey = Array.from(searchCache.entries())\n          .sort((a, b) => a[1].timestamp - b[1].timestamp)[0][0];\n        searchCache.delete(oldestKey);\n      }\n\n      sendSuccess(res, result);\n    } catch (error: any) {\n      // Handle specific Google API errors\n      if (error.code === 429) {\n        return next(new BadRequestError('Daily API quota exceeded. Please try again tomorrow.'));\n      }\n      if (error.code === 403) {\n        return next(new BadRequestError('Invalid API credentials. Please check your Google API configuration.'));\n      }\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/google-images/upload-to-imagekit\n * Download images from URLs and upload to ImageKit\n * Returns ImageKit URLs to be saved in the database\n */\ngoogleImagesRoutes.post(\n  '/upload-to-imagekit',\n  requireAuth,\n  requireAdmin,\n  validateBody(downloadSchema),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { imageUrl, imageUrls, folder } = req.body;\n\n      // Determine if single or batch upload\n      const urls: string[] = imageUrls || (imageUrl ? [imageUrl] : []);\n\n      if (urls.length === 0) {\n        throw new BadRequestError('At least one image URL is required');\n      }\n\n      const ik = getImageKit();\n\n      const results = await Promise.all(\n        urls.map(async (url: string, index: number) => {\n          try {\n            // Generate unique filename\n            const timestamp = Date.now();\n            const random = Math.random().toString(36).substring(2, 8);\n            const urlPath = new URL(url).pathname;\n            const extension = urlPath.split('.').pop()?.toLowerCase() || 'jpg';\n            const fileName = `google-image-${timestamp}-${index}-${random}.${extension}`;\n\n            // Upload to ImageKit using URL\n            const uploadResult = await ik.upload({\n              file: url, // ImageKit accepts URL directly\n              fileName,\n              folder: folder || '/products',\n              useUniqueFileName: true,\n              tags: ['google-images', 'product-image'],\n            });\n\n            return {\n              success: true,\n              originalUrl: url,\n              imagekitUrl: uploadResult.url,\n              imagekitFileId: uploadResult.fileId,\n              thumbnailUrl: uploadResult.thumbnailUrl,\n              metadata: {\n                width: uploadResult.width,\n                height: uploadResult.height,\n                size: uploadResult.size,\n                fileType: uploadResult.fileType,\n                filePath: uploadResult.filePath,\n              },\n            };\n          } catch (error: any) {\n            console.error(`Failed to upload image: ${url}`, error.message);\n            return {\n              success: false,\n              originalUrl: url,\n              error: error.message || 'Upload failed',\n            };\n          }\n        })\n      );\n\n      const successCount = results.filter((r) => r.success).length;\n      const failureCount = results.length - successCount;\n\n      // Extract just the successful ImageKit URLs for easy access\n      const imagekitUrls = results\n        .filter((r) => r.success)\n        .map((r) => r.imagekitUrl);\n\n      sendSuccess(res, {\n        results,\n        imagekitUrls, // Array of successful ImageKit URLs ready to use\n        summary: {\n          total: results.length,\n          success: successCount,\n          failed: failureCount,\n        },\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/google-images/cache-stats\n * Get cache statistics (Admin only)\n */\ngoogleImagesRoutes.get(\n  '/cache-stats',\n  requireAuth,\n  requireAdmin,\n  async (_req: Request, res: Response) => {\n    const now = Date.now();\n    const entries = Array.from(searchCache.entries()).map(([key, entry]) => {\n      const parsed = JSON.parse(key);\n      return {\n        query: parsed.q,\n        age: Math.floor((now - entry.timestamp) / 1000),\n      };\n    });\n\n    sendSuccess(res, {\n      size: searchCache.size,\n      ttl: Math.floor(CACHE_TTL / 1000),\n      entries,\n    });\n  }\n);\n\n/**\n * DELETE /api/google-images/cache\n * Clear the search cache (Admin only)\n */\ngoogleImagesRoutes.delete(\n  '/cache',\n  requireAuth,\n  requireAdmin,\n  async (_req: Request, res: Response) => {\n    const size = searchCache.size;\n    searchCache.clear();\n    sendSuccess(res, { cleared: size });\n  }\n);\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { getDb, pdfTemplates, eq, desc, sql } from '@lab404/database';\nimport { validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, sendNoContent, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { NotFoundError, BadRequestError } from '../utils/errors';\n\nexport const pdfTemplatesRoutes = Router();\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst createTemplateSchema = z.object({\n  name: z.string().min(1).max(100),\n  isDefault: z.boolean().optional().default(false),\n  logoUrl: z.string().max(500).optional().nullable(),\n  primaryColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional().default('#1a1a2e'),\n  accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional().default('#0066cc'),\n  showCompanyLogo: z.boolean().optional().default(true),\n  showLineItemImages: z.boolean().optional().default(false),\n  showLineItemDescription: z.boolean().optional().default(false),\n  showSku: z.boolean().optional().default(true),\n  headerText: z.string().max(500).optional().nullable(),\n  footerText: z.string().max(500).optional().nullable(),\n  thankYouMessage: z.string().max(500).optional().nullable(),\n});\n\nconst updateTemplateSchema = z.object({\n  name: z.string().min(1).max(100).optional(),\n  isDefault: z.boolean().optional(),\n  logoUrl: z.string().max(500).optional().nullable(),\n  primaryColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional(),\n  accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional(),\n  showCompanyLogo: z.boolean().optional(),\n  showLineItemImages: z.boolean().optional(),\n  showLineItemDescription: z.boolean().optional(),\n  showSku: z.boolean().optional(),\n  headerText: z.string().max(500).optional().nullable(),\n  footerText: z.string().max(500).optional().nullable(),\n  thankYouMessage: z.string().max(500).optional().nullable(),\n});\n\n// ===========================================\n// Admin Routes\n// ===========================================\n\n/**\n * GET /api/pdf-templates\n * Get all PDF templates (Admin only)\n */\npdfTemplatesRoutes.get('/', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(pdfTemplates);\n    const count = countResult[0]?.count ?? 0;\n\n    const templates = await db\n      .select()\n      .from(pdfTemplates)\n      .orderBy(desc(pdfTemplates.isDefault), desc(pdfTemplates.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, templates, 200, createPaginationMeta(page, limit, Number(count)));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/pdf-templates/default\n * Get the default PDF template (Admin only)\n */\npdfTemplatesRoutes.get('/default', requireAuth, requireAdmin, async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    const [template] = await db\n      .select()\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.isDefault, true))\n      .limit(1);\n\n    if (!template) {\n      // Return default built-in values\n      return sendSuccess(res, {\n        id: null,\n        name: 'Default Template',\n        isDefault: true,\n        primaryColor: '#1a1a2e',\n        accentColor: '#0066cc',\n        showCompanyLogo: true,\n        showLineItemImages: false,\n        showLineItemDescription: false,\n        showSku: true,\n        headerText: null,\n        footerText: null,\n        thankYouMessage: null,\n      });\n    }\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/pdf-templates/:id\n * Get single PDF template (Admin only)\n */\npdfTemplatesRoutes.get('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    const [template] = await db\n      .select()\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!template) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/pdf-templates\n * Create new PDF template (Admin only)\n */\npdfTemplatesRoutes.post(\n  '/',\n  requireAuth,\n  requireAdmin,\n  validateBody(createTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const data = req.body;\n\n      // If this is being set as default, unset other defaults\n      if (data.isDefault) {\n        await db\n          .update(pdfTemplates)\n          .set({ isDefault: false, updatedAt: new Date() })\n          .where(eq(pdfTemplates.isDefault, true));\n      }\n\n      const [template] = await db\n        .insert(pdfTemplates)\n        .values({\n          name: data.name,\n          isDefault: data.isDefault || false,\n          logoUrl: data.logoUrl,\n          primaryColor: data.primaryColor || '#1a1a2e',\n          accentColor: data.accentColor || '#0066cc',\n          showCompanyLogo: data.showCompanyLogo ?? true,\n          showLineItemImages: data.showLineItemImages ?? false,\n          showLineItemDescription: data.showLineItemDescription ?? false,\n          showSku: data.showSku ?? true,\n          headerText: data.headerText,\n          footerText: data.footerText,\n          thankYouMessage: data.thankYouMessage,\n        })\n        .returning();\n\n      sendSuccess(res, template, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/pdf-templates/:id\n * Update PDF template (Admin only)\n */\npdfTemplatesRoutes.put(\n  '/:id',\n  requireAuth,\n  requireAdmin,\n  validateBody(updateTemplateSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const id = req.params['id'] as string;\n      const data = req.body;\n\n      // Check exists\n      const [existing] = await db\n        .select({ id: pdfTemplates.id })\n        .from(pdfTemplates)\n        .where(eq(pdfTemplates.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('PDF template not found');\n      }\n\n      // If this is being set as default, unset other defaults\n      if (data.isDefault) {\n        await db\n          .update(pdfTemplates)\n          .set({ isDefault: false, updatedAt: new Date() })\n          .where(eq(pdfTemplates.isDefault, true));\n      }\n\n      const updateData: Record<string, unknown> = {\n        updatedAt: new Date(),\n      };\n\n      if (data.name !== undefined) {updateData.name = data.name;}\n      if (data.isDefault !== undefined) {updateData.isDefault = data.isDefault;}\n      if (data.logoUrl !== undefined) {updateData.logoUrl = data.logoUrl;}\n      if (data.primaryColor !== undefined) {updateData.primaryColor = data.primaryColor;}\n      if (data.accentColor !== undefined) {updateData.accentColor = data.accentColor;}\n      if (data.showCompanyLogo !== undefined) {updateData.showCompanyLogo = data.showCompanyLogo;}\n      if (data.showLineItemImages !== undefined) {updateData.showLineItemImages = data.showLineItemImages;}\n      if (data.showLineItemDescription !== undefined) {updateData.showLineItemDescription = data.showLineItemDescription;}\n      if (data.showSku !== undefined) {updateData.showSku = data.showSku;}\n      if (data.headerText !== undefined) {updateData.headerText = data.headerText;}\n      if (data.footerText !== undefined) {updateData.footerText = data.footerText;}\n      if (data.thankYouMessage !== undefined) {updateData.thankYouMessage = data.thankYouMessage;}\n\n      const [template] = await db\n        .update(pdfTemplates)\n        .set(updateData)\n        .where(eq(pdfTemplates.id, id))\n        .returning();\n\n      sendSuccess(res, template);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/pdf-templates/:id\n * Delete PDF template (Admin only)\n */\npdfTemplatesRoutes.delete('/:id', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Check exists\n    const [existing] = await db\n      .select({ id: pdfTemplates.id, isDefault: pdfTemplates.isDefault })\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    if (existing.isDefault) {\n      throw new BadRequestError('Cannot delete the default template. Set another template as default first.');\n    }\n\n    await db.delete(pdfTemplates).where(eq(pdfTemplates.id, id));\n\n    sendNoContent(res);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/pdf-templates/:id/set-default\n * Set template as default (Admin only)\n */\npdfTemplatesRoutes.post('/:id/set-default', requireAuth, requireAdmin, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const id = req.params['id'] as string;\n\n    // Check exists\n    const [existing] = await db\n      .select({ id: pdfTemplates.id })\n      .from(pdfTemplates)\n      .where(eq(pdfTemplates.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('PDF template not found');\n    }\n\n    // Unset all defaults\n    await db\n      .update(pdfTemplates)\n      .set({ isDefault: false, updatedAt: new Date() })\n      .where(eq(pdfTemplates.isDefault, true));\n\n    // Set this as default\n    const [template] = await db\n      .update(pdfTemplates)\n      .set({ isDefault: true, updatedAt: new Date() })\n      .where(eq(pdfTemplates.id, id))\n      .returning();\n\n    sendSuccess(res, template);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router, Request, Response, NextFunction } from 'express';\nimport { getDb, quotations, settings, newsletterCampaigns, newsletterSends, newsletterSubscribers, eq, and, lte, gte, sql, asc } from '@lab404/database';\nimport { sendSuccess, sendError } from '../utils/response';\nimport { notificationService } from '../services/notification.service';\nimport { quotationActivityService } from '../services/quotation-activity.service';\nimport { verificationCodeService } from '../services';\nimport { mailerService } from '../services/mailer.service';\nimport { logger } from '../utils/logger';\nimport { cronLimiter } from '../middleware/rateLimiter';\n\nexport const cronRoutes = Router();\n\n// Apply rate limiting to all cron routes\ncronRoutes.use(cronLimiter);\n\n// Middleware to verify cron secret (for security)\nconst verifyCronSecret = (req: Request, res: Response, next: NextFunction) => {\n  const cronSecret = req.headers['x-cron-secret'] || req.query.secret;\n  const expectedSecret = process.env['CRON_SECRET'];\n\n  // CRON_SECRET is required in all environments (no dev bypass for security)\n  if (!expectedSecret) {\n    logger.error('CRON_SECRET not configured');\n    return sendError(res, 503, 'CRON_NOT_CONFIGURED', 'Cron jobs not configured');\n  }\n\n  if (cronSecret !== expectedSecret) {\n    logger.warn('Invalid cron secret attempt', { ip: req.ip });\n    return sendError(res, 403, 'FORBIDDEN', 'Forbidden');\n  }\n\n  next();\n};\n\ninterface ExpiryNotificationResult {\n  quotationId: string;\n  quotationNumber: string;\n  customerEmail: string;\n  daysUntilExpiry: number;\n  status: 'sent' | 'failed';\n  error?: string;\n}\n\n/**\n * POST /api/cron/quotation-expiry-check\n * Check for quotations expiring soon and send notifications\n *\n * Should be called daily by a cron job (e.g., Vercel cron, GitHub Actions, or external service)\n */\ncronRoutes.post('/quotation-expiry-check', verifyCronSecret, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const results: ExpiryNotificationResult[] = [];\n\n    // Define expiry windows (days from now)\n    const expiryWindows = [1, 3, 7];\n\n    for (const days of expiryWindows) {\n      // Calculate the target date range\n      const targetDateStart = new Date(now);\n      targetDateStart.setDate(targetDateStart.getDate() + days);\n      targetDateStart.setHours(0, 0, 0, 0);\n\n      const targetDateEnd = new Date(targetDateStart);\n      targetDateEnd.setHours(23, 59, 59, 999);\n\n      // Find quotations expiring on this day\n      // Only check 'sent' status quotations (not draft, accepted, etc.)\n      const expiringQuotations = await db\n        .select()\n        .from(quotations)\n        .where(\n          and(\n            eq(quotations.status, 'sent'),\n            gte(quotations.validUntil, targetDateStart),\n            lte(quotations.validUntil, targetDateEnd)\n          )\n        );\n\n      logger.info(`Found ${expiringQuotations.length} quotations expiring in ${days} day(s)`);\n\n      for (const quotation of expiringQuotations) {\n        try {\n          // Send expiry notification email\n          await notificationService.sendQuotationExpiryReminder(\n            quotation.customerEmail,\n            quotation.customerName,\n            quotation.quotationNumber,\n            days,\n            quotation.validUntil!,\n            quotation.acceptanceToken || undefined\n          );\n\n          // Log activity\n          await quotationActivityService.logActivity({\n            quotationId: quotation.id,\n            activityType: 'note_added',\n            description: `Expiry reminder sent (${days} day${days === 1 ? '' : 's'} remaining)`,\n            actorType: 'system',\n          }).catch(() => {}); // Non-blocking\n\n          results.push({\n            quotationId: quotation.id,\n            quotationNumber: quotation.quotationNumber,\n            customerEmail: quotation.customerEmail,\n            daysUntilExpiry: days,\n            status: 'sent',\n          });\n        } catch (error) {\n          logger.error(`Failed to send expiry notification for ${quotation.quotationNumber}:`, error);\n          results.push({\n            quotationId: quotation.id,\n            quotationNumber: quotation.quotationNumber,\n            customerEmail: quotation.customerEmail,\n            daysUntilExpiry: days,\n            status: 'failed',\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n        }\n      }\n    }\n\n    // Auto-expire quotations past their valid date\n    const expiredResult = await db\n      .update(quotations)\n      .set({\n        status: 'expired',\n        updatedAt: now,\n      })\n      .where(\n        and(\n          eq(quotations.status, 'sent'),\n          lte(quotations.validUntil, now)\n        )\n      )\n      .returning({ id: quotations.id, quotationNumber: quotations.quotationNumber });\n\n    // Log expiry activities\n    for (const expired of expiredResult) {\n      await quotationActivityService.logExpired(expired.id).catch(() => {}); // Non-blocking\n    }\n\n    const summary = {\n      processedAt: now.toISOString(),\n      notificationsSent: results.filter(r => r.status === 'sent').length,\n      notificationsFailed: results.filter(r => r.status === 'failed').length,\n      autoExpired: expiredResult.length,\n      details: results,\n      expiredQuotations: expiredResult.map(q => q.quotationNumber),\n    };\n\n    logger.info('Quotation expiry check completed:', summary);\n    sendSuccess(res, summary);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/cron/cleanup-verification-codes\n * Remove expired and used verification codes older than 24 hours\n *\n * Should be called every 6 hours by a cron job (Vercel cron, GitHub Actions, or external service)\n */\ncronRoutes.post('/cleanup-verification-codes', verifyCronSecret, async (req, res, next) => {\n  try {\n    const startTime = Date.now();\n\n    const deletedCount = await verificationCodeService.cleanupExpiredCodes();\n\n    const duration = Date.now() - startTime;\n\n    logger.info('Verification codes cleanup cron completed', {\n      deletedCount,\n      durationMs: duration\n    });\n\n    sendSuccess(res, {\n      message: 'Verification codes cleanup completed',\n      deletedCount,\n      durationMs: duration,\n      processedAt: new Date().toISOString(),\n    });\n  } catch (error) {\n    logger.error('Verification codes cleanup cron failed', { error });\n    next(error);\n  }\n});\n\n/**\n * GET /api/cron/health\n * Health check for cron jobs\n */\ncronRoutes.get('/health', (req, res) => {\n  sendSuccess(res, { status: 'ok', timestamp: new Date().toISOString() });\n});\n\n/**\n * POST /api/cron/newsletter-send\n * Process newsletter sending queue\n *\n * Should be called every hour by a cron job.\n * Sends emails up to the daily limit for each active campaign.\n */\ncronRoutes.post('/newsletter-send', verifyCronSecret, async (req, res, next) => {\n  try {\n    const db = getDb();\n    const now = new Date();\n    const startOfDay = new Date(now);\n    startOfDay.setHours(0, 0, 0, 0);\n\n    const results: {\n      campaignId: string;\n      campaignName: string;\n      emailsSent: number;\n      emailsFailed: number;\n      completed: boolean;\n    }[] = [];\n\n    // Get all active (sending) campaigns\n    const activeCampaigns = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.status, 'sending'));\n\n    logger.info(`Processing ${activeCampaigns.length} active newsletter campaigns`);\n\n    for (const campaign of activeCampaigns) {\n      // Count emails sent today for this campaign\n      const [todayStats] = await db\n        .select({\n          sentToday: sql<number>`count(*) filter (where ${newsletterSends.sentAt} >= ${startOfDay})`,\n        })\n        .from(newsletterSends)\n        .where(eq(newsletterSends.campaignId, campaign.id));\n\n      const sentToday = Number(todayStats?.sentToday || 0);\n      const remainingToday = Math.max(0, campaign.dailyLimit - sentToday);\n\n      if (remainingToday === 0) {\n        logger.info(`Campaign ${campaign.name}: Daily limit reached (${campaign.dailyLimit})`);\n        continue;\n      }\n\n      // Get pending sends for this campaign (up to remaining daily limit)\n      const pendingSends = await db\n        .select({\n          id: newsletterSends.id,\n          email: newsletterSends.email,\n          subscriberId: newsletterSends.subscriberId,\n        })\n        .from(newsletterSends)\n        .where(\n          and(\n            eq(newsletterSends.campaignId, campaign.id),\n            eq(newsletterSends.status, 'pending')\n          )\n        )\n        .orderBy(asc(newsletterSends.createdAt))\n        .limit(remainingToday);\n\n      if (pendingSends.length === 0) {\n        // No more pending - mark campaign as completed\n        await db\n          .update(newsletterCampaigns)\n          .set({\n            status: 'completed',\n            completedAt: now,\n            updatedAt: now,\n          })\n          .where(eq(newsletterCampaigns.id, campaign.id));\n\n        results.push({\n          campaignId: campaign.id,\n          campaignName: campaign.name,\n          emailsSent: 0,\n          emailsFailed: 0,\n          completed: true,\n        });\n\n        logger.info(`Campaign ${campaign.name}: Completed (all emails sent)`);\n        continue;\n      }\n\n      let emailsSent = 0;\n      let emailsFailed = 0;\n\n      // Process each pending send\n      for (const send of pendingSends) {\n        try {\n          // Get subscriber for unsubscribe token\n          const [subscriber] = await db\n            .select({ unsubscribeToken: newsletterSubscribers.unsubscribeToken })\n            .from(newsletterSubscribers)\n            .where(eq(newsletterSubscribers.id, send.subscriberId));\n\n          // Build unsubscribe URL\n          const baseUrl = process.env['WEBSITE_URL'] || 'http://localhost:3000';\n          const unsubscribeUrl = `${baseUrl}/unsubscribe/${subscriber?.unsubscribeToken || ''}`;\n\n          // Add unsubscribe link to content\n          const contentWithUnsubscribe = campaign.content + `\n            <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #eee;\">\n            <p style=\"font-size: 12px; color: #666; text-align: center;\">\n              You received this email because you subscribed to our newsletter.\n              <br>\n              <a href=\"${unsubscribeUrl}\" style=\"color: #666;\">Unsubscribe</a>\n            </p>\n          `;\n\n          // Send email\n          const success = await mailerService.sendEmail({\n            to: send.email,\n            subject: campaign.subject,\n            html: contentWithUnsubscribe,\n          });\n\n          if (success) {\n            await db\n              .update(newsletterSends)\n              .set({\n                status: 'sent',\n                sentAt: now,\n              })\n              .where(eq(newsletterSends.id, send.id));\n\n            emailsSent++;\n          } else {\n            await db\n              .update(newsletterSends)\n              .set({\n                status: 'failed',\n                errorMessage: 'Email service returned failure',\n                retryCount: sql`${newsletterSends.retryCount} + 1`,\n              })\n              .where(eq(newsletterSends.id, send.id));\n\n            emailsFailed++;\n          }\n        } catch (error) {\n          logger.error(`Failed to send newsletter to ${send.email}:`, error);\n\n          await db\n            .update(newsletterSends)\n            .set({\n              status: 'failed',\n              errorMessage: error instanceof Error ? error.message : 'Unknown error',\n              retryCount: sql`${newsletterSends.retryCount} + 1`,\n            })\n            .where(eq(newsletterSends.id, send.id));\n\n          emailsFailed++;\n        }\n      }\n\n      // Update campaign stats\n      await db\n        .update(newsletterCampaigns)\n        .set({\n          sentCount: sql`${newsletterCampaigns.sentCount} + ${emailsSent}`,\n          failedCount: sql`${newsletterCampaigns.failedCount} + ${emailsFailed}`,\n          lastSentAt: emailsSent > 0 ? now : campaign.lastSentAt,\n          updatedAt: now,\n        })\n        .where(eq(newsletterCampaigns.id, campaign.id));\n\n      results.push({\n        campaignId: campaign.id,\n        campaignName: campaign.name,\n        emailsSent,\n        emailsFailed,\n        completed: false,\n      });\n\n      logger.info(`Campaign ${campaign.name}: Sent ${emailsSent}, Failed ${emailsFailed}`);\n    }\n\n    const summary = {\n      processedAt: now.toISOString(),\n      campaignsProcessed: results.length,\n      totalEmailsSent: results.reduce((sum, r) => sum + r.emailsSent, 0),\n      totalEmailsFailed: results.reduce((sum, r) => sum + r.emailsFailed, 0),\n      campaignsCompleted: results.filter(r => r.completed).length,\n      details: results,\n    };\n\n    logger.info('Newsletter send cron completed:', summary);\n    sendSuccess(res, summary);\n  } catch (error) {\n    logger.error('Newsletter send cron failed:', error);\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport { validateQuery, validateBody } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess } from '../utils/response';\nimport { NotFoundError } from '../utils/errors';\nimport { auditLogService } from '../services/audit-log.service';\nimport { ipReputationService } from '../services/ip-reputation.service';\nimport { SecurityEventType, EventStatus, ActorType } from '../types/audit-events';\n\nexport const adminRoutes = Router();\n\n// Apply admin auth to all routes\nadminRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst auditLogFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  status: z.nativeEnum(EventStatus).optional(),\n  actorId: z.string().optional(),\n  ipAddress: z.string().optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst exportFiltersSchema = z.object({\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  eventType: z.nativeEnum(SecurityEventType).optional(),\n  status: z.nativeEnum(EventStatus).optional(),\n  actorId: z.string().optional(),\n  ipAddress: z.string().optional(),\n  format: z.enum(['csv', 'json']).optional().default('json'),\n});\n\nconst ipListFiltersSchema = z.object({\n  isBlocked: z.string().optional(),\n  minScore: z.string().optional(),\n  maxScore: z.string().optional(),\n  limit: z.string().optional(),\n  offset: z.string().optional(),\n});\n\nconst blockIPSchema = z.object({\n  reason: z.string().min(1, 'Block reason is required'),\n  duration: z.number().positive().optional(),\n});\n\n// ===========================================\n// Admin Audit Log Routes\n// ===========================================\n\n/**\n * GET /api/admin/audit-logs\n * List audit logs with pagination and filters\n */\nadminRoutes.get('/audit-logs', validateQuery(auditLogFiltersSchema), async (req, res, next) => {\n  try {\n    const {\n      startDate,\n      endDate,\n      eventType,\n      status,\n      actorId,\n      ipAddress,\n      limit,\n      offset,\n    } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof auditLogService.query>[0] = {\n      startDate: startDate ? new Date(startDate as string) : undefined,\n      endDate: endDate ? new Date(endDate as string) : undefined,\n      eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n      status: status as EventStatus | undefined,\n      actorId: actorId as string | undefined,\n      ipAddress: ipAddress as string | undefined,\n      limit: limit ? parseInt(limit as string, 10) : 50,\n      offset: offset ? parseInt(offset as string, 10) : 0,\n    };\n\n    const logs = await auditLogService.query(filters);\n\n    sendSuccess(res, logs);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/audit-logs/:id\n * Get a specific audit log by ID\n */\nadminRoutes.get('/audit-logs/:id', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n\n    const log = await auditLogService.getById(id);\n\n    if (!log) {\n      throw new NotFoundError('Audit log not found');\n    }\n\n    sendSuccess(res, log);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/audit-logs/export\n * Export audit logs to CSV or JSON\n */\nadminRoutes.get('/audit-logs/export', validateQuery(exportFiltersSchema), async (req, res, next) => {\n  try {\n    const {\n      startDate,\n      endDate,\n      eventType,\n      status,\n      actorId,\n      ipAddress,\n      format,\n    } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof auditLogService.query>[0] = {\n      startDate: startDate ? new Date(startDate as string) : undefined,\n      endDate: endDate ? new Date(endDate as string) : undefined,\n      eventTypes: eventType ? [eventType as SecurityEventType] : undefined,\n      status: status as EventStatus | undefined,\n      actorId: actorId as string | undefined,\n      ipAddress: ipAddress as string | undefined,\n    };\n\n    let exportData: string;\n    let contentType: string;\n    let filename: string;\n\n    if (format === 'csv') {\n      exportData = await auditLogService.exportToCSV(filters);\n      contentType = 'text/csv';\n      filename = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;\n    } else {\n      exportData = await auditLogService.exportToJSON(filters);\n      contentType = 'application/json';\n      filename = `audit-logs-${new Date().toISOString().split('T')[0]}.json`;\n    }\n\n    res.setHeader('Content-Type', contentType);\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    res.send(exportData);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ===========================================\n// Admin Abuse Management Routes\n// ===========================================\n\n/**\n * GET /api/admin/abuse/ips\n * List IP reputations with pagination and filters\n */\nadminRoutes.get('/abuse/ips', validateQuery(ipListFiltersSchema), async (req, res, next) => {\n  try {\n    const { isBlocked, minScore, maxScore, limit, offset } = req.query;\n\n    // Parse query parameters\n    const filters: Parameters<typeof ipReputationService.query>[0] = {\n      isBlocked: isBlocked ? isBlocked === 'true' : undefined,\n      minScore: minScore ? parseInt(minScore as string, 10) : undefined,\n      maxScore: maxScore ? parseInt(maxScore as string, 10) : undefined,\n      limit: limit ? parseInt(limit as string, 10) : 50,\n      offset: offset ? parseInt(offset as string, 10) : 0,\n    };\n\n    const ips = await ipReputationService.query(filters);\n\n    sendSuccess(res, ips);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/abuse/ips/:ip\n * Get specific IP reputation details\n */\nadminRoutes.get('/abuse/ips/:ip', async (req, res, next) => {\n  try {\n    const ip = req.params.ip as string;\n\n    const reputation = await ipReputationService.getReputation(ip);\n\n    if (!reputation) {\n      throw new NotFoundError('IP reputation not found');\n    }\n\n    sendSuccess(res, reputation);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/admin/abuse/ips/:ip/block\n * Manually block an IP address\n */\nadminRoutes.post('/abuse/ips/:ip/block', validateBody(blockIPSchema), async (req, res, next) => {\n  try {\n    const ip = req.params['ip'] as string;\n    const { reason, duration } = req.body;\n\n    // Block the IP\n    await ipReputationService.blockIP(ip, reason, duration);\n\n    // Log the admin action\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.ADMIN_ACTION,\n      actorType: ActorType.ADMIN,\n      actorId: (req as any).user?.id,\n      actorEmail: (req as any).user?.email,\n      action: 'block_ip',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        targetIp: ip,\n        reason,\n        duration: duration || 'permanent',\n      },\n    });\n\n    sendSuccess(res, { message: 'IP blocked successfully', ip, reason, duration });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/admin/abuse/ips/:ip/unblock\n * Unblock an IP address\n */\nadminRoutes.delete('/abuse/ips/:ip/unblock', async (req, res, next) => {\n  try {\n    const ip = req.params['ip'] as string;\n\n    // Unblock the IP\n    await ipReputationService.unblockIP(ip);\n\n    // Log the admin action\n    await auditLogService.logFromRequest(req, {\n      eventType: SecurityEventType.ADMIN_ACTION,\n      actorType: ActorType.ADMIN,\n      actorId: (req as any).user?.id,\n      actorEmail: (req as any).user?.email,\n      action: 'unblock_ip',\n      status: EventStatus.SUCCESS,\n      metadata: {\n        targetIp: ip,\n      },\n    });\n\n    sendSuccess(res, { message: 'IP unblocked successfully', ip });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/admin/abuse/stats\n * Get abuse prevention statistics\n */\nadminRoutes.get('/abuse/stats', async (req, res, next) => {\n  try {\n    const stats = await ipReputationService.getStatistics();\n\n    sendSuccess(res, stats);\n  } catch (error) {\n    next(error);\n  }\n});\n","import { Router } from 'express';\nimport { z } from 'zod';\nimport crypto from 'crypto';\nimport {\n  getDb,\n  newsletterSubscribers,\n  newsletterCampaigns,\n  newsletterSends,\n  eq,\n  desc,\n  asc,\n  and,\n  sql,\n  inArray,\n} from '@lab404/database';\nimport { validateBody, validateQuery } from '../middleware/validator';\nimport { requireAuth, requireAdmin } from '../middleware/auth';\nimport { sendSuccess, createPaginationMeta, parsePaginationParams } from '../utils/response';\nimport { BadRequestError, NotFoundError } from '../utils/errors';\n\nexport const newsletterRoutes = Router();\n\n// Apply admin auth to all routes\nnewsletterRoutes.use(requireAuth, requireAdmin);\n\n// ===========================================\n// Validation Schemas\n// ===========================================\n\nconst subscriberFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['active', 'unsubscribed', 'bounced']).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional(),\n  search: z.string().optional(),\n});\n\nconst addSubscriberSchema = z.object({\n  email: z.string().email(),\n  name: z.string().max(100).optional(),\n  source: z.enum(['footer', 'checkout', 'popup', 'import', 'admin']).optional().default('admin'),\n});\n\nconst importSubscribersSchema = z.object({\n  subscribers: z.array(\n    z.object({\n      email: z.string().email(),\n      name: z.string().max(100).optional(),\n    })\n  ).min(1).max(10000),\n});\n\nconst campaignFiltersSchema = z.object({\n  page: z.string().optional(),\n  limit: z.string().optional(),\n  status: z.enum(['draft', 'scheduled', 'sending', 'paused', 'completed', 'cancelled']).optional(),\n});\n\nconst createCampaignSchema = z.object({\n  name: z.string().min(1).max(255),\n  subject: z.string().min(1).max(255),\n  previewText: z.string().max(255).optional(),\n  content: z.string().min(1),\n  dailyLimit: z.number().int().min(1).max(10000).optional().default(100),\n  sendTime: z.string().regex(/^([01]\\d|2[0-3]):([0-5]\\d)$/).optional(), // HH:MM format\n  scheduledAt: z.string().datetime().optional(),\n});\n\nconst updateCampaignSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  subject: z.string().min(1).max(255).optional(),\n  previewText: z.string().max(255).optional(),\n  content: z.string().min(1).optional(),\n  dailyLimit: z.number().int().min(1).max(10000).optional(),\n  sendTime: z.string().regex(/^([01]\\d|2[0-3]):([0-5]\\d)$/).optional(),\n  scheduledAt: z.string().datetime().optional(),\n});\n\n// ===========================================\n// Subscriber Routes\n// ===========================================\n\n/**\n * GET /api/newsletter/subscribers\n * List all subscribers with pagination and filters\n */\nnewsletterRoutes.get(\n  '/subscribers',\n  validateQuery(subscriberFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { status, source, search } = req.query;\n\n      const conditions = [];\n\n      if (status) {\n        conditions.push(eq(newsletterSubscribers.status, status as string));\n      }\n\n      if (source) {\n        conditions.push(eq(newsletterSubscribers.source, source as string));\n      }\n\n      if (search) {\n        conditions.push(\n          sql`(${newsletterSubscribers.email} ILIKE ${`%${search}%`} OR ${newsletterSubscribers.name} ILIKE ${`%${search}%`})`\n        );\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Get total count\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterSubscribers)\n        .where(whereClause);\n      const total = Number(countResult[0]?.count ?? 0);\n\n      // Get subscribers\n      const subscribers = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(whereClause)\n        .orderBy(desc(newsletterSubscribers.subscribedAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, subscribers, 200, createPaginationMeta(page, limit, total));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/newsletter/subscribers/stats\n * Get subscriber statistics\n */\nnewsletterRoutes.get('/subscribers/stats', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    const [stats] = await db\n      .select({\n        total: sql<number>`count(*)`,\n        active: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'active')`,\n        unsubscribed: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'unsubscribed')`,\n        bounced: sql<number>`count(*) filter (where ${newsletterSubscribers.status} = 'bounced')`,\n        thisMonth: sql<number>`count(*) filter (where ${newsletterSubscribers.subscribedAt} >= date_trunc('month', current_date))`,\n        thisWeek: sql<number>`count(*) filter (where ${newsletterSubscribers.subscribedAt} >= date_trunc('week', current_date))`,\n      })\n      .from(newsletterSubscribers);\n\n    // Get by source\n    const bySource = await db\n      .select({\n        source: newsletterSubscribers.source,\n        count: sql<number>`count(*)`,\n      })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'))\n      .groupBy(newsletterSubscribers.source);\n\n    sendSuccess(res, {\n      total: Number(stats.total),\n      active: Number(stats.active),\n      unsubscribed: Number(stats.unsubscribed),\n      bounced: Number(stats.bounced),\n      thisMonth: Number(stats.thisMonth),\n      thisWeek: Number(stats.thisWeek),\n      bySource: bySource.reduce((acc, item) => {\n        acc[item.source] = Number(item.count);\n        return acc;\n      }, {} as Record<string, number>),\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/newsletter/subscribers/export\n * Export subscribers as CSV\n */\nnewsletterRoutes.get('/subscribers/export', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { status } = req.query;\n\n    const conditions = [];\n    if (status) {\n      conditions.push(eq(newsletterSubscribers.status, status as string));\n    }\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const subscribers = await db\n      .select({\n        email: newsletterSubscribers.email,\n        name: newsletterSubscribers.name,\n        status: newsletterSubscribers.status,\n        source: newsletterSubscribers.source,\n        subscribedAt: newsletterSubscribers.subscribedAt,\n        unsubscribedAt: newsletterSubscribers.unsubscribedAt,\n      })\n      .from(newsletterSubscribers)\n      .where(whereClause)\n      .orderBy(desc(newsletterSubscribers.subscribedAt));\n\n    // Generate CSV\n    const headers = ['Email', 'Name', 'Status', 'Source', 'Subscribed At', 'Unsubscribed At'];\n    const rows = subscribers.map((s) => [\n      s.email,\n      s.name || '',\n      s.status,\n      s.source,\n      s.subscribedAt.toISOString(),\n      s.unsubscribedAt?.toISOString() || '',\n    ]);\n\n    const csv = [\n      headers.join(','),\n      ...rows.map((row) => row.map((cell) => `\"${cell.replace(/\"/g, '\"\"')}\"`).join(',')),\n    ].join('\\n');\n\n    res.setHeader('Content-Type', 'text/csv');\n    res.setHeader('Content-Disposition', `attachment; filename=\"subscribers-${new Date().toISOString().split('T')[0]}.csv\"`);\n    res.send(csv);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/subscribers\n * Add a new subscriber (admin)\n */\nnewsletterRoutes.post(\n  '/subscribers',\n  validateBody(addSubscriberSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { email, name, source } = req.body;\n\n      // Check if already exists\n      const [existing] = await db\n        .select()\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.email, email.toLowerCase()));\n\n      if (existing) {\n        throw new BadRequestError('Email already subscribed');\n      }\n\n      const unsubscribeToken = crypto.randomBytes(32).toString('hex');\n\n      const [subscriber] = await db\n        .insert(newsletterSubscribers)\n        .values({\n          email: email.toLowerCase(),\n          name,\n          source,\n          unsubscribeToken,\n          status: 'active',\n        })\n        .returning();\n\n      sendSuccess(res, subscriber, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * POST /api/newsletter/subscribers/import\n * Bulk import subscribers\n */\nnewsletterRoutes.post(\n  '/subscribers/import',\n  validateBody(importSubscribersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { subscribers: inputSubscribers } = req.body;\n\n      const results = {\n        imported: 0,\n        skipped: 0,\n        errors: [] as string[],\n      };\n\n      // Get existing emails\n      const existingEmails = new Set(\n        (await db.select({ email: newsletterSubscribers.email }).from(newsletterSubscribers))\n          .map((s) => s.email.toLowerCase())\n      );\n\n      // Filter out existing\n      const newSubscribers = inputSubscribers.filter((s: { email: string }) => {\n        if (existingEmails.has(s.email.toLowerCase())) {\n          results.skipped++;\n          return false;\n        }\n        return true;\n      });\n\n      // Insert in batches\n      const batchSize = 100;\n      for (let i = 0; i < newSubscribers.length; i += batchSize) {\n        const batch = newSubscribers.slice(i, i + batchSize);\n        const values = batch.map((s: { email: string; name?: string }) => ({\n          email: s.email.toLowerCase(),\n          name: s.name || null,\n          source: 'import' as const,\n          unsubscribeToken: crypto.randomBytes(32).toString('hex'),\n          status: 'active' as const,\n        }));\n\n        await db.insert(newsletterSubscribers).values(values);\n        results.imported += batch.length;\n      }\n\n      sendSuccess(res, {\n        message: `Import completed: ${results.imported} imported, ${results.skipped} skipped`,\n        ...results,\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/newsletter/subscribers/:id\n * Remove a subscriber\n */\nnewsletterRoutes.delete('/subscribers/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [deleted] = await db\n      .delete(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.id, id))\n      .returning();\n\n    if (!deleted) {\n      throw new NotFoundError('Subscriber not found');\n    }\n\n    sendSuccess(res, { message: 'Subscriber removed successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * DELETE /api/newsletter/subscribers/bulk\n * Bulk delete subscribers\n */\nnewsletterRoutes.post(\n  '/subscribers/bulk-delete',\n  validateBody(z.object({ ids: z.array(z.string().uuid()).min(1) })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { ids } = req.body;\n\n      const deleted = await db\n        .delete(newsletterSubscribers)\n        .where(inArray(newsletterSubscribers.id, ids))\n        .returning();\n\n      sendSuccess(res, { message: `${deleted.length} subscribers removed` });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n// ===========================================\n// Campaign Routes\n// ===========================================\n\n/**\n * GET /api/newsletter/campaigns\n * List all campaigns\n */\nnewsletterRoutes.get(\n  '/campaigns',\n  validateQuery(campaignFiltersSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n      const { status } = req.query;\n\n      const conditions = [];\n      if (status) {\n        conditions.push(eq(newsletterCampaigns.status, status as string));\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n      // Get total count\n      const countResult = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterCampaigns)\n        .where(whereClause);\n      const total = Number(countResult[0]?.count ?? 0);\n\n      // Get campaigns\n      const campaigns = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(whereClause)\n        .orderBy(desc(newsletterCampaigns.createdAt))\n        .limit(limit)\n        .offset(offset);\n\n      sendSuccess(res, campaigns, 200, createPaginationMeta(page, limit, total));\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * GET /api/newsletter/campaigns/:id\n * Get a specific campaign\n */\nnewsletterRoutes.get('/campaigns/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    sendSuccess(res, campaign);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns\n * Create a new campaign\n */\nnewsletterRoutes.post(\n  '/campaigns',\n  validateBody(createCampaignSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { name, subject, previewText, content, dailyLimit, sendTime, scheduledAt } = req.body;\n\n      // Get total active subscribers\n      const [{ count }] = await db\n        .select({ count: sql<number>`count(*)` })\n        .from(newsletterSubscribers)\n        .where(eq(newsletterSubscribers.status, 'active'));\n\n      const [campaign] = await db\n        .insert(newsletterCampaigns)\n        .values({\n          name,\n          subject,\n          previewText,\n          content,\n          dailyLimit,\n          sendTime,\n          scheduledAt: scheduledAt ? new Date(scheduledAt) : null,\n          totalRecipients: Number(count),\n          status: scheduledAt ? 'scheduled' : 'draft',\n          createdBy: (req as any).user?.id,\n        })\n        .returning();\n\n      sendSuccess(res, campaign, 201);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * PUT /api/newsletter/campaigns/:id\n * Update a campaign (only draft/paused campaigns)\n */\nnewsletterRoutes.put(\n  '/campaigns/:id',\n  validateBody(updateCampaignSchema),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { id } = req.params;\n      const updates = req.body;\n\n      const [existing] = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(eq(newsletterCampaigns.id, id));\n\n      if (!existing) {\n        throw new NotFoundError('Campaign not found');\n      }\n\n      if (!['draft', 'paused', 'scheduled'].includes(existing.status)) {\n        throw new BadRequestError('Can only edit draft, scheduled, or paused campaigns');\n      }\n\n      // If updating scheduledAt, also update status\n      const additionalUpdates: Record<string, unknown> = {};\n      if (updates.scheduledAt) {\n        additionalUpdates.scheduledAt = new Date(updates.scheduledAt);\n        if (existing.status === 'draft') {\n          additionalUpdates.status = 'scheduled';\n        }\n      }\n\n      // If content changed, recalculate recipient count\n      if (updates.content) {\n        const [{ count }] = await db\n          .select({ count: sql<number>`count(*)` })\n          .from(newsletterSubscribers)\n          .where(eq(newsletterSubscribers.status, 'active'));\n        additionalUpdates.totalRecipients = Number(count);\n      }\n\n      const [campaign] = await db\n        .update(newsletterCampaigns)\n        .set({\n          ...updates,\n          ...additionalUpdates,\n          updatedAt: new Date(),\n        })\n        .where(eq(newsletterCampaigns.id, id))\n        .returning();\n\n      sendSuccess(res, campaign);\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n\n/**\n * DELETE /api/newsletter/campaigns/:id\n * Delete a campaign (only draft campaigns)\n */\nnewsletterRoutes.delete('/campaigns/:id', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [existing] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!existing) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (existing.status !== 'draft') {\n      throw new BadRequestError('Can only delete draft campaigns');\n    }\n\n    await db.delete(newsletterCampaigns).where(eq(newsletterCampaigns.id, id));\n\n    sendSuccess(res, { message: 'Campaign deleted successfully' });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/start\n * Start sending a campaign\n */\nnewsletterRoutes.post('/campaigns/:id/start', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (!['draft', 'scheduled', 'paused'].includes(campaign.status)) {\n      throw new BadRequestError('Campaign cannot be started in its current state');\n    }\n\n    // Get active subscribers count\n    const [{ count }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'));\n\n    const totalRecipients = Number(count);\n\n    if (totalRecipients === 0) {\n      throw new BadRequestError('No active subscribers to send to');\n    }\n\n    // Create send records for all active subscribers who haven't received this campaign\n    const activeSubscribers = await db\n      .select({ id: newsletterSubscribers.id, email: newsletterSubscribers.email })\n      .from(newsletterSubscribers)\n      .where(eq(newsletterSubscribers.status, 'active'));\n\n    // Check for existing sends\n    const existingSends = await db\n      .select({ subscriberId: newsletterSends.subscriberId })\n      .from(newsletterSends)\n      .where(eq(newsletterSends.campaignId, id));\n\n    const existingSubscriberIds = new Set(existingSends.map((s) => s.subscriberId));\n\n    // Filter out subscribers who already have sends\n    const newSubscribers = activeSubscribers.filter((s) => !existingSubscriberIds.has(s.id));\n\n    if (newSubscribers.length > 0) {\n      // Insert in batches\n      const batchSize = 500;\n      for (let i = 0; i < newSubscribers.length; i += batchSize) {\n        const batch = newSubscribers.slice(i, i + batchSize);\n        await db.insert(newsletterSends).values(\n          batch.map((s) => ({\n            campaignId: id,\n            subscriberId: s.id,\n            email: s.email,\n            status: 'pending' as const,\n          }))\n        );\n      }\n    }\n\n    // Update campaign status\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'sending',\n        totalRecipients,\n        startedAt: campaign.startedAt || new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, {\n      message: 'Campaign started',\n      campaign: updated,\n      pendingSends: newSubscribers.length,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/pause\n * Pause a sending campaign\n */\nnewsletterRoutes.post('/campaigns/:id/pause', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (campaign.status !== 'sending') {\n      throw new BadRequestError('Can only pause campaigns that are sending');\n    }\n\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'paused',\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, { message: 'Campaign paused', campaign: updated });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/cancel\n * Cancel a campaign\n */\nnewsletterRoutes.post('/campaigns/:id/cancel', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n\n    const [campaign] = await db\n      .select()\n      .from(newsletterCampaigns)\n      .where(eq(newsletterCampaigns.id, id));\n\n    if (!campaign) {\n      throw new NotFoundError('Campaign not found');\n    }\n\n    if (['completed', 'cancelled'].includes(campaign.status)) {\n      throw new BadRequestError('Campaign cannot be cancelled in its current state');\n    }\n\n    // Delete pending sends\n    await db\n      .delete(newsletterSends)\n      .where(\n        and(\n          eq(newsletterSends.campaignId, id),\n          eq(newsletterSends.status, 'pending')\n        )\n      );\n\n    const [updated] = await db\n      .update(newsletterCampaigns)\n      .set({\n        status: 'cancelled',\n        updatedAt: new Date(),\n      })\n      .where(eq(newsletterCampaigns.id, id))\n      .returning();\n\n    sendSuccess(res, { message: 'Campaign cancelled', campaign: updated });\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/newsletter/campaigns/:id/sends\n * Get send details for a campaign\n */\nnewsletterRoutes.get('/campaigns/:id/sends', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const { id } = req.params;\n    const { page, limit, offset } = parsePaginationParams(req.query as Record<string, string>);\n    const { status } = req.query;\n\n    const conditions = [eq(newsletterSends.campaignId, id)];\n    if (status) {\n      conditions.push(eq(newsletterSends.status, status as string));\n    }\n\n    const whereClause = and(...conditions);\n\n    // Get total count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(newsletterSends)\n      .where(whereClause);\n    const total = Number(countResult[0]?.count ?? 0);\n\n    // Get sends\n    const sends = await db\n      .select()\n      .from(newsletterSends)\n      .where(whereClause)\n      .orderBy(asc(newsletterSends.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    sendSuccess(res, sends, 200, createPaginationMeta(page, limit, total));\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/newsletter/campaigns/:id/test\n * Send a test email for a campaign\n */\nnewsletterRoutes.post(\n  '/campaigns/:id/test',\n  validateBody(z.object({ email: z.string().email() })),\n  async (req, res, next) => {\n    try {\n      const db = getDb();\n      const { id } = req.params;\n      const { email } = req.body;\n\n      const [campaign] = await db\n        .select()\n        .from(newsletterCampaigns)\n        .where(eq(newsletterCampaigns.id, id));\n\n      if (!campaign) {\n        throw new NotFoundError('Campaign not found');\n      }\n\n      // TODO: Actually send test email via email service\n      // For now, just return success\n      console.log('Test email would be sent:', {\n        to: email,\n        subject: campaign.subject,\n        contentLength: campaign.content.length,\n      });\n\n      sendSuccess(res, {\n        message: `Test email sent to ${email}`,\n        campaign: {\n          id: campaign.id,\n          subject: campaign.subject,\n        },\n      });\n    } catch (error) {\n      next(error);\n    }\n  }\n);\n"],"mappings":"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","names":["import_express","dotenv","path","timestamp","import_pg_core","import_drizzle_orm","import_pg_core","import_drizzle_orm","import_pg_core","import_drizzle_orm","import_pg_core","import_pg_core","import_drizzle_orm","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_drizzle_orm","import_pg_core","import_drizzle_orm","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_pg_core","import_drizzle_orm","sql","import_drizzle_orm","import_drizzle_orm","bcrypt","count","jwt","uuidValidate","import_zod","rateLimit","xss","import_uuid","uuidv4","import_express","import_zod","import_bcryptjs","import_uuid","text","slugify","sum","text","PDFDocument","index","desc","path","import_zod","index","index","db","import_drizzle_orm","crypto","crypto","db","import_drizzle_orm","sum","db","config","nodemailer","timestamp","import_bcryptjs","import_crypto","crypto","count","db","zxcvbn","db","bcrypt","import_drizzle_orm","db","SecurityEventType","EventStatus","db","db","bcrypt","import_express","sessions","count","import_express","import_zod","db","count","import_express","import_zod","db","count","import_express","import_zod","import_uuid","db","uuidv4","sum","import_express","import_zod","text","db","count","import_express","import_zod","import_bcryptjs","WEAK_PASSWORDS","addressSchema","db","bcrypt","count","import_express","import_zod","db","count","import_express","import_zod","db","db","count","db","sum","import_express","import_zod","db","import_express","import_zod","db","count","index","import_express","import_zod","db","count","import_express","import_zod","db","sum","import_express","import_zod","db","import_express","import_zod","db","shippingAddress","billingAddress","import_express","import_zod","import_crypto","db","crypto","products","import_express","import_zod","ImageKit","import_express","db","import_express","import_zod","settings","import_express","import_zod","import_express","import_zod","import_imagekit","imagekit","getImageKit","ImageKit","searchQuerySchema","index","timestamp","import_express","import_zod","createTemplateSchema","updateTemplateSchema","db","count","import_express","db","sum","import_express","import_zod","auditLogFiltersSchema","import_express","import_zod","import_crypto","db","crypto","count","router","app","express","helmet","cors","compression","cookieParser","morgan","router"]}